# Tegaki é‡è¦ãªä¿®æ­£ - ã‚¨ãƒ©ãƒ¼è§£æ±ºãƒ»æç”»ãƒ»ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å•é¡Œ

---

## ğŸ”´ **ç¾åœ¨ã®ã‚¨ãƒ©ãƒ¼ãƒ»å•é¡Œã®æ•´ç†**

| å•é¡Œ | åŸå›  | å½±éŸ¿ | å„ªå…ˆåº¦ |
|------|------|------|--------|
| BrushSettings ãƒ¡ã‚½ãƒƒãƒ‰ãªã— | `setPressureCorrection()` ç­‰æœªå®Ÿè£… | EventBus ã‚¨ãƒ©ãƒ¼ | **P1** âœ… ä¿®æ­£æ¸ˆ |
| ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒéè¡¨ç¤º | popup-manager.js + show/hide ãƒ­ã‚¸ãƒƒã‚¯ | UIä½¿ç”¨ä¸å¯ | **P1** |
| æç”»ã§ããªã„ | core-runtime.js ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆï¼Ÿ | æç”»æ©Ÿèƒ½ãªã— | **P1** |
| ãƒªã‚µã‚¤ã‚ºæ™‚èƒŒæ™¯è‰²ãŒé€æ˜ã« | Camera/Layeråº§æ¨™ç³»æ··åœ¨ï¼Ÿ | è¦–è¦šçš„å•é¡Œ | **P2** |
| æ“ä½œãŒé‡ã„ | DOMå†æç”»å¤šé‡å®Ÿè¡Œï¼Ÿ | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | **P2** |

---

## âœ… **ä¿®æ­£1å®Œäº†: BrushSettings**

**ä¿®æ­£å†…å®¹:**
- `setPressureCorrection()`, `setSmoothing()`, `setPressureCurve()` ç­‰ã‚’è¿½åŠ 
- ã™ã¹ã¦ã®getter/setter ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…
- `getCurrentSettings()` å®Œå…¨å®Ÿè£…

**ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ**: `BrushSettings - ãƒ–ãƒ©ã‚·è¨­å®šç®¡ç†ã‚¯ãƒ©ã‚¹ï¼ˆå®Œå…¨ç‰ˆï¼‰`

---

## ğŸ”§ **ä¿®æ­£2: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œãªã„å•é¡Œ**

### **åŸå› ã®ç‰¹å®š**

```
popup-manager.js:192 ğŸ‘ï¸ Popup "quickAccess" shown
popup-manager.js:212 ğŸ™ˆ Popup "quickAccess" hidden
```

â†’ show() ç›´å¾Œã« hide() ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹

### **åŸå› æ¨æ¸¬**

1. **popup-manager.js ã® `hideAll()` ãŒ quickAccess ã‚‚éš ã—ã¦ã„ã‚‹**
   ```javascript
   // ç¾åœ¨ã®å•é¡Œã‚³ãƒ¼ãƒ‰
   hideAll(exceptName = null) {
     this.popups.forEach((popupData, name) => {
       if (name !== exceptName && popupData.instance) {
         popupData.instance.hide();  // â† exceptName ä»¥å¤–ã¯å…¨ã¦éè¡¨ç¤º
       }
     });
   }
   ```
   
   show() â†’ hideAll('quickAccess') ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ã¯ãšã ãŒã€exceptName ãŒæ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ãªã„

2. **quick-access-popup.js ã® initialize() ãŒå‘¼ã°ã‚Œã¦ã„ãªã„**
   - `.show()` ãŒå‘¼ã°ã‚Œã¦ã‚‚ `.initialize()` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„
   - DOM ãŒä½œæˆã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§

### **ä¿®æ­£æ–¹æ³•**

#### **Step 1: quick-access-popup.js ã« initialize() ã‚’è¿½åŠ **

```javascript
// ui/quick-access-popup.js ã«è¿½åŠ 

initialize() {
  if (this.initialized) return;
  
  this._ensurePanelExists();
  this._cacheElements();
  this._attachEventListeners();
  
  this.initialized = true;
  console.log('âœ… QuickAccessPopup initialized');
}

show() {
  if (!this.initialized) {
    this.initialize();
  }
  
  if (!this.panel) {
    this._ensurePanelExists();
  }
  
  this.panel.classList.add('show');
  this.isVisible = true;
  console.log('ğŸ‘ï¸ QuickAccessPopup shown');
}

hide() {
  if (this.panel) {
    this.panel.classList.remove('show');
  }
  this.isVisible = false;
  console.log('ğŸ™ˆ QuickAccessPopup hidden');
}

toggle() {
  if (this.isVisible) {
    this.hide();
  } else {
    this.show();
  }
}
```

#### **Step 2: popup-manager.js ã® hideAll() ã‚’ä¿®æ­£**

```javascript
// popup-manager.js ä¿®æ­£

show(name) {
  const instance = this.get(name);
  
  if (!instance) {
    console.error(`âŒ Cannot show popup "${name}": not ready`);
    return false;
  }
  
  // âœ… ä¿®æ­£: exceptName ã‚’æ˜ç¤ºçš„ã«æ¸¡ã™
  this.hideAll(name);  // â† name ã‚’é™¤å¤–å¯¾è±¡ã¨ã—ã¦æ¸¡ã™
  
  instance.show();
  this.activePopup = name;
  
  this.eventBus.emit('popup:show', { name });
  console.log(`ğŸ‘ï¸ Popup "${name}" shown`);
  
  return true;
}

hideAll(exceptName = null) {
  let hiddenCount = 0;
  
  // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çµŒç”±ã§ã®éè¡¨ç¤º
  this.popups.forEach((popupData, name) => {
    // âœ… ä¿®æ­£: exceptName ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    if (name === exceptName) {
      return;
    }
    
    if (popupData.instance && popupData.status === 'ready') {
      if (this.isVisible(name)) {
        popupData.instance.hide();
        hiddenCount++;
      }
    }
  });
  
  if (exceptName !== null) {
    this.activePopup = exceptName;
  } else {
    this.activePopup = null;
  }
  
  if (hiddenCount > 0) {
    this.eventBus.emit('popup:all-hidden', { exceptName, hiddenCount });
  }
}
```

---

## ğŸ¨ **ä¿®æ­£3: æç”»ã§ããªã„å•é¡Œ**

### **åŸå› æ¨æ¸¬**

ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆãŒ drawingEngine ã«ä¼æ’­ã—ã¦ã„ãªã„

### **ç¢ºèªæ‰‹é †**

```javascript
// Console ã§å®Ÿè¡Œ
console.log('=== Pointer Event Debug ===');
console.log('DrawingEngine:', window.coreEngine?.getDrawingEngine?.());
console.log('DrawingEngine.isDrawing:', window.coreEngine?.getDrawingEngine?.().isDrawing);
console.log('DrawingEngine.currentTool:', window.coreEngine?.getDrawingEngine?.().currentTool);

// ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚­ãƒ£ãƒƒãƒã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
const canvas = document.querySelector('canvas');
canvas.addEventListener('pointerdown', (e) => {
  console.log('âœ… Canvas pointerdown fired:', e.clientX, e.clientY);
});
```

### **ä¿®æ­£å†…å®¹**

**core-runtime.js ã® handlePointerDown ã‚’ç¢ºèª:**

```javascript
handlePointerDown(event) {
  const currentTool = this.internal.drawingEngine?.currentTool || 'pen';
  const isDrawingTool = currentTool === 'pen' || currentTool === 'eraser';
  
  // âœ… ç¢ºèª: LayerMoveMode ãƒã‚§ãƒƒã‚¯
  if (this.internal.drawingEngine && 
      !this.internal.layerManager?.isLayerMoveMode && 
      isDrawingTool) {
    
    console.log('ğŸ–Œï¸ Starting draw:', event.global.x, event.global.y);  // ãƒ‡ãƒãƒƒã‚°è¿½åŠ 
    this.internal.drawingEngine.startDrawing(event.global.x, event.global.y, event);
  } else {
    console.log('âš ï¸ Draw blocked:', {
      hasDrawingEngine: !!this.internal.drawingEngine,
      isLayerMoveMode: this.internal.layerManager?.isLayerMoveMode,
      currentTool,
      isDrawingTool
    });
  }
}
```

---

## ğŸ¨ **ä¿®æ­£4: ãƒªã‚µã‚¤ã‚ºæ™‚ã«èƒŒæ™¯è‰²ãŒé€æ˜ã«**

### **åŸå› **

ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã§èƒŒæ™¯è‰²è¨­å®šãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹

### **ç¢ºèª**

```javascript
// Console ã§å®Ÿè¡Œ
const layerSystem = window.coreEngine?.getLayerManager?.();
const activeLayer = layerSystem?.getActiveLayer?.();
console.log('Active layer background:', activeLayer?.layerData?.isBackground);
console.log('Background color:', window.TEGAKI_CONFIG?.background?.color);
```

### **ä¿®æ­£å†…å®¹ï¼ˆlayer-system.jsï¼‰**

```javascript
// ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ä¿®æ­£
updateLayerSizesAfterResize(newWidth, newHeight) {
  this.cuts.forEach(cut => {
    cut.layers.forEach(layer => {
      if (layer.layerData?.isBackground) {
        // âœ… ä¿®æ­£: èƒŒæ™¯è‰²ã‚’ä¿æŒ
        const bgColor = window.TEGAKI_CONFIG?.background?.color || 0xf0e0d6;
        
        if (layer.layerData.backgroundGraphics) {
          layer.layerData.backgroundGraphics.clear();
          
          const squareSize = 16;
          for (let y = 0; y < newHeight; y += squareSize) {
            for (let x = 0; x < newWidth; x += squareSize) {
              const isEvenX = (x / squareSize) % 2 === 0;
              const isEvenY = (y / squareSize) % 2 === 0;
              const color = (isEvenX === isEvenY) ? 0xe9c2ba : 0xf0e0d6;
              
              layer.layerData.backgroundGraphics.rect(x, y, squareSize, squareSize);
              layer.layerData.backgroundGraphics.fill({ color });
            }
          }
        }
      }
    });
  });
}
```

---

## âš¡ **ä¿®æ­£5: æ“ä½œãŒé‡ã„å•é¡Œ**

### **åŸå› **

DOM ã®éåº¦ãªå†æç”»

### **å¯¾ç­–**

```javascript
// layer-panel-renderer.js ã® requestAnimationFrame ä½¿ç”¨

let pendingRender = false;

updateLayerPanelUI() {
  if (pendingRender) return;  // âœ… æ—¢ã«äºˆç´„æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
  
  pendingRender = true;
  
  requestAnimationFrame(() => {
    // é‡ã„å‡¦ç†ã‚’ã“ã“ã§å®Ÿè¡Œ
    this._renderLayerPanelSync();
    pendingRender = false;
  });
}
```

---

## ğŸ“‹ **å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

- [ ] **BrushSettings**: å…¨ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…å®Œäº† âœ…
- [ ] **drawing-engine.js**: EventBus è³¼èª­å®‰å…¨åŒ– âœ…
- [ ] **quick-access-popup.js**: `initialize()` `toggle()` è¿½åŠ 
- [ ] **popup-manager.js**: `show()` ã¨ `hideAll()` ä¿®æ­£
- [ ] **core-runtime.js**: ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
- [ ] **layer-system.js**: ãƒªã‚µã‚¤ã‚ºæ™‚èƒŒæ™¯è‰²ä¿æŒ
- [ ] **layer-panel-renderer.js**: requestAnimationFrame åŒ–

---

## ğŸ” **ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰**

```javascript
// ä¸€æ‹¬ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ

console.log('=== Tegaki Debug Report ===');

// 1. BrushSettings
const bs = window.coreEngine?.getDrawingEngine?.().settings;
console.log('BrushSettings methods:', {
  getCurrentSettings: typeof bs.getCurrentSettings,
  setPressureCorrection: typeof bs.setPressureCorrection,
  setSmoothing: typeof bs.setSmoothing
});

// 2. PopupManager
const pm = window.PopupManager;
console.log('PopupManager statuses:', pm?.getAllStatuses?.());

// 3. DrawingEngine
const de = window.coreEngine?.getDrawingEngine?.();
console.log('DrawingEngine:', {
  currentTool: de?.currentTool,
  isDrawing: de?.isDrawing,
  canDraw: typeof de?.startDrawing === 'function'
});

// 4. Canvas
const canvas = document.querySelector('canvas');
console.log('Canvas:', {
  width: canvas?.width,
  height: canvas?.height,
  hasEventListeners: !!canvas?.onpointerdown
});
```

---

## âœ… **ä¿®æ­£ã®å„ªå…ˆé †ä½**

1. **quick-access-popup.js**: `initialize()` + `toggle()` è¿½åŠ  â†’ **ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º**
2. **popup-manager.js**: `hideAll()` ä¿®æ­£ â†’ **ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—éè¡¨ç¤ºå•é¡Œè§£æ±º**
3. **core-runtime.js**: ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆ ãƒ‡ãƒãƒƒã‚°è¿½åŠ  â†’ **æç”»å¯èƒ½ã‹ç¢ºèª**
4. **layer-system.js**: èƒŒæ™¯è‰²ä¿æŒ â†’ **ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ**
5. **layer-panel-renderer.js**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ â†’ **æ“ä½œè»½é‡åŒ–**