# ğŸ¨ Tegaki v8.13 Drawing Tool - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£&ã‚·ãƒ³ãƒœãƒ«è¾å…¸

## ğŸ“‹ ç›®æ¬¡
1. [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã¨ãƒ•ãƒ­ãƒ¼](#ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã¨ãƒ•ãƒ­ãƒ¼)
3. [èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«å•é¡Œã®è¨ºæ–­](#èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«å•é¡Œã®è¨ºæ–­)
4. [ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°](#ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°)
5. [åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³](#åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³)
6. [ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ãƒãƒƒãƒ—](#ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ãƒãƒƒãƒ—)

---

## ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡
- **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: PixiJS v8.13, ES2023, WebGPU
- **ç¦æ­¢äº‹é …**: Canvas2D, TypeScript, ESM, bundler
- **è¨­è¨ˆåŸå‰‡**: DRY/SOLID, æ˜ç¢ºãªè²¬å‹™åˆ†æ‹…, äºŒé‡å®Ÿè£…ã®æ’²æ»…

### ğŸ¯ ã‚³ã‚¢æ©Ÿèƒ½
- SDF/MSDFæŠ€è¡“ã«ã‚ˆã‚‹ãƒšãƒ³ãƒ»æ¶ˆã—ã‚´ãƒ æç”»
- WebGPU GPU Computeã«ã‚ˆã‚‹è·é›¢å ´ç”Ÿæˆ
- ãƒ¬ã‚¤ãƒ¤ãƒ¼&ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ 
- å¤‰æ›ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½

---

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã¨ãƒ•ãƒ­ãƒ¼

### ğŸ“‚ åˆæœŸåŒ–ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆindex.htmlèª­ã¿è¾¼ã¿é †ï¼‰

```
1. PIXI.js, å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
   â†“
2. config.js (è¨­å®šãƒ»ã‚­ãƒ¼ãƒãƒƒãƒ—)
   â†“
3. event-bus.js (ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ )
   â†“
4. coordinate-system.js (åº§æ¨™å¤‰æ›ã‚³ã‚¢API)
   â†“
5. ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
   â”œâ”€ data-models.js (LayerModel, StrokeDataå®šç¾©)
   â”œâ”€ batch-api.js
   â”œâ”€ popup-manager.js
   â”œâ”€ state-manager.js
   â”œâ”€ settings-manager.js
   â”œâ”€ camera-system.js (ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ãƒ»å¤‰æ›)
   â”œâ”€ layer-transform.js (ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢)
   â”œâ”€ checker-utils.js (ãƒã‚§ãƒƒã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆ)
   â”œâ”€ layer-system.js (ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ãƒ»èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”Ÿæˆ)
   â”œâ”€ drawing-clipboard.js
   â”œâ”€ history.js
   â”œâ”€ virtual-album.js
   â””â”€ animation-system.js
   â†“
6. WebGPUåŸºç›¤
   â”œâ”€ webgpu-capabilities.js
   â”œâ”€ webgpu-drawing-layer.js
   â”œâ”€ webgpu-compute-sdf.js
   â”œâ”€ webgpu-compute-msdf.js
   â””â”€ webgpu-texture-bridge.js
   â†“
7. Drawing System
   â”œâ”€ pointer-handler.js (ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†)
   â”œâ”€ pressure-handler.js (ç­†åœ§å‡¦ç†)
   â”œâ”€ curve-interpolator.js (æ›²ç·šè£œé–“)
   â”œâ”€ stroke-recorder.js (ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ²)
   â”œâ”€ sdf-brush-shader.js (SDFã‚·ã‚§ãƒ¼ãƒ€ãƒ¼)
   â”œâ”€ sdf-texture-generator.js
   â”œâ”€ sdf-mesh-builder.js
   â”œâ”€ stroke-renderer.js (æç”»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°)
   â”œâ”€ thumbnail-system.js (ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ)
   â”œâ”€ brush-settings.js
   â”œâ”€ brush-core.js
   â””â”€ drawing-engine.js (æç”»ã‚¨ãƒ³ã‚¸ãƒ³çµ±åˆ)
   â†“
8. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ 
   â”œâ”€ export-manager.js
   â”œâ”€ png-exporter.js
   â”œâ”€ apng-exporter.js
   â”œâ”€ gif-exporter.js
   â”œâ”€ webp-exporter.js
   â””â”€ mp4-exporter.js
   â†“
9. UI
   â”œâ”€ dom-builder.js (DOMæ§‹ç¯‰)
   â”œâ”€ slider-utils.js
   â”œâ”€ keyboard-handler.js
   â”œâ”€ resize-popup.js
   â”œâ”€ layer-panel-renderer.js (âš ï¸ å•é¡Œç®‡æ‰€)
   â”œâ”€ status-display-renderer.js
   â”œâ”€ timeline-thumbnail-utils.js
   â”œâ”€ timeline-ui.js
   â”œâ”€ album-popup.js
   â”œâ”€ settings-popup.js
   â”œâ”€ quick-access-popup.js
   â”œâ”€ export-popup.js
   â””â”€ ui-panels.js
   â†“
10. ã‚³ã‚¢ãƒ©ãƒ³ã‚¿ã‚¤ãƒ 
    â”œâ”€ core-runtime.js (APIå…¬é–‹)
    â”œâ”€ core-engine.js (ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ)
    â””â”€ core-initializer.js (åˆæœŸåŒ–ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
```

---

## ğŸ” èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«å•é¡Œã®è¨ºæ–­

### å•é¡Œã®ç—‡çŠ¶
- èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚µãƒ ãƒã‚¤ãƒ«æ å†…ã«**å°ã•ãªç‚¹ã®ã¿è¡¨ç¤º**
- ã‚µãƒ ãƒã‚¤ãƒ«æ ï¼ˆborderï¼‰ã¯è¦‹ãˆã‚‹ãŒã€**å†…å®¹ï¼ˆè‰²è¦‹æœ¬ï¼‰ãŒè¦‹ãˆãªã„**

### ğŸ” æ ¹æœ¬åŸå› ã®ç‰¹å®š

#### 1. å®Ÿè£…ãƒ•ãƒ­ãƒ¼ã®ç¢ºèª

**layer-panel-renderer.js: createThumbnail()**
```javascript
// èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å ´åˆã®å‡¦ç†
if (isBackground) {
    const swatch = document.createElement('div');
    swatch.className = 'background-color-swatch';
    
    // âš ï¸ å•é¡Œç®‡æ‰€: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
    swatch.style.width = '100%';
    swatch.style.height = '100%';
    swatch.style.display = 'block';
    swatch.style.boxSizing = 'border-box';
    
    const isVisible = layer.layerData?.visible !== false;
    
    if (!isVisible) {
        // éè¡¨ç¤ºæ™‚: ãƒã‚§ãƒƒã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³
        const dataUrl = window.checkerUtils.createThumbnailCheckerDataURL(74, 40, 8);
        swatch.style.backgroundImage = `url(${dataUrl})`;
    } else {
        // âœ… è¡¨ç¤ºæ™‚: backgroundColor ã‚’åæ˜ 
        const bgColor = layer.layerData.backgroundColor ?? 0xf0e0d6;
        const colorHex = '#' + bgColor.toString(16).padStart(6, '0');
        swatch.style.backgroundColor = colorHex;
    }
    
    thumbnailContainer.appendChild(swatch);
    return thumbnailContainer;
}
```

**thumbnailContainer ã®è¨­å®š**
```javascript
thumbnailContainer.style.cssText = `
    box-sizing: border-box;
    max-width: ${maxThumbnailWidth}px;  // 74px
    max-height: ${maxThumbnailHeight}px; // 40px
    width: ${maxThumbnailWidth}px;
    height: ${maxThumbnailHeight}px;
    border: 1px solid #cf9c97;
    display: flex;  // âš ï¸ ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹
    align-items: center;
    justify-content: center;
`;
```

### ğŸ› å•é¡Œã®åˆ†æ

#### A. CSSç«¶åˆã®å¯èƒ½æ€§
è¦ªè¦ç´ (`thumbnailContainer`)ãŒ`display: flex`ã§ã€å­è¦ç´ (`swatch`)ãŒ`display: block`ã®å ´åˆã€ã‚µã‚¤ã‚ºè¨ˆç®—ã«å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

#### B. åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°
`layer.layerData.backgroundColor`ãŒåˆæœŸåŒ–å‰ã«èª­ã¿å–ã‚‰ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã€‚

#### C. ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®å•é¡Œ
`width: 100%`, `height: 100%`ãŒã€ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§æ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ãªã„å¯èƒ½æ€§ã€‚

### âœ… ä¿®æ­£æ–¹æ³•

#### ä¿®æ­£1: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã®å®Œå…¨æŒ‡å®š

```javascript
// createThumbnail() å†…ã®èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼å‡¦ç†ã‚’ä¿®æ­£
if (isBackground) {
    const swatch = document.createElement('div');
    swatch.className = 'background-color-swatch';
    
    // âœ… ä¿®æ­£: æ˜ç¤ºçš„ãªã‚µã‚¤ã‚ºæŒ‡å®š
    swatch.style.cssText = `
        width: 74px;
        height: 40px;
        display: block;
        box-sizing: border-box;
    `;
    
    const isVisible = layer.layerData?.visible !== false;
    
    if (!isVisible) {
        if (window.checkerUtils) {
            const dataUrl = window.checkerUtils.createThumbnailCheckerDataURL(74, 40, 8);
            swatch.style.backgroundImage = `url(${dataUrl})`;
            swatch.style.backgroundRepeat = 'no-repeat';
            swatch.style.backgroundSize = 'cover';
            swatch.style.backgroundPosition = 'center';
        } else {
            swatch.style.backgroundColor = '#cccccc';
        }
    } else {
        const bgColor = layer.layerData?.backgroundColor ?? 0xf0e0d6;
        const colorHex = '#' + bgColor.toString(16).padStart(6, '0');
        swatch.style.backgroundColor = colorHex;
    }
    
    thumbnailContainer.appendChild(swatch);
    return thumbnailContainer;
}
```

#### ä¿®æ­£2: è¦ªã‚³ãƒ³ãƒ†ãƒŠã®displayã‚’blockã«å¤‰æ›´

```javascript
thumbnailContainer.style.cssText = `
    box-sizing: border-box;
    width: 74px;
    height: 40px;
    border: 1px solid #cf9c97;
    display: block;  // âœ… flexã‹ã‚‰blockã«å¤‰æ›´
    overflow: hidden;
    border-radius: 2px;
`;
```

#### ä¿®æ­£3: main.cssã®ç¢ºèªãƒ»è¿½åŠ 

```css
/* main.css ã«è¿½åŠ  */
.layer-thumbnail {
    display: block !important;  /* flexã‚’ä¸Šæ›¸ã */
    width: 74px !important;
    height: 40px !important;
}

.background-color-swatch {
    width: 74px !important;
    height: 40px !important;
    display: block !important;
    box-sizing: border-box;
}
```

---

## ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°

### 1ï¸âƒ£ **layer-system.js** - ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã®ä¸­æ¢

#### è²¬å‹™
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½œæˆãƒ»å‰Šé™¤ãƒ»ä¸¦ã³æ›¿ãˆ
- èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸåŒ–ã¨ç®¡ç†
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¯è¦–æ€§ãƒ»é€æ˜åº¦åˆ¶å¾¡
- ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†

#### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

| ãƒ¡ã‚½ãƒƒãƒ‰å | å¼•æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|-----------|------|--------|------|
| `init(canvasContainer, eventBus, config)` | ã‚³ãƒ³ãƒ†ãƒŠ, EventBus, è¨­å®š | void | ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã€èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ |
| `createLayer(name, isBackground)` | åå‰, èƒŒæ™¯ãƒ•ãƒ©ã‚° | {layer, index} | æ–°è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ |
| `setActiveLayer(index)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå· | void | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ›´ |
| `toggleLayerVisibility(index)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå· | void | è¡¨ç¤º/éè¡¨ç¤ºåˆ‡æ›¿ |
| `changeBackgroundLayerColor(index, layerId)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå·, ID | void | èƒŒæ™¯è‰²ã‚’ç¾åœ¨ã®ãƒšãƒ³ã‚«ãƒ©ãƒ¼ã«å¤‰æ›´ |
| `setLayerOpacity(index, opacity)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå·, é€æ˜åº¦ | void | ãƒ¬ã‚¤ãƒ¤ãƒ¼é€æ˜åº¦è¨­å®š(0-1) |
| `addPathToActiveLayer(path)` | ãƒ‘ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | void | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç”»è¿½åŠ  |

#### ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
```javascript
'layer:created'              // ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆæ™‚
'layer:deleted'              // ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤æ™‚
'layer:activated'            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–æ™‚
'layer:visibility-changed'   // å¯è¦–æ€§å¤‰æ›´æ™‚
'layer:opacity-changed'      // é€æ˜åº¦å¤‰æ›´æ™‚
'layer:background-color-changed' // èƒŒæ™¯è‰²å¤‰æ›´æ™‚
'layer:stroke-added'         // ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¿½åŠ æ™‚
'thumbnail:layer-updated'    // ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°è¦æ±‚
```

#### èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼
```
LayerSystem.init()
  â†“
èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼Containerä½œæˆ
  â†“
LayerModelç”Ÿæˆ (isBackground: true)
  â†“
_createSolidBackground() â†’ PIXI.Graphicsä½œæˆ
  â†“
backgroundGraphicsä¿å­˜
  â†“
backgroundColorä¿å­˜ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0xf0e0d6)
  â†“
Container.addChild(background)
```

---

### 2ï¸âƒ£ **layer-panel-renderer.js** - UIè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯

#### è²¬å‹™
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®DOMæ§‹ç¯‰
- ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºï¼ˆé€šå¸¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—é †åºå¤‰æ›´
- ãƒ¬ã‚¤ãƒ¤ãƒ¼åç·¨é›†

#### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

| ãƒ¡ã‚½ãƒƒãƒ‰å | å¼•æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|-----------|------|--------|------|
| `render(layers, activeIndex, animationSystem)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼é…åˆ—, ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç•ªå·, ã‚¢ãƒ‹ãƒ¡ã‚·ã‚¹ãƒ†ãƒ  | void | ãƒ‘ãƒãƒ«å…¨ä½“å†æç”» |
| `createLayerElement(layer, index, isActive, animationSystem)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼, ç•ªå·, ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ©ã‚°, ã‚¢ãƒ‹ãƒ¡ã‚·ã‚¹ãƒ†ãƒ  | HTMLElement | 1ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†ã®DOMç”Ÿæˆ |
| `createThumbnail(layer, index)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼, ç•ªå· | HTMLElement | **ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼ˆå•é¡Œç®‡æ‰€ï¼‰** |
| `_updateSingleThumbnail(layerIndex)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå· | Promise<void> | å˜ä¸€ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–° |
| `updateAllThumbnails()` | - | Promise<void> | å…¨ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–° |

#### ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆãƒ•ãƒ­ãƒ¼

```
createThumbnail(layer, index)
  â†“
layer.layerData.isBackground ? 
  â”œâ”€ YES â†’ è‰²è¦‹æœ¬<div>ç”Ÿæˆ
  â”‚        â”œâ”€ visible=false â†’ ãƒã‚§ãƒƒã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³
  â”‚        â””â”€ visible=true  â†’ backgroundColoråæ˜ 
  â”‚
  â””â”€ NO  â†’ ThumbnailSystem.generateLayerThumbnail()
           â””â”€ PixiJS RenderTextureçµŒç”±ã§ç”»åƒåŒ–
```

---

### 3ï¸âƒ£ **thumbnail-system.js** - ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³

#### è²¬å‹™
- é€šå¸¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®PixiJSãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
- ã‚µãƒ ãƒã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
- RenderTextureãƒ—ãƒ¼ãƒ«ç®¡ç†

#### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

| ãƒ¡ã‚½ãƒƒãƒ‰å | å¼•æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|-----------|------|--------|------|
| `generateLayerThumbnail(layer, index, maxW, maxH)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼, ç•ªå·, æœ€å¤§å¹…, æœ€å¤§é«˜ | Promise<{dataUrl, width, height}> | **èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å³åº§ã«nullã‚’è¿”ã™** |
| `_renderLayerThumbnail(layer, maxW, maxH)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼, æœ€å¤§å¹…, æœ€å¤§é«˜ | Promise<Object> | å®Ÿéš›ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç† |
| `generateFrameThumbnail(frame, maxW, maxH)` | ãƒ•ãƒ¬ãƒ¼ãƒ , æœ€å¤§å¹…, æœ€å¤§é«˜ | Promise<Object> | ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ ãƒã‚¤ãƒ« |
| `invalidateLayerCache(index)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå· | void | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ– |

#### èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç‰¹åˆ¥æ‰±ã„
```javascript
async generateLayerThumbnail(layer, ...) {
    // âš ï¸ èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã“ã“ã§å³ãƒªã‚¿ãƒ¼ãƒ³
    if (layer.layerData?.isBackground) {
        return null;  // layer-panel-rendererã§ç›´æ¥æç”»
    }
    // ...é€šå¸¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‡¦ç†
}
```

---

### 4ï¸âƒ£ **checker-utils.js** - ãƒã‚§ãƒƒã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆ

#### è²¬å‹™
- ã‚­ãƒ£ãƒ³ãƒã‚¹ç”¨ãƒã‚§ãƒƒã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆPIXI.Graphicsï¼‰
- ã‚µãƒ ãƒã‚¤ãƒ«ç”¨ãƒã‚§ãƒƒã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆCanvasï¼‰
- Futabaé…è‰²ã®çµ±ä¸€ç®¡ç†

#### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

| ãƒ¡ã‚½ãƒƒãƒ‰å | å¼•æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|-----------|------|--------|------|
| `createCanvasChecker(width, height)` | å¹…, é«˜ã• | PIXI.Graphics | ã‚­ãƒ£ãƒ³ãƒã‚¹èƒŒæ™¯ç”¨ãƒã‚§ãƒƒã‚«ãƒ¼ |
| `createThumbnailCheckerCanvas(w, h, sq)` | å¹…, é«˜ã•, ãƒã‚¹ã‚µã‚¤ã‚º | HTMLCanvasElement | ã‚µãƒ ãƒã‚¤ãƒ«ç”¨ãƒã‚§ãƒƒã‚«ãƒ¼ |
| `createThumbnailCheckerDataURL(w, h, sq)` | å¹…, é«˜ã•, ãƒã‚¹ã‚µã‚¤ã‚º | string | DataURLå½¢å¼ã®ãƒã‚§ãƒƒã‚«ãƒ¼ |
| `resizeCanvasChecker(checker, newW, newH)` | æ—¢å­˜ãƒã‚§ãƒƒã‚«ãƒ¼, æ–°å¹…, æ–°é«˜ | PIXI.Graphics | ãƒªã‚µã‚¤ã‚º |

#### é…è‰²å®šç¾©
```javascript
color1 = 0xf0e0d6  // Futaba cream
color2 = 0xffffee  // Futaba background
squareSize = 16    // 16x16pxå›ºå®šï¼ˆã‚ºãƒ¼ãƒ å½±éŸ¿ãªã—ï¼‰
```

---

### 5ï¸âƒ£ **data-models.js** - ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å®šç¾©

#### LayerModel

```javascript
class LayerModel {
    constructor(data = {}) {
        this.id = data.id || è‡ªå‹•ç”Ÿæˆ;
        this.name = data.name || 'ãƒ¬ã‚¤ãƒ¤ãƒ¼';
        this.visible = data.visible !== undefined ? data.visible : true;
        this.opacity = data.opacity !== undefined ? data.opacity : 1.0;
        this.isBackground = data.isBackground || false;
        this.backgroundColor = data.backgroundColor ?? 0xf0e0d6; // âš ï¸ é‡è¦
        this.paths = data.paths || [];
        this.maskTexture = null;
        this.maskSprite = null;
    }
    
    initializeMask(width, height, renderer) { ... }
    destroyMask() { ... }
    hasMask() { ... }
}
```

#### ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
```javascript
LAYER_SCHEMA = {
    backgroundColor: { 
        type: 'number', 
        default: 0xf0e0d6, 
        editable: true 
    },
    // ...
}
```

---

## åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### å¤‰æ›ã®æµã‚Œï¼ˆå³æ ¼ï¼‰

```
PointerEvent.clientX/Y
  â†“ screenClientToCanvas() [DPIè£œæ­£]
Canvasåº§æ¨™ (DPRè€ƒæ…®)
  â†“ canvasToWorld() [worldContaineré€†è¡Œåˆ—]
Worldåº§æ¨™
  â†“ worldToLocal() [æ‰‹å‹•é€†ç®—]
Localåº§æ¨™ (ãƒ¬ã‚¤ãƒ¤ãƒ¼ç›¸å¯¾)
  â†“ strokeRecorder.addPoint()
è¨˜éŒ²
```

### âš ï¸ äºŒé‡å¤‰æ›ã®ç¦æ­¢

âŒ **ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³**
```javascript
// drawing-engine.js
const localX = worldToLocal(worldX, worldY);
// â†“ åº§æ¨™ã‚’æ¸¡ã™
strokeRecorder.startStroke(localX, localY, pressure);
// â†“ stroke-recorder.js
startStroke(x, y, pressure) {
    // âŒ å†åº¦å¤‰æ›ã—ã¦ã¯ã„ã‘ãªã„
    const {localX, localY} = this.screenToLayer(x, y);
    this.addPoint(localX, localY, pressure);
}
```

âœ… **æ­£ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³**
```javascript
// drawing-engine.js
const localX = worldToLocal(worldX, worldY);
strokeRecorder.startStroke(localX, localY, pressure);

// stroke-recorder.js
startStroke(localX, localY, pressure) {
    // âœ… å—ã‘å–ã£ãŸåº§æ¨™ã‚’ãã®ã¾ã¾è¨˜éŒ²
    this.addPoint(localX, localY, pressure);
}
```

---

## ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ãƒãƒƒãƒ—

### ãƒ¬ã‚¤ãƒ¤ãƒ¼é–¢é€£

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ
  â†“
UI (layer-panel-renderer.js)
  â†“ 'ui:background-color-change-requested'
EventBus
  â†“
layer-system.js: changeBackgroundLayerColor()
  â†“ Graphicsæ›´æ–°
  â†“ 'layer:background-color-changed'
  â†“ 'thumbnail:layer-updated'
EventBus
  â†“
layer-panel-renderer.js: _updateSingleThumbnail()
  â†“
createThumbnail() å†å®Ÿè¡Œ
```

### ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼

| ã‚¤ãƒ™ãƒ³ãƒˆå | ç™ºè¡Œå…ƒ | å—ä¿¡å…ˆ | å†…å®¹ |
|-----------|--------|--------|------|
| `thumbnail:layer-updated` | layer-system.js | layer-panel-renderer.js | å˜ä¸€ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–°è¦æ±‚ |
| `layer:stroke-added` | layer-system.js | thumbnail-system.js | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¿½åŠ  |
| `layer:transform-updated` | layer-transform.js | thumbnail-system.js | å¤‰å½¢å®Œäº† |
| `camera:resized` | camera-system.js | layer-system.js, thumbnail-system.js | ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒªã‚µã‚¤ã‚º |

---

## ãƒ‡ãƒãƒƒã‚°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«å•é¡Œã®ãƒã‚§ãƒƒã‚¯é …ç›®

#### ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ç¢ºèª
```javascript
// 1. ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã®ç¢ºèª
const layers = window.layerManager.getLayers();
const bgLayer = layers[0];
console.log('èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼:', bgLayer);
console.log('isBackground:', bgLayer.layerData.isBackground);
console.log('backgroundColor:', bgLayer.layerData.backgroundColor);
console.log('backgroundGraphics:', bgLayer.layerData.backgroundGraphics);

// 2. DOMè¦ç´ ã®ç¢ºèª
const thumbnails = document.querySelectorAll('.layer-thumbnail');
const bgThumbnail = thumbnails[thumbnails.length - 1]; // æœ€å¾ŒãŒèƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼
console.log('ã‚µãƒ ãƒã‚¤ãƒ«HTML:', bgThumbnail.outerHTML);

// 3. è‰²è¦‹æœ¬è¦ç´ ã®ç¢ºèª
const swatch = bgThumbnail.querySelector('.background-color-swatch');
console.log('è‰²è¦‹æœ¬è¦ç´ :', swatch);
console.log('è¨ˆç®—æ¸ˆã¿ã‚¹ã‚¿ã‚¤ãƒ«:', window.getComputedStyle(swatch));

// 4. å¼·åˆ¶æ›´æ–°
window.layerPanelRenderer._updateSingleThumbnail(0);
```

#### ä¿®æ­£å¾Œã®ç¢ºèªãƒã‚¤ãƒ³ãƒˆ
- âœ… ã‚µãƒ ãƒã‚¤ãƒ«æ ï¼ˆ74x40pxï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
- âœ… è‰²è¦‹æœ¬è¦ç´ ã®ã‚µã‚¤ã‚ºãŒ74x40pxã«ãªã£ã¦ã„ã‚‹
- âœ… `backgroundColor`ãŒ16é€²æ•°ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦é©ç”¨ã•ã‚Œã¦ã„ã‚‹
- âœ… èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã§è‰²è¦‹æœ¬ã¨ãƒã‚§ãƒƒã‚«ãƒ¼ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹

---

## ã¾ã¨ã‚

### ğŸ¯ å•é¡Œã®æœ¬è³ª
- **è¦ªè¦ç´ ã®display: flex**ã¨**å­è¦ç´ ã®width/height: 100%**ã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚Šã€è‰²è¦‹æœ¬è¦ç´ ãŒæ­£ã—ãã‚µã‚¤ã‚ºè¨ˆç®—ã•ã‚Œã¦ã„ãªã„
- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ãŒä¸å®Œå…¨ã§ã€CSSç¶™æ‰¿ã®å½±éŸ¿ã‚’å—ã‘ã¦ã„ã‚‹

### âœ… æ¨å¥¨ä¿®æ­£
1. **layer-panel-renderer.js**: è‰²è¦‹æœ¬è¦ç´ ã«æ˜ç¤ºçš„ãªå›ºå®šã‚µã‚¤ã‚ºï¼ˆ74x40pxï¼‰ã‚’æŒ‡å®š
2. **thumbnailContainerã®display**: `flex` â†’ `block`ã«å¤‰æ›´
3. **main.css**: `!important`ã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¼·åˆ¶é©ç”¨

### ğŸ“ äºˆé˜²ç­–
- ã™ã¹ã¦ã®ã‚µã‚¤ã‚ºæŒ‡å®šã¯`px`ã§æ˜ç¤ºçš„ã«
- ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã¯è¦ªè¦ç´ ã®`display`å±æ€§ã‚’è€ƒæ…®
- èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç‰¹åˆ¥æ‰±ã„ã‚’å¿˜ã‚Œãªã„ï¼ˆ`isBackground`ãƒ•ãƒ©ã‚°ã§åˆ†å²ï¼‰