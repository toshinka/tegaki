================================================================================
Layer System æ®µéšçš„æ”¹ä¿®è¨ˆç”»æ›¸ (æ©Ÿèƒ½åˆ¥æ°´å¹³åˆ†å‰²ç‰ˆ)
================================================================================

ğŸ¯ æ”¹ä¿®ç›®æ¨™
layer-system.js (1,500è¡Œ) ã‚’æ©Ÿèƒ½åˆ¥ã«3åˆ†å‰²ã—ã€40%è»½é‡åŒ–ã€‚
æ—¢å­˜APIäº’æ›æ€§ã‚’ç¶­æŒã—ã¤ã¤ã€æ®µéšçš„ã«å®‰å…¨ã«ç§»è¡Œã™ã‚‹ã€‚

================================================================================
Phase 1: LayerTransform åˆ†é›¢ï¼ˆå¤‰å½¢æ©Ÿèƒ½ã®ç‹¬ç«‹åŒ–ï¼‰
================================================================================

ğŸ“‹ å¯¾è±¡æ©Ÿèƒ½
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ»å›è»¢ãƒ»æ‹¡å¤§ç¸®å°ãƒ»åè»¢
- Vã‚­ãƒ¼ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
- å¤‰å½¢ãƒ‘ãƒãƒ«åˆ¶å¾¡
- ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œ
- å¤‰å½¢ç¢ºå®šãƒ»åº§æ¨™å¤‰æ›

ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
ã€æ–°è¦ä½œæˆã€‘
  system/layer-transform.js (300-400è¡Œ)

ã€æ”¹ä¿®å¯¾è±¡ã€‘
  system/layer-system.js (1,500è¡Œ â†’ 1,200è¡Œ)

ã€å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
  system/layer-system.js (ç§»å‹•å…ƒãƒ¡ã‚½ãƒƒãƒ‰ã®ç¢ºèª)
  coordinate-system.js (åº§æ¨™å¤‰æ›APIã®ç¢ºèª)
  config.js (layerè¨­å®šã®ç¢ºèª)

---

ğŸ“ layer-transform.js å®Ÿè£…å†…å®¹

ã€ã‚¯ãƒ©ã‚¹å®šç¾©ã€‘
class LayerTransform {
    constructor(config, coordAPI)
    
    // çŠ¶æ…‹ç®¡ç†
    transforms: Map<layerId, {x, y, rotation, scaleX, scaleY}>
    isVKeyPressed: boolean
    isDragging: boolean
    dragLastPoint: {x, y}
    transformPanel: HTMLElement
    
    // åˆæœŸåŒ–
    init(app, cameraSystem)
    
    // ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡
    enterMoveMode()
    exitMoveMode()
    toggleMoveMode()
    
    // å¤‰å½¢æ“ä½œ
    updateTransform(layer, property, value)
    applyTransform(layer, transform)
    flipLayer(layer, direction)
    moveLayer(layer, direction, amount)
    scaleLayer(layer, factor)
    rotateLayer(layer, angle)
    
    // å¤‰å½¢ç¢ºå®š
    confirmTransform(layer)
    applyTransformToPaths(layer, transform)
    
    // å†…éƒ¨å‡¦ç†
    _setupTransformPanel()
    _setupDragEvents(canvas)
    _handleDrag(event)
    _createTransformMatrix(transform, centerX, centerY)
    _transformPoints(points, matrix)
    _isTransformNonDefault(transform)
    _updateCursor(canvas)
    
    // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    onTransformComplete: Function
    onTransformUpdate: Function
}

ã€ç§»å‹•å¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ (layer-system.js ã‹ã‚‰)ã€‘
- enterLayerMoveMode()
- exitLayerMoveMode()
- toggleLayerMoveMode()
- updateActiveLayerTransform()
- flipActiveLayer()
- moveActiveLayer()
- transformActiveLayer()
- confirmLayerTransform()
- safeApplyTransformToPaths()
- createTransformMatrix()
- safeTransformPoints()
- isTransformNonDefault()
- updateCursor()
- _applyTransformDirect()
- _setupLayerTransformPanel()
- _setupLayerSlider()
- _setupLayerDragEvents()
- _getSafeCanvas()
- _handleLayerDrag()
- updateLayerTransformPanelValues()
- updateFlipButtons()

ã€ä¾å­˜é–¢ä¿‚ã€‘
- window.CoordinateSystem (åº§æ¨™å¤‰æ›)
- PIXI.Matrix (è¡Œåˆ—è¨ˆç®—)
- this.config.layer.* (è¨­å®šå€¤)
- this.config.canvas.* (ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º)

ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã€‘
_setupLayerOperations() å†…ã®ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã‚’åˆ†é›¢:
- LAYER_MOVE_MODE_TOGGLE
- LAYER_MOVE_UP/DOWN/LEFT/RIGHT
- LAYER_SCALE_UP/DOWN
- LAYER_ROTATE_LEFT/RIGHT
- LAYER_FLIP_HORIZONTAL/VERTICAL

---

ğŸ“ layer-system.js æ”¹ä¿®å†…å®¹

ã€è¿½åŠ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€‘
this.transform: LayerTransform

ã€init() ã§ã®åˆæœŸåŒ–ã€‘
this.transform = new LayerTransform(this.config, this.coordAPI);
this.transform.init(this.app, this.cameraSystem);
this.transform.onTransformComplete = (layer) => {
    this.requestThumbnailUpdate(this.getLayerIndex(layer));
    this.eventBus.emit('layer:transform-confirmed', {layerId: layer.layerData.id});
};
this.transform.onTransformUpdate = (layer, transform) => {
    this.eventBus.emit('layer:updated', {layerId: layer.layerData.id, transform});
};

ã€å§”è­²ãƒ¡ã‚½ãƒƒãƒ‰ (å…¬é–‹APIç¶­æŒ)ã€‘
enterLayerMoveMode() {
    return this.transform.enterMoveMode();
}

exitLayerMoveMode() {
    const activeLayer = this.getActiveLayer();
    return this.transform.exitMoveMode(activeLayer);
}

flipActiveLayer(direction) {
    const activeLayer = this.getActiveLayer();
    return this.transform.flipLayer(activeLayer, direction);
}

// ä»¥ä¸‹åŒæ§˜ã«ã™ã¹ã¦ã®å¤‰å½¢é–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å§”è­²

ã€å‰Šé™¤ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
ä¸Šè¨˜ã€Œç§»å‹•å¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ã€ã‚’ã™ã¹ã¦å‰Šé™¤

ã€_setupLayerOperations() æ”¹ä¿®ã€‘
å¤‰å½¢é–¢é€£ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’LayerTransformã«å§”è­²:
case 'LAYER_MOVE_MODE_TOGGLE':
    this.transform.toggleMoveMode();
    e.preventDefault();
    break;

---

âœ… Phase 1 å®Œäº†æ¡ä»¶
- LayerTransformå˜ä½“ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–å¯èƒ½
- ã™ã¹ã¦ã®å¤‰å½¢æ“ä½œãŒæ­£å¸¸å‹•ä½œ
- Vã‚­ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®å…¥é€€å‡ºãŒæ­£å¸¸
- å¤‰å½¢ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºãƒ»æ›´æ–°ãŒæ­£å¸¸
- Historyçµ±åˆãŒæ­£å¸¸
- æ—¢å­˜ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãŒå‹•ä½œ

ğŸ§ª ãƒ†ã‚¹ãƒˆé …ç›®
- Vã‚­ãƒ¼æŠ¼ä¸‹â†’ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ¢ãƒ¼ãƒ‰å…¥é€€å‡º
- çŸ¢å°ã‚­ãƒ¼ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•
- Shift+çŸ¢å°ã‚­ãƒ¼ã§æ‹¡å¤§ç¸®å°ãƒ»å›è»¢
- ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•
- Shift+ãƒ‰ãƒ©ãƒƒã‚°ã§æ‹¡å¤§ç¸®å°ãƒ»å›è»¢
- åè»¢ãƒœã‚¿ãƒ³ã§æ°´å¹³ãƒ»å‚ç›´åè»¢
- Vã‚­ãƒ¼é›¢è„±æ™‚ã®å¤‰å½¢ç¢ºå®š
- Undo/Redoã§å¤‰å½¢ã®å¾©å…ƒ

================================================================================
Phase 2: LayerRendering åˆ†é›¢ï¼ˆæç”»æ©Ÿèƒ½ã®ç‹¬ç«‹åŒ–ï¼‰
================================================================================

ğŸ“‹ å¯¾è±¡æ©Ÿèƒ½
- PathGraphicså†æ§‹ç¯‰
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
- RenderTextureç®¡ç†
- Canvas2Dæç”»å‡¦ç†

ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
ã€æ–°è¦ä½œæˆã€‘
  system/layer-rendering.js (250-350è¡Œ)

ã€æ”¹ä¿®å¯¾è±¡ã€‘
  system/layer-system.js (1,200è¡Œ â†’ 900è¡Œ)

ã€å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
  system/layer-system.js (ç§»å‹•å…ƒãƒ¡ã‚½ãƒƒãƒ‰ã®ç¢ºèª)
  config.js (thumbnailè¨­å®šã®ç¢ºèª)

---

ğŸ“ layer-rendering.js å®Ÿè£…å†…å®¹

ã€ã‚¯ãƒ©ã‚¹å®šç¾©ã€‘
class LayerRendering {
    constructor(config)
    
    // çŠ¶æ…‹ç®¡ç†
    app: PIXI.Application
    renderer: PIXI.Renderer
    thumbnailQueue: Set<layerIndex>
    thumbnailTimer: number
    cutRenderTextures: Map<cutId, RenderTexture>
    cutThumbnailDirty: Map<cutId, boolean>
    
    // åˆæœŸåŒ–
    setApp(app)
    startThumbnailProcess()
    
    // Pathæç”»
    rebuildPathGraphics(path)
    
    // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
    generateThumbnail(layer, panelElement, config)
    calculateThumbnailSize(canvasWidth, canvasHeight)
    requestThumbnailUpdate(layerIndex)
    processThumbnailUpdates(layers)
    
    // RenderTextureç®¡ç†
    createCutRenderTexture(cutId, width, height)
    renderCutToTexture(cutId, container)
    getCutRenderTexture(cutId)
    destroyCutRenderTexture(cutId)
    markCutThumbnailDirty(cutId)
    isCutThumbnailDirty(cutId)
    clearCutThumbnailDirty(cutId)
    
    // å†…éƒ¨å‡¦ç†
    _renderLayerToTexture(layer, width, height, scale)
    _createCanvas(width, height)
    _saveLayerState(layer)
    _restoreLayerState(layer, state)
}

ã€ç§»å‹•å¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ (layer-system.js ã‹ã‚‰)ã€‘
- rebuildPathGraphics()
- updateThumbnail()
- requestThumbnailUpdate()
- processThumbnailUpdates()
- _startThumbnailUpdateProcess()
- createCutRenderTexture()
- renderCutToTexture()
- getCutRenderTexture()
- destroyCutRenderTexture()
- markCutThumbnailDirty()
- isCutThumbnailDirty()
- clearCutThumbnailDirty()

ã€ä¾å­˜é–¢ä¿‚ã€‘
- PIXI.Graphics
- PIXI.RenderTexture
- PIXI.Container
- getStroke() (Perfect Freehand)
- this.config.canvas.* (ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º)
- this.config.thumbnail.* (ã‚µãƒ ãƒã‚¤ãƒ«è¨­å®š)
- this.config.background.* (èƒŒæ™¯è‰²)

ã€rebuildPathGraphics() å®Ÿè£…æ³¨æ„ã€‘
- Perfect Freehandåˆ©ç”¨å¯èƒ½æ™‚ã¯é«˜å“è³ªæç”»
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å††ã®é€£ç¶šæç”»
- Graphicsç ´æ£„å‡¦ç†ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
- path.graphics ã«æ–°ã—ã„Graphicsã‚’è¨­å®š

ã€generateThumbnail() å®Ÿè£…æ³¨æ„ã€‘
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¤‰å½¢çŠ¶æ…‹ã‚’ä¿å­˜
- å¤‰å½¢ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- å¤‰å½¢çŠ¶æ…‹ã‚’å¾©å…ƒ
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å…ƒã®ä½ç½®ã«æˆ»ã™
- RenderTextureã®ç ´æ£„ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ

---

ğŸ“ layer-system.js æ”¹ä¿®å†…å®¹

ã€è¿½åŠ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€‘
this.rendering: LayerRendering

ã€init() ã§ã®åˆæœŸåŒ–ã€‘
this.rendering = new LayerRendering(this.config);
this.rendering.setApp(this.app);
this.rendering.startThumbnailProcess();

ã€å§”è­²ãƒ¡ã‚½ãƒƒãƒ‰ (å…¬é–‹APIç¶­æŒ)ã€‘
rebuildPathGraphics(path) {
    return this.rendering.rebuildPathGraphics(path);
}

requestThumbnailUpdate(layerIndex) {
    return this.rendering.requestThumbnailUpdate(layerIndex);
}

createCutRenderTexture(cutId) {
    return this.rendering.createCutRenderTexture(
        cutId, 
        this.config.canvas.width, 
        this.config.canvas.height
    );
}

// ä»¥ä¸‹åŒæ§˜ã«ã™ã¹ã¦ã®æç”»é–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å§”è­²

ã€updateThumbnail() æ”¹ä¿®ã€‘
// LayerRenderingã«å§”è­²ã—ã€ãƒ‘ãƒãƒ«è¦ç´ ã®å–å¾—ã®ã¿LayerSystemã§å®Ÿè¡Œ
updateThumbnail(layerIndex) {
    const layers = this.getLayers();
    const layer = layers[layerIndex];
    const layerItems = document.querySelectorAll('.layer-item');
    const panelIndex = layers.length - 1 - layerIndex;
    const thumbnail = layerItems[panelIndex]?.querySelector('.layer-thumbnail');
    
    if (thumbnail) {
        this.rendering.generateThumbnail(layer, thumbnail, this.config);
    }
}

ã€processThumbnailUpdates() æ”¹ä¿®ã€‘
processThumbnailUpdates() {
    const layers = this.getLayers();
    this.rendering.processThumbnailUpdates(layers, (layerIndex) => {
        this.updateThumbnail(layerIndex);
    });
}

ã€å‰Šé™¤ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
ä¸Šè¨˜ã€Œç§»å‹•å¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ã€ã‚’ã™ã¹ã¦å‰Šé™¤

---

âœ… Phase 2 å®Œäº†æ¡ä»¶
- LayerRenderingå˜ä½“ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–å¯èƒ½
- Pathæç”»ãŒæ­£å¸¸å‹•ä½œ
- ã‚µãƒ ãƒã‚¤ãƒ«ç”ŸæˆãŒæ­£å¸¸å‹•ä½œ
- RenderTextureç®¡ç†ãŒæ­£å¸¸å‹•ä½œ
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãªã— (Graphicsç ´æ£„ç¢ºèª)
- æ—¢å­˜ã®æç”»å‡¦ç†ãŒã™ã¹ã¦å‹•ä½œ

ğŸ§ª ãƒ†ã‚¹ãƒˆé …ç›®
- ãƒšãƒ³ãƒ„ãƒ¼ãƒ«ã§æç”»â†’Path Graphicsç”Ÿæˆ
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã®ç”Ÿæˆãƒ»æ›´æ–°
- ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢å¾Œã®ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
- ã‚«ãƒƒãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ã®RenderTextureç”Ÿæˆ
- ã‚«ãƒƒãƒˆå‰Šé™¤æ™‚ã®RenderTextureç ´æ£„
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ç›£è¦–

================================================================================
Phase 3: LayerHierarchy åˆ†é›¢ï¼ˆéšå±¤ç®¡ç†ã®ç‹¬ç«‹åŒ–ï¼‰
================================================================================

ğŸ“‹ å¯¾è±¡æ©Ÿèƒ½
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒ»å‰Šé™¤
- ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
- Historyçµ±åˆ

ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
ã€æ–°è¦ä½œæˆã€‘
  system/layer-hierarchy.js (200-300è¡Œ)

ã€æ”¹ä¿®å¯¾è±¡ã€‘
  system/layer-system.js (900è¡Œ â†’ 600è¡Œ)

ã€å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
  system/layer-system.js (ç§»å‹•å…ƒãƒ¡ã‚½ãƒƒãƒ‰ã®ç¢ºèª)
  system/history.js (History APIã®ç¢ºèª)
  system/data-models.js (LayerModelã®ç¢ºèª)

---

ğŸ“ layer-hierarchy.js å®Ÿè£…å†…å®¹

ã€ã‚¯ãƒ©ã‚¹å®šç¾©ã€‘
class LayerHierarchy {
    constructor(config)
    
    // çŠ¶æ…‹ç®¡ç†
    container: PIXI.Container
    activeLayerIndex: number
    
    // ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ
    createLayer(name, isBackground)
    deleteLayer(index)
    getLayers()
    getActiveLayer()
    setActiveLayer(index)
    getLayerIndex(layer)
    
    // éšå±¤æ“ä½œ
    reorderLayers(fromIndex, toIndex)
    moveLayerHierarchy(index, direction)
    
    // å¯è¦–æ€§
    toggleLayerVisibility(index)
    
    // ãƒ‘ã‚¹è¿½åŠ 
    addPathToLayer(index, path)
    addPathToActiveLayer(path)
    
    // Containerç®¡ç†
    setContainer(container)
    
    // å†…éƒ¨å‡¦ç†
    _wrapWithHistory(action, name, meta)
    _createLayerContainer(layerModel, config)
    _updateActiveIndex(fromIndex, toIndex)
}

ã€ç§»å‹•å¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ (layer-system.js ã‹ã‚‰)ã€‘
- createLayer()
- deleteLayer()
- getLayers()
- getActiveLayer()
- setActiveLayer()
- reorderLayers()
- moveActiveLayerHierarchy()
- toggleLayerVisibility()
- addPathToLayer()
- addPathToActiveLayer()

ã€ä¾å­˜é–¢ä¿‚ã€‘
- PIXI.Container
- PIXI.Graphics
- window.TegakiDataModels.LayerModel
- window.History (å±¥æ­´ç®¡ç†)
- this.config.canvas.* (ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º)
- this.config.background.* (èƒŒæ™¯è‰²)

ã€createLayer() å®Ÿè£…æ³¨æ„ã€‘
- LayerModelã‚’ç”Ÿæˆ
- PIXI.Containerã‚’ç”Ÿæˆ
- backgroundGraphicsã®è¨­å®š (èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å ´åˆ)
- Historyçµ±åˆ
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: onCreate(layer, index)

ã€deleteLayer() å®Ÿè£…æ³¨æ„ã€‘
- èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å‰Šé™¤ä¸å¯
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®èª¿æ•´
- Historyçµ±åˆ
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: onDelete(layerId, index)

ã€reorderLayers() å®Ÿè£…æ³¨æ„ã€‘
- Containeréšå±¤ã®æ›´æ–°
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®èª¿æ•´
- Historyçµ±åˆ
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: onReorder(fromIndex, toIndex)

---

ğŸ“ layer-system.js æ”¹ä¿®å†…å®¹

ã€è¿½åŠ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€‘
this.hierarchy: LayerHierarchy

ã€init() ã§ã®åˆæœŸåŒ–ã€‘
this.hierarchy = new LayerHierarchy(this.config);
this.hierarchy.setContainer(this.currentCutContainer);
this.hierarchy.onCreate = (layer, index) => {
    this.updateLayerPanelUI();
    this.updateStatusDisplay();
    this.eventBus.emit('layer:created', {layerId: layer.layerData.id});
};
this.hierarchy.onDelete = (layerId, index) => {
    this.updateLayerPanelUI();
    this.updateStatusDisplay();
    this.eventBus.emit('layer:deleted', {layerId, layerIndex: index});
};
this.hierarchy.onReorder = (fromIndex, toIndex) => {
    this.updateLayerPanelUI();
    this.eventBus.emit('layer:reordered', {fromIndex, toIndex});
};

ã€å§”è­²ãƒ¡ã‚½ãƒƒãƒ‰ (å…¬é–‹APIç¶­æŒ)ã€‘
createLayer(name, isBackground) {
    return this.hierarchy.createLayer(name, isBackground);
}

deleteLayer(index) {
    return this.hierarchy.deleteLayer(index);
}

getLayers() {
    return this.hierarchy.getLayers();
}

getActiveLayer() {
    return this.hierarchy.getActiveLayer();
}

setActiveLayer(index) {
    this.hierarchy.setActiveLayer(index);
    this.updateLayerPanelUI();
    this.updateStatusDisplay();
    if (this.isLayerMoveMode) {
        this.transform.updateTransformPanelValues(this.getActiveLayer());
    }
}

// ä»¥ä¸‹åŒæ§˜ã«ã™ã¹ã¦ã®éšå±¤é–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å§”è­²

ã€activeLayerIndex ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€‘
// LayerHierarchyã«å§”è­²
get activeLayerIndex() {
    return this.hierarchy.activeLayerIndex;
}

set activeLayerIndex(value) {
    this.hierarchy.activeLayerIndex = value;
}

ã€å‰Šé™¤ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
ä¸Šè¨˜ã€Œç§»å‹•å¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ã€ã‚’ã™ã¹ã¦å‰Šé™¤

ã€setCurrentCutContainer() æ”¹ä¿®ã€‘
setCurrentCutContainer(cutContainer) {
    this.currentCutContainer = cutContainer;
    this.hierarchy.setContainer(cutContainer);
    
    const layers = this.getLayers();
    if (layers.length > 0) {
        this.setActiveLayer(layers.length - 1);
    }
    
    this.updateLayerPanelUI();
    this.updateStatusDisplay();
}

---

âœ… Phase 3 å®Œäº†æ¡ä»¶
- LayerHierarchyå˜ä½“ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–å¯èƒ½
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒ»å‰Šé™¤ãŒæ­£å¸¸å‹•ä½œ
- ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´ãŒæ­£å¸¸å‹•ä½œ
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡ã‚Šæ›¿ãˆãŒæ­£å¸¸å‹•ä½œ
- Historyçµ±åˆãŒæ­£å¸¸å‹•ä½œ
- æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œãŒã™ã¹ã¦å‹•ä½œ

ğŸ§ª ãƒ†ã‚¹ãƒˆé …ç›®
- ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³â†’æ–°è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ
- ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤ãƒœã‚¿ãƒ³â†’ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒªãƒƒã‚¯â†’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°â†’é †åºå¤‰æ›´
- ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ç§»å‹•ã‚­ãƒ¼â†’é †åºå¤‰æ›´
- Undo/Redoã§ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œã®å¾©å…ƒ
- èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‰Šé™¤ä¸å¯ç¢ºèª

================================================================================
Phase 4: çµ±åˆãƒ»æœ€çµ‚èª¿æ•´
================================================================================

ğŸ“‹ å¯¾è±¡ä½œæ¥­
- å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®é€£æºç¢ºèª
- EventBusé€šçŸ¥ã®æ•´ç†
- UIæ›´æ–°å‡¦ç†ã®æœ€é©åŒ–
- ä¸è¦ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤

ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
ã€æ”¹ä¿®å¯¾è±¡ã€‘
  system/layer-system.js (600è¡Œ â†’ 500è¡Œ)
  system/layer-transform.js (å¾®èª¿æ•´)
  system/layer-rendering.js (å¾®èª¿æ•´)
  system/layer-hierarchy.js (å¾®èª¿æ•´)

ã€å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
  system/event-bus.js (ã‚¤ãƒ™ãƒ³ãƒˆåã®ç¢ºèª)
  ui/ui-panels.js (UIæ›´æ–°å‡¦ç†ã®ç¢ºèª)

---

ğŸ“ layer-system.js æœ€çµ‚èª¿æ•´

ã€æ®‹å­˜ãƒ¡ã‚½ãƒƒãƒ‰ (ç´„500è¡Œ)ã€‘
- init()
- setCurrentCutContainer()
- updateLayerPanelUI()
- updateStatusDisplay()
- insertClipboard()
- setCameraSystem()
- setApp()
- setAnimationSystem()
- _setupAnimationSystemIntegration()
- _establishAnimationSystemConnection()
- _setupLayerOperations() (ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã®ã¿)

ã€_setupLayerOperations() æœ€çµ‚å½¢ã€‘
å¤‰å½¢é–¢é€£: this.transform.*
éšå±¤æ“ä½œ: this.hierarchy.*
ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: this.animationSystem.*

ã€EventBusé€šçŸ¥ã®æ•´ç†ã€‘
å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§Emit:
- layer:created â†’ hierarchy.onCreate
- layer:deleted â†’ hierarchy.onDelete
- layer:reordered â†’ hierarchy.onReorder
- layer:updated â†’ transform.onTransformUpdate
- layer:transform-confirmed â†’ transform.onTransformComplete
- layer:visibility-changed â†’ hierarchy.onVisibilityChange

ã€ä¸è¦ã‚³ãƒ¼ãƒ‰å‰Šé™¤ã€‘
- ä½¿ã‚ã‚Œã¦ã„ãªã„ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
- é‡è¤‡ã—ãŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
- ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰

---

ğŸ“ å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“é€£æºã®ç¢ºèª

ã€LayerSystem â†’ LayerTransformã€‘
- getActiveLayer() â†’ transform.enterMoveMode()
- transform.onTransformComplete â†’ rendering.generateThumbnail()

ã€LayerSystem â†’ LayerRenderingã€‘
- hierarchy.onCreate â†’ rendering.requestThumbnailUpdate()
- transform.onTransformComplete â†’ rendering.generateThumbnail()

ã€LayerSystem â†’ LayerHierarchyã€‘
- hierarchy.onCreate â†’ updateLayerPanelUI()
- hierarchy.onDelete â†’ updateLayerPanelUI()
- hierarchy.onReorder â†’ updateLayerPanelUI()

ã€å¾ªç’°å‚ç…§ã®é˜²æ­¢ã€‘
å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯LayerSystemã‚’ç›´æ¥å‚ç…§ã—ãªã„
ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯çµŒç”±ã§ã®ã¿é€šçŸ¥

---

âœ… Phase 4 å®Œäº†æ¡ä»¶
- ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒé€£æºå‹•ä½œ
- EventBusé€šçŸ¥ãŒæ­£å¸¸
- UIæ›´æ–°ãŒæ­£å¸¸
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãªã—
- ä¸è¦ã‚³ãƒ¼ãƒ‰ãŒå‰Šé™¤æ¸ˆã¿
- ã‚³ãƒ¼ãƒ‰è¡Œæ•°ãŒç›®æ¨™å€¤ä»¥å†…

ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆé …ç›®
- æ–°è¦ã‚­ãƒ£ãƒ³ãƒã‚¹ä½œæˆâ†’åˆæœŸãƒ¬ã‚¤ãƒ¤ãƒ¼ç”Ÿæˆ
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆâ†’ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
- ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢â†’ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
- ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤â†’UIæ›´æ–°
- ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´â†’UIæ›´æ–°
- ã‚«ãƒƒãƒˆåˆ‡ã‚Šæ›¿ãˆâ†’ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
- ã™ã¹ã¦ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
- ã™ã¹ã¦ã®Undo/Redoæ“ä½œ
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®é•·æ™‚é–“ç›£è¦–

================================================================================
index.html èª­ã¿è¾¼ã¿é †åº (Phase 3å®Œäº†å¾Œ)
================================================================================

<!-- æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ« -->
<script src="system/data-models.js"></script>
<script src="system/event-bus.js"></script>
<script src="system/history.js"></script>

<!-- æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« (Phaseå®Œäº†é †ã«è¿½åŠ ) -->
<script src="system/layer-rendering.js"></script>
<script src="system/layer-transform.js"></script>
<script src="system/layer-hierarchy.js"></script>

<!-- æ”¹ä¿®å¾Œã®ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ« -->
<script src="system/layer-system.js"></script>

================================================================================
ãƒªã‚¹ã‚¯ç®¡ç†
================================================================================

ğŸš¨ é«˜ãƒªã‚¹ã‚¯ç®‡æ‰€

ã€Phase 1ã€‘
- å¤‰å½¢åº§æ¨™ã®è¨ˆç®—ãƒŸã‚¹
  å¯¾ç­–: CoordinateSystem APIã®å‹•ä½œç¢ºèª
  
- Historyçµ±åˆã®ä¸å…·åˆ
  å¯¾ç­–: Undo/Redo ã®è©³ç´°ãƒ†ã‚¹ãƒˆ

ã€Phase 2ã€‘
- Graphicsç ´æ£„æ¼ã‚Œ
  å¯¾ç­–: ãƒ¡ãƒ¢ãƒªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ©ã§ç›£è¦–
  
- ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ™‚ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ç ´å£Š
  å¯¾ç­–: çŠ¶æ…‹ä¿å­˜ãƒ»å¾©å…ƒã®ç¢ºå®Ÿãªå®Ÿè¡Œ

ã€Phase 3ã€‘
- Containeréšå±¤ã®ä¸æ•´åˆ
  å¯¾ç­–: å„æ“ä½œå¾Œã®getLayers()ã§æ¤œè¨¼
  
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚ºãƒ¬
  å¯¾ç­–: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹èª¿æ•´ãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°ãƒ†ã‚¹ãƒˆ

ã€å…¨Phaseå…±é€šã€‘
- å¾ªç’°å‚ç…§
  å¯¾ç­–: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ã¿ä½¿ç”¨
  
- æ—¢å­˜APIç ´å£Š
  å¯¾ç­–: å…¬é–‹APIã®å®Œå…¨äº’æ›æ€§ç¶­æŒ

ğŸ›¡ï¸ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

å„Phaseå®Œäº†æ™‚ç‚¹ã§Gitã‚³ãƒŸãƒƒãƒˆæ¨å¥¨:
Phase 1å®Œäº†: "refactor: separate LayerTransform"
Phase 2å®Œäº†: "refactor: separate LayerRendering"
Phase 3å®Œäº†: "refactor: separate LayerHierarchy"
Phase 4å®Œäº†: "refactor: finalize layer-system split"

ä¸å…·åˆç™ºç”Ÿæ™‚ã¯ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆã«æˆ»ã™

================================================================================
æˆæœç‰©
================================================================================

ã€æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
system/layer-rendering.js   (250-350è¡Œ)
system/layer-transform.js   (300-400è¡Œ)
system/layer-hierarchy.js   (200-300è¡Œ)

ã€æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
system/layer-system.js       (1,500è¡Œ â†’ 500è¡Œ)

ã€ä¸å¤‰ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
system/data-models.js
system/event-bus.js
system/history.js
system/camera-system.js
coordinate-system.js
ãã®ä»–ã™ã¹ã¦ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«

ã€åˆè¨ˆå‰Šæ¸›ã€‘
1,500è¡Œ â†’ 1,250-1,450è¡Œ (250-450è¡Œå‰Šæ¸›ã€ç´„17-30%è»½é‡åŒ–)
â€» æ©Ÿèƒ½åˆ†é›¢ã«ã‚ˆã‚‹å¯èª­æ€§ãƒ»ä¿å®ˆæ€§å‘ä¸ŠãŒä¸»ç›®çš„

================================================================================
å®Œäº†åŸºæº–
================================================================================

âœ… æ©Ÿèƒ½é¢
- ã™ã¹ã¦ã®æ—¢å­˜æ©Ÿèƒ½ãŒæ­£å¸¸å‹•ä½œ
- ã™ã¹ã¦ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãŒå‹•ä½œ
- History (Undo/Redo) ãŒæ­£å¸¸å‹•ä½œ
- UIæ›´æ–°ãŒæ­£å¸¸å‹•ä½œ

âœ… å“è³ªé¢
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãªã—
- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—
- æ—¢å­˜APIã®å®Œå…¨äº’æ›æ€§ç¶­æŒ

âœ… ã‚³ãƒ¼ãƒ‰å“è³ª
- å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè‡ªå·±å®Œçµ
- å¾ªç’°å‚ç…§ãªã—
- ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ãªã—
- æ˜ç¢ºãªè²¬å‹™åˆ†é›¢

================================================================================