# Vãƒ¢ãƒ¼ãƒ‰æ”¹ä¿® å®Œå…¨ç‰ˆè¨ˆç”»æ›¸ - æ ¹æœ¬åŸå› åˆ†æã¨çµ±åˆä¿®æ­£

**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v8.13_Vmode_Phase1c  
**ä½œæˆæ—¥**: 2025-10-22  
**é‡è¦åº¦**: ğŸ”´ æœ€å„ªå…ˆ - ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®é€£æºä¸æ•´åˆ  

---

## ğŸš¨ æ ¹æœ¬çš„å•é¡Œã®ç™ºè¦‹

### å•é¡Œã®æœ¬è³ª
ç¾è¡Œã®æ”¹ä¿®è¨ˆç”»æ›¸ã¯**layer-system.js ã¨ layer-transform.js ã®ã¿**ã«ç€ç›®ã—ã¦ã„ã¾ã—ãŸãŒã€å®Ÿéš›ã«ã¯ä»¥ä¸‹ã®**ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®é€£æºä¸æ•´åˆ**ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™:

1. **Vã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ã®æ–­çµ¶**: keyboard-handler â†’ layer-system â†’ layer-transform ã®é€£æºãŒäºŒé‡åŒ–
2. **å¤‰å½¢ç¢ºå®šå‡¦ç†ã®æ¬ è½**: `onRebuildRequired` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæœªè¨­å®šã®ãŸã‚ Graphics ãŒå†æ§‹ç¯‰ã•ã‚Œãªã„
3. **åº§æ¨™ç³»ã®ä¸ä¸€è‡´**: camera-system ã® vKeyPressed çŠ¶æ…‹ã¨ layer-transform ã® isVKeyPressed ãŒéåŒæœŸ
4. **ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†ã®ç«¶åˆ**: camera-system ã¨ layer-transform ãŒç‹¬ç«‹ã—ã¦ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆ¶å¾¡
5. **ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹çµ±åˆã®ä¸å®Œå…¨**: Vãƒ¢ãƒ¼ãƒ‰é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆãŒ config.js ã®ã‚­ãƒ¼ãƒãƒƒãƒ—ã¨ä¸æ•´åˆ

---

## ğŸ“Š ç¾çŠ¶ã®ã‚·ã‚¹ãƒ†ãƒ é€£æºèª¿æŸ»çµæœ

### Vã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ï¼ˆç¾çŠ¶ï¼‰

```
[keyboard-handler.js]
  â†“ keydown 'KeyV' æ¤œå‡º
  â†“ eventBus.emit('keyboard:vkey-pressed')
  â†“
[layer-system.js]
  â†“ eventBus.on('keyboard:vkey-pressed')
  â†“ transform.enterMoveMode() / exitMoveMode()
  â†“
[layer-transform.js]
  â†“ isVKeyPressed = true/false
  â†“ cameraSystem.setVKeyPressed(true/false) â† ã“ã“ã§ camera-system ã«é€šçŸ¥
  â†“
[camera-system.js]
  â†“ vKeyPressed = true/false
  â†“ _emitCursorUpdate() â† ã‚«ãƒ¼ã‚½ãƒ«æ›´æ–°
```

**å•é¡Œç‚¹**: 
- keyboard-handler.js ãŒç‹¬è‡ªã« vKeyPressed çŠ¶æ…‹ã‚’ä¿æŒï¼ˆäºŒé‡ç®¡ç†ï¼‰
- layer-system.js ã® `_setupVKeyEvents()` ã§ãƒˆã‚°ãƒ«å‡¦ç†ã‚’å®Ÿè£…ï¼ˆè²¬å‹™ã®æ··åœ¨ï¼‰
- camera-system.js ã® Hã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨ layer-transform.js ã® Hã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒç«¶åˆ

### å¤‰å½¢ç¢ºå®šãƒ•ãƒ­ãƒ¼ï¼ˆç¾çŠ¶ï¼‰

```
[layer-system.js]
  â†“ exitMoveMode() å‘¼ã³å‡ºã—
  â†“
[layer-transform.js]
  â†“ exitMoveMode(activeLayer)
  â†“ confirmTransform(layer) ã¯å‘¼ã°ã‚Œã¦ã„ãªã„ï¼
```

**æ ¹æœ¬åŸå› **:
- `layer-transform.js:exitMoveMode()` ã¯çŠ¶æ…‹å¤‰æ›´ã®ã¿ã§ç¢ºå®šå‡¦ç†ã‚’å®Ÿè¡Œã—ãªã„
- `layer-system.js:exitMoveMode()` ã‚‚ `confirmTransform()` ã‚’å‘¼ã‚“ã§ã„ãªã„
- PHASE 1 ã§è¿½åŠ äºˆå®šã® `onRebuildRequired` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæœªè¨­å®š

### åè»¢æ©Ÿèƒ½ãƒ•ãƒ­ãƒ¼ï¼ˆç¾çŠ¶ï¼‰

```
[layer-transform.js]
  â†“ _setupFlipKeyEvents() - Hã‚­ãƒ¼æ¤œå‡º
  â†“ onFlipRequest('horizontal')
  â†“
[layer-system.js]
  â†“ initTransform() ã§ onFlipRequest ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
  â†“ this.flipActiveLayer(direction)
  â†“
[layer-transform.js]
  â†“ flipLayer(layer, direction)
  âœ“ å‹•ä½œã™ã‚‹ã¯ãš
```

**å•é¡Œç‚¹**:
- `layer-system.js:initTransform()` ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒä¸æ˜ç¢º
- `transform.app` ãŒæœªè¨­å®šã®å ´åˆã« `onFlipRequest` ãŒ null ã®ã¾ã¾

---

## ğŸ¯ æ”¹ä¿®æ–¹é‡ã®å†å®šç¾©

### è¨­è¨ˆåŸå‰‡

1. **å˜ä¸€è²¬ä»»ã®åŸå‰‡ (SRP)**
   - keyboard-handler: ã‚­ãƒ¼å…¥åŠ›ã®æ¤œå‡ºã¨ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã®ã¿
   - layer-system: ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã¨ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
   - layer-transform: å¤‰å½¢è¨ˆç®—ã¨UIåˆ¶å¾¡
   - camera-system: ã‚«ãƒ¡ãƒ©åˆ¶å¾¡ã¨ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†

2. **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**
   - å…¨ã¦ã®çŠ¶æ…‹å¤‰æ›´ã‚’ EventBus çµŒç”±ã§é€šçŸ¥
   - ç›´æ¥çš„ãªãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã‚’æœ€å°åŒ–

3. **åˆæœŸåŒ–é †åºã®æ˜ç¢ºåŒ–**
   - core-engine.js ã§ä¾å­˜é–¢ä¿‚ã‚’æ˜ç¤ºçš„ã«è§£æ±º
   - LayerTransform ã®åˆæœŸåŒ–ã‚’ setupCrossReferences() ã§ç¢ºå®Ÿã«å®Ÿè¡Œ

---

## ğŸ”§ ä¿®æ­£è¨ˆç”»ï¼ˆå„ªå…ˆåº¦é †ï¼‰

### PHASE 0: åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼ä¿®æ­£ ğŸ”´ **æœ€å„ªå…ˆ**

**ç›®çš„**: LayerTransform ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `core-engine.js`

```javascript
// setupCrossReferences() å†…ã§ LayerTransform ã‚’ç¢ºå®Ÿã«åˆæœŸåŒ–

setupCrossReferences() {
    this.cameraSystem.setLayerManager(this.layerSystem);
    this.cameraSystem.setDrawingEngine(this.drawingEngine);
    
    this.layerSystem.setCameraSystem(this.cameraSystem);
    this.layerSystem.setApp(this.app);
    
    // ğŸ”¥ è¿½åŠ : LayerTransform ã®ç¢ºå®ŸãªåˆæœŸåŒ–
    if (this.layerSystem.transform) {
        if (!this.layerSystem.transform.app) {
            this.layerSystem.initTransform();
        }
    }
    
    this.clipboardSystem.setLayerManager(this.layerSystem);
}
```

**å½±éŸ¿**:
- âœ… `onFlipRequest` ãŒç¢ºå®Ÿã«è¨­å®šã•ã‚Œã‚‹
- âœ… `onRebuildRequired` ãªã©ã®æ–°è¦ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚è¨­å®šå¯èƒ½
- âœ… åˆæœŸåŒ–é †åºã®ã‚¨ãƒ©ãƒ¼ã‚’é˜²æ­¢

---

### PHASE 1: å¤‰å½¢ç¢ºå®šå‡¦ç†ä¿®æ­£ ğŸ”´ **æœ€å„ªå…ˆ**

**ç›®çš„**: Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã«å¤‰å½¢ã‚’ç¢ºå®Ÿã«åæ˜ 

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `layer-system.js`, `layer-transform.js`

#### 1-1. layer-transform.js: exitMoveMode() ä¿®æ­£

**ç¾çŠ¶ã®å•é¡Œ**: exitMoveMode() ãŒçŠ¶æ…‹å¤‰æ›´ã®ã¿ã§ç¢ºå®šå‡¦ç†ã‚’å®Ÿè¡Œã—ãªã„

```javascript
// ä¿®æ­£å‰
exitMoveMode(activeLayer) {
    if (!this.isVKeyPressed) return;
    
    this.isVKeyPressed = false;
    this.isDragging = false;
    
    if (this.cameraSystem?.setVKeyPressed) {
        this.cameraSystem.setVKeyPressed(false);
        this.cameraSystem.hideGuideLines();
    }
    
    if (this.transformPanel) {
        this.transformPanel.classList.remove('show');
    }
    
    this._updateCursor();
}

// ä¿®æ­£å¾Œ
exitMoveMode(activeLayer) {
    if (!this.isVKeyPressed) return;
    
    // ğŸ”¥ è¿½åŠ : Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†å‰ã«å¤‰å½¢ç¢ºå®š
    if (activeLayer && this._isTransformNonDefault(this.transforms.get(activeLayer.layerData?.id))) {
        this.confirmTransform(activeLayer);
    }
    
    this.isVKeyPressed = false;
    this.isDragging = false;
    
    if (this.cameraSystem?.setVKeyPressed) {
        this.cameraSystem.setVKeyPressed(false);
        this.cameraSystem.hideGuideLines();
    }
    
    if (this.transformPanel) {
        this.transformPanel.classList.remove('show');
    }
    
    this._updateCursor();
}
```

#### 1-2. layer-system.js: initTransform() ã« onRebuildRequired è¿½åŠ 

**æ—¢å­˜ã® confirmTransform() ã®å‡¦ç†ã‚’ onRebuildRequired ã«ç§»è¡Œ**

```javascript
initTransform() {
    if (!this.transform || !this.app) return;
    
    this.transform.init(this.app, this.cameraSystem);
    
    // ğŸ”¥ è¿½åŠ : Graphics ãƒªãƒ“ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    this.transform.onRebuildRequired = (layer, transformedPaths) => {
        const success = this.safeRebuildLayer(layer, transformedPaths);
        
        if (success) {
            this.requestThumbnailUpdate(this.getLayerIndex(layer));
            
            if (this.animationSystem?.generateCutThumbnail) {
                const cutIndex = this.animationSystem.getCurrentCutIndex();
                setTimeout(() => {
                    this.animationSystem.generateCutThumbnail(cutIndex);
                }, 100);
            }
        }
    };
    
    this.transform.onTransformComplete = (layer, pathsBackup) => {
        // Undo/Redo ç™»éŒ²
        if (window.History && !window.History._manager.isApplying) {
            const layerId = layer.layerData.id;
            const pathsAfter = structuredClone(layer.layerData.paths);
            
            const entry = {
                name: 'layer-transform-complete',
                do: () => {
                    this.safeRebuildLayer(layer, pathsAfter);
                    this.requestThumbnailUpdate(this.getLayerIndex(layer));
                },
                undo: () => {
                    this.safeRebuildLayer(layer, pathsBackup);
                    this.requestThumbnailUpdate(this.getLayerIndex(layer));
                },
                meta: { layerId, type: 'transform' }
            };
            window.History.push(entry);
        }
        
        this.eventBus.emit('layer:transform-confirmed', {
            layerId: layer.layerData.id
        });
    };
    
    // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š ...
    
    // ğŸ”¥ è¿½åŠ : ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆPHASE 4 ç”¨ï¼‰
    this.transform.onGetActiveLayer = () => {
        return this.getActiveLayer();
    };
}
```

#### 1-3. layer-system.js: confirmLayerTransform() ãƒ¡ã‚½ãƒƒãƒ‰å‰Šé™¤

**ç†ç”±**: æ—¢ã« exitMoveMode() å†…ã§ç¢ºå®šå‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ä¸è¦

```javascript
// å‰Šé™¤: confirmLayerTransform() ãƒ¡ã‚½ãƒƒãƒ‰å…¨ä½“ã‚’å‰Šé™¤
// â†“ exitMoveMode() ã§ç¢ºå®šå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ä¸è¦ã«ãªã£ãŸ
```

**å½±éŸ¿**:
- âœ… Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã«å¤‰å½¢ãŒç¢ºå®Ÿã«åæ˜ ã•ã‚Œã‚‹
- âœ… Graphics å†æ§‹ç¯‰ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹
- âœ… Undo/Redo ã«æ­£ã—ãè¨˜éŒ²ã•ã‚Œã‚‹

---

### PHASE 2: Hã‚­ãƒ¼åè»¢æ©Ÿèƒ½ä¿®æ­£ ğŸŸ¡

**ç›®çš„**: Vãƒ¢ãƒ¼ãƒ‰æ™‚ã® Hã‚­ãƒ¼åè»¢ã‚’ç¢ºå®Ÿã«å‹•ä½œã•ã›ã‚‹

**å•é¡Œç‚¹**: camera-system.js ã® Hã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨ç«¶åˆã—ã¦ã„ã‚‹

#### 2-1. camera-system.js: Hã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ä¿®æ­£

```javascript
_handleCameraFlipKeys(e) {
    // ğŸ”¥ ä¿®æ­£: Vãƒ¢ãƒ¼ãƒ‰æ™‚ã¯å‡¦ç†ã—ãªã„
    if (this.vKeyPressed) return;
    
    if (!e.code === 'KeyH' || e.ctrlKey || e.altKey || e.metaKey) return;
    
    const centerX = this.config.canvas.width / 2;
    const centerY = this.config.canvas.height / 2;
    const worldCenter = this.worldContainer.toGlobal({ x: centerX, y: centerY });
    
    if (e.shiftKey) {
        this.verticalFlipped = !this.verticalFlipped;
        this.worldContainer.scale.y *= -1;
    } else {
        this.horizontalFlipped = !this.horizontalFlipped;
        this.worldContainer.scale.x *= -1;
    }
    
    const newWorldCenter = this.worldContainer.toGlobal({ x: centerX, y: centerY });
    this.worldContainer.x += worldCenter.x - newWorldCenter.x;
    this.worldContainer.y += worldCenter.y - newWorldCenter.y;
    
    this._emitTransformChanged();
    e.preventDefault();
}
```

#### 2-2. layer-transform.js: _setupFlipKeyEvents() ç¢ºèª

**ç¾çŠ¶ã§å•é¡Œãªã—** - æ—¢ã«å…¥åŠ›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹åˆ¤å®šãŒå®Ÿè£…æ¸ˆã¿

**å½±éŸ¿**:
- âœ… Vãƒ¢ãƒ¼ãƒ‰æ™‚ã« Hã‚­ãƒ¼ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼åè»¢
- âœ… éVãƒ¢ãƒ¼ãƒ‰æ™‚ã« Hã‚­ãƒ¼ã§ã‚«ãƒ¡ãƒ©åè»¢
- âœ… å…¥åŠ›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã¯ä¸¡æ–¹ã¨ã‚‚ç„¡åŠ¹

---

### PHASE 3: ãƒ›ã‚¤ãƒ¼ãƒ«æ“ä½œè¿½åŠ  ğŸŸ¢

**ç›®çš„**: Vãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ›ã‚¤ãƒ¼ãƒ«æ“ä½œã‚’è¿½åŠ 

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `layer-transform.js`

#### 3-1. _setupWheelEvents() å®Ÿè£…ç¢ºèª

**ç¾çŠ¶**: æ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼ˆã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªï¼‰

**ç¢ºèªäº‹é …**:
- âœ… `onGetActiveLayer` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒ PHASE 1 ã§è¨­å®šã•ã‚Œã‚‹
- âœ… ãƒ›ã‚¤ãƒ¼ãƒ«: ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´
- âœ… Shift+ãƒ›ã‚¤ãƒ¼ãƒ«: å›è»¢å¤‰æ›´

**å½±éŸ¿**:
- âœ… Vãƒ¢ãƒ¼ãƒ‰æ™‚ã«ãƒ›ã‚¤ãƒ¼ãƒ«ã§æ‹¡å¤§ç¸®å°
- âœ… Vãƒ¢ãƒ¼ãƒ‰æ™‚ã« Shift+ãƒ›ã‚¤ãƒ¼ãƒ«ã§å›è»¢

---

### PHASE 4: ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†ã®çµ±åˆ ğŸŸ¡

**ç›®çš„**: ã‚«ãƒ¼ã‚½ãƒ«åˆ¶å¾¡ã®é‡è¤‡ã‚’è§£æ¶ˆ

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `layer-transform.js`

#### 4-1. _updateCursor() ä¿®æ­£

```javascript
_updateCursor() {
    // ğŸ”¥ å‰Šé™¤: ç›´æ¥ã‚«ãƒ¼ã‚½ãƒ«ã‚’å¤‰æ›´ã—ãªã„
    // camera-system ã«ä»»ã›ã‚‹
    
    // const canvas = this._getSafeCanvas();
    // if (!canvas) return;
    // 
    // if (this.isVKeyPressed) {
    //     canvas.style.cursor = 'grab';
    // } else {
    //     canvas.style.cursor = 'default';
    // }
    
    // ğŸ”¥ è¿½åŠ : camera-system ã®ã‚«ãƒ¼ã‚½ãƒ«æ›´æ–°ã‚’ãƒˆãƒªã‚¬ãƒ¼
    if (this.cameraSystem?.updateCursor) {
        this.cameraSystem.updateCursor();
    }
}
```

**å½±éŸ¿**:
- âœ… ã‚«ãƒ¼ã‚½ãƒ«åˆ¶å¾¡ãŒ camera-system ã«çµ±ä¸€ã•ã‚Œã‚‹
- âœ… ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚«ãƒ¼ã‚½ãƒ«å¤‰æ›´ãŒæ­£ã—ãå‹•ä½œã™ã‚‹

---

### PHASE 5: keyboard-handler.js ã®äºŒé‡ç®¡ç†è§£æ¶ˆ ğŸŸ¢

**ç›®çš„**: Vã‚­ãƒ¼çŠ¶æ…‹ç®¡ç†ã®ä¸€å…ƒåŒ–

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `keyboard-handler.js`

#### 5-1. vKeyPressed çŠ¶æ…‹ç®¡ç†å‰Šé™¤

```javascript
// å‰Šé™¤: ç‹¬è‡ªã® vKeyPressed ç®¡ç†ã‚’å‰Šé™¤
// let vKeyPressed = false;

function handleKeyDown(e) {
    const eventBus = window.TegakiEventBus;
    const keymap = window.TEGAKI_KEYMAP;
    
    if (!eventBus || !keymap) return;
    if (isInputFocused()) return;
    
    // ... æ—¢å­˜ã®å‡¦ç† ...
    
    // ğŸ”¥ ä¿®æ­£: EventBusç™ºç«ã®ã¿ï¼ˆçŠ¶æ…‹ç®¡ç†ã¯ layer-system ã«ä»»ã›ã‚‹ï¼‰
    if (e.code === 'KeyV' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
        eventBus.emit('keyboard:vkey-pressed', { pressed: true });
        e.preventDefault();
        return;
    }
    
    // ... æ—¢å­˜ã®å‡¦ç† ...
}

function handleKeyUp(e) {
    // ğŸ”¥ å‰Šé™¤: Vã‚­ãƒ¼è§£æ”¾ã‚¤ãƒ™ãƒ³ãƒˆã¯ä¸è¦ï¼ˆãƒˆã‚°ãƒ«æ–¹å¼ã®ãŸã‚ï¼‰
    // if (e.code === 'KeyV') {
    //     ...
    // }
}
```

**å½±éŸ¿**:
- âœ… çŠ¶æ…‹ç®¡ç†ãŒ layer-system ã«ä¸€å…ƒåŒ–ã•ã‚Œã‚‹
- âœ… keyboard-handler ã¯ç´”ç²‹ã«ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã®ã¿ã«å°‚å¿µ

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1: Vãƒ¢ãƒ¼ãƒ‰èµ·å‹•ãƒ»è§£é™¤

1. Vã‚­ãƒ¼æŠ¼ä¸‹ â†’ Vãƒ¢ãƒ¼ãƒ‰èµ·å‹•
   - âœ… ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³è¡¨ç¤º
   - âœ… å¤‰å½¢ãƒ‘ãƒãƒ«è¡¨ç¤º
   - âœ… ã‚«ãƒ¼ã‚½ãƒ«ãŒ grab ã«å¤‰æ›´

2. Vã‚­ãƒ¼å†æŠ¼ä¸‹ â†’ Vãƒ¢ãƒ¼ãƒ‰è§£é™¤
   - âœ… å¤‰å½¢ãŒç¢ºå®šã•ã‚Œã‚‹
   - âœ… Graphics ãŒå†æ§‹ç¯‰ã•ã‚Œã‚‹
   - âœ… ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³éè¡¨ç¤º
   - âœ… å¤‰å½¢ãƒ‘ãƒãƒ«éè¡¨ç¤º
   - âœ… ã‚«ãƒ¼ã‚½ãƒ«ãŒ default ã«æˆ»ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 2: å¤‰å½¢æ“ä½œ

1. Vãƒ¢ãƒ¼ãƒ‰æ™‚ã«çŸ¢å°ã‚­ãƒ¼ã§ç§»å‹•
   - âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç§»å‹•ã™ã‚‹
   - âœ… ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ãŒæ›´æ–°ã•ã‚Œã‚‹

2. Vãƒ¢ãƒ¼ãƒ‰æ™‚ã« Shift+çŸ¢å°ã‚­ãƒ¼ã§æ‹¡å¤§ç¸®å°ãƒ»å›è»¢
   - âœ… æ‹¡å¤§ç¸®å°ãŒå‹•ä½œã™ã‚‹
   - âœ… å›è»¢ãŒå‹•ä½œã™ã‚‹

3. Vãƒ¢ãƒ¼ãƒ‰æ™‚ã«ãƒ›ã‚¤ãƒ¼ãƒ«æ“ä½œ
   - âœ… ãƒ›ã‚¤ãƒ¼ãƒ«: æ‹¡å¤§ç¸®å°
   - âœ… Shift+ãƒ›ã‚¤ãƒ¼ãƒ«: å›è»¢

4. Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚
   - âœ… å¤‰å½¢ãŒåº§æ¨™ã«ç„¼ãè¾¼ã¾ã‚Œã‚‹
   - âœ… Undo ã§å…ƒã«æˆ»ã›ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 3: åè»¢æ©Ÿèƒ½

1. Vãƒ¢ãƒ¼ãƒ‰æ™‚ã« Hã‚­ãƒ¼
   - âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ°´å¹³åè»¢ã™ã‚‹
   - âœ… ãƒœã‚¿ãƒ³çŠ¶æ…‹ãŒæ›´æ–°ã•ã‚Œã‚‹

2. Vãƒ¢ãƒ¼ãƒ‰æ™‚ã« Shift+H
   - âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‚ç›´åè»¢ã™ã‚‹

3. éVãƒ¢ãƒ¼ãƒ‰æ™‚ã« Hã‚­ãƒ¼
   - âœ… ã‚«ãƒ¡ãƒ©ãŒæ°´å¹³åè»¢ã™ã‚‹ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã¯ãªã„ï¼‰

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 4: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹ã§ Vãƒ¢ãƒ¼ãƒ‰
   - âœ… ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„

2. å¤‰å½¢ä¸­ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±
   - âœ… Vãƒ¢ãƒ¼ãƒ‰ãŒè‡ªå‹•è§£é™¤ã•ã‚Œã‚‹
   - âœ… å¤‰å½¢ãŒç¢ºå®šã•ã‚Œã‚‹

3. å…¥åŠ›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã« Hã‚­ãƒ¼
   - âœ… åè»¢å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œãªã„

---

## ğŸ“ ã‚·ãƒ³ãƒœãƒ«è¾å…¸ï¼ˆå®Œå…¨ç‰ˆï¼‰

### EventBus ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§

```javascript
// Vãƒ¢ãƒ¼ãƒ‰é–¢é€£
'keyboard:vkey-pressed'        // Vã‚­ãƒ¼æŠ¼ä¸‹ï¼ˆãƒˆã‚°ãƒ«ï¼‰
'layer:transform-confirmed'    // å¤‰å½¢ç¢ºå®šå®Œäº†
'layer:updated'                // ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–°
'layer:flipped'                // ãƒ¬ã‚¤ãƒ¤ãƒ¼åè»¢

// ã‚«ãƒ¡ãƒ©é–¢é€£
'camera:cursor-changed'        // ã‚«ãƒ¼ã‚½ãƒ«å¤‰æ›´
'camera:transform-changed'     // ã‚«ãƒ¡ãƒ©å¤‰å½¢å¤‰æ›´
```

### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§

#### layer-system.js
- `initTransform()` - LayerTransform åˆæœŸåŒ–ã¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
- `enterLayerMoveMode()` - Vãƒ¢ãƒ¼ãƒ‰é–‹å§‹
- `exitLayerMoveMode()` - Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†ï¼ˆå¤‰å½¢ç¢ºå®šã‚’å«ã‚€ï¼‰
- `flipActiveLayer(direction)` - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼åè»¢
- `safeRebuildLayer(layer, paths)` - ãƒ¬ã‚¤ãƒ¤ãƒ¼ Graphics å†æ§‹ç¯‰

#### layer-transform.js
- `init(app, cameraSystem)` - åˆæœŸåŒ–
- `enterMoveMode()` - Vãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹å¤‰æ›´
- `exitMoveMode(layer)` - Vãƒ¢ãƒ¼ãƒ‰è§£é™¤ï¼‹å¤‰å½¢ç¢ºå®š
- `confirmTransform(layer)` - å¤‰å½¢ç¢ºå®šï¼‹åº§æ¨™ç„¼ãè¾¼ã¿
- `flipLayer(layer, direction)` - ãƒ¬ã‚¤ãƒ¤ãƒ¼åè»¢
- `applyTransformToPaths(layer, transform)` - ãƒ‘ã‚¹ã¸å¤‰å½¢é©ç”¨

#### camera-system.js
- `setVKeyPressed(pressed)` - Vã‚­ãƒ¼çŠ¶æ…‹è¨­å®š
- `updateCursor()` - ã‚«ãƒ¼ã‚½ãƒ«æ›´æ–°
- `showGuideLines()` / `hideGuideLines()` - ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³è¡¨ç¤ºåˆ¶å¾¡

---

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### æ©Ÿèƒ½æ€§
- âœ… Vãƒ¢ãƒ¼ãƒ‰èµ·å‹•ãƒ»è§£é™¤ãŒç¢ºå®Ÿã«å‹•ä½œ
- âœ… å¤‰å½¢ç¢ºå®šãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹
- âœ… Hã‚­ãƒ¼åè»¢ãŒç¢ºå®Ÿã«å‹•ä½œ
- âœ… ãƒ›ã‚¤ãƒ¼ãƒ«æ“ä½œãŒè¿½åŠ ã•ã‚Œã‚‹

### ä¿å®ˆæ€§
- âœ… è²¬å‹™åˆ†é›¢ãŒæ˜ç¢ºåŒ–ã•ã‚Œã‚‹
- âœ… åˆæœŸåŒ–é †åºãŒæ˜ç¤ºçš„ã«ãªã‚‹
- âœ… çŠ¶æ…‹ç®¡ç†ãŒä¸€å…ƒåŒ–ã•ã‚Œã‚‹
- âœ… ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹å¼ã§ç–çµåˆã‚’ç¶­æŒ

### æ‹¡å¼µæ€§
- âœ… æ–°ã—ã„å¤‰å½¢æ“ä½œã®è¿½åŠ ãŒå®¹æ˜“
- âœ… Undo/Redo å¯¾å¿œãŒå®Œå‚™
- âœ… EventBus çµ±åˆãŒå®Œå…¨åŒ–

---

## âš ï¸ æ—¢çŸ¥ã®åˆ¶ç´„äº‹é …

1. **PixiJS v8.13 ã®åˆ¶ç´„**
   - Matrix å¤‰æ›ã¯ PixiJS ã®æ¨™æº–æ©Ÿèƒ½ã«ä¾å­˜
   - Graphics å†æ§‹ç¯‰æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

2. **ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§**
   - ãƒ›ã‚¤ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã¯ { passive: false } ãŒå¿…è¦
   - PointerEvent å¿…é ˆï¼ˆIE11 éå¯¾å¿œï¼‰

3. **åº§æ¨™ç²¾åº¦**
   - æµ®å‹•å°æ•°ç‚¹æ¼”ç®—ã«ã‚ˆã‚‹å¾®å°ãªèª¤å·®
   - å¤‰å½¢ç¢ºå®šæ™‚ã« structuredClone ã§ãƒ‡ãƒ¼ã‚¿è¤‡è£½

---

## ğŸš€ å®Ÿè£…é †åºï¼ˆæ¨å¥¨ï¼‰

1. **Day 1**: PHASE 0 + PHASE 1
   - åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼ä¿®æ­£
   - å¤‰å½¢ç¢ºå®šå‡¦ç†ä¿®æ­£
   - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1, 2, 4 å®Ÿæ–½

2. **Day 2**: PHASE 2 + PHASE 4
   - Hã‚­ãƒ¼åè»¢ä¿®æ­£
   - ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†çµ±åˆ
   - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 3 å®Ÿæ–½

3. **Day 3**: PHASE 3 + PHASE 5
   - ãƒ›ã‚¤ãƒ¼ãƒ«æ“ä½œè¿½åŠ 
   - keyboard-handler æ•´ç†
   - å…¨ä½“çµ±åˆãƒ†ã‚¹ãƒˆ

---

## ğŸ“š å‚è€ƒè³‡æ–™

- PixiJS v8 Matrix API: https://pixijs.download/dev/docs/PIXI.Matrix.html
- PointerEvent Spec: https://www.w3.org/TR/pointerevents/
- EventBus ãƒ‘ã‚¿ãƒ¼ãƒ³: https://github.com/EventBus

---

**æ”¹è¨‚å±¥æ­´**
- v1.0 (2025-10-22): åˆç‰ˆä½œæˆ - æ ¹æœ¬åŸå› åˆ†æã¨çµ±åˆä¿®æ­£è¨ˆç”»