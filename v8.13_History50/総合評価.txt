ğŸ“‹ ç·åˆè©•ä¾¡
âœ… è‰¯å¥½ãªç‚¹

è²¬å‹™åˆ†é›¢ã¯æ¦‚ã­è‰¯å¥½: settings-popup.jsã¯UIè¡¨ç¤ºã¨EventBusé€šçŸ¥ã®ã¿ã«å°‚å¿µ
EventBusçµ±åˆã¯å®Œæˆ: è¨­å®šå¤‰æ›´ã¯å…¨ã¦EventBusçµŒç”±ã§é€šçŸ¥
BrushSettingsãŒé©åˆ‡ã«è³¼èª­: brush-settings.jsãŒè¨­å®šå¤‰æ›´ã‚’æ­£ã—ãè³¼èª­
äºŒé‡å®Ÿè£…ã¯ç¢ºèªã•ã‚Œãš: è¨­å®šå€¤ã®ç®¡ç†ã¯BrushSettingsã«ä¸€å…ƒåŒ–

âš ï¸ ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œç‚¹
ğŸ”´ é‡å¤§ãªå•é¡Œ
1. DrawingEngineãŒEventBusã‚’è³¼èª­ã—ã¦ã„ãªã„
javascript// drawing-engine.js L12-20
if (window.TegakiDrawing) {
  this.settings = window.TegakiDrawing.BrushSettings ? 
    new window.TegakiDrawing.BrushSettings(config, eventBus) : null;
  // ...
}
```

**å•é¡Œ**: `DrawingEngine`è‡ªä½“ã¯EventBusã‹ã‚‰è¨­å®šå¤‰æ›´ã‚’è³¼èª­ã—ã¦ã„ã¾ã›ã‚“ã€‚`BrushSettings`ãŒè³¼èª­ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

**å½±éŸ¿**: ç­†åœ§è£œæ­£ã®å¤‰æ›´ãŒ`PressureHandler`ã«ä¼ã‚ã‚‰ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### 2. **PressureHandlerã¸ã®è¨­å®šé©ç”¨ãŒä¸å®Œå…¨**

`pressure-handler.js`ã¯ç­†åœ§ã‚’å–å¾—ã™ã‚‹ã ã‘ã§ã€`BrushSettings`ã®`pressureCorrection`ã‚„`pressureCurve`ã‚’é©ç”¨ã™ã‚‹è²¬å‹™ãŒä¸æ˜ç¢ºã§ã™ã€‚

**ç¾çŠ¶ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```
settings-popup.js â†’ EventBus â†’ brush-settings.js
                                      â†“
                                 (é©ç”¨ã•ã‚Œãªã„?)
                                      â†“
                              pressure-handler.js
ğŸŸ¡ ä¸­ç¨‹åº¦ã®å•é¡Œ
3. ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å®Ÿè£…ãŒäºŒé‡åŒ–
settings-popup.js:
javascript// L175-254: ç‹¬è‡ªã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å®Ÿè£…
setupPressureCorrectionListener() { ... }
setupSmoothingListener() { ... }
ui-panels.js:
javascript// L272-312: åˆ¥ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å®Ÿè£…
createSlider: function(sliderId, min, max, initial, callback) { ... }
å•é¡Œ: 2ã¤ã®ç•°ãªã‚‹ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å®Ÿè£…ãŒå­˜åœ¨ã—ã€ã‚³ãƒ¼ãƒ‰ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ã€‚
4. CoreRuntime APIã®ä¸è¶³
core-runtime.jsã«ã¯ä»¥ä¸‹ã®APIãŒå­˜åœ¨ã—ã¾ã›ã‚“:

api.setPressureCorrection(value)
api.setSmoothing(value)
api.setPressureCurve(curve)

ç¾çŠ¶: ã“ã‚Œã‚‰ã®è¨­å®šã¯EventBusçµŒç”±ã§ã®ã¿å¤‰æ›´å¯èƒ½ã§ã™ãŒã€CoreRuntime.apiã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã›ã‚‹æ–¹ãŒçµ±ä¸€æ„ŸãŒã‚ã‚Šã¾ã™ã€‚
5. è¨­å®šã®æ°¸ç¶šåŒ–ãŒåˆ†æ•£
javascript// settings-popup.js L235-244
saveSettings(partial) {
  const stored = localStorage.getItem('tegaki_settings');
  // ...
  localStorage.setItem('tegaki_settings', JSON.stringify(updated));
}
å•é¡Œ: localStorageã¸ã®ä¿å­˜ãŒsettings-popup.jsã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ãŠã‚Šã€å°†æ¥config.jsã¨ã®é€£æºæ™‚ã«ç«¶åˆã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ğŸŸ¢ è»½å¾®ãªå•é¡Œ
6. BrushSettingsã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§åˆæœŸå€¤èª­ã¿è¾¼ã¿ãŒä¸å®Œå…¨
javascript// brush-settings.js L13-14
this.pressureCorrection = this.config.userSettings?.pressureCorrection || 1.0;
this.pressureCurve = this.config.userSettings?.pressureCurve || 'linear';
å•é¡Œ: config.jsã«userSettingsã®å®šç¾©ãŒãªã„ãŸã‚ã€å¸¸ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
ğŸ“ æ”¹å–„ææ¡ˆ
ğŸ”§ ææ¡ˆ1: DrawingEngineã§EventBusã‚’å®Œå…¨çµ±åˆ
javascript// drawing-engine.js
constructor(cameraSystem, layerManager, eventBus, config) {
  // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
  
  // ğŸ†• EventBusè³¼èª­
  this.subscribeToSettings();
}

subscribeToSettings() {
  if (!this.eventBus) return;
  
  // ç­†åœ§è£œæ­£ã®å¤‰æ›´ã‚’è³¼èª­
  this.eventBus.on('settings:pressure-correction', ({ value }) => {
    if (this.pressureHandler && this.settings) {
      // PressureHandlerã«é©ç”¨ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
      this.pressureHandler.pressureCorrection = value;
    }
  });
  
  // ç·šè£œæ­£ã®å¤‰æ›´ã‚’è³¼èª­
  this.eventBus.on('settings:smoothing', ({ value }) => {
    if (this.settings) {
      this.settings.setSmoothing(value);
    }
  });
  
  // ç­†åœ§ã‚«ãƒ¼ãƒ–ã®å¤‰æ›´ã‚’è³¼èª­
  this.eventBus.on('settings:pressure-curve', ({ curve }) => {
    if (this.settings) {
      this.settings.setPressureCurve(curve);
    }
  });
}
ğŸ”§ ææ¡ˆ2: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’çµ±ä¸€åŒ–
ui-panels.jsã®createSliderã‚’å…±é€šé–¢æ•°ã¨ã—ã¦æŠ½å‡ºã—ã€settings-popup.jsã§ã‚‚ä½¿ç”¨:
javascript// æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: ui/slider-utils.js
window.TegakiUI.SliderUtils = {
  createSlider(container, options) {
    const { min, max, initial, onChange, onCommit } = options;
    // çµ±ä¸€ã•ã‚ŒãŸã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å®Ÿè£…
  }
};
ğŸ”§ ææ¡ˆ3: CoreRuntime APIã®è¿½åŠ 
javascript// core-runtime.js ã® api ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
api: {
  // ... æ—¢å­˜ã®ãƒ¡ã‚½ãƒƒãƒ‰ ...
  
  setPressureCorrection(value) {
    if (CoreRuntime.internal.drawingEngine?.settings) {
      CoreRuntime.internal.drawingEngine.settings.setPressureCorrection(value);
      return true;
    }
    return false;
  },
  
  setSmoothing(value) {
    if (CoreRuntime.internal.drawingEngine?.settings) {
      CoreRuntime.internal.drawingEngine.settings.setSmoothing(value);
      return true;
    }
    return false;
  },
  
  setPressureCurve(curve) {
    if (CoreRuntime.internal.drawingEngine?.settings) {
      CoreRuntime.internal.drawingEngine.settings.setPressureCurve(curve);
      return true;
    }
    return false;
  }
}
ğŸ”§ ææ¡ˆ4: è¨­å®šç®¡ç†ã‚’ä¸€å…ƒåŒ–
javascript// æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: system/settings-manager.js
window.TegakiSettingsManager = class {
  constructor(eventBus) {
    this.eventBus = eventBus;
    this.settings = this.loadFromStorage();
    this.subscribeToChanges();
  }
  
  loadFromStorage() {
    const stored = localStorage.getItem('tegaki_settings');
    return stored ? JSON.parse(stored) : this.getDefaults();
  }
  
  getDefaults() {
    return {
      pressureCorrection: 1.0,
      smoothing: 0.5,
      pressureCurve: 'linear',
      statusPanelVisible: true
    };
  }
  
  updateSetting(key, value) {
    this.settings[key] = value;
    this.saveToStorage();
    this.eventBus.emit(`settings:${this.kebabCase(key)}`, { value });
  }
  
  saveToStorage() {
    localStorage.setItem('tegaki_settings', JSON.stringify(this.settings));
  }
  
  subscribeToChanges() {
    // config.js ã‹ã‚‰ã®å¤‰æ›´ã‚‚è³¼èª­å¯èƒ½ã«
  }
};
ğŸ“Š å„ªå…ˆåº¦åˆ¥ã‚¿ã‚¹ã‚¯
ğŸ”´ æœ€å„ªå…ˆï¼ˆå‹•ä½œã«å½±éŸ¿ï¼‰

DrawingEngineã§EventBusè³¼èª­ã‚’è¿½åŠ  - ç­†åœ§è£œæ­£ãŒæ©Ÿèƒ½ã—ã¦ã„ãªã„å¯èƒ½æ€§
PressureHandlerã¸ã®è¨­å®šé©ç”¨ãƒ•ãƒ­ãƒ¼ã‚’æ˜ç¢ºåŒ–

ğŸŸ¡ ä¸­å„ªå…ˆï¼ˆä¿å®ˆæ€§ãƒ»æ‹¡å¼µæ€§ï¼‰

CoreRuntime APIã®è¿½åŠ  - çµ±ä¸€ã•ã‚ŒãŸAPIæä¾›
è¨­å®šç®¡ç†ã®ä¸€å…ƒåŒ– - SettingsManagerã®å°å…¥
ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®çµ±ä¸€ - ã‚³ãƒ¼ãƒ‰é‡è¤‡å‰Šæ¸›

ğŸŸ¢ ä½å„ªå…ˆï¼ˆå°†æ¥å¯¾å¿œï¼‰

config.jsã¨ã®é€£æºå¼·åŒ– - ã‚­ãƒ¼ã‚³ãƒ³ãƒ•ã‚£ã‚°è¨­å®šã®çµ±åˆæº–å‚™
UIãƒ†ãƒ¼ãƒè¨­å®šã®è¿½åŠ  - è‰²ã‚„ãƒ•ã‚©ãƒ³ãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º