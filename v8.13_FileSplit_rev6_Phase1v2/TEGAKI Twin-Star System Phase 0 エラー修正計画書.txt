# TEGAKI Twin-Star System Phase 0 エラー修正計画書

## 🔍 現状の問題分析

### 確認されたエラー
1. **core-engine.js:2 Uncaught SyntaxError: Unexpected token '{'**
   - ファイル先頭に重複/不正なコードブロックが存在
   - LayerManagerのcreateLayerメソッドが重複定義されている

2. **index.html:998 Uncaught TypeError: Cannot destructure property 'CoreEngine' of 'window.TegakiCore' as it is undefined**
   - core-engine.jsの構文エラーによりTegakiCoreが未定義
   - main.js部分でCoreEngineクラスが参照できない

3. **coordinate-system.js の二重実装**
   - index.html内でCoordinateSystemが再定義されている
   - coordinate-system.jsファイルとの重複

## 🎯 修正方針

### Phase 0.1 緊急修正 (20分以内)
**優先度: 最高** - アプリケーション起動可能な状態にする

#### 修正対象ファイル
1. **core-engine.js** - 構文エラー修正
2. **index.html** - 二重実装解消・読み込み順序修正

#### 具体的修正内容

##### core-engine.jsの修正
- ❌ ファイル先頭の重複コードブロック削除
- ❌ LayerManager.createLayerメソッドの重複削除  
- ✅ 正しい構文に修正
- ✅ コメント・コードの整合性確保

##### index.htmlの修正
- ❌ インライン CoordinateSystem定義を削除
- ✅ coordinate-system.js ファイル読み込みに一本化
- ✅ スクリプト読み込み順序の最適化:
  ```html
  1. config.js
  2. ui-panels.js  
  3. coordinate-system.js
  4. core-engine.js
  5. main.js統合部分
  ```

### Phase 0.2 統合確認 (10分以内)
**優先度: 高** - coordinate-system.js連携の確認

#### 確認項目
- ✅ CoordinateSystemクラスが正常にグローバル公開されているか
- ✅ core-engine.js内でCoordinateSystemが参照できるか  
- ✅ 座標変換メソッドの二重実装が無いか
- ✅ PixiJS v8.13 APIとの適合性

### Phase 0.3 動作検証 (10分以内)
**優先度: 高** - 基本機能の動作確認

#### 検証項目
- ✅ アプリケーション起動
- ✅ ペン描画機能
- ✅ レイヤー操作
- ✅ キャンバス操作（ズーム・パン）
- ✅ 座標系の整合性

## 🔧 実装手順

### Step 1: core-engine.js 修正
```javascript
// 削除対象: ファイル先頭の重複コード
// 修正対象: LayerManager.createLayerメソッドの一本化
// 確認対象: window.TegakiCore の正常な公開
```

### Step 2: index.html 修正  
```html
<!-- 削除: インラインCoordinateSystem定義 -->
<!-- 修正: スクリプト読み込み順序 -->
<!-- 確認: coordinate-system.js ファイル読み込み -->
```

### Step 3: 動作検証
```javascript
// 確認: window.TegakiCore.CoreEngine
// 確認: window.CoordinateSystem  
// 確認: Phase 0の座標系統合機能
```

## 🚫 禁止事項（改修時の注意）

- **フォールバック処理追加禁止** - エラー隠蔽・暗黙修復は行わない
- **過度なエラーハンドリング禁止** - 問題の根本解決を優先
- **バージョン混在対応禁止** - PixiJS v8.13一本に統一
- **ユーザー向けエラー演出禁止** - 開発中のため不要
- **機能追加禁止** - 既存機能の修復のみに集中

## ✅ 期待される結果

### 修正後の状態
1. **構文エラー解消** - core-engine.jsが正常読み込み
2. **TegakiCore初期化成功** - main.js部分が正常実行  
3. **CoordinateSystem統合** - 座標系の一元管理
4. **Phase 0完成** - 座標系コメント付きの統合版

### 動作確認項目
- [ ] アプリケーション起動（エラーなし）
- [ ] ペン描画（座標変換正常）
- [ ] レイヤー移動モード（V キー）
- [ ] キャンバス操作（Space + マウス）
- [ ] 座標デバッグ表示（Ctrl+D）

## 📈 Phase 1への準備状況

修正完了後、以下が整備される：
- ✅ 座標系の明示的コメント追加完了
- ✅ CoordinateSystemクラス統合完了  
- ✅ PixiJS v8.13準拠の座標変換API確認
- ✅ 二重実装の解消
- 🔄 Engine Star作成準備（Phase 1への布石）

## 🕐 予想作業時間

- **Phase 0.1**: 20分（緊急修正）
- **Phase 0.2**: 10分（統合確認）  
- **Phase 0.3**: 10分（動作検証）
- **合計**: 約40分

これらの修正により、Phase 0の座標系統合版が完成し、Phase 1のEngine Star作成に向けた準備が整います。