// ===== ui/layer-panel-renderer.js - „Çø„Éñ„É¨„ÉÉ„Éà„Éö„É≥ÂÆåÂÖ®ÂØæÂøúÁâà =====
// Phase 5: Sortable.js „Çí PointerEvent „Éô„Éº„Çπ„Å´ÁΩÆ„ÅçÊèõ„Åà
// 
// „ÄêÊîπ‰øÆÂÜÖÂÆπ„Äë
// - Sortable.js ‰æùÂ≠ò„ÇíÂâäÈô§
// - PointerEvent „Éô„Éº„Çπ„ÅÆ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÂÆüË£Ö
// - „Çø„Éñ„É¨„ÉÉ„Éà„Éö„É≥„Éª„Çø„ÉÉ„ÉÅ„Éª„Éû„Ç¶„ÇπÂÖ®ÂØæÂøú
// - setPointerCapture/releasePointerCapture ‰ΩøÁî®

window.TegakiUI = window.TegakiUI || {};

window.TegakiUI.LayerPanelRenderer = class {
    constructor() {
        this.container = null;
        this.animationSystem = null;
        this.layerSystem = null;
        this.eventBus = window.TegakiEventBus;
        this.thumbnailUpdateScheduled = false;
        this.thumbnailCanvases = new Map();
        
        // Phase 3-4: ÂÄãÂà•„É¨„Ç§„É§„ÉºÊõ¥Êñ∞„ÅÆthrottleÁÆ°ÁêÜ
        this.layerUpdateTimers = new Map();
        this.layerUpdateThrottle = 50; // 50ms
        
        // Phase 5: „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖãÁÆ°ÁêÜ
        this.dragState = {
            isDragging: false,
            draggedElement: null,
            draggedIndex: null,
            startY: 0,
            currentY: 0,
            pointerId: null,
            placeholder: null
        };
    }

    init(container, layerSystem, animationSystem) {
        this.container = container || document.getElementById('layer-list');
        this.layerSystem = layerSystem;
        this.animationSystem = animationSystem;
        
        if (!this.container) {
            throw new Error('Layer panel container not found');
        }
        
        // Phase 5: „Ç≥„É≥„ÉÜ„Éä„Å´„Çπ„Çø„Ç§„É´ËøΩÂä†
        this.container.style.touchAction = 'none';
        this.container.style.userSelect = 'none';
        
        this._setupEventListeners();
        console.log('‚úÖ LayerPanelRenderer initialized (Phase 5: „Çø„Éñ„É¨„ÉÉ„Éà„Éö„É≥ÂØæÂøú)');
    }
    
    _setupEventListeners() {
        if (!this.eventBus) return;
        
        // Phase 4: layer:transform-updated „ÇíË≥ºË™≠ÔºàV„É¢„Éº„ÉâÂØæÂøú„ÉªÊúÄÂÑ™ÂÖàÔºâ
        this.eventBus.on('layer:transform-updated', ({ data }) => {
            const { layerIndex, layerId, transform } = data || {};
            
            if (layerIndex === undefined && !layerId) return;
            
            // throttle: Âêå„Åò„É¨„Ç§„É§„Éº„ÅÆÈÄ£Á∂öÊõ¥Êñ∞„Çí 50ms ÈñìÈöî„Å´Âà∂Èôê
            const throttleKey = layerId || `index-${layerIndex}`;
            
            if (this.layerUpdateTimers.has(throttleKey)) {
                clearTimeout(this.layerUpdateTimers.get(throttleKey));
            }
            
            const timer = setTimeout(() => {
                // Âç≥Â∫ß„Å´„Çµ„É†„Éç„Ç§„É´Êõ¥Êñ∞
                if (layerIndex !== undefined) {
                    console.log(`üé¨ Panel: Updating layer ${layerIndex} thumbnail (transform)`);
                    this.updateLayerThumbnail(layerIndex);
                } else if (layerId) {
                    // layerId ‚Üí layerIndex Ëß£Ê±∫
                    const layers = this.layerSystem?.getLayers?.();
                    if (layers) {
                        const index = layers.findIndex(l => l.layerData?.id === layerId);
                        if (index >= 0) {
                            console.log(`üé¨ Panel: Updating layer ${index} thumbnail (by ID)`);
                            this.updateLayerThumbnail(index);
                        }
                    }
                }
                
                this.layerUpdateTimers.delete(throttleKey);
            }, this.layerUpdateThrottle);
            
            this.layerUpdateTimers.set(throttleKey, timer);
        });
        
        // „Çµ„É†„Éç„Ç§„É´Êõ¥Êñ∞„É™„ÇØ„Ç®„Çπ„ÉàË≥ºË™≠ÔºàÊ±éÁî®Ôºâ
        this.eventBus.on('thumbnail:layer-updated', ({ data }) => {
            const { layerIndex, layerId, immediate } = data || {};
            
            // immediate „Éï„É©„Ç∞„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ throttle „Çí„Çπ„Ç≠„ÉÉ„Éó
            if (immediate) {
                requestAnimationFrame(() => {
                    if (layerIndex !== undefined) {
                        console.log(`‚ö° Panel: Immediate update layer ${layerIndex}`);
                        this.updateLayerThumbnail(layerIndex);
                    } else {
                        this.updateAllThumbnails();
                    }
                });
                return;
            }
            
            if (this.thumbnailUpdateScheduled) return;
            this.thumbnailUpdateScheduled = true;
            
            requestAnimationFrame(() => {
                if (layerIndex !== undefined) {
                    this.updateLayerThumbnail(layerIndex);
                } else {
                    this.updateAllThumbnails();
                }
                this.thumbnailUpdateScheduled = false;
            });
        });
        
        // „Éö„É≥ÊèèÁîªÂÆå‰∫ÜÊôÇ
        this.eventBus.on('layer:path-added', ({ layerIndex }) => {
            if (this.thumbnailUpdateScheduled) return;
            this.thumbnailUpdateScheduled = true;
            
            requestAnimationFrame(() => {
                console.log(`‚úèÔ∏è Panel: Path added to layer ${layerIndex}`);
                this.updateAllThumbnails();
                this.thumbnailUpdateScheduled = false;
            });
        });
        
        // „Ç´„É°„É©Â§âÂΩ¢ÊôÇ
        this.eventBus.on('camera:transform-changed', () => {
            if (this.thumbnailUpdateScheduled) return;
            this.thumbnailUpdateScheduled = true;
            
            requestAnimationFrame(() => {
                console.log('üé• Panel: Camera transform changed');
                this.updateAllThumbnails();
                this.thumbnailUpdateScheduled = false;
            });
        });
        
        // „É™„Çµ„Ç§„Ç∫ÊôÇ
        this.eventBus.on('camera:resized', ({ width, height }) => {
            if (this.thumbnailUpdateScheduled) return;
            this.thumbnailUpdateScheduled = true;
            
            requestAnimationFrame(() => {
                console.log(`üìê Panel: Canvas resized to ${width}x${height}`);
                this.updateAllThumbnails();
                this.thumbnailUpdateScheduled = false;
            });
        });
        
        console.log('‚úì Event listeners configured (transform-updated, thumbnail-updated, etc.)');
    }

    render(layers, activeIndex, animationSystem = null) {
        if (!this.container) return;
        if (!layers || layers.length === 0) return;

        this.container.innerHTML = '';

        layers.forEach((layer, index) => {
            const layerElement = this.createLayerElement(
                layer,
                index,
                index === activeIndex,
                animationSystem
            );
            this.container.insertBefore(layerElement, this.container.firstChild);
        });

        // Phase 5: Sortable.js „ÅÆ‰ª£„Çè„Çä„Å´ PointerEvent „Éô„Éº„Çπ„ÅÆ„Éâ„É©„ÉÉ„Ç∞„ÇíË®≠ÂÆö
        this._setupPointerDrag();
    }

    createLayerElement(layer, index, isActive, animationSystem) {
        const layerDiv = document.createElement('div');
        layerDiv.className = isActive ? 'layer-item active' : 'layer-item';
        layerDiv.dataset.layerId = layer.layerData?.id || `layer-${index}`;
        
        // Phase 3: data-layer-index Â±ûÊÄß„ÇíËøΩÂä†ÔºàÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¨„Ç§„É§„ÉºÊõ¥Êñ∞Áî®Ôºâ
        layerDiv.dataset.layerIndex = index;
        
        // Phase 5: „Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å´„Åô„Çã
        layerDiv.style.touchAction = 'none';
        layerDiv.style.cursor = 'grab';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'layer-visibility-toggle';
        checkbox.checked = layer.visible !== false;
        checkbox.style.gridColumn = '1';
        checkbox.style.gridRow = '1 / 3';
        layerDiv.appendChild(checkbox);

        const nameSpan = document.createElement('span');
        nameSpan.className = 'layer-name';
        nameSpan.textContent = layer.layerData?.name || `Layer ${index}`;
        nameSpan.style.gridColumn = '2';
        nameSpan.style.gridRow = '2';
        layerDiv.appendChild(nameSpan);

        const thumbnail = this.createThumbnail(layer, index);
        layerDiv.appendChild(thumbnail);

        // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºà„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ‰ª•Â§ñÔºâ
        layerDiv.addEventListener('click', (e) => {
            if (e.target !== checkbox && !this.dragState.isDragging) {
                if (window.TegakiEventBus) {
                    window.TegakiEventBus.emit('ui:layer-selected', { 
                        layerIndex: index,
                        layerId: layer.layerData?.id
                    });
                }
            }
        });

        // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Ç§„Éô„É≥„Éà
        checkbox.addEventListener('change', (e) => {
            layer.visible = e.target.checked;
            if (window.TegakiEventBus) {
                window.TegakiEventBus.emit('ui:layer-visibility-changed', {
                    layerIndex: index,
                    visible: e.target.checked,
                    layerId: layer.layerData?.id
                });
            }
        });

        return layerDiv;
    }

    createThumbnail(layer, index) {
        const thumbnail = document.createElement('div');
        thumbnail.className = 'layer-thumbnail';
        thumbnail.style.gridColumn = '3';
        thumbnail.style.gridRow = '1 / 3';
        thumbnail.dataset.layerIndex = index;

        if (layer.layerData?.isBackground) {
            const swatch = document.createElement('div');
            swatch.style.width = '100%';
            swatch.style.height = '100%';
            swatch.style.backgroundColor = '#F0E0D6';
            thumbnail.appendChild(swatch);
            return thumbnail;
        }

        // img Ë¶ÅÁ¥†Ôºà„Çµ„É†„Éç„Ç§„É´Ë°®Á§∫Áî®Ôºâ
        const img = document.createElement('img');
        img.alt = 'Layer thumbnail';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.style.display = 'none';
        img.dataset.layerIndex = index;

        thumbnail.appendChild(img);

        // ÈùûÂêåÊúü„Åß„Çµ„É†„Éç„Ç§„É´ÁîüÊàê
        this._generateAndDisplayThumbnail(layer, index, img);

        return thumbnail;
    }

    /**
     * „Çµ„É†„Éç„Ç§„É´ÈùûÂêåÊúüÁîüÊàê„Å®Ë°®Á§∫
     * Phase 4: ThumbnailSystem.canvasToDataURL() Áµ±‰∏Ä‰ΩøÁî®
     */
    async _generateAndDisplayThumbnail(layer, index, img) {
        try {
            if (!window.ThumbnailSystem) {
                console.warn('ThumbnailSystem not initialized');
                return;
            }

            // „Çµ„É†„Éç„Ç§„É´ÁîüÊàê
            const bitmap = await window.ThumbnailSystem.generateLayerThumbnail(
                layer,
                64,
                64
            );

            if (!bitmap) {
                console.warn(`Failed to generate thumbnail for layer ${index}`);
                return;
            }

            // Phase 4: ThumbnailSystem „ÅÆ canvasToDataURL() „Çí‰ΩøÁî®
            const dataURL = window.ThumbnailSystem.canvasToDataURL(bitmap);
            
            if (dataURL) {
                img.src = dataURL;
                img.style.display = 'block';
                console.log(`‚úì Layer ${index} thumbnail displayed`);
            }

        } catch (error) {
            console.error(`Layer thumbnail generation failed for index ${index}:`, error);
        }
    }

    /**
     * ÊåáÂÆö„É¨„Ç§„É§„Éº„ÅÆ„Çµ„É†„Éç„Ç§„É´Êõ¥Êñ∞
     * Phase 3-4: „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂº∑Âà∂„ÇØ„É™„Ç¢„Åó„Å¶„Åã„ÇâÊõ¥Êñ∞
     */
    async updateLayerThumbnail(layerIndex) {
        if (!this.container) return;
        
        const layers = this.layerSystem?.getLayers?.();
        if (!layers || !layers[layerIndex]) return;

        const layer = layers[layerIndex];
        
        // Phase 3-4: „Çµ„É†„Éç„Ç§„É´Êõ¥Êñ∞Ââç„Å´„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
        if (window.ThumbnailSystem && layer.layerData?.id) {
            window.ThumbnailSystem._invalidateLayerCacheByLayerId(layer.layerData.id);
            console.log(`‚úì Layer ${layerIndex} cache invalidated`);
        }
        
        // Phase 3: data-layer-index „ÅßË¶ÅÁ¥†Ê§úÁ¥¢
        const layerDiv = this.container.querySelector(
            `.layer-item[data-layer-index="${layerIndex}"]`
        );

        if (!layerDiv) {
            console.warn(`Layer element not found for index ${layerIndex}`);
            return;
        }

        const thumbnail = layerDiv.querySelector('.layer-thumbnail');
        const img = thumbnail?.querySelector('img');
        
        if (!img) {
            console.warn(`Thumbnail image element not found for layer ${layerIndex}`);
            return;
        }

        // „Çµ„É†„Éç„Ç§„É´ÁîüÊàê„ÉªË°®Á§∫
        await this._generateAndDisplayThumbnail(layer, layerIndex, img);
    }

    /**
     * ÂÖ®„É¨„Ç§„É§„Éº„Çµ„É†„Éç„Ç§„É´Êõ¥Êñ∞
     */
    async updateAllThumbnails() {
        if (!this.container) return;
        
        const layers = this.layerSystem?.getLayers?.();
        if (!layers) return;

        // Phase 3-4: ÂÖ®„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢
        if (window.ThumbnailSystem) {
            window.ThumbnailSystem.clearAllCache();
            console.log('‚úì All thumbnail caches cleared');
        }

        // ÂÖ®„É¨„Ç§„É§„Éº„ÇíÈ†ÜÁï™„Å´Êõ¥Êñ∞
        for (let i = 0; i < layers.length; i++) {
            await this.updateLayerThumbnail(i);
            
            // Ë≤†Ëç∑ÂàÜÊï£
            if (i < layers.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 10));
            }
        }
        
        console.log(`‚úÖ All ${layers.length} layer thumbnails updated`);
    }

    /**
     * Phase 5: PointerEvent „Éô„Éº„Çπ„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„ÉóÂÆüË£Ö
     * „Çø„Éñ„É¨„ÉÉ„Éà„Éö„É≥„Éª„Çø„ÉÉ„ÉÅ„Éª„Éû„Ç¶„ÇπÂÖ®ÂØæÂøú
     */
    _setupPointerDrag() {
        if (!this.container) return;

        // „Ç≥„É≥„ÉÜ„Éä„Å´ PointerEvent „Éè„É≥„Éâ„É©„ÇíË®≠ÂÆö
        this.container.addEventListener('pointerdown', this._onPointerDown.bind(this));
        this.container.addEventListener('pointermove', this._onPointerMove.bind(this));
        this.container.addEventListener('pointerup', this._onPointerUp.bind(this));
        this.container.addEventListener('pointercancel', this._onPointerCancel.bind(this));

        console.log('‚úì PointerEvent-based drag initialized');
    }

    /**
     * PointerDown: „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
     */
    _onPointerDown(e) {
        // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇÑ„Çµ„É†„Éç„Ç§„É´„ÅØ„Çπ„Ç≠„ÉÉ„Éó
        if (e.target.type === 'checkbox' || e.target.classList.contains('layer-thumbnail')) {
            return;
        }

        // layer-item „ÇíÊé¢„Åô
        const layerItem = e.target.closest('.layer-item');
        if (!layerItem) return;

        // ËÉåÊôØ„É¨„Ç§„É§„Éº„ÅØ„Éâ„É©„ÉÉ„Ç∞‰∏çÂèØ
        const layerIndex = parseInt(layerItem.dataset.layerIndex);
        const layers = this.layerSystem?.getLayers?.();
        if (layers && layers[layerIndex]?.layerData?.isBackground) {
            return;
        }

        // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖãÂàùÊúüÂåñ
        this.dragState.isDragging = true;
        this.dragState.draggedElement = layerItem;
        this.dragState.draggedIndex = layerIndex;
        this.dragState.startY = e.clientY;
        this.dragState.currentY = e.clientY;
        this.dragState.pointerId = e.pointerId;

        // setPointerCapture „Åß„Ç§„Éô„É≥„ÉàÊçïÊçâ
        this.container.setPointerCapture(e.pointerId);

        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Çπ„Çø„Ç§„É´
        layerItem.style.opacity = '0.5';
        layerItem.style.cursor = 'grabbing';

        // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº‰ΩúÊàê
        this._createPlaceholder(layerItem);

        console.log(`üñ±Ô∏è Drag started: Layer ${layerIndex}`);
    }

    /**
     * PointerMove: „Éâ„É©„ÉÉ„Ç∞‰∏≠
     */
    _onPointerMove(e) {
        if (!this.dragState.isDragging) return;
        if (e.pointerId !== this.dragState.pointerId) return;

        this.dragState.currentY = e.clientY;

        const draggedElement = this.dragState.draggedElement;
        if (!draggedElement) return;

        // „Éâ„É©„ÉÉ„Ç∞Ë¶ÅÁ¥†„ÇíÁßªÂãï
        const deltaY = this.dragState.currentY - this.dragState.startY;
        draggedElement.style.transform = `translateY(${deltaY}px)`;

        // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº‰ΩçÁΩÆÊõ¥Êñ∞
        this._updatePlaceholderPosition(e.clientY);
    }

    /**
     * PointerUp: „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü
     */
    _onPointerUp(e) {
        if (!this.dragState.isDragging) return;
        if (e.pointerId !== this.dragState.pointerId) return;

        this._finalizeDrag();

        // releasePointerCapture
        this.container.releasePointerCapture(e.pointerId);
    }

    /**
     * PointerCancel: „Éâ„É©„ÉÉ„Ç∞„Ç≠„É£„É≥„Çª„É´
     */
    _onPointerCancel(e) {
        if (!this.dragState.isDragging) return;
        if (e.pointerId !== this.dragState.pointerId) return;

        this._cancelDrag();

        // releasePointerCapture
        this.container.releasePointerCapture(e.pointerId);
    }

    /**
     * „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº‰ΩúÊàê
     */
    _createPlaceholder(layerItem) {
        const placeholder = document.createElement('div');
        placeholder.className = 'layer-item-placeholder';
        placeholder.style.height = `${layerItem.offsetHeight}px`;
        placeholder.style.border = '2px dashed #888';
        placeholder.style.backgroundColor = 'rgba(0,0,0,0.1)';
        placeholder.style.boxSizing = 'border-box';

        // layerItem „ÅÆÊ¨°„Å´ÊåøÂÖ•
        layerItem.parentNode.insertBefore(placeholder, layerItem.nextSibling);

        this.dragState.placeholder = placeholder;
    }

    /**
     * „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº‰ΩçÁΩÆÊõ¥Êñ∞
     */
    _updatePlaceholderPosition(clientY) {
        const placeholder = this.dragState.placeholder;
        if (!placeholder) return;

        const layerItems = Array.from(this.container.querySelectorAll('.layer-item'));
        
        // ÁèæÂú®„ÅÆYÂ∫ßÊ®ô„Å´ÊúÄ„ÇÇËøë„ÅÑ layer-item „ÇíÊé¢„Åô
        let closestItem = null;
        let closestDistance = Infinity;

        for (const item of layerItems) {
            if (item === this.dragState.draggedElement) continue;

            const rect = item.getBoundingClientRect();
            const itemCenterY = rect.top + rect.height / 2;
            const distance = Math.abs(clientY - itemCenterY);

            if (distance < closestDistance) {
                closestDistance = distance;
                closestItem = item;
            }
        }

        if (closestItem) {
            const rect = closestItem.getBoundingClientRect();
            const containerRect = this.container.getBoundingClientRect();
            
            // clientY „Åå item „ÅÆ‰∏äÂçäÂàÜ„Å™„ÇâÂâç„Å´„ÄÅ‰∏ãÂçäÂàÜ„Å™„ÇâÂæå„Çç„Å´
            if (clientY < rect.top + rect.height / 2) {
                closestItem.parentNode.insertBefore(placeholder, closestItem);
            } else {
                closestItem.parentNode.insertBefore(placeholder, closestItem.nextSibling);
            }
        }
    }

    /**
     * „Éâ„É©„ÉÉ„Ç∞Á¢∫ÂÆö
     */
    _finalizeDrag() {
        const draggedElement = this.dragState.draggedElement;
        const placeholder = this.dragState.placeholder;

        if (!draggedElement || !placeholder) {
            this._cancelDrag();
            return;
        }

        // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÅÆ‰ΩçÁΩÆ„Å´„Éâ„É©„ÉÉ„Ç∞Ë¶ÅÁ¥†„ÇíÁßªÂãï
        placeholder.parentNode.insertBefore(draggedElement, placeholder);
        placeholder.remove();

        // „Çπ„Çø„Ç§„É´„É™„Çª„ÉÉ„Éà
        draggedElement.style.opacity = '';
        draggedElement.style.transform = '';
        draggedElement.style.cursor = 'grab';

        // Êñ∞„Åó„ÅÑ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíË®àÁÆó
        const layerItems = Array.from(this.container.querySelectorAll('.layer-item'));
        const newIndex = layerItems.indexOf(draggedElement);
        const oldIndex = this.dragState.draggedIndex;

        console.log(`üîÑ Drag finalized: ${oldIndex} ‚Üí ${newIndex}`);

        // „É¨„Ç§„É§„ÉºÈ†ÜÂ∫èÂ§âÊõ¥
        if (this.layerSystem?.reorderLayers && oldIndex !== newIndex) {
            this.layerSystem.reorderLayers(oldIndex, newIndex);
        }

        // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
        this._resetDragState();
    }

    /**
     * „Éâ„É©„ÉÉ„Ç∞„Ç≠„É£„É≥„Çª„É´
     */
    _cancelDrag() {
        const draggedElement = this.dragState.draggedElement;
        const placeholder = this.dragState.placeholder;

        if (draggedElement) {
            draggedElement.style.opacity = '';
            draggedElement.style.transform = '';
            draggedElement.style.cursor = 'grab';
        }

        if (placeholder) {
            placeholder.remove();
        }

        console.log('‚ùå Drag cancelled');

        this._resetDragState();
    }

    /**
     * „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
     */
    _resetDragState() {
        this.dragState.isDragging = false;
        this.dragState.draggedElement = null;
        this.dragState.draggedIndex = null;
        this.dragState.startY = 0;
        this.dragState.currentY = 0;
        this.dragState.pointerId = null;
        this.dragState.placeholder = null;
    }

    /**
     * „Éá„Éê„ÉÉ„Ç∞Áî®: „Ç≠„É£„ÉÉ„Ç∑„É•ÊÉÖÂ†±Ë°®Á§∫
     */
    debugPrintCacheInfo() {
        if (window.ThumbnailSystem) {
            const info = window.ThumbnailSystem.getDebugInfo();
            console.log('ThumbnailSystem Debug Info:', info);
        }
    }
    
    /**
     * „É¨„Ç§„É§„ÉºÂÄãÂà•„ÅÆË©≥Á¥∞ÊÉÖÂ†±Ë°®Á§∫Ôºà„Éá„Éê„ÉÉ„Ç∞Ôºâ
     */
    debugPrintLayerInfo(layerIndex) {
        const layers = this.layerSystem?.getLayers?.();
        if (!layers || !layers[layerIndex]) {
            console.error(`Layer ${layerIndex} not found`);
            return;
        }
        
        const layer = layers[layerIndex];
        console.log(`\nüìã Layer ${layerIndex} Debug Info:`);
        console.log(`  ID: ${layer.layerData?.id}`);
        console.log(`  Name: ${layer.layerData?.name}`);
        console.log(`  Visible: ${layer.visible}`);
        console.log(`  Opacity: ${layer.alpha}`);
        console.log(`  Position: (${layer.position.x}, ${layer.position.y})`);
        console.log(`  Scale: (${layer.scale.x}, ${layer.scale.y})`);
        console.log(`  Rotation: ${layer.rotation}`);
        console.log(`  IsBackground: ${layer.layerData?.isBackground}`);
    }
    
    /**
     * „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
     */
    destroy() {
        // throttle „Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
        for (const timer of this.layerUpdateTimers.values()) {
            clearTimeout(timer);
        }
        this.layerUpdateTimers.clear();
        
        // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„ÇØ„É™„Ç¢
        this._resetDragState();
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂâäÈô§
        if (this.container) {
            this.container.removeEventListener('pointerdown', this._onPointerDown);
            this.container.removeEventListener('pointermove', this._onPointerMove);
            this.container.removeEventListener('pointerup', this._onPointerUp);
            this.container.removeEventListener('pointercancel', this._onPointerCancel);
        }
        
        // canvas „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
        this.thumbnailCanvases.clear();
        
        console.log('‚úì LayerPanelRenderer destroyed');
    }
};

console.log('‚úÖ ui/layer-panel-renderer.js (Phase 5: „Çø„Éñ„É¨„ÉÉ„Éà„Éö„É≥ÂÆåÂÖ®ÂØæÂøúÁâà) loaded');
console.log('   ‚úì PointerEvent „Éô„Éº„ÇπÂÆüË£ÖÔºàSortable.js ‰∏çË¶ÅÔºâ');
console.log('   ‚úì „Çø„Éñ„É¨„ÉÉ„Éà„Éö„É≥„Éª„Çø„ÉÉ„ÉÅ„Éª„Éû„Ç¶„ÇπÂÖ®ÂØæÂøú');
console.log('   ‚úì setPointerCapture/releasePointerCapture ÂÆüË£Ö');
console.log('   ‚úì „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Éì„Ç∏„É•„Ç¢„É´„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ');
console.log('   ‚úì ËÉåÊôØ„É¨„Ç§„É§„Éº„Éâ„É©„ÉÉ„Ç∞Èò≤Ê≠¢');