// ===== „Ç≠„Éº„Éú„Éº„Éâ„Éè„É≥„Éâ„É©Ôºàindex.htmlÂÜÖ <script>„Çø„Ç∞ÈÉ®ÂàÜ„ÅÆÁΩÆ„ÅçÊèõ„ÅàÁî®Ôºâ=====
// üîß ‰øÆÊ≠£ÂÜÖÂÆπÔºö
// 1. ÊñπÂêë„Ç≠„Éº„ÅÆÁ¢∫ÂÆü„Å™Âãï‰ΩúÔºà‰∏ÄÊÆµÈ£õ„Å∞„Åó„ÅÆ‰øÆÊ≠£Ôºâ
// 2. Undo/Redo„ÅÆÂàùÊúüÂåñÂæÖÊ©üÂá¶ÁêÜ
// 3. „Ç§„Éô„É≥„ÉàÁô∫ÁÅ´È†ÜÂ∫è„ÅÆÊúÄÈÅ©Âåñ

(function() {
    'use strict';
    
    // ===== Áµ±Âêà„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà =====
    function setupUnifiedKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // F5, F11, F12„ÅØË®±ÂèØ
            if (e.key === 'F5' || e.key === 'F11' || e.key === 'F12') return;
            if (e.key.startsWith('F') && e.key.length <= 3) {
                e.preventDefault();
                return;
            }
            
            const eventBus = window.TegakiEventBus;
            if (!eventBus) return;
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Åß„ÅØÁÑ°ÂäπÂåñ
            const activeElement = document.activeElement;
            if (activeElement && (
                activeElement.tagName === 'INPUT' ||
                activeElement.tagName === 'TEXTAREA' ||
                activeElement.isContentEditable
            )) return;
            
            // üîß ‰øÆÊ≠£1: Undo/Redo - HistoryÂàùÊúüÂåñÁ¢∫Ë™ç
            if (e.ctrlKey && e.code === 'KeyZ' && !e.shiftKey && !e.altKey) {
                if (window.History && window.History.undo) {
                    window.History.undo();
                    e.preventDefault();
                } else {
                    console.warn('History not initialized yet');
                }
                return;
            }
            
            if (e.ctrlKey && e.code === 'KeyY' && !e.shiftKey && !e.altKey) {
                if (window.History && window.History.redo) {
                    window.History.redo();
                    e.preventDefault();
                } else {
                    console.warn('History not initialized yet');
                }
                return;
            }
            
            if (e.ctrlKey && e.code === 'KeyZ' && e.shiftKey && !e.altKey) {
                if (window.History && window.History.redo) {
                    window.History.redo();
                    e.preventDefault();
                } else {
                    console.warn('History not initialized yet');
                }
                return;
            }
            
            // üîß ‰øÆÊ≠£2: ÊñπÂêë„Ç≠„ÉºÔºà‚Üê/‚ÜíÔºâ- CUTÂàá„ÇäÊõø„Åà
            // preventDefault„ÇíÁ¢∫ÂÆü„Å´ÂÆüË°å„Åó„ÄÅÈÄ£Á∂öÂÆüË°å„ÇíÈò≤„Åê
            if (e.code === 'ArrowLeft' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                if (window.animationSystem && typeof window.animationSystem.goToPreviousFrame === 'function') {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // üîß „Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜ„ÅßÈÄ£Á∂öÂÆüË°å„ÇíÈò≤„Åê
                    if (!window._arrowKeyDebounce) {
                        window._arrowKeyDebounce = true;
                        window.animationSystem.goToPreviousFrame();
                        
                        setTimeout(() => {
                            window._arrowKeyDebounce = false;
                        }, 100);
                    }
                } else {
                    console.warn('animationSystem.goToPreviousFrame not available');
                }
                return;
            }
            
            if (e.code === 'ArrowRight' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                if (window.animationSystem && typeof window.animationSystem.goToNextFrame === 'function') {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // üîß „Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜ„ÅßÈÄ£Á∂öÂÆüË°å„ÇíÈò≤„Åê
                    if (!window._arrowKeyDebounce) {
                        window._arrowKeyDebounce = true;
                        window.animationSystem.goToNextFrame();
                        
                        setTimeout(() => {
                            window._arrowKeyDebounce = false;
                        }, 100);
                    }
                } else {
                    console.warn('animationSystem.goToNextFrame not available');
                }
                return;
            }
            
            // üîß ‰øÆÊ≠£3: ÊñπÂêë„Ç≠„ÉºÔºà‚Üë/‚ÜìÔºâ- „É¨„Ç§„É§„ÉºÈöéÂ±§ÁßªÂãï
            if (e.code === 'ArrowUp' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                if (window.drawingApp && window.drawingApp.layerManager) {
                    e.preventDefault();
                    window.drawingApp.layerManager.moveActiveLayerHierarchy('up');
                } else {
                    console.warn('layerManager not available');
                }
                return;
            }
            
            if (e.code === 'ArrowDown' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                if (window.drawingApp && window.drawingApp.layerManager) {
                    e.preventDefault();
                    window.drawingApp.layerManager.moveActiveLayerHierarchy('down');
                } else {
                    console.warn('layerManager not available');
                }
                return;
            }
            
            // Delete: „É¨„Ç§„É§„Éº„ÇØ„É™„Ç¢
            if (e.code === 'Delete' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                eventBus.emit('layer:clear-active');
                e.preventDefault();
                return;
            }
            
            // Ctrl+L: Êñ∞Ë¶è„É¨„Ç§„É§„Éº‰ΩúÊàê
            if (e.ctrlKey && e.code === 'KeyL' && !e.shiftKey && !e.altKey) {
                if (window.drawingApp && window.drawingApp.layerManager) {
                    const layerSystem = window.drawingApp.layerManager;
                    const newLayerIndex = layerSystem.layers.length + 1;
                    layerSystem.createLayer(`L${newLayerIndex}`, false);
                    e.preventDefault();
                }
                return;
            }
            
            // Shift+N: Êñ∞Ë¶èCUT‰ΩúÊàê
            if (e.shiftKey && e.code === 'KeyN' && !e.ctrlKey && !e.altKey) {
                if (window.animationSystem) {
                    window.animationSystem.createNewEmptyCut();
                    e.preventDefault();
                }
                return;
            }
            
            // Shift+A: „Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫ÂàáÊõø
            if (e.shiftKey && e.code === 'KeyA' && !e.ctrlKey && !e.altKey) {
                eventBus.emit('ui:toggle-timeline');
                e.preventDefault();
                return;
            }
            
            // K: ÂÜçÁîü/ÂÅúÊ≠¢
            if (e.code === 'KeyK' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                if (window.timelineUI && window.timelineUI.isVisible) {
                    window.timelineUI.togglePlayStop();
                    e.preventDefault();
                }
                return;
            }
            
            // Shift+C: CUT„Ç≥„Éî„Éº&„Éö„Éº„Çπ„Éà
            if (e.shiftKey && e.code === 'KeyC' && !e.ctrlKey && !e.altKey) {
                eventBus.emit('cut:copy-current');
                setTimeout(() => eventBus.emit('cut:paste-right-adjacent'), 10);
                e.preventDefault();
                return;
            }
            
            // P: „Éö„É≥„ÉÑ„Éº„É´
            if (e.code === 'KeyP' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                eventBus.emit('tool:select', { tool: 'pen' });
                e.preventDefault();
                return;
            }
            
            // E: Ê∂à„Åó„Ç¥„É†„ÉÑ„Éº„É´
            if (e.code === 'KeyE' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                eventBus.emit('tool:select', { tool: 'eraser' });
                e.preventDefault();
                return;
            }
        });
    }
    
    // ===== ‰æùÂ≠òÈñ¢‰øÇ„ÉÅ„Çß„ÉÉ„ÇØ =====
    function checkPhase1Dependencies() {
        const dependencies = [
            { name: 'PIXI', obj: window.PIXI },
            { name: 'TEGAKI_CONFIG', obj: window.TEGAKI_CONFIG },
            { name: 'TegakiEventBus', obj: window.TegakiEventBus },
            { name: 'Sortable', obj: window.Sortable },
            { name: 'GIF', obj: window.GIF }
        ];
        
        const missing = dependencies.filter(dep => !dep.obj);
        if (missing.length > 0) {
            console.error('Dependencies not loaded:', missing.map(d => d.name).join(', '));
            return false;
        }
        
        if (!window.TEGAKI_CONFIG.animation) {
            console.error('Animation configuration not found');
            return false;
        }
        
        return true;
    }

    function checkCoreRuntime() {
        if (!window.CoreRuntime) return false;
        if (!window.TegakiCore || !window.TegakiCore.CoreEngine) return false;
        return true;
    }

    // ===== „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ =====
    function initializeApp() {
        const CoreEngine = window.TegakiCore.CoreEngine;
        const CONFIG = window.TEGAKI_CONFIG;
        const { UIController } = window.TegakiUI;
        
        class DrawingApp {
            constructor() {
                this.pixiApp = null;
                this.coreEngine = null;
                this.uiController = null;
            }
            
            async initialize() {
                const containerEl = document.getElementById('drawing-canvas');
                if (!containerEl) {
                    console.error('Canvas container not found');
                    return false;
                }
                
                this.pixiApp = new PIXI.Application();
                
                const screenWidth = window.innerWidth - 50;
                const screenHeight = window.innerHeight;
                
                await this.pixiApp.init({
                    width: screenWidth,
                    height: screenHeight,
                    backgroundAlpha: 0,
                    resolution: 1,
                    antialias: true,
                    eventMode: 'static'
                });
                
                containerEl.innerHTML = '';
                containerEl.appendChild(this.pixiApp.canvas);
                
                this.pixiApp.canvas.style.width = `${screenWidth}px`;
                this.pixiApp.canvas.style.height = `${screenHeight}px`;
                
                // üîß ‰øÆÊ≠£: CoreEngineÂàùÊúüÂåñÔºàstage„ÇíÊ≠£„Åó„ÅèÊ∏°„ÅôÔºâ
                this.coreEngine = new CoreEngine(this.pixiApp);
                this.coreEngine.initialize();
                
                // üîß ‰øÆÊ≠£: window.drawingApp„ÅÆÊßãÈÄ†‰ΩúÊàê
                window.drawingApp = {
                    pixiApp: this.pixiApp,
                    coreEngine: this.coreEngine,
                    cameraSystem: this.coreEngine.getCameraSystem(),
                    layerManager: this.coreEngine.getLayerManager(),
                    drawingEngine: this.coreEngine.getDrawingEngine(),
                    uiController: null
                };
                
                // CoreRuntimeÂàùÊúüÂåñ
                const runtimeSuccess = CoreRuntime.init({
                    app: this.pixiApp,
                    worldContainer: this.coreEngine.getCameraSystem().worldContainer,
                    canvasContainer: this.coreEngine.getCameraSystem().canvasContainer,
                    cameraSystem: this.coreEngine.getCameraSystem(),
                    layerManager: this.coreEngine.getLayerManager(),
                    drawingEngine: this.coreEngine.getDrawingEngine()
                });
                
                if (!runtimeSuccess) {
                    console.error('‚ùå CoreRuntime initialization failed');
                    return false;
                }
                
                // „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü„Ç§„Éô„É≥„ÉàÁô∫ÁÅ´
                if (window.TegakiEventBus) {
                    window.TegakiEventBus.emit('system:ready');
                }
                
                // UI„Ç≥„É≥„Éà„É≠„Éº„É©‰ΩúÊàê
                this.uiController = new UIController(
                    this.coreEngine.getDrawingEngine(), 
                    this.coreEngine.getLayerManager(), 
                    this.pixiApp
                );
                
                window.drawingApp.uiController = this.uiController;
                
                // „É¨„Ç¨„Ç∑„Éº‰∫íÊèõÊÄß
                window.drawingAppResizeCanvas = (newWidth, newHeight) => {
                    return CoreRuntime.api.resizeCanvas(newWidth, newHeight);
                };
                
                // „É™„Çµ„Ç§„Ç∫Âá¶ÁêÜ
                window.addEventListener('resize', () => {
                    const newWidth = window.innerWidth - 50;
                    const newHeight = window.innerHeight;
                    
                    this.pixiApp.renderer.resize(newWidth, newHeight);
                    this.pixiApp.canvas.style.width = `${newWidth}px`;
                    this.pixiApp.canvas.style.height = `${newHeight}px`;
                    
                    const cameraSystem = this.coreEngine.getCameraSystem();
                    cameraSystem.initializeCamera();
                    cameraSystem.updateGuideLinesForCanvasResize();
                });
                
                this.updateCanvasInfo();
                this.updateDPRInfo();
                this.startFPSMonitor();
                
                return true;
            }
            
            updateCanvasInfo() {
                const element = document.getElementById('canvas-info');
                if (element) {
                    element.textContent = `${CONFIG.canvas.width}√ó${CONFIG.canvas.height}px`;
                }
            }
            
            updateDPRInfo() {
                const element = document.getElementById('dpr-info');
                if (element) {
                    element.textContent = (window.devicePixelRatio || 1).toFixed(1);
                }
            }
            
            startFPSMonitor() {
                let frameCount = 0;
                let lastTime = performance.now();
                
                const updateFPS = () => {
                    frameCount++;
                    const currentTime = performance.now();
                    
                    if (currentTime - lastTime >= 1000) {
                        const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                        const element = document.getElementById('fps');
                        if (element) element.textContent = fps;
                        
                        frameCount = 0;
                        lastTime = currentTime;
                    }
                    
                    requestAnimationFrame(updateFPS);
                };
                
                updateFPS();
            }
        }
        
        return DrawingApp;
    }

    // ===== HistoryÁµ±Âêà =====
    function setupHistoryIntegration() {
        if (window.TegakiEventBus && window.History) {
            window.TegakiEventBus.on('history:undo-request', () => {
                if (window.History.undo) window.History.undo();
            });
            
            window.TegakiEventBus.on('history:redo-request', () => {
                if (window.History.redo) window.History.redo();
            });
            
            window.TegakiEventBus.on('history:changed', (data) => {
                const historyElement = document.getElementById('history-info');
                if (historyElement && data) {
                    historyElement.textContent = `${data.undoCount || 0}/${window.History.MAX_HISTORY || 50}`;
                }
            });
            
            if (window.History.getHistoryInfo) {
                const info = window.History.getHistoryInfo();
                const historyElement = document.getElementById('history-info');
                if (historyElement) {
                    historyElement.textContent = `${info.undoCount}/${info.maxHistory}`;
                }
            }
        }
    }

    // ===== „É¨„Ç§„É§„Éº„Éë„Éç„É´ÈáçË§á‰øÆÊ≠£ =====
    function setupLayerPanelDuplicationFix() {
        if (window.TegakiEventBus) {
            window.TegakiEventBus.on('layer:created', () => {
                setTimeout(() => {
                    if (window.layerSystem && window.layerSystem.updateLayerPanelUI) {
                        window.layerSystem.updateLayerPanelUI();
                    }
                }, 50);
            });
            
            window.TegakiEventBus.on('layer:deleted', () => {
                setTimeout(() => {
                    if (window.layerSystem && window.layerSystem.updateLayerPanelUI) {
                        window.layerSystem.updateLayerPanelUI();
                    }
                }, 50);
            });
        }
    }

    // ===== DOMContentLoaded =====
    window.addEventListener('DOMContentLoaded', async () => {
        console.log('=== „ÅäÁµµ„Åã„Åç„ÉÑ„Éº„É´ ÂÆåÂÖ®‰øÆÊ≠£Áâà: Ëµ∑ÂãïÈñãÂßã ===');
        
        if (!checkPhase1Dependencies()) {
            console.error('‚ùå Dependencies check failed');
            return;
        }
        
        if (!checkCoreRuntime()) {
            console.error('‚ùå CoreRuntime not initialized');
            return;
        }
        
        const DrawingApp = initializeApp();
        const app = new DrawingApp();
        const success = await app.initialize();
        
        if (!success) {
            console.error('‚ùå App initialization failed');
            return;
        }
        
        console.log('‚úÖ App initialization successful');
        
        // üîß ‰øÆÊ≠£: „Ç≠„Éº„Éú„Éº„Éâ„Éè„É≥„Éâ„É©„ÇíHistoryÂàùÊúüÂåñÂæå„Å´Ë®≠ÂÆö
        setTimeout(() => {
            setupUnifiedKeyboardShortcuts();
            console.log('‚úÖ Keyboard shortcuts initialized');
        }, 300);
        
        setupHistoryIntegration();
        setupLayerPanelDuplicationFix();
        
        if (window.CoordinateSystem && window.CoordinateSystem.diagnoseReferences) {
            window.CoordinateSystem.diagnoseReferences();
        }
        
        console.log('=== „ÅäÁµµ„Åã„Åç„ÉÑ„Éº„É´ ÂÆåÂÖ®‰øÆÊ≠£Áâà: Ëµ∑ÂãïÂÆå‰∫Ü ===');
    });

    // ===== „É≠„Éº„ÉâÂâç„ÅÆÊó©ÊúüÂàùÊúüÂåñÔºàDOMContentLoaded„Çà„ÇäÂâç„Å´ÂÆüË°åÔºâ=====
    if (document.readyState === 'loading') {
        // „Åæ„Å†„É≠„Éº„Éâ‰∏≠„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàDOMContentLoaded„ÅßÂá¶ÁêÜÔºâ
    } else {
        // Êó¢„Å´„É≠„Éº„ÉâÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´ÂÆüË°å
        console.warn('‚ö†Ô∏è Document already loaded. Running initialization immediately.');
        const event = new Event('DOMContentLoaded');
        window.dispatchEvent(event);
    }
})();