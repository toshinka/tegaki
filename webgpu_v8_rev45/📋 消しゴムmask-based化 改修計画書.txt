ğŸ“‹ æ¶ˆã—ã‚´ãƒ mask-basedåŒ– æ”¹ä¿®è¨ˆç”»æ›¸
ğŸ” ç¾çŠ¶åˆ†æ
âŒ ç¾åœ¨ã®å•é¡Œ

ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å˜ä½æ¶ˆå»: æ¶ˆã—ã‚´ãƒ ãŒãƒ‘ã‚¹å…¨ä½“ã®alphaæ“ä½œã®ã¿
è»Œè·¡ãƒ™ãƒ¼ã‚¹ä¸å¯: ãƒšãƒ³è»Œè·¡ã«æ²¿ã£ãŸå‰Šé™¤ãŒã§ããªã„
å½«åˆ»çš„æç”»ä¸å¯: å‰Šã£ã¦æãè¡¨ç¾ãŒä¸å¯èƒ½

âœ… å®Ÿè£…æ¸ˆã¿è¦ç´ 

webgpu-mask-layer.js Phase 5: mask textureç®¡ç†å®Ÿè£…æ¸ˆã¿
eraseAppendPoint() / finalizeErase(): APIå®Ÿè£…æ¸ˆã¿
GPU compute shaderåŸºç›¤: å‹•ä½œç¢ºèªæ¸ˆã¿


ğŸ¯ æ”¹ä¿®ç›®æ¨™
mask-basedæ¶ˆã—ã‚´ãƒ ã«ã‚ˆã‚Šä»¥ä¸‹ã‚’å®Ÿç¾:

âœ… è»Œè·¡ã«æ²¿ã£ãŸé€æ˜åŒ–ï¼ˆãƒ–ãƒ©ã‚·çš„æ¶ˆå»ï¼‰
âœ… ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ä¿æŒï¼ˆUndo/Redoæ™‚ã«å†æç”»å¯èƒ½ï¼‰
âœ… å½«åˆ»çš„æç”»å¯¾å¿œï¼ˆå‰Šã£ã¦æãè¡¨ç¾ï¼‰


ğŸ“ å½±éŸ¿ç¯„å›²ãƒ•ã‚¡ã‚¤ãƒ«
ãƒ•ã‚¡ã‚¤ãƒ«æ”¹ä¿®å†…å®¹å„ªå…ˆåº¦brush-core.jsæ¶ˆã—ã‚´ãƒ ãƒ­ã‚¸ãƒƒã‚¯å…¨é¢æ›¸ãæ›ãˆğŸ”¥ æœ€å„ªå…ˆwebgpu-mask-layer.jsAPIèª¿æ•´ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆğŸ”¥ é«˜history.jsmask snapshotä¿å­˜ğŸ”¥ é«˜layer-system.jsãƒã‚¹ã‚¯ãƒ†ã‚¯ã‚¹ãƒãƒ£ç®¡ç†ä¸­stroke-renderer.jsãƒã‚¹ã‚¯é©ç”¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­

ğŸ”§ Phase 1: brush-core.js æ¶ˆã—ã‚´ãƒ å…¨é¢æ›¸ãæ›ãˆ
ç¾çŠ¶ã‚³ãƒ¼ãƒ‰ï¼ˆL460-550ä»˜è¿‘ï¼‰
javascript// âŒ ç¾çŠ¶: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å‰²alphaæ“ä½œ
async _applyEraserMask(activeLayer, bounds) {
  const segments = [];
  for (let i = 0; i < eraserPoints.length; i += segmentSize) {
    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å‰²
  }
  
  for (const child of container.children) {
    // alphaæ“ä½œã§é€æ˜åŒ–
    child.alpha = Math.max(0, child.alpha - intersectRatio);
  }
}
æ”¹ä¿®å¾Œã‚³ãƒ¼ãƒ‰
javascript// âœ… æ”¹ä¿®å¾Œ: mask-basedé€æ˜åŒ–
async _applyEraserMask(activeLayer, bounds) {
  // 1. webgpu-mask-layerçµŒç”±ã§mask textureç”Ÿæˆ
  const maskTexture = await this.webgpuMaskLayer.generateEraseMask(
    this.strokeRecorder.getRawPoints(),
    this.currentSettings.size
  );
  
  // 2. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«maské©ç”¨
  if (!activeLayer.maskTexture) {
    activeLayer.maskTexture = maskTexture;
  } else {
    // æ—¢å­˜maskã¨åˆæˆ
    await this.webgpuMaskLayer.composeMasks(
      activeLayer.maskTexture,
      maskTexture
    );
  }
  
  // 3. æç”»æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
  this.eventBus.emit('layer:mask-updated', {
    layerId: activeLayer.id,
    maskTexture: activeLayer.maskTexture
  });
}
çµ±åˆãƒã‚¤ãƒ³ãƒˆ

startStroke(): æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
updateStroke(): webgpuMaskLayer.eraseAppendPoint() å‘¼ã³å‡ºã—
finalizeStroke(): webgpuMaskLayer.finalizeErase() â†’ mask textureå–å¾—
_applyEraserMask(): ä¸Šè¨˜æ–°ã‚³ãƒ¼ãƒ‰ã«å·®ã—æ›¿ãˆ


ğŸ”§ Phase 2: webgpu-mask-layer.js APIèª¿æ•´
å¿…è¦ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª
javascript// âœ… å®Ÿè£…æ¸ˆã¿ç¢ºèª
class WebGPUMaskLayer {
  startErase()                          // âœ… å®Ÿè£…æ¸ˆã¿
  eraseAppendPoint(x, y, radius)        // âœ… å®Ÿè£…æ¸ˆã¿
  finalizeErase()                       // âœ… å®Ÿè£…æ¸ˆã¿
  
  // ğŸ”§ è¿½åŠ å¿…è¦
  generateEraseMask(points, brushSize)  // â† Phase 2ã§å®Ÿè£…
  composeMasks(baseTexture, newTexture) // â† Phase 2ã§å®Ÿè£…
}
å®Ÿè£…å„ªå…ˆåº¦

generateEraseMask(): ãƒã‚¤ãƒ³ãƒˆé…åˆ—â†’mask textureå¤‰æ›
composeMasks(): è¤‡æ•°æ¶ˆã—ã‚´ãƒ ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯çµ±åˆ


ğŸ”§ Phase 3: history.js mask snapshotå¯¾å¿œ
ç¾çŠ¶ã®å±¥æ­´æ§‹é€ 
javascript// âŒ ç¾çŠ¶: ãƒ‘ã‚¹æƒ…å ±ã®ã¿ä¿å­˜
{
  type: 'erase',
  layerId: activeLayer.id,
  pathId: pathData.id // â† ãƒ‘ã‚¹å‰Šé™¤æƒ…å ±
}
æ”¹ä¿®å¾Œæ§‹é€ 
javascript// âœ… æ”¹ä¿®å¾Œ: mask snapshotä¿å­˜
{
  type: 'erase',
  layerId: activeLayer.id,
  maskSnapshot: {
    before: previousMaskTexture,  // Undoç”¨
    after: currentMaskTexture,    // Redoç”¨
    bounds: eraseBounds
  }
}
å®Ÿè£…ãƒ¡ã‚½ãƒƒãƒ‰
javascript// history.js ã«è¿½åŠ 
pushEraseMask(layerId, beforeMask, afterMask, bounds) {
  this.push({
    name: 'erase-mask',
    do: () => {
      const layer = layerSystem.getLayerById(layerId);
      layer.maskTexture = afterMask;
    },
    undo: () => {
      const layer = layerSystem.getLayerById(layerId);
      layer.maskTexture = beforeMask;
    },
    meta: { type: 'erase-mask', layerId, bounds }
  });
}

ğŸ”§ Phase 4: layer-system.js ãƒã‚¹ã‚¯ç®¡ç†
ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ æ‹¡å¼µ
javascript// layer-system.js
class LayerSystem {
  createLayer(options) {
    const layer = {
      id: generateId(),
      // ... æ—¢å­˜ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
      
      // âœ… è¿½åŠ 
      maskTexture: null,        // GPU mask texture
      maskEnabled: true,        // maskæœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
      maskCompositeMode: 'multiply' // åˆæˆãƒ¢ãƒ¼ãƒ‰
    };
  }
}
ãƒã‚¹ã‚¯é©ç”¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
javascript// stroke-renderer.js ã«è¿½åŠ 
renderLayerWithMask(layer) {
  if (!layer.maskTexture || !layer.maskEnabled) {
    return this.renderLayerNormal(layer);
  }
  
  // GPU shaderçµŒç”±ã§maské©ç”¨
  const maskedTexture = this.applyMaskShader(
    layer.renderTexture,
    layer.maskTexture
  );
  
  return maskedTexture;
}
```

---

### ğŸ“Š å®Ÿè£…é †åº

#### ğŸ”¥ Phase 1: åŸºç›¤çµ±åˆï¼ˆæœ€å„ªå…ˆï¼‰
1. brush-core.js æ¶ˆã—ã‚´ãƒ ãƒ­ã‚¸ãƒƒã‚¯æ›¸ãæ›ãˆ
2. webgpu-mask-layer.js èª¿æŸ»ãƒ»APIç¢ºèª
3. çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå˜ç´”ãªæ¶ˆã—ã‚´ãƒ å‹•ä½œï¼‰

#### ğŸ”¥ Phase 2: maskç”Ÿæˆãƒ»åˆæˆ
1. `generateEraseMask()` å®Ÿè£…
2. `composeMasks()` å®Ÿè£…
3. è¤‡æ•°ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯çµ±åˆãƒ†ã‚¹ãƒˆ

#### ğŸ”¥ Phase 3: å±¥æ­´å¯¾å¿œ
1. history.js mask snapshotæ§‹é€ è¿½åŠ 
2. Undo/Redoå®Ÿè£…
3. å±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ

#### ä¸­ Phase 4: ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµ±åˆ
1. layer-system.js ãƒã‚¹ã‚¯ç®¡ç†è¿½åŠ 
2. stroke-renderer.js ãƒã‚¹ã‚¯é©ç”¨å®Ÿè£…
3. æœ€çµ‚çµ±åˆãƒ†ã‚¹ãƒˆ

---

### âš ï¸ æŠ€è¡“çš„èª²é¡Œ

#### 1. Mask Textureç®¡ç†
- **èª²é¡Œ**: GPU textureç”Ÿå­˜æœŸé–“ç®¡ç†
- **å¯¾ç­–**: texture poolå®Ÿè£…ï¼ˆmsdf-pipelineåŒæ§˜ï¼‰

#### 2. Maskåˆæˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- **èª²é¡Œ**: è¤‡æ•°ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æ™‚ã®åˆæˆè² è·
- **å¯¾ç­–**: GPU compute shaderæ´»ç”¨

#### 3. å±¥æ­´å®¹é‡
- **èª²é¡Œ**: mask textureä¿å­˜ã§ãƒ¡ãƒ¢ãƒªå¢—å¤§
- **å¯¾ç­–**: 
  - boundså¤–åˆ‡ã‚ŠæŠœã
  - å·®åˆ†åœ§ç¸®ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

---

### ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ

#### âœ… æ”¹ä¿®å¾Œ
```
æ¶ˆã—ã‚´ãƒ ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–‹å§‹
â†’ pointermoveæ¯ã«mask textureæ›´æ–°
â†’ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€æ˜åŒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
â†’ pointerupæ™‚ã«maskç¢ºå®š
â†’ å±¥æ­´ã«snapshotä¿å­˜
â†’ Undoã§å…ƒã«æˆ»ã‚‹ï¼ˆãƒ‘ã‚¹ã¯ä¿æŒï¼‰
ğŸ¨ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

å½«åˆ»çš„æç”»: é»’å¡—ã‚Šâ†’æ¶ˆã—ã‚´ãƒ ã§å‰Šã‚‹è¡¨ç¾
ä¿®æ­£ä½œæ¥­: éƒ¨åˆ†çš„ãªå‰Šé™¤ãƒ»ã‚„ã‚Šç›´ã—
ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: æ¶ˆã—ã‚´ãƒ ç­†åœ§ã§é€æ˜åº¦èª¿æ•´


ğŸ“‹ ãƒ‡ãƒãƒƒã‚°æ‰‹é †
Step 1: maskç”Ÿæˆç¢ºèª
javascriptconsole.log('[Mask Debug] Points:', eraserPoints.length);
console.log('[Mask Debug] Texture:', maskTexture.width, maskTexture.height);
Step 2: maské©ç”¨ç¢ºèª
javascriptconsole.log('[Mask Apply] Before alpha:', child.alpha);
console.log('[Mask Apply] After alpha:', child.alpha);
Step 3: å±¥æ­´ç¢ºèª
javascriptconsole.log('[History] Mask snapshot saved:', history.stack.length);
console.log('[History] Undo available:', history.canUndo());
```

---

## ğŸ“ æ®‹å­˜å•é¡Œãƒ¡ãƒ¢ï¼ˆPhase 1-3å®Œäº†å¾Œã®èª²é¡Œï¼‰

### ğŸ”´ æœªè§£æ±ºå•é¡Œ

#### 1. ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯çµ‚äº†ã¾ã§ç·šãŒå‡ºãªã„
**çŠ¶æ…‹**: brush-core.js Phase 1æ”¹ä¿®æ¸ˆã¿ã ãŒ**æ”¹å–„ãªã—**

**åŸå› æ¨å®š**:
- `renderPreview()` ãŒç©ºæŒ¯ã‚Šã—ã¦ã„ã‚‹å¯èƒ½æ€§
- msdf-pipeline-manager.js ã® `sampleCount: 1` å•é¡Œ
```
  webgpu-drawing-layer.js: sampleCount: 4 âœ…
  msdf-pipeline-manager.js: sampleCount: 1 âŒ â† ä¸ä¸€è‡´
æ¬¡ã‚¹ãƒ†ãƒƒãƒ—:

msdf-pipeline-manager.jsåˆæœŸåŒ–æ™‚ã« sampleCount ã‚’æ­£ã—ãæ¸¡ã™
renderPreview() å†…ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¿½åŠ 
GPU textureç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ç¢ºèª


2. ã‚¸ãƒ£ã‚®ãƒ¼ï¼ˆå††æç”»æ™‚ï¼‰
çŠ¶æ…‹: MSAA/range/è£œé–“ã™ã¹ã¦å®Ÿè£…æ¸ˆã¿ã ãŒç›®è¦–æ”¹å–„ãªã—
åŸå› æ¨å®š:

MSAA sampleCountä¸ä¸€è‡´ï¼ˆä¸Šè¨˜ï¼‰
ãƒ†ã‚¯ã‚¹ãƒãƒ£è§£åƒåº¦512pxãŒä¸è¶³
JFAç²¾åº¦é™ç•Œ

æ¬¡ã‚¹ãƒ†ãƒƒãƒ—:

MSAAçµ±åˆä¿®æ­£å¾Œã«å†è©•ä¾¡
å¿…è¦ã«å¿œã˜ã¦1024pxåŒ–ãƒ†ã‚¹ãƒˆï¼ˆè² è·è¨ˆæ¸¬å¿…é ˆï¼‰
æ‰‹æãç·š vs å††ã®å“è³ªå·®ã‚’åˆ†æ


3. ç­†åœ§åæ˜ ä¸å®Œå…¨
çŠ¶æ…‹: gpu-stroke-processor.jså®Ÿè£…æ¸ˆã¿ã ãŒç¸æ¨¡æ§˜ãŒå‡ºã‚‹
åŸå› æ¨å®š:

appendPointToStream() ãŒå‘¼ã°ã‚Œã¦ã„ãªã„
GPU streaming bufferæ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œ
MSDF encodeæ™‚ã®ç­†åœ§æƒ…å ±æå¤±

æ¬¡ã‚¹ãƒ†ãƒƒãƒ—:

updateStroke() â†’ appendPointToStream() å‘¼ã³å‡ºã—ç¢ºèª
GPU bufferè»¢é€ãƒ­ã‚°è¿½åŠ 
msdf-encode.wgsl ã§ç­†åœ§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª


ğŸŸ¡ è¨­è¨ˆèª²é¡Œ
4. Export Previewæœªå®Ÿè£…
çŠ¶æ…‹: export-popup.js ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º
å¯¾ç­–: åˆ¥Phaseå®Ÿè£…ï¼ˆå„ªå…ˆåº¦ä½ï¼‰
5. Vã‚­ãƒ¼å¤‰å½¢å¾Œã®ãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚ºæœªå®Ÿè£…
çŠ¶æ…‹: æ‹¡å¤§å¾Œã‚‚ãƒ™ã‚¯ã‚¿ãƒ¼å†è¨ˆç®—ãªã—
å¯¾ç­–: layer-transform.js ã§ confirmTransform() æ™‚ã«MSDFå†ç”Ÿæˆ

ğŸ”§ core-initializer.js çµ±åˆä¿®æ­£å¿…è¦
é‡è¦: msdf-pipeline-manageråˆæœŸåŒ–æ™‚ã« sampleCount ã‚’æ¸¡ã™
javascript// core-initializer.js ä¿®æ­£ç®‡æ‰€
const device = window.WebGPUDrawingLayer.getDevice();
const format = window.WebGPUDrawingLayer.getFormat();
const sampleCount = window.WebGPUDrawingLayer.getSampleCount(); // â† è¿½åŠ 

await window.MSDFPipelineManager.initialize(device, format, sampleCount); // â† ä¿®æ­£
