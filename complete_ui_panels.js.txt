// ===== ui-panels.js - å®Œå…¨çµåˆç‰ˆï¼ˆè¨­å®šãƒ‘ãƒãƒ«çµ±åˆï¼‰ =====
// Phase 12å¯¾å¿œ + è¨­å®šãƒ‘ãƒãƒ«çµ±åˆ

window.TegakiUI = {
    
    UIController: class {
        constructor(drawingEngine, layerManager, app) {
            this.drawingEngine = drawingEngine;
            this.layerManager = layerManager;
            this.app = app;
            this.activePopup = null;
            this.toolbarIconClickMode = false;
            this.albumPopup = null;
            this.settingsPopup = null; // ğŸ”¥ è¨­å®šãƒ‘ãƒãƒ«
            
            this.validateCoreRuntime();
            
            this.setupEventDelegation();
            this.setupSliders();
            this.setupCanvasResize();
            this.setupFlipButtons();
            this.initializeSettingsPopup(); // ğŸ”¥ è¨­å®šãƒ‘ãƒãƒ«åˆæœŸåŒ–
            window.TegakiUI.setupPanelStyles();
        }
        
        validateCoreRuntime() {
            if (!window.CoreRuntime) {
                throw new Error('CoreRuntime dependency missing');
            }
            
            if (!window.CoreRuntime.api) {
                throw new Error('CoreRuntime.api not initialized');
            }
        }
        
        // ğŸ”¥ è¨­å®šãƒ‘ãƒãƒ«åˆæœŸåŒ–
        initializeSettingsPopup() {
            if (!window.TegakiUI.SettingsPopup) {
                console.warn('âš ï¸ SettingsPopup not loaded');
                return false;
            }
            
            try {
                this.settingsPopup = new window.TegakiUI.SettingsPopup();
                
                // BrushSettingsã¨é€£æº
                if (this.drawingEngine && this.drawingEngine.settings) {
                    this.settingsPopup.setBrushSettings(this.drawingEngine.settings);
                }
                
                console.log('âœ… SettingsPopup initialized');
                return true;
            } catch (error) {
                console.error('âŒ Failed to initialize SettingsPopup:', error);
                return false;
            }
        }
        
        // ã‚¢ãƒ«ãƒãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆæœŸåŒ–
        initializeAlbumPopup(animationSystem) {
            if (!window.AlbumPopup) {
                console.error('âŒ AlbumPopup class not loaded');
                console.error('Make sure ui/album-popup.js is loaded before ui-panels.js');
                return false;
            }
            
            if (!animationSystem) {
                console.error('âŒ AnimationSystem not provided');
                return false;
            }
            
            try {
                this.albumPopup = new window.AlbumPopup(
                    this.app,
                    this.layerManager,
                    animationSystem
                );
                console.log('âœ… AlbumPopup initialized successfully');
                return true;