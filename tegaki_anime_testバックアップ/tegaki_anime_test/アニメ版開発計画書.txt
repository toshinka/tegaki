================================================================================
Tegaki ã‚¢ãƒ‹ãƒ¡ç‰ˆé–‹ç™ºè¨ˆç”»æ›¸
npm ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆã«ã‚ˆã‚‹CSPå¯¾ç­–å®Ÿè£…ã‚¬ã‚¤ãƒ‰
================================================================================

Document Version: 1.0
Last Updated: 2025-10-11
Target: å¾Œç¶šClaude / é–‹ç™ºè€…å‘ã‘æŠ€è¡“ä»•æ§˜æ›¸

================================================================================
ç›®æ¬¡
================================================================================

1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
3. Phase 1: ç’°å¢ƒæ§‹ç¯‰
4. Phase 2: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆ
5. Phase 3: ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£…
6. Phase 4: ãƒ­ãƒ¼ãƒ€ãƒ¼å®Ÿè£…
7. Phase 5: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
8. æ›éª¨å¥ªèƒã‚¬ã‚¤ãƒ‰ï¼ˆæ—¢å­˜ãƒ„ãƒ¼ãƒ«ã‹ã‚‰ã®ç§»è¡Œï¼‰

================================================================================
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
================================================================================

â–  1.1 ç›®çš„
  - ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ã§APNG/GIFæŠ•ç¨¿å¯èƒ½ãªãŠçµµã‹ããƒ„ãƒ¼ãƒ«æ§‹ç¯‰
  - CSPåˆ¶ç´„ä¸‹ã§ã‚‚å‹•ä½œã™ã‚‹å¤–éƒ¨ä¾å­˜ãªã—ã®å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
  - æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ«ï¼ˆbundlerä¸ä½¿ç”¨ã€ESMä¸ä½¿ç”¨ï¼‰ã‚’ç¶­æŒ

â–  1.2 æŠ€è¡“åˆ¶ç´„
  ã€éµå®ˆäº‹é …ã€‘
    - Canvas2Dä½¿ç”¨ç¦æ­¢ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ã®ã¿è¨±å¯ï¼‰
    - TypeScriptä½¿ç”¨ç¦æ­¢
    - Viteä½¿ç”¨ç¦æ­¢
    - ESMä½¿ç”¨ç¦æ­¢
    - bundlerï¼ˆwebpack/rollupï¼‰ä½¿ç”¨ç¦æ­¢
    - Babelä½¿ç”¨ç¦æ­¢
  
  ã€è¨±å¯äº‹é …ã€‘
    - npmï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ã¿ï¼‰
    - Node.jsï¼ˆãƒ•ã‚¡ã‚¤ãƒ«çµåˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã¿ï¼‰
    - ES2023æ§‹æ–‡ï¼ˆIIFEãƒ©ãƒƒãƒ—å¿…é ˆï¼‰
    - fetch API
    - CDNï¼ˆPixiJSã®ã¿ã€ã‚¢ãƒ‹ãƒ¡ç‰ˆã§ã¯ä¸è¦ï¼‰

â–  1.3 æˆæœç‰©
  tegaki_anime_test/
  â”œâ”€â”€ dist/tegaki_anime.js          # çµ±åˆæ¸ˆã¿ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«
  â”œâ”€â”€ tegaki-loader_anime.js        # ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆå¤‰æ›´ãªã—ï¼‰
  â””â”€â”€ TegakiAniTest.html            # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨HTML

================================================================================
2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
================================================================================

â–  2.1 å…¨ä½“ãƒ•ãƒ­ãƒ¼

  [ãƒ¦ãƒ¼ã‚¶ãƒ¼]
     â†“ ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå®Ÿè¡Œ
  [tegaki-loader_anime.js] â† ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ä¸Šã§å‹•ä½œ
     â†“ scriptã‚¿ã‚°ã§èª­ã¿è¾¼ã¿
  [tegaki_anime.js] â† UPNG/pako/GIF.jsçµ±åˆæ¸ˆã¿
     â†“ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
  [TegakiAnimeCore] â† æç”»ãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
     â†“ Blobç”Ÿæˆ
  [ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ] â† Fileæ³¨å…¥

â–  2.2 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¨å½¹å‰²

  ã€æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå‚è€ƒç”¨ï¼‰ã€‘
    - tegaki_basic.js           : é™æ­¢ç”»ç‰ˆã‚³ã‚¢
    - tegaki-loader_basic.js    : é™æ­¢ç”»ç‰ˆãƒ­ãƒ¼ãƒ€ãƒ¼
    - TegakiTest.html           : é™æ­¢ç”»ç‰ˆãƒ†ã‚¹ãƒˆ
    - tegaki_anime.jsï¼ˆæ—¢å­˜ï¼‰   : ã‚¢ãƒ‹ãƒ¡ç‰ˆã‚³ã‚¢ï¼ˆCDNä¾å­˜ç‰ˆãƒ»å‹•ä½œä¸è‰¯ï¼‰
    - tegaki-loader_anime.js    : ã‚¢ãƒ‹ãƒ¡ç‰ˆãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆCDNä¾å­˜ç‰ˆãƒ»å‹•ä½œä¸è‰¯ï¼‰
    - TegakiAniTest.html        : ã‚¢ãƒ‹ãƒ¡ç‰ˆãƒ†ã‚¹ãƒˆ

  ã€æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«ã€‘
    - package.json              : npmä¾å­˜ç®¡ç†
    - build.js                  : ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµåˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    - libs/upng.js              : npmã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸUPNG.js
    - libs/pako.js              : npmã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸpako.js
    - libs/gif.js               : npmã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸgif.js
    - libs/gif.worker.js        : npmã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸgif.worker.js
    - src/tegaki_anime_core.js  : æ—¢å­˜tegaki_anime.jsã‚’æ”¹ä¿®ã—ãŸã‚‚ã®
    - dist/tegaki_anime.js      : ãƒ“ãƒ«ãƒ‰å¾Œã®çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœ€çµ‚æˆæœç‰©ï¼‰

â–  2.3 ä¾å­˜é–¢ä¿‚ãƒãƒƒãƒ—

  package.json
    â””â”€> npm install
          â”œâ”€> upng-js@2.1.0
          â”œâ”€> pako@2.1.0
          â””â”€> gif.js@0.2.0
                â””â”€> gif.worker.jsï¼ˆåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

  build.js
    â”œâ”€ èª­ã¿è¾¼ã¿: libs/upng.js
    â”œâ”€ èª­ã¿è¾¼ã¿: libs/pako.js
    â”œâ”€ èª­ã¿è¾¼ã¿: libs/gif.js
    â”œâ”€ èª­ã¿è¾¼ã¿: libs/gif.worker.jsï¼ˆBase64åŒ–ï¼‰
    â””â”€ èª­ã¿è¾¼ã¿: src/tegaki_anime_core.js
         â†“
    å‡ºåŠ›: dist/tegaki_anime.jsï¼ˆçµ±åˆæ¸ˆã¿ï¼‰

  TegakiAniTest.html
    â””â”€ èª­ã¿è¾¼ã¿: dist/tegaki_anime.js
         â””â”€> window.TegakiAnimeCore ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–

  tegaki-loader_anime.jsï¼ˆã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ç”¨ï¼‰
    â””â”€ èª­ã¿è¾¼ã¿: https://[GitHub Pages]/dist/tegaki_anime.js
         â””â”€> window.TegakiAnimeCore ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–

================================================================================
Phase 1: ç’°å¢ƒæ§‹ç¯‰
================================================================================

â–  ç›®çš„
  - npmãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–
  - ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä½œæˆ

â–  ä½œæ¥­ãƒ•ã‚¡ã‚¤ãƒ«
  ã€æ–°è¦ä½œæˆã€‘
    - package.json
    - build.js
    - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

â–  å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«
  - ãªã—ï¼ˆæ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰

â–  å‡¦ç†ãƒ•ãƒ­ãƒ¼
  [ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³æ“ä½œ]
    â†“
  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
    â†“
  npm init -y
    â†“
  npm install upng-js pako gif.js
    â†“
  ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆlibs, src, distï¼‰

â–  å®Ÿè£…æ‰‹é †

ã€æ‰‹é †1-1ã€‘ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
  
  ã‚³ãƒãƒ³ãƒ‰:
    cd tegaki
    mkdir tegaki_anime_test
    cd tegaki_anime_test

  ç¢ºèª:
    pwd
    # å‡ºåŠ›: /path/to/tegaki/tegaki_anime_test

ã€æ‰‹é †1-2ã€‘package.jsonä½œæˆ

  ã‚³ãƒãƒ³ãƒ‰:
    npm init -y

  ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«: package.json
  
  å†…å®¹ï¼ˆè‡ªå‹•ç”Ÿæˆå¾Œã«ç·¨é›†ï¼‰:
    {
      "name": "tegaki_anime_test",
      "version": "1.0.0",
      "description": "Animation drawing tool for Mebuki channel",
      "main": "dist/tegaki_anime.js",
      "scripts": {
        "build": "node build.js"
      },
      "dependencies": {
        "upng-js": "^2.1.0",
        "pako": "^2.1.0",
        "gif.js": "^0.2.0"
      },
      "keywords": ["canvas", "animation", "apng", "gif"],
      "author": "",
      "license": "MIT"
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - npm init: package.jsonã®å¯¾è©±çš„ç”Ÿæˆ
    - -y ãƒ•ãƒ©ã‚°: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§è‡ªå‹•ç”Ÿæˆ

ã€æ‰‹é †1-3ã€‘ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

  ã‚³ãƒãƒ³ãƒ‰:
    npm install

  å‡¦ç†å†…å®¹:
    - package.jsonã®dependenciesã‚’èª­ã¿è¾¼ã¿
    - node_modules/ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    - package-lock.jsonã‚’ç”Ÿæˆï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šï¼‰

  ç¢ºèª:
    ls node_modules/
    # å‡ºåŠ›ä¾‹: upng-js  pako  gif.js

ã€æ‰‹é †1-4ã€‘ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ä½œæˆ

  ã‚³ãƒãƒ³ãƒ‰:
    mkdir libs src dist

  æœ€çµ‚çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :
    tegaki_anime_test/
    â”œâ”€â”€ node_modules/          # npmç®¡ç†ï¼ˆGitã«ã¯å«ã‚ãªã„ï¼‰
    â”œâ”€â”€ libs/                  # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚³ãƒ”ãƒ¼å…ˆ
    â”œâ”€â”€ src/                   # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
    â”œâ”€â”€ dist/                  # ãƒ“ãƒ«ãƒ‰å‡ºåŠ›
    â”œâ”€â”€ package.json
    â”œâ”€â”€ package-lock.json
    â””â”€â”€ build.js               # æ¬¡ã®Phaseã§ä½œæˆ

ã€æ‰‹é †1-5ã€‘ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼

  ã‚³ãƒãƒ³ãƒ‰:
    cp node_modules/upng-js/UPNG.js libs/upng.js
    cp node_modules/pako/dist/pako.min.js libs/pako.js
    cp node_modules/gif.js/dist/gif.js libs/gif.js
    cp node_modules/gif.js/dist/gif.worker.js libs/gif.worker.js

  ç¢ºèª:
    ls -lh libs/
    # å‡ºåŠ›ä¾‹:
    # upng.js      (ç´„50KB)
    # pako.js      (ç´„45KB)
    # gif.js       (ç´„30KB)
    # gif.worker.js (ç´„10KB)

  ç†ç”±:
    - node_modules/ã¯å®¹é‡ãŒå¤§ããGitã«å«ã‚ãªã„
    - libs/ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚’å®¹æ˜“ã«

â–  ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
  âœ“ package.jsonãŒå­˜åœ¨ã—ã€dependenciesã«3ã¤ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹
  âœ“ node_modules/ã«3ã¤ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã™ã‚‹
  âœ“ libs/ã«4ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã‚‹
  âœ“ src/, dist/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¦ã„ã‚‹

================================================================================
Phase 2: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆ
================================================================================

â–  ç›®çš„
  - è¤‡æ•°ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã«çµåˆ
  - GIF.jsã®Workerã‚’Base64åŸ‹ã‚è¾¼ã¿ã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–
  - CSPåˆ¶ç´„ã‚’å›é¿ã§ãã‚‹å½¢å¼ã«å¤‰æ›

â–  ä½œæ¥­ãƒ•ã‚¡ã‚¤ãƒ«
  ã€æ–°è¦ä½œæˆã€‘
    - build.js

â–  å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«
  - libs/upng.js
  - libs/pako.js
  - libs/gif.js
  - libs/gif.worker.js

â–  å‡¦ç†ãƒ•ãƒ­ãƒ¼
  [build.jså®Ÿè¡Œ]
    â†“
  libs/å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
    â†“
  gif.worker.jsã‚’Base64ã«å¤‰æ›
    â†“
  å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–‡å­—åˆ—çµåˆ
    â†“
  Workerã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    â†“
  ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å…¬é–‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    â†“
  dist/tegaki_anime.js ã«å‡ºåŠ›

â–  å®Ÿè£…æ‰‹é †

ã€æ‰‹é †2-1ã€‘build.jsä½œæˆï¼ˆåŸºæœ¬æ§‹é€ ï¼‰

  ãƒ•ã‚¡ã‚¤ãƒ«: build.js
  
  å†…å®¹:
    const fs = require('fs');
    const path = require('path');

    console.log('ğŸ”¨ Building tegaki_anime.js with inline Worker...');

    // å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼
    let output = `// ========================================
    // Tegaki Anime Bundle
    // UPNG.js + pako.js + GIF.js + TegakiAnimeCore
    // Build: ${new Date().toISOString()}
    // ========================================
    
    `;

    // æ¬¡ã®æ‰‹é †ã«ç¶šã...

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - require('fs'): Node.jsã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    - require('path'): ãƒ‘ã‚¹æ“ä½œãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    - console.log(): ãƒ“ãƒ«ãƒ‰çŠ¶æ³ã®è¡¨ç¤º

ã€æ‰‹é †2-2ã€‘ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¨çµåˆ

  build.js ã«è¿½åŠ :

    // çµåˆã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆ
    const libraryFiles = [
        'libs/upng.js',
        'libs/pako.js',
        'libs/gif.js'
    ];

    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é †æ¬¡èª­ã¿è¾¼ã‚“ã§çµåˆ
    libraryFiles.forEach(file => {
        console.log(`ğŸ“¦ Reading: ${file}`);
        const content = fs.readFileSync(path.join(__dirname, file), 'utf8');
        output += `\n// ========== ${file} ==========\n`;
        output += content + '\n';
    });

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - fs.readFileSync(path, encoding): ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæœŸçš„ã«èª­ã¿è¾¼ã¿
      - å¼•æ•°1: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
      - å¼•æ•°2: 'utf8' = ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã¿
      - æˆ»ã‚Šå€¤: ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆæ–‡å­—åˆ—ï¼‰
    - path.join(...paths): ãƒ‘ã‚¹ã‚’çµåˆï¼ˆOSä¾å­˜ã®åŒºåˆ‡ã‚Šæ–‡å­—ã‚’è‡ªå‹•å‡¦ç†ï¼‰
    - __dirname: å®Ÿè¡Œä¸­ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹

ã€æ‰‹é †2-3ã€‘GIF.jsã®Workerã‚’Base64åŒ–

  build.js ã«è¿½åŠ :

    // Worker ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
    console.log('ğŸ”§ Encoding gif.worker.js to Base64...');
    const workerCode = fs.readFileSync(
        path.join(__dirname, 'libs/gif.worker.js'), 
        'utf8'
    );
    const workerBase64 = Buffer.from(workerCode).toString('base64');
    console.log(`âœ“ Worker size: ${workerCode.length} bytes`);
    console.log(`âœ“ Base64 size: ${workerBase64.length} bytes`);

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - Buffer.from(string): æ–‡å­—åˆ—ã‚’ãƒãƒƒãƒ•ã‚¡ã«å¤‰æ›
    - Buffer.toString('base64'): ãƒãƒƒãƒ•ã‚¡ã‚’Base64æ–‡å­—åˆ—ã«å¤‰æ›
    
  å‡¦ç†å†…å®¹:
    - gif.worker.js ã®å†…å®¹ã‚’æ–‡å­—åˆ—ã¨ã—ã¦èª­ã¿è¾¼ã¿
    - Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦åŸ‹ã‚è¾¼ã¿å¯èƒ½ãªå½¢å¼ã«å¤‰æ›
    - ã“ã‚Œã«ã‚ˆã‚ŠWorkerã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã‚€å¿…è¦ãŒãªããªã‚‹

ã€æ‰‹é †2-4ã€‘Workerã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã‚³ãƒ¼ãƒ‰ã‚’IIFEã§è¿½åŠ 

  build.js ã«è¿½åŠ :

    // Worker ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã™ã‚‹ã‚³ãƒ¼ãƒ‰
    output += `
    // ========== GIF.js Worker Inline ==========
    (function() {
        'use strict';
        
        // GIFãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (typeof window === 'undefined' || !window.GIF) {
            console.warn('GIF.js not loaded, skipping Worker inline');
            return;
        }
        
        // Base64ã‹ã‚‰Workerã‚³ãƒ¼ãƒ‰ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
        const workerCodeBase64 = '${workerBase64}';
        const workerCode = atob(workerCodeBase64);
        
        // Blob URL ã‚’ç”Ÿæˆ
        const blob = new Blob([workerCode], { 
            type: 'application/javascript' 
        });
        const workerUrl = URL.createObjectURL(blob);
        
        // GIF.js ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ Worker ã‚’ä¸Šæ›¸ã
        if (window.GIF.prototype) {
            window.GIF.prototype.options = window.GIF.prototype.options || {};
            window.GIF.prototype.options.workerScript = workerUrl;
            console.log('âœ… GIF.js Worker inlined successfully');
        }
    })();
    `;

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - atob(base64String): Base64æ–‡å­—åˆ—ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
    - new Blob(array, options): ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      - å¼•æ•°1: ãƒ‡ãƒ¼ã‚¿é…åˆ—
      - å¼•æ•°2: { type: MIMEã‚¿ã‚¤ãƒ— }
    - URL.createObjectURL(blob): Blobã‹ã‚‰URLæ–‡å­—åˆ—ã‚’ç”Ÿæˆ
      - æˆ»ã‚Šå€¤: 'blob:...' å½¢å¼ã®URL
    
  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - IIFEï¼ˆå³æ™‚å®Ÿè¡Œé–¢æ•°å¼ï¼‰ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã‚¹ã‚³ãƒ¼ãƒ—ã‚’åˆ†é›¢
    - Blob URLã‚’ä½¿ã†ã“ã¨ã§CSPã® worker-src åˆ¶ç´„ã‚’å›é¿

ã€æ‰‹é †2-5ã€‘ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å…¬é–‹

  build.js ã«è¿½åŠ :

    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    output += `
    // ========== Global Exports ==========
    (function() {
        'use strict';
        
        if (typeof window !== 'undefined') {
            // UPNG.js ã®å…¬é–‹
            if (typeof UPNG !== 'undefined') {
                window.UPNG = UPNG;
            }
            
            // pako.js ã®å…¬é–‹
            if (typeof pako !== 'undefined') {
                window.pako = pako;
                window.Zlib = pako;  // UPNG.jsãŒæœŸå¾…ã™ã‚‹åå‰
            }
            
            // GIF.js ã®å…¬é–‹
            if (typeof GIF !== 'undefined') {
                window.GIF = GIF;
            }
            
            console.log('âœ… Libraries exposed to window:', {
                UPNG: !!window.UPNG,
                pako: !!window.pako,
                Zlib: !!window.Zlib,
                GIF: !!window.GIF
            });
        }
    })();
    `;

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - typeof variable: å¤‰æ•°ã®å‹ã‚’æ–‡å­—åˆ—ã§è¿”ã™
      - æœªå®šç¾©ã®å ´åˆ: 'undefined'
    - !!value: äºŒé‡å¦å®šã§çœŸå½å€¤ã«å¤‰æ›
      - å­˜åœ¨ãƒã‚§ãƒƒã‚¯ç”¨

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - window.Zlib = pako ã®è¨­å®šãŒå¿…é ˆ
    - UPNG.jsã¯å†…éƒ¨ã§ window.Zlib.deflate() ã‚’å‘¼ã³å‡ºã™ãŸã‚

ã€æ‰‹é †2-6ã€‘ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›

  build.js ã«è¿½åŠ :

    // dist ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    const distDir = path.join(__dirname, 'dist');
    if (!fs.existsSync(distDir)) {
        fs.mkdirSync(distDir, { recursive: true });
        console.log('ğŸ“ Created dist/ directory');
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
    const outputPath = path.join(distDir, 'tegaki_anime.js');
    fs.writeFileSync(outputPath, output, 'utf8');

    // çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
    const stats = fs.statSync(outputPath);
    console.log('âœ… Build complete!');
    console.log(`ğŸ“„ Output: ${outputPath}`);
    console.log(`ğŸ“¦ Size: ${(stats.size / 1024).toFixed(2)} KB`);
    console.log(`ğŸ“¦ Lines: ${output.split('\n').length}`);

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - fs.existsSync(path): ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
    - fs.mkdirSync(path, options): ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
      - { recursive: true }: è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚è‡ªå‹•ä½œæˆ
    - fs.writeFileSync(path, data, encoding): ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
    - fs.statSync(path): ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®å–å¾—
      - æˆ»ã‚Šå€¤.size: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆãƒã‚¤ãƒˆï¼‰

ã€æ‰‹é †2-7ã€‘ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ

  ã‚³ãƒãƒ³ãƒ‰:
    npm run build

  æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
    ğŸ”¨ Building tegaki_anime.js with inline Worker...
    ğŸ“¦ Reading: libs/upng.js
    ğŸ“¦ Reading: libs/pako.js
    ğŸ“¦ Reading: libs/gif.js
    ğŸ”§ Encoding gif.worker.js to Base64...
    âœ“ Worker size: 10234 bytes
    âœ“ Base64 size: 13648 bytes
    ğŸ“ Created dist/ directory
    âœ… Build complete!
    ğŸ“„ Output: /path/to/dist/tegaki_anime.js
    ğŸ“¦ Size: 145.23 KB
    ğŸ“¦ Lines: 3542

  ç¢ºèª:
    ls -lh dist/
    # å‡ºåŠ›: tegaki_anime.js (ç´„145KB)

â–  ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
  âœ“ build.jsãŒä½œæˆã•ã‚Œã€npm run buildã§å®Ÿè¡Œã§ãã‚‹
  âœ“ dist/tegaki_anime.jsãŒç”Ÿæˆã•ã‚Œã‚‹
  âœ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ100KBä»¥ä¸Šã‚ã‚‹ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒçµ±åˆã•ã‚Œã¦ã„ã‚‹è¨¼æ‹ ï¼‰
  âœ“ ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«Base64æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ï¼ˆWorkeråŸ‹ã‚è¾¼ã¿ç¢ºèªï¼‰

================================================================================
Phase 3: ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£…
================================================================================

â–  ç›®çš„
  - TegakiAnimeCoreã‚¯ãƒ©ã‚¹ã®å®Ÿè£…
  - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æç”»æ©Ÿèƒ½
  - APNG/GIFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½

â–  ä½œæ¥­ãƒ•ã‚¡ã‚¤ãƒ«
  ã€æ–°è¦ä½œæˆã€‘
    - src/tegaki_anime_core.js

â–  å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«
  - tegaki_basic.jsï¼ˆé™æ­¢ç”»ç‰ˆã‚³ã‚¢ï¼‰
  - tegaki_anime.jsï¼ˆæ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ç‰ˆãƒ»ä¿®æ­£å‰ï¼‰

â–  å‡¦ç†ãƒ•ãƒ­ãƒ¼
  [TegakiAnimeCore ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–]
    â†“
  UIã®æ§‹ç¯‰ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã€ã‚µãƒ ãƒã‚¤ãƒ«ï¼‰
    â†“
  ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆæç”»ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿ï¼‰
    â†“
  æç”»å‡¦ç†ï¼ˆå„ãƒ•ãƒ¬ãƒ¼ãƒ ã«ä¿å­˜ï¼‰
    â†“
  ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆAPNG/GIFç”Ÿæˆï¼‰

â–  ã‚¯ãƒ©ã‚¹è¨­è¨ˆ

  class TegakiAnimeCore {
    constructor(container)          // åˆæœŸåŒ–
    init()                          // å†…éƒ¨åˆæœŸåŒ–å‡¦ç†
    createUI()                      // UIè¦ç´ ã®ç”Ÿæˆ
    setupCanvas()                   // Canvasè¨­å®š
    initLayersAndHistory()          // ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»å±¥æ­´ã®åˆæœŸåŒ–
    attachEvents()                  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    
    // æç”»é–¢é€£
    startDrawing(e)                 // æç”»é–‹å§‹
    draw(e)                         // æç”»å‡¦ç†
    stopDrawing()                   // æç”»çµ‚äº†
    
    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
    switchLayer(index)              // ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿
    updateThumbnail()               // ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
    
    // Undo/Redo
    pushHistory()                   // å±¥æ­´ã«è¿½åŠ 
    undo()                          // å…ƒã«æˆ»ã™
    redo()                          // ã‚„ã‚Šç›´ã—
    handleKeyDown(e)                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    prepareExport()                 // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‰å‡¦ç†
    exportAsApng()                  // APNGç”Ÿæˆ
    exportAsGif(onProgress)         // GIFç”Ÿæˆ
    
    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    destroy()                       // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç ´æ£„
  }

â–  å®Ÿè£…æ‰‹é †

ã€æ‰‹é †3-1ã€‘æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ã¨é…ç½®

  ã‚³ãƒãƒ³ãƒ‰:
    cp ../docs/tegaki_anime.js src/tegaki_anime_core.js

  ç·¨é›†:
    - ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã€IIFEæ§‹é€ ã‚’ç¢ºèª
    - æœ€çµ‚çš„ã«build.jsã§çµåˆã™ã‚‹ãŸã‚ã€IIFEã¯ç¶­æŒ

ã€æ‰‹é †3-2ã€‘ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å®šç¾©

  ãƒ•ã‚¡ã‚¤ãƒ«: src/tegaki_anime_core.js
  
  è©²å½“éƒ¨åˆ†ï¼ˆ11è¡Œç›®ã€œ45è¡Œç›®ä»˜è¿‘ï¼‰:

    window.TegakiAnimeCore = class TegakiAnimeCore {
        constructor(container) {
            // DOMè¦ç´ 
            this.container = container;
            this.wrapper = null;
            this.canvas = null;              // æç”»ç”¨ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹
            this.ctx = null;                 // æç”»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            this.bgCanvas = null;            // èƒŒæ™¯è¡¨ç¤ºç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹
            
            // æç”»çŠ¶æ…‹
            this.isDrawing = false;
            this.lastX = 0;
            this.lastY = 0;
            
            // å›ºå®šãƒ„ãƒ¼ãƒ«è¨­å®š
            this.color = '#800000';          // ãµãŸã° maroon
            this.size = 2;                   // ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚º
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
            this.frameCount = 5;             // ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
            this.frameDelay = 200;           // ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰
            this.layers = [];                // ImageDataé…åˆ—
            this.thumbnailContainer = null;  // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºé ˜åŸŸ
            this.activeLayerIndex = 0;       // ç¾åœ¨ç·¨é›†ä¸­ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼
            
            // Undo/Redoå±¥æ­´
            this.history = [];               // [layer0: [state0, state1, ...], layer1: [...]]
            this.historyIndex = [];          // [layer0: index, layer1: index, ...]
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ä¿æŒï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–ï¼‰
            this.boundHandleKeyDown = this.handleKeyDown.bind(this);
            
            this.init();
        }
    }

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - this.layers: å„ãƒ•ãƒ¬ãƒ¼ãƒ ã®æç”»å†…å®¹ã‚’ImageDataã§ä¿æŒ
    - this.history: 2æ¬¡å…ƒé…åˆ—ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®Undoã‚¹ã‚¿ãƒƒã‚¯ã‚’ç®¡ç†
    - this.boundHandleKeyDown: bind()ã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿æŒã—ã¦removeEventListenerã§ä½¿ç”¨

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - Function.prototype.bind(thisArg): ãƒ¡ã‚½ãƒƒãƒ‰ã®thisã‚’å›ºå®š
      - æˆ»ã‚Šå€¤: æ–°ã—ã„é–¢æ•°ï¼ˆthisãŒæŸç¸›æ¸ˆã¿ï¼‰

ã€æ‰‹é †3-3ã€‘UIç”Ÿæˆï¼ˆcreateUIï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 52è¡Œç›®ã€œ135è¡Œç›®ä»˜è¿‘ï¼‰:

    createUI() {
        // ãƒ©ãƒƒãƒ‘ãƒ¼ä½œæˆ
        this.wrapper = document.createElement('div');
        this.wrapper.style.cssText = `
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background: #ffffee;
            padding: 10px 0 20px 0;
        `;
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ä½œæˆ
        const canvasArea = document.createElement('div');
        canvasArea.style.cssText = `
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        `;
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚³ãƒ³ãƒ†ãƒŠï¼ˆèƒŒæ™¯+æç”»ã®2å±¤æ§‹é€ ï¼‰
        const canvasContainer = document.createElement('div');
        canvasContainer.style.cssText = `
            position: relative;
            width: 400px;
            height: 400px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        `;
        
        // èƒŒæ™¯ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼0ï¼‰
        this.bgCanvas = document.createElement('canvas');
        this.bgCanvas.width = 400;
        this.bgCanvas.height = 400;
        const bgCtx = this.bgCanvas.getContext('2d');
        bgCtx.fillStyle = '#f0e0d6';
        bgCtx.fillRect(0, 0, 400, 400);
        this.bgCanvas.style.cssText = `
            position: absolute; 
            top: 0; 
            left: 0;
        `;
        
        // æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼1ãƒ»é€æ˜ï¼‰
        this.canvas = document.createElement('canvas');
        this.canvas.width = 400;
        this.canvas.height = 400;
        this.canvas.style.cssText = `
            position: absolute; 
            top: 0; 
            left: 0; 
            cursor: crosshair;
        `;
        
        // çµ„ã¿ç«‹ã¦
        canvasContainer.appendChild(this.bgCanvas);
        canvasContainer.appendChild(this.canvas);
        canvasArea.appendChild(canvasContainer);
        
        // ã‚µãƒ ãƒã‚¤ãƒ«ã‚¨ãƒªã‚¢ä½œæˆ
        this.thumbnailContainer = document.createElement('div');
        this.thumbnailContainer.style.cssText = `
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 5px 0;
        `;
        
        // ã‚µãƒ ãƒã‚¤ãƒ«å€‹åˆ¥ä½œæˆï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ æ•°åˆ†ï¼‰
        for (let i = 0; i < this.frameCount; i++) {
            const thumb = document.createElement('canvas');
            thumb.width = 60;
            thumb.height = 60;
            thumb.style.cssText = `
                border: 3px solid #aa5a56;
                border-radius: 2px;
                background: #f0e0d6;
                cursor: pointer;
                transition: all 0.2s;
            `;
            thumb.title = `ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i + 1}`;
            thumb.onclick = () => this.switchLayer(i);
            this.thumbnailContainer.appendChild(thumb);
        }
        
        // DOMã«è¿½åŠ 
        this.wrapper.appendChild(canvasArea);
        this.wrapper.appendChild(this.thumbnailContainer);
        this.container.appendChild(this.wrapper);
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - document.createElement(tagName): HTMLè¦ç´ ã‚’ä½œæˆ
    - element.style.cssText: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸€æ‹¬è¨­å®š
    - element.appendChild(child): å­è¦ç´ ã‚’è¿½åŠ 
    - canvas.getContext('2d'): 2Dæç”»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
    - ctx.fillRect(x, y, width, height): çŸ©å½¢ã‚’å¡—ã‚Šã¤ã¶ã—

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - 2å±¤æ§‹é€ ï¼ˆèƒŒæ™¯+æç”»ï¼‰ã«ã‚ˆã‚Šã€èƒŒæ™¯ã‚’æ¶ˆã•ãšã«é€æ˜ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§æç”»
    - position: absolute ã§é‡ã­åˆã‚ã›
    - ã‚µãƒ ãƒã‚¤ãƒ«ã¯ Canvas2D

ã€æ‰‹é †3-4ã€‘ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®šï¼ˆsetupCanvasï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 140è¡Œç›®ã€œ147è¡Œç›®ä»˜è¿‘ï¼‰:

    setupCanvas() {
        this.ctx = this.canvas.getContext('2d');
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.strokeStyle = this.color;
        this.ctx.lineWidth = this.size;
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - canvas.getContext('2d'): CanvasRenderingContext2D ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
    - ctx.lineCap: ç·šã®ç«¯ã®å½¢çŠ¶ï¼ˆ'butt' | 'round' | 'square'ï¼‰
    - ctx.lineJoin: ç·šã®æ¥åˆéƒ¨ã®å½¢çŠ¶ï¼ˆ'round' | 'bevel' | 'miter'ï¼‰
    - ctx.strokeStyle: ç·šã®è‰²ï¼ˆCSSè‰²æ–‡å­—åˆ—ï¼‰
    - ctx.lineWidth: ç·šã®å¤ªã•ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - lineCap/lineJoin ã‚’ 'round' ã«ã™ã‚‹ã“ã¨ã§æ»‘ã‚‰ã‹ãªç·šã‚’æç”»
    - åˆæœŸå€¤ã¨ã—ã¦ color ã¨ size ã‚’è¨­å®š

ã€æ‰‹é †3-5ã€‘ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨å±¥æ­´ã®åˆæœŸåŒ–ï¼ˆinitLayersAndHistoryï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 150è¡Œç›®ã€œ157è¡Œç›®ä»˜è¿‘ï¼‰:

    initLayersAndHistory() {
        for (let i = 0; i < this.frameCount; i++) {
            // é€æ˜ãª ImageData ã‚’ä½œæˆ
            const initialImageData = this.ctx.createImageData(
                this.canvas.width, 
                this.canvas.height
            );
            
            this.layers.push(initialImageData);
            this.history.push([initialImageData]);  // å±¥æ­´ã®æœ€åˆã«è¿½åŠ 
            this.historyIndex.push(0);
        }
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - ctx.createImageData(width, height): ç©ºã® ImageData ã‚’ä½œæˆ
      - æˆ»ã‚Šå€¤: ImageData ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        - .data: Uint8ClampedArrayï¼ˆRGBAå€¤ã®é…åˆ—ï¼‰
        - .width: å¹…
        - .height: é«˜ã•

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - ImageData ã¯ Canvas ã®ç”Ÿãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    - å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«ç‹¬ç«‹ã—ãŸå±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒã¤
    - åˆæœŸçŠ¶æ…‹ï¼ˆç©ºã® ImageDataï¼‰ã‚’å±¥æ­´ã®æœ€åˆã«è¿½åŠ 

ã€æ‰‹é †3-6ã€‘ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆattachEventsï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 162è¡Œç›®ã€œ197è¡Œç›®ä»˜è¿‘ï¼‰:

    attachEvents() {
        // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', () => this.stopDrawing());
        this.canvas.addEventListener('mouseleave', () => this.stopDrawing());
        
        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
        this.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            this.canvas.dispatchEvent(mouseEvent);
        });
        
        this.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            this.canvas.dispatchEvent(mouseEvent);
        });
        
        this.canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            const mouseEvent = new MouseEvent('mouseup', {});
            this.canvas.dispatchEvent(mouseEvent);
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆUndo/Redoï¼‰
        document.addEventListener('keydown', this.boundHandleKeyDown);
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - element.addEventListener(type, listener): ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
      - å¼•æ•°1: ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆ'mousedown', 'touchstart' ãªã©ï¼‰
      - å¼•æ•°2: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
    - Event.preventDefault(): ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    - TouchEvent.touches: ã‚¿ãƒƒãƒãƒã‚¤ãƒ³ãƒˆã®é…åˆ—
      - touches[0]: æœ€åˆã®ã‚¿ãƒƒãƒãƒã‚¤ãƒ³ãƒˆ
    - new MouseEvent(type, options): ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”Ÿæˆ
    - element.dispatchEvent(event): ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã«å¤‰æ›ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’å…±é€šåŒ–
    - preventDefault() ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
    - boundHandleKeyDown ã‚’ä½¿ç”¨ï¼ˆå¾Œã§ removeEventListener ã™ã‚‹ãŸã‚ï¼‰

ã€æ‰‹é †3-7ã€‘æç”»å‡¦ç†ï¼ˆstartDrawing / draw / stopDrawingï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 202è¡Œç›®ã€œ237è¡Œç›®ä»˜è¿‘ï¼‰:

    startDrawing(e) {
        this.isDrawing = true;
        const rect = this.canvas.getBoundingClientRect();
        this.lastX = e.clientX - rect.left;
        this.lastY = e.clientY - rect.top;
    }
    
    draw(e) {
        if (!this.isDrawing) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        this.ctx.beginPath();
        this.ctx.moveTo(this.lastX, this.lastY);
        this.ctx.lineTo(x, y);
        this.ctx.stroke();
        
        this.lastX = x;
        this.lastY = y;
    }
    
    stopDrawing() {
        if (!this.isDrawing) return;
        this.isDrawing = false;
        this.ctx.beginPath();
        this.pushHistory();
        this.updateThumbnail();
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - element.getBoundingClientRect(): è¦ç´ ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’å–å¾—
      - æˆ»ã‚Šå€¤: DOMRect { left, top, width, height, ... }
    - MouseEvent.clientX/clientY: ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆåº§æ¨™
    - ctx.beginPath(): æ–°ã—ã„ãƒ‘ã‚¹ã‚’é–‹å§‹
    - ctx.moveTo(x, y): ãƒ‘ã‚¹ã®é–‹å§‹ä½ç½®ã‚’è¨­å®š
    - ctx.lineTo(x, y): ç¾åœ¨ä½ç½®ã‹ã‚‰æŒ‡å®šä½ç½®ã¾ã§ç·šã‚’æç”»
    - ctx.stroke(): ç¾åœ¨ã®ãƒ‘ã‚¹ã‚’æç”»

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - getBoundingClientRect() ã§ Canvas ã®ç”»é¢ä¸Šã®ä½ç½®ã‚’å–å¾—
    - clientX/Y ã‹ã‚‰ rect.left/top ã‚’å¼•ã„ã¦ Canvas å†…ã®åº§æ¨™ã«å¤‰æ›
    - lastX/Y ã‚’ä¿æŒã—ã¦é€£ç¶šã—ãŸç·šã‚’æç”»
    - stopDrawing() ã§å±¥æ­´ä¿å­˜ã¨ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°

ã€æ‰‹é †3-8ã€‘ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ï¼ˆswitchLayer / updateThumbnailï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 242è¡Œç›®ã€œ274è¡Œç›®ä»˜è¿‘ï¼‰:

    switchLayer(index) {
        if (index === this.activeLayerIndex) return;
        
        // ç¾åœ¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æç”»å†…å®¹ã‚’ä¿å­˜
        this.layers[this.activeLayerIndex] = this.ctx.getImageData(
            0, 0, 
            this.canvas.width, 
            this.canvas.height
        );
        
        // æ–°ã—ã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
        this.activeLayerIndex = index;
        this.ctx.putImageData(this.layers[index], 0, 0);
        
        // ã‚µãƒ ãƒã‚¤ãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ›´æ–°
        this.thumbnailContainer.childNodes.forEach((thumb, i) => {
            thumb.style.borderColor = (i === index) ? '#800000' : '#aa5a56';
            thumb.style.transform = (i === index) ? 'scale(1.1)' : 'scale(1)';
        });
    }
    
    updateThumbnail() {
        const thumbCanvas = this.thumbnailContainer.childNodes[this.activeLayerIndex];
        if (!thumbCanvas) return;
        const thumbCtx = thumbCanvas.getContext('2d');
        thumbCtx.clearRect(0, 0, thumbCanvas.width, thumbCanvas.height);

        // ã‚µãƒ ãƒã‚¤ãƒ«ã«ã¯èƒŒæ™¯ã‚‚åˆæˆã—ã¦è¡¨ç¤º
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = this.canvas.width;
        tempCanvas.height = this.canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(this.bgCanvas, 0, 0);
        tempCtx.drawImage(this.canvas, 0, 0);
        
        thumbCtx.drawImage(
            tempCanvas, 
            0, 0, 
            thumbCanvas.width, 
            thumbCanvas.height
        );
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - ctx.getImageData(x, y, width, height): Canvas ã‹ã‚‰ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      - æˆ»ã‚Šå€¤: ImageData ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    - ctx.putImageData(imageData, x, y): ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ Canvas ã«æç”»
    - ctx.clearRect(x, y, width, height): æŒ‡å®šé ˜åŸŸã‚’ã‚¯ãƒªã‚¢
    - ctx.drawImage(source, dx, dy): ç”»åƒã‚’æç”»
    - ctx.drawImage(source, dx, dy, dWidth, dHeight): ãƒªã‚µã‚¤ã‚ºã—ã¦æç”»

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - switchLayer() ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã®åˆ‡ã‚Šæ›¿ãˆæ™‚ã« ImageData ã‚’ä¿å­˜/å¾©å…ƒ
    - updateThumbnail() ã§èƒŒæ™¯ã¨æç”»ã‚’åˆæˆã—ãŸçŠ¶æ…‹ã§ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
    - ä¸€æ™‚çš„ãª tempCanvas ã‚’ä½¿ã£ã¦åˆæˆï¼ˆå…ƒã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’æ±šã•ãªã„ï¼‰

ã€æ‰‹é †3-9ã€‘Undo/Redo æ©Ÿèƒ½ï¼ˆpushHistory / undo / redo / handleKeyDownï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 279è¡Œç›®ã€œ318è¡Œç›®ä»˜è¿‘ï¼‰:

    handleKeyDown(e) {
        // UIãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å‡¦ç†ã—ãªã„ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–ï¼‰
        if (!this.wrapper || !this.wrapper.isConnected) return;
        
        if (e.ctrlKey && e.key.toLowerCase() === 'z') {
            e.preventDefault();
            this.undo();
        }
        if (e.ctrlKey && e.key.toLowerCase() === 'y') {
            e.preventDefault();
            this.redo();
        }
    }

    pushHistory() {
        const history = this.history[this.activeLayerIndex];
        let index = this.historyIndex[this.activeLayerIndex];
        
        // ç¾åœ¨ä½ç½®ã‚ˆã‚Šå¾Œã®å±¥æ­´ã‚’å‰Šé™¤ï¼ˆåˆ†å²ã‚’é˜²ãï¼‰
        if (index < history.length - 1) {
            this.history[this.activeLayerIndex] = history.slice(0, index + 1);
        }
        
        // ç¾åœ¨ã®çŠ¶æ…‹ã‚’å±¥æ­´ã«è¿½åŠ 
        const imageData = this.ctx.getImageData(
            0, 0, 
            this.canvas.width, 
            this.canvas.height
        );
        this.history[this.activeLayerIndex].push(imageData);
        this.historyIndex[this.activeLayerIndex]++;
    }

    undo() {
        let index = this.historyIndex[this.activeLayerIndex];
        if (index > 0) {
            index--;
            this.historyIndex[this.activeLayerIndex] = index;
            const imageData = this.history[this.activeLayerIndex][index];
            this.ctx.putImageData(imageData, 0, 0);
            this.updateThumbnail();
        }
    }
    
    redo() {
        const history = this.history[this.activeLayerIndex];
        let index = this.historyIndex[this.activeLayerIndex];
        if (index < history.length - 1) {
            index++;
            this.historyIndex[this.activeLayerIndex] = index;
            const imageData = this.history[this.activeLayerIndex][index];
            this.ctx.putImageData(imageData, 0, 0);
            this.updateThumbnail();
        }
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - KeyboardEvent.ctrlKey: Ctrl ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹ã‹
    - KeyboardEvent.key: æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼ã®æ–‡å­—åˆ—
    - String.toLowerCase(): å°æ–‡å­—ã«å¤‰æ›
    - Array.slice(start, end): é…åˆ—ã®ä¸€éƒ¨ã‚’å–å¾—
      - å¼•æ•°1: é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå«ã‚€ï¼‰
      - å¼•æ•°2: çµ‚äº†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå«ã¾ãªã„ï¼‰
    - Node.isConnected: ãƒãƒ¼ãƒ‰ãŒ DOM ã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«ç‹¬ç«‹ã—ãŸå±¥æ­´ã‚’ç®¡ç†
    - pushHistory() ã§åˆ†å²å±¥æ­´ã‚’å‰Šé™¤ï¼ˆãƒªãƒ‹ã‚¢å±¥æ­´ã‚’ç¶­æŒï¼‰
    - isConnected ãƒã‚§ãƒƒã‚¯ã§ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢

ã€æ‰‹é †3-10ã€‘ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‰å‡¦ç†ï¼ˆprepareExportï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 323è¡Œç›®ã€œ327è¡Œç›®ä»˜è¿‘ï¼‰:

    prepareExport() {
        // ç¾åœ¨ç·¨é›†ä¸­ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å†…å®¹ã‚’ä¿å­˜
        this.layers[this.activeLayerIndex] = this.ctx.getImageData(
            0, 0, 
            this.canvas.width, 
            this.canvas.height
        );
    }

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç›´å‰ã«ç¾åœ¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä¿å­˜
    - ã“ã‚Œã«ã‚ˆã‚Šæœªä¿å­˜ã®æç”»å†…å®¹ã‚‚ç¢ºå®Ÿã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã‚‹

ã€æ‰‹é †3-11ã€‘APNGã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆexportAsApngï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 330è¡Œç›®ã€œ358è¡Œç›®ä»˜è¿‘ï¼‰:

    async exportAsApng() {
        this.prepareExport();
        
        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å­˜åœ¨ç¢ºèª
        if (!window.UPNG || !window.Zlib) {
            alert('APNGç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª(UPNG.js/pako.js)ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return null;
        }
        
        const frames = [];
        
        // å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’èƒŒæ™¯ã¨åˆæˆã—ã¦ãƒ•ãƒ¬ãƒ¼ãƒ åŒ–
        for (const layerData of this.layers) {
            const frameCanvas = document.createElement('canvas');
            frameCanvas.width = this.canvas.width;
            frameCanvas.height = this.canvas.height;
            const frameCtx = frameCanvas.getContext('2d');
            
            // èƒŒæ™¯ã‚’æç”»
            frameCtx.drawImage(this.bgCanvas, 0, 0);
            
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é‡ã­ã‚‹
            frameCtx.putImageData(layerData, 0, 0);
            
            // ImageData ã® data ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆUint8ClampedArrayï¼‰ã‚’å–å¾—
            const imageData = frameCtx.getImageData(
                0, 0, 
                frameCanvas.width, 
                frameCanvas.height
            );
            
            // ArrayBuffer ã«å¤‰æ›ã—ã¦ frames é…åˆ—ã«è¿½åŠ 
            frames.push(imageData.data.buffer);
        }
        
        // å„ãƒ•ãƒ¬ãƒ¼ãƒ ã®è¡¨ç¤ºæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
        const delays = Array(this.frameCount).fill(this.frameDelay);
        
        // UPNG.encode ã§APNGãƒã‚¤ãƒŠãƒªã‚’ç”Ÿæˆ
        const apngData = UPNG.encode(
            frames,                    // ArrayBuffer[]
            this.canvas.width,         // å¹…
            this.canvas.height,        // é«˜ã•
            0,                         // åœ§ç¸®ãƒ¬ãƒ™ãƒ«ï¼ˆ0=ç„¡åœ§ç¸®ï¼‰
            delays                     // å„ãƒ•ãƒ¬ãƒ¼ãƒ ã®é…å»¶æ™‚é–“
        );
        
        // Blob ã«å¤‰æ›ã—ã¦è¿”ã™
        return new Blob([apngData], {type: 'image/png'});
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - UPNG.encode(frames, width, height, cnum, delays): APNGãƒã‚¤ãƒŠãƒªã‚’ç”Ÿæˆ
      - å¼•æ•°1: ArrayBuffer[] - å„ãƒ•ãƒ¬ãƒ¼ãƒ ã®RGBAãƒ‡ãƒ¼ã‚¿
      - å¼•æ•°2: å¹…ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
      - å¼•æ•°3: é«˜ã•ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
      - å¼•æ•°4: è‰²æ•°ï¼ˆ0=è‡ªå‹•ã€256=8bitï¼‰
      - å¼•æ•°5: number[] - å„ãƒ•ãƒ¬ãƒ¼ãƒ ã®é…å»¶ï¼ˆãƒŸãƒªç§’ï¼‰
      - æˆ»ã‚Šå€¤: ArrayBuffer - APNGãƒã‚¤ãƒŠãƒª
    - Array(length).fill(value): æŒ‡å®šå€¤ã§åŸ‹ã‚ãŸé…åˆ—ã‚’ç”Ÿæˆ
    - new Blob(array, options): ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      - å¼•æ•°1: ArrayBuffer ã‚„æ–‡å­—åˆ—ã®é…åˆ—
      - å¼•æ•°2: { type: MIMEã‚¿ã‚¤ãƒ— }

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - MIMEã‚¿ã‚¤ãƒ—ã¯ 'image/png' ã‚’ä½¿ç”¨ï¼ˆ'image/apng' ã§ã¯ãªã„ï¼‰
    - APNG ã¯ PNG ã®æ‹¡å¼µãªã®ã§æ¨™æº–ã® PNG MIMEã‚¿ã‚¤ãƒ—ã§æ‰±ã†
    - imageData.data.buffer ã§ Uint8ClampedArray ã‹ã‚‰ ArrayBuffer ã‚’å–å¾—

ã€æ‰‹é †3-12ã€‘GIFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆexportAsGifï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 361è¡Œç›®ã€œ410è¡Œç›®ä»˜è¿‘ï¼‰:

    async exportAsGif(onProgress) {
        this.prepareExport();
        
        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å­˜åœ¨ç¢ºèª
        if (!window.GIF) {
            alert('GIFç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return null;
        }

        return new Promise((resolve) => {
            // GIF.js ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
            const gif = new GIF({
                workers: 2,            // Workeræ•°
                quality: 10,           // å“è³ªï¼ˆ1-30ã€ä½ã„ã»ã©é«˜å“è³ªï¼‰
                width: this.canvas.width,
                height: this.canvas.height
            });
            
            // é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç™»éŒ²
            if (onProgress && typeof onProgress === 'function') {
                gif.on('progress', onProgress);
            }

            // å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’èƒŒæ™¯ã¨åˆæˆã—ã¦ãƒ•ãƒ¬ãƒ¼ãƒ è¿½åŠ 
            for (const layerData of this.layers) {
                const frameCanvas = document.createElement('canvas');
                frameCanvas.width = this.canvas.width;
                frameCanvas.height = this.canvas.height;
                const frameCtx = frameCanvas.getContext('2d');
                
                // èƒŒæ™¯ã‚’æç”»
                frameCtx.drawImage(this.bgCanvas, 0, 0);
                
                // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é‡ã­ã‚‹
                frameCtx.putImageData(layerData, 0, 0);
                
                // GIF ã«ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¿½åŠ 
                gif.addFrame(frameCanvas, { 
                    delay: this.frameDelay 
                });
            }

            // ç”Ÿæˆå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆ
            gif.on('finished', (blob) => {
                // é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è§£é™¤ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–ï¼‰
                if (onProgress) {
                    gif.off('progress', onProgress);
                }
                resolve(blob);
            });
            
            // GIFç”Ÿæˆã‚’é–‹å§‹
            gif.render();
        });
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - new GIF(options): GIF.js ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
      - options.workers: ä½¿ç”¨ã™ã‚‹Workeræ•°
      - options.quality: ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å“è³ªï¼ˆ1-30ï¼‰
      - options.width/height: GIFã‚µã‚¤ã‚º
    - gif.addFrame(canvas, options): ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¿½åŠ 
      - å¼•æ•°1: Canvasè¦ç´  ã¾ãŸã¯ ImageData
      - å¼•æ•°2: { delay: ãƒŸãƒªç§’, copy: boolean }
    - gif.on(event, callback): ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
      - 'progress': é€²æ—æ›´æ–°ï¼ˆå¼•æ•°: 0.0-1.0ï¼‰
      - 'finished': ç”Ÿæˆå®Œäº†ï¼ˆå¼•æ•°: Blobï¼‰
    - gif.off(event, callback): ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è§£é™¤
    - gif.render(): GIFç”Ÿæˆã‚’é–‹å§‹
    - new Promise(executor): Promise ã‚’ä½œæˆ
      - executor: (resolve, reject) => void

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - éåŒæœŸå‡¦ç†ã®ãŸã‚ Promise ã§ãƒ©ãƒƒãƒ—
    - Worker ãŒå†…éƒ¨ã§å‹•ä½œï¼ˆbuild.js ã§åŸ‹ã‚è¾¼ã¿æ¸ˆã¿ï¼‰
    - é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ UI æ›´æ–°ãŒå¯èƒ½
    - gif.off() ã§ãƒªã‚¹ãƒŠãƒ¼è§£é™¤ã—ã¦ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢

ã€æ‰‹é †3-13ã€‘ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆdestroyï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆsrc/tegaki_anime_core.js 415è¡Œç›®ã€œ424è¡Œç›®ä»˜è¿‘ï¼‰:

    destroy() {
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–ï¼‰
        document.removeEventListener('keydown', this.boundHandleKeyDown);
        
        // DOMè¦ç´ ã‚’å‰Šé™¤
        if (this.wrapper && this.wrapper.parentNode) {
            this.wrapper.remove();
        }
        
        // å‚ç…§ã‚’ã‚¯ãƒªã‚¢
        this.canvas = null;
        this.ctx = null;
        this.bgCanvas = null;
        this.layers = null;
        this.history = null;
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - element.removeEventListener(type, listener): ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
    - Node.parentNode: è¦ªãƒãƒ¼ãƒ‰ã‚’å–å¾—
    - Node.remove(): DOMã‹ã‚‰è‡ªèº«ã‚’å‰Šé™¤

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - removeEventListener ã«ã¯ addEventListener ã¨åŒã˜é–¢æ•°ã‚’æ¸¡ã™å¿…è¦
    - ãã®ãŸã‚ boundHandleKeyDown ã‚’ä½¿ç”¨
    - å‚ç…§ã‚’ null ã«ã—ã¦ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿ƒé€²

ã€æ‰‹é †3-14ã€‘build.js ã«ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 

  ãƒ•ã‚¡ã‚¤ãƒ«: build.js
  
  è©²å½“éƒ¨åˆ†ã®ä¿®æ­£ï¼ˆlibraryFiles é…åˆ—ã«è¿½åŠ ï¼‰:

    const libraryFiles = [
        'libs/upng.js',
        'libs/pako.js',
        'libs/gif.js',
        'src/tegaki_anime_core.js'  // â† è¿½åŠ 
    ];

  ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚çµ±åˆã•ã‚Œã‚‹ã€‚

ã€æ‰‹é †3-15ã€‘ãƒ“ãƒ«ãƒ‰ã¨å‹•ä½œç¢ºèª

  ã‚³ãƒãƒ³ãƒ‰:
    npm run build

  ç¢ºèª:
    cat dist/tegaki_anime.js | grep "TegakiAnimeCore"
    # å‡ºåŠ›: window.TegakiAnimeCore = class TegakiAnimeCore { ãŒè¦‹ã¤ã‹ã‚Œã°OK

â–  ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
  âœ“ src/tegaki_anime_core.js ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
  âœ“ TegakiAnimeCore ã‚¯ãƒ©ã‚¹ãŒã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹
  âœ“ build.js ã« src/tegaki_anime_core.js ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
  âœ“ npm run build ã§ dist/tegaki_anime.js ã«ã‚¯ãƒ©ã‚¹ãŒå«ã¾ã‚Œã‚‹
  âœ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ 150KB ä»¥ä¸Šã‚ã‚‹

================================================================================
Phase 4: ãƒ­ãƒ¼ãƒ€ãƒ¼å®Ÿè£…
================================================================================

â–  ç›®çš„
  - ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ä¸Šã§å‹•ä½œã™ã‚‹ãƒ­ãƒ¼ãƒ€ãƒ¼å®Ÿè£…
  - çµ±åˆæ¸ˆã¿ tegaki_anime.js ã®èª­ã¿è¾¼ã¿
  - UIè¡¨ç¤ºã¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†

â–  ä½œæ¥­ãƒ•ã‚¡ã‚¤ãƒ«
  ã€ä¿®æ­£ã€‘
    - tegaki-loader_anime.js

â–  å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«
  - tegaki-loader_basic.jsï¼ˆé™æ­¢ç”»ç‰ˆãƒ­ãƒ¼ãƒ€ãƒ¼ï¼‰

â–  å‡¦ç†ãƒ•ãƒ­ãƒ¼
  [ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå®Ÿè¡Œ]
    â†“
  window.tegakiAnimeStart() å‘¼ã³å‡ºã—
    â†“
  TegakiLoaderAnime.start()
    â†“
  æ²ç¤ºæ¿åˆ¤å®š â†’ è¦ç´ æ¤œå‡º
    â†“
  tegaki_anime.js ã‚’èª­ã¿è¾¼ã¿
    â†“
  TegakiAnimeCore ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    â†“
  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæç”»
    â†“
  exportAndAttach() ã§Blobç”Ÿæˆ
    â†“
  injectToBoard() ã§ãƒ•ã‚©ãƒ¼ãƒ ã«æ³¨å…¥

â–  ã‚¯ãƒ©ã‚¹è¨­è¨ˆ

  class TegakiLoaderAnime {
    constructor()                       // åˆæœŸåŒ–
    start()                             // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
    detectBoard()                       // æ²ç¤ºæ¿åˆ¤å®š
    findTargetElements()                // è¦ç´ æ¤œå‡º
    createUI()                          // UIä½œæˆ
    exportAndAttach(type)               // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ+æ·»ä»˜
    injectToBoard(blob, type)           // ãƒ•ã‚©ãƒ¼ãƒ ã«æ³¨å…¥
    cancel()                            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    cleanup()                           // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    wait(ms)                            // å¾…æ©Ÿ
    waitFor(condition, timeout)         // æ¡ä»¶å¾…æ©Ÿ
  }

â–  å®Ÿè£…æ‰‹é †

ã€æ‰‹é †4-1ã€‘æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼

  ã‚³ãƒãƒ³ãƒ‰:
    # æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚³ãƒ”ãƒ¼
    cp ../docs/tegaki-loader_anime.js ./

  ç·¨é›†æ–¹é‡:
    - åŸºæœ¬æ§‹é€ ã¯ãã®ã¾ã¾ï¼ˆå‹•ä½œå®Ÿç¸¾ã‚ã‚Šï¼‰
    - SCRIPT_URLS ã‚’ä¿®æ­£
    - APNG ã® MIMEã‚¿ã‚¤ãƒ—ã‚’ä¿®æ­£

ã€æ‰‹é †4-2ã€‘SCRIPT_URLS ã®ä¿®æ­£

  ãƒ•ã‚¡ã‚¤ãƒ«: tegaki-loader_anime.js
  
  è©²å½“éƒ¨åˆ†ï¼ˆ17è¡Œç›®ã€œ24è¡Œç›®ä»˜è¿‘ï¼‰:

  ä¿®æ­£å‰:
    const SCRIPT_URLS = {
        tegaki: 'https://cdn.jsdelivr.net/gh/toshinka/tegaki/docs/tegaki_anime.js',
        upng: 'https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js',
        pako: 'https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js',
        gif: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js',
        gifWorker: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
    };

  ä¿®æ­£å¾Œ:
    const SCRIPT_URLS = {
        // çµ±åˆæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿èª­ã¿è¾¼ã‚€ï¼ˆä»–ã¯ä¸è¦ï¼‰
        tegaki: 'https://toshinka.github.io/tegaki/tegaki_anime_test/dist/tegaki_anime.js'
    };

  ç†ç”±:
    - çµ±åˆãƒ“ãƒ«ãƒ‰ã«ã‚ˆã‚Šã€UPNG/pako/GIF.js ã¯ tegaki_anime.js ã«å«ã¾ã‚Œã‚‹
    - å¤–éƒ¨CDNã¸ã®ä¾å­˜ã‚’ã™ã¹ã¦æ’é™¤

ã€æ‰‹é †4-3ã€‘start() ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£

  ãƒ•ã‚¡ã‚¤ãƒ«: tegaki-loader_anime.js
  
  è©²å½“éƒ¨åˆ†ï¼ˆ92è¡Œç›®ã€œ143è¡Œç›®ä»˜è¿‘ï¼‰:

  ä¿®æ­£å‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿éƒ¨åˆ†:
    await Promise.all([
        loadScript(SCRIPT_URLS.upng),
        loadScript(SCRIPT_URLS.pako),
        loadScript(SCRIPT_URLS.gif),
        loadScript(SCRIPT_URLS.tegaki)
    ]);

  ä¿®æ­£å¾Œ:
    // çµ±åˆæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿èª­ã¿è¾¼ã¿
    await loadScript(SCRIPT_URLS.tegaki);

  ä¿®æ­£å‰ã®Workerè¨­å®šéƒ¨åˆ†ã‚’å‰Šé™¤:
    if (window.GIF && window.GIF.prototype) {
        if (typeof window.GIF.prototype.options === 'undefined') {
            window.GIF.prototype.options = {};
        }
        window.GIF.prototype.options.workerScript = SCRIPT_URLS.gifWorker;
    }

  ç†ç”±:
    - Worker ã¯ build.js ã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–æ¸ˆã¿
    - å¤–éƒ¨URLã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒãªã„

ã€æ‰‹é †4-4ã€‘injectToBoard() ã® MIMEã‚¿ã‚¤ãƒ—ä¿®æ­£

  ãƒ•ã‚¡ã‚¤ãƒ«: tegaki-loader_anime.js
  
  è©²å½“éƒ¨åˆ†ï¼ˆ267è¡Œç›®ã€œ284è¡Œç›®ä»˜è¿‘ï¼‰:

  ä¿®æ­£å‰:
    const mimeType = type === 'apng' ? 'image/apng' : 'image/gif';
    const filename = `tegaki_anime_${Date.now()}.${type}`;

  ä¿®æ­£å¾Œ:
    // APNG ã¯æ¨™æº–ã® image/png ã‚’ä½¿ç”¨
    const mimeType = type === 'apng' ? 'image/png' : 'image/gif';
    
    // æ‹¡å¼µå­ã‚‚ .png ã«çµ±ä¸€
    const ext = type === 'apng' ? 'png' : 'gif';
    const filename = `tegaki_anime_${Date.now()}.${ext}`;

  ç†ç”±:
    - APNG ã¯ PNG ã®æ‹¡å¼µãªã®ã§ 'image/png' ãŒæ­£ã—ã„
    - ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ã¯ 'image/apng' ã‚’å—ã‘ä»˜ã‘ãªã„å¯èƒ½æ€§

ã€æ‰‹é †4-5ã€‘é€²æ—è¡¨ç¤ºã®æ”¹å–„ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ç¢ºèªï¼‰

  è©²å½“éƒ¨åˆ†ï¼ˆ207è¡Œç›®ã€œ240è¡Œç›®ä»˜è¿‘ï¼‰:

  æ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ä¸è¦ï¼‰:
    async exportAndAttach(type) {
        if (!this.core) {
            alert('ãŠçµµã‹ããƒ„ãƒ¼ãƒ«ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
        }
        
        try {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            this.loadingEl = this.loadingEl || document.createElement('div');
            this.loadingEl.textContent = `${type.toUpperCase()}ã‚’ç”Ÿæˆä¸­...`;
            this.loadingEl.style.cssText = '...';
            document.body.appendChild(this.loadingEl);

            let blob;
            
            const progressCallback = (p) => {
                const percent = Math.floor(p * 100);
                this.loadingEl.textContent = `${type.toUpperCase()}ã‚’ç”Ÿæˆä¸­... (${percent}%)`;
            };

            if (type === 'apng') {
                blob = await this.core.exportAsApng();
} else if (type === 'gif') {
                // GIFç”Ÿæˆæ™‚ã«é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ¸¡ã™
                blob = await this.core.exportAsGif(progressCallback);
            } else {
                throw new Error('ç„¡åŠ¹ãªã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã§ã™ã€‚');
            }
            
            this.loadingEl.remove();

            if (!blob) {
                alert(`${type.toUpperCase()}ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
                return;
            }
            
            console.log(`[Tegaki Anime Loader] âœ“ ${type.toUpperCase()} Blob created:`, blob.size, 'bytes');
            
            // æ²ç¤ºæ¿ã«æ³¨å…¥
            await this.injectToBoard(blob, type);
            console.log('[Tegaki Anime Loader] âœ“ Image injected to board');
            
            alert(`ç”»åƒã‚’æ·»ä»˜ã—ã¾ã—ãŸï¼æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚\n(ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: ${type.toUpperCase()})`);
            this.cleanup();
            
        } catch (error) {
            console.error('[Tegaki Anime Loader] ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—:', error);
            if (this.loadingEl) this.loadingEl.remove();
            alert(`ç”»åƒã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ\n${error.message}`);
        }
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - async/await: éåŒæœŸå‡¦ç†ã®é †æ¬¡å®Ÿè¡Œ
    - try/catch: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    - console.log/error: ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å‡ºåŠ›
    - alert(): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - progressCallback ã‚’ GIFç”Ÿæˆã®ã¿ã«æ¸¡ã™ï¼ˆAPNGã¯é€²æ—ãªã—ï¼‰
    - ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºå®Ÿã«å‰Šé™¤

ã€æ‰‹é †4-6ã€‘createUI() ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¢ºèª

  è©²å½“éƒ¨åˆ†ï¼ˆ147è¡Œç›®ã€œ204è¡Œç›®ä»˜è¿‘ï¼‰:

  æ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ä¸è¦ï¼‰:
    createUI() {
        // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ
        this.container = document.createElement('div');
        this.container.id = 'tegaki-anime-container';
        this.container.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #f0e0d6; z-index: 10000;
            display: flex; flex-direction: column;
        `;

        // ãƒˆãƒƒãƒ—ãƒãƒ¼ï¼ˆãµãŸã°é¢¨ã‚«ãƒ©ãƒ¼ï¼‰
        const topBar = document.createElement('div');
        topBar.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: #e9c2ba;
            border-bottom: 2px solid #cf9c97;
            gap: 8px;
        `;
        
        // å·¦å´ï¼šã‚¿ã‚¤ãƒˆãƒ«
        const title = document.createElement('div');
        title.textContent = 'ã‚¢ãƒ‹ãƒ¡ãŠçµµã‹ããƒ„ãƒ¼ãƒ«';
        title.style.cssText = `
            color: #800000;
            font-size: 14px;
            font-weight: bold;
        `;
        
        // å³å´ï¼šãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
        const buttonGroup = document.createElement('div');
        buttonGroup.style.cssText = `display: flex; gap: 8px;`;

        // APNGæŠ•ç¨¿ãƒœã‚¿ãƒ³
        const postApngBtn = createButton('APNGæŠ•ç¨¿', () => this.exportAndAttach('apng'), true);
        postApngBtn.title = 'APNGã‚’ç”Ÿæˆã—ã¦æ²ç¤ºæ¿ã«æ·»ä»˜';
        
        // GIFæŠ•ç¨¿ãƒœã‚¿ãƒ³
        const postGifBtn = createButton('GIFæŠ•ç¨¿', () => this.exportAndAttach('gif'), true);
        postGifBtn.title = 'GIFã‚’ç”Ÿæˆã—ã¦æ²ç¤ºæ¿ã«æ·»ä»˜';

        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        const closeBtn = createButton('âœ• é–‰ã˜ã‚‹', () => this.cancel());
        closeBtn.title = 'ç ´æ£„ã—ã¦é–‰ã˜ã‚‹';
        
        buttonGroup.appendChild(postApngBtn);
        buttonGroup.appendChild(postGifBtn);
        buttonGroup.appendChild(closeBtn);
        topBar.appendChild(title);
        topBar.appendChild(buttonGroup);
        this.container.appendChild(topBar);

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ï¼ˆTegakiã‚³ã‚¢ãŒä½¿ç”¨ï¼‰
        const canvasArea = document.createElement('div');
        canvasArea.id = 'tegaki-canvas-area-anime';
        canvasArea.style.cssText = `
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #ffffee;
        `;
        this.container.appendChild(canvasArea);
        
        document.body.appendChild(this.container);
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
        this.originalBodyOverflow = document.body.style.overflow;
        document.body.style.overflow = 'hidden';
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - document.createElement(tagName): DOMè¦ç´ ã‚’ä½œæˆ
    - element.appendChild(child): å­è¦ç´ ã‚’è¿½åŠ 
    - document.body.style.overflow: ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - z-index: 10000 ã§æœ€å‰é¢ã«è¡¨ç¤º
    - position: fixed ã§ç”»é¢å…¨ä½“ã‚’ã‚«ãƒãƒ¼
    - overflow: hidden ã§ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–

ã€æ‰‹é †4-7ã€‘createButton() ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®ç¢ºèª

  è©²å½“éƒ¨åˆ†ï¼ˆ39è¡Œç›®ã€œ67è¡Œç›®ä»˜è¿‘ï¼‰:

  æ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ä¸è¦ï¼‰:
    function createButton(text, onClick, isPrimary = false) {
        const btn = document.createElement('button');
        btn.innerHTML = text;
        
        const primaryBg = '#4ade80'; // ç·‘ç³»
        const primaryHover = '#22c55e';
        const primaryBorder = '#22c55e';

        const secondaryBg = '#f87171'; // æœ±è‰²ç³»
        const secondaryHover = '#ef4444';
        const secondaryBorder = '#ef4444';

        btn.style.cssText = `
            padding: 8px 16px;
            background: ${isPrimary ? primaryBg : secondaryBg};
            color: white;
            border: 2px solid ${isPrimary ? primaryBorder : secondaryBorder};
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        `;
        btn.onmouseover = () => btn.style.background = isPrimary ? primaryHover : secondaryHover;
        btn.onmouseout = () => btn.style.background = isPrimary ? primaryBg : secondaryBg;
        btn.onclick = onClick;
        return btn;
    }

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - element.onmouseover/onmouseout: ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    - element.onclick: ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«: `${å¤‰æ•°}` ã§æ–‡å­—åˆ—åŸ‹ã‚è¾¼ã¿

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - isPrimary ã§æŠ•ç¨¿ãƒœã‚¿ãƒ³ï¼ˆç·‘ï¼‰ã¨é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼ˆèµ¤ï¼‰ã‚’åŒºåˆ¥
    - transition ã§æ»‘ã‚‰ã‹ãªãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ

ã€æ‰‹é †4-8ã€‘cleanup() ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¢ºèª

  è©²å½“éƒ¨åˆ†ï¼ˆ300è¡Œç›®ã€œ326è¡Œç›®ä»˜è¿‘ï¼‰:

  æ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ä¸è¦ï¼‰:
    cleanup() {
        console.log('[Tegaki Anime Loader] Cleaning up...');
        
        if (this.core && this.core.destroy) {
            this.core.destroy();
            this.core = null;
            window.tegakiAnimeCore = null;
        }
        
        if (this.container) {
            this.container.remove();
            this.container = null;
        }
        
        if (this.originalBodyOverflow !== null) {
            document.body.style.overflow = this.originalBodyOverflow;
            this.originalBodyOverflow = null;
        }
        
        if (this.loadingEl) {
            this.loadingEl.remove();
        }
        
        console.log('[Tegaki Anime Loader] âœ“ Cleanup complete');
    }

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - core.destroy() ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
    - container.remove() ã§ DOM ã‚’å‰Šé™¤
    - overflow ã‚’å…ƒã«æˆ»ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
    - ã™ã¹ã¦ã®å‚ç…§ã‚’ null ã«ã—ã¦ãƒ¡ãƒ¢ãƒªè§£æ”¾

ã€æ‰‹é †4-9ã€‘ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²ã¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

  è©²å½“éƒ¨åˆ†ï¼ˆ357è¡Œç›®ã€œ367è¡Œç›®ä»˜è¿‘ï¼‰:

  æ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ä¸è¦ï¼‰:
    // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ² =====
    window.tegakiAnimeStart = function() {
        if (!window.tegakiAnimeInstance) {
            window.tegakiAnimeInstance = new TegakiLoaderAnime();
        }
        window.tegakiAnimeInstance.start();
    };
    
    // åˆå›å®Ÿè¡Œ
    // window.tegakiAnimeStart(); // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç™ºç«ã®å ´åˆã¯ãƒ­ãƒ¼ãƒ€ãƒ¼å´ã§è‡ªå‹•èµ·å‹•ã•ã›ãªã„

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - window.tegakiAnimeStart ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
    - ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¤‡æ•°å›å®Ÿè¡Œã‚’é˜²æ­¢
    - æœ€çµ‚è¡Œã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå´ã§å‘¼ã³å‡ºã™ï¼‰

ã€æ‰‹é †4-10ã€‘ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä½œæˆ

  ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«: bookmarklet.jsï¼ˆå‚è€ƒç”¨ï¼‰

  å†…å®¹:
    javascript:(function(){
        if(!window.tegakiAnimeStart){
            var s=document.createElement('script');
            s.charset='UTF-8';
            s.src='https://toshinka.github.io/tegaki/tegaki_anime_test/tegaki-loader_anime.js';
            document.body.appendChild(s);
        } else {
            window.tegakiAnimeStart();
        }
    })();

  ä½¿ç”¨æ–¹æ³•:
    1. ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã‚’1è¡Œã«ã¾ã¨ã‚ã‚‹
    2. ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«ç™»éŒ²
    3. ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ã§å®Ÿè¡Œ

  å‡¦ç†ãƒ•ãƒ­ãƒ¼:
    window.tegakiAnimeStart ãŒå­˜åœ¨ã—ãªã„
      â†’ tegaki-loader_anime.js ã‚’èª­ã¿è¾¼ã¿
      â†’ èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€è‡ªå‹•çš„ã« window.tegakiAnimeStart ãŒå®šç¾©ã•ã‚Œã‚‹
      â†’ ï¼ˆåˆå›ã¯æ‰‹å‹•ã§å†ã‚¯ãƒªãƒƒã‚¯ãŒå¿…è¦ï¼‰
    
    window.tegakiAnimeStart ãŒå­˜åœ¨ã™ã‚‹
      â†’ ç›´æ¥å®Ÿè¡Œ

ã€æ‰‹é †4-11ã€‘æœ€çµ‚ç¢ºèªç”¨ã®ä¿®æ­£ãƒªã‚¹ãƒˆ

  tegaki-loader_anime.js ã§ä¿®æ­£ã—ãŸç®‡æ‰€:
  
  1. SCRIPT_URLS ã®ç°¡ç•¥åŒ–ï¼ˆ17-24è¡Œç›®ï¼‰
     ä¿®æ­£å‰: 5ã¤ã®URL
     ä¿®æ­£å¾Œ: tegaki ã®ã¿
  
  2. start() ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ï¼ˆ120-130è¡Œç›®ï¼‰
     ä¿®æ­£å‰: Promise.all ã§4ã¤èª­ã¿è¾¼ã¿
     ä¿®æ­£å¾Œ: loadScript ã§1ã¤ã®ã¿èª­ã¿è¾¼ã¿
  
  3. GIF Workerè¨­å®šã®å‰Šé™¤ï¼ˆ132-139è¡Œç›®ï¼‰
     å‰Šé™¤: window.GIF.prototype.options.workerScript ã®è¨­å®š
  
  4. injectToBoard() ã® MIMEã‚¿ã‚¤ãƒ—ä¿®æ­£ï¼ˆ267-271è¡Œç›®ï¼‰
     ä¿®æ­£å‰: 'image/apng'
     ä¿®æ­£å¾Œ: 'image/png'
  
  5. ãƒ•ã‚¡ã‚¤ãƒ«åã®æ‹¡å¼µå­ä¿®æ­£ï¼ˆ270-271è¡Œç›®ï¼‰
     ä¿®æ­£å‰: `tegaki_anime_${Date.now()}.${type}`
     ä¿®æ­£å¾Œ: `tegaki_anime_${Date.now()}.${ext}` (ext = type === 'apng' ? 'png' : 'gif')

â–  ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
  âœ“ tegaki-loader_anime.js ãŒä¿®æ­£ã•ã‚Œã¦ã„ã‚‹
  âœ“ SCRIPT_URLS ãŒçµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’æŒ‡ã—ã¦ã„ã‚‹
  âœ“ APNG ã® MIMEã‚¿ã‚¤ãƒ—ãŒ 'image/png' ã«ãªã£ã¦ã„ã‚‹
  âœ“ ä¸è¦ãª Worker è¨­å®šã‚³ãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
  âœ“ ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®URLãŒæ­£ã—ã„

================================================================================
Phase 5: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
================================================================================

â–  ç›®çš„
  - ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ
  - GitHub Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  - æœ¬ç•ªç’°å¢ƒï¼ˆã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ï¼‰ã§ã®å‹•ä½œç¢ºèª

â–  ä½œæ¥­ãƒ•ã‚¡ã‚¤ãƒ«
  ã€æ–°è¦ä½œæˆã€‘
    - TegakiAniTest.html

â–  å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«
  - TegakiAniTest.htmlï¼ˆæ—¢å­˜ï¼‰
  - TegakiTest.html

â–  å‡¦ç†ãƒ•ãƒ­ãƒ¼
  [ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ]
    â†“
  TegakiAniTest.html ã‚’é–‹ã
    â†“
  dist/tegaki_anime.js ã‚’èª­ã¿è¾¼ã¿
    â†“
  TegakiAnimeCore ãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã‹ç¢ºèª
    â†“
  [ãƒ‡ãƒ—ãƒ­ã‚¤]
    â†“
  GitHub ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥
    â†“
  GitHub Pages ã§å…¬é–‹
    â†“
  [æœ¬ç•ªãƒ†ã‚¹ãƒˆ]
    â†“
  ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ã§ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå®Ÿè¡Œ
    â†“
  APNG/GIF ã‚’æŠ•ç¨¿

â–  å®Ÿè£…æ‰‹é †

ã€æ‰‹é †5-1ã€‘TegakiAniTest.html ã®ä½œæˆ

  ãƒ•ã‚¡ã‚¤ãƒ«: TegakiAniTest.html
  
  å†…å®¹:
    <!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Tegaki.js ã‚¢ãƒ‹ãƒ¡å¯¾å¿œç‰ˆ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒ</title>
        <style>
            html, body {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background-color: #ffffee;
            }
            #app-container {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
            }
            #top-bar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 16px;
                background-color: #f0e0d6;
                border-bottom: 2px solid #cf9c97;
                color: #800000;
            }
            #top-bar h1 {
                font-size: 18px;
                margin: 0;
            }
            #main-content {
                flex-grow: 1;
                position: relative;
            }
            #tegaki-app-container {
                width: 100%;
                height: 100%;
            }
            .test-buttons {
                display: flex;
                gap: 8px;
            }
            .test-btn {
                padding: 6px 12px;
                background: #4ade80;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            }
            .test-btn:hover {
                background: #22c55e;
            }
        </style>
    </head>
    <body>
        <div id="app-container">
            <header id="top-bar">
                <h1>ğŸŒ±ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ APNG/GIF ã‚¢ãƒ‹ãƒ¡æŠ•ç¨¿ãƒ†ã‚¹ãƒˆ</h1>
                <div class="test-buttons">
                    <button class="test-btn" onclick="testApng()">APNG ãƒ†ã‚¹ãƒˆ</button>
                    <button class="test-btn" onclick="testGif()">GIF ãƒ†ã‚¹ãƒˆ</button>
                </div>
            </header>
            <main id="main-content">
                <div id="tegaki-app-container"></div>
            </main>
        </div>

        <!-- çµ±åˆæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
        <script src="dist/tegaki_anime.js"></script>

        <script>
            let coreInstance = null;

            document.addEventListener('DOMContentLoaded', () => {
                const container = document.getElementById('tegaki-app-container');

                if (container && window.TegakiAnimeCore) {
                    coreInstance = new window.TegakiAnimeCore(container);
                    console.log('[Test] TegakiAnimeCore initialized');
                } else {
                    console.error('[Test] TegakiAnimeCore not found');
                }
            });

            async function testApng() {
                if (!coreInstance) {
                    alert('ã‚³ã‚¢ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                console.log('[Test] Exporting APNG...');
                const blob = await coreInstance.exportAsApng();
                
                if (blob) {
                    console.log('[Test] APNG Blob size:', blob.size);
                    downloadBlob(blob, 'test.png');
                } else {
                    alert('APNGç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            async function testGif() {
                if (!coreInstance) {
                    alert('ã‚³ã‚¢ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                console.log('[Test] Exporting GIF...');
                const blob = await coreInstance.exportAsGif((progress) => {
                    console.log('[Test] GIF progress:', Math.floor(progress * 100) + '%');
                });
                
                if (blob) {
                    console.log('[Test] GIF Blob size:', blob.size);
                    downloadBlob(blob, 'test.gif');
                } else {
                    alert('GIFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            function downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                console.log('[Test] Download triggered:', filename);
            }
        </script>
    </body>
    </html>

  ä½¿ç”¨ãƒ¡ã‚½ãƒƒãƒ‰:
    - URL.createObjectURL(blob): Blob ã‹ã‚‰ä¸€æ™‚URLã‚’ç”Ÿæˆ
    - URL.revokeObjectURL(url): ä¸€æ™‚URLã‚’è§£æ”¾
    - a.click(): ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹ï¼‰

  é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    - ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã§ APNG/GIF ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ¤œè¨¼
    - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãƒ‡ãƒãƒƒã‚°

ã€æ‰‹é †5-2ã€‘ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

  ã‚³ãƒãƒ³ãƒ‰:
    # ãƒ“ãƒ«ãƒ‰
    npm run build
    
    # ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆPython 3ã®å ´åˆï¼‰
    python -m http.server 8000
    
    # ã¾ãŸã¯ Node.js ã® http-server
    npx http-server -p 8000

  ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã:
    http://localhost:8000/TegakiAniTest.html

  ãƒ†ã‚¹ãƒˆæ‰‹é †:
    1. ãƒšãƒ¼ã‚¸ãŒé–‹ã„ãŸã‚‰ã€å„ãƒ•ãƒ¬ãƒ¼ãƒ ã«æç”»
    2. ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿ãƒœã‚¿ãƒ³ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦5ãƒ•ãƒ¬ãƒ¼ãƒ æç”»
    3. "APNG ãƒ†ã‚¹ãƒˆ" ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
       â†’ test.png ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
       â†’ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã‹ç¢ºèª
    4. "GIF ãƒ†ã‚¹ãƒˆ" ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
       â†’ test.gif ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
       â†’ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã‹ç¢ºèª
    5. ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª

  æœŸå¾…ã•ã‚Œã‚‹çµæœ:
    âœ“ æç”»ãŒæ­£å¸¸ã«å‹•ä½œ
    âœ“ ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿ãŒæ­£å¸¸ã«å‹•ä½œ
    âœ“ Undo/Redoï¼ˆCtrl+Z/Yï¼‰ãŒæ­£å¸¸ã«å‹•ä½œ
    âœ“ APNG ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹
    âœ“ GIF ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹
    âœ“ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„

ã€æ‰‹é †5-3ã€‘GitHub ã¸ã®ãƒ—ãƒƒã‚·ãƒ¥

  ã‚³ãƒãƒ³ãƒ‰:
    cd tegaki_anime_test
    
    # Git åˆæœŸåŒ–ï¼ˆã¾ã ã®å ´åˆï¼‰
    git init
    
    # .gitignore ä½œæˆ
    echo "node_modules/" > .gitignore
    echo "package-lock.json" >> .gitignore
    
    # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
    git add .
    
    # ã‚³ãƒŸãƒƒãƒˆ
    git commit -m "Add anime version with bundled libraries"
    
    # ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«è¿½åŠ ï¼ˆæ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆï¼‰
    git remote add origin https://github.com/[username]/tegaki.git
    
    # ãƒ—ãƒƒã‚·ãƒ¥
    git push origin main

  ã¾ãŸã¯ã€è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (tegaki/) ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥:
    cd ..
    git add tegaki_anime_test/
    git commit -m "Add tegaki_anime_test with npm build system"
    git push origin main

ã€æ‰‹é †5-4ã€‘GitHub Pages ã®è¨­å®š

  GitHub ãƒªãƒã‚¸ãƒˆãƒªãƒšãƒ¼ã‚¸ã§:
    1. Settings â†’ Pages
    2. Source: Deploy from a branch
    3. Branch: main / root (ã¾ãŸã¯ docs)
    4. Save
    
  ã¾ãŸã¯ã€tegaki_anime_test/dist/ ã‚’ docs/ ã«ã‚³ãƒ”ãƒ¼:
    cp -r dist ../docs/anime/
    git add ../docs/anime/
    git commit -m "Deploy anime version to GitHub Pages"
    git push

  å…¬é–‹URL:
    https://[username].github.io/tegaki/tegaki_anime_test/dist/tegaki_anime.js
    https://[username].github.io/tegaki/tegaki_anime_test/tegaki-loader_anime.js

ã€æ‰‹é †5-5ã€‘ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æœ€çµ‚ç‰ˆ

  æœ€çµ‚çš„ãªãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚³ãƒ¼ãƒ‰:
    javascript:(function(){if(!window.tegakiAnimeStart){var s=document.createElement('script');s.charset='UTF-8';s.src='https://toshinka.github.io/tegaki/tegaki_anime_test/tegaki-loader_anime.js';document.body.appendChild(s)}else{window.tegakiAnimeStart()}})();

  ç™»éŒ²æ–¹æ³•:
    1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã‚’è¡¨ç¤º
    2. æ–°ã—ã„ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’ä½œæˆ
    3. åå‰: Tegaki Anime
    4. URL: ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ï¼ˆjavascript:...ï¼‰ã‚’è²¼ã‚Šä»˜ã‘
    5. ä¿å­˜

ã€æ‰‹é †5-6ã€‘æœ¬ç•ªç’°å¢ƒï¼ˆã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ï¼‰ã§ã®ãƒ†ã‚¹ãƒˆ

  ãƒ†ã‚¹ãƒˆæ‰‹é †:
    1. ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹ã
       https://mebuki.moe/app/t/[ã‚¹ãƒ¬ãƒƒãƒ‰ID]
    
    2. ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå®Ÿè¡Œ
       - åˆå›: ãƒ­ãƒ¼ãƒ€ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ï¼ˆç”»é¢ã¯å¤‰ã‚ã‚‰ãªã„ï¼‰
       - 2å›ç›®: ãŠçµµã‹ãUIãŒè¡¨ç¤ºã•ã‚Œã‚‹
    
    3. å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç”»
       - ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿
       - 5ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†æç”»
    
    4. APNGæŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
       - "APNGã‚’ç”Ÿæˆä¸­..." ã¨è¡¨ç¤ºã•ã‚Œã‚‹
       - "ç”»åƒã‚’æ·»ä»˜ã—ã¾ã—ãŸï¼" ã¨è¡¨ç¤ºã•ã‚Œã‚‹
       - ãƒ¬ã‚¹æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã«ç”»åƒãŒæ·»ä»˜ã•ã‚Œã‚‹
    
    5. æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
       - ãƒ¬ã‚¹ãŒæŠ•ç¨¿ã•ã‚Œã‚‹
       - ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹
       - ç”»åƒãŒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã‹ç¢ºèª
    
    6. GIFæŠ•ç¨¿ã‚‚åŒæ§˜ã«ãƒ†ã‚¹ãƒˆ

  ãƒã‚§ãƒƒã‚¯é …ç›®:
    âœ“ UI ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹
    âœ“ æç”»ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
    âœ“ ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡æ›¿ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
    âœ“ APNGç”ŸæˆãŒå®Œäº†ã™ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ï¼‰
    âœ“ GIFç”ŸæˆãŒå®Œäº†ã™ã‚‹ï¼ˆé€²æ—ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
    âœ“ ç”»åƒãŒãƒ•ã‚©ãƒ¼ãƒ ã«æ·»ä»˜ã•ã‚Œã‚‹
    âœ“ æŠ•ç¨¿å¾Œã€ç”»åƒãŒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹

ã€æ‰‹é †5-7ã€‘ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

  å•é¡Œ1: ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒå‹•ä½œã—ãªã„
    åŸå› : CSP ãŒ script ã‚¿ã‚°ã®å‹•çš„è¿½åŠ ã‚’ãƒ–ãƒ­ãƒƒã‚¯
    å¯¾ç­–: ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
          åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§è©¦ã™ï¼ˆChrome, Firefox, Safariï¼‰

  å•é¡Œ2: APNG ãŒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã—ãªã„
    åŸå› : ãƒ–ãƒ©ã‚¦ã‚¶ãŒ APNG æœªå¯¾å¿œ
          MIMEã‚¿ã‚¤ãƒ—ãŒé–“é•ã£ã¦ã„ã‚‹
    å¯¾ç­–: Firefox ã¾ãŸã¯ Chrome ã§ç¢ºèª
          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ hex ã‚¨ãƒ‡ã‚£ã‚¿ã§é–‹ãã€PNG ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèª
          
  å•é¡Œ3: GIF ç”ŸæˆãŒå®Œäº†ã—ãªã„
    åŸå› : Worker ã®èª­ã¿è¾¼ã¿å¤±æ•—
    å¯¾ç­–: build.js ã® Worker ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã‚’ç¢ºèª
          ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ GIF.js ã®ãƒ­ã‚°ã‚’ç¢ºèª

  å•é¡Œ4: æŠ•ç¨¿å¾Œã€ç”»åƒãŒè¡¨ç¤ºã•ã‚Œãªã„
    åŸå› : Blob ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã‚‹
          ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™
    å¯¾ç­–: ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã‚’æ¸›ã‚‰ã™ï¼ˆ5â†’3ï¼‰
          å“è³ªã‚’ä¸‹ã’ã‚‹ï¼ˆGIF ã® quality ã‚’ä¸Šã’ã‚‹ï¼‰

  ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒ¼ãƒ‰:
    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
    console.log('UPNG:', typeof window.UPNG);
    console.log('pako:', typeof window.pako);
    console.log('Zlib:', typeof window.Zlib);
    console.log('GIF:', typeof window.GIF);
    console.log('TegakiAnimeCore:', typeof window.TegakiAnimeCore);

  æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
    UPNG: function
    pako: object
    Zlib: object
    GIF: function
    TegakiAnimeCore: function

â–  ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
  âœ“ TegakiAniTest.html ã§æ­£å¸¸ã«å‹•ä½œã™ã‚‹
  âœ“ APNG/GIF ãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹
  âœ“ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹
  âœ“ ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ­£ã—ã„URLã‚’æŒ‡ã—ã¦ã„ã‚‹
  âœ“ ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ã§æŠ•ç¨¿ã§ãã‚‹
  âœ“ æŠ•ç¨¿ã—ãŸç”»åƒãŒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹

================================================================================
8. æ›éª¨å¥ªèƒã‚¬ã‚¤ãƒ‰ï¼ˆæ—¢å­˜ãƒ„ãƒ¼ãƒ«ã‹ã‚‰ã®ç§»è¡Œï¼‰
================================================================================

â–  ç›®çš„
  - åˆ¥ã®ãŠçµµã‹ããƒ„ãƒ¼ãƒ«ã‚’ä»Šå›ã®æ§‹æˆã«ç§»è¡Œ
  - index.html ã‚’ loader.html ã¨ test.html ã«åˆ†å‰²
  - CDN ä¾å­˜ã‚’ npm ç®¡ç†ã«å¤‰æ›´

â–  å‰ææ¡ä»¶
  æ—¢å­˜ãƒ„ãƒ¼ãƒ«ãŒä»¥ä¸‹ã®æ§‹æˆã§ã‚ã‚‹å ´åˆ:
    project/
    â”œâ”€â”€ index.html          # ã™ã¹ã¦ã‚’å«ã‚€å˜ä¸€HTML
    â”œâ”€â”€ script.js           # ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
    â””â”€â”€ style.css           # ã‚¹ã‚¿ã‚¤ãƒ«

  index.html ã®æ§‹é€ :
    <script src="https://cdn.example.com/library1.js"></script>
    <script src="https://cdn.example.com/library2.js"></script>
    <script src="script.js"></script>

â–  ç§»è¡Œæ‰‹é †

ã€ç§»è¡Œæ‰‹é †1ã€‘ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã®å†ç·¨æˆ

  æ–°ã—ã„æ§‹é€ :
    project/
    â”œâ”€â”€ package.json
    â”œâ”€â”€ build.js
    â”œâ”€â”€ libs/
    â”‚   â”œâ”€â”€ library1.js         # CDNã‹ã‚‰ã‚³ãƒ”ãƒ¼
    â”‚   â””â”€â”€ library2.js         # CDNã‹ã‚‰ã‚³ãƒ”ãƒ¼
    â”œâ”€â”€ src/
    â”‚   â””â”€â”€ core.js             # script.js ã‚’ãƒªãƒãƒ¼ãƒ 
    â”œâ”€â”€ dist/
    â”‚   â””â”€â”€ bundle.js           # ãƒ“ãƒ«ãƒ‰å‡ºåŠ›
    â”œâ”€â”€ loader.html             # ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ç”¨ãƒ­ãƒ¼ãƒ€ãƒ¼
    â””â”€â”€ test.html               # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨

ã€ç§»è¡Œæ‰‹é †2ã€‘index.html ã®åˆ†å‰²

  å…ƒã® index.html:
    <!DOCTYPE html>
    <html>
    <head>
        <script src="https://cdn.example.com/library1.js"></script>
        <script src="https://cdn.example.com/library2.js"></script>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div id="app"></div>
        <script src="script.js"></script>
        <script>
            // åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰
            new MyApp(document.getElementById('app'));
        </script>
    </body>
    </html>

  åˆ†å‰²å¾Œã® test.html:
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ</title>
        <style>
            /* style.css ã®å†…å®¹ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ */
        </style>
    </head>
    <body>
        <div id="app"></div>
        
        <!-- ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
        <script src="dist/bundle.js"></script>
        
        <script>
            // åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰
            document.addEventListener('DOMContentLoaded', () => {
                if (window.MyApp) {
                    new window.MyApp(document.getElementById('app'));
                }
            });
        </script>
    </body>
    </html>

  loader.htmlï¼ˆã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ç”¨ï¼‰:
    (function() {
        'use strict';
        
        window.myAppStart = function() {
            // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚Œã°å‰Šé™¤
if (window.myAppInstance) {
                window.myAppInstance.destroy();
                window.myAppInstance = null;
            }
            
            // UIã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
            const container = document.createElement('div');
            container.id = 'myapp-container';
            container.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                z-index: 10000;
                background: white;
            `;
            document.body.appendChild(container);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
            document.body.style.overflow = 'hidden';
            
            // ãƒãƒ³ãƒ‰ãƒ«ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿
            const script = document.createElement('script');
            script.src = 'https://[username].github.io/[repo]/dist/bundle.js';
            script.onload = function() {
                if (window.MyApp) {
                    window.myAppInstance = new window.MyApp(container);
                    console.log('[Loader] MyApp initialized');
                }
            };
            script.onerror = function() {
                alert('ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                container.remove();
                document.body.style.overflow = '';
            };
            document.head.appendChild(script);
        };
        
        // è‡ªå‹•èµ·å‹•ï¼ˆãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
        // window.myAppStart();
    })();

ã€ç§»è¡Œæ‰‹é †3ã€‘script.js ã‚’ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›

  å…ƒã® script.js:
    class MyApp {
        constructor(container) {
            this.container = container;
            this.canvas = document.createElement('canvas');
            // ...
        }
        
        // ãƒ¡ã‚½ãƒƒãƒ‰ç¾¤
    }

  å¤‰æ›å¾Œã® src/core.js:
    (function() {
        'use strict';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆé‡è¦ï¼‰
        window.MyApp = class MyApp {
            constructor(container) {
                this.container = container;
                this.canvas = document.createElement('canvas');
                // ...
            }
            
            // ãƒ¡ã‚½ãƒƒãƒ‰ç¾¤
            
            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ï¼ˆå¿…é ˆï¼‰
            destroy() {
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
                // DOMè¦ç´ ã‚’å‰Šé™¤
                // å‚ç…§ã‚’ã‚¯ãƒªã‚¢
            }
        };
        
        console.log('âœ… MyApp loaded');
    })();

  é‡è¦ãªå¤‰æ›´ç‚¹:
    1. IIFE ã§ãƒ©ãƒƒãƒ—
    2. window.MyApp ã¨ã—ã¦å…¬é–‹
    3. destroy() ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ç”¨ï¼‰

ã€ç§»è¡Œæ‰‹é †4ã€‘package.json ã®ä½œæˆ

  å†…å®¹:
    {
      "name": "my-drawing-app",
      "version": "1.0.0",
      "description": "Drawing app for Mebuki channel",
      "scripts": {
        "build": "node build.js"
      },
      "dependencies": {
        "library1": "^1.0.0",
        "library2": "^2.0.0"
      }
    }

  ã‚³ãƒãƒ³ãƒ‰:
    npm install

ã€ç§»è¡Œæ‰‹é †5ã€‘build.js ã®ä½œæˆ

  åŸºæœ¬ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆTegaki Animeç‰ˆã‚’ãƒ™ãƒ¼ã‚¹ã«ï¼‰:
    const fs = require('fs');
    const path = require('path');

    console.log('ğŸ”¨ Building bundle.js...');

    // çµåˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆ
    const files = [
        'libs/library1.js',
        'libs/library2.js',
        'src/core.js'
    ];

    // ãƒ˜ãƒƒãƒ€ãƒ¼
    let output = `// Bundle built at ${new Date().toISOString()}\n\n`;

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †æ¬¡èª­ã¿è¾¼ã‚“ã§çµåˆ
    files.forEach(file => {
        console.log(`ğŸ“¦ Reading: ${file}`);
        const content = fs.readFileSync(path.join(__dirname, file), 'utf8');
        output += `\n// ========== ${file} ==========\n`;
        output += content + '\n';
    });

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    output += `
    // ========== Global Exports ==========
    (function() {
        'use strict';
        
        if (typeof window !== 'undefined') {
            // å¿…è¦ã«å¿œã˜ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
            console.log('âœ… Bundle loaded successfully');
        }
    })();
    `;

    // å‡ºåŠ›
    fs.mkdirSync('dist', { recursive: true });
    fs.writeFileSync('dist/bundle.js', output);

    console.log('âœ… Build complete: dist/bundle.js');
    console.log(`ğŸ“¦ Size: ${(output.length / 1024).toFixed(2)} KB`);

ã€ç§»è¡Œæ‰‹é †6ã€‘CDNä¾å­˜ã®æ’é™¤

  å…ƒã®HTML:
    <script src="https://cdn.example.com/pixijs/pixi.min.js"></script>

  ã‚¹ãƒ†ãƒƒãƒ—A: npm ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    npm install pixi.js

  ã‚¹ãƒ†ãƒƒãƒ—B: libs/ ã«ã‚³ãƒ”ãƒ¼
    cp node_modules/pixi.js/dist/pixi.min.js libs/pixi.js

  ã‚¹ãƒ†ãƒƒãƒ—C: build.js ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã«è¿½åŠ 
    const files = [
        'libs/pixi.js',        // â† è¿½åŠ 
        'libs/library1.js',
        'libs/library2.js',
        'src/core.js'
    ];

  ã‚¹ãƒ†ãƒƒãƒ—D: ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ã‚’ç¢ºèª
    // pixi.js ã¯è‡ªå‹•çš„ã« window.PIXI ã‚’å…¬é–‹ã™ã‚‹ãŸã‚è¿½åŠ ã‚³ãƒ¼ãƒ‰ä¸è¦
    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã£ã¦ã¯æ‰‹å‹•ã§å…¬é–‹ãŒå¿…è¦
    
    output += `
    if (typeof PIXI !== 'undefined') {
        window.PIXI = PIXI;
    }
    `;

ã€ç§»è¡Œæ‰‹é †7ã€‘Worker ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ï¼ˆå¿…è¦ãªå ´åˆï¼‰

  å…ƒã®ã‚³ãƒ¼ãƒ‰:
    const worker = new Worker('https://cdn.example.com/worker.js');

  ã‚¹ãƒ†ãƒƒãƒ—A: worker.js ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    curl -o libs/worker.js https://cdn.example.com/worker.js

  ã‚¹ãƒ†ãƒƒãƒ—B: build.js ã§ Base64 åŒ–
    // Worker ã‚’ Base64 ã«å¤‰æ›
    const workerCode = fs.readFileSync(path.join(__dirname, 'libs/worker.js'), 'utf8');
    const workerBase64 = Buffer.from(workerCode).toString('base64');

    // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    output += `
    // ========== Worker Inline ==========
    (function() {
        const workerCode = atob('${workerBase64}');
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        window.__workerUrl = URL.createObjectURL(blob);
        console.log('âœ… Worker inlined');
    })();
    `;

  ã‚¹ãƒ†ãƒƒãƒ—C: ã‚³ã‚¢å´ã§ Blob URL ã‚’ä½¿ç”¨
    // src/core.js å†…
    const worker = new Worker(window.__workerUrl);

ã€ç§»è¡Œæ‰‹é †8ã€‘ã‚¹ã‚¿ã‚¤ãƒ«ã®åŸ‹ã‚è¾¼ã¿

  å…ƒã®æ§‹æˆ:
    index.html: <link rel="stylesheet" href="style.css">

  æ–¹æ³•A: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ¨å¥¨ï¼‰
    // src/core.js å†…ã§å‹•çš„ã«è¿½åŠ 
    const style = document.createElement('style');
    style.textContent = `
        #myapp-container {
            background: #f0f0f0;
            /* ... */
        }
    `;
    document.head.appendChild(style);

  æ–¹æ³•B: build.js ã§CSSã‚’çµ±åˆ
    const cssContent = fs.readFileSync('style.css', 'utf8');
    output += `
    (function() {
        const style = document.createElement('style');
        style.textContent = \`${cssContent}\`;
        document.head.appendChild(style);
    })();
    `;

ã€ç§»è¡Œæ‰‹é †9ã€‘ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä½œæˆ

  loader.js ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç”¨ã«æœ€å°åŒ–:
    javascript:(function(){if(!window.myAppStart){var s=document.createElement('script');s.src='https://[username].github.io/[repo]/loader.js';document.body.appendChild(s)}else{window.myAppStart()}})();

ã€ç§»è¡Œæ‰‹é †10ã€‘ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤

  ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ:
    npm run build
    python -m http.server 8000
    # http://localhost:8000/test.html ã‚’é–‹ã

  GitHub ã¸ãƒ—ãƒƒã‚·ãƒ¥:
    git add .
    git commit -m "Migrate to bundled architecture"
    git push

  GitHub Pages ã§å…¬é–‹:
    Settings â†’ Pages â†’ Branch: main â†’ Save

â–  ç§»è¡Œæ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

  â–¡ package.json ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
  â–¡ ã™ã¹ã¦ã®CDNä¾å­˜ãŒnpmã«ç½®ãæ›ãˆã‚‰ã‚Œã¦ã„ã‚‹
  â–¡ libs/ ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã‚‹
  â–¡ build.js ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
  â–¡ dist/bundle.js ãŒç”Ÿæˆã•ã‚Œã‚‹
  â–¡ test.html ã§æ­£å¸¸ã«å‹•ä½œã™ã‚‹
  â–¡ loader.js ãŒãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹
  â–¡ ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ã§æ­£å¸¸ã«å‹•ä½œã™ã‚‹
  â–¡ ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒãªã„ï¼ˆdestroy() å®Ÿè£…æ¸ˆã¿ï¼‰
  â–¡ CSPã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„

â–  ã‚ˆãã‚ã‚‹ç§»è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³

  ãƒ‘ã‚¿ãƒ¼ãƒ³1: PixiJS + ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ¼ãƒ‰
    ä¾å­˜: PixiJS (CDN)
    å¯¾å¿œ: npm install pixi.js â†’ libs/pixi.js ã«ã‚³ãƒ”ãƒ¼
    æ³¨æ„: PixiJS ã¯è‡ªå‹•ã§ window.PIXI ã‚’å…¬é–‹

  ãƒ‘ã‚¿ãƒ¼ãƒ³2: Three.js + OrbitControls
    ä¾å­˜: Three.js (CDN), OrbitControls (åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«)
    å¯¾å¿œ: npm install three
          cp node_modules/three/build/three.min.js libs/
          cp node_modules/three/examples/jsm/controls/OrbitControls.js libs/
    æ³¨æ„: OrbitControls ã¯ ESM ãªã®ã§ã€IIFEç‰ˆã‚’æ¢ã™ã‹ã€æ‰‹å‹•ã§å¤‰æ›

  ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼
    ä¾å­˜: GIF.js, APNG.js (Workerå«ã‚€)
    å¯¾å¿œ: npm install gif.js upng-js pako
          Worker ã‚’ Base64 åŒ–ã—ã¦ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆTegaki Animeç‰ˆã¨åŒã˜ï¼‰

  ãƒ‘ã‚¿ãƒ¼ãƒ³4: UI ãƒ©ã‚¤ãƒ–ãƒ©ãƒª + ã‚³ã‚¢
    ä¾å­˜: React/Vue (CDN), ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    å¯¾å¿œ: npm install react react-dom
          Babel ã‚’ä½¿ã‚ãªã„å ´åˆã¯ React.createElement() ã§è¨˜è¿°
          ã¾ãŸã¯ã€Preact ãªã©è»½é‡ä»£æ›¿ã‚’æ¤œè¨

â–  ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

  å•é¡Œ: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ window ã«å…¬é–‹ã•ã‚Œãªã„
    åŸå› : ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ ESM ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹
    å¯¾ç­–: UMDç‰ˆ ã¾ãŸã¯ IIFEç‰ˆ ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          package.json ã® "browser" ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª

  å•é¡Œ: ãƒ“ãƒ«ãƒ‰å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã‚‹
    åŸå› : åœ§ç¸®ã•ã‚Œã¦ã„ãªã„
    å¯¾ç­–: äº‹å‰ã« .min.js ç‰ˆã‚’ä½¿ç”¨
          terser ãªã©ã§åœ§ç¸®ï¼ˆnpm install --save-dev terserï¼‰
          build.js ã«åœ§ç¸®å‡¦ç†ã‚’è¿½åŠ 

  å•é¡Œ: è¤‡æ•°ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒç«¶åˆã™ã‚‹
    åŸå› : ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®è¡çª
    å¯¾ç­–: IIFE ã§ãƒ©ãƒƒãƒ—ã—ã¦åå‰ç©ºé–“ã‚’åˆ†é›¢
          window.MyApp.dependencies = { lib1, lib2 } ã®ã‚ˆã†ã«ç®¡ç†

  å•é¡Œ: Worker ãŒå‹•ä½œã—ãªã„
    åŸå› : CSP ã® worker-src åˆ¶ç´„
    å¯¾ç­–: Blob URL ã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ï¼ˆå¿…é ˆï¼‰
          build.js ã§ Base64 å¤‰æ›

================================================================================
9. ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã¨å½¹å‰²ã‚µãƒãƒªãƒ¼
================================================================================

â–  æœ€çµ‚çš„ãªãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

  tegaki_anime_test/
  â”‚
  â”œâ”€â”€ package.json                  # npm ä¾å­˜ç®¡ç†
  â”œâ”€â”€ package-lock.json             # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ­ãƒƒã‚¯
  â”œâ”€â”€ build.js                      # ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  â”‚
  â”œâ”€â”€ node_modules/                 # npm ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆï¼ˆGitã«å«ã‚ãªã„ï¼‰
  â”‚   â”œâ”€â”€ upng-js/
  â”‚   â”œâ”€â”€ pako/
  â”‚   â””â”€â”€ gif.js/
  â”‚
  â”œâ”€â”€ libs/                         # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚³ãƒ”ãƒ¼å…ˆ
  â”‚   â”œâ”€â”€ upng.js                   # APNG ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼
  â”‚   â”œâ”€â”€ pako.js                   # åœ§ç¸®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
  â”‚   â”œâ”€â”€ gif.js                    # GIF ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼
  â”‚   â””â”€â”€ gif.worker.js             # GIF Worker
  â”‚
  â”œâ”€â”€ src/                          # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
  â”‚   â””â”€â”€ tegaki_anime_core.js      # ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
  â”‚
  â”œâ”€â”€ dist/                         # ãƒ“ãƒ«ãƒ‰å‡ºåŠ›
  â”‚   â””â”€â”€ tegaki_anime.js           # çµ±åˆæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœ€çµ‚æˆæœç‰©ï¼‰
  â”‚
  â”œâ”€â”€ tegaki-loader_anime.js        # ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ç”¨ï¼‰
  â”œâ”€â”€ TegakiAniTest.html            # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨HTML
  â””â”€â”€ README.md                     # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

â–  å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²

  ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€‘
    package.json          : npm ä¾å­˜é–¢ä¿‚ã®å®šç¾©
    build.js              : ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    .gitignore            : Gitç®¡ç†å¯¾è±¡å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®š

  ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆlibs/ï¼‰ã€‘
    upng.js               : APNG ãƒã‚¤ãƒŠãƒªç”Ÿæˆï¼ˆUPNG.encodeï¼‰
    pako.js               : Deflateåœ§ç¸®ï¼ˆUPNG ãŒå†…éƒ¨ã§ä½¿ç”¨ï¼‰
    gif.js                : GIF ãƒã‚¤ãƒŠãƒªç”Ÿæˆï¼ˆnew GIF, addFrame, renderï¼‰
    gif.worker.js         : GIF ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å‡¦ç†ã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ

  ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆsrc/ï¼‰ã€‘
    tegaki_anime_core.js  : TegakiAnimeCoreã‚¯ãƒ©ã‚¹å®šç¾©
                            - UIç”Ÿæˆ
                            - æç”»å‡¦ç†
                            - ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
                            - Undo/Redo
                            - ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

  ã€ãƒ“ãƒ«ãƒ‰å‡ºåŠ›ï¼ˆdist/ï¼‰ã€‘
    tegaki_anime.js       : upng + pako + gif + core ã®çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«
                            - Worker ãŒ Base64 ã§åŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹
                            - window.UPNG, pako, GIF, TegakiAnimeCore ã‚’å…¬é–‹

  ã€ãƒ­ãƒ¼ãƒ€ãƒ¼ã€‘
    tegaki-loader_anime.js: ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ç”¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
                            - æ²ç¤ºæ¿åˆ¤å®š
                            - è¦ç´ æ¤œå‡º
                            - UIç”Ÿæˆ
                            - ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‹æ·»ä»˜å‡¦ç†

  ã€ãƒ†ã‚¹ãƒˆã€‘
    TegakiAniTest.html    : ãƒ­ãƒ¼ã‚«ãƒ«å‹•ä½œç¢ºèªç”¨
                            - dist/tegaki_anime.js ã‚’ç›´æ¥èª­ã¿è¾¼ã¿
                            - APNG/GIF ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ä»˜ã

â–  ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

  [é–‹ç™ºæ™‚]
    package.json â†’ npm install â†’ node_modules/
                                       â†“
                               libs/ ã¸ã‚³ãƒ”ãƒ¼
                                       â†“
    build.js â†’ libs/*.js + src/*.js ã‚’çµåˆ â†’ dist/tegaki_anime.js

  [ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆæ™‚]
    TegakiAniTest.html
      â†“ script src
    dist/tegaki_anime.js
      â†“ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    TegakiAnimeCore
      â†“ æç”»
    Canvas
      â†“ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    Blob â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

  [æœ¬ç•ªï¼ˆã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ï¼‰æ™‚]
    ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
      â†“ script æŒ¿å…¥
    tegaki-loader_anime.js
      â†“ script æŒ¿å…¥
    dist/tegaki_anime.js
      â†“ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    TegakiAnimeCore
      â†“ æç”»
    Canvas
      â†“ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    Blob
      â†“ File å¤‰æ›
    input[type="file"]
      â†“ æŠ•ç¨¿
    ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹

================================================================================
10. é–‹ç™ºãƒ»ä¿å®ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
================================================================================

â–  ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

  ã€å¿…é ˆã€‘
    - ã™ã¹ã¦ã®JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’ IIFE ã§ãƒ©ãƒƒãƒ—
    - 'use strict' ã‚’å®£è¨€
    - ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ã™ã‚‹ã‚‚ã®ã¯ window.* ã«æ˜ç¤ºçš„ã«ä»£å…¥
    - ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯å¿…ãšè§£é™¤ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰

  ã€æ¨å¥¨ã€‘
    - å¤‰æ•°åã¯ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ï¼ˆframeCount, activeLayerIndexï¼‰
    - ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã¯ä¸è¦ï¼ˆIIFEå†…ã§é–‰ã˜ã‚‹ãŸã‚ï¼‰
    - async/await ã‚’ä½¿ç”¨ï¼ˆPromise.then ã‚ˆã‚Šå¯èª­æ€§ãŒé«˜ã„ï¼‰
    - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã«æ¥é ­è¾ã‚’ã¤ã‘ã‚‹ï¼ˆä¾‹: '[Tegaki] ...'ï¼‰

  ã€ç¦æ­¢ã€‘
    - var ã®ä½¿ç”¨ï¼ˆlet/const ã‚’ä½¿ç”¨ï¼‰
    - ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ç„¡ç§©åºãªè¿½åŠ 
    - å¤–éƒ¨CDNã¸ã®ä¾å­˜ï¼ˆã™ã¹ã¦ npm çµŒç”±ï¼‰

â–  ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

  ã€Git ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘
    feat: æ–°æ©Ÿèƒ½è¿½åŠ 
    fix: ãƒã‚°ä¿®æ­£
    refactor: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
    docs: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
    build: ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ å¤‰æ›´
    
    ä¾‹:
      feat: Add GIF export with progress callback
      fix: Fix APNG MIME type to image/png
      refactor: Extract button creation to helper function

  ã€ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã€‘
    main        : å®‰å®šç‰ˆ
    develop     : é–‹ç™ºç‰ˆ
    feature/*   : æ©Ÿèƒ½è¿½åŠ 
    fix/*       : ãƒã‚°ä¿®æ­£

  ã€ã‚¿ã‚°ä»˜ã‘ã€‘
    v1.0.0: åˆå›ãƒªãƒªãƒ¼ã‚¹
    v1.1.0: APNGå¯¾å¿œ
    v1.2.0: GIFå¯¾å¿œ
    v1.2.1: MIMEã‚¿ã‚¤ãƒ—ä¿®æ­£

â–  ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

  ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã€‘
    1. npm run build
    2. TegakiAniTest.html ã§å‹•ä½œç¢ºèª
    3. å„ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªï¼ˆChrome, Firefox, Safariï¼‰

  ã€æœ¬ç•ªãƒ†ã‚¹ãƒˆã€‘
    1. GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤
    2. ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ã§ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå®Ÿè¡Œ
    3. å®Ÿéš›ã«æŠ•ç¨¿ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª

  ã€ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã€‘
    - æ—¢å­˜æ©Ÿèƒ½ãŒå£Šã‚Œã¦ã„ãªã„ã‹ç¢ºèª
    - ç‰¹ã«é™æ­¢ç”»ç‰ˆã¨ã®äº’æ›æ€§

â–  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

  ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºå‰Šæ¸›ã€‘
    - ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® .min.js ç‰ˆã‚’ä½¿ç”¨
    - ä¸è¦ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
    - terser ã§åœ§ç¸®ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

  ã€å®Ÿè¡Œé€Ÿåº¦æ”¹å–„ã€‘
    - ImageData ã®ä½¿ã„å›ã—
    - ä¸è¦ãªå†æç”»ã‚’é¿ã‘ã‚‹
    - Worker ã‚’æ´»ç”¨ï¼ˆGIFç”Ÿæˆï¼‰

  ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–ã€‘
    - destroy() ã§å¿…ãšãƒªã‚¹ãƒŠãƒ¼è§£é™¤
    - Blob URL ã¯ revokeObjectURL ã§è§£æ”¾
    - å¤§ããªé…åˆ—ã¯ null ä»£å…¥ã§ã‚¯ãƒªã‚¢

â–  ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

  ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ç¢ºèªã€‘
    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèª
    console.log(typeof window.UPNG);     // "object" ã¾ãŸã¯ "function"
    console.log(typeof window.pako);     // "object"
    console.log(typeof window.GIF);      // "function"
    
    // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç¢ºèª
    console.log(window.tegakiAnimeCore);
    
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
    const blob = await window.tegakiAnimeCore.exportAsApng();
    console.log('Blob size:', blob.size);

  ã€ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®å¯¾å¿œã€‘
    1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã
    2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨è¡Œç•ªå·ã‚’ç¢ºèª
    3. ã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ—ãŒãªã„å ´åˆã€dist/tegaki_anime.js ã‚’ç›´æ¥ç¢ºèª
    4. å•é¡Œã®ã‚ã‚‹é–¢æ•°ã‚’ç‰¹å®š
    5. src/*.js ã‚’ä¿®æ­£
    6. npm run build ã§å†ãƒ“ãƒ«ãƒ‰

  ã€CSPã‚¨ãƒ©ãƒ¼ã®ç¢ºèªã€‘
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ CSP ãƒãƒªã‚·ãƒ¼ã‚’è¡¨ç¤º
    console.log(document.querySelector('meta[http-equiv="Content-Security-Policy"]')?.content);
    
    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§ blocked ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª

================================================================================
11. FAQ
================================================================================

Q1: ãªãœ webpack ã‚„ Rollup ã‚’ä½¿ã‚ãªã„ã®ã‹ï¼Ÿ
A1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒ«ã§ bundler ä½¿ç”¨ãŒç¦æ­¢ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€‚
    Node.js ã® fs ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã£ãŸå˜ç´”ãªæ–‡å­—åˆ—çµåˆã§ä»£æ›¿ã€‚

Q2: ESM ã‚’ä½¿ã„ãŸã„å ´åˆã¯ï¼Ÿ
A2: ãƒ«ãƒ¼ãƒ«ä¸Šç¦æ­¢ã€‚ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’ IIFE ã§ãƒ©ãƒƒãƒ—ã—ã€
    window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆçµŒç”±ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“é€šä¿¡ã‚’è¡Œã†ã€‚

Q3: TypeScript ã¯ä½¿ãˆãªã„ã‹ï¼Ÿ
A3: ãƒ«ãƒ¼ãƒ«ä¸Šç¦æ­¢ã€‚å‹ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ãªå ´åˆã¯ã€
    JSDoc ã‚³ãƒ¡ãƒ³ãƒˆã§å‹æƒ…å ±ã‚’è¨˜è¿°ã—ã€VSCode ã®å‹ãƒã‚§ãƒƒã‚¯ã‚’æ´»ç”¨ã€‚

Q4: PixiJS ã‚‚çµ±åˆã§ãã‚‹ã‹ï¼Ÿ
A4: å¯èƒ½ã€‚ãŸã ã— PixiJS ã¯å¤§ãã„ãŸã‚ï¼ˆ500KBä»¥ä¸Šï¼‰ã€
    æœ¬å½“ã«å¿…è¦ã‹æ¤œè¨ã™ã‚‹ã“ã¨ã€‚ã‚¢ãƒ‹ãƒ¡ç‰ˆã§ã¯ Canvas2D ã®ã¿ã§å®Ÿè£…ã€‚

Q5: ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã‚’å¢—ã‚„ã›ã‚‹ã‹ï¼Ÿ
A5: å¯èƒ½ã€‚this.frameCount ã‚’å¤‰æ›´ã™ã‚Œã°OKã€‚
    ãŸã ã—ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ãŸã‚ã€5ãƒ•ãƒ¬ãƒ¼ãƒ ç¨‹åº¦ãŒæ¨å¥¨ã€‚

Q6: ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ä»¥å¤–ã®æ²ç¤ºæ¿ã«å¯¾å¿œã§ãã‚‹ã‹ï¼Ÿ
A6: å¯èƒ½ã€‚detectBoard() ã¨ findTargetElements() ã‚’ä¿®æ­£ã€‚
    å„æ²ç¤ºæ¿ã®HTMLæ§‹é€ ã«åˆã‚ã›ã¦ã‚»ãƒ¬ã‚¯ã‚¿ã‚’èª¿æ•´ã€‚

Q7: ãƒ“ãƒ«ãƒ‰ã‚’è‡ªå‹•åŒ–ã§ãã‚‹ã‹ï¼Ÿ
A7: å¯èƒ½ã€‚package.json ã® scripts ã« watch ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ :
    "watch": "nodemon --watch src --watch libs --exec 'npm run build'"
    npm install --save-dev nodemon

Q8: æœ¬ç•ªç’°å¢ƒã§å‹•ã‹ãªã„ãŒã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯å‹•ã
A8: GitHub Pages ã®URLãŒæ­£ã—ã„ã‹ç¢ºèªã€‚
    CORS ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã‹ç¢ºèªï¼ˆé€šå¸¸ã¯å‡ºãªã„ï¼‰ã€‚
    ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†è©¦è¡Œã€‚

================================================================================
12. ã¾ã¨ã‚
================================================================================

æœ¬è¨ˆç”»æ›¸ã§ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œãŠçµµã‹ããƒ„ãƒ¼ãƒ«ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸ:

ã€Phase 1ã€‘ç’°å¢ƒæ§‹ç¯‰
  - npm ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–
  - å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã€Phase 2ã€‘ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆ
  - build.js ã«ã‚ˆã‚‹è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®çµåˆ
  - Worker ã® Base64 åŸ‹ã‚è¾¼ã¿ã§ CSP å›é¿

ã€Phase 3ã€‘ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£…
  - TegakiAnimeCore ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…
  - APNG/GIF ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½

ã€Phase 4ã€‘ãƒ­ãƒ¼ãƒ€ãƒ¼å®Ÿè£…
  - ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ç”¨ãƒ­ãƒ¼ãƒ€ãƒ¼ã®å®Ÿè£…
  - æ²ç¤ºæ¿ã¸ã®ãƒ•ã‚¡ã‚¤ãƒ«æ³¨å…¥

ã€Phase 5ã€‘ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
  - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ§‹ç¯‰
  - GitHub Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ã€æ›éª¨å¥ªèƒã‚¬ã‚¤ãƒ‰ã€‘
  - æ—¢å­˜ãƒ„ãƒ¼ãƒ«ã‚’ä»Šå›ã®æ§‹æˆã«ç§»è¡Œã™ã‚‹æ‰‹é †
  - CDN ä¾å­˜ã®æ’é™¤æ–¹æ³•

ã“ã®æ§‹æˆã«ã‚ˆã‚Šã€ä»¥ä¸‹ã‚’é”æˆã—ã¾ã—ãŸ:

âœ… CSP åˆ¶ç´„ä¸‹ã§ã‚‚å‹•ä½œï¼ˆå¤–éƒ¨ä¾å­˜ãªã—ï¼‰
âœ… ãƒ«ãƒ¼ãƒ«éµå®ˆï¼ˆbundler/ESM/TypeScriptä¸ä½¿ç”¨ï¼‰
âœ… npm ã«ã‚ˆã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šï¼‰
âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒï¼ˆTegakiAniTest.htmlï¼‰
âœ… æœ¬ç•ªç’°å¢ƒå¯¾å¿œï¼ˆã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ï¼‰

å¾Œç¶šã®é–‹ç™ºè€…ã¯ã€ã“ã®è¨ˆç”»æ›¸ã‚’å‚ç…§ã™ã‚‹ã“ã¨ã§:
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å…¨ä½“åƒã‚’æŠŠæ¡
- å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²ã‚’ç†è§£
- æ–°æ©Ÿèƒ½ã®è¿½åŠ æ–¹æ³•ã‚’ç¿’å¾—
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å®Ÿæ–½

ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

================================================================================
END OF DOCUMENT
================================================================================

