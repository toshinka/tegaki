================================================================================
Tegaki Anime - æ–°æ©Ÿèƒ½å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
================================================================================

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
----------------
ç”»åƒæ²ç¤ºæ¿ï¼ˆã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ï¼‰ç”¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æç”»ãƒ„ãƒ¼ãƒ«ã€‚
CSPåˆ¶ç´„ã‚’å›é¿ã™ã‚‹ãŸã‚ã€å…¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’1ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±åˆã—ã¦ã„ã‚‹ã€‚

é‡è¦ãªåˆ¶ç´„
----------
âŒ CDNä½¿ç”¨ç¦æ­¢ï¼ˆCSPåˆ¶ç´„ã®ãŸã‚ï¼‰
âŒ bundler (webpack/rollup) ä½¿ç”¨ç¦æ­¢
âŒ ESM ä½¿ç”¨ç¦æ­¢
âŒ TypeScript ä½¿ç”¨ç¦æ­¢
âœ… npmï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ã¿ï¼‰
âœ… IIFE + windowå…¬é–‹ãƒ‘ã‚¿ãƒ¼ãƒ³

ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
------------
tegaki_anime_test/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ tegaki_anime_core.js    # â˜… æ–°æ©Ÿèƒ½ã¯ã“ã“ã«å®Ÿè£…
â”œâ”€â”€ libs/                        # npmã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒª
â”‚   â”œâ”€â”€ upng.js
â”‚   â”œâ”€â”€ pako.js
â”‚   â”œâ”€â”€ gif.js
â”‚   â””â”€â”€ gif.worker.js
â”œâ”€â”€ dist/
â”‚   â””â”€â”€ tegaki_anime.js          # ãƒ“ãƒ«ãƒ‰ç”Ÿæˆç‰©ï¼ˆç·¨é›†ç¦æ­¢ï¼‰
â”œâ”€â”€ build.js                     # ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆé€šå¸¸ç·¨é›†ä¸è¦ï¼‰
â”œâ”€â”€ tegaki-loader_anime.js       # ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆUIèª¿æ•´æ™‚ã®ã¿ç·¨é›†ï¼‰
â””â”€â”€ TegakiAniTest.html           # ãƒ†ã‚¹ãƒˆç”¨

åŸºæœ¬çš„ãªé–‹ç™ºãƒ•ãƒ­ãƒ¼
------------------
1. src/tegaki_anime_core.js ã‚’ç·¨é›†
2. npm run build ã‚’å®Ÿè¡Œ
3. TegakiAniTest.html ã§å‹•ä½œç¢ºèª
4. git commit & pushï¼ˆGitHub PagesãŒè‡ªå‹•æ›´æ–°ï¼‰

æ–°æ©Ÿèƒ½å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
------------------

ã€ãƒ‘ã‚¿ãƒ¼ãƒ³1: UIãƒœã‚¿ãƒ³ã®è¿½åŠ ã€‘
å ´æ‰€: createUI() ã¾ãŸã¯ createControlPanel() ãƒ¡ã‚½ãƒƒãƒ‰å†…

const newBtn = document.createElement('button');
newBtn.textContent = 'æ–°æ©Ÿèƒ½';
newBtn.style.cssText = `padding: 8px; background: #4ade80; color: white; border: none; cursor: pointer;`;
newBtn.onclick = () => this.executeNewFeature();
this.controlPanel.appendChild(newBtn);

ã€ãƒ‘ã‚¿ãƒ¼ãƒ³2: æç”»æ©Ÿèƒ½ã®è¿½åŠ ã€‘
å ´æ‰€: draw() ãƒ¡ã‚½ãƒƒãƒ‰å†…

draw(e) {
    if (!this.isDrawing) return;
    const rect = this.canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    // â˜… æ–°æ©Ÿèƒ½ã®å‡¦ç†ã‚’è¿½åŠ 
    if (this.newFeatureEnabled) {
        this.ctx.globalCompositeOperation = 'destination-out'; // æ¶ˆã—ã‚´ãƒ ç­‰
    }
    
    this.ctx.beginPath();
    this.ctx.moveTo(this.lastX, this.lastY);
    this.ctx.lineTo(x, y);
    this.ctx.stroke();
    this.lastX = x;
    this.lastY = y;
}

ã€ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼è¿½åŠ ã€‘
å ´æ‰€: registerDefaultKeys() ãƒ¡ã‚½ãƒƒãƒ‰å†…

registerDefaultKeys() {
    const km = this.keyManager;
    km.register('z', { ctrl: true }, () => this.undo(), 'Undo');
    km.register('y', { ctrl: true }, () => this.redo(), 'Redo');
    km.register('e', {}, () => this.switchTool('eraser'), 'Eraser'); // â˜… è¿½åŠ ä¾‹
}

ã€ãƒ‘ã‚¿ãƒ¼ãƒ³4: æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è¿½åŠ ã€‘
å ´æ‰€: constructor() ãƒ¡ã‚½ãƒƒãƒ‰å†…

constructor(container) {
    this.container = container;
    this.canvas = null;
    this.color = '#800000';
    this.size = 2;
    
    // â˜… æ–°æ©Ÿèƒ½ç”¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ 
    this.newFeatureEnabled = false;
    this.newFeatureValue = 0;
    
    this.init();
}

æ–°ã—ã„npmãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã™ã‚‹æ‰‹é †
----------------------------------
ä¾‹: Chart.js ã‚’è¿½åŠ ã—ãŸã„å ´åˆ

1. package.json ã® dependencies ã«è¿½åŠ :
{
  "dependencies": {
    "upng-js": "^2.1.0",
    "pako": "^2.1.0",
    "gif.js": "^0.2.0",
    "chart.js": "^4.0.0"  // â˜… è¿½åŠ 
  }
}

2. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:
npm install

3. å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’libs/ã«ã‚³ãƒ”ãƒ¼:
cp node_modules/chart.js/dist/chart.umd.js libs/chart.js

4. build.js ã® libraryFiles ã«è¿½åŠ :
const libraryFiles = [
    'libs/upng.js',
    'libs/pako.js',
    'libs/gif.js',
    'libs/chart.js'  // â˜… è¿½åŠ 
];

5. ãƒ“ãƒ«ãƒ‰:
npm run build

6. ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ãŒå¿…è¦ãªå ´åˆã¯ build.js ã® Global Exports ã«è¿½åŠ :
if (typeof Chart !== 'undefined') {
    window.Chart = Chart;
}

Workerã‚’å«ã‚€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ æ–¹æ³•
--------------------------------
ä¾‹: GIF.jsï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼‰ã‚’å‚è€ƒã«

1. Workerç”¨ã®JSãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ libs/ ã«ã‚³ãƒ”ãƒ¼
2. build.js ã§Workerã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰:

const workerCode = fs.readFileSync('libs/your.worker.js', 'utf8');
const workerBase64 = Buffer.from(workerCode).toString('base64');

3. Blob URLã¨ã—ã¦å…¬é–‹ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ :

output += `
(function() {
    const workerCode = atob('${workerBase64}');
    const blob = new Blob([workerCode], { type: 'application/javascript' });
    const workerUrl = URL.createObjectURL(blob);
    window.__yourWorkerUrl = workerUrl;
})();
`;

4. ã‚³ã‚¢å´ã§Blob URLã‚’ä½¿ç”¨:
const worker = new Worker(window.__yourWorkerUrl);

æ³¨æ„äº‹é …
--------
âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨
- dist/tegaki_anime.js ã‚’ç›´æ¥ç·¨é›†ï¼ˆãƒ“ãƒ«ãƒ‰ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰
- CDNã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆCSPåˆ¶ç´„ã§å‹•ã‹ãªã„ï¼‰
- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä¹±ç”¨ï¼ˆå¿…ãš window.* ã¾ãŸã¯ this.* çµŒç”±ï¼‰

âœ… æ¨å¥¨äº‹é …
- å°ã•ãå§‹ã‚ã‚‹: 1æ©Ÿèƒ½ãšã¤å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆ
- console.log ã‚’æ´»ç”¨: å‹•ä½œç¢ºèªã‚’é€ä¸€è¡Œã†
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒ: ä¼¼ãŸæ©Ÿèƒ½ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’çœŸä¼¼ã‚‹
- ãƒ“ãƒ«ãƒ‰ã‚’å¿˜ã‚Œãªã„: src/ ç·¨é›†å¾Œã¯å¿…ãš npm run build

ãƒ†ã‚¹ãƒˆæ–¹æ³•
----------
ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã€‘
npm run build
python -m http.server 8000
# http://localhost:8000/TegakiAniTest.html ã§ç¢ºèª

ã€æœ¬ç•ªãƒ†ã‚¹ãƒˆï¼ˆã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ï¼‰ã€‘
1. git push ã§GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
2. ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå®Ÿè¡Œ
3. å®Ÿéš›ã«æç”»â†’æŠ•ç¨¿ã—ã¦ç¢ºèª

ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
----------------------
Q: ãƒ“ãƒ«ãƒ‰å¾Œã‚‚å¤‰æ›´ãŒåæ˜ ã•ã‚Œãªã„
A: ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ï¼ˆCtrl+Shift+Rï¼‰

Q: æ–°ã—ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ undefined
A: build.js ã® Global Exports ã§windowã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

Q: Worker ãŒå‹•ã‹ãªã„
A: build.js ã§ Base64 åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã€Blob URL ãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

Q: CSPã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹
A: å¤–éƒ¨URLã‚’å‚ç…§ã—ã¦ã„ãªã„ã‹ç¢ºèªã€‚å…¨ã¦libs/ã‹ã‚‰èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹

å®Ÿè£…ä¾‹: æ¶ˆã—ã‚´ãƒ ãƒ„ãƒ¼ãƒ«ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚ˆã‚Šï¼‰
----------------------------------------
// constructor ã«è¿½åŠ 
this.tool = 'pen'; // 'pen' or 'eraser'
this.eraserSize = 10;

// ãƒ„ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆãƒ¡ã‚½ãƒƒãƒ‰
switchTool(tool) {
    this.tool = tool;
    if (tool === 'eraser') {
        this.ctx.globalCompositeOperation = 'destination-out';
        this.ctx.lineWidth = this.eraserSize;
    } else {
        this.ctx.globalCompositeOperation = 'source-over';
        this.ctx.lineWidth = this.size;
    }
}

// UIãƒœã‚¿ãƒ³è¿½åŠ ï¼ˆcreateControlPanelå†…ï¼‰
const eraserBtn = document.createElement('button');
eraserBtn.innerHTML = 'ğŸ§¹ æ¶ˆã—ã‚´ãƒ ';
eraserBtn.onclick = () => this.switchTool('eraser');

// ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¿½åŠ ï¼ˆregisterDefaultKeyså†…ï¼‰
km.register('e', {}, () => this.switchTool('eraser'), 'Eraser');

ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„
----------------
- IIFEã§å¿…ãšãƒ©ãƒƒãƒ—: (function() { 'use strict'; ... })();
- windowçµŒç”±ã§å…¬é–‹: window.TegakiAnimeCore = class { ... };
- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯å¿…ãšè§£é™¤: destroy() ã§removeEventListener
- å¤‰æ•°ã¯ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹: activeLayerIndex, frameCount
- async/await ã‚’ä½¿ç”¨: Promise.then ã‚ˆã‚Šå¯èª­æ€§ãŒé«˜ã„

ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã®ç¢ºèªãƒã‚¤ãƒ³ãƒˆ
----------------------------
âœ“ src/tegaki_anime_core.js ã®ã¿ç·¨é›†ã—ã¦ã„ã‚‹ã‹
âœ“ npm run build ã‚’å®Ÿè¡Œã—ãŸã‹
âœ“ dist/tegaki_anime.js ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç¢ºèªï¼‰
âœ“ ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã‹
âœ“ GitHub Pages ã«ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã‹ï¼ˆæœ¬ç•ªåæ˜ ï¼‰

ãƒ‡ãƒ—ãƒ­ã‚¤
--------
git add src/tegaki_anime_core.js dist/tegaki_anime.js
git commit -m "feat: Add new feature"
git push origin main
# GitHub Pages ãŒè‡ªå‹•æ›´æ–°ï¼ˆæ•°åˆ†ã‹ã‹ã‚‹ï¼‰

æœ¬ç•ªURL
-------
https://toshinka.github.io/tegaki/tegaki_anime_test/dist/tegaki_anime.js
https://toshinka.github.io/tegaki/tegaki_anime_test/tegaki-loader_anime.js

================================================================================
END OF DOCUMENT
================================================================================