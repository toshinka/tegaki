 âœ… config.js v8.14.3 Phase 1.7 ç­†åœ§å¯¾å¿œç‰ˆ loaded
    ğŸ”§ thinning: 0.7 (ç­†åœ§ã«ã‚ˆã‚‹å¤ªã•å¤‰åŒ–æœ‰åŠ¹)
    ğŸ”§ smoothing: 0.4 (é©åº¦ãªè£œé–“)
    ğŸ”§ streamline: 0.3 (å®‰å®šåŒ–)
 âœ… coordinate-system.js Phase 1.1 åº§æ¨™ã‚ºãƒ¬ä¿®æ­£ç‰ˆ loaded
    ğŸ”§ worldContainer.updateTransform()ä¿è¨¼
    ğŸ”§ NaN/Infinityæ¤œå‡ºè¿½åŠ 
    ğŸ”§ ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢å®Ÿè£…
 âœ… data-models.js (backgroundColorè¿½åŠ ç‰ˆ) loaded
 âœ… batch-api.js (Phase 6: Historyçµ±åˆç‰ˆ) loaded
 âœ… popup-manager.js (quick-accessé™¤å¤–å¯¾å¿œç‰ˆ) loaded
 âœ… state-manager.js (Phase 8å®Œå…¨å®Ÿè£…ç‰ˆ) loaded
 âœ… settings-manager.js Phase 2 loaded
    ğŸ”§ exportResolution è¨­å®šé …ç›®è¿½åŠ 
 âœ… layer-transform.js Phase 6 loaded
    ğŸ”§ flipLayer(): confirmTransform()å‰Šé™¤ - åè»¢æ™‚ã®ç”»åƒæ¶ˆå¤±ã‚’è§£æ±º
 âœ… system/checker-utils.js çµ±ä¸€å®Ÿè£…ç‰ˆ loaded
 âœ… layer-system.js Phase 8å®Œæˆç‰ˆ loaded
    âœ… getLayerById() ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
    âœ… LayerModel.id ç¢ºå®Ÿå–å¾—ä¿è¨¼
    âœ… history.js ã¨ã®çµ±åˆå¯¾å¿œå®Œäº†
 âœ… drawing-clipboard.js Phase 1 loaded
    ğŸ”§ cutActiveLayer(): æç”»ã®ã¿å‰Šé™¤ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ä¿æŒï¼‰
    ğŸ¨ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—: ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ”ãƒ¼ã€åˆ‡ã‚Šå–ã‚Š
 âœ… history.js Phase 4 mask snapshotå¯¾å¿œå®Œå…¨ç‰ˆ loaded
    âœ… pushEraseMask() å®Ÿè£…
    âœ… beginAction/endAction/addPoint å®Ÿè£…
 âœ… webgl2-drawing-layer.js Phase 1 loaded
 [GLStrokeProcessor] âœ… Singleton instance created
 [GLMSDFPipeline] âœ… Phase 1.8 Rollbackä¿®æ­£ç‰ˆ loaded
    âš ï¸ Phase 1.7ã®éå‰°ä¿®æ­£ã‚’å–ã‚Šæ¶ˆã—
    âœ… aPosition: [0, bounds.width/height] â†’ uResolutionã§æ­£è¦åŒ–
 âœ… gl-texture-bridge.js Phase 5å®Œå…¨ç‰ˆ (PixiJS v8å¯¾å¿œ) loaded
    âœ… WebGLTexture â†’ PIXI.Spriteå¤‰æ›å®Ÿè£…å®Œäº†
    âœ… PixiJS v8: Texture.from()ç›´æ¥ä½¿ç”¨ï¼ˆå®šæ•°å•é¡Œè§£æ±ºï¼‰
    âœ… WebGPUäº’æ›API (createSpriteFromGPUTexture) å¯¾å¿œ
 âœ… gl-mask-layer.js Phase 6å®Œå…¨ç‰ˆ loaded
    âœ… Circle mask renderingå®Ÿè£…
    âœ… Additive blendå¯¾å¿œ
    âœ… Compose Passçµ±åˆæº–å‚™å®Œäº†
 âœ… pointer-handler.js Phase 1 loaded
    ğŸ”§ pressureæ­£è¦åŒ–ä¿®æ­£ï¼ˆãƒã‚¦ã‚¹=0, ãƒšãƒ³=e.pressureï¼‰
    ğŸ”§ EventEmitteré¢¨APIå®Ÿè£…ï¼ˆ.on / .offï¼‰
 âœ… pressure-handler.js Phase 1 loaded
    ğŸ”§ ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æœªç¢ºå®šæ™‚ã«rawå€¤è¿”å´ï¼ˆ0.5å›ºå®šå‰Šé™¤ï¼‰
 âœ… stroke-recorder.js Phase 0 loaded
    âœ“ è‡ªå‹•åˆæœŸåŒ–å®Œäº†ï¼ˆinitialize()ä¸è¦ï¼‰
    âœ“ Localåº§æ¨™è¨˜éŒ²å°‚ç”¨ï¼ˆåº§æ¨™å¤‰æ›ãªã—ï¼‰
    âœ“ PerfectFreehandäº’æ›å½¢å¼å¯¾å¿œ
 âœ… stroke-renderer.js (WebGL2ç§»è¡Œç‰ˆ) loaded
    ğŸ”§ WebGPU â†’ WebGL2 å‚ç…§å¤‰æ›´å®Œäº†
 âœ… thumbnail-system.js (v1.1: çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¯¾å¿œ) loaded
 âœ… brush-settings.js (Phase 3-D Clean) loaded
 âœ… BlendMode definitions loaded
 âœ… vector-operations.js Phase 1å®Œå…¨ç‰ˆ loaded
    âœ“ window.VectorOperations.generateStrokePolygon(points, size)
    âœ“ config.js perfectFreehandè¨­å®šè‡ªå‹•é©ç”¨
    ğŸ”¥ PerfectFreehandçµ±åˆåŸºç›¤å®Œæˆ
 âœ… brush-core.js Phase 2.2 åº§æ¨™ã‚ºãƒ¬å®Œå…¨ä¿®æ­£ç‰ˆ loaded
    âœ… Spriteã‚¹ã‚±ãƒ¼ãƒ«ä¿®æ­£: 512å›ºå®š â†’ bounds.width/height
    âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é€æ˜åº¦: å®Ÿéš›ã®å€¤ã«ä¿®æ­£
    âœ… ãƒ†ã‚¯ã‚¹ãƒãƒ£å†åˆ©ç”¨ç¶­æŒ
 âœ… fill-tool.js (WebGPUç«¶åˆä¿®æ­£ç‰ˆ) loaded
    âŒ ç‹¬è‡ªWebGPUåˆæœŸåŒ–ã‚’å‰Šé™¤
    âœ… æ—¢å­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å‚ç…§ã®ã¿
 âœ… drawing-engine.js v8.14.2 Phase 1.1 åº§æ¨™ã‚ºãƒ¬å®Œå…¨ä¿®æ­£ç‰ˆ loaded
    ğŸ”§ CoordinateSystemåˆæœŸåŒ–è‡ªå‹•ä¿®å¾©æ©Ÿèƒ½è¿½åŠ 
    ğŸ”§ NaN/Infinityæ¤œå‡ºå¼·åŒ–ï¼ˆå…¨ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
    ğŸ”§ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Œå…¨åŒ–
    ğŸ”§ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰: window.TegakiDebug.drawing.*
 âœ… quick-export-ui.js (ç„¡åŠ¹åŒ–ç‰ˆ) loaded
 âœ… export-manager.js v8.33.0 loaded
    ğŸ”§ PNGâ†’APNGç¶­æŒ / WEBPâ†’WebMè‡ªå‹•åˆ‡æ›¿å¯¾å¿œ
 âœ… png-exporter.js v8.29.0 loaded
    ğŸ”§ generatePreview()ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
    ğŸ”§ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
    ğŸ”§ Blobç”Ÿæˆã®ç¢ºå®Ÿæ€§å‘ä¸Š
 âœ… webp-exporter.js v8.33.0 loaded (é™æ­¢ç”»WEBPå°‚ç”¨)
    âš ï¸ è¤‡æ•°ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚ã¯WebMæ¨å¥¨ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡å€¤ç¶­æŒãƒ»è»½é‡ï¼‰
 âœ… psd-exporter.js v8.18.0 loaded (Phase 5: ãƒœã‚¿ãƒ³é…ç½®ç”¨)
    âš ï¸ å®Ÿè£…ã¯å°†æ¥ãƒ•ã‚§ãƒ¼ã‚ºã§è¿½åŠ äºˆå®š
    âœ“ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§é–‹ç™ºä¸­ã‚’é€šçŸ¥
apng-exporter.js:281 âœ… apng-exporter.js v8.31.0 loaded
mp4-exporter.js:30 âœ… mp4-exporter.js (Phase 8å®Œæˆç‰ˆ) loaded
dom-builder.js:527 âœ… dom-builder.js v8.19.0 loaded
dom-builder.js:528    ğŸ”§ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³: PNG/WEBP/PSDï¼ˆGIF/PDFå‰Šé™¤ï¼‰
dom-builder.js:529    âœ“ Systemæƒ…å ±è¡¨ç¤ºï¼ˆWebGPU/GPUæ¤œå‡ºï¼‰
slider-utils.js:265 âœ… slider-utils.js v8.14.0 loaded
slider-utils.js:266    ğŸ”§ PointerEventé…ä¿¡å•é¡Œä¿®æ­£å®Œäº†
keyboard-handler.js:486 âœ… keyboard-handler.js Phase 6å®Œæˆç‰ˆ loaded
keyboard-handler.js:487    âœ… BS/DEL: æç”»å‰Šé™¤ãŒæ­£å¸¸å‹•ä½œ
keyboard-handler.js:488    âœ… Undo/Redo: childrenå‚ç…§ä¿æŒã§å®Œå…¨å¾©å…ƒ
keyboard-handler.js:489    ğŸ”§ åè»¢å‡¦ç†: ç”»åƒæ¶ˆå¤±å•é¡Œè§£æ±º
layer-panel-renderer.js:663 âœ… layer-panel-renderer.js (Phase 5+6å¯¾å¿œç‰ˆ) loaded
layer-panel-renderer.js:664    âœ“ layer:panel-update-requested ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
layer-panel-renderer.js:665    âœ“ LayerSystemã‹ã‚‰ã®ç›´æ¥å‘¼ã³å‡ºã—å®Œå…¨æ’é™¤
status-display-renderer.js:317 âœ… ui/status-display-renderer.js å®Œå…¨æ”¹ä¿®ç‰ˆ loaded
timeline-thumbnail-utils.js:258 âœ… ui/timeline-thumbnail-utils.js (Phase 3å®Œå…¨ç‰ˆ) loaded
timeline-thumbnail-utils.js:259    âœ“ Phase 1: layer:transform-updated è³¼èª­è¿½åŠ 
timeline-thumbnail-utils.js:260    âœ“ Phase 3: throttleæœ€é©åŒ–ï¼ˆ100msï¼‰
timeline-thumbnail-utils.js:261    âœ“ Phase 3: immediate ãƒ•ãƒ©ã‚°å¯¾å¿œ
timeline-thumbnail-utils.js:262    âœ“ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«ãŒãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢ã«å³åº§è¿½å¾“
timeline-ui.js:981 âœ… timeline-ui.js (Phase 4å®Œäº†: ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢é€£æºç‰ˆ) loaded
album-popup.js:473 âœ… album-popup.js (FRAMEæ”¹ä¿®ç‰ˆ) loaded
settings-popup.js:649 âœ… settings-popup.js Phase 1 loaded
settings-popup.js:650    ğŸ”§ ui:open-settings ãƒªã‚¹ãƒŠãƒ¼è¿½åŠ ï¼ˆCtrl+, å¯¾å¿œï¼‰
quick-access-popup.js:740 âœ… quick-access-popup.js v8.13.17 loaded
export-popup.js:557 âœ… export-popup.js v8.29.0 loaded
export-popup.js:558    ğŸ”§ PNGâ†’APNGç¶­æŒ / WEBPâ†’WebMè‡ªå‹•åˆ‡æ›¿UIå¯¾å¿œ
ui-panels.js:420 âœ… ui-panels.js v8.13.15 loaded
ui-panels.js:421    ğŸ¨ ã‚µã‚¤ãƒ‰ãƒãƒ¼è»½é‡ãƒ‡ã‚¶ã‚¤ãƒ³: ã‚ªãƒ¬ãƒ³ã‚¸æ ã®ã¿
ui-panels.js:422    ğŸ¯ SVGè‰²çµ±ä¸€: å¸¸ã«var(--futaba-maroon)
core-runtime.js:578 âœ… core-runtime.js (Phase 5 - UIä¾‹å¤–ä¿®æ­£ç‰ˆ) loaded
core-engine.js:767 âœ… core-engine.js Phase 4-Cå®Œå…¨ç‰ˆ loaded
core-engine.js:768    ğŸ”§ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµ±åˆå®Œäº†
core-engine.js:769    ğŸ”§ Master Loop: pointer â†’ preview â†’ render
index.html:111 ğŸš€ WebGL2 MSDFç‰ˆ èµ·å‹•ä¸­...
popup-manager.js:16 âœ… PopupManager initialized
popup-manager.js:42 ğŸ“‹ Popup "settings" registered (priority: 1)
popup-manager.js:42 ğŸ“‹ Popup "quickAccess" registered (priority: 2)
popup-manager.js:42 ğŸ“‹ Popup "album" registered (priority: 3)
popup-manager.js:42 ğŸ“‹ Popup "resize" registered (priority: 4)
popup-manager.js:102 ğŸ”§ Initializing all popups...
popup-manager.js:87 âœ… Popup "settings" initialized successfully
popup-manager.js:87 âœ… Popup "quickAccess" initialized successfully
popup-manager.js:87 âœ… Popup "album" initialized successfully
popup-manager.js:87 âœ… Popup "resize" initialized successfully
popup-manager.js:118 ğŸ“Š Popup initialization: 4 ready, 0 deferred
webgl2-drawing-layer.js:87 [WebGL2DrawingLayer] âœ… Initialized Object
core-initializer.js:189 [WebGL2] Drawing Layer initialized
gl-stroke-processor.js:48 [GLStrokeProcessor] âœ… Initialized (Phase 1.6)
core-initializer.js:198 [WebGL2] GLStrokeProcessor initialized
gl-msdf-pipeline.js:66 [GLMSDFPipeline] âœ… Initialized (Phase 1.8)
core-initializer.js:203 [WebGL2] GLMSDFPipeline initialized
gl-texture-bridge.js:51 [GLTextureBridge] âœ… Initialized (PixiJS v8)
core-initializer.js:211 [WebGL2] GLTextureBridge initialized
gl-mask-layer.js:82 [GLMaskLayer] âœ… Initialized Object
core-initializer.js:223 [WebGL2] GLMaskLayer initialized
stroke-renderer.js:76 [StrokeRenderer] âœ… Initialized (WebGL2 mode)
core-initializer.js:238 [WebGL2] StrokeRenderer initialized
core-initializer.js:240 [WebGL2] âœ… Phase 6 initialization complete
core-initializer.js:347 [App] Re-initializing BrushCore with WebGL2 components
core-initializer.js:383 [App] BrushCore already initialized, components updated
core-initializer.js:386 [App] âœ… BrushCore re-initialized with WebGL2 (Phase 6.1) Object
index.html:113 âœ… WebGL2åˆæœŸåŒ–å®Œäº†
popup-manager.js:42 ğŸ“‹ Popup "export" registered (priority: 5)
popup-manager.js:87 âœ… Popup "export" initialized successfully
/**
 * ============================================================================
 * drawing-engine.js v8.14.2 - Phase 1.1 åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œå…¨æ¤œè¨¼ç‰ˆ
 * ============================================================================
 * è²¬å‹™: PointerEventå—ä¿¡ãƒ»åº§æ¨™å¤‰æ›å®Ÿè¡Œãƒ»BrushCoreã¸ã®æç”»å‘½ä»¤å§”è­²
 * 
 * è¦ªä¾å­˜:
 *   - coordinate-system.js (CoordinateSystem) - åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
 *   - system/camera-system.js (cameraSystem) - ã‚«ãƒ¡ãƒ©å¤‰æ›ç®¡ç†
 *   - system/layer-system.js (layerManager) - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—
 *   - system/drawing/brush-core.js (BrushCore) - ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å‡¦ç†çµ±åˆ
 *   - system/drawing/pointer-handler.js (PointerHandler) - ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†
 * 
 * å­ä¾å­˜:
 *   - core-engine.js (åˆæœŸåŒ–å‘¼ã³å‡ºã—å…ƒã€renderPreviewå‘¼ã³å‡ºã—å…ƒ)
 * 
 * åº§æ¨™å¤‰æ›ãƒ•ãƒ­ãƒ¼:
 *   PointerEvent.clientX/Y
 *   â†’ screenClientToCanvas() [DPIè£œæ­£]
 *   â†’ canvasToWorld() [worldContaineré€†è¡Œåˆ—]
 *   â†’ worldToLocal() [æ‰‹å‹•é€†ç®—ãƒ»è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»]
 *   â†’ {localX, localY} â†’ BrushCore
 * 
 * å¤‰æ›´å±¥æ­´:
 *   v8.14.1: WebGL2ç§»è¡Œç‰ˆ
 *   v8.14.2 Phase 1.1: åº§æ¨™å¤‰æ›æ¤œè¨¼å¼·åŒ–ãƒ»åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼æ”¹å–„ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Œå…¨åŒ–
 * ============================================================================
 */

class DrawingEngine {
  constructor() {
    this.initialized = false;
    this.isDrawing = false;
    this.currentMode = 'pen';
    
    // ä¾å­˜é–¢ä¿‚
    this.coordSystem = null;
    this.cameraSystem = null;
    this.layerManager = null;
    this.brushCore = null;
    this.pointerHandler = null;
    this.eventBus = null;
    
    // Pointerç®¡ç†
    this.pendingPoints = [];
    this.maxPendingPoints = 3;
    this.lastFlushTime = 0;
    this.flushInterval = 16; // ~60fps
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ•ãƒ©ã‚°ï¼ˆé–‹ç™ºæ™‚ã®ã¿trueï¼‰
    this.DEBUG_TRANSFORM = false;
    
    // WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹å‚ç…§
    this.glCanvas = null;
    
    // åˆæœŸåŒ–è©¦è¡Œã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    this._initAttempts = 0;
    this._maxInitAttempts = 3;
  }

  /**
   * åˆæœŸåŒ–
   */
  initialize(dependencies) {
    if (this.initialized) {
      console.warn('[DrawingEngine] Already initialized');
      return true;
    }

    this._initAttempts++;

    const {
      coordSystem,
      cameraSystem,
      layerManager,
      brushCore,
      pointerHandler,
      eventBus,
      glCanvas
    } = dependencies;

    // å¿…é ˆä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    const missing = [];
    if (!coordSystem) missing.push('coordSystem');
    if (!cameraSystem) missing.push('cameraSystem');
    if (!layerManager) missing.push('layerManager');
    if (!brushCore) missing.push('brushCore');
    if (!pointerHandler) missing.push('pointerHandler');
    if (!eventBus) missing.push('eventBus');
    if (!glCanvas) missing.push('glCanvas');

    if (missing.length > 0) {
      console.error('[DrawingEngine] Missing dependencies:', missing);
      console.log(`[DrawingEngine] Init attempt ${this._initAttempts}/${this._maxInitAttempts}`);
      return false;
    }

    this.coordSystem = coordSystem;
    this.cameraSystem = cameraSystem;
    this.layerManager = layerManager;
    this.brushCore = brushCore;
    this.pointerHandler = pointerHandler;
    this.eventBus = eventBus;
    this.glCanvas = glCanvas;

    // CoordinateSystemåˆæœŸåŒ–ç¢ºèªãƒ»è‡ªå‹•ä¿®å¾©
    if (!this._ensureCoordinateSystemReady()) {
      console.error('[DrawingEngine] CoordinateSystem initialization failed');
      return false;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®š
    this._setupPointerHandlers();
    this._setupEventListeners();
    
    this.initialized = true;
    console.log('[DrawingEngine] âœ… Initialized v8.14.2 Phase 1.1', {
      coordSystemReady: this.coordSystem.initialized,
      glCanvasSize: { 
        width: this.glCanvas.width, 
        height: this.glCanvas.height 
      },
      brushCoreReady: !!this.brushCore
    });

    return true;
  }

  /**
   * CoordinateSystemåˆæœŸåŒ–ç¢ºèªãƒ»è‡ªå‹•ä¿®å¾©
   */
  _ensureCoordinateSystemReady() {
    if (this.coordSystem.initialized) {
      return true;
    }

    console.warn('[DrawingEngine] CoordinateSystem not initialized, attempting auto-fix...');

    // Pixiã‚¢ãƒ—ãƒªå–å¾—
    const pixiApp = window.pixiApp || window.app;
    
    if (!pixiApp) {
      console.error('[DrawingEngine] Cannot find Pixi app instance');
      return false;
    }

    if (!this.glCanvas) {
      console.error('[DrawingEngine] WebGL2 canvas not available');
      return false;
    }

    if (!this.eventBus) {
      console.error('[DrawingEngine] EventBus not available');
      return false;
    }

    try {
      this.coordSystem.initialize(this.glCanvas, pixiApp, this.eventBus);
      
      if (this.coordSystem.initialized) {
        console.log('[DrawingEngine] âœ… CoordinateSystem auto-initialized successfully');
        return true;
      } else {
        console.error('[DrawingEngine] CoordinateSystem auto-initialization failed');
        return false;
      }
    } catch (error) {
      console.error('[DrawingEngine] Error initializing CoordinateSystem:', error);
      return false;
    }
  }

  /**
   * Pointerãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®š
   */
  _setupPointerHandlers() {
    if (!this.pointerHandler) {
      console.warn('[DrawingEngine] PointerHandler not available');
      return;
    }

    // PointerDownã‚¤ãƒ™ãƒ³ãƒˆ
    this.pointerHandler.on('pointerdown', (e) => {
      this._handlePointerDown(e);
    });

    // PointerMoveã‚¤ãƒ™ãƒ³ãƒˆ
    this.pointerHandler.on('pointermove', (e) => {
      this._handlePointerMove(e);
    });

    // PointerUpã‚¤ãƒ™ãƒ³ãƒˆ
    this.pointerHandler.on('pointerup', (e) => {
      this._handlePointerUp(e);
    });

    if (this.DEBUG_TRANSFORM) {
      console.log('[DrawingEngine] Pointer handlers registered');
    }
  }

  /**
   * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
   */
  _setupEventListeners() {
    if (!this.eventBus) {
      console.warn('[DrawingEngine] EventBus not available');
      return;
    }

    this.eventBus.on('tool:changed', (data) => {
      this.currentMode = data.tool;
      if (this.DEBUG_TRANSFORM) {
        console.log('[DrawingEngine] Tool changed:', this.currentMode);
      }
    });
  }

  /**
   * ============================================================================
   * Pointer Event Handlers
   * ============================================================================
   */

  /**
   * PointerDownå‡¦ç†
   */
  _handlePointerDown(e) {
    if (!this.initialized) {
      console.warn('[DrawingEngine] Not initialized, ignoring pointerdown');
      return;
    }

    if (!this.brushCore) {
      console.error('[DrawingEngine] BrushCore not available');
      return;
    }

    const coords = this._transformPointerToLocal(e);
    if (!coords) {
      console.error('[DrawingEngine] Failed to transform pointer coords on pointerdown');
      return;
    }

    const pressure = e.pressure || 0.5;

    try {
      this.brushCore.startStroke(coords.localX, coords.localY, pressure);
      this.isDrawing = true;
      this.pendingPoints = [];
      this.lastFlushTime = performance.now();

      if (this.DEBUG_TRANSFORM) {
        console.log('[DrawingEngine] Stroke started', {
          local: { x: coords.localX, y: coords.localY },
          pressure
        });
      }
    } catch (error) {
      console.error('[DrawingEngine] Error starting stroke:', error);
      this.isDrawing = false;
    }
  }

  /**
   * PointerMoveå‡¦ç†
   */
  _handlePointerMove(e) {
    if (!this.isDrawing || !this.initialized) return;

    const coords = this._transformPointerToLocal(e);
    if (!coords) {
      if (this.DEBUG_TRANSFORM) {
        console.warn('[DrawingEngine] Failed to transform pointer coords on pointermove, skipping point');
      }
      return;
    }

    const pressure = e.pressure || 0.5;

    // Pending pointsã«ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°
    this.pendingPoints.push({
      localX: coords.localX,
      localY: coords.localY,
      pressure: pressure,
      timestamp: performance.now()
    });

    // ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºã¾ãŸã¯æ™‚é–“é–“éš”ã§ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
    const now = performance.now();
    if (
      this.pendingPoints.length >= this.maxPendingPoints ||
      now - this.lastFlushTime >= this.flushInterval
    ) {
      this.flushPendingPoints();
    }
  }

  /**
   * PointerUpå‡¦ç†
   */
  _handlePointerUp(e) {
    if (!this.isDrawing || !this.initialized) return;

    // æ®‹ã‚Šã®ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
    this.flushPendingPoints();

    try {
      if (this.brushCore) {
        this.brushCore.finalizeStroke();
      }

      if (this.DEBUG_TRANSFORM) {
        console.log('[DrawingEngine] Stroke finalized');
      }
    } catch (error) {
      console.error('[DrawingEngine] Error finalizing stroke:', error);
    } finally {
      this.isDrawing = false;
      this.pendingPoints = [];
    }
  }

  /**
   * Pending pointsãƒ•ãƒ©ãƒƒã‚·ãƒ¥
   */
  flushPendingPoints() {
    if (!this.brushCore || this.pendingPoints.length === 0) return;

    try {
      for (const point of this.pendingPoints) {
        this.brushCore.updateStroke(point.localX, point.localY, point.pressure);
      }

      this.pendingPoints = [];
      this.lastFlushTime = performance.now();
    } catch (error) {
      console.error('[DrawingEngine] Error flushing points:', error);
      this.pendingPoints = [];
    }
  }

  /**
   * ============================================================================
   * åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œï¼ˆPhase 1.1å¼·åŒ–ç‰ˆï¼‰
   * ============================================================================
   * PointerEvent â†’ Localåº§æ¨™ã¸ã®å¤‰æ›
   * 
   * ãƒ•ãƒ­ãƒ¼:
   *   PointerEvent.clientX/Y
   *   â†’ screenClientToCanvas() [DPIè£œæ­£]
   *   â†’ canvasToWorld() [worldContaineré€†è¡Œåˆ— + updateTransformä¿è¨¼]
   *   â†’ worldToLocal() [æ‰‹å‹•é€†ç®—ãƒ»è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ» + ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢]
   *   â†’ {localX, localY}
   * 
   * å„ã‚¹ãƒ†ãƒƒãƒ—ã§NaN/Infinityæ¤œå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
   */
  _transformPointerToLocal(e) {
    const coordSys = this.coordSystem;
    
    if (!coordSys || !coordSys.initialized) {
      console.error('[DrawingEngine] CoordinateSystem not initialized');
      return null;
    }

    if (this.DEBUG_TRANSFORM) {
      console.log('[_transformPointerToLocal] Input:', {
        clientX: e.clientX,
        clientY: e.clientY,
        pressure: e.pressure
      });
    }

    // Step 1: Screen â†’ Canvas
    const canvasCoords = coordSys.screenClientToCanvas(e.clientX, e.clientY);
    if (!canvasCoords) {
      console.error('[DrawingEngine] screenClientToCanvas failed');
      return null;
    }

    if (this.DEBUG_TRANSFORM) {
      console.log('[_transformPointerToLocal] Canvas:', canvasCoords);
    }

    // NaNæ¤œå‡º Step 1
    if (isNaN(canvasCoords.canvasX) || isNaN(canvasCoords.canvasY)) {
      console.error('[DrawingEngine] Canvas coords are NaN', canvasCoords);
      return null;
    }

    // Infinityæ¤œå‡º Step 1
    if (!isFinite(canvasCoords.canvasX) || !isFinite(canvasCoords.canvasY)) {
      console.error('[DrawingEngine] Canvas coords are Infinity', canvasCoords);
      return null;
    }

    // Step 2: Canvas â†’ World
    const worldCoords = coordSys.canvasToWorld(canvasCoords.canvasX, canvasCoords.canvasY);
    if (!worldCoords) {
      console.error('[DrawingEngine] canvasToWorld failed');
      return null;
    }

    if (this.DEBUG_TRANSFORM) {
      console.log('[_transformPointerToLocal] World:', worldCoords);
    }

    // NaNæ¤œå‡º Step 2
    if (isNaN(worldCoords.worldX) || isNaN(worldCoords.worldY)) {
      console.error('[DrawingEngine] World coords are NaN', worldCoords);
      return null;
    }

    // Infinityæ¤œå‡º Step 2
    if (!isFinite(worldCoords.worldX) || !isFinite(worldCoords.worldY)) {
      console.error('[DrawingEngine] World coords are Infinity', worldCoords);
      return null;
    }

    // Step 3: activeLayerå–å¾—
    const activeLayer = this.layerManager ? this.layerManager.getActiveLayer() : null;
    if (!activeLayer) {
      console.error('[DrawingEngine] No active layer');
      return null;
    }

    // activeLayeræ¤œè¨¼
    if (this.DEBUG_TRANSFORM) {
      console.log('[_transformPointerToLocal] ActiveLayer:', {
        id: activeLayer.id,
        label: activeLayer.label || activeLayer.name,
        position: activeLayer.position,
        parent: activeLayer.parent?.label || activeLayer.parent?.name || 'none',
        hasDrawingContainer: !!activeLayer.drawingContainer
      });
    }

    // Step 4: World â†’ Local
    const localCoords = coordSys.worldToLocal(
      worldCoords.worldX,
      worldCoords.worldY,
      activeLayer
    );

    if (!localCoords) {
      console.error('[DrawingEngine] worldToLocal failed');
      return null;
    }

    if (this.DEBUG_TRANSFORM) {
      console.log('[_transformPointerToLocal] Local:', localCoords);
    }

    // NaNæ¤œå‡º Step 3
    if (isNaN(localCoords.localX) || isNaN(localCoords.localY)) {
      console.error('[DrawingEngine] Local coords are NaN', {
        canvas: canvasCoords,
        world: worldCoords,
        local: localCoords
      });
      return null;
    }

    // Infinityæ¤œå‡º Step 3
    if (!isFinite(localCoords.localX) || !isFinite(localCoords.localY)) {
      console.error('[DrawingEngine] Local coords are Infinity', {
        canvas: canvasCoords,
        world: worldCoords,
        local: localCoords
      });
      return null;
    }

    return {
      localX: localCoords.localX,
      localY: localCoords.localY,
      worldX: worldCoords.worldX,
      worldY: worldCoords.worldY,
      canvasX: canvasCoords.canvasX,
      canvasY: canvasCoords.canvasY
    };
  }

  /**
   * ============================================================================
   * BrushCoreé€£æºãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå…ƒå®Ÿè£…ç¶™æ‰¿ï¼‰
   * ============================================================================
   */

  /**
   * ãƒ–ãƒ©ã‚·è¨­å®šæ›´æ–°ï¼ˆCoreEngineã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
   */
  setBrushSettings(settings) {
    if (!this.brushCore) {
      // åˆæœŸåŒ–ä¸­ã®å ´åˆã¯è­¦å‘Šã‚’å‡ºã•ãªã„
      if (this.initialized) {
        console.warn('[DrawingEngine] BrushCore not available');
      }
      return;
    }

    try {
      // BrushCoreã«è¨­å®šã‚’å§”è­²
      if (typeof this.brushCore.updateSettings === 'function') {
        this.brushCore.updateSettings(settings);
      } else if (typeof this.brushCore.setBrushSettings === 'function') {
        this.brushCore.setBrushSettings(settings);
      } else {
        console.warn('[DrawingEngine] BrushCore has no settings update method');
      }
    } catch (error) {
      console.error('[DrawingEngine] Error setting brush settings:', error);
    }
  }

  /**
   * ã‚«ãƒ©ãƒ¼å¤‰æ›´
   */
  setColor(color) {
    if (this.brushCore && typeof this.brushCore.setColor === 'function') {
      this.brushCore.setColor(color);
    }
  }

  /**
   * ã‚µã‚¤ã‚ºå¤‰æ›´
   */
  setSize(size) {
    if (this.brushCore && typeof this.brushCore.setSize === 'function') {
      this.brushCore.setSize(size);
    }
  }

  /**
   * ä¸é€æ˜åº¦å¤‰æ›´
   */
  setOpacity(opacity) {
    if (this.brushCore && typeof this.brushCore.setOpacity === 'function') {
      this.brushCore.setOpacity(opacity);
    }
  }

  /**
   * ãƒ„ãƒ¼ãƒ«å¤‰æ›´
   */
  setTool(tool) {
    this.currentMode = tool;
    if (this.brushCore && typeof this.brushCore.setMode === 'function') {
      this.brushCore.setMode(tool);
    }
  }

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆCoreEngineã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
   */
  renderPreview() {
    if (this.brushCore && typeof this.brushCore.renderPreview === 'function') {
      this.brushCore.renderPreview();
    }
  }

  /**
   * æç”»ä¸­ã‹ã©ã†ã‹
   */
  getIsDrawing() {
    return this.isDrawing;
  }

  /**
   * ============================================================================
   * ãƒ‡ãƒãƒƒã‚°ãƒ»æ¤œè¨¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   * ============================================================================
   */

  /**
   * ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
   */
  setDebugMode(enabled) {
    this.DEBUG_TRANSFORM = enabled;
    console.log(`[DrawingEngine] Debug mode: ${enabled}`);
  }

  /**
   * ç¾åœ¨ã®åº§æ¨™å¤‰æ›ã‚’ãƒ†ã‚¹ãƒˆ
   */
  testCoordinateTransform(clientX, clientY) {
    console.group('[DrawingEngine] Coordinate Transform Test');
    
    const mockEvent = { clientX, clientY, pressure: 0.5 };
    const result = this._transformPointerToLocal(mockEvent);
    
    if (result) {
      console.log('âœ… Transform successful:', result);
    } else {
      console.error('âŒ Transform failed');
    }
    
    console.groupEnd();
    return result;
  }

  /**
   * çŠ¶æ…‹æ¤œæŸ»
   */
  inspect() {
    console.group('[DrawingEngine] State Inspection');
    
    console.log('Version:', 'v8.14.2 Phase 1.1');
    console.log('Initialized:', this.initialized);
    console.log('IsDrawing:', this.isDrawing);
    console.log('CurrentMode:', this.currentMode);
    console.log('PendingPoints:', this.pendingPoints.length);
    
    console.log('Dependencies:', {
      coordSystem: !!this.coordSystem && this.coordSystem.initialized,
      cameraSystem: !!this.cameraSystem,
      layerManager: !!this.layerManager,
      brushCore: !!this.brushCore,
      pointerHandler: !!this.pointerHandler,
      eventBus: !!this.eventBus
    });
    
    console.log('GLCanvas:', {
      exists: !!this.glCanvas,
      width: this.glCanvas?.width,
      height: this.glCanvas?.height
    });
    
    if (this.layerManager) {
      const activeLayer = this.layerManager.getActiveLayer();
      console.log('ActiveLayer:', {
        exists: !!activeLayer,
        id: activeLayer?.id,
        label: activeLayer?.label || activeLayer?.name,
        hasParent: !!activeLayer?.parent,
        hasDrawingContainer: !!activeLayer?.drawingContainer
      });
    }
    
    console.groupEnd();
  }

  /**
   * ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
   */
  destroy() {
    this.isDrawing = false;
    this.pendingPoints = [];
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è§£é™¤ã¯å„ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å´ã§å®Ÿæ–½æ¸ˆã¿
    
    this.initialized = false;
    this.coordSystem = null;
    this.cameraSystem = null;
    this.layerManager = null;
    this.brushCore = null;
    this.pointerHandler = null;
    this.eventBus = null;
    this.glCanvas = null;
    
    console.log('[DrawingEngine] Destroyed');
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
if (typeof window !== 'undefined') {
  window.DrawingEngine = DrawingEngine;
  
  // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 
  window.TegakiDebug = window.TegakiDebug || {};
  window.TegakiDebug.drawing = {
    inspect: () => window.drawingEngine?.inspect(),
    enableDebug: () => window.drawingEngine?.setDebugMode(true),
    disableDebug: () => window.drawingEngine?.setDebugMode(false),
    testTransform: (x, y) => window.drawingEngine?.testCoordinateTransform(x, y)
  };
  
  console.log('âœ… drawing-engine.js v8.14.2 Phase 1.1 åº§æ¨™ã‚ºãƒ¬å®Œå…¨ä¿®æ­£ç‰ˆ loaded');
  console.log('   ğŸ”§ CoordinateSystemåˆæœŸåŒ–è‡ªå‹•ä¿®å¾©æ©Ÿèƒ½è¿½åŠ ');
  console.log('   ğŸ”§ NaN/Infinityæ¤œå‡ºå¼·åŒ–ï¼ˆå…¨ã‚¹ãƒ†ãƒƒãƒ—ï¼‰');
  console.log('   ğŸ”§ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Œå…¨åŒ–');
  console.log('   ğŸ”§ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰: window.TegakiDebug.drawing.*');
}
VM82:1 Uncaught SyntaxError: Identifier 'DrawingEngine' has already been declared
