// ç·Šæ€¥ãƒ‘ãƒƒãƒ: DrawingEngine.settingsã‚’å¼·åˆ¶çš„ã«åˆæœŸåŒ–ã—ã€P/E+ãƒ‰ãƒ©ãƒƒã‚°ã‚’å‹•ä½œã•ã›ã‚‹

console.log('=== ç·Šæ€¥ãƒ‘ãƒƒãƒé©ç”¨ ===\n');

// 1. DrawingEngine.settingsã‚’å¼·åˆ¶åˆæœŸåŒ–
const de = window.coreEngine?.drawingEngine || window.drawingApp?.drawingEngine;

if (!de) {
  console.log('âŒ DrawingEngine not found');
} else {
  const BrushSettingsClass = window.TegakiDrawing?.BrushSettings || window.BrushSettings;
  
  if (!BrushSettingsClass) {
    console.log('âŒ BrushSettings not found');
  } else {
    // BrushSettingsåˆæœŸåŒ–
    if (!de.settings) {
      de.settings = new BrushSettingsClass(de.config, de.eventBus);
      console.log('âœ… DrawingEngine.settings åˆæœŸåŒ–å®Œäº†');
    }
    
    // _ensureBrushSettings()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
    de._ensureBrushSettings = function() {
      return !!this.settings;
    };
    console.log('âœ… DrawingEngine._ensureBrushSettings() è¿½åŠ ');
    
    // ToolSizeManagerã®penSize/Opacityã‚’åŒæœŸ
    if (window.toolSizeManager) {
      window.toolSizeManager.penSize = de.settings.getBrushSize();
      window.toolSizeManager.penOpacity = de.settings.getBrushOpacity();
      console.log('âœ… ToolSizeManager åˆæœŸå€¤åŒæœŸ');
      console.log('   - penSize:', window.toolSizeManager.penSize);
      console.log('   - penOpacity:', window.toolSizeManager.penOpacity);
    }
    
    // EventBusé€šçŸ¥
    if (de.eventBus) {
      de.eventBus.emit('brush:initialized', { settings: de.settings });
      console.log('âœ… brush:initialized ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«');
    }
  }
}

// 2. å‹•ä½œç¢ºèª
console.log('\n=== å‹•ä½œç¢ºèª ===');

setTimeout(() => {
  // DrawingEngineç¢ºèª
  console.log('1. DrawingEngine.settings:', !!de?.settings);
  if (de?.settings) {
    console.log('   - getBrushSize():', de.settings.getBrushSize());
    console.log('   - getBrushOpacity():', de.settings.getBrushOpacity());
  }
  
  // ToolSizeManagerç¢ºèª
  if (window.toolSizeManager) {
    const bs = window.toolSizeManager._getBrushSettings();
    console.log('2. ToolSizeManager._getBrushSettings():', !!bs);
    
    if (bs) {
      console.log('   âœ… æ¥ç¶šæˆåŠŸ!');
    } else {
      console.log('   âŒ ã¾ã æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }
  }
  
  // EventBusãƒªã‚¹ãƒŠãƒ¼ç¢ºèª
  if (window.TegakiEventBus?._listeners) {
    const listeners = window.TegakiEventBus._listeners;
    console.log('3. EventBusãƒªã‚¹ãƒŠãƒ¼:');
    console.log('   - tool:drag-size-start:', listeners['tool:drag-size-start']?.length || 0);
    console.log('   - tool:drag-size-update:', listeners['tool:drag-size-update']?.length || 0);
    console.log('   - tool:drag-size-end:', listeners['tool:drag-size-end']?.length || 0);
  }
  
  // å®Ÿéš›ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã—ã¦ãƒ†ã‚¹ãƒˆ
  console.log('\n4. ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ãƒ†ã‚¹ãƒˆ:');
  if (window.TegakiEventBus && de?.settings) {
    const initialSize = de.settings.getBrushSize();
    const initialOpacity = de.settings.getBrushOpacity();
    
    console.log('   åˆæœŸå€¤ - size:', initialSize, 'opacity:', initialOpacity);
    
    // drag-size-start
    window.TegakiEventBus.emit('tool:drag-size-start', {
      tool: 'pen',
      startSize: initialSize,
      startOpacity: initialOpacity
    });
    
    // drag-size-update (ã‚µã‚¤ã‚º+5, é€æ˜åº¦-0.1)
    window.TegakiEventBus.emit('tool:drag-size-update', {
      tool: 'pen',
      deltaX: 50,  // ã‚µã‚¤ã‚º+5
      deltaY: -20  // é€æ˜åº¦-0.1
    });
    
    setTimeout(() => {
      const newSize = de.settings.getBrushSize();
      const newOpacity = de.settings.getBrushOpacity();
      
      console.log('   æ›´æ–°å¾Œ - size:', newSize, 'opacity:', newOpacity);
      
      if (newSize !== initialSize || newOpacity !== initialOpacity) {
        console.log('   âœ… ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†æˆåŠŸ!');
      } else {
        console.log('   âŒ å€¤ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
      
      // drag-size-end
      window.TegakiEventBus.emit('tool:drag-size-end');
    }, 50);
  }
  
}, 200);

console.log('\n=== ãƒ‘ãƒƒãƒé©ç”¨å®Œäº† ===');
console.log('\nğŸ’¡ å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ:');
console.log('Pã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ãƒã‚¦ã‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„');
console.log('ç”»é¢å·¦ä¸Šã«è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™');