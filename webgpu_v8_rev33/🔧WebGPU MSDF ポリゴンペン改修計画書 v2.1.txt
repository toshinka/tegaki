================================================================================
WebGPU MSDF ãƒãƒªã‚´ãƒ³ãƒšãƒ³æ”¹ä¿®è¨ˆç”»æ›¸ v2.1ï¼ˆrev30å®Œå…¨åˆ†æç‰ˆï¼‰
================================================================================

â–  GPT5ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ¤œè¨¼çµæœ
================================================================================

ã€çµè«–ã€‘âœ… ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯90%æ­£ç¢º - ãŸã ã—rev30ã§ã¯ä¸€éƒ¨æ”¹ä¿®æ¸ˆã¿

ã€ç¾çŠ¶åˆ†æï¼šrev30ã®çŠ¶æ…‹ã€‘

å®Ÿè£…æ¸ˆã¿ï¼š
âœ… gpu-stroke-processor.js: createPolygonVertexBuffer() å®Ÿè£…å®Œäº†
âœ… msdf-seed-init.wgsl: Bresenhamè£œé–“å®Ÿè£…å®Œäº†
âœ… msdf-quad-expansion.wgsl: Vertex Shaderå®Ÿè£…å®Œäº†
âœ… brush-core.js: edgeCountæ˜ç¤ºå¯¾å¿œå®Œäº†

æœªå®Œæˆï¼š
âŒ msdf-pipeline-manager.js: Polygon Pipelineæœªçµ±åˆ
   â†’ polygonRenderPipelineä½œæˆæ¸ˆã¿ã ãŒå‘¼ã³å‡ºã—ãƒ•ãƒ­ãƒ¼æœªçµ±åˆ
âŒ msdf-quad-expansion.wgsl: å®Ÿè£…ã‚ã‚‹ãŒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ç¹‹ãŒã£ã¦ã„ãªã„
âŒ æ¶ˆã—ã‚´ãƒ ãƒã‚¹ã‚¯å‡¦ç†: GPU Computeæœªå®Ÿè£…
âŒ æ—§ã‚³ãƒ¼ãƒ‰å‰Šé™¤: polygon-generator.jsç­‰ãŒæ®‹å­˜


ã€ç—‡çŠ¶ã¨åŸå› ã®å¯¾å¿œï¼ˆrev30ç‰¹æœ‰ï¼‰ã€‘

ç—‡çŠ¶                     | æ ¹æœ¬åŸå› 
------------------------|--------------------------------------------------
ãƒšãƒ³ãŒå››è§’ã«ãªã‚‹          | âœ…Bresenhamå®Ÿè£…æ¸ˆã¿ âŒã§ã‚‚Quadå±•é–‹ãƒ‘ã‚¹æœªçµ±åˆ
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æç”»ã•ã‚Œãªã„  | âš ï¸GPUåŒæœŸå¾…ã¡å®Ÿè£…æ¸ˆã¿ âŒã§ã‚‚ä¸å®Œå…¨
ã‚¸ãƒ£ã‚®ãƒ¼ã«ãªã‚‹           | âš ï¸JFAå®Ÿè£…æ¸ˆã¿ âŒã§ã‚‚Seedç”Ÿæˆå¾Œã®çµŒè·¯ãŒæ—§ç‰ˆ
æ¶ˆã—ã‚´ãƒ ãŒé»’ãƒšãƒ³åŒ–       | âŒwebgpu-mask-layerçµ±åˆãªã—
æç”»ã®ä¸å®‰å®šæ€§           | âŒPolygonãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨Edgeãƒãƒƒãƒ•ã‚¡ãŒäºŒé‡å­˜åœ¨


â–  ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆrev30å®Ÿè£…åˆ†æï¼‰
================================================================================

ã€Phase 1: Pointer â†’ Pointsè¨˜éŒ²ã€‘âœ…å®Œå…¨æ­£å¸¸
drawing-engine.js
   â†“
brush-core.js: updateStroke()
   â†“
strokeRecorder.addPoint({x: localX, y: localY, pressure})


ã€Phase 2: Strokeçµ‚äº†å‡¦ç†ã€‘âš ï¸ã“ã“ã‹ã‚‰å•é¡Œé–‹å§‹
brush-core.js: _finalizeMSDFStroke()
   â†“
ğŸ” Step 1: Polygon Vertex Bufferç”Ÿæˆ
   gpuStrokeProcessor.createPolygonVertexBuffer(points)
   â†’ âœ… {buffer: Float32Array[prev,curr,next,side], vertexCount} æ­£å¸¸ç”Ÿæˆ
   â†“
   uploadToGPU(vertexBuffer, 'vertex', 7*4)
   â†’ âœ… gpuVertexBufferç”ŸæˆæˆåŠŸ
   â†“
ğŸ” Step 2: Edge Bufferç”Ÿæˆ
   gpuStrokeProcessor.createEdgeBuffer(points)
   â†’ âœ… {buffer: Float32Array[x0,y0,x1,y1,...], edgeCount} æ­£å¸¸ç”Ÿæˆ
   â†“
   uploadToGPU(edgeBuffer, 'storage', 8*4)
   â†’ âœ… gpuEdgeBufferç”ŸæˆæˆåŠŸ
   â†“
ğŸ” Step 3: MSDF Pipelineå‘¼ã³å‡ºã—
   msdfPipelineManager.generateMSDF(
     gpuEdgeBuffer,        â† EdgeBuffer
     bounds,
     null,
     brushSettings,
     gpuVertexBuffer,      â† VertexBuffer
     vertexCount,          â† æ¸¡ã—ã¦ã„ã‚‹
     edgeCount             â† æ¸¡ã—ã¦ã„ã‚‹
   )
   â†“
   âš ï¸å•é¡Œç®‡æ‰€: generateMSDFå†…éƒ¨
      â†“
      ğŸ”€ _seedInitPass(gpuEdgeBuffer, seedTex, width, height, edgeCount)
         â†’ msdf-seed-init.wgsl: Bresenhamç·šè£œé–“
         â†’ âœ…å®Ÿè£…æ¸ˆã¿ãƒ»æ­£å¸¸å‹•ä½œ
      â†“
      ğŸ”€ _executeJFA(seedTex, width, height)
         â†’ msdf-jfa-pass.wgsl: è·é›¢å ´ç”Ÿæˆ
         â†’ âœ…å®Ÿè£…æ¸ˆã¿ãƒ»æ­£å¸¸å‹•ä½œ
      â†“
      ğŸ”€ _encodePass(seedTex, gpuEdgeBuffer, msdfTex, width, height, edgeCount)
         â†’ msdf-encode.wgsl: MSDFç¬¦å·åŒ–
         â†’ âœ…å®Ÿè£…æ¸ˆã¿ãƒ»æ­£å¸¸å‹•ä½œ
      â†“
      ğŸš¨ã“ã“ãŒå•é¡ŒğŸš¨
      if (vertexBuffer && vertexCount > 0) {
        _renderMSDFPolygon(msdfTex, vertexBuffer, vertexCount, ...)
      } else {
        _renderMSDF(msdfTex, width, height, ...)  â† ã“ã£ã¡ã«å…¥ã‚‹
      }
      â†“
   âŒ _renderMSDFPolygon()ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŒå‘¼ã°ã‚Œãªã„
   âŒ _renderMSDF()ã¯ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³Quadæç”»ï¼ˆ4é ‚ç‚¹ï¼‰
   âŒ Quadå±•é–‹æœªå®Ÿè¡Œ â†’ å››è§’ã„MSDFãŒãã®ã¾ã¾æç”»


ã€Phase 3: Spriteé…ç½®ã€‘âš ï¸å½¢çŠ¶ã¯å››è§’ã ãŒé…ç½®ã¯æ­£å¸¸
brush-core.js
   â†“
layerSystem.addPathToActiveLayer(pathData)
   â†’ pathData.sprite = Sprite(msdfTexture)
   â†’ âš ï¸ Spriteã¯æ­£å¸¸ã ãŒå››è§’ãƒ†ã‚¯ã‚¹ãƒãƒ£


ã€Phase 4: æ¶ˆã—ã‚´ãƒ å•é¡Œã€‘âŒå®Œå…¨æœªå®Ÿè£…
brush-core.js: _finalizeMSDFStroke()
   â†’ settings.mode === 'eraser' åˆ†å²ãªã—
   â†’ âŒ GPUå´ãƒã‚¹ã‚¯å‡¦ç†æœªå®Ÿè£…
   â†’ msdf-render.wgsl: vec4(color.rgb, alpha) å‡ºåŠ›
   â†’ æ¶ˆã—ã‚´ãƒ ãŒè‰²ä»˜ããƒšãƒ³ã¨ã—ã¦æç”»


â–  å•é¡Œã®æœ¬è³ªï¼ˆrev30ç‰¹æœ‰ï¼‰
================================================================================

ğŸ”¥æœ€é‡è¦å•é¡Œï¼š
msdf-pipeline-manager.js: generateMSDF()ã®åˆ†å²åˆ¤å®šãŒèª¤å‹•ä½œ

ã€ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ï¼ˆ481-487è¡Œç›®ï¼‰ã€‘
```
if (vertexBuffer && vertexCount > 0) {
  finalTexture = await this._renderMSDFPolygon(...);
} else {
  finalTexture = await this._renderMSDF(...);
}
```

ã€å•é¡Œç‚¹ã€‘
âŒ brush-core.jsã‹ã‚‰å¼•æ•°ã¯æ­£ã—ãæ¸¡ã•ã‚Œã¦ã„ã‚‹ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰
âŒ vertexBufferã¯GPUBufferã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
âŒ ã—ã‹ã— _renderMSDFPolygon()å†…ã§ vertexBuffer ãŒæ­£ã—ãä½¿ã‚ã‚Œã¦ã„ãªã„
âŒ _renderMSDFPolygon()ã®bindGroupãŒãŠã‹ã—ã„å¯èƒ½æ€§


ã€_renderMSDFPolygon()ã®å•é¡Œï¼ˆ388-460è¡Œç›®ï¼‰ã€‘

å•é¡Œ1: BindGroupæ§‹é€ ãŒè¤‡é›‘
   â†’ @group(0): QuadUniforms
   â†’ @group(1): Sampler/Texture/RenderUniforms/Color
   â†’ msdf-quad-expansion.wgslã¨æ•´åˆæ€§å–ã‚Œã¦ã„ãªã„ï¼Ÿ

å•é¡Œ2: setVertexBuffer()å‘¼ã³å‡ºã—ã¯ã‚ã‚‹ï¼ˆ435è¡Œç›®ï¼‰
   â†’ renderPass.setVertexBuffer(0, vertexBuffer);
   â†’ å¼•æ•°vertexBufferã¯GPUBufferã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¯ãš
   â†’ ã—ã‹ã—Vertex Shaderå´ã§å—ã‘å–ã‚Œã¦ã„ãªã„ï¼Ÿ

å•é¡Œ3: msdf-quad-expansion.wgsl ã¨ã®ä¸æ•´åˆ
   â†’ Vertex Shaderã®entry pointã¯ "main"
   â†’ _createPipelines()ã§ entryPoint: 'main' æŒ‡å®šï¼ˆ141è¡Œç›®ï¼‰
   â†’ âœ…ã“ã‚Œã¯æ­£ã—ã„
   â†’ âŒã§ã‚‚BindGroup @group(0) ã®æ§‹é€ ãŒé•ã†å¯èƒ½æ€§


â–  ãƒ•ã‚¡ã‚¤ãƒ«è²¬å‹™åˆ†æï¼ˆDRY/SOLIDé•åæ¤œå‡ºï¼‰
================================================================================

ã€äºŒé‡å®Ÿè£…æ¤œå‡ºã€‘

æ©Ÿèƒ½                    | å®Ÿè£…ç®‡æ‰€1 | å®Ÿè£…ç®‡æ‰€2 | çŠ¶æ…‹
-----------------------|----------|----------|----------
Polygoné ‚ç‚¹ç”Ÿæˆ         | âœ…gpu-stroke-processor | âŒãªã— | æ­£å¸¸
EdgeBufferç”Ÿæˆ          | âœ…gpu-stroke-processor | âŒãªã— | æ­£å¸¸
SeedåˆæœŸåŒ–             | âœ…msdf-seed-init | âŒæ—§ç‰ˆå‰Šé™¤æ¸ˆã¿ | æ­£å¸¸
JFAå®Ÿè¡Œ                | âœ…msdf-jfa-pass | âŒæ—§ç‰ˆå‰Šé™¤æ¸ˆã¿ | æ­£å¸¸
MSDF Encode            | âœ…msdf-encode | âŒæ—§ç‰ˆå‰Šé™¤æ¸ˆã¿ | æ­£å¸¸
Render Pipeline        | âš ï¸2ç³»çµ±å­˜åœ¨ | - | ğŸš¨è¦çµ±åˆ
  â”œ _renderMSDF        | ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³Quad | - | ğŸ—‘ï¸å‰Šé™¤å€™è£œ
  â”” _renderMSDFPolygon | Polygon Vertexå±•é–‹ | - | âœ…æ®‹ã™
æ¶ˆã—ã‚´ãƒ å‡¦ç†            | âŒæœªå®Ÿè£… | - | ğŸ”§è¦è¿½åŠ 


ã€å‰Šé™¤å€™è£œãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœªå‰Šé™¤æ®‹å­˜ï¼‰ã€‘

ãƒ•ã‚¡ã‚¤ãƒ«                    | çŠ¶æ…‹ | å‰Šé™¤å¯å¦
--------------------------|------|----------
polygon-generator.js      | ğŸ—‘ï¸æœªä½¿ç”¨ | âœ…å‰Šé™¤å¯èƒ½
webgpu-geometry-layer.js  | ğŸ—‘ï¸æœªä½¿ç”¨ | âœ…å‰Šé™¤å¯èƒ½
webgpu-compute-sdf.js     | ğŸ—‘ï¸æœªä½¿ç”¨ | âœ…å‰Šé™¤å¯èƒ½
webgpu-compute-msdf.js    | ğŸ—‘ï¸æœªä½¿ç”¨ | âœ…å‰Šé™¤å¯èƒ½


â–  ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ã‚·ãƒ³ãƒœãƒ«è¾å…¸ï¼ˆrev30å®Ÿè£…ï¼‰
================================================================================

ã€gpu-stroke-processor.jsã€‘âœ…å®Ÿè£…å®Œäº†

createPolygonVertexBuffer(points)
  å…¥åŠ›: [{x,y,pressure}, ...] ã¾ãŸã¯ [x,y, ...]
  å‡ºåŠ›: {buffer: Float32Array, vertexCount: number}
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†
  stride: 7 floats = 28 bytes
  å†…å®¹: [prev.x, prev.y, curr.x, curr.y, next.x, next.y, side]

createEdgeBuffer(points)
  å…¥åŠ›: åŒä¸Š
  å‡ºåŠ›: {buffer: Float32Array, edgeCount: number}
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†
  stride: 8 floats = 32 bytes
  å†…å®¹: [x0, y0, x1, y1, edgeId, channelId, insideFlag, padding]

uploadToGPU(data, usage, elementStrideBytes)
  å…¥åŠ›: Float32Array, 'vertex' | 'storage', stride
  å‡ºåŠ›: {gpuBuffer: GPUBuffer, elementCount: number}
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†
  å¤‰æ›´: Phase1-FIXã§elementCountè¿”å´å¯¾å¿œæ¸ˆã¿

calculateBounds(points)
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†
  margin: 50px


ã€msdf-pipeline-manager.jsã€‘âš ï¸éƒ¨åˆ†å®Ÿè£…

_createPipelines()
  å®Ÿè£…çŠ¶æ…‹: âœ… polygonRenderPipelineä½œæˆæ¸ˆã¿
  å•é¡Œ: BindGroupæ§‹é€ ã¨WGSLã®ä¸æ•´åˆ

generateMSDF(gpuBuffer, bounds, existingMSDF, settings, vertexBuffer, vertexCount, edgeCount)
  å®Ÿè£…çŠ¶æ…‹: âš ï¸å¼•æ•°å—ã‘å–ã‚Šæ¸ˆã¿ãƒ»åˆ†å²å‡¦ç†ã‚ã‚Š
  å•é¡Œ: _renderMSDFPolygon()ã¸ã®æ¸¡ã—æ–¹ãŒä¸é©åˆ‡

_seedInitPass(gpuBuffer, seedTexture, width, height, edgeCount)
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†
  GPUåŒæœŸ: await device.queue.onSubmittedWorkDone()å¯¾å¿œæ¸ˆã¿

_executeJFA(seedTexture, width, height)
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†
  è¤‡æ•°ãƒ‘ã‚¹å®Ÿè¡Œ: steps = ceil(log2(maxDim))

_encodePass(seedTexture, gpuBuffer, msdfTexture, width, height, edgeCount)
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†

_renderMSDF(msdfTexture, width, height, settings)
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†
  å•é¡Œ: ã“ã‚ŒãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçµŒè·¯ã«ãªã£ã¦ã„ã‚‹
  ç”¨é€”: ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³Quadæç”»ï¼ˆdraw(4)ï¼‰
  å‰Šé™¤å¯å¦: ğŸ—‘ï¸Polygonçµ±åˆå¾Œã¯å‰Šé™¤

_renderMSDFPolygon(msdfTexture, vertexBuffer, vertexCount, width, height, settings)
  å®Ÿè£…çŠ¶æ…‹: âš ï¸å®Ÿè£…ã‚ã‚Šãƒ»å‹•ä½œä¸å…¨
  å•é¡Œç®‡æ‰€:
    - Line 398: bindGroup0ä½œæˆ
    - Line 407: bindGroup1ä½œæˆ
    - Line 435: setVertexBuffer(0, vertexBuffer)
    - Line 436-437: setBindGroup(0/1)
    - Line 438: draw(vertexCount, 1)
  æ¨å®šåŸå› : BindGroupã¨WGSL @groupå®šç¾©ã®ä¸ä¸€è‡´


ã€msdf-quad-expansion.wgslã€‘âœ…å®Ÿè£…å®Œäº†ãƒ»æœªçµ±åˆ

struct VertexInput
  @location(0) prev: vec2<f32>
  @location(1) curr: vec2<f32>
  @location(2) next: vec2<f32>
  @location(3) side: f32

struct QuadUniforms
  canvasWidth/Height/halfWidth/padding

@group(0) @binding(0) var<uniform> uQuad: QuadUniforms
  â†‘ã“ã“ãŒå•é¡Œï¼šmsdf-pipeline-manager.jsã®bindGroup0ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ï¼Ÿ

@vertex fn main(in: VertexInput) -> VertexOutput
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†
  å‡¦ç†: tangentè¨ˆç®— â†’ normalè¨ˆç®— â†’ offseté©ç”¨ â†’ NDCå¤‰æ›


ã€msdf-render.wgslã€‘âœ…å®Ÿè£…å®Œäº†

@group(1) @binding(0) var msdfSampler: sampler;
@group(1) @binding(1) var msdfTex: texture_2d<f32>;
@group(1) @binding(2) var<uniform> uRender: RenderUniforms;
@group(1) @binding(3) var<uniform> uColor: vec4<f32>;

@fragment fn main(input: VertexOutput) -> @location(0) vec4<f32>
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†
  å‡¦ç†: MSDF sampling â†’ median() â†’ smoothstep() â†’ coloré©ç”¨

@vertex fn vertMain(@builtin(vertex_index) vertexIndex: u32)
  ç”¨é€”: ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³Quadç”¨
  å‰Šé™¤å¯å¦: ğŸ—‘ï¸Polygonçµ±åˆå¾Œã¯ä¸è¦


ã€brush-core.jsã€‘âœ…å®Ÿè£…å®Œäº†ãƒ»å‘¼ã³å‡ºã—æ­£å¸¸

_finalizeMSDFStroke(points, activeLayer)
  å®Ÿè£…çŠ¶æ…‹: âœ…å®Œäº†
  å•é¡Œãªã—: å¼•æ•°æ¸¡ã—ã¯æ­£å¸¸
  æ”¹ä¿®ä¸è¦: ãŸã ã—æ¶ˆã—ã‚´ãƒ åˆ†å²ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ã‚ã‚Š


ã€stroke-renderer.jsã€‘âš ï¸æ—§ãƒ¡ã‚½ãƒƒãƒ‰æ®‹å­˜

renderMSDFPreview()
  å®Ÿè£…çŠ¶æ…‹: âœ…ã‚ã‚Šãƒ»æœªä½¿ç”¨
  å‰Šé™¤å¯å¦: ğŸ—‘ï¸brush-coreã‹ã‚‰å‘¼ã°ã‚Œã¦ã„ãªã„ãƒ»å‰Šé™¤å¯èƒ½

renderPreview() / renderFinalStroke()
  å®Ÿè£…çŠ¶æ…‹: deprecatedè­¦å‘Šã®ã¿
  å‰Šé™¤å¯å¦: âœ…å‰Šé™¤å¯èƒ½


â–  ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼å›³ï¼ˆrev30å®Ÿè£…ï¼‰
================================================================================

ã€æç”»é–‹å§‹ã€‘âœ…æ­£å¸¸
PointerEvent (pointerdown)
  â†’ drawing-engine.js: _handlePointerDown()
  â†’ brush-core.js: startStroke(localX, localY, pressure)
  â†’ strokeRecorder.startStroke()

ã€æç”»ä¸­ã€‘âœ…æ­£å¸¸
PointerEvent (pointermove)
  â†’ drawing-engine.js: _handlePointerMove()
  â†’ åº§æ¨™å¤‰æ›: Localåº§æ¨™ç®—å‡º
  â†’ brush-core.js: updateStroke(localX, localY, pressure)
  â†’ strokeRecorder.addPoint()

ã€æç”»çµ‚äº†ã€‘âš ï¸ã“ã“ã§å•é¡Œç™ºç”Ÿ
PointerEvent (pointerup)
  â†’ drawing-engine.js: _handlePointerUp()
  â†’ brush-core.js: finalizeStroke()
  â†’ brush-core.js: _finalizeMSDFStroke()
      â†“
      âœ… gpuStrokeProcessor.createPolygonVertexBuffer()
      âœ… gpuStrokeProcessor.createEdgeBuffer()
      âœ… uploadToGPU() Ã— 2
      â†“
      âœ… msdfPipelineManager.generateMSDF()
          âœ… _seedInitPass() â†’ Bresenhamè£œé–“
          âœ… _executeJFA() â†’ è·é›¢å ´ç”Ÿæˆ
          âœ… _encodePass() â†’ MSDFç¬¦å·åŒ–
          â†“
          ğŸš¨ if (vertexBuffer && vertexCount > 0)
             âŒ _renderMSDFPolygon() å‘¼ã°ã‚Œã‚‹ãŒå‹•ä½œä¸å…¨
                â† BindGroupä¸æ•´åˆã§é ‚ç‚¹ãŒæ¸¡ã‚‰ãªã„
             â† ã¾ãŸã¯ _renderMSDF()ã«å…¥ã£ã¦ã—ã¾ã†
          â†“
      âš ï¸ finalTexture = å››è§’ã„MSDFãƒ†ã‚¯ã‚¹ãƒãƒ£
      â†“
  âœ… textureBridge.createSpriteFromGPUTexture()
  âœ… layerSystem.addPathToActiveLayer()


â–  æ”¹ä¿®å„ªå…ˆé †ä½ï¼ˆrev30ç‰¹åŒ–ï¼‰
================================================================================

å„ªå…ˆåº¦ | ãƒ•ã‚¡ã‚¤ãƒ« | æ”¹ä¿®å†…å®¹ | å½±éŸ¿ç¯„å›²
------|---------|---------|----------
ğŸ”¥1 | msdf-pipeline-manager.js | _renderMSDFPolygon() BindGroupä¿®æ­£ | å››è§’å•é¡Œè§£æ±º
ğŸ”¥2 | msdf-pipeline-manager.js | generateMSDF()åˆ†å²ãƒ‡ãƒãƒƒã‚° | çµŒè·¯çµ±ä¸€
âš ï¸3 | brush-core.js | æ¶ˆã—ã‚´ãƒ åˆ†å²è¿½åŠ  | æ¶ˆã—ã‚´ãƒ å•é¡Œè§£æ±º
âš ï¸4 | webgpu-mask-layer.js | applyEraserMask()å®Ÿè£… | ãƒã‚¹ã‚¯çµ±åˆ
ğŸ—‘ï¸5 | msdf-pipeline-manager.js | _renderMSDF()å‰Šé™¤ | ã‚³ãƒ¼ãƒ‰æ•´ç†
ğŸ—‘ï¸6 | msdf-render.wgsl | vertMainå‰Šé™¤ | åŒä¸Š
ğŸ—‘ï¸7 | stroke-renderer.js | æ—§ãƒ¡ã‚½ãƒƒãƒ‰å‰Šé™¤ | åŒä¸Š
ğŸ—‘ï¸8 | polygon-generator.jsç­‰ | ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ | DRYåŸå‰‡


â–  Phaseåˆ¥å®Ÿè£…è¨ˆç”»ï¼ˆrev30ç‰¹åŒ–ï¼‰
================================================================================

ã€Phase 1ã€‘BindGroupä¿®æ­£ğŸ”¥CRITICAL

ğŸ“ msdf-pipeline-manager.js: _renderMSDFPolygon()
   ğŸ”§ Line 388-460ã®è¦‹ç›´ã—
   
   å•é¡Œæ¨å®šç®‡æ‰€1: bindGroup0ã®layoutä¸ä¸€è‡´
      ç¾åœ¨:
        @group(0) @binding(0) var<uniform> uQuad: QuadUniforms;
      æœŸå¾…:
        quadUniformsBuffer.size = 16 bytes (Float32Array(4))
        [canvasWidth, canvasHeight, halfWidth, padding]
   
   ğŸ” æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰:
      console.log('BindGroup0 entries:', bindGroup0.entries);
      console.log('Pipeline layout:', polygonRenderPipeline.getBindGroupLayout(0));
   
   ä¿®æ­£æ–¹é‡:
      - quadUniformsDataã®å†…å®¹ç¢ºèª
      - bindGroup0ã®bindingç•ªå·ç¢ºèª
      - pipeline.getBindGroupLayout(0)ã¨ä¸€è‡´ã•ã›ã‚‹

   å•é¡Œæ¨å®šç®‡æ‰€2: vertexBufferå¼•æ•°å‹
      ç¾åœ¨: vertexBuffer = gpuVertexBuffer (GPUBuffer)
      æœŸå¾…: setVertexBuffer(0, GPUBuffer)
      
   ğŸ” æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰:
      console.log('vertexBuffer type:', vertexBuffer.constructor.name);
      console.log('vertexBuffer size:', vertexBuffer.size);
   
   ä¿®æ­£æ–¹é‡:
      - brush-core.jsã‹ã‚‰æ¸¡ã•ã‚Œã‚‹vertexBufferãŒGPUBufferã‹ç¢ºèª
      - ã‚‚ã—é•ãˆã° uploadToGPU()ã®æˆ»ã‚Šå€¤æ§‹é€ ã‚’è¦‹ç›´ã™


ã€Phase 2ã€‘åˆ†å²ãƒ‡ãƒãƒƒã‚°ğŸ”¥HIGH

ğŸ“ msdf-pipeline-manager.js: generateMSDF()
   ğŸ”§ Line 481-487ã®åˆ†å²æ¡ä»¶ç¢ºèª
   
   ğŸ” ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ¼ãƒ‰è¿½åŠ :
      ```
      console.log('[MSDF] Render path decision:');
      console.log('  vertexBuffer:', vertexBuffer);
      console.log('  vertexCount:', vertexCount);
      console.log('  condition:', !!(vertexBuffer && vertexCount > 0));
      
      if (vertexBuffer && vertexCount > 0) {
        console.log('[MSDF] Using Polygon path');
        finalTexture = await this._renderMSDFPolygon(...);
      } else {
        console.log('[MSDF] Using Fullscreen path');
        finalTexture = await this._renderMSDF(...);
      }
      ```
   
   æœŸå¾…ãƒ­ã‚°:
      vertexBuffer: GPUBuffer {...}
      vertexCount: 10 (ä¾‹)
      condition: true
      Using Polygon path
   
   ã‚‚ã— "Using Fullscreen path" ãªã‚‰:
      â†’ brush-core.jsã®å¼•æ•°æ¸¡ã—ã‚’å†ç¢ºèª
      â†’ uploadToGPU()ã®æˆ»ã‚Šå€¤ã‚’ç¢ºèª


ã€Phase 3ã€‘æ¶ˆã—ã‚´ãƒ åˆ†å²è¿½åŠ âš ï¸MEDIUM

ğŸ“ brush-core.js: _finalizeMSDFStroke()
   ğŸ”§ Line 112-125ã® brushSettings ç”Ÿæˆéƒ¨åˆ†
   
   è¿½åŠ ã‚³ãƒ¼ãƒ‰:
      ```
      const brushSettings = {
        mode: this.currentSettings.mode,  // â† ã“ã‚ŒãŒ 'eraser' ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
        color: this.currentSettings.color,
        opacity: this.currentSettings.opacity,
        size: this.currentSettings.size
      };
      
      // ãƒ‡ãƒãƒƒã‚°è¿½åŠ 
      console.log('[BrushCore] Brush settings:', brushSettings);
      ```

ğŸ“ msdf-pipeline-manager.js: _renderMSDFPolygon()
   ğŸ”§ Line 421-428ã® colorDataç”Ÿæˆéƒ¨åˆ†
   
   ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰:
      ```
      if (settings.mode === 'eraser') {
        colorData = new Float32Array([0.0, 0.0, 0.0, 0.0]);
      } else {
        const color = this._parseColor(settings.color || '#800000');
        colorData = new Float32Array([color.r, color.g, color.b, 1.0]);
      }
      ```
   
   å•é¡Œç‚¹:
      âŒ alpha=0.0 ã ã‘ã§ã¯æ¶ˆã—ã‚´ãƒ ã«ãªã‚‰ãªã„
      âŒ GPUå´ã§ãƒã‚¹ã‚¯æ¸›ç®—ãŒå¿…è¦
   
   ä¿®æ­£æ–¹é‡:
      â†’ Phase 4ã®webgpu-mask-layerçµ±åˆå¾Œã«å†å®Ÿè£…


ã€Phase 4ã€‘ãƒã‚¹ã‚¯çµ±åˆâš ï¸MEDIUM

ğŸ“ webgpu-mask-layer.js
   ğŸ”§ applyEraserMask() æ–°è¦å®Ÿè£…
   
   å‡¦ç†ãƒ•ãƒ­ãƒ¼:
      1. msdfTexture ã‹ã‚‰alphaå€¤èª­ã¿å–ã‚Š
      2. maskTexture ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚’æ¸›ç®—
      3. maskTexture ã‚’æ›´æ–°
   
   å®Ÿè£…:
      ```
      async applyEraserMask(msdfTexture, maskTexture, bounds) {
        // Compute Shaderå®Ÿè£…
        // maskTex[xy] = max(0.0, maskTex[xy] - msdfTex[xy].a)
      }
      ```

ğŸ“ msdf-pipeline-manager.js
   ğŸ”§ generateMSDF() ã«åˆ†å²è¿½åŠ 
   
   ç¾åœ¨: _renderMSDFPolygon()ãŒæœ€çµ‚å‡ºåŠ›
   è¿½åŠ : if (settings.mode === 'eraser') {
           await webgpuMaskLayer.applyEraserMask(finalTexture, ...);
         }


ã€Phase 5ã€‘æ—§ã‚³ãƒ¼ãƒ‰å‰Šé™¤ğŸ—‘ï¸LOW

ğŸ“ msdf-pipeline-manager.js
   ğŸ—‘ï¸ _renderMSDF() å‰Šé™¤
   ğŸ—‘ï¸ generateMSDF()ã® elseåˆ†å²å‰Šé™¤

ğŸ“ msdf-render.wgsl
   ğŸ—‘ï¸ vertMain() å‰Šé™¤

ğŸ“ stroke-renderer.js
   ğŸ—‘ï¸ renderPreview() / renderFinalStroke() å‰Šé™¤

ğŸ“ å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:
   ğŸ—‘ï¸ polygon-generator.js
   ğŸ—‘ï¸ webgpu-geometry-layer.js
   ğŸ—‘ï¸ webgpu-compute-sdf.js
   ğŸ—‘ï¸ webgpu-compute-msdf.js


ã€Phase 6ã€‘çµ±åˆãƒ†ã‚¹ãƒˆâœ…FINAL

âœ… ãƒšãƒ³æç”»: æ»‘ã‚‰ã‹ãªç·šï¼ˆã‚¸ãƒ£ã‚®ãƒ¼ãªã—ï¼‰
âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§: ãƒã‚¤ãƒ³ã‚¿ç§»å‹•ã¨åŒæœŸ
âœ… ç·šå¹…: settings.sizeã«å¿œã˜ãŸå¤ªã•
âœ… æ¶ˆã—ã‚´ãƒ : æ—¢å­˜æç”»å‰Šé™¤
âœ… 120fpsç¶­æŒ
âœ… ã‚µãƒ ãƒã‚¤ãƒ«å³åº§æ›´æ–°
âœ… Undo/Redoå®Œå…¨å¾©å…ƒ


â–  ãƒ‡ãƒãƒƒã‚°ãƒã‚¤ãƒ³ãƒˆï¼ˆrev30ç‰¹åŒ–ï¼‰
================================================================================

ğŸ” BindGroupæ§‹é€ ç¢ºèª
   ```
   // msdf-pipeline-manager.js: _renderMSDFPolygon()å†…ã«è¿½åŠ 
   console.log('[MSDF] BindGroup0 layout:', 
     this.polygonRenderPipeline.getBindGroupLayout(0));
   console.log('[MSDF] BindGroup0 entries:', bindGroup0);
   ```

ğŸ” VertexBufferå†…å®¹ç¢ºèª
   ```
   // brush-core.js: _finalizeMSDFStroke()å†…ã«è¿½åŠ 
   const f32 = new Float32Array(vertexBuffer.buffer, 0, 14);
   console.table([
     {prev: [f32[0],f32[1]], curr: [f32[2],f32[3]], 
      next: [f32[4],f32[5]], side: f32[6]},
     {prev: [f32[7],f32[8]], curr: [f32[9],f32[10]], 
      next: [f32[11],f32[12]], side: f32[13]}
   ]);
   ```

ğŸ” åˆ†å²çµŒè·¯ç¢ºèª
   ```
   // msdf-pipeline-manager.js: generateMSDF()å†…
   console.log('[MSDF] vertexBuffer:', vertexBuffer);
   console.log('[MSDF] vertexCount:', vertexCount);
   console.log('[MSDF] Polygon path:', !!(vertexBuffer && vertexCount > 0));
   ```

ğŸ” PipelineåˆæœŸåŒ–ç¢ºèª
   ```
   // msdf-pipeline-manager.js: _createPipelines()å¾Œ
   console.log('[MSDF] Pipelines:', {
     seed: !!this.seedInitPipeline,
     jfa: !!this.jfaPipeline,
     encode: !!this.encodePipeline,
     render: !!this.renderPipeline,
     polygon: !!this.polygonRenderPipeline
   });
   ```


â–  æˆåŠŸåŸºæº–ï¼ˆrev30ç‰¹åŒ–ï¼‰
================================================================================

âœ… ç›´ç·šæç”»: 2ç‚¹é–“ãŒæ»‘ã‚‰ã‹ãªç·šï¼ˆå››è§’ã§ãªã„ï¼‰
âœ… æ›²ç·šæç”»: é€£ç¶šç‚¹åˆ—ãŒæ»‘ã‚‰ã‹ãªæ›²ç·š
âœ… ç·šå¹…: 3.0ã§ç´„3pxå¹…
âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æç”»: ãƒã‚¤ãƒ³ã‚¿ç§»å‹•ã¨åŒæ™‚ã«æç”»
âœ… æ¶ˆã—ã‚´ãƒ : æ—¢å­˜æç”»ã‚’å‰Šé™¤ï¼ˆé»’å¡—ã‚Šã—ãªã„ï¼‰
âœ… ã‚¸ãƒ£ã‚®ãƒ¼ãªã—: MSDF smoothstepé©ç”¨
âœ… 120fpsç¶­æŒ: é…å»¶ãªã—
âœ… ã‚µãƒ ãƒã‚¤ãƒ«: æç”»ç›´å¾Œæ›´æ–°
âœ… Undo/Redo: å®Œå…¨å¾©å…ƒ


â–  æœ€é‡è¦ä¿®æ­£ç®‡æ‰€ã¾ã¨ã‚
================================================================================

ğŸ”¥Priority 1: msdf-pipeline-manager.js: _renderMSDFPolygon()
   â†’ BindGroup0ã®æ§‹é€ ã¨WGSLã®æ•´åˆæ€§ç¢ºèª
   â†’ vertexBufferå¼•æ•°ã®å‹ç¢ºèª
   â†’ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã§çµŒè·¯ç¢ºèª

ğŸ”¥Priority 2: msdf-pipeline-manager.js: generateMSDF()
   â†’ åˆ†å²æ¡ä»¶ã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
   â†’ vertexBuffer/vertexCountå€¤ã®æ¤œè¨¼

âš ï¸Priority 3: brush-core.js + msdf-pipeline-manager.js
   â†’ æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰åˆ†å²å®Ÿè£…

ğŸ—‘ï¸Priority 4: æ—§ã‚³ãƒ¼ãƒ‰å‰Šé™¤
   â†’ _renderMSDF() / polygon-generator.jsç­‰


================================================================================
EOF
================================================================================