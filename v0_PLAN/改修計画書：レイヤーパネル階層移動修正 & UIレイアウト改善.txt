ğŸ“‹ ç¾çŠ¶åˆ†æ
ğŸ” å•é¡Œç‚¹1: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®éšå±¤ç§»å‹•ä¸å…·åˆ
åŸå› ç‰¹å®š:

ui-panels.jså†…ã®SortableJSçµ±åˆå‡¦ç†(initializeSortable)ã«ã¦ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ã®ç§»å‹•å‡¦ç†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
onEndã‚¤ãƒ™ãƒ³ãƒˆå†…ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼é…åˆ—ã¨Pixi Containeréšå±¤ã‚’ä¸¡æ–¹æ›´æ–°ã—ã¦ã„ã‚‹ãŒã€LayerSystemã¸ã®çŠ¶æ…‹åæ˜ ãŒä¸å®Œå…¨
ä¸€åº¦ç§»å‹•ã™ã‚‹ã¨layerManager.updateLayerPanelUI()ãŒå‘¼ã°ã‚Œã‚‹ãŒã€ãã®å¾Œã®å†ç§»å‹•æ™‚ã«é…åˆ—ã¨ã‚³ãƒ³ãƒ†ãƒŠã®åŒæœŸãŒå–ã‚Œãªããªã‚‹
é‡è¦: LayerSystemã®updateLayerPanelUI()ãƒ¡ã‚½ãƒƒãƒ‰ãŒã€SortableJSã«ã‚ˆã‚‹ç§»å‹•ã‚’æ¤œçŸ¥ã—ã¦å†æç”»ã™ã‚‹éš›ã€æ—¢ã«ç§»å‹•æ¸ˆã¿ã®DOMè¦ç´ ã«å¯¾ã—ã¦å†åº¦Sortableã‚’åˆæœŸåŒ–ã—ã¦ã„ãªã„å¯èƒ½æ€§

å½±éŸ¿ç¯„å›²:

ui-panels.js: initializeSortableãƒ¡ã‚½ãƒƒãƒ‰
layer-system.js: updateLayerPanelUIãƒ¡ã‚½ãƒƒãƒ‰ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯

ğŸ” å•é¡Œç‚¹2: UIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä½ç½®é–¢ä¿‚
ç¾çŠ¶:

ãƒ¬ã‚¤ãƒ¤ãƒ¼+ãƒœã‚¿ãƒ³
â—€CUT1â–¶
ãƒ¬ã‚¤ãƒ¤ãƒ¼1
èƒŒæ™¯

è¦æœ›:

â—€CUT1â–¶
ãƒ¬ã‚¤ãƒ¤ãƒ¼+ãƒœã‚¿ãƒ³ | ãƒ•ã‚©ãƒ«ãƒ€+ãƒœã‚¿ãƒ³
ãƒ¬ã‚¤ãƒ¤ãƒ¼1
èƒŒæ™¯

ğŸ¯ æ”¹ä¿®è¨ˆç”»
Phase 1: ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ç§»å‹•ã®ä¿®æ­£
ãƒ•ã‚¡ã‚¤ãƒ«: ui-panels.js, layer-system.js
ä¿®æ­£å†…å®¹
1. ui-panels.js - SortableJSçµ±åˆã®æ”¹å–„

// å•é¡Œ: Sortableã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå†åˆæœŸåŒ–ã•ã‚Œãªã„
// è§£æ±ºç­–: updateLayerPanelUI()å‘¼ã³å‡ºã—å¾Œã«å†åˆæœŸåŒ–

initializeSortable: function(layerManager) {
    const layerList = document.getElementById('layer-list');
    if (!layerList || typeof Sortable === 'undefined') return;
    
    // æ—¢å­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
    if (layerList.sortableInstance) {
        layerList.sortableInstance.destroy();
    }
    
    // æ–°è¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
    layerList.sortableInstance = Sortable.create(layerList, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        onEnd: function(evt) {
            const fromIndex = layerManager.layers.length - 1 - evt.oldIndex;
            const toIndex = layerManager.layers.length - 1 - evt.newIndex;
            
            if (fromIndex !== toIndex) {
                // LayerSystemã®çµ±ä¸€APIã‚’ä½¿ç”¨
                const success = layerManager.reorderLayers(fromIndex, toIndex);
                
                if (success) {
                    // UIæ›´æ–°
                    layerManager.updateLayerPanelUI();
                    
                    // Sortableå†åˆæœŸåŒ–
                    setTimeout(() => {
                        if (window.TegakiUI?.initializeSortable) {
                            window.TegakiUI.initializeSortable(layerManager);
                        }
                    }, 50);
                }
            }
        }
    });
}

2. layer-system.js - ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´APIã®è¿½åŠ 

// æ–°è¦ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
reorderLayers(fromIndex, toIndex) {
    const layers = this.getLayers();
    
    if (fromIndex < 0 || fromIndex >= layers.length || 
        toIndex < 0 || toIndex >= layers.length || 
        fromIndex === toIndex) {
        return false;
    }
    
    // é…åˆ—ã‹ã‚‰ç§»å‹•
    const [movedLayer] = layers.splice(fromIndex, 1);
    layers.splice(toIndex, 0, movedLayer);
    
    // Pixiã‚³ãƒ³ãƒ†ãƒŠã®éšå±¤ã‚‚åŒæœŸ
    this.currentCutContainer.removeChild(movedLayer);
    this.currentCutContainer.addChildAt(movedLayer, toIndex);
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®èª¿æ•´
    if (this.activeLayerIndex === fromIndex) {
        this.activeLayerIndex = toIndex;
    } else if (this.activeLayerIndex > fromIndex && this.activeLayerIndex <= toIndex) {
        this.activeLayerIndex--;
    } else if (this.activeLayerIndex < fromIndex && this.activeLayerIndex >= toIndex) {
        this.activeLayerIndex++;
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    if (this.eventBus) {
        this.eventBus.emit('layer:reordered', { 
            fromIndex, 
            toIndex, 
            activeIndex: this.activeLayerIndex 
        });
    }
    
    return true;
}

3. layer-system.js - updateLayerPanelUIã®æ”¹å–„

updateLayerPanelUI() {
    const layerList = document.getElementById('layer-list');
    if (!layerList) return;

    layerList.innerHTML = '';
    
    const layers = this.getLayers();

    for (let i = layers.length - 1; i >= 0; i--) {
        const layer = layers[i];
        const isActive = (i === this.activeLayerIndex);
        
        const layerItem = document.createElement('div');
        layerItem.className = `layer-item ${isActive ? 'active' : ''}`;
        layerItem.dataset.layerId = layer.layerData.id;
        layerItem.dataset.layerIndex = i;

        // ... æ—¢å­˜ã®HTMLç”Ÿæˆã‚³ãƒ¼ãƒ‰ ...
        
        layerList.appendChild(layerItem);
    }
    
    // ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
    for (let i = 0; i < layers.length; i++) {
        this.requestThumbnailUpdate(i);
    }
    
    // â­ Sortableå†åˆæœŸåŒ–ï¼ˆé‡è¦ï¼‰
    if (window.TegakiUI?.initializeSortable) {
        setTimeout(() => {
            window.TegakiUI.initializeSortable(this);
        }, 50);
    }
}

Phase 2: UIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å†æ§‹ç¯‰
ãƒ•ã‚¡ã‚¤ãƒ«: index.html
HTMLæ§‹é€ å¤‰æ›´

<div class="layer-panel-container" id="layer-panel-container">
    <!-- CUTã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ï¼ˆæœ€ä¸Šéƒ¨ï¼‰ -->
    <div class="cut-indicator">
        <div class="cut-nav-btn" id="prev-cut-btn">â—€</div>
        <div class="cut-display" id="cut-display">CUT1</div>
        <div class="cut-nav-btn" id="next-cut-btn">â–¶</div>
    </div>
    
    <!-- ãƒœã‚¿ãƒ³ç¾¤ï¼ˆæ¨ªä¸¦ã³ï¼‰ -->
    <div class="layer-controls-row">
        <div class="layer-add-button" id="add-layer-btn" title="ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ  (Ctrl+L)">
            <svg><!-- layer-plus icon --></svg>
        </div>
        
        <div class="folder-add-button" id="add-folder-btn" title="ãƒ•ã‚©ãƒ«ãƒ€è¿½åŠ ï¼ˆæº–å‚™ä¸­ï¼‰">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#800000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 10v6"/><path d="M9 13h6"/>
                <path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>
            </svg>
        </div>
    </div>
    
    <!-- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆ -->
    <div class="layer-panel-items" id="layer-list"></div>
</div>

CSSè¿½åŠ 

/* ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡Œ */
.layer-controls-row {
    display: flex;
    flex-direction: row;
    gap: 8px;
    background: transparent;
    pointer-events: all;
    justify-content: center;
    padding: 4px 8px;
}

.layer-add-button,
.folder-add-button {
    width: 36px;
    height: 36px;
    background: var(--futaba-cream);
    border: 2px solid var(--futaba-light-medium);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(128, 0, 0, 0.1);
    pointer-events: all;
}

.folder-add-button {
    opacity: 0.6;
    cursor: not-allowed;
}

.folder-add-button:hover {
    opacity: 0.7;
}

.layer-add-button svg,
.folder-add-button svg {
    width: 18px;
    height: 18px;
    stroke: #800000;
}

Phase 3: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ 
ãƒ•ã‚¡ã‚¤ãƒ«: index.html
HTMLã¸ã®ã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ 

<div class="sidebar">
    <!-- ğŸ“š ã‚¢ãƒ«ãƒãƒ ä¿ç®¡ã‚¢ã‚¤ã‚³ãƒ³ -->
    <div class="tool-button" id="library-tool" title="ã‚¢ãƒ«ãƒãƒ ä¿ç®¡ (æº–å‚™ä¸­)">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#800000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect width="8" height="18" x="3" y="3" rx="1"/>
            <path d="M7 3v18"/>
            <path d="M20.4 18.9c.2.5-.1 1.1-.6 1.3l-1.9.7c-.5.2-1.1-.1-1.3-.6L11.1 5.1c-.2-.5.1-1.1.6-1.3l1.9-.7c.5-.2 1.1.1 1.3.6Z"/>
        </svg>
    </div>
    
    <!-- ğŸ“¥ ç”»åƒãƒ»ã‚¢ãƒ‹ãƒ¡è¨˜éŒ²ã‚¢ã‚¤ã‚³ãƒ³ -->
    <div class="tool-button" id="export-tool" title="ç”»åƒãƒ»ã‚¢ãƒ‹ãƒ¡å‡ºåŠ› (æº–å‚™ä¸­)">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#800000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10l-3.1-3.1a2 2 0 0 0-2.814.014L6 21"/>
            <path d="m14 19 3 3v-5.5"/>
            <path d="m17 22 3-3"/>
            <circle cx="9" cy="9" r="2"/>
        </svg>
    </div>
    
    <div class="tool-separator"></div>
    
    <!-- æ—¢å­˜ã®ãƒªã‚µã‚¤ã‚ºãƒ„ãƒ¼ãƒ«ä»¥é™ -->
    <!-- ... -->
</div>

ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¿½åŠ ï¼ˆui-panels.jsï¼‰

handleToolClick(button) {
    const toolId = button.id;
    
    const toolMap = {
        'library-tool': () => {
            alert('ã‚¢ãƒ«ãƒãƒ ä¿ç®¡æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
            // å°†æ¥å®Ÿè£…: localStorage/IndexedDBã«ã‚ˆã‚‹ä¿å­˜UI
        },
        'export-tool': () => {
            this.showExportPanel();
        },
        // æ—¢å­˜ã®ãƒ„ãƒ¼ãƒ«...
    };
    
    const handler = toolMap[toolId];
    if (handler) handler();
}

showExportPanel() {
    // å‡ºåŠ›ãƒ‘ãƒãƒ«è¡¨ç¤ºï¼ˆGIFå„ªå…ˆå®Ÿè£…ï¼‰
    const exportPanel = document.getElementById('export-panel');
    if (exportPanel) {
        exportPanel.classList.add('show');
    } else {
        // ç°¡æ˜“ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆãƒ‘ãƒãƒ«æœªå®Ÿè£…æ™‚ï¼‰
        alert('å‡ºåŠ›å½¢å¼ï¼šPNG, APNG, GIF, WEBP, MP4, PDF\nâ€»GIFå‡ºåŠ›ã‚’å„ªå…ˆå®Ÿè£…äºˆå®š');
    }
}


ğŸ“Š å®Ÿè£…å„ªå…ˆåº¦
ğŸ”´ æœ€å„ªå…ˆï¼ˆPhase 1ï¼‰

ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ç§»å‹•ã®ä¿®æ­£

ui-panels.js SortableJSçµ±åˆæ”¹å–„
layer-system.js reorderLayersãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
updateLayerPanelUIã§ã®Sortableå†åˆæœŸåŒ–



ğŸŸ¡ é«˜å„ªå…ˆåº¦ï¼ˆPhase 2ï¼‰

UIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´

CUTã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ä½ç½®å¤‰æ›´
ãƒ¬ã‚¤ãƒ¤ãƒ¼+ãƒœã‚¿ãƒ³ã¨ãƒ•ã‚©ãƒ«ãƒ€+ãƒœã‚¿ãƒ³æ¨ªä¸¦ã³
CSSèª¿æ•´



ğŸŸ¢ ä¸­å„ªå…ˆåº¦ï¼ˆPhase 3ï¼‰

ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ 

library-bigã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ 
image-downã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ 
ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆå®Ÿè£…



ğŸ”µ ä½å„ªå…ˆåº¦ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

æ©Ÿèƒ½å®Ÿè£…

ã‚¢ãƒ«ãƒãƒ ä¿ç®¡æ©Ÿèƒ½ï¼ˆlocalStorage/IndexedDBï¼‰
PNG/APNG/GIF/WEBP/MP4/PDFå‡ºåŠ›
ãƒ•ã‚©ãƒ«ãƒ€æ©Ÿèƒ½




ğŸ”§ æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«

ui-panels.js ï¼ˆSortableJSçµ±åˆæ”¹å–„ã€ãƒ„ãƒ¼ãƒ«ãƒãƒ³ãƒ‰ãƒ©è¿½åŠ ï¼‰
layer-system.js ï¼ˆreorderLayersãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ã€updateLayerPanelUIæ”¹å–„ï¼‰
index.html ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«HTMLæ§‹é€ å¤‰æ›´ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ ã€CSSè¿½åŠ ï¼‰

æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«
ãªã—ï¼ˆæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®æ”¹ä¿®ã®ã¿ï¼‰

âš ï¸ æ³¨æ„äº‹é …
äº’æ›æ€§ç¶­æŒ

æ—¢å­˜ã®LayerSystem APIã¯å…¨ã¦ç¶­æŒ
updateLayerPanelUI()ã®å‹•ä½œã¯å¤‰æ›´ãªã—ï¼ˆå†…éƒ¨ã§Sortableå†åˆæœŸåŒ–ã‚’è¿½åŠ ã™ã‚‹ã®ã¿ï¼‰
EventBusçµŒç”±ã®ã‚¤ãƒ™ãƒ³ãƒˆåã¯æ—¢å­˜ã®ã¾ã¾

ãƒ‡ãƒãƒƒã‚°ãƒã‚¤ãƒ³ãƒˆ

SortableJSã®onEndã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ãç™ºç«ã™ã‚‹ã‹
reorderLayers()å¾Œã®Pixi Containeréšå±¤ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼é…åˆ—ã®ä¸€è‡´
updateLayerPanelUI()å¾Œã®Sortableå†åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°

ãƒ†ã‚¹ãƒˆé …ç›®

ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä¸Šä¸‹ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦éšå±¤ç§»å‹•
ç§»å‹•å¾Œã€å†åº¦åˆ¥ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç§»å‹•å¯èƒ½ã‹
ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ­£ã—ãè¿½å¾“ã™ã‚‹ã‹
CUTã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãŒæœ€ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹
ãƒ¬ã‚¤ãƒ¤ãƒ¼+ãƒœã‚¿ãƒ³ã¨ãƒ•ã‚©ãƒ«ãƒ€+ãƒœã‚¿ãƒ³ãŒæ¨ªä¸¦ã³ã‹
ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æ–°è¦ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‹

