CUTç‹¬ç«‹åŒ–ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«æœ€é©åŒ–å¯¾å¿œ

ğŸ“‹ ç›®æ¬¡

ç¾çŠ¶åˆ†æã¨å•é¡Œã®æ ¹æœ¬åŸå› 
æ”¹ä¿®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨è¨­è¨ˆæ–¹é‡
ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å†è¨­è¨ˆ
å‹•ä½œãƒ•ãƒ­ãƒ¼è©³ç´°
ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥æ”¹ä¿®ä»•æ§˜
ãƒ¡ã‚½ãƒƒãƒ‰è¾å…¸
æ”¹ä¿®ã®å„ªå…ˆé †ä½ã¨æ‰‹é †
æ¤œè¨¼é …ç›®


1. ç¾çŠ¶åˆ†æã¨å•é¡Œã®æ ¹æœ¬åŸå› 
ğŸ”´ å•é¡ŒA: å…¨CUTã«åŒã˜çµµãŒæç”»ã•ã‚Œã‚‹
åŸå› 

ç¾çŠ¶ã®layer-system.jsã§ã¯ã€å…¨CUTãŒåŒä¸€ã®Containerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å‚ç…§ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„
CUTåˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã€ŒContainer ã®å‚ç…§ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã€ã®ã§ã¯ãªãã€ã€ŒContainer ã®ä¸­èº«ã‚’å…¥ã‚Œæ›¿ãˆã¦ã„ã‚‹ã€ãŸã‚ã€GPUä¸Šã§ã¯åŒä¸€ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’å…¨CUTãŒå…±æœ‰

è¨¼è·¡

ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã§ã¯æ­£å¸¸ â†’ ãƒ¬ã‚¤ãƒ¤ãƒ¼è‡ªä½“ã¯ç‹¬ç«‹
Timelineåˆ‡ã‚Šæ›¿ãˆæ™‚ã«å…¨CUTãŒåŒæœŸ â†’ CUTãƒ¬ãƒ™ãƒ«ã§ã®åˆ†é›¢ãŒæœªå®Ÿè£…

ğŸ”´ å•é¡ŒB: æç”»æ™‚ã®ãƒãƒ©ã¤ãã¨å·¦ä¸Šã‚­ãƒ£ãƒ³ãƒã‚¹å‡ºç¾
åŸå› 

timeline-ui.jsã®updateCutThumbnail()ãŒæç”»ã‚¤ãƒ™ãƒ³ãƒˆæ¯ã«extract.canvas()ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹
extract.canvas()ã¯å†…éƒ¨çš„ã«GPUâ†’CPUè»¢é€ã‚’è¡Œã†ãŸã‚ã€æç”»ã®ãŸã³ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒä¸­æ–­
æŠ½å‡ºã—ãŸCanvasãŒä¸€ç¬DOMä¸Šã®åˆ¥è¦ç´ ã¨ã—ã¦ç¾ã‚Œã‚‹ï¼ˆä½ç½®æŒ‡å®šä¸è¶³ï¼‰

è¨¼è·¡

ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã§ã¯ã‚¹ãƒ ãƒ¼ã‚º â†’ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã¯é©åˆ‡ã«å·®åˆ†æ›´æ–°ã•ã‚Œã¦ã„ã‚‹
Timelineã®ã¿ãƒãƒ©ã¤ã â†’ Timelineå›ºæœ‰ã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ã«å•é¡Œ


2. æ”¹ä¿®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨è¨­è¨ˆæ–¹é‡
ğŸ¯ æ ¸å¿ƒã¨ãªã‚‹è¨­è¨ˆå¤‰æ›´
A. CUTã‚’ã€Œç‹¬ç«‹ã—ãŸRenderTextureã‚’æŒã¤ã‚³ãƒ³ãƒ†ãƒŠã€ã¨ã—ã¦å®Ÿè£…
å¾“æ¥ã®æ§‹é€ ï¼ˆå•é¡Œã‚ã‚Šï¼‰:
â”œâ”€ Stage (Container)
    â””â”€ layersContainer (Container) â† å…¨CUTã§å…±æœ‰
        â”œâ”€ Layer1 (Graphics)
        â””â”€ Layer2 (Graphics)

æ–°ã—ã„æ§‹é€ :
â”œâ”€ Stage (Container)
    â”œâ”€ Cut1 (Container) + RenderTexture1
    â”‚   â”œâ”€ Layer1-1 (Graphics)
    â”‚   â””â”€ Layer1-2 (Graphics)
    â””â”€ Cut2 (Container) + RenderTexture2
        â”œâ”€ Layer2-1 (Graphics)
        â””â”€ Layer2-2 (Graphics)
B. RenderTextureã®å½¹å‰²

GPUä¸Šã®ç‹¬ç«‹ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ã¨ã—ã¦æ©Ÿèƒ½
å„CUTã®å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åˆæˆã—ãŸæœ€çµ‚ç”»åƒã‚’ä¿æŒ
Timelineè¡¨ç¤ºæ™‚ã¯RenderTexture â†’ Canvas2Dã®å¤‰æ›ã‚’å¿…è¦æ™‚ã®ã¿å®Ÿè¡Œ

C. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€ã¨ã®è¨­è¨ˆçµ±ä¸€
CUTã¯ã€Œæœ€ä¸Šä½ã®ç‰¹æ®Šãªãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€ã€ã¨ã—ã¦å®Ÿè£…:

type: 'cut'ã‚’æŒã¤ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
å­è¦ç´ ã¨ã—ã¦é€šå¸¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æŒã¤
å°†æ¥çš„ãªãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€å®Ÿè£…ã¨æ§‹é€ ã‚’å…±é€šåŒ–


3. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å†è¨­è¨ˆ
3.1 CUTã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå®šç¾©
javascript{
  id: 'cut_1728000000000',
  type: 'cut',
  name: 'Cut 1',
  duration: 1000,           // ãƒŸãƒªç§’
  container: Container,      // Pixi.Container instance
  renderTexture: RenderTexture, // GPUä¸Šã®æç”»çµæœ
  layers: [],               // å­ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é…åˆ—
  activeLayerId: 'layer_xxx',
  visible: true,
  locked: false,
  thumbnailCache: null,     // Canvas2D thumbnail cache
  thumbnailDirty: true      // å†ç”Ÿæˆãƒ•ãƒ©ã‚°
}
3.2 ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå®šç¾©ï¼ˆå¤‰æ›´ãªã—ï¼‰
javascript{
  id: 'layer_1728000000001',
  type: 'raster',           // 'raster' | 'vector' | 'folder'
  name: 'Layer 1',
  parentId: 'cut_xxx',      // è¦ªCUT or ãƒ•ã‚©ãƒ«ãƒ€ID
  container: Container,
  graphics: Graphics,
  visible: true,
  opacity: 1.0,
  locked: false,
  blendMode: 'normal'
}
3.3 LayerSystemå†…éƒ¨çŠ¶æ…‹
javascript{
  cuts: Map<id, CutObject>,        // å…¨CUT
  layers: Map<id, LayerObject>,    // å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆãƒ•ãƒ©ãƒƒãƒˆï¼‰
  activeCutId: 'cut_xxx',
  cutOrder: ['cut_1', 'cut_2'],   // è¡¨ç¤ºé †åº
}

4. å‹•ä½œãƒ•ãƒ­ãƒ¼è©³ç´°
4.1 åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼
core-engine.js: initPixiApp()
  â†“
layer-system.js: initialize()
  â”œâ”€ createCut('cut_default')
  â”‚   â”œâ”€ new Container()
  â”‚   â”œâ”€ RenderTexture.create({ width, height })
  â”‚   â””â”€ createLayer(cutId, 'Layer 1')
  â””â”€ setActiveCut('cut_default')
  â†“
animation-system.js: initialize()
  â””â”€ registerCut('cut_default')
  â†“
timeline-ui.js: initialize()
  â””â”€ refreshTimeline()
4.2 æç”»ãƒ•ãƒ­ãƒ¼ï¼ˆãƒšãƒ³ãƒ„ãƒ¼ãƒ«ä½¿ç”¨æ™‚ï¼‰
user: mousedown on canvas
  â†“
core-runtime.js: handleDrawingStart()
  â†“
layer-system.js: getActiveLayer(activeCutId)
  â†“ è¿”ã‚Šå€¤: activeLayer
  â†“
core-runtime.js: graphics.moveTo(x, y)
  â†“
user: mousemove
  â†“
core-runtime.js: graphics.lineTo(x, y)
  â†“ (æ¯ãƒ•ãƒ¬ãƒ¼ãƒ è‡ªå‹•ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°)
  â†“
user: mouseup
  â†“
layer-system.js: renderCutToTexture(activeCutId)
  â”œâ”€ renderer.render(cutContainer, { renderTexture })
  â””â”€ markThumbnailDirty(cutId)
  â†“
EventBus.emit('cut:updated', { cutId })
  â†“
timeline-ui.js: onCutUpdated({ cutId })
  â””â”€ scheduleThrottledUpdate(cutId)
4.3 CUTåˆ‡ã‚Šæ›¿ãˆãƒ•ãƒ­ãƒ¼
user: click on timeline cut
  â†“
timeline-ui.js: handleCutClick(cutId)
  â†“
animation-system.js: gotoCut(cutId)
  â†“
layer-system.js: setActiveCut(cutId)
  â”œâ”€ æ—§CUT: cutContainer.visible = false
  â”œâ”€ æ–°CUT: cutContainer.visible = true
  â””â”€ EventBus.emit('cut:changed', { cutId })
  â†“
ui-panels.js: refreshLayerPanel(cutId)
4.4 Timelineã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ãƒ•ãƒ­ãƒ¼ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
EventBus.on('cut:updated', { cutId })
  â†“
timeline-ui.js: scheduleThrottledUpdate(cutId)
  â”œâ”€ throttle: 300ms
  â””â”€ dirtyFlags.add(cutId)
  â†“
timeline-ui.js: processDirtyThumbnails()
  â””â”€ for each dirtyCutId:
      updateCutThumbnail(dirtyCutId)
        â”œâ”€ if (cut.thumbnailDirty === false) return
        â”œâ”€ const canvas = extract.canvas(cutContainer)
        â”œâ”€ const dataURL = canvas.toDataURL()
        â”œâ”€ imgElement.src = dataURL
        â”œâ”€ cut.thumbnailCache = canvas
        â””â”€ cut.thumbnailDirty = false

5. ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥æ”¹ä¿®ä»•æ§˜
5.1 system/layer-system.js
è²¬å‹™

CUT/ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½œæˆãƒ»å‰Šé™¤ãƒ»å–å¾—
CUTã”ã¨ã®RenderTextureç®¡ç†
æç”»å†…å®¹ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¸ã®åæ˜ 

æ”¹ä¿®å†…å®¹
æ–°è¦è¿½åŠ 
javascriptclass LayerSystem {
  constructor(app) {
    this.app = app;
    this.renderer = app.renderer;
    this.stage = app.stage;
    this.cuts = new Map();
    this.layers = new Map();
    this.activeCutId = null;
    this.cutOrder = [];
  }

  // CUTç®¡ç†
  createCut(options = {}) { /* å®Ÿè£… */ }
  getCut(id) { /* å®Ÿè£… */ }
  setActiveCut(id) { /* å®Ÿè£… */ }
  deleteCut(id) { /* å®Ÿè£… */ }
  
  // RenderTextureç®¡ç†
  renderCutToTexture(cutId) { /* å®Ÿè£… */ }
  markThumbnailDirty(cutId) { /* å®Ÿè£… */ }
  
  // ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ï¼ˆæ—¢å­˜ã‚’æ”¹ä¿®ï¼‰
  createLayer(cutId, options) { /* parentIdå¯¾å¿œ */ }
  getActiveLayer(cutId) { /* CUTæŒ‡å®šç‰ˆ */ }
}
æ”¹ä¿®å¯¾è±¡ã®æ—¢å­˜ãƒ¡ã‚½ãƒƒãƒ‰

createLayer(): parentIdãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆcutIdå¿…é ˆåŒ–ï¼‰
deleteLayer(): è¦ªCUTã®thumbnailDirtyãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
setLayerVisibility(): åŒä¸Š


5.2 system/animation-system.js
è²¬å‹™

CUTã®ç™»éŒ²ãƒ»é †åºç®¡ç†
å†ç”Ÿ/åœæ­¢åˆ¶å¾¡
CUTé–“ã®é·ç§»

æ”¹ä¿®å†…å®¹
æ–°è¦è¿½åŠ 
javascriptclass AnimationSystem {
  constructor(layerSystem) {
    this.layerSystem = layerSystem;
    this.isPlaying = false;
    this.currentCutIndex = 0;
    this.animationId = null;
  }

  addCut(options) { /* layerSystem.createCut()ã‚’å‘¼ã³å‡ºã— */ }
  removeCut(cutId) { /* layerSystem.deleteCut()ã‚’å‘¼ã³å‡ºã— */ }
  gotoCut(cutId) { /* layerSystem.setActiveCut()ã‚’å‘¼ã³å‡ºã— */ }
  
  playAnimation() { /* å®Ÿè£… */ }
  pauseAnimation() { /* å®Ÿè£… */ }
  nextCut() { /* å®Ÿè£… */ }
  prevCut() { /* å®Ÿè£… */ }
}
æ—¢å­˜ã‹ã‚‰ã®å¤‰æ›´

CUTç®¡ç†ã®è²¬å‹™ã‚’layer-system.jsã«ç§»è­²
animation-system.jsã¯å†ç”Ÿåˆ¶å¾¡ã«å°‚å¿µ


5.3 ui/timeline-ui.js
è²¬å‹™

Timeline UIã®æç”»
CUTã‚µãƒ ãƒã‚¤ãƒ«ã®ç”Ÿæˆãƒ»æ›´æ–°
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†

æ”¹ä¿®å†…å®¹
æ–°è¦è¿½åŠ 
javascriptclass TimelineUI {
  constructor(layerSystem, animationSystem) {
    this.layerSystem = layerSystem;
    this.animationSystem = animationSystem;
    this.dirtyFlags = new Set();
    this.updateThrottle = null;
  }

  // ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ï¼ˆæœ€é©åŒ–ï¼‰
  scheduleThrottledUpdate(cutId) { /* 300ms throttle */ }
  processDirtyThumbnails() { /* ãƒãƒƒãƒå‡¦ç† */ }
  updateCutThumbnail(cutId) { /* extract.canvas()ã‚’å‘¼ã¶ */ }
  
  // Timelineæç”»
  refreshTimeline() { /* å…¨CUTã®UIå†æ§‹ç¯‰ */ }
  renderCutElement(cut) { /* å€‹åˆ¥CUTè¦ç´ ç”Ÿæˆ */ }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆ
  bindTimelineEvents() { /* ã‚¯ãƒªãƒƒã‚¯ç­‰ */ }
}
é‡è¦ãªæœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ
javascriptupdateCutThumbnail(cutId) {
  const cut = this.layerSystem.getCut(cutId);
  
  // å·®åˆ†ãƒã‚§ãƒƒã‚¯
  if (!cut.thumbnailDirty) return;
  
  // Extractå®Ÿè¡Œï¼ˆã“ã“ã ã‘ï¼‰
  const canvas = this.layerSystem.renderer.extract.canvas(cut.container);
  const dataURL = canvas.toDataURL('image/png');
  
  // DOMæ›´æ–°
  const imgElement = document.querySelector(`[data-cut-id="${cutId}"] img`);
  if (imgElement) {
    imgElement.src = dataURL;
  }
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
  cut.thumbnailCache = canvas;
  cut.thumbnailDirty = false;
}

5.4 system/history.js
è²¬å‹™

Undo/Redoå±¥æ­´ç®¡ç†
CUTå˜ä½ã§ã®å±¥æ­´åˆ†é›¢

æ”¹ä¿®å†…å®¹
ãƒ‡ãƒ¼ã‚¿æ§‹é€ å¤‰æ›´
javascript// å¾“æ¥: å˜ä¸€ã®å±¥æ­´é…åˆ—
histories: []

// æ”¹ä¿®å¾Œ: CUTåˆ¥ã®å±¥æ­´Map
histories: Map<cutId, HistoryEntry[]>
æ–°è¦è¿½åŠ 
javascriptclass HistorySystem {
  constructor(layerSystem) {
    this.layerSystem = layerSystem;
    this.histories = new Map(); // cutId -> []
    this.historyIndices = new Map(); // cutId -> index
  }

  pushState(cutId, action, data) { /* CUTåˆ¥ã«è¿½åŠ  */ }
  undo(cutId) { /* æŒ‡å®šCUTã®ã¿ */ }
  redo(cutId) { /* æŒ‡å®šCUTã®ã¿ */ }
  clearHistory(cutId) { /* CUTå‰Šé™¤æ™‚ */ }
}
æ—¢å­˜ã‹ã‚‰ã®å¤‰æ›´

ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªå±¥æ­´ â†’ CUTåˆ¥ã®å±¥æ­´ã«å¤‰æ›´
undo()/redo()ã«cutIdãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 


5.5 system/gif-exporter.js
è²¬å‹™

å…¨CUTã®RenderTextureâ†’PNGå¤‰æ›
GIFç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

æ”¹ä¿®å†…å®¹
æ–°è¦è¿½åŠ 
javascriptclass GifExporter {
  constructor(layerSystem, animationSystem) {
    this.layerSystem = layerSystem;
    this.animationSystem = animationSystem;
  }

  async renderCutFrames() {
    const frames = [];
    const cutOrder = this.layerSystem.cutOrder;
    
    for (const cutId of cutOrder) {
      const cut = this.layerSystem.getCut(cutId);
      
      // RenderTextureã‹ã‚‰ç›´æ¥Canvaså–å¾—
      const canvas = this.layerSystem.renderer.extract.canvas(cut.renderTexture);
      frames.push({
        canvas: canvas,
        delay: cut.duration
      });
    }
    
    return frames;
  }

  async exportGIF(frames) { /* gif.jsä½¿ç”¨ */ }
  downloadGIF(blob, filename) { /* Blobä¿å­˜ */ }
}
æœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ

renderTextureã‹ã‚‰ç›´æ¥æŠ½å‡ºï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸è¦ï¼‰
éåŒæœŸå‡¦ç†ã§UIå‡çµã‚’é˜²æ­¢


5.6 core-engine.js
è²¬å‹™

PixiJSã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
å„ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã®ç®¡ç†

æ”¹ä¿®å†…å®¹
åˆæœŸåŒ–é †åºã®æ˜ç¢ºåŒ–
javascriptasync function initPixiApp() {
  // 1. PixiJS Application
  const app = new PIXI.Application();
  await app.init({ /* options */ });
  
  // 2. Core Systems
  window.eventBus = new EventBus();
  window.layerSystem = new LayerSystem(app);
  window.cameraSystem = new CameraSystem(app);
  
  // 3. Feature Systems
  window.animationSystem = new AnimationSystem(layerSystem);
  window.historySystem = new HistorySystem(layerSystem);
  window.gifExporter = new GifExporter(layerSystem, animationSystem);
  
  // 4. UI
  window.timelineUI = new TimelineUI(layerSystem, animationSystem);
  window.uiPanels = new UIPanels(layerSystem, historySystem);
  
  // 5. Initialize all
  layerSystem.initialize();
  animationSystem.initialize();
  timelineUI.initialize();
  
  return app;
}

6. ãƒ¡ã‚½ãƒƒãƒ‰è¾å…¸
ã€6.1 LayerSystemã€‘
â–  createCut()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: CUTä½œæˆã€RenderTextureå‰²å½“
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: { name, duration }
æˆ»ã‚Šå€¤: cutId
â–  getCut()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: CUTå–å¾—
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: CutObject
â–  setActiveCut()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTåˆ‡æ›¿
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  deleteCut()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: CUTå‰Šé™¤
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  renderCutToTexture()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: CUTã‚’RenderTextureã«æç”»
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  markThumbnailDirty()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: ã‚µãƒ ãƒã‚¤ãƒ«å†ç”Ÿæˆãƒ•ãƒ©ã‚°
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  createLayer()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId, { name, type }
æˆ»ã‚Šå€¤: layerId
å¤‰æ›´ç‚¹: cutIdå¿…é ˆåŒ–ã€parentIdå¯¾å¿œ
â–  getActiveLayer()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: LayerObject
å¤‰æ›´ç‚¹: CUTæŒ‡å®šç‰ˆã«å¤‰æ›´
â–  deleteLayer()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: layerId
æˆ»ã‚Šå€¤: void
å¤‰æ›´ç‚¹: dirtyæ›´æ–°è¿½åŠ 
â–  setLayerVisibility()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: è¡¨ç¤ºåˆ‡æ›¿
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: layerId, visible
æˆ»ã‚Šå€¤: void
å¤‰æ›´ç‚¹: dirtyæ›´æ–°è¿½åŠ 
ã€6.2 AnimationSystemã€‘
â–  addCut()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: CUTè¿½åŠ 
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: options
æˆ»ã‚Šå€¤: cutId
â–  removeCut()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: CUTå‰Šé™¤
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  gotoCut()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: CUTç§»å‹•
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  nextCut()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: æ¬¡ã®CUTã¸
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ãªã—
æˆ»ã‚Šå€¤: void
â–  prevCut()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: å‰ã®CUTã¸
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ãªã—
æˆ»ã‚Šå€¤: void
â–  playAnimation()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: å†ç”Ÿé–‹å§‹
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ãªã—
æˆ»ã‚Šå€¤: void
â–  pauseAnimation()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: å†ç”Ÿåœæ­¢
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ãªã—
æˆ»ã‚Šå€¤: void
ã€6.3 TimelineUIã€‘
â–  scheduleThrottledUpdate()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°äºˆç´„ï¼ˆthrottleï¼‰
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  processDirtyThumbnails()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: äºˆç´„æ¸ˆã¿æ›´æ–°ã‚’ä¸€æ‹¬å‡¦ç†
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ãªã—
æˆ»ã‚Šå€¤: void
â–  updateCutThumbnail()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: å˜ä¸€CUTã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  refreshTimeline()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: Timelineå…¨ä½“å†æç”»
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ãªã—
æˆ»ã‚Šå€¤: void
â–  renderCutElement()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: CUTè¦ç´ HTMLç”Ÿæˆ
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutObject
æˆ»ã‚Šå€¤: HTMLElement
â–  bindTimelineEvents()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ãªã—
æˆ»ã‚Šå€¤: void
ã€6.4 HistorySystemã€‘
â–  pushState()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: å±¥æ­´è¿½åŠ ï¼ˆCUTåˆ¥ï¼‰
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId, action, data
æˆ»ã‚Šå€¤: void
â–  undo()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: Undoï¼ˆCUTåˆ¥ï¼‰
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  redo()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: Redoï¼ˆCUTåˆ¥ï¼‰
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  clearHistory()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: CUTå‰Šé™¤æ™‚ã®å±¥æ­´ã‚¯ãƒªã‚¢
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: void
â–  canUndo()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: Undoå¯èƒ½åˆ¤å®š
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: boolean
â–  canRedo()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: Redoå¯èƒ½åˆ¤å®š
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: cutId
æˆ»ã‚Šå€¤: boolean
ã€6.5 GifExporterã€‘
â–  renderCutFrames()
ç¨®åˆ¥: æ–°è¦
èª¬æ˜: å…¨CUTã‚’Canvasé…åˆ—åŒ–
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ãªã—
æˆ»ã‚Šå€¤: Promise<Frame[]>
â–  exportGIF()
ç¨®åˆ¥: æ”¹ä¿®
èª¬æ˜: GIFç”Ÿæˆ
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: frames
æˆ»ã‚Šå€¤: Promise<Blob>
â–  downloadGIF()
ç¨®åˆ¥: ç¶™æ‰¿
èª¬æ˜: GIFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: blob, filename
æˆ»ã‚Šå€¤: void

7. æ”¹ä¿®ã®å„ªå…ˆé †ä½ã¨æ‰‹é †
Phase 1: CUTç‹¬ç«‹åŒ–ï¼ˆæœ€å„ªå…ˆï¼‰
ç›®çš„: å…¨CUTã«åŒã˜çµµãŒæç”»ã•ã‚Œã‚‹å•é¡Œã®è§£æ±º

layer-system.jsæ”¹ä¿®

createCut()å®Ÿè£…: Container + RenderTextureç”Ÿæˆ
setActiveCut()å®Ÿè£…: Containeråˆ‡ã‚Šæ›¿ãˆ
renderCutToTexture()å®Ÿè£…: æç”»å¾Œã®ãƒ†ã‚¯ã‚¹ãƒãƒ£æ›´æ–°


animation-system.jsæ”¹ä¿®

CUTç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’layerSystemã«å§”è­²
gotoCut()ã§layerSystem.setActiveCut()ã‚’å‘¼ã¶


æ¤œè¨¼

CUTé–“ã§çµµãŒç‹¬ç«‹ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
CUTåˆ‡ã‚Šæ›¿ãˆæ™‚ã«æ­£ã—ã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª



Phase 2: Timelineã‚µãƒ ãƒã‚¤ãƒ«æœ€é©åŒ–
ç›®çš„: ãƒãƒ©ã¤ãã¨å·¦ä¸Šã‚­ãƒ£ãƒ³ãƒã‚¹å‡ºç¾ã®è§£æ¶ˆ

layer-system.jsæ‹¡å¼µ

markThumbnailDirty()å®Ÿè£…
thumbnailDirtyãƒ•ãƒ©ã‚°ç®¡ç†


timeline-ui.jsæ”¹ä¿®

scheduleThrottledUpdate()å®Ÿè£…ï¼ˆ300ms throttleï¼‰
updateCutThumbnail()ã‚’å·®åˆ†æ›´æ–°ç‰ˆã«æ›¸ãæ›ãˆ
EventBusé€£æºï¼ˆcut:updatedã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ï¼‰


æ¤œè¨¼

æç”»æ™‚ã®ãƒãƒ©ã¤ããŒæ¶ˆãˆã‚‹ã“ã¨ã‚’ç¢ºèª
ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ãŒé©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¡Œã‚ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª



Phase 3: å±¥æ­´ã®CUTå˜ä½å¯¾å¿œ
ç›®çš„: Undo/RedoãŒCUTåˆ¥ã«å‹•ä½œã™ã‚‹

history.jsæ”¹ä¿®

historiesã‚’MapåŒ–
pushState(), undo(), redo()ã«cutIdè¿½åŠ 


core-runtime.jsèª¿æ•´

æç”»çµ‚äº†æ™‚ã«historySystem.pushState(activeCutId, ...)ã‚’å‘¼ã¶


æ¤œè¨¼

CUT1ã§Undo â†’ CUT2ã«å½±éŸ¿ã—ãªã„ã“ã¨ã‚’ç¢ºèª



Phase 4: GIF Exportæœ€é©åŒ–
ç›®çš„: RenderTextureã‹ã‚‰é«˜é€Ÿã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

gif-exporter.jsæ”¹ä¿®

renderCutFrames()ã‚’RenderTextureä½¿ç”¨ç‰ˆã«æ›¸ãæ›ãˆ


æ¤œè¨¼

å…¨CUTãŒæ­£ã—ãGIFã«å«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé€Ÿåº¦ã®å‘ä¸Šã‚’ç¢ºèª




8. æ¤œè¨¼é …ç›®
æ©Ÿèƒ½æ¤œè¨¼
é …ç›®æ¤œè¨¼å†…å®¹æœŸå¾…çµæœCUTç‹¬ç«‹æ€§CUT1ã«æç”»â†’CUT2ã«ç§»å‹•â†’CUT1ã«æˆ»ã‚‹CUT1ã®çµµãŒæ®‹ã£ã¦ã„ã‚‹Timelineåˆ‡æ›¿CUTåˆ‡æ›¿æ™‚ã®è¡¨ç¤ºæ­£ã—ã„CUTã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°æç”»æ™‚ã®ãƒãƒ©ã¤ããƒãƒ©ã¤ããªã—ã€å·¦ä¸Šã«ä½•ã‚‚å‡ºãªã„ã‚µãƒ ãƒã‚¤ãƒ«æ­£ç¢ºæ€§Timelineç”»åƒå®Ÿéš›ã®æç”»å†…å®¹ã¨ä¸€è‡´Undo/RedoCUTåˆ¥ã®å±¥æ­´ä»–CUTã«å½±éŸ¿ã—ãªã„GIF Exportå…¨CUTå‡ºåŠ›å„CUTãŒç‹¬ç«‹ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ã¨ã—ã¦å‡ºåŠ›
ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼
é …ç›®æ¸¬å®šæ–¹æ³•ç›®æ¨™å€¤æç”»ãƒ¬ã‚¹ãƒãƒ³ã‚¹requestAnimationFrameã®fps60fpsç¶­æŒã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°é »åº¦console.timeæ¸¬å®š300msä»¥ä¸‹ã®é–“éš”GIF Exportæ™‚é–“10CUTã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚é–“5ç§’ä»¥å†…
äº’æ›æ€§æ¤œè¨¼
é …ç›®ç¢ºèªå†…å®¹æ—¢å­˜ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒ»å‰Šé™¤ãƒ»å¯è¦–æ€§ãŒå‹•ä½œã‚«ãƒ¡ãƒ©æ“ä½œPan/ZoomãŒå…¨CUTã§æ©Ÿèƒ½ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆCtrl+Zç­‰ãŒæ­£å¸¸å‹•ä½œ

ğŸ“Œ é‡è¦ãªè¨­è¨ˆåˆ¤æ–­
ãªãœRenderTextureã‚’ä½¿ã†ã®ã‹ï¼Ÿ

GPUä¸Šã§ã®ç‹¬ç«‹æ€§: å„CUTãŒç‹¬è‡ªã®GPUãƒ¡ãƒ¢ãƒªé ˜åŸŸã‚’æŒã¤
æç”»åŠ¹ç‡: æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å†åˆæˆã›ãšã€RenderTextureã‚’ãã®ã¾ã¾è¡¨ç¤º
Extractæœ€é©åŒ–: RenderTextureã‹ã‚‰ç›´æ¥CanvasæŠ½å‡ºå¯èƒ½

ãªãœCUTã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€ã‚’åŒã˜æ§‹é€ ã«ã™ã‚‹ã®ã‹ï¼Ÿ

å°†æ¥ã®æ‹¡å¼µæ€§: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€å®Ÿè£…æ™‚ã«ã‚³ãƒ¼ãƒ‰ã‚’å†åˆ©ç”¨ã§ãã‚‹
ä¸€è²«æ€§: éšå±¤æ§‹é€ ã®æ‰±ã„ãŒçµ±ä¸€ã•ã‚Œã‚‹
ç†è§£ã—ã‚„ã™ã•: AIæ”¹ä¿®æ™‚ã®èªçŸ¥è² è·ãŒæ¸›ã‚‹

throttle 300msã®æ ¹æ‹ 

äººé–“ã®çŸ¥è¦š: 100msä»¥ä¸‹ã®é…å»¶ã¯æ°—ã¥ã‹ã‚Œãªã„
æç”»é »åº¦: 60fpsã§ã‚‚16.7msé–“éš”ãªã®ã§ã€300msã¯ååˆ†ãªé–“å¼•ã
GPUè² è·: extract.canvas()ã¯é‡ã„å‡¦ç†ãªã®ã§ã€éåº¦ãªå‘¼ã³å‡ºã—ã‚’é˜²ã


ğŸš¨ æ³¨æ„äº‹é …
localStorageç¦æ­¢

PixiJS v8.13ç’°å¢ƒã§ã¯ä½¿ç”¨ä¸å¯
å…¨ã¦ãƒ¡ãƒ¢ãƒªä¸Šã§ç®¡ç†ï¼ˆSessionçµ‚äº†ã§æ¶ˆãˆã‚‹è¨­è¨ˆï¼‰

Canvas2Dä½¿ç”¨ç®‡æ‰€ã®é™å®š

ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ™‚ã®extract.canvas()ã®ã¿è¨±å¯
æç”»æœ¬ä½“ã¯å¿…ãšPixiJSï¼ˆWebGLï¼‰ã‚’ä½¿ç”¨

åº§æ¨™ç³»ã®ä¸€è²«æ€§

å…¨ã¦ã®åº§æ¨™ã¯coordinate-system.jsçµŒç”±ã§å¤‰æ›
Containeré–“ã®è¦ªå­é–¢ä¿‚ã«æ³¨æ„ï¼ˆCUTâ†’Layerï¼‰


æ‰€ã®é™å®šã€‘

ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ™‚ã®extract.canvas()ã®ã¿è¨±å¯
æç”»æœ¬ä½“ã¯å¿…ãšPixiJSï¼ˆWebGLï¼‰ã‚’ä½¿ç”¨

ã€åº§æ¨™ç³»ã®ä¸€è²«æ€§ã€‘

å…¨ã¦ã®åº§æ¨™ã¯coordinate-system.jsçµŒç”±ã§å¤‰æ›
Containeré–“ã®è¦ªå­é–¢ä¿‚ã«æ³¨æ„ï¼ˆCUTâ†’Layerï¼‰

================================================================================
è£œè¶³: å®Ÿè£…æ™‚ã®å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹
ã€LayerSystem.createCut() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘
createCut(options = {}) {
const id = options.id || cut_${Date.now()};
const name = options.name || Cut ${this.cuts.size + 1};
const duration = options.duration || 1000;
// Containerä½œæˆ
const container = new PIXI.Container();
container.label = name;
this.stage.addChild(container);
// RenderTextureä½œæˆ
const renderTexture = PIXI.RenderTexture.create({
width: this.app.screen.width,
height: this.app.screen.height
});
// CUTã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
const cut = {
id: id,
type: 'cut',
name: name,
duration: duration,
container: container,
renderTexture: renderTexture,
layers: [],
activeLayerId: null,
visible: false,
locked: false,
thumbnailCache: null,
thumbnailDirty: true
};
this.cuts.set(id, cut);
this.cutOrder.push(id);
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
const defaultLayerId = this.createLayer(id, { name: 'Layer 1' });
cut.activeLayerId = defaultLayerId;
return id;
}
ã€LayerSystem.setActiveCut() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘
setActiveCut(cutId) {
if (!this.cuts.has(cutId)) {
throw new Error(Cut not found: ${cutId});
}
// æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTã‚’éè¡¨ç¤º
if (this.activeCutId) {
const oldCut = this.cuts.get(this.activeCutId);
if (oldCut) {
oldCut.container.visible = false;
}
}
// æ–°ã—ã„CUTã‚’è¡¨ç¤º
const newCut = this.cuts.get(cutId);
newCut.container.visible = true;
this.activeCutId = cutId;
// ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
if (window.eventBus) {
window.eventBus.emit('cut:changed', { cutId: cutId });
}
}
ã€LayerSystem.renderCutToTexture() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘
renderCutToTexture(cutId) {
const cut = this.cuts.get(cutId);
if (!cut) return;
// CUTã®Containerã‚’RenderTextureã«æç”»
this.renderer.render({
container: cut.container,
target: cut.renderTexture,
clear: true
});
// ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
this.markThumbnailDirty(cutId);
}
ã€LayerSystem.markThumbnailDirty() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘
markThumbnailDirty(cutId) {
const cut = this.cuts.get(cutId);
if (cut) {
cut.thumbnailDirty = true;
// Timeline UIã«é€šçŸ¥
if (window.eventBus) {
  window.eventBus.emit('cut:updated', { cutId: cutId });
}
}
}
ã€TimelineUI.scheduleThrottledUpdate() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘
scheduleThrottledUpdate(cutId) {
// dirtyãƒ•ãƒ©ã‚°ã«è¿½åŠ 
this.dirtyFlags.add(cutId);
// æ—¢ã«throttleä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
if (this.updateThrottle) return;
// 300mså¾Œã«å®Ÿè¡Œ
this.updateThrottle = setTimeout(() => {
this.processDirtyThumbnails();
this.updateThrottle = null;
}, 300);
}
ã€TimelineUI.processDirtyThumbnails() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘
processDirtyThumbnails() {
for (const cutId of this.dirtyFlags) {
this.updateCutThumbnail(cutId);
}
this.dirtyFlags.clear();
}
ã€TimelineUI.updateCutThumbnail() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘
updateCutThumbnail(cutId) {
const cut = this.layerSystem.getCut(cutId);
if (!cut) return;
// å·®åˆ†ãƒã‚§ãƒƒã‚¯
if (!cut.thumbnailDirty) return;
// Extractå®Ÿè¡Œï¼ˆGPU â†’ CPUè»¢é€ï¼‰
const canvas = this.layerSystem.renderer.extract.canvas(cut.container);
// Canvas2D â†’ Data URLå¤‰æ›
const dataURL = canvas.toDataURL('image/png');
// DOMæ›´æ–°
const imgElement = document.querySelector(
[data-cut-id="${cutId}"] .timeline-thumbnail
);
if (imgElement) {
imgElement.src = dataURL;
}
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã¨ãƒ•ãƒ©ã‚°ã‚¯ãƒªã‚¢
cut.thumbnailCache = canvas;
cut.thumbnailDirty = false;
}
ã€AnimationSystem.gotoCut() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘
gotoCut(cutId) {
if (!this.layerSystem.cuts.has(cutId)) {
throw new Error(Cut not found: ${cutId});
}
// LayerSystemã«åˆ‡æ›¿ã‚’å§”è­²
this.layerSystem.setActiveCut(cutId);
// ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
this.currentCutIndex = this.layerSystem.cutOrder.indexOf(cutId);
}
ã€HistorySystem.pushState() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆCUTåˆ¥å¯¾å¿œï¼‰ã€‘
pushState(cutId, action, data) {
// CUTåˆ¥ã®å±¥æ­´ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°ä½œæˆï¼‰
if (!this.histories.has(cutId)) {
this.histories.set(cutId, []);
this.historyIndices.set(cutId, -1);
}
const history = this.histories.get(cutId);
let index = this.historyIndices.get(cutId);
// ç¾åœ¨ä½ç½®ã‚ˆã‚Šå¾Œã‚ã®å±¥æ­´ã‚’å‰Šé™¤
history.splice(index + 1);
// æ–°ã—ã„å±¥æ­´ã‚’è¿½åŠ 
history.push({
action: action,
data: data,
timestamp: Date.now()
});
// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é€²ã‚ã‚‹
index = history.length - 1;
this.historyIndices.set(cutId, index);
// å±¥æ­´ä¸Šé™ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: 50ä»¶ï¼‰
if (history.length > 50) {
history.shift();
this.historyIndices.set(cutId, index - 1);
}
}
ã€HistorySystem.undo() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆCUTåˆ¥å¯¾å¿œï¼‰ã€‘
undo(cutId) {
if (!this.canUndo(cutId)) return;
const history = this.histories.get(cutId);
let index = this.historyIndices.get(cutId);
// ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—
const state = history[index];
// çŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆactionã«å¿œã˜ãŸå‡¦ç†ï¼‰
this.restoreState(cutId, state);
// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æˆ»ã™
index--;
this.historyIndices.set(cutId, index);
// ç”»é¢æ›´æ–°
this.layerSystem.renderCutToTexture(cutId);
}
ã€GifExporter.renderCutFrames() ã®å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘
async renderCutFrames() {
const frames = [];
const cutOrder = this.layerSystem.cutOrder;
for (const cutId of cutOrder) {
const cut = this.layerSystem.getCut(cutId);
// RenderTextureãŒæœªæ›´æ–°ãªã‚‰æç”»
if (cut.thumbnailDirty) {
  this.layerSystem.renderCutToTexture(cutId);
}

// RenderTextureã‹ã‚‰ç›´æ¥Canvaså–å¾—
const canvas = this.layerSystem.renderer.extract.canvas(cut.renderTexture);

frames.push({
  canvas: canvas,
  delay: cut.duration,
  cutId: cutId
});

// UIå‡çµé˜²æ­¢ã®ãŸã‚éåŒæœŸå¾…æ©Ÿ
await new Promise(resolve => setTimeout(resolve, 0));
}
return frames;
}
================================================================================
EventBusã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§
æ”¹ä¿®ã«ä¼´ã„æ–°è¦è¿½åŠ ãƒ»å¤‰æ›´ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
ã€æ–°è¦è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆã€‘
â–  cut:created
ç™ºç«å…ƒ: LayerSystem.createCut()
ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰: { cutId }
ç”¨é€”: Timeline UIã®æ›´æ–°
â–  cut:deleted
ç™ºç«å…ƒ: LayerSystem.deleteCut()
ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰: { cutId }
ç”¨é€”: Timeline UIã‹ã‚‰CUTå‰Šé™¤
â–  cut:changed
ç™ºç«å…ƒ: LayerSystem.setActiveCut()
ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰: { cutId }
ç”¨é€”: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ãƒ»Timeline UIã®åŒæœŸ
â–  cut:updated
ç™ºç«å…ƒ: LayerSystem.markThumbnailDirty()
ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰: { cutId }
ç”¨é€”: Timelineã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
ã€æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆã®å¤‰æ›´ã€‘
â–  layer:created
å¤‰æ›´ç‚¹: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«cutIdã‚’è¿½åŠ 
æ–°ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰: { layerId, cutId }
â–  layer:deleted
å¤‰æ›´ç‚¹: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«cutIdã‚’è¿½åŠ 
æ–°ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰: { layerId, cutId }
â–  layer:visibility:changed
å¤‰æ›´ç‚¹: è¦ªCUTã®dirtyãƒ•ãƒ©ã‚°æ›´æ–°ã‚’è¿½åŠ 
æ–°ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰: { layerId, cutId, visible }
================================================================================
æ”¹ä¿®å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«é–“ä¾å­˜é–¢ä¿‚
core-engine.js
â”œâ”€ ä¾å­˜: ãªã—
â””â”€ ç”Ÿæˆ: app, eventBus, layerSystem, cameraSystem, animationSystem,
historySystem, gifExporter, timelineUI, uiPanels
system/layer-system.js
â”œâ”€ ä¾å­˜: PIXI, eventBus
â””â”€ ä½¿ç”¨å…ƒ: animationSystem, historySystem, timelineUI, uiPanels,
core-runtime
system/animation-system.js
â”œâ”€ ä¾å­˜: layerSystem, eventBus
â””â”€ ä½¿ç”¨å…ƒ: timelineUI, core-runtime
system/history.js
â”œâ”€ ä¾å­˜: layerSystem, eventBus
â””â”€ ä½¿ç”¨å…ƒ: core-runtime, uiPanels
system/gif-exporter.js
â”œâ”€ ä¾å­˜: layerSystem, animationSystem, gif.js
â””â”€ ä½¿ç”¨å…ƒ: uiPanelsï¼ˆExportå®Ÿè¡Œæ™‚ï¼‰
ui/timeline-ui.js
â”œâ”€ ä¾å­˜: layerSystem, animationSystem, eventBus
â””â”€ ä½¿ç”¨å…ƒ: ãªã—ï¼ˆUIãƒ¬ã‚¤ãƒ¤ãƒ¼æœ€ä¸Šä½ï¼‰
ui/ui-panels.js
â”œâ”€ ä¾å­˜: layerSystem, historySystem, gifExporter, eventBus
â””â”€ ä½¿ç”¨å…ƒ: ãªã—ï¼ˆUIãƒ¬ã‚¤ãƒ¤ãƒ¼æœ€ä¸Šä½ï¼‰
core-runtime.js
â”œâ”€ ä¾å­˜: layerSystem, animationSystem, historySystem, cameraSystem,
eventBus
â””â”€ ä½¿ç”¨å…ƒ: ãªã—ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼‰
================================================================================
æ”¹ä¿®æ™‚ã®æ³¨æ„ç‚¹ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
ã€å•é¡Œ: CUTåˆ‡æ›¿æ™‚ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ¶ˆãˆã‚‹ã€‘
åŸå› å€™è£œ:

setActiveCut()ã§container.visible = trueã«ã—å¿˜ã‚Œ
ContainerãŒstageã«è¿½åŠ ã•ã‚Œã¦ã„ãªã„
z-indexãŒä»–ã®CUTã®ä¸‹ã«ãªã£ã¦ã„ã‚‹

å¯¾å‡¦æ³•:

createCut()ã§stage.addChild(container)ã‚’ç¢ºèª
setActiveCut()ã§visibleãƒ•ãƒ©ã‚°ã®è¨­å®šã‚’ç¢ºèª
Container.zIndexã‚’æ˜ç¤ºçš„ã«è¨­å®š

ã€å•é¡Œ: ã‚µãƒ ãƒã‚¤ãƒ«ãŒçœŸã£ç™½/çœŸã£é»’ã«ãªã‚‹ã€‘
åŸå› å€™è£œ:

renderCutToTexture()ãŒå‘¼ã°ã‚Œã¦ã„ãªã„
extract.canvas()ã®å¯¾è±¡ãŒç©ºã®Container
RenderTextureã®ã‚µã‚¤ã‚ºãŒ0

å¯¾å‡¦æ³•:

æç”»å¾Œã«å¿…ãšrenderCutToTexture()ã‚’å‘¼ã¶
Containerã«å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
RenderTextureä½œæˆæ™‚ã®width/heightã‚’ç¢ºèª

ã€å•é¡Œ: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒç™ºç”Ÿã™ã‚‹ã€‘
åŸå› å€™è£œ:

deleteCut()æ™‚ã«RenderTexture.destroy()ã‚’å‘¼ã‚“ã§ã„ãªã„
EventBusã®ãƒªã‚¹ãƒŠãƒ¼ãŒè§£é™¤ã•ã‚Œã¦ã„ãªã„
Canvasè¦ç´ ãŒDOMä¸Šã«æ®‹ã‚Šç¶šã‘ã¦ã„ã‚‹

å¯¾å‡¦æ³•:

deleteCut()ã§ä»¥ä¸‹ã‚’å¿…ãšå®Ÿè¡Œ:

renderTexture.destroy(true)
container.destroy({ children: true })
eventBus.off()ã§å…¨ãƒªã‚¹ãƒŠãƒ¼è§£é™¤


thumbnailCacheã‚‚æ˜ç¤ºçš„ã«nullã«ã™ã‚‹

ã€å•é¡Œ: Timelineæ›´æ–°ãŒé…ã„ã€‘
åŸå› å€™è£œ:

throttleãŒåŠ¹ã„ã¦ã„ãªã„
æ¯ãƒ•ãƒ¬ãƒ¼ãƒ extract.canvas()ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹
å¤§é‡ã®CUTãŒå­˜åœ¨ã™ã‚‹

å¯¾å‡¦æ³•:

scheduleThrottledUpdate()ã®å®Ÿè£…ã‚’ç¢ºèª
updateCutThumbnail()ã®å‘¼ã³å‡ºã—å›æ•°ã‚’console.countã§è¨ˆæ¸¬
CUTæ•°ãŒå¤šã„å ´åˆã¯ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å°å…¥ã‚’æ¤œè¨

ã€å•é¡Œ: Undo/RedoãŒå‹•ä½œã—ãªã„ã€‘
åŸå› å€™è£œ:

pushState()ã«cutIdã‚’æ¸¡ã—ã¦ã„ãªã„
å±¥æ­´MapãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„
å¾©å…ƒå‡¦ç†ãŒä¸å®Œå…¨

å¯¾å‡¦æ³•:

core-runtime.jsã®æç”»çµ‚äº†æ™‚ã«cutIdã‚’æ¸¡ã—ã¦ã„ã‚‹ã‹ç¢ºèª
HistorySystem.initialize()ã§å„CUTã®å±¥æ­´ã‚’åˆæœŸåŒ–
restoreState()ã®å®Ÿè£…ã‚’ç¢ºèª

================================================================================
å°†æ¥çš„ãªæ‹¡å¼µã¸ã®æº–å‚™
ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€å®Ÿè£…æ™‚ã®å¯¾å¿œã€‘
ç¾åœ¨ã®CUTæ§‹é€ ã‚’è¸è¥²ã™ã‚‹ã“ã¨ã§ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€ã¯ä»¥ä¸‹ã®å¤‰æ›´ã®ã¿ã§å®Ÿè£…å¯èƒ½:

LayerObjectã«childrenãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¿½åŠ 
{
id: 'folder_xxx',
type: 'folder',
name: 'Folder 1',
parentId: 'cut_xxx',
children: ['layer_yyy', 'layer_zzz'],
expanded: true,
visible: true,
locked: false
}
createFolder()ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
LayerSystem.createFolder(parentId, options)
å†å¸°çš„ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç†
renderFolderRecursive(folderId)
UIå´ã®éšå±¤è¡¨ç¤º
ui-panels.jsã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆè¡¨ç¤ºå®Ÿè£…

ã€ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³å®Ÿè£…æ™‚ã®å¯¾å¿œã€‘
RenderTextureã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³ã¯æ¯”è¼ƒçš„ç°¡å˜ã«å®Ÿè£…å¯èƒ½:

å‰å¾Œã®CUTã®RenderTextureã‚’å–å¾—
åŠé€æ˜ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
ã‚«ã‚¹ã‚¿ãƒ ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã§è‰²èª¿å¤‰æ›´ï¼ˆèµ¤/é’ãªã©ï¼‰

ã€ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å†ç”Ÿã®æ‹¡å¼µã€‘
ç¾åœ¨ã®è¨­è¨ˆã§ã¯ä»¥ä¸‹ãŒå®¹æ˜“ã«å®Ÿè£…å¯èƒ½:

ãƒ•ãƒ¬ãƒ¼ãƒ è£œé–“ï¼ˆTweeningï¼‰
å„CUTé–“ã§è£œé–“ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ç”Ÿæˆ
ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é–¢æ•°å¯¾å¿œ
CUTé·ç§»æ™‚ã«ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é©ç”¨
ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
cutOrderã‚’å¾ªç’°ã•ã›ã‚‹

================================================================================
æœ€çµ‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
Phase 1å®Ÿè£…å¾Œ:
â–¡ createCut()ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
â–¡ setActiveCut()ã§CUTãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹
â–¡ å„CUTã§ç‹¬ç«‹ã—ã¦æç”»ã§ãã‚‹
â–¡ CUTé–“ã§çµµãŒæ··ã–ã‚‰ãªã„
Phase 2å®Ÿè£…å¾Œ:
â–¡ æç”»æ™‚ã®ãƒãƒ©ã¤ããŒæ¶ˆãˆãŸ
â–¡ å·¦ä¸Šã«ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒå‡ºãªããªã£ãŸ
â–¡ ã‚µãƒ ãƒã‚¤ãƒ«ãŒæ­£ç¢ºã«æ›´æ–°ã•ã‚Œã‚‹
â–¡ 300ms throttleãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹
Phase 3å®Ÿè£…å¾Œ:
â–¡ CUTåˆ¥ã«Undo/RedoãŒå‹•ä½œã™ã‚‹
â–¡ ä»–CUTã«å½±éŸ¿ã—ãªã„
â–¡ å±¥æ­´ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã‚‹
Phase 4å®Ÿè£…å¾Œ:
â–¡ GIF ExportãŒé«˜é€ŸåŒ–ã—ãŸ
â–¡ å…¨CUTãŒæ­£ã—ãå‡ºåŠ›ã•ã‚Œã‚‹
â–¡ ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒãªã„
å…¨Phaseå®Œäº†å¾Œ:
â–¡ æ—¢å­˜æ©Ÿèƒ½ãŒå…¨ã¦å‹•ä½œã™ã‚‹
â–¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒ60fpsç¶­æŒ
â–¡ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒé©åˆ‡
â–¡ ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãŒé«˜ã„
================================================================================
çµ‚ã‚ã‚Šã«
æœ¬æ”¹ä¿®è¨ˆç”»æ›¸ã¯ã€AIãŒæ”¹ä¿®ä½œæ¥­ã‚’è¡Œã†éš›ã®å®Œå…¨ãªã‚¬ã‚¤ãƒ‰ã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’
ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚
å„ãƒ•ã‚§ãƒ¼ã‚ºã¯ç‹¬ç«‹ã—ã¦ãŠã‚Šã€æ®µéšçš„ãªå®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã§ã™ã€‚
å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€æœ¬æ›¸ã®ã€Œæ”¹ä¿®æ™‚ã®æ³¨æ„ç‚¹ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€
ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
æ”¹ä¿®å®Œäº†å¾Œã¯ã€å…¨ã¦ã®æ¤œè¨¼é …ç›®ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚å†è©¦è¡ŒClaudeã¯ç¾åœ¨ã€ç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚