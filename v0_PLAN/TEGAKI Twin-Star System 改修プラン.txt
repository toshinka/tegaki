# TEGAKI Twin-Star System æ”¹ä¿®ãƒ—ãƒ©ãƒ³

## ğŸ¯ ç›®æ¨™ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
Twin-Star System
â”œâ”€â”€ UI Star (index.htmlä¸­å¿ƒ)
â”‚   â”œâ”€â”€ config.js âœ… å®Œæˆ
â”‚   â”œâ”€â”€ ui-panels.js âœ… å®Œæˆ  
â”‚   â””â”€â”€ ui-tools.js (æ–°è¦ä½œæˆäºˆå®š)
â””â”€â”€ Engine Star (core-runtime.jsä¸­å¿ƒ) 
    â”œâ”€â”€ coordinate-system.js (æ–°è¦)
    â”œâ”€â”€ layer-system.js (åˆ†é›¢)
    â”œâ”€â”€ drawing-engine.js (åˆ†é›¢)
    â”œâ”€â”€ transform-utils.js (æ–°è¦)
    â””â”€â”€ clipboard-system.js (åˆ†é›¢)
```

## ğŸ“… Phase 0 - å³åº§å¯¾å¿œ (1æ—¥)

### P0.1 åº§æ¨™ç³»ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã«åº§æ¨™ç³»ã®æ˜ç¤ºçš„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 

```javascript
// BEFORE
const canvasPoint = this.cameraSystem.screenToCanvas(screenX, screenY);

// AFTER  
// coord: screen -> world
const canvasPoint = this.cameraSystem.screenToCanvas(screenX, screenY);
```

### P0.2 åº§æ¨™å¤‰æ›ãƒ¡ã‚½ãƒƒãƒ‰çµ±åˆ
`screenToCanvasForDrawing`ã¨`screenToCanvas`ã®ä½¿ã„åˆ†ã‘ã‚’æ˜ç¢ºåŒ–

```javascript
// çµ±åˆã•ã‚ŒãŸåº§æ¨™å¤‰æ›API
class CoordinateSystem {
  // coord: screen -> canvas (æç”»ç”¨)
  screenToCanvas(app, screenX, screenY) { /* ... */ }
  
  // coord: screen -> world (ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œç”¨)  
  screenToWorld(app, screenX, screenY) { /* ... */ }
  
  // coord: world -> screen
  worldToScreen(app, worldX, worldY) { /* ... */ }
}
```

## ğŸ“… Phase 1 - åº§æ¨™ç³»çµ±ä¸€ (1é€±é–“)

### P1.1 coordinate-system.js ä½œæˆ
å˜ä¸€è²¬ä»»ã§åº§æ¨™å¤‰æ›ã‚’ç®¡ç†

```javascript
window.CoordinateSystem = {
  // æ˜ç¤ºçš„ãªåº§æ¨™ç©ºé–“å¤‰æ›
  screenToWorld(app, x, y) {
    // coord: screen -> world
    const point = new PIXI.Point(x, y);
    return app.stage.toLocal(point);
  },
  
  worldToLayer(layer, worldX, worldY) {
    // coord: world -> layer
    return layer.toLocal(new PIXI.Point(worldX, worldY));
  },
  
  // å¤‰å½¢é©ç”¨ï¼ˆpivotè€ƒæ…®ï¼‰
  transformPoint(point, pivot, transform) {
    // çµ±ä¸€ã•ã‚ŒãŸå¤‰å½¢è¨ˆç®—
    return this.applyTransformMatrix(point, pivot, transform);
  }
};
```

### P1.2 core-engine.jså†…ã®åº§æ¨™å¤‰æ›ã‚’ç½®æ›
- `container.toLocal()` â†’ `CoordinateSystem.worldToLayer()`
- `container.toGlobal()` â†’ `CoordinateSystem.layerToWorld()`

### P1.3 åº§æ¨™ç©ºé–“æ¤œè¨¼ã®è¿½åŠ 
```javascript
function validateCoordSpace(point, expectedSpace) {
  if (!point._coordSpace || point._coordSpace !== expectedSpace) {
    throw new Error(`Expected ${expectedSpace} coordinates, got ${point._coordSpace || 'unknown'}`);
  }
}
```

## ğŸ“… Phase 2 - Engine Star ä½œæˆ (3æ—¥)

### P2.1 core-runtime.js ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ä½œæˆ
```javascript
window.CoreRuntime = {
  coord: CoordinateSystem,
  camera: CameraSystem, 
  layer: LayerSystem,
  transform: TransformUtils,
  draw: DrawingEngine,
  
  // çµ±ä¸€API
  api: {
    // ã‚«ãƒ¡ãƒ©æ“ä½œ
    panCamera: (dx, dy) => CoreRuntime.camera.pan(dx, dy),
    zoomCamera: (factor, centerX, centerY) => CoreRuntime.camera.zoom(factor, centerX, centerY),
    
    // ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ
    transformActiveLayer: (transform, pivotMode) => {
      const layer = CoreRuntime.layer.getActive();
      CoreRuntime.transform.applyNonDestructive(layer, transform, pivotMode);
    }
  }
};
```

### P2.2 CameraSystem ã®åˆ†é›¢
core-engine.js ã‹ã‚‰ CameraSystem ã‚¯ãƒ©ã‚¹ã‚’ camera-system.js ã«ç§»å‹•

### P2.3 UIå±¤ã®å‚ç…§æ›´æ–°
index.htmlå†…ã® `TegakiCore.*` â†’ `CoreRuntime.*`

## ğŸ“… Phase 3 - ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ åˆ†é›¢ (1é€±é–“)

### P3.1 layer-system.js ä½œæˆ - ãƒ‘ã‚¹ä¸­å¿ƒè¨­è¨ˆ
```javascript
// ãƒ‘ã‚¹ä¸­å¿ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
const Layer = {
  id: 'layer_xxx',
  paths: [
    {
      id: 'path_xxx', 
      points: [{x: 10, y: 20}, ...], // coord: layer space
      style: {color: 0x800000, width: 5},
      closed: false
    }
  ],
  transform: {scale: 1, rotation: 0, tx: 0, ty: 0}, // ä¸€æ™‚çš„å¤‰å½¢
  container: pixiContainer, // è¡¨ç¤ºç”¨
  cache: renderTexture || null // ã‚­ãƒ£ãƒƒã‚·ãƒ¥
};
```

### P3.2 éç ´å£Šå¤‰å½¢ã®å®Ÿè£…
```javascript
TransformUtils.applyTransformToPaths(layer, transform, pivotMode) {
  const pivot = this.getPivotPoint(layer, pivotMode);
  
  // ãƒ‘ã‚¹ãƒ‡ãƒ¼ã‚¿ã«ç›´æ¥å¤‰å½¢é©ç”¨ï¼ˆéç ´å£Šï¼‰
  layer.paths.forEach(path => {
    path.points = path.points.map(point => {
      // coord: layer -> world -> transformed -> layer
      return this.transformPointWithPivot(point, pivot, transform);
    });
  });
  
  // è¡¨ç¤ºå¤‰å½¢ã‚’ãƒªã‚»ãƒƒãƒˆ
  layer.container.position.set(0, 0);
  layer.container.scale.set(1, 1);
  layer.container.rotation = 0;
}
```

### P3.3 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã‚·ã‚¹ãƒ†ãƒ 
```javascript
// ãƒ€ãƒ¼ãƒ†ã‚£ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹é¸æŠçš„æ›´æ–°
class LayerSystem {
  markDirty(layerId, reason) {
    this.dirtyLayers.add(layerId);
    this.dirtyReasons.set(layerId, reason);
  }
  
  processDirtyLayers() {
    this.dirtyLayers.forEach(layerId => {
      const layer = this.getLayer(layerId);
      const reason = this.dirtyReasons.get(layerId);
      
      if (reason === 'transform') {
        this.rebuildGraphics(layer);
        this.updateThumbnail(layer);
      }
    });
  }
}
```

## ğŸ“… Phase 4 - æç”»ã‚¨ãƒ³ã‚¸ãƒ³åˆ†é›¢ (3æ—¥)

### P4.1 drawing-engine.js ä½œæˆ
æç”»ã¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢

```javascript
window.DrawingEngine = {
  // ãƒ‘ã‚¹ã‹ã‚‰Graphicså†æ§‹ç¯‰
  rebuildGraphicsFromPath(path, graphics, style) {
    graphics.clear();
    
    if (path.points.length === 0) return;
    
    // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
    graphics.lineStyle(style.width, style.color, style.alpha);
    
    // ãƒ‘ã‚¹æç”»
    graphics.moveTo(path.points[0].x, path.points[0].y);
    path.points.slice(1).forEach(point => {
      graphics.lineTo(point.x, point.y);
    });
  },
  
  // ãƒ–ãƒ©ã‚·ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ²
  recordBrushStroke(startPoint, endPoint, pressure, style) {
    return {
      id: this.generateId(),
      points: this.interpolateStroke(startPoint, endPoint, pressure),
      style: {...style},
      timestamp: Date.now()
    };
  }
};
```

### P4.2 æç”»æœ€é©åŒ–
- ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æ”¹å–„
- ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åŠ¹ç‡åŒ–
- é¸æŠçš„Graphicsæ›´æ–°

## ğŸ“… Phase 5 - æœ€çµ‚çµ±åˆ (3æ—¥)

### P5.1 core-engine.js å‰Šé™¤å‰ã®æ¤œè¨¼
- å…¨æ©Ÿèƒ½ãŒæ–°ã‚·ã‚¹ãƒ†ãƒ ã«ç§»è¡Œæ¸ˆã¿ã‹ç¢ºèª
- å¾ªç’°ä¾å­˜ãŒãªã„ã‹æ¤œè¨¼
- ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã‹ç¢ºèª

### P5.2 ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
```bash
# å‰Šé™¤å¯¾è±¡
rm core-engine.js
rm duplicate-coordinate-methods.js
```

### P5.3 æœ€çµ‚çµ±åˆãƒ†ã‚¹ãƒˆ
- åº§æ¨™å¤‰æ›ã®å¾€å¾©ç²¾åº¦ãƒ†ã‚¹ãƒˆ
- ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢ã®éç ´å£Šæ€§ç¢ºèª
- ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆã®å®Œå…¨æ€§ç¢ºèª

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ğŸ“ˆ æ€§èƒ½å‘ä¸Š
- **åº§æ¨™å¤‰æ›**: < 1ms (ç¾åœ¨: 2-5ms)
- **ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡ã‚Šæ›¿ãˆ**: < 8ms (ç¾åœ¨: 15-30ms)  
- **å¤‰å½¢æ“ä½œ**: < 16ms (ç¾åœ¨: 30-50ms)

### ğŸ§¹ ã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Š
- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: å„1500è¡Œä»¥ä¸‹ (ç¾åœ¨: core-engine.js 4000è¡Œ+)
- **è²¬ä»»åˆ†é›¢**: å˜ä¸€è²¬ä»»åŸå‰‡ã®å¾¹åº•
- **åº§æ¨™ç³»ãƒã‚°**: ã‚¼ãƒ­ (æ˜ç¤ºçš„ãªå‹ã‚·ã‚¹ãƒ†ãƒ )

### ğŸ”§ ä¿å®ˆæ€§å‘ä¸Š
- **Claudeæ”¹ä¿®åŠ¹ç‡**: 70%å‘ä¸Š (æ˜ç¢ºãªAPIå¢ƒç•Œ)
- **æ©Ÿèƒ½è¿½åŠ é€Ÿåº¦**: 50%å‘ä¸Š (ç–çµåˆè¨­è¨ˆ)
- **ãƒã‚°ç‰¹å®šæ™‚é–“**: 80%çŸ­ç¸® (è²¬ä»»ç¯„å›²æ˜ç¢ºåŒ–)

## âš ï¸ æ³¨æ„äº‹é …

### ğŸš« çµ¶å¯¾ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³
- `try-catch`ã§ã®ã‚¨ãƒ©ãƒ¼éš è”½
- `||`æ¼”ç®—å­ã§ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
- åº§æ¨™å¤‰æ›ã®ç›´æ¥`toLocal`/`toGlobal`å‘¼ã³å‡ºã—
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†

### âœ… å¿…é ˆãƒ‘ã‚¿ãƒ¼ãƒ³
- åº§æ¨™ç©ºé–“ã®æ˜ç¤ºçš„ã‚³ãƒ¡ãƒ³ãƒˆ
- å˜ä¸€è²¬ä»»ã®å¾¹åº•
- ã‚¤ãƒ™ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹é€šä¿¡
- éç ´å£Šçš„ãƒ‘ã‚¹æ“ä½œ
- æ˜ç¤ºçš„ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾

## ğŸš€ é–‹å§‹ææ¡ˆ

**ã¾ãšã¯Phase 0ã‹ã‚‰é–‹å§‹ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚**

Phase 0ã¯1æ—¥ã§å®Œäº†ã—ã€æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ã‚’æœ€å°é™ã«æŠ‘ãˆãªãŒã‚‰ã€å¾Œç¶šãƒ•ã‚§ãƒ¼ã‚ºã®æº–å‚™ã‚’æ•´ãˆã¾ã™ã€‚ç‰¹ã«åº§æ¨™ç³»ã‚³ãƒ¡ãƒ³ãƒˆã®è¿½åŠ ã¯ã€Claude/AIã®ç†è§£ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã€ä»¥é™ã®æ”¹ä¿®ä½œæ¥­ã®ç²¾åº¦ã‚’é«˜ã‚ã¾ã™ã€‚

æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€å„ãƒ•ã‚§ãƒ¼ã‚ºã§ã®å‹•ä½œç¢ºèªã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã®ç¢ºä¿ãŒå¯èƒ½ã§ã™ã€‚