# tegaki-loader.js å®Œå…¨ç§»æ¤æ”¹ä¿®è¨ˆç”»æ›¸

## ğŸ“‹ ç¾çŠ¶åˆ†æ

### å®¹é‡æ¯”è¼ƒ
- **index.html**: ç´„1000è¡Œï¼ˆHTML+CSS+JSçµ±åˆï¼‰
- **tegaki-loader.js**: ç´„400è¡Œï¼ˆJSéƒ¨åˆ†ã®ã¿ï¼‰
- **å•é¡Œ**: 60%ã®æ©Ÿèƒ½ãŒæ¬ è½

### æ¬ è½ã—ã¦ã„ã‚‹ä¸»è¦æ©Ÿèƒ½
#### 1. **CDNèª­è¾¼ã®æ¬ è½**
- âŒ SortableJS
- âŒ pako (zlibåœ§ç¸®)
- âŒ UPNG.js (APNG)
- âŒ jsPDF

#### 2. **UIè¦ç´ ã®æ¬ è½**
- âŒ ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ç¾¤
- âŒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«
- âŒ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³UI
- âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
- âŒ ã‚¢ãƒ«ãƒãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
- âŒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ãƒ‘ãƒãƒ«
- âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ«

#### 3. **æ©Ÿèƒ½ã®æ¬ è½**
- âŒ ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼çµ±åˆ
- âŒ Historyçµ±åˆï¼ˆCtrl+Z/Yï¼‰
- âŒ FPSãƒ¢ãƒ‹ã‚¿ãƒ¼
- âŒ Canvasæƒ…å ±è¡¨ç¤º
- âŒ DPRè¡¨ç¤º

#### 4. **ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­è¾¼é †åºã®å•é¡Œ**
- âŒ `export-popup.js` æ¬ è½
- âŒ `diagnostics.js` æ¬ è½
- âŒ webp/mp4/pdf exporter æ¬ è½

---

## ğŸ¯ å®Œå…¨ç§»æ¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: CDNãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­è¾¼ï¼ˆå®Œå…¨ï¼‰
```javascript
[âœ“] PIXI.js v8.13.0
[ ] SortableJS (ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°ç”¨)
[ ] pako v2.1.0 (zlibåœ§ç¸®)
[ ] UPNG.js v2.1.0 (APNGç”Ÿæˆ)
[ ] GIF.js v0.2.0
[ ] jsPDF v2.5.1
```

### Phase 2: Tegakiã‚³ã‚¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­è¾¼ï¼ˆå®Œå…¨ï¼‰
```javascript
[âœ“] config.js
[âœ“] coordinate-system.js
[âœ“] system/event-bus.js
[âœ“] system/state-manager.js
[ ] system/layer-commands.js âš ï¸
[âœ“] system/camera-system.js
[âœ“] system/layer-system.js
[âœ“] system/drawing-clipboard.js
[âœ“] system/history.js
[âœ“] system/virtual-album.js
[âœ“] system/animation-system.js
[âœ“] system/export-manager.js
[âœ“] system/exporters/png-exporter.js
[âœ“] system/exporters/apng-exporter.js
[âœ“] system/exporters/gif-exporter.js
[ ] system/exporters/webp-exporter.js âš ï¸
[ ] system/exporters/mp4-exporter.js âš ï¸
[ ] system/exporters/pdf-exporter.js âš ï¸
[ ] system/quick-export-ui.js âš ï¸
[âœ“] ui/timeline-ui.js
[âœ“] ui/album-popup.js
[ ] ui/export-popup.js âš ï¸ é‡è¦
[âœ“] ui/ui-panels.js
[âœ“] ui/timeline-thumbnail-utils.js
[âœ“] core-runtime.js
[âœ“] core-engine.js
[ ] system/diagnostics.js âš ï¸
```

### Phase 3: UIè¦ç´ ç§»æ¤ï¼ˆå®Œå…¨ï¼‰

#### 3.1 ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
```javascript
[ ] library-tool (ã‚¢ãƒ«ãƒãƒ ä¿ç®¡)
[ ] export-tool (ç”»åƒãƒ»ã‚¢ãƒ‹ãƒ¡å‡ºåŠ›)
[ ] resize-tool (ãƒªã‚µã‚¤ã‚º)
[ ] pen-tool (ãƒ™ã‚¯ã‚¿ãƒ¼ãƒšãƒ³)
[ ] eraser-tool (æ¶ˆã—ã‚´ãƒ )
[ ] gif-animation-tool (GIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³)
```

#### 3.2 ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«
```javascript
[ ] layer-panel-container
[ ] layer-controls-row
[ ] layer-add-button
[ ] folder-add-button
[ ] layer-panel-items
[ ] layer-item (å€‹åˆ¥ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º)
[ ] layer-visibility (è¡¨ç¤º/éè¡¨ç¤º)
[ ] layer-opacity (ä¸é€æ˜åº¦è¡¨ç¤º)
[ ] layer-name (åå‰è¡¨ç¤º)
[ ] layer-thumbnail (ã‚µãƒ ãƒã‚¤ãƒ«)
[ ] layer-delete-button (å‰Šé™¤ãƒœã‚¿ãƒ³)
```

#### 3.3 ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ‘ãƒãƒ«
```javascript
[ ] pen-settings (ãƒšãƒ³è¨­å®š)
[ ] export-popup (ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š)
[ ] resize-settings (ãƒªã‚µã‚¤ã‚ºè¨­å®š)
```

#### 3.4 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ«
```javascript
[ ] status-panel
[ ] canvas-info (ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º)
[ ] current-tool (ç¾åœ¨ã®ãƒ„ãƒ¼ãƒ«)
[ ] current-layer (ç¾åœ¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼)
[ ] coordinates (åº§æ¨™è¡¨ç¤º)
[ ] transform-info (ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±)
[ ] dpr-info (DPR)
[ ] fps (FPS)
[ ] history-info (HistoryçŠ¶æ…‹)
```

#### 3.5 ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ãƒ‘ãƒãƒ«
```javascript
[ ] layer-transform-panel
[ ] layer-x-slider (Xåº§æ¨™)
[ ] layer-y-slider (Yåº§æ¨™)
[ ] layer-rotation-slider (å›è»¢)
[ ] layer-scale-slider (æ‹¡ç¸®)
[ ] flip-horizontal-btn (æ°´å¹³åè»¢)
[ ] flip-vertical-btn (å‚ç›´åè»¢)
```

### Phase 4: CSSç§»æ¤ï¼ˆå®Œå…¨ï¼‰

#### 4.1 CSSå¤‰æ•°å®šç¾©
```css
[ ] --futaba-maroon
[ ] --futaba-light-maroon
[ ] --futaba-medium
[ ] --futaba-light-medium
[ ] --futaba-cream
[ ] --futaba-background
[ ] --text-primary
[ ] --text-secondary
[ ] --text-inverse
```

#### 4.2 ä¸»è¦ã‚¯ãƒ©ã‚¹å®šç¾©
```css
[ ] .main-layout
[ ] .sidebar
[ ] .tool-button
[ ] .tool-separator
[ ] .canvas-area
[ ] .layer-panel-container
[ ] .cut-indicator
[ ] .layer-controls-row
[ ] .layer-item
[ ] .popup-panel
[ ] .status-panel
[ ] .layer-transform-panel
[ ] .export-options
[ ] .preview-container
```

### Phase 5: JavaScriptæ©Ÿèƒ½ç§»æ¤ï¼ˆå®Œå…¨ï¼‰

#### 5.1 ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆçµ±åˆ
```javascript
[ ] setupUnifiedKeyboardShortcuts()
[ ] UNDO (Ctrl+Z)
[ ] REDO (Ctrl+Shift+Z / Ctrl+Y)
[ ] LAYER_CLEAR
[ ] LAYER_CREATE (Ctrl+L)
[ ] GIF_CREATE_CUT
[ ] GIF_TOGGLE_TIMELINE
[ ] GIF_PLAY_PAUSE (Space)
[ ] GIF_COPY_CUT
[ ] TOOL_PEN (P)
[ ] TOOL_ERASER (E)
```

#### 5.2 Historyçµ±åˆ
```javascript
[ ] setupHistoryIntegration()
[ ] history:changed ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
[ ] history-info è¦ç´ æ›´æ–°
```

#### 5.3 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
```javascript
[ ] checkPhase1Dependencies()
[ ] checkCoreRuntime()
[ ] initializeApp()
[ ] DrawingApp ã‚¯ãƒ©ã‚¹
[ ] updateCanvasInfo()
[ ] updateDPRInfo()
[ ] startFPSMonitor()
```

#### 5.4 ExportSystemåˆæœŸåŒ–
```javascript
[ ] initExportWithRetry()
[ ] CoreRuntime.initializeExportSystem()
[ ] animation:system-ready ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
[ ] animation:initialized ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
```

#### 5.5 UIControllerçµ±åˆ
```javascript
[ ] UIController ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
[ ] initializeAlbumPopup()
[ ] initializeExportPopup()
[ ] initializeLayerPanel()
[ ] initializeToolButtons()
```

#### 5.6 è¨ºæ–­æ©Ÿèƒ½
```javascript
[ ] CoordinateSystem.diagnoseReferences()
[ ] SystemDiagnostics.runFullDiagnostics()
```

### Phase 6: ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹çµ±åˆï¼ˆå®Œå…¨ï¼‰

#### 6.1 ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
```javascript
[ ] tool:select
[ ] tool:pen
[ ] tool:eraser
```

#### 6.2 ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
```javascript
[ ] layer:clear-active
[ ] layer:created-by-shortcut
[ ] layer:visibility-toggle
[ ] layer:delete
[ ] layer:select
```

#### 6.3 ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
```javascript
[ ] cut:created-by-shortcut
[ ] cut:copy-current
[ ] cut:paste-right-adjacent
[ ] animation:system-ready
[ ] animation:initialized
```

#### 6.4 UIã‚¤ãƒ™ãƒ³ãƒˆ
```javascript
[ ] ui:toggle-timeline
[ ] ui:toggle-layer-panel
[ ] ui:toggle-export-popup
```

#### 6.5 Historyã‚¤ãƒ™ãƒ³ãƒˆ
```javascript
[ ] history:changed
```

---

## ğŸ”§ å®Ÿè£…æˆ¦ç•¥

### æˆ¦ç•¥1: HTMLâ†’JSå¤‰æ›ãƒãƒƒãƒ”ãƒ³ã‚°
```
index.html ã® <div> â†’ JS ã§ createElement('div')
index.html ã® <style> â†’ JS ã§ .style.cssText = `...`
index.html ã® <script> â†’ JS ã§é–¢æ•°/ã‚¯ãƒ©ã‚¹å®šç¾©
```

### æˆ¦ç•¥2: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ†å‰²
```javascript
class TegakiBookmarklet {
  constructor()
  start()
  
  // --- CDNèª­è¾¼ ---
  loadCDNLibraries()
  loadTegakiCore()
  
  // --- UIæ§‹ç¯‰ ---
  createMainLayout()
  createSidebar()
  createCanvasArea()
  createLayerPanel()
  createStatusPanel()
  createPopupPanels()
  
  // --- æ©Ÿèƒ½çµ±åˆ ---
  setupShortcuts()
  setupEventBus()
  setupHistory()
  setupFPSMonitor()
  
  // --- Tegakièµ·å‹• ---
  initializeTegaki()
  initializeUIController()
  
  // --- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ---
  exportAndClose()
  injectToBoard()
  
  // --- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ---
  cleanup()
}
```

### æˆ¦ç•¥3: CSSå®šç¾©æ–¹æ³•
```javascript
// 1. <style> ã‚¿ã‚°ã¨ã—ã¦æ³¨å…¥
const style = document.createElement('style');
style.textContent = `
  :root { --futaba-maroon: #800000; }
  .tool-button { ... }
`;
document.head.appendChild(style);

// 2. ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§ç›´æ¥é©ç”¨
element.style.cssText = `
  background: var(--futaba-maroon);
  border: 2px solid var(--futaba-medium);
`;
```

### æˆ¦ç•¥4: ç¶™æ‰¿ãƒã‚§ãƒƒã‚¯ãƒˆãƒªã‚¬ãƒ¼
å„Phaseå®Œäº†æ™‚ã«ä»¥ä¸‹ã‚’ç¢ºèª:
```javascript
function validatePhase(phase) {
  const checklist = PHASE_CHECKLISTS[phase];
  const missing = checklist.filter(item => !item.completed);
  if (missing.length > 0) {
    console.error(`Phase ${phase} incomplete:`, missing);
    return false;
  }
  return true;
}
```

---

## ğŸ“¦ æœ€çµ‚æ§‹æˆï¼ˆç›®æ¨™ï¼‰

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
tegaki-loader.js (å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«: ç´„1500-2000è¡Œ)
â”œâ”€â”€ Phase 1: CDNèª­è¾¼ (ç´„100è¡Œ)
â”œâ”€â”€ Phase 2: Tegakiã‚³ã‚¢èª­è¾¼ (ç´„50è¡Œ)
â”œâ”€â”€ Phase 3: CSSå®šç¾© (ç´„400è¡Œ)
â”œâ”€â”€ Phase 4: UIæ§‹ç¯‰ (ç´„600è¡Œ)
â”œâ”€â”€ Phase 5: æ©Ÿèƒ½çµ±åˆ (ç´„300è¡Œ)
â”œâ”€â”€ Phase 6: ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ (ç´„100è¡Œ)
â””â”€â”€ Phase 7: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (ç´„50è¡Œ)
```

### ãƒ¡ãƒ¢ãƒªç®¡ç†
```javascript
- å…¨UIè¦ç´ ã‚’ this.elements = {} ã«æ ¼ç´
- cleanup() ã§å…¨è¦ç´ ã‚’ç ´æ£„
- EventBusè³¼èª­ã‚’ this.subscriptions = [] ã«è¨˜éŒ²
- cleanup() ã§å…¨è³¼èª­è§£é™¤
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

### ãƒ™ã‚¯ã‚¿ãƒ¼ãƒšãƒ³æƒ…å ±ã®å–æ‰±
```javascript
// âŒ å±é™º: å…¨ãƒ™ã‚¯ã‚¿ãƒ¼ãƒ‘ã‚¹ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
const data = layerSystem.serializeAllVectorData();

// âœ… å®‰å…¨: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã®ã¿ãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚º
const blob = await exportManager.exportAsPNGBlob();
```

### localStorageç¦æ­¢
```javascript
// âŒ ç¦æ­¢
localStorage.setItem('tegaki-data', ...);

// âœ… è¨±å¯: ãƒ¡ãƒ¢ãƒªå†…ã§ä¿æŒ
this.temporaryData = { ... };
```

### åº§æ¨™ç³»ã®æ··åœ¨é˜²æ­¢
```javascript
// å¸¸ã« CoordinateSystem çµŒç”±ã§å¤‰æ›
const screenPos = CoordinateSystem.worldToScreen(worldPos);
const worldPos = CoordinateSystem.screenToWorld(screenPos);
```

---

## ğŸš€ å®Ÿè£…é †åºï¼ˆæ¨å¥¨ï¼‰

### å„ªå…ˆåº¦1ï¼ˆå¿…é ˆï¼‰
1. Phase 1: CDNèª­è¾¼å®Œå…¨åŒ–
2. Phase 2: ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­è¾¼å®Œå…¨åŒ–
3. Phase 3: CSSå®šç¾©å®Œå…¨ç§»æ¤
4. Phase 4: ã‚µã‚¤ãƒ‰ãƒãƒ¼+ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ«

### å„ªå…ˆåº¦2ï¼ˆé‡è¦ï¼‰
5. Phase 5: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆçµ±åˆ
6. Phase 6: Historyçµ±åˆ
7. Phase 7: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«
8. Phase 8: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—

### å„ªå…ˆåº¦3ï¼ˆæ¨å¥¨ï¼‰
9. Phase 9: FPSãƒ¢ãƒ‹ã‚¿ãƒ¼
10. Phase 10: è¨ºæ–­æ©Ÿèƒ½
11. Phase 11: UIControllerçµ±åˆ

---

## ğŸ” æ¤œè¨¼æ–¹æ³•

### èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯
```javascript
1. å…¨CDNãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‹ï¼Ÿ
2. å…¨Tegakiã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‹ï¼Ÿ
3. CSSãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
4. UIè¦ç´ ãŒå…¨ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
5. ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ãŒå‹•ä½œã™ã‚‹ã‹ï¼Ÿ
6. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒæˆåŠŸã™ã‚‹ã‹ï¼Ÿ
```

### çµ‚äº†æ™‚ãƒã‚§ãƒƒã‚¯
```javascript
1. å…¨UIè¦ç´ ãŒå‰Šé™¤ã•ã‚ŒãŸã‹ï¼Ÿ
2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒå…¨ã¦è§£é™¤ã•ã‚ŒãŸã‹ï¼Ÿ
3. PIXIã‚¢ãƒ—ãƒªãŒç ´æ£„ã•ã‚ŒãŸã‹ï¼Ÿ
4. ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹ï¼Ÿ
```

---

## ğŸ“Š é€²æ—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

```
Phase 1: CDNèª­è¾¼        [ ] 0/6
Phase 2: ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­è¾¼  [ ] 0/27
Phase 3: CSSå®šç¾©        [ ] 0/30
Phase 4: UIæ§‹ç¯‰         [ ] 0/40
Phase 5: æ©Ÿèƒ½çµ±åˆ       [ ] 0/15
Phase 6: ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹    [ ] 0/12
Phase 7: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—  [ ] 0/5

å…¨ä½“é€²æ—: 0/135 (0%)
```

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã“ã®è¨ˆç”»æ›¸ã«å¾“ã£ã¦ã€**Phase 1ã‹ã‚‰é †ç•ªã«**å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚
å„Phaseã®å®Œäº†æ™‚ã«å¿…ãšãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ç¢ºèªã—ã€æ¼ã‚ŒãŒãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚