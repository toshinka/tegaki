

# CUTãƒ»ãƒ¬ã‚¤ãƒ¤ãƒ¼2æ¬¡å…ƒãƒãƒˆãƒªã‚¯ã‚¹æ”¹ä¿®è¨ˆç”»æ›¸ è©³ç´°ç‰ˆ

## ğŸš¨ ç¾çŠ¶ã®å•é¡Œï¼ˆå†ç¢ºèªï¼‰

### å•é¡Œ1: CUTæ¯ã®ç‹¬ç«‹æ€§ãŒãªã„
**ç—‡çŠ¶**: æ–°è¦CUTä½œæˆå¾Œã€å…¨CUTã«æç”»ãŒåæ˜ ã•ã‚Œã‚‹
**åŸå› **: `animation-system.js`ã®æç”»åæ˜ ãƒ­ã‚¸ãƒƒã‚¯ãŒå…¨CUTã«æ³¢åŠã—ã¦ã„ã‚‹

### å•é¡Œ2: ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã•ã‚Œãªã„
**ç—‡çŠ¶**: CUTæ¯ã®ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæˆç”»åƒãŒè¡¨ç¤ºã•ã‚Œãªã„
**åŸå› **: ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆå¾Œã€timeline-ui.jsã¸ã®åæ˜ å‡¦ç†ãŒä¸å®Œå…¨

### å•é¡Œ3: 2æ¬¡å…ƒãƒãƒˆãƒªã‚¯ã‚¹æ§‹é€ ãŒå®Ÿç¾ã§ãã¦ã„ãªã„
**ç—‡çŠ¶**: CUTåˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ãŒæ­£ã—ãå¾©å…ƒã•ã‚Œãªã„
**åŸå› **: ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã®ä¿å­˜ãƒ»å¾©å…ƒãƒ•ãƒ­ãƒ¼ãŒä¸å®Œå…¨

---

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œãƒ•ãƒ­ãƒ¼ï¼ˆç†æƒ³å½¢ï¼‰

```
ã€CUTä½œæˆæ™‚ã€‘
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAlt+PlusæŠ¼ä¸‹
2. timeline-ui.js: createCutButton ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
3. eventBus.emit('animation:create-cut')
4. animation-system.js: createNewCutFromCurrentLayers() å®Ÿè¡Œ
   â”œâ”€ ç¾åœ¨ã®LayerSystemã®å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
   â”œâ”€ æ–°è¦CUTç”¨ã«å®Œå…¨ç‹¬ç«‹ã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’ç”Ÿæˆ
   â”œâ”€ cutsé…åˆ—ã«è¿½åŠ 
   â””â”€ generateCutThumbnailOptimized() å®Ÿè¡Œ
5. eventBus.emit('animation:cut-created', { cutIndex })
6. timeline-ui.js: 'animation:cut-created' ãƒªã‚¹ãƒŠãƒ¼ãŒåå¿œ
7. timeline-ui.js: renderCutsList() ã§UIæ›´æ–°
   â””â”€ cut.thumbnail ã‚’ <img> ã‚¿ã‚°ã§è¡¨ç¤º

ã€CUTåˆ‡ã‚Šæ›¿ãˆæ™‚ã€‘
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCUTã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯
2. timeline-ui.js: switchToActiveCutSafely(cutIndex) å‘¼ã³å‡ºã—
3. animation-system.js: 
   â”œâ”€ ç¾åœ¨ã®CUTã®çŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆsaveCutLayerStatesBeforeSwitchï¼‰
   â”œâ”€ æ–°ã—ã„CUTã®çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿ï¼ˆsetActiveCutï¼‰
   â”‚  â”œâ”€ clearLayerSystemLayers() - æ—¢å­˜ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤
   â”‚  â””â”€ rebuildLayersFromCutData() - CUTã®ãƒ¬ã‚¤ãƒ¤ãƒ¼å¾©å…ƒ
   â””â”€ LayerSystemã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«UIæ›´æ–°
4. eventBus.emit('animation:cut-applied', { cutIndex })
5. ç”»é¢ã«é¸æŠã—ãŸCUTã®æç”»å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹

ã€æç”»æ™‚ã€‘
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒšãƒ³ã§æç”»
2. drawing-engine.js: startDrawing() â†’ continueDrawing() â†’ stopDrawing()
3. layer-system.js: ãƒ‘ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿½åŠ 
4. eventBus.emit('layer:path-added')
5. animation-system.js: onLayerChanged() ãƒªã‚¹ãƒŠãƒ¼ãŒåå¿œ
6. animation-system.js: saveCutLayerStates() å®Ÿè¡Œ
   â””â”€ ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTã®ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã®ã¿æ›´æ–°
7. generateCutThumbnailOptimized() ã§ã‚µãƒ ãƒã‚¤ãƒ«å†ç”Ÿæˆ
8. eventBus.emit('animation:thumbnail-generated', { cutIndex })
9. timeline-ui.js: ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
```

---

## ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»å®šç¾©è¾å…¸

### animation-system.js

#### ã‚¯ãƒ©ã‚¹: AnimationSystem

**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**
```javascript
this.animationData = {
    cuts: [
        {
            id: String,              // 'cut_1234567890_abc123'
            name: String,            // 'CUT1', 'CUT2', ...
            duration: Number,        // 0.5 (ç§’)
            layers: [                // CUTå°‚ç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿é…åˆ—
                {
                    id: String,      // 'cut_xxx_layer_0'
                    name: String,    // 'ãƒ¬ã‚¤ãƒ¤ãƒ¼1'
                    visible: Boolean,
                    opacity: Number,
                    isBackground: Boolean,
                    transform: { x, y, rotation, scaleX, scaleY },
                    paths: [         // ãƒ‘ã‚¹ãƒ‡ãƒ¼ã‚¿é…åˆ—
                        {
                            id: String,
                            points: [{x, y}, ...],
                            size: Number,
                            color: Number,
                            opacity: Number,
                            tool: String
                        }
                    ]
                }
            ],
            thumbnail: PIXI.Texture  // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ
        }
    ],
    settings: { fps: 12, loop: true },
    playback: { isPlaying: false, currentCutIndex: 0, startTime: 0 }
}

this.layerSystem = LayerSystem        // å‚ç…§
this.app = PIXI.Application           // å‚ç…§
this.eventBus = TegakiEventBus        // å‚ç…§
this.cutLayerIdCounters = Map<cutId, counter>  // CUTæ¯ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
```

**ãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§**

| ãƒ¡ã‚½ãƒƒãƒ‰å | å¼•æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ | å‘¼ã³å‡ºã—å…ƒ |
|-----------|------|--------|------|-----------|
| `init(layerSystem, app)` | LayerSystem, PIXI.App | void | ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ– | core-engine.js |
| `createNewCutFromCurrentLayers()` | ãªã— | Cut | ç¾åœ¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã‹ã‚‰æ–°è¦CUTä½œæˆ | timeline-ui.js, EventBus |
| `createNewBlankCut()` | ãªã— | Cut | ç©ºã®æ–°è¦CUTä½œæˆ | timeline-ui.js |
| `switchToActiveCutSafely(cutIndex, resetTransform)` | Number, Boolean | void | CUTåˆ‡ã‚Šæ›¿ãˆï¼ˆå®‰å…¨ç‰ˆï¼‰ | timeline-ui.js, å†…éƒ¨ |
| `saveCutLayerStatesBeforeSwitch()` | ãªã— | void | CUTåˆ‡ã‚Šæ›¿ãˆå‰ã«ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜ | å†…éƒ¨ |
| `setActiveCut(cutIndex, resetTransform)` | Number, Boolean | void | æŒ‡å®šCUTã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ– | å†…éƒ¨ |
| `clearLayerSystemLayers()` | ãªã— | void | LayerSystemã®å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤ | å†…éƒ¨ |
| `rebuildLayersFromCutData(cutLayers, resetTransform)` | Array, Boolean | void | CUTãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ¬ã‚¤ãƒ¤ãƒ¼å†æ§‹ç¯‰ | å†…éƒ¨ |
| `copyCurrentLayersForCutIndependent(cutId)` | String | Array | ç¾åœ¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’CUTå°‚ç”¨ã«ç‹¬ç«‹ã‚³ãƒ”ãƒ¼ | å†…éƒ¨ |
| `generateUniqueCutLayerId(cutId)` | String | String | CUTå°‚ç”¨ã®ä¸€æ„ãªãƒ¬ã‚¤ãƒ¤ãƒ¼IDç”Ÿæˆ | å†…éƒ¨ |
| `generateCutThumbnailOptimized(cutIndex)` | Number | Promise | ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼ˆæœ€é©åŒ–ç‰ˆï¼‰ | å†…éƒ¨, timeline-ui.js |
| `temporarilyApplyCutState(cutIndex)` | Number | Promise | ä¸€æ™‚çš„ã«CUTçŠ¶æ…‹ã‚’é©ç”¨ | å†…éƒ¨ |
| `generateLayerCompositeCanvasOptimized()` | ãªã— | Promise<Canvas> | ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæˆCanvasç”Ÿæˆ | å†…éƒ¨ |
| `renderLayerToCanvasOptimized(layer)` | PIXI.Container | Promise<Canvas> | ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’Canvasã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° | å†…éƒ¨ |
| `saveCutLayerStates()` | ãªã— | void | ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTã®çŠ¶æ…‹ã‚’ä¿å­˜ | EventBusãƒªã‚¹ãƒŠãƒ¼ |
| `deleteCut(cutIndex)` | Number | Boolean | CUTå‰Šé™¤ | timeline-ui.js |
| `getCurrentCut()` | ãªã— | Cut | ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTã‚’å–å¾— | å„æ‰€ |
| `getAnimationData()` | ãªã— | Object | ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’å–å¾— | timeline-ui.js |

**EventBusãƒªã‚¹ãƒŠãƒ¼ï¼ˆsetupCutClipboardEventså†…ï¼‰**
- `'cut:copy-current'` â†’ `copyCurrent()`
- `'cut:paste-right-adjacent'` â†’ `pasteRightAdjacent()`
- `'cut:paste-new'` â†’ `pasteAsNew()`

**EventBusç™ºè¡Œã‚¤ãƒ™ãƒ³ãƒˆ**
- `'animation:initialized'` - åˆæœŸåŒ–å®Œäº†
- `'animation:cut-created'` - CUTä½œæˆå®Œäº†
- `'animation:cut-applied'` - CUTåˆ‡ã‚Šæ›¿ãˆå®Œäº†
- `'animation:thumbnail-generated'` - ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆå®Œäº†
- `'animation:cut-updated'` - CUTæ›´æ–°å®Œäº†

---

### timeline-ui.js

#### ã‚¯ãƒ©ã‚¹: TimelineUI

**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**
```javascript
this.animationSystem = AnimationSystem  // å‚ç…§
this.container = HTMLElement            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³DOMè¦ç´ 
this.cutsContainer = HTMLElement        // CUTãƒªã‚¹ãƒˆDOMè¦ç´ 
this.isVisible = Boolean                // è¡¨ç¤ºçŠ¶æ…‹
```

**ãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§**

| ãƒ¡ã‚½ãƒƒãƒ‰å | å¼•æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ | å‘¼ã³å‡ºã—å…ƒ |
|-----------|------|--------|------|-----------|
| `init()` | ãªã— | void | UIåˆæœŸåŒ– | core-engine.js |
| `renderCutsList()` | ãªã— | void | CUTãƒªã‚¹ãƒˆUIå…¨ä½“ã‚’å†æç”» | å†…éƒ¨, EventBusãƒªã‚¹ãƒŠãƒ¼ |
| `createCutElement(cut, index)` | Cut, Number | HTMLElement | å˜ä¸€CUTè¦ç´ ã‚’ç”Ÿæˆ | renderCutsList() |
| `updateSingleCutThumbnail(cutIndex)` | Number | void | æŒ‡å®šCUTã®ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã‚’æ›´æ–° | EventBusãƒªã‚¹ãƒŠãƒ¼ |
| `ensureInitialCut()` | ãªã— | void | åˆå›CUTä½œæˆã‚’ä¿è¨¼ | init() |
| `toggle()` | ãªã— | void | ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ | EventBus, ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ |

**EventBusãƒªã‚¹ãƒŠãƒ¼ï¼ˆsetupEventListenerså†…ï¼‰**
- `'animation:cut-created'` â†’ `renderCutsList()`
- `'animation:cut-deleted'` â†’ `renderCutsList()`
- `'animation:thumbnail-generated'` â†’ `updateSingleCutThumbnail(cutIndex)`
- `'animation:cut-applied'` â†’ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTå¼·èª¿è¡¨ç¤ºæ›´æ–°

**æœŸå¾…ã•ã‚Œã‚‹DOMæ§‹é€ **
```html
<div class="timeline-container">
  <div class="cuts-container">
    <div class="cut-item" data-cut-index="0">
      <div class="cut-thumbnail">
        <img src="data:image/png;base64,..." /> <!-- â† ã“ã“ãŒè¡¨ç¤ºã•ã‚Œãªã„ -->
      </div>
      <div class="cut-info">CUT1 (0.5s)</div>
    </div>
    <div class="cut-item" data-cut-index="1">...</div>
  </div>
</div>
```

---

### layer-system.js

#### é‡è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆAnimationSystemã¨ã®é€£æºï¼‰

| ãƒ¡ã‚½ãƒƒãƒ‰å | èª¬æ˜ | AnimationSystemã‹ã‚‰ã®å‘¼ã³å‡ºã— |
|-----------|------|----------------------------|
| `createLayer(name, isBackground)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ | createNewBlankCut() |
| `redrawLayer(layerIndex)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼å†æç”» | - |
| `updateLayerPanelUI()` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«UIæ›´æ–° | setActiveCut() |
| `captureLayerSnapshot()` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆç”Ÿæˆ | âŒ æœªä½¿ç”¨ï¼ˆè¦ç¢ºèªï¼‰ |

**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**
```javascript
this.layers = [PIXI.Container, ...]           // ãƒ¬ã‚¤ãƒ¤ãƒ¼é…åˆ—
this.layerTransforms = Map<layerId, transform> // ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢çŠ¶æ…‹
this.layersContainer = PIXI.Container         // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ
this.animationSystem = AnimationSystem        // é€†å‚ç…§
```

---

## ğŸ” å•é¡Œã®æ ¹æœ¬åŸå› åˆ†æ

### åŸå› 1: ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å•é¡Œ

**ç¾åœ¨ã®å®Ÿè£…**
```javascript
// animation-system.js: createNewCutFromCurrentLayers()
setTimeout(() => {
    this.generateCutThumbnailOptimized(this.animationData.cuts.length - 1);
}, 100);
```

**å•é¡Œç‚¹**
- éåŒæœŸå‡¦ç†å¾Œã«EventBusé€šçŸ¥ãŒãªã„
- timeline-ui.jsãŒã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆå®Œäº†ã‚’æ¤œçŸ¥ã§ããªã„

**æ­£ã—ã„ãƒ•ãƒ­ãƒ¼**
```javascript
async createNewCutFromCurrentLayers() {
    // ... CUTä½œæˆå‡¦ç† ...
    
    // å³åº§ã«ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
    await this.generateCutThumbnailOptimized(newIndex);
    
    // ç”Ÿæˆå®Œäº†å¾Œã«EventBusé€šçŸ¥
    this.eventBus.emit('animation:cut-created', { 
        cutId: cut.id, 
        cutIndex: newIndex 
    });
}
```

### åŸå› 2: timeline-ui.jsã®ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ä¸å‚™

**timeline-ui.jså†…ã®å•é¡Œç®‡æ‰€ï¼ˆæ¨æ¸¬ï¼‰**
```javascript
// createCutElement() å†…
if (cut.thumbnail) {
    // PIXI.Textureã‚’ã©ã†ã‚„ã£ã¦<img>ã«å¤‰æ›ã—ã¦ã„ã‚‹ï¼Ÿ
    // ã“ã®å®Ÿè£…ãŒä¸å®Œå…¨ãªå¯èƒ½æ€§
}
```

**å¿…è¦ãªå®Ÿè£…**
```javascript
createCutElement(cut, index) {
    const cutItem = document.createElement('div');
    cutItem.className = 'cut-item';
    
    const thumbnail = document.createElement('div');
    thumbnail.className = 'cut-thumbnail';
    
    if (cut.thumbnail) {
        // PIXI.Texture â†’ Canvas â†’ DataURL
        const canvas = this.animationSystem.app.renderer.extract.canvas(cut.thumbnail);
        const img = document.createElement('img');
        img.src = canvas.toDataURL();
        thumbnail.appendChild(img);
    } else {
        thumbnail.textContent = 'No Image';
    }
    
    cutItem.appendChild(thumbnail);
    return cutItem;
}
```

### åŸå› 3: CUTç‹¬ç«‹æ€§ã®å•é¡Œ

**ç¾åœ¨ã®å®Ÿè£…ã®æ‡¸å¿µç‚¹**
```javascript
// animation-system.js: saveCutLayerStates()
saveCutLayerStates() {
    const currentCut = this.getCurrentCut();
    if (!currentCut || !this.layerSystem) return;
    
    const savedLayers = this.copyCurrentLayersForCutIndependent(currentCut.id);
    currentCut.layers = savedLayers;  // â† ã“ã‚Œã§æœ¬å½“ã«ç‹¬ç«‹ã—ã¦ã„ã‚‹ï¼Ÿ
}
```

**ç¢ºèªã™ã¹ãç‚¹**
1. `copyCurrentLayersForCutIndependent()` ãŒæœ¬å½“ã«ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã‚‹ã‹
2. `rebuildLayersFromCutData()` ãŒæ­£ã—ããƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾©å…ƒã—ã¦ã„ã‚‹ã‹
3. LayerSystemã® `layers` é…åˆ—ã¨ AnimationSystemã® `cut.layers` ãŒå®Œå…¨ã«åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ã‹

---

## ğŸ› ï¸ æ”¹ä¿®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³

### Step 1: timeline-ui.jsã®ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºä¿®æ­£ï¼ˆæœ€å„ªå…ˆï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ui/timeline-ui.js`

**ä¿®æ­£å†…å®¹**:
1. `createCutElement()` ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Œå…¨å®Ÿè£…
2. `updateSingleCutThumbnail()` ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Œå…¨å®Ÿè£…
3. PIXI.Texture â†’ Canvas â†’ img.src å¤‰æ›ã®å®Ÿè£…

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
- CUTä½œæˆæ™‚ã«ã‚µãƒ ãƒã‚¤ãƒ«ãŒå³åº§ã«è¡¨ç¤ºã•ã‚Œã‚‹
- ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°æ™‚ã«ç”»åƒãŒæ­£ã—ãæ›´æ–°ã•ã‚Œã‚‹

### Step 2: ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `system/animation-system.js`

**ä¿®æ­£å†…å®¹**:
1. `createNewCutFromCurrentLayers()` ã‚’ async/await ã«å¤‰æ›´
2. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆå®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ EventBus é€šçŸ¥
3. `generateCutThumbnailOptimized()` ã®æˆ»ã‚Šå€¤ã‚’ä¿è¨¼

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
- ã‚µãƒ ãƒã‚¤ãƒ«ç”ŸæˆãŒç¢ºå®Ÿã«å®Œäº†ã—ã¦ã‹ã‚‰ UI æ›´æ–°ã•ã‚Œã‚‹
- éåŒæœŸå‡¦ç†ã®ç«¶åˆãŒãªããªã‚‹

### Step 3: CUTç‹¬ç«‹æ€§ã®æ¤œè¨¼ãƒ»ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `system/animation-system.js`

**æ¤œè¨¼é …ç›®**:
1. `copyCurrentLayersForCutIndependent()` ã®ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ç¢ºèª
2. `rebuildLayersFromCutData()` ã®å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯ç¢ºèª
3. ãƒ¬ã‚¤ãƒ¤ãƒ¼IDè¡çªãŒãªã„ã‹ç¢ºèª

**ä¿®æ­£å†…å®¹**:
1. ãƒ‘ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨ãªãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
2. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®å®Œå…¨ãªå†æ§‹ç¯‰
3. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®è¿½åŠ ï¼ˆä¸€æ™‚çš„ï¼‰

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
- CUT1ã§æç”» â†’ CUT2ä½œæˆ â†’ CUT1ã«æˆ»ã‚‹ â†’ æç”»ãŒæ®‹ã£ã¦ã„ã‚‹
- CUT2ã§æç”» â†’ CUT1ã«æˆ»ã‚‹ â†’ CUT2ã®æç”»ãŒè¦‹ãˆãªã„

### Step 4: EventBusé€šçŸ¥ãƒ•ãƒ­ãƒ¼ã®æ•´å‚™

**ãƒ•ã‚¡ã‚¤ãƒ«**: å…¨ãƒ•ã‚¡ã‚¤ãƒ«

**ä¿®æ­£å†…å®¹**:
1. ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®çµ±ä¸€
2. ã‚¤ãƒ™ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®æ¨™æº–åŒ–
3. ãƒªã‚¹ãƒŠãƒ¼ã®å®Ÿè£…æ¼ã‚Œãƒã‚§ãƒƒã‚¯

---

## ğŸ“ è‡ªå·±è©•ä¾¡ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### è¨­è¨ˆé¢
- [ ] 2æ¬¡å…ƒãƒãƒˆãƒªã‚¯ã‚¹æ§‹é€ ãŒæ˜ç¢ºã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] CUTé–“ã®å®Œå…¨ãªç‹¬ç«‹æ€§ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆãƒ•ãƒ­ãƒ¼ãŒæ˜ç¢ºã‹ï¼Ÿ
- [ ] EventBusé€šçŸ¥ãƒ•ãƒ­ãƒ¼ãŒä¸€è²«ã—ã¦ã„ã‚‹ã‹ï¼Ÿ

### å®Ÿè£…é¢
- [ ] timeline-ui.jsã®ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã¯å®Œå…¨ã‹ï¼Ÿ
- [ ] animation-system.jsã®CUTç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã¯å®Œå…¨ã‹ï¼Ÿ
- [ ] éåŒæœŸå‡¦ç†ã®ç«¶åˆå¯¾ç­–ã¯ååˆ†ã‹ï¼Ÿ
- [ ] ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–ã¯ååˆ†ã‹ï¼Ÿ

### ãƒ†ã‚¹ãƒˆé¢
- [ ] CUTä½œæˆâ†’ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã®ãƒ•ãƒ­ãƒ¼ã¯ç¢ºèªæ¸ˆã¿ã‹ï¼Ÿ
- [ ] CUTåˆ‡ã‚Šæ›¿ãˆâ†’æç”»ç‹¬ç«‹æ€§ã¯ç¢ºèªæ¸ˆã¿ã‹ï¼Ÿ
- [ ] æç”»â†’ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ã®ãƒ•ãƒ­ãƒ¼ã¯ç¢ºèªæ¸ˆã¿ã‹ï¼Ÿ
- [ ] å¤§é‡CUTä½œæˆæ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯ç¢ºèªæ¸ˆã¿ã‹ï¼Ÿ

---

## ğŸ¯ æ”¹ä¿®å„ªå…ˆé †ä½

### æœ€å„ªå…ˆï¼ˆå³åº§ã«å¯¾å¿œï¼‰
1. **timeline-ui.jsã®ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºä¿®æ­£**
   - ç†ç”±: ã“ã‚ŒãŒãªã„ã¨ä½•ã‚‚è¦‹ãˆãªã„
   - å½±éŸ¿ç¯„å›²: timeline-ui.js ã®ã¿
   - é›£æ˜“åº¦: ä½

### é«˜å„ªå…ˆï¼ˆæ¬¡ã«å¯¾å¿œï¼‰
2. **ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ä¿®æ­£**
   - ç†ç”±: éåŒæœŸå‡¦ç†ã®ç«¶åˆã‚’è§£æ¶ˆ
   - å½±éŸ¿ç¯„å›²: animation-system.js
   - é›£æ˜“åº¦: ä¸­

### ä¸­å„ªå…ˆï¼ˆæ¤œè¨¼å¾Œã«å¯¾å¿œï¼‰
3. **CUTç‹¬ç«‹æ€§ã®æ¤œè¨¼ãƒ»ä¿®æ­£**
   - ç†ç”±: æ ¹æœ¬çš„ãªæ©Ÿèƒ½ã®ç¢ºèª
   - å½±éŸ¿ç¯„å›²: animation-system.js
   - é›£æ˜“åº¦: ä¸­ã€œé«˜

### ä½å„ªå…ˆï¼ˆä½™è£•ãŒã‚ã‚Œã°ï¼‰
4. **EventBusé€šçŸ¥ãƒ•ãƒ­ãƒ¼ã®æ•´å‚™**
   - ç†ç”±: æ—¢å­˜æ©Ÿèƒ½ã®æ”¹å–„
   - å½±éŸ¿ç¯„å›²: å…¨ãƒ•ã‚¡ã‚¤ãƒ«
   - é›£æ˜“åº¦: ä½

---

## ğŸ’¡ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### ä»Šã™ãå®Ÿæ–½ã™ã‚‹ã“ã¨
1. timeline-ui.jsã®ç¾åœ¨ã®å®Ÿè£…ã‚’ç¢ºèª
2. ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã®å®Œå…¨å®Ÿè£…
3. å‹•ä½œç¢ºèª

### ç¢ºèªãŒå¿…è¦ãªã“ã¨
1. `cut.thumbnail` ã« PIXI.Texture ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
2. timeline-ui.jsã® `createCutElement()` ã¯å­˜åœ¨ã™ã‚‹ã‹ï¼Ÿ
3. `updateSingleCutThumbnail()` ã¯å­˜åœ¨ã™ã‚‹ã‹ï¼Ÿ

---

## ğŸ“Œ é‡è¦ãªæ³¨æ„äº‹é …

### PixiJS v8.13 ã®åˆ¶ç´„
- `renderer.extract.canvas()` ã®ä½¿ç”¨æ–¹æ³•
- `PIXI.Texture.from()` ã®å¼•æ•°
- RenderTexture ã®ç ´æ£„ã‚¿ã‚¤ãƒŸãƒ³ã‚°

### ãƒ–ãƒ©ã‚¦ã‚¶APIåˆ¶ç´„
- `localStorage` ä½¿ç”¨ç¦æ­¢ï¼ˆç¢ºèªæ¸ˆã¿ï¼‰
- Canvas ã® toDataURL() ã¯åŒæœŸå‡¦ç†
- å¤§é‡ã®DataURLã¯ãƒ¡ãƒ¢ãƒªã‚’åœ§è¿«ã™ã‚‹å¯èƒ½æ€§

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®
- ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã¯é‡ã„å‡¦ç†
- å¤§é‡CUTä½œæˆæ™‚ã®é…å»¶å¯¾ç­–
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–ï¼ˆTextureç ´æ£„ï¼‰

---

ã“ã®è¨ˆç”»æ›¸ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ã¾ãš **timeline-ui.js ã®ç¾çŠ¶ç¢ºèª** ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

---
 **timeline-ui.js ã®ç¾çŠ¶ç¢ºèª**
ğŸš¨ ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã•ã‚Œãªã„æ ¹æœ¬åŸå› 
å•é¡Œç®‡æ‰€: generateCutThumbnailHTML() ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆline 1048-1054ä»˜è¿‘ï¼‰

generateCutThumbnailHTML(cut, index) {
    if (cut.thumbnail) {
        // âŒ å•é¡Œ: cut.thumbnail ã¯ PIXI.Texture ãªã®ã«ç›´æ¥srcå±æ€§ã«ä»£å…¥ã—ã¦ã„ã‚‹
        return `<img src="${cut.thumbnail}" alt="CUT${index + 1}" />`;
    } else {
        return `<div class="cut-thumbnail-placeholder">CUT${index + 1}</div>`;
    }
}

ç¾çŠ¶ã®å•é¡Œ:

cut.thumbnail ã¯ PIXI.Texture ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
<img src="[object Object]"> ã®ã‚ˆã†ãªçŠ¶æ…‹ã«ãªã£ã¦ã„ã‚‹
PIXI.Texture â†’ Canvas â†’ DataURL ã¸ã®å¤‰æ›ãŒæ¬ è½

æ­£ã—ã„å®Ÿè£…:
generateCutThumbnailHTML(cut, index) {
    if (cut.thumbnail && this.animationSystem?.app?.renderer) {
        // PIXI.Texture â†’ Canvas â†’ DataURL ã«å¤‰æ›
        try {
            const canvas = this.animationSystem.app.renderer.extract.canvas(cut.thumbnail);
            const dataUrl = canvas.toDataURL('image/png');
            return `<img src="${dataUrl}" alt="CUT${index + 1}" />`;
        } catch (error) {
            console.error('Thumbnail conversion failed:', error);
            return `<div class="cut-thumbnail-placeholder">ERR</div>`;
        }
    } else {
        return `<div class="cut-thumbnail-placeholder">CUT${index + 1}</div>`;
    }
}


ğŸ“‹ ãã®ä»–ã®å•é¡Œç‚¹
å•é¡Œ2: updateSingleCutThumbnail() ã‚‚åŒæ§˜ã®å•é¡Œ

// line 1071-1082ä»˜è¿‘
updateSingleCutThumbnail(cutIndex) {
    // ... çœç•¥ ...
    if (cut && cut.thumbnail) {
        // âŒ åŒã˜å•é¡Œ: PIXI.Texture ã‚’ç›´æ¥ä½¿ç”¨
        thumbnail.innerHTML = `<img src="${cut.thumbnail}" alt="CUT${cutIndex + 1}" />`;
    }
}



