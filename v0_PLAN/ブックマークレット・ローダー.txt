ğŸš¨ã¯ã£ã¡ã‚ƒã‚“ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆcanvas98ï¼‰ã®çªç ´æ–¹æ³•

canvas98 ã® bookmarklet ã‚’æ”¹ã‚ã¦è¦‹ã‚‹ã¨ï¼š

javascript:(function(){
  if(!globalThis.canvas98start){
    var s=document.createElement('script');
    s.charset='UTF-8';
    s.src='https://canvas98.github.io/canvas98/all-in-one.js';
    document.body.appendChild(s)
  } else {
    globalThis.canvas98start()
  }
})();


â†’ iframe ã§ã¯ãªã script ã‚¿ã‚°ã§ç›´æ¥ JS ã‚’æ³¨å…¥ ã—ã¦ã¾ã™ã€‚
ãã® JS (all-in-one.js) ãŒ æ²ç¤ºæ¿ã® DOM ã«ç›´æ¥ã€Œæç”»UIï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã€ãƒœã‚¿ãƒ³ï¼‰ã€ã‚’æŒ¿å…¥ã—ã¦ç¨¼åƒ ã—ã¦ã„ã‚‹ã‚“ã§ã™ã€‚

ã¤ã¾ã‚Šï¼š

iframe ã‚’ä½¿ã‚ãªã„

è¦ªãƒšãƒ¼ã‚¸ã® CSP ã‚’å›é¿ã™ã‚‹

ç›´æ¥ DOM ã« PixiJS ã‚¢ãƒ—ãƒªã‚’ç”Ÿæˆã—ã¦ã€Œæ²ç¤ºæ¿ä¸Šã«æµ®ã‹ã›ã‚‹ã€

ã“ã®æ–¹å¼ã ã‹ã‚‰ã€ãµãŸã°ã‚„ Mebuki ã®ã‚ˆã†ãª CSP å¼·ã„ã‚µã‚¤ãƒˆã§ã‚‚å‹•ä½œã—ã¦ã„ãŸã‚ã‘ã§ã™ã€‚

ä»Šã® loader ã®å•é¡Œç‚¹

iframe ã«ä¾å­˜ â†’ ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹

export é€£æºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ãŒä¸è¦ã«è¤‡é›‘ã«ãªã£ã¦ã‚‹

Tegaki ç”¨ã«æ”¹è‰¯ã™ã¹ãæ–¹å‘

iframe ã‚’å»ƒæ­¢
â†’ ä»£ã‚ã‚Šã« script ã§ç›´æ¥ core-engine ã‚’æ³¨å…¥ã—ã¦ã€PixiJS ã® <canvas> ã‚’ãƒšãƒ¼ã‚¸å†…ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã€‚

ã€Œæ·»ä»˜å‡¦ç†ã€ã ã‘ã‚’æ®‹ã™

export ã—ãŸ PNG ã‚’ Mebuki ã® input[type=file] ã«æ³¨å…¥ã™ã‚‹å‡¦ç†ã¯ãã®ã¾ã¾æ®‹ã™

ãŸã ã— export ã¯ iframe çµŒç”±ã§ã¯ãªãã€Œã‚¢ãƒ—ãƒªå†…éƒ¨ APIã€ã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã™

å…¨ä½“ã®æµã‚Œï¼ˆã¯ã£ã¡ã‚ƒã‚“æ–¹å¼ã‚’è¸è¥²ï¼‰

Bookmarklet â†’ loader ã‚’ script ã‚¿ã‚°ã§èª­ã¿è¾¼ã¿

loader ãŒ globalThis.mebukiStart ã‚’ç™»éŒ²

mebukiStart() ãŒ Pixi ã‚¢ãƒ—ãƒªã‚’ãƒšãƒ¼ã‚¸ã«ç›´æ¥æŒ¿å…¥ï¼ˆposition:fixed ã® canvas/UIï¼‰

å®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰ PNG â†’ File â†’ input[type=file] æ³¨å…¥

-------

Tegaki ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ for Futaba / Mebuki
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç›®çš„:
  ãƒ»ãµãŸã°ã¡ã‚ƒã‚“ã­ã‚‹ï¼ˆFutabaï¼‰ã¨ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹ï¼ˆMebukiï¼‰ã®æ²ç¤ºæ¿æŠ•ç¨¿æ¬„ã«
    Tegakiã§æã„ãŸçµµã‚’æ³¨å…¥ã§ãã‚‹ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½œã‚‹ã€‚
  ãƒ»ä¸¡æ²ç¤ºæ¿ã§ä»•çµ„ã¿ãŒç•°ãªã‚‹ãŸã‚ã€å…±é€šãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æŒã¡ã¤ã¤
    å€‹åˆ¥ã«ã€Œã‚­ãƒ£ãƒ³ãƒã‚¹æ³¨å…¥æ–¹å¼ã€ã¨ã€Œãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›æ³¨å…¥æ–¹å¼ã€ã‚’åˆ‡æ›¿å¯èƒ½ã«ã™ã‚‹ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€å…¨ä½“æ§‹é€ ã€‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
   - ä¸€è¡ŒJSã€‚
   - tegaki-loader.js ã‚’èª­ã¿è¾¼ã¿ã€window.tegakiStart() ã‚’å‘¼ã¶ã€‚

2. Tegaki Loader
   - æ²ç¤ºæ¿ç¨®åˆ¥ã‚’åˆ¤å®šï¼ˆFutaba/Mebukiï¼‰ã€‚
   - å¯¾å¿œã™ã‚‹ detect ãƒ¡ã‚½ãƒƒãƒ‰ã§æ³¨å…¥å…ˆã‚’ç‰¹å®šã€‚
   - core-engine.js ã‚’èª­ã¿è¾¼ã¿ã€Tegaki ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã€‚
   - èµ·å‹•æ™‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« { mode:"bookmarklet", targetElement } ã‚’æ¸¡ã™ã€‚

3. Tegaki Core (PixiJS v8.13)
   - é€šå¸¸æç”»æ©Ÿèƒ½ã«åŠ ãˆã€Bookmarklet API ã‚’æä¾›:
     * window.tegakiStart()
     * window.tegakiStop()
     * window.tegakiCancel()

4. æ³¨å…¥å¯¾è±¡
   - Futaba: <canvas id="oejs"> ã« drawImage ã§æç”»åæ˜ ã€‚
   - Mebuki: <input type=file> ã« File ã‚’æ³¨å…¥ â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ <img src="blob:..."> ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€å‹•ä½œãƒ•ãƒ­ãƒ¼ã€‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Step 0: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå®Ÿè¡Œ
Step 1: loader ãŒèµ·å‹•
   - æ²ç¤ºæ¿åˆ¤å®š
   - detectBoardCanvas_Futaba() ã¾ãŸã¯ detectFileInput_Mebuki() å®Ÿè¡Œ
Step 2: Tegaki Core ã‚’ãƒ­ãƒ¼ãƒ‰
   - PixiJS ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
   - boardCanvas/input ã‚’ä¿æŒ
   - æç”»ç”»é¢ã‚’è¡¨ç¤º
Step 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼æç”»
Step 4: å®Œäº†æ“ä½œ
   - Futaba: toDataURL â†’ drawImage(canvas)
   - Mebuki: toBlob â†’ File â†’ input.files â†’ change ã‚¤ãƒ™ãƒ³ãƒˆ
Step 5: UIã‚’é–‰ã˜ã¦çµ‚äº†
   - app.destroy(true)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰è¨­è¨ˆã€‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Futabaç”¨
------------------------------------------------
async function detectBoardCanvas_Futaba() {
  let canvas = document.querySelector('#oejs');
  if (canvas) return canvas;

  // ç„¡ã‘ã‚Œã°ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”Ÿæˆ
  const btn = document.querySelector('#oebtnj, #oebtnj_f');
  if (btn) btn.click();

  return new Promise((resolve, reject) => {
    const observer = new MutationObserver(() => {
      canvas = document.querySelector('#oejs');
      if (canvas) {
        observer.disconnect();
        resolve(canvas);
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });
    setTimeout(() => { observer.disconnect(); reject("Futaba canvas not found"); }, 5000);
  });
}

function stopTegaki_Futaba(app, boardCanvas) {
  try {
    const dataURL = app.view.toDataURL("image/png");
    const img = new Image();
    img.onload = () => {
      const ctx = boardCanvas.getContext("2d");
      ctx.clearRect(0, 0, boardCanvas.width, boardCanvas.height);
      ctx.drawImage(img, 0, 0, boardCanvas.width, boardCanvas.height);
      app.destroy(true);
    };
    img.src = dataURL;
  } catch (e) {
    console.error("Futaba stop failed", e);
  }
}

2. Mebukiç”¨
------------------------------------------------
async function detectFileInput_Mebuki() {
  let input = document.querySelector('input[type="file"][accept*="image/png"]');
  if (input) return input;

  const btn = document.querySelector('.dt_r_status-button'); // æ‰‹æ›¸ãã‚’æ·»ä»˜
  if (btn) btn.click();

  return new Promise((resolve, reject) => {
    const observer = new MutationObserver(() => {
      input = document.querySelector('input[type="file"][accept*="image/png"]');
      if (input) {
        observer.disconnect();
        resolve(input);
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });
    setTimeout(() => { observer.disconnect(); reject("Mebuki input not found"); }, 5000);
  });
}

function stopTegaki_Mebuki(app, input) {
  app.view.toBlob(blob => {
    const file = new File([blob], "tegaki.png", { type: "image/png" });
    const dt = new DataTransfer();
    dt.items.add(file);
    input.files = dt.files;
    input.dispatchEvent(new Event("change", { bubbles: true }));
    app.destroy(true);
  }, "image/png");
}

3. å…±é€š API
------------------------------------------------
window.tegakiStart = async function() {
  if (location.host.includes("2chan.net")) {
    const canvas = await detectBoardCanvas_Futaba();
    window.tegakiTarget = { type:"futaba", element:canvas };
  } else if (location.host.includes("mebuki.moe")) {
    const input = await detectFileInput_Mebuki();
    window.tegakiTarget = { type:"mebuki", element:input };
  }
  // PixiJS ã‚¢ãƒ—ãƒªèµ·å‹•å‡¦ç†ï¼ˆçœç•¥ï¼‰
};

window.tegakiStop = function(app) {
  if (!window.tegakiTarget) return;
  if (window.tegakiTarget.type === "futaba") {
    stopTegaki_Futaba(app, window.tegakiTarget.element);
  } else if (window.tegakiTarget.type === "mebuki") {
    stopTegaki_Mebuki(app, window.tegakiTarget.element);
  }
};

window.tegakiCancel = function(app) {
  app.destroy(true);
};

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€ã‚»ãƒ¬ã‚¯ã‚¿ã¾ã¨ã‚ã€‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Futaba:
  - boardCanvas: #oejs
  - button: #oebtnj, #oebtnj_f

Mebuki:
  - æ‰‹æ›¸ããƒœã‚¿ãƒ³: .dt_r_status-button
  - input[type=file][accept*="image/png"]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€æ”¹ä¿®è¨ˆç”»ã¸ã®åæ˜ ã€‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Futabaå¯¾å¿œ: å¾“æ¥é€šã‚Š canvas æ³¨å…¥æ–¹å¼ã€‚
- Mebukiå¯¾å¿œ: input[type=file] æ³¨å…¥æ–¹å¼ã«è¨­è¨ˆå¤‰æ›´ã€‚
- detect ç³»é–¢æ•°ã‚’åˆ†é›¢ã—ã€æ²ç¤ºæ¿ã”ã¨ã«åˆ‡æ›¿å¯èƒ½ã«ã™ã‚‹ã€‚
- Tegaki Core ã® API ã¯ start/stop/cancel ã‚’å…±é€šã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã«çµ±ä¸€ã€‚
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¦æ­¢: ã‚»ãƒ¬ã‚¯ã‚¿ãŒå¤‰ã‚ã£ã¦æ¤œå‡ºå¤±æ•—ã—ãŸã‚‰ä¾‹å¤–ã¨ã—ã¦çµ‚äº†ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä¾‹ã€‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
javascript:(function(){
  if(!window.tegakiStart){
    var s=document.createElement('script');
    s.charset='UTF-8';
    s.src='https://example.com/tegaki-loader.js';
    document.body.appendChild(s);
  } else {
    window.tegakiStart();
  }
})();
