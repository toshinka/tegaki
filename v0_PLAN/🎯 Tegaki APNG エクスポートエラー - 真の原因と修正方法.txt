# ğŸ¯ Tegaki APNG ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ - çœŸã®åŸå› ã¨ä¿®æ­£æ–¹æ³•

## **â–  ğŸš¨ çœŸã®åŸå› ã‚’ç‰¹å®šã—ã¾ã—ãŸ**

### **src/tegaki_anime_core.js ã® exportAsApng() ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¦ï¼š**

```javascript
async exportAsApng() {
    this.prepareExport();
    
    // â˜… ã‚¨ãƒ©ãƒ¼ã¯ã“ã“ã§ç™ºç”Ÿï¼
    if (!window.UPNG || !window.Zlib) {
        alert('APNGç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª(UPNG.js/pako.js)ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
        return null;
    }
    
    // ... ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰
    const apngData = UPNG.encode(  // â˜… ã“ã“ã§ undefined ã‚¨ãƒ©ãƒ¼
        frames,
        this.canvas.width,
        this.canvas.height,
        0,
        delays
    );
```

### **ğŸ”´ ç¢ºèªã•ã‚ŒãŸå•é¡Œç‚¹**

| # | å•é¡Œå†…å®¹ | é‡è¦åº¦ |
|----|---------|--------|
| **â‘  å‚ç…§æ–¹æ³•ã®ä¸çµ±ä¸€** | `window.UPNG` ã‚’ check ã—ã¦ã„ã‚‹ã®ã«ã€`UPNG.encode()` ã§å‚ç…§ã—ã¦ã„ã‚‹ | ğŸ”´ é«˜ |
| **â‘¡ window.pako ã®æ¤œè¨¼ãƒŸã‚¹** | checkæ™‚ã¯ `window.Zlib` ã ãŒã€UPNG.jså†…ã§ã¯ `window.pako` ã‚’å‚ç…§ | ğŸ”´ é«˜ |
| **â‘¢ libs/upng.js ã®åˆæœŸåŒ–é †åº** | pako ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹å‰ã« upng.js ãŒå®Ÿè¡Œã•ã‚Œã‚‹ | ğŸ”´ é«˜ |
| **â‘£ Build.js ã® Global Exports** | window ã¸ã®å…¬é–‹é †åºãŒä¸æ­£ | ğŸŸ¡ ä¸­ |

---

## **â–  ä¿®æ­£æ–¹æ³•ï¼ˆå„ªå…ˆé †ä½é †ï¼‰**

### **ğŸ“Œ ä¿®æ­£1: src/tegaki_anime_core.js ã® exportAsApng() ã‚’ä¿®æ­£**

**ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ï¼š**
```javascript
async exportAsApng() {
    this.prepareExport();
    if (!window.UPNG || !window.Zlib) {
        alert('APNGç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª(UPNG.js/pako.js)ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
        return null;
    }
    // ...
    const apngData = UPNG.encode(frames, ...);  // â˜… å‚ç…§æ–¹æ³•ãŒé•ã†ï¼
```

**ä¿®æ­£å¾Œï¼š**
```javascript
async exportAsApng() {
    this.prepareExport();
    
    // â˜… æ­£ç¢ºã«ãƒã‚§ãƒƒã‚¯
    if (!window.UPNG) {
        console.error('Missing UPNG:', {
            window_UPNG: !!window.UPNG,
            UPNG_type: typeof window.UPNG,
            UPNG_encode: typeof window.UPNG?.encode
        });
        throw new Error('APNGã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¯UPNG.jsãŒå¿…è¦ã§ã™ã€‚');
    }
    
    if (!window.pako) {  // â˜… Zlib ã§ã¯ãªã pako ã‚’ check
        console.error('Missing pako:', {
            window_pako: !!window.pako,
            pako_type: typeof window.pako,
            pako_inflate: typeof window.pako?.inflate
        });
        throw new Error('APNGã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¯pako.jsãŒå¿…è¦ã§ã™ã€‚');
    }
    
    const frames = [];
    
    for (const layerData of this.layers) {
        const frameCanvas = document.createElement('canvas');
        frameCanvas.width = this.canvas.width;
        frameCanvas.height = this.canvas.height;
        const frameCtx = frameCanvas.getContext('2d');
        
        frameCtx.drawImage(this.bgCanvas, 0, 0);
        frameCtx.putImageData(layerData, 0, 0);
        
        const imageData = frameCtx.getImageData(
            0, 0, 
            frameCanvas.width, 
            frameCanvas.height
        );
        
        frames.push(imageData.data.buffer);
    }
    
    const delays = Array(this.frameCount).fill(this.frameDelay);
    
    // â˜… window.UPNG ã§ã¯ãªã UPNG ã‚’ç›´æ¥å‚ç…§ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å­˜åœ¨ã™ã‚‹ãŸã‚ï¼‰
    const apngData = window.UPNG.encode(
        frames,
        this.canvas.width,
        this.canvas.height,
        0,
        delays
    );
    
    return new Blob([apngData], {type: 'image/png'});
}
```

---

### **ğŸ“Œ ä¿®æ­£2: build.js ã® Global Exports ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£**

**ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ï¼š**
```javascript
// ========== Global Exports ==========
(function() {
    'use strict';
    
    if (typeof window !== 'undefined') {
        if (typeof UPNG !== 'undefined') {
            window.UPNG = UPNG;
        }
        if (typeof pako !== 'undefined') {
            window.pako = pako;
            window.Zlib = pako;
        }
        if (typeof GIF !== 'undefined') {
            window.GIF = GIF;
        }
    }
})();
```

**ä¿®æ­£å¾Œï¼š**
```javascript
// ========== Global Exports ==========
(function() {
    'use strict';
    
    if (typeof window !== 'undefined') {
        // â˜… pako ã‚’å…ˆã«å…¬é–‹ï¼ˆupng.js ãŒä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ï¼‰
        if (typeof pako !== 'undefined') {
            window.pako = pako;
            window.Zlib = pako;  // äº’æ›æ€§ã®ãŸã‚ä¸¡æ–¹ã‚’å…¬é–‹
            console.log('âœ… pako.js exposed to window.pako and window.Zlib');
        } else {
            console.warn('âŒ pako.js not found in scope');
        }
        
        // â˜… UPNG ã‚’æ¬¡ã«å…¬é–‹ï¼ˆpako ãŒå…ˆã«å…¬é–‹ã•ã‚Œã¦ã‹ã‚‰ï¼‰
        if (typeof UPNG !== 'undefined') {
            window.UPNG = UPNG;
            console.log('âœ… UPNG.js exposed to window.UPNG');
        } else {
            console.warn('âŒ UPNG.js not found in scope');
        }
        
        // â˜… GIF ã‚’å…¬é–‹
        if (typeof GIF !== 'undefined') {
            window.GIF = GIF;
            console.log('âœ… GIF.js exposed to window.GIF');
        } else {
            console.warn('âŒ GIF.js not found in scope');
        }
        
        // â˜… æœ€çµ‚ãƒã‚§ãƒƒã‚¯
        const libs = {
            pako: !!window.pako,
            UPNG: !!window.UPNG,
            GIF: !!window.GIF
        };
        console.log('ğŸ“¦ Library initialization complete:', libs);
        
        if (!libs.pako || !libs.UPNG || !libs.GIF) {
            console.error('âš ï¸ Some libraries failed to load!', libs);
        }
    }
})();
```

---

### **ğŸ“Œ ä¿®æ­£3: libs/upng.js ã®ç›´å¾Œã«äº’æ›æ€§ã‚·ãƒ è¿½åŠ **

**build.js ã® `libraryFiles.forEach()` ç›´å¾Œã«è¿½åŠ ï¼š**

```javascript
// ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’é †æ¬¡èª­ã¿è¾¼ã‚“ã§çµåˆ
libraryFiles.forEach(file => {
    console.log(`ğŸ“¦ Reading: ${file}`);
    const content = fs.readFileSync(path.join(__dirname, file), 'utf8');
    output += `\n// ========== ${file} ==========\n`;
    output += content + '\n';
    
    // â˜… libs/upng.js ç›´å¾Œã«ã‚·ãƒ è¿½åŠ 
    if (file === 'libs/upng.js') {
        output += `
// ========== UPNG/Pako Compatibility Shim ==========
(function() {
    'use strict';
    
    // upng.js å†…ã§ IIFE ãŒå®Ÿè¡Œã•ã‚Œã‚‹æ™‚ã« pako ãŒå¿…è¦ãªãŸã‚ã€
    // å®Ÿè¡Œå¾Œã« window.pako ãŒã‚ã‚Œã° UPNGå†…éƒ¨ã§ã‚‚å‚ç…§å¯èƒ½ã«ã™ã‚‹
    if (typeof window !== 'undefined' && typeof UPNG !== 'undefined') {
        // UPNG ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ç™»éŒ²ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        console.log('âœ“ UPNG initialized, pako available:', !!window.pako);
    }
})();
`;
    }
});
```

---

### **ğŸ“Œ ä¿®æ­£4: ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ­ã‚°ã‚’å¼·åŒ–**

**build.js ã®ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ã€ã®ç›´å‰ã«è¿½åŠ ï¼š**

```javascript
// ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ã™ã‚‹å‰ã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
output += `
// ========== Pre-Export Debug Check ==========
(function() {
    console.log('Before Global Exports:');
    console.log('  typeof UPNG:', typeof UPNG);
    console.log('  typeof pako:', typeof pako);
    console.log('  typeof GIF:', typeof GIF);
    console.log('  typeof window.pako:', typeof window.pako);
    console.log('  typeof window.UPNG:', typeof window.UPNG);
})();
`;
```

---

## **â–  å¯¾å¿œç­–ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

GPT ã®æŒ‡æ‘˜ã«å¯¾ã™ã‚‹å¯¾å¿œçŠ¶æ³ï¼š

### **â‘  IIFEå†…ã‚¹ã‚³ãƒ¼ãƒ— â†’ windowã«éœ²å‡ºã—ã¦ã„ãªã„**
- âœ… **ä¿®æ­£**: `build.js` ã® Global Exports ã§pakoå„ªå…ˆå®Ÿè¡Œ

### **â‘¡ èª­ã¿è¾¼ã¿é † â†’ core.jsãŒå…ˆã«å®Ÿè¡Œ**
- âœ… **ä¿®æ­£**: `exportAsApng()` ã§ checké †åºã‚’çµ±ä¸€

### **â‘¢ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æ–‡ â†’ exportä»˜ãnpmç‰ˆã‚’ä½¿ç”¨**
- âœ… **ç¢ºèª**: `libs/pako.js` ã¯minified UMD â†’ IIFEç‰ˆ
- âœ… **ç¢ºèª**: `libs/upng.js` ã¯IIFEç‰ˆã§ window.UPNG ã«å…¬é–‹

### **â‘£ å‚ç…§æ–¹æ³• â†’ coreå´ãŒ window. ãªã—**
- âœ… **ä¿®æ­£**: `exportAsApng()` ã§ `window.UPNG` â†’ `UPNG` ã¸ã®æ˜ç¢ºãªå‚ç…§åˆ‡ã‚Šæ›¿ãˆ
- âœ… **ä¿®æ­£**: ãƒã‚§ãƒƒã‚¯ã¯ `window.pako`ï¼ˆ`window.Zlib` ã§ã¯ãªãï¼‰

---

## **â–  å®Ÿè£…æ‰‹é †**

### **Step 1: src/tegaki_anime_core.js ã‚’ä¿®æ­£**

- `exportAsApng()` ãƒ¡ã‚½ãƒƒãƒ‰ã® check/å‚ç…§éƒ¨åˆ†ã‚’ä¸Šè¨˜ã€Œä¿®æ­£1ã€ã®é€šã‚Šã«æ›´æ–°
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜

### **Step 2: build.js ã‚’ä¿®æ­£**

- Global Exports ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸Šè¨˜ã€Œä¿®æ­£2ã€ã®é€šã‚Šã«æ›´æ–°
- libs/upng.js ç›´å¾Œã«ã‚·ãƒ è¿½åŠ ï¼ˆä¿®æ­£3ï¼‰
- å¯èƒ½ã§ã‚ã‚Œã°ä¿®æ­£4ã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚‚è¿½åŠ 

### **Step 3: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ**

```bash
npm run build
```

### **Step 4: ãƒ†ã‚¹ãƒˆ**

```bash
python -m http.server 8000
# http://localhost:8000/TegakiAniTest.html
```

ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ï¼š
```javascript
console.log(window.pako, window.UPNG, window.GIF);
// ã™ã¹ã¦ true ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‹ç¢ºèª
```

### **Step 5: æ²ç¤ºæ¿ãƒ†ã‚¹ãƒˆ**

- ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå®Ÿè¡Œ
- æç”» â†’ APNGæŠ•ç¨¿
- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª

---

## **â–  ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**

### **Q: ãã‚Œã§ã‚‚ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹**

```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ç¢ºèª
console.log('UPNG.encode:', typeof UPNG.encode);
console.log('pako.inflate:', typeof pako.inflate);

// build.js ã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ç¢ºèª
npm run build | grep -E "(âœ“|âŒ|âœ…)"
```

### **Q: libs/upng.js ãŒå¤ã„å¯èƒ½æ€§**

```bash
# npm ã§æœ€æ–°ç‰ˆã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install upng-js@latest pako@latest --save

# libs/ ã«ã‚³ãƒ”ãƒ¼
cp node_modules/upng-js/UPNG.js libs/upng.js
cp node_modules/pako/dist/pako.js libs/pako.js

# å†åº¦ãƒ“ãƒ«ãƒ‰
npm run build
```