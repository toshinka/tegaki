# ====================================
# TEGAKI ARCHITECTURE RULEBOOK v10
# Twin-Star System with Coordinate Core
# ====================================
# Priority: Claude/AI readability and maintainability
# Update: 2025-01-XX
# Status: ACTIVE

SYSTEM_ARCHITECTURE:
  type: "Twin-Star System"
  structure:
    ui_star:
      main: "index.html"
      satellites:
        - "config.js"
        - "ui-panels.js"
        - "ui-tools.js"
    engine_star:
      main: "core-runtime.js"
      satellites:
        - "coordinate-system.js"
        - "layer-system.js"
        - "drawing-engine.js"
        - "transform-utils.js"
        - "clipboard-system.js"

CRITICAL_RULES:
  coordinate_system:
    single_source_of_truth: "coordinate-system.js"
    forbidden:
      - "Direct toLocal/toGlobal calls outside coordinate-system"
      - "Mixed coordinate spaces without explicit conversion"
      - "Ambiguous pivot references"
    required:
      - "All coordinate conversions through CoordinateSystem API"
      - "Explicit coordinate space naming: screen/world/layer/local"
      - "Pivot type annotation: pivotScreen/pivotWorld/pivotLayer"

  api_boundaries:
    pattern: "Facade with explicit exports"
    ui_to_engine:
      - "CoreRuntime.camera.*"
      - "CoreRuntime.layer.*"
      - "CoreRuntime.transform.*"
      - "CoreRuntime.draw.*"
    engine_to_ui:
      - "Events only (no direct calls)"
      - "Published via window.TegakiEvents"

  code_style:
    priority: "AI/Claude comprehension"
    requirements:
      - "Explicit type hints in comments"
      - "No implicit conversions"
      - "No fallback behaviors"
      - "No error recovery"
      - "Fail fast and loud"
    forbidden:
      - "try-catch for error hiding"
      - "|| operator for defaults"
      - "Automatic corrections"
      - "User-facing error dialogs"

IMPLEMENTATION_PHASES:
  phase_0_immediate:
    duration: "1 day"
    scope: "Apply GPT5 patch B"
    tasks:
      - id: "P0.1"
        action: "Add non-destructive transform patch to index.html"
        location: "index.html after DOMContentLoaded"
        validates: "Path-based transforms preserve data"
      - id: "P0.2"
        action: "Add deep-clone clipboard system"
        location: "index.html global scope"
        validates: "Copy-paste preserves path data"

  phase_1_coordinate_core:
    duration: "1 week"
    scope: "Extract and unify coordinate system"
    tasks:
      - id: "P1.1"
        action: "Create coordinate-system.js"
        exports:
          - "screenToWorld(app, x, y) -> {x, y}"
          - "worldToScreen(app, x, y) -> {x, y}"
          - "layerToWorld(layer, x, y) -> {x, y}"
          - "worldToLayer(layer, x, y) -> {x, y}"
          - "transformPoint(point, matrix) -> {x, y}"
      - id: "P1.2"
        action: "Replace all toLocal/toGlobal calls"
        pattern: "Search: .toLocal( -> Replace: CoordinateSystem.worldToLayer("
      - id: "P1.3"
        action: "Add coordinate space validation"
        implementation: "Assert coordinate space types in all APIs"

  phase_2_engine_star_creation:
    duration: "3 days"
    scope: "Create core-runtime.js as engine facade"
    tasks:
      - id: "P2.1"
        action: "Create core-runtime.js"
        structure: |
          window.CoreRuntime = {
            camera: CameraSystem,
            layer: LayerSystem,
            transform: TransformUtils,
            draw: DrawingEngine,
            coord: CoordinateSystem
          };
      - id: "P2.2"
        action: "Move camera logic from core-engine.js"
        target: "camera-system.js"
        api: ["pan", "zoom", "reset", "getViewport", "setViewport"]
      - id: "P2.3"
        action: "Update index.html references"
        pattern: "TegakiCore.* -> CoreRuntime.*"

  phase_3_layer_system_extraction:
    duration: "1 week"
    scope: "Path-first layer architecture"
    tasks:
      - id: "P3.1"
        action: "Create layer-system.js"
        data_model: |
          Layer = {
            id: string,
            paths: Path[],
            transform: Matrix,
            visible: boolean,
            opacity: number,
            blendMode: string,
            cache: RenderTexture | null
          }
          Path = {
            id: string,
            points: Point[],
            style: StyleData,
            closed: boolean
          }
      - id: "P3.2"
        action: "Implement non-destructive operations"
        methods:
          - "applyTransformToPaths(layer, transform, pivot)"
          - "mergePaths(layer, otherLayer)"
          - "splitPath(path, splitPoint)"
      - id: "P3.3"
        action: "Cache invalidation system"
        trigger_on: ["path modification", "transform change", "style change"]

  phase_4_drawing_engine_separation:
    duration: "3 days"
    scope: "Separate rendering from data"
    tasks:
      - id: "P4.1"
        action: "Create drawing-engine.js"
        responsibilities:
          - "Path to Graphics conversion"
          - "Brush stroke recording"
          - "Smoothing algorithms"
      - id: "P4.2"
        action: "Implement path rebuilding"
        signature: "rebuildGraphicsFromPath(path, graphics, style)"
      - id: "P4.3"
        action: "Optimize render caching"
        strategy: "Dirty flag system for selective updates"

  phase_5_final_cleanup:
    duration: "3 days"
    scope: "Remove core-engine.js"
    tasks:
      - id: "P5.1"
        action: "Verify all functionality migrated"
        checklist:
          - "All methods have new homes"
          - "No circular dependencies"
          - "Event system working"
      - id: "P5.2"
        action: "Delete core-engine.js"
        pre_condition: "All tests pass"
      - id: "P5.3"
        action: "Update documentation headers"
        format: "JSDoc with @module annotations"

COORDINATE_SPACE_DEFINITIONS:
  screen:
    origin: "top-left of canvas"
    units: "CSS pixels"
    usage: "Mouse/touch input, UI positioning"
  
  world:
    origin: "top-left of infinite canvas"
    units: "Canvas units (affected by camera zoom)"
    usage: "Layer positioning, camera viewport"
  
  layer:
    origin: "top-left of layer bounds"
    units: "Layer pixels"
    usage: "Path points, local transforms"
  
  local:
    origin: "object pivot point"
    units: "Object units"
    usage: "Rotation/scale operations"

VALIDATION_RULES:
  coordinate_conversion:
    required_annotations:
      - "// coord: screen"
      - "// coord: world"
      - "// coord: layer"
    forbidden_patterns:
      - "container.toGlobal without comment"
      - "Mixed coordinate math without conversion"
      - "Implicit screen<->world assumptions"

  api_contracts:
    method_signature:
      format: "methodName(param1: Type1, param2: Type2): ReturnType"
      example: "screenToWorld(x: number, y: number): {x: number, y: number}"
    
    error_handling:
      strategy: "throw immediately"
      format: 'throw new Error("MethodName: specific failure reason");'
      no_recovery: true

  memory_management:
    render_textures:
      - "Always destroy() when replacing"
      - "Single owner principle"
      - "Explicit lifecycle methods"
    
    event_listeners:
      - "Named functions only (for removal)"
      - "Cleanup in symmetric teardown"
      - "No anonymous handlers"

TESTING_STRATEGY:
  coordinate_tests:
    priority: "CRITICAL"
    cases:
      - "Round-trip conversions preserve position"
      - "Camera zoom affects world<->screen correctly"
      - "Layer transforms compose properly"
  
  visual_regression:
    method: "Manual verification"
    checkpoints:
      - "After each phase completion"
      - "Transform operations"
      - "Copy/paste operations"

MIGRATION_SAFETY:
  rollback_points:
    - "Before Phase 1: Tag 'pre-coordinate-extraction'"
    - "Before Phase 2: Tag 'pre-engine-star'"
    - "Before Phase 5: Tag 'pre-cleanup'"
  
  compatibility_bridge:
    during_migration: |
      // Temporary compatibility layer
      window.TegakiCore = window.CoreRuntime; // Alias during transition
    
    after_migration: |
      delete window.TegakiCore; // Clean break

FILE_SIZE_LIMITS:
  hard_limits:
    "*.js": "1500 lines"
    "index.html": "500 lines (excluding libs)"
  
  split_triggers:
    - "Method count > 30"
    - "Responsibility count > 3"
    - "Coordinate space mixing"

SUCCESS_METRICS:
  performance:
    - "Transform operations < 16ms"
    - "Layer switching < 8ms"
    - "Coordinate conversion < 1ms"
  
  code_quality:
    - "No coordinate space bugs"
    - "Clear API boundaries"
    - "Zero fallback patterns"

FORBIDDEN_PATTERNS:
  absolute_no:
    - "try { ... } catch(e) { /* ignore */ }"
    - "if (someValue || defaultValue)"
    - "container.toLocal without CoordinateSystem"
    - "Error modal/dialog/alert"
    - "Version compatibility checks"
    - "Automatic repair attempts"
    - "Silent failures"
    - "Fallback behaviors"

REQUIRED_PATTERNS:
  mandatory:
    - "Explicit coordinate space comments"
    - "Single responsibility per file"
    - "Event-based inter-system communication"
    - "Immutable path operations"
    - "Explicit disposal/cleanup"

STATUS_TRACKING:
  current_phase: 0
  next_milestone: "P0.1 - Apply GPT5 patch"
  blockers: []
  
END_OF_RULEBOOK_V10

â€»åˆ¥Claudeã‹ã‚‰ã®ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯è©•ä¾¡

âœ… ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ã®å„ªç§€ãªç‚¹
1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

Twin-Star Systemã¯è²¬ä»»åˆ†é›¢ãŒæ˜ç¢º
åº§æ¨™ç³»ã®çµ±ä¸€ã¯æœ€ã‚‚é‡è¦ãªå•é¡Œã‚’è§£æ±º
éç ´å£Šå¤‰æ›ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã«å¿…é ˆ

2. é–‹ç™ºæ–¹é‡

ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµ¶å¯¾ç¦æ­¢ã¯æ­£ã—ã„åˆ¤æ–­
AIå¯èª­æ€§å„ªå…ˆã¯ä¿å®ˆæ€§ã‚’å¤§å¹…å‘ä¸Š
æ®µéšçš„ç§»è¡Œã§ãƒªã‚¹ã‚¯è»½æ¸›

âš ï¸ æ½œåœ¨çš„ãªèª²é¡Œã¨å¯¾ç­–ææ¡ˆ
1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é–¢é€£ã®è¨˜è¿°ä¸è¶³
èª²é¡Œ:
javascript// å¤§é‡ãƒ‘ã‚¹å‡¦ç†æ™‚ã®æ€§èƒ½å•é¡ŒãŒæœªè€ƒæ…®
layer.paths.forEach(path => {
    path.points = path.points.map(pt => transformPoint(pt)); // é‡ã„å‡¦ç†
});
å¯¾ç­–è¿½åŠ ææ¡ˆ:
javascript// ãƒãƒƒãƒå‡¦ç†ã¨Workerå¯¾å¿œã‚’è¿½åŠ 
PERFORMANCE_RULES:
  path_processing:
    - "1000+ points: Use batch processing"  
    - "Complex transforms: Consider Web Workers"
    - "Real-time: Use requestAnimationFrame throttling"
2. ãƒ¡ãƒ¢ãƒªç®¡ç†ã®è©³ç´°ä¸è¶³
èª²é¡Œ: RenderTextureä»¥å¤–ã®ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³
è¿½åŠ ã™ã¹ãé …ç›®:
javascriptMEMORY_MANAGEMENT:
  graphics_objects:
    - "Graphics.clear() before rebuilding"
    - "Container.removeChildren() + child.destroy()"
  event_listeners:
    - "AbortController for cleanup"
    - "WeakMap for temporary references"
3. GIFåŒ–ã¨ã®å…·ä½“çš„ãªé€£æº
èª²é¡Œ: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã¨ã®çµ±åˆè©³ç´°ãŒæŠ½è±¡çš„
å…·ä½“åŒ–ææ¡ˆ:
javascriptGIF_INTEGRATION:
  timeline_structure:
    - "Frame = LayerState snapshot"
    - "Keyframe = Transform + opacity"
    - "Tween = Path interpolation"
  export_pipeline:
    - "Render each frame to texture"
    - "Batch encode with Web Workers"
4. ãƒ‡ãƒãƒƒã‚°ãƒ»è¨ºæ–­æ©Ÿèƒ½
è¿½åŠ æ¨å¥¨:
javascriptDEBUGGING_SYSTEM:
  coordinate_validation:
    - "Real-time coordinate space checker"
    - "Transform chain visualization"  
  performance_monitoring:
    - "Path count per layer warnings"
    - "Render time profiling"
ğŸ“‹ æ¨å¥¨ã™ã‚‹è¿½åŠ ãƒ«ãƒ¼ãƒ«
Phaseé–“ã®æ¤œè¨¼é …ç›®
javascriptPHASE_VALIDATION:
  after_coordinate_extraction:
    - "All mouse interactions work correctly"
    - "Layer transforms preserve visual position"
    - "Copy-paste maintains exact positioning"
  
  before_gif_implementation:  
    - "Path data completely separated from display"
    - "Non-destructive transforms verified"
    - "Memory usage stable under stress testing"
ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
javascriptERROR_HANDLING:
  coordinate_conversion:
    - "NaN/Infinity detection with immediate throw"
    - "Coordinate space type validation"
  
  path_operations:
    - "Empty path array validation"  
    - "Point array bounds checking"
ğŸ¯ çµè«–
ã“ã®ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ã¯85%å®Œæˆåº¦ã§ã€å®Ÿè£…é–‹å§‹ã«ååˆ†ãªå“è³ªã§ã™ã€‚
å³åº§ã«é–‹å§‹å¯èƒ½ãªç†ç”±:

æ ¸å¿ƒçš„ãªè¨­è¨ˆåŸå‰‡ã¯å®Œç’§
æ®µéšçš„ç§»è¡Œã§ãƒªã‚¹ã‚¯ç®¡ç†æ¸ˆã¿
åº§æ¨™ç³»çµ±ä¸€ã§æœ€å¤§ã®å•é¡Œã‚’è§£æ±º

å®Ÿè£…ä¸­ã«è¿½åŠ ã™ã¹ãé …ç›®:

ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã¨ãƒœãƒˆãƒ«ãƒãƒƒã‚¯å¯¾ç­–
ãƒ¡ãƒ¢ãƒªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœã®åæ˜ 
GIFåŒ–ã®å…·ä½“çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
