================================================================================
Phase 2 è¨ºæ–­çµæœã¨æ”¹ä¿®è¨ˆç”»æ›¸
================================================================================
è¨ºæ–­æ—¥æ™‚: 2025-10-05
å¯¾è±¡: Phase 1ä¿®æ­£å¾Œã®æ®‹å­˜å•é¡Œ

================================================================================
1. ç¾è±¡ã®ç¢ºèª
================================================================================

[å ±å‘Šã•ã‚ŒãŸå•é¡Œ]
âœ— Ctrl+Z/Y ã§CUTç§»å‹•ãŒç™ºç”Ÿã™ã‚‹ï¼ˆæœ¬æ¥ã¯Undo/Redoï¼‰
âœ— æ–¹å‘ã‚­ãƒ¼â†â†’ã§ã®CUTç§»å‹•ãŒä¸€ã¤é£›ã°ã—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ï¼ˆä¸å®‰å®šï¼‰
âœ— ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œãªã„ï¼ˆPhase 1ã§ä¿®æ­£ã—ãŸã¯ãšãŒæœªè§£æ±ºï¼‰

[æ­£å¸¸å‹•ä½œã—ã¦ã„ã‚‹éƒ¨åˆ†]
âœ“ æ–¹å‘ã‚­ãƒ¼ã®å·¦å³ã®æ–¹å‘æ€§ã¯ä¿®æ­£æ¸ˆã¿
âœ“ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¯è¡¨ç¤ºã•ã‚Œã‚‹

================================================================================
2. æ ¹æœ¬åŸå› ã®ç‰¹å®š
================================================================================

[åŸå› A: AnimationSystemã®ãƒ¡ã‚½ãƒƒãƒ‰åä¸ä¸€è‡´]

**å•é¡Œ:**
index.html ã§å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰åã¨ã€å®Ÿéš›ã®ãƒ¡ã‚½ãƒƒãƒ‰åãŒç•°ãªã‚‹

index.html (ä¿®æ­£ç‰ˆ):
```javascript
// â†: å‰ã®CUTã¸ç§»å‹•
window.animationSystem.goToNextCut();  // â† ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯å­˜åœ¨ã—ãªã„

// â†’: æ¬¡ã®CUTã¸ç§»å‹•
window.animationSystem.goToPreviousCut();  // â† ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯å­˜åœ¨ã—ãªã„
```

animation-system.js (å®Ÿéš›):
```javascript
goToPreviousFrame() { ... }  // â† æ­£ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰å
goToNextFrame() { ... }      // â† æ­£ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰å
```

**å½±éŸ¿:**
- æ–¹å‘ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã‚‚ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãšã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- ã‚¨ãƒ©ãƒ¼ãŒã‚­ãƒ£ãƒƒãƒã•ã‚Œãšã«ç„¡è¦–ã•ã‚Œã€ã€Œä¸€ã¤é£›ã°ã—ã€ã®ã‚ˆã†ãªä¸å®‰å®šãªå‹•ä½œã«è¦‹ãˆã‚‹
- å®Ÿéš›ã«ã¯ä½•ã‚‚å®Ÿè¡Œã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒé«˜ã„

[åŸå› B: Ctrl+Z/YãŒCUTç§»å‹•ã—ã¦ã—ã¾ã†å•é¡Œ]

**å•é¡Œã®æ‰€åœ¨ã‚’ç‰¹å®š:**
index.html ã®çµ±åˆã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ã‚’ç¢ºèªã™ã‚‹ã¨ã€Ctrl+Z/Y ã®å‡¦ç†ã¯æ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€‚
ã—ã‹ã—ã€ä»–ã®å ´æ‰€ï¼ˆlayer-system.js ã‚„ core-engine.jsï¼‰ã§ã‚‚æ–¹å‘ã‚­ãƒ¼ã‚„Ctrl+Z/Yã‚’
å‡¦ç†ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

**ç¢ºèªãŒå¿…è¦ãªç®‡æ‰€:**
1. layer-system.js: _setupLayerOperations() ãƒ¡ã‚½ãƒƒãƒ‰
   - æ–¹å‘ã‚­ãƒ¼ã®å‡¦ç†ãŒé‡è¤‡ã—ã¦ã„ã‚‹å¯èƒ½æ€§
2. core-engine.js: UnifiedKeyHandler
   - Phase 1-Cã§å‰Šé™¤ã—ãŸã¯ãšã ãŒã€ä»–ã®å‡¦ç†ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§
3. animation-system.js: ç‹¬è‡ªã®ã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
   - ç‹¬ç«‹ã—ãŸã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚‹å¯èƒ½æ€§

[åŸå› C: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒè¡¨ç¤ºã•ã‚Œãªã„]

**Phase 1ã§ä¿®æ­£ã—ãŸã¯ãšãŒ...**
window.drawingApp.layerManager ã®æ§‹é€ ã¯ä¿®æ­£æ¸ˆã¿ã®ã¯ãšã€‚
ã—ã‹ã—ã€ã¾ã è¡¨ç¤ºã•ã‚Œãªã„ã¨ã„ã†ã“ã¨ã¯ï¼š

**å¯èƒ½æ€§1: ãƒ•ã‚¡ã‚¤ãƒ«ã®ç½®ãæ›ãˆãƒŸã‚¹**
- ä¿®æ­£ã—ãŸ index.html ãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ãªã„
- ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ®‹ã£ã¦ã„ã‚‹

**å¯èƒ½æ€§2: åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å•é¡Œ**
- window.drawingApp.layerManager ã¯å­˜åœ¨ã™ã‚‹ãŒã€UIã®åˆæœŸåŒ–ãŒå¤±æ•—ã—ã¦ã„ã‚‹
- updateLayerPanelUI() ãŒå‘¼ã°ã‚Œã¦ã„ãªã„

**å¯èƒ½æ€§3: StateManagerã®æœªåˆæœŸåŒ–**
- LayerSystemãŒ StateManager ã«ä¾å­˜ã—ã¦ã„ã‚‹
- StateManager ãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ãŒç©ºã«ãªã‚‹

================================================================================
3. è©³ç´°è¨ºæ–­
================================================================================

[A. ãƒ¡ã‚½ãƒƒãƒ‰åä¸ä¸€è‡´ã®å½±éŸ¿ç¯„å›²]

å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:
- index.html: çµ±åˆã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ï¼ˆâ†â†’ã®å‡¦ç†ï¼‰

ä¿®æ­£å†…å®¹:
```javascript
// ä¿®æ­£å‰ï¼ˆé–“é•ã„ï¼‰
window.animationSystem.goToNextCut();
window.animationSystem.goToPreviousCut();

// ä¿®æ­£å¾Œï¼ˆæ­£ã—ã„ï¼‰
window.animationSystem.goToNextFrame();
window.animationSystem.goToPreviousFrame();
```

[B. ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®é‡è¤‡å‡¦ç†]

**layer-system.js ã®å•é¡Œ:**
è¡Œ1188-1215: _setupLayerOperations() å†…ã§æ–¹å‘ã‚­ãƒ¼ã‚’å‡¦ç†

```javascript
case 'gifPrevFrame':
    if (!this.vKeyPressed && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey) {
        if (this.animationSystem?.goToPreviousFrame) {
            this.animationSystem.goToPreviousFrame();
        }
        e.preventDefault();
    }
    break;
```

**å•é¡Œ:**
- index.html ã®çµ±åˆã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ã¨é‡è¤‡ã—ã¦ã„ã‚‹
- ä¸¡æ–¹ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã€ŒäºŒé‡å®Ÿè¡Œã€â†’ã€Œä¸€ã¤é£›ã°ã—ã€ã«è¦‹ãˆã‚‹

**core-engine.js: UnifiedKeyHandler ã®æ®‹å­˜å‡¦ç†:**
Phase 1-Cã§å‰Šé™¤ã—ãŸã¯ãšã ãŒã€ä»¥ä¸‹ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ï¼š

```javascript
case 'gifPrevFrame':
case 'gifNextFrame':
    // ã“ã®å‡¦ç†ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã€ä¸‰é‡å®Ÿè¡Œã«ãªã‚‹
```

[C. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«æœªè¡¨ç¤ºã®åŸå› ]

**Consoleç¢ºèªã‚³ãƒãƒ³ãƒ‰:**
```javascript
// Step 1: window.drawingAppã®æ§‹é€ ç¢ºèª
console.log('drawingApp:', window.drawingApp);
console.log('layerManager:', window.drawingApp?.layerManager);
console.log('typeof:', typeof window.drawingApp?.layerManager);

// Step 2: StateManagerç¢ºèª
console.log('StateManager:', window.StateManager);
console.log('stateManager instance:', window.drawingApp?.layerManager?.stateManager);

// Step 3: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«è¦ç´ ç¢ºèª
console.log('layer-list element:', document.getElementById('layer-list'));
console.log('layer-panel-container:', document.getElementById('layer-panel-container'));

// Step 4: LayerSystemã®åˆæœŸåŒ–çŠ¶æ…‹ç¢ºèª
console.log('currentCutContainer:', window.drawingApp?.layerManager?.currentCutContainer);
console.log('layers:', window.drawingApp?.layerManager?.getLayers());
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ:**
- layerManager: TegakiLayerSystem ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- stateManager: StateManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆã¾ãŸã¯ nullï¼‰
- currentCutContainer: PIXI.Container ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- layers: é…åˆ—ï¼ˆå°‘ãªãã¨ã‚‚1ã¤ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰

**å•é¡Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³:**
1. layerManager ãŒ undefined â†’ Phase 1-Aä¿®æ­£ãŒæœªåæ˜ 
2. stateManager ãŒ undefined â†’ StateManagerã®åˆæœŸåŒ–å¤±æ•—
3. currentCutContainer ãŒ null â†’ AnimationSystemã¨ã®é€£æºå¤±æ•—
4. layers ãŒç©ºé…åˆ— â†’ åˆæœŸãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä½œæˆã•ã‚Œã¦ã„ãªã„

================================================================================
4. æ”¹ä¿®è¨ˆç”»
================================================================================

[Phase 2-A: ãƒ¡ã‚½ãƒƒãƒ‰åä¿®æ­£ï¼ˆCRITICALï¼‰]

å„ªå…ˆåº¦: ğŸ”¥ CRITICAL
å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: index.html

ä¿®æ­£ç®‡æ‰€:
è¡Œ113-124: æ–¹å‘ã‚­ãƒ¼ã®CUTç§»å‹•å‡¦ç†

```javascript
// ä¿®æ­£å‰
if (e.code === 'ArrowLeft' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
    if (window.animationSystem?.goToNextCut) {
        window.animationSystem.goToNextCut();  // â† å­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰
    }
    e.preventDefault();
    return;
}

if (e.code === 'ArrowRight' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
    if (window.animationSystem?.goToPreviousCut) {
        window.animationSystem.goToPreviousCut();  // â† å­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰
    }
    e.preventDefault();
    return;
}

// ä¿®æ­£å¾Œ
if (e.code === 'ArrowLeft' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
    if (window.animationSystem?.goToNextFrame) {
        window.animationSystem.goToNextFrame();  // â† æ­£ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰å
    }
    e.preventDefault();
    return;
}

if (e.code === 'ArrowRight' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
    if (window.animationSystem?.goToPreviousFrame) {
        window.animationSystem.goToPreviousFrame();  // â† æ­£ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰å
    }
    e.preventDefault();
    return;
}
```

æœŸå¾…ã•ã‚Œã‚‹çµæœ:
âœ“ æ–¹å‘ã‚­ãƒ¼â†â†’ãŒå®‰å®šã—ã¦å‹•ä½œ
âœ“ ä¸€ã¤é£›ã°ã—ã®å•é¡ŒãŒè§£æ¶ˆ

[Phase 2-B: ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆé‡è¤‡å‰Šé™¤ï¼ˆCRITICALï¼‰]

å„ªå…ˆåº¦: ğŸ”¥ CRITICAL
å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: layer-system.js

ä¿®æ­£ç®‡æ‰€:
è¡Œ1188-1330: _setupLayerOperations() ãƒ¡ã‚½ãƒƒãƒ‰

**æ–¹é‡:**
layer-system.js ã‹ã‚‰ã¯ä»¥ä¸‹ã®ã‚­ãƒ¼å‡¦ç†ã‚’å®Œå…¨å‰Šé™¤ï¼š
- Ctrl+Z / Ctrl+Yï¼ˆUndo/Redoï¼‰
- æ–¹å‘ã‚­ãƒ¼â†â†’ï¼ˆä¿®é£¾ã‚­ãƒ¼ãªã—ï¼‰ã§ã®CUTç§»å‹•
- æ–¹å‘ã‚­ãƒ¼â†‘â†“ï¼ˆä¿®é£¾ã‚­ãƒ¼ãªã—ï¼‰ã§ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ç§»å‹•

**æ®‹ã™ã¹ãå‡¦ç†:**
- V ã‚­ãƒ¼ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ï¼‰
- V ã‚­ãƒ¼æŠ¼ä¸‹ä¸­ã®æ–¹å‘ã‚­ãƒ¼ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ç§»å‹•ãƒ»å›è»¢ãƒ»æ‹¡ç¸®ï¼‰
- V ã‚­ãƒ¼æŠ¼ä¸‹ä¸­ã® F ã‚­ãƒ¼ï¼ˆåè»¢ï¼‰

ä¿®æ­£å†…å®¹:
```javascript
_setupLayerOperations() {
    document.addEventListener('keydown', (e) => {
        const keyConfig = window.TEGAKI_KEYCONFIG_MANAGER;
        if (!keyConfig) return;
        
        const action = keyConfig.getActionForKey(e.code, {
            vPressed: this.vKeyPressed,
            shiftPressed: e.shiftKey
        });
        
        if (!action) return;
        
        switch(action) {
            // === Phase 2-B: ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã‚’å‰Šé™¤ ===
            // case 'gifPrevFrame':  // â† å‰Šé™¤
            // case 'gifNextFrame':  // â† å‰Šé™¤
            // case 'layerUp':       // â† å‰Šé™¤
            // case 'layerDown':     // â† å‰Šé™¤
            
            // === æ®‹ã™å‡¦ç† ===
            case 'layerMode':  // V ã‚­ãƒ¼
                if (!e.ctrlKey && !e.altKey && !e.metaKey) {
                    if (!this.vKeyPressed) {
                        this.enterLayerMoveMode();
                    }
                    e.preventDefault();
                }
                break;
            
            // V ã‚­ãƒ¼æŠ¼ä¸‹ä¸­ã®å‡¦ç†ã®ã¿æ®‹ã™
            case 'layerMoveUp':
            case 'layerMoveDown':
            case 'layerMoveLeft':
            case 'layerMoveRight':
            case 'layerScaleUp':
            case 'layerScaleDown':
            case 'layerRotateLeft':
            case 'layerRotateRight':
            case 'horizontalFlip':
                // ã“ã‚Œã‚‰ã¯ this.vKeyPressed === true ã®æ™‚ã®ã¿å‹•ä½œ
                // å‡¦ç†å†…å®¹ã¯å¤‰æ›´ãªã—
                break;
        }
    });
    
    // ... ä»¥é™ã®ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ãªã—
}
```

æœŸå¾…ã•ã‚Œã‚‹çµæœ:
âœ“ ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®é‡è¤‡å®Ÿè¡ŒãŒè§£æ¶ˆ
âœ“ Ctrl+Z/Y ãŒUndo/Redoã®ã¿ã«ãªã‚‹
âœ“ æ–¹å‘ã‚­ãƒ¼ãŒå®‰å®šå‹•ä½œ

[Phase 2-C: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«è¡¨ç¤ºå•é¡Œã®è¨ºæ–­ã¨ä¿®æ­£ï¼ˆHIGHï¼‰]

å„ªå…ˆåº¦: ğŸ”¥ HIGH
å¯¾è±¡: è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«

**ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢**
1. Ctrl+Shift+Delete ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
2. ãƒãƒ¼ãƒ‰ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆCtrl+Shift+Rï¼‰
3. DevToolsã®Application â†’ Clear storage â†’ Clear site data

**ã‚¹ãƒ†ãƒƒãƒ—2: Consoleè¨ºæ–­**
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’Consoleã§å®Ÿè¡Œï¼š

```javascript
// === è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ===
console.group('ğŸ” Phase 2 è¨ºæ–­');

// A. window.drawingAppç¢ºèª
console.log('A. drawingApp:', window.drawingApp);
console.log('   layerManager:', window.drawingApp?.layerManager);
console.log('   typeof:', typeof window.drawingApp?.layerManager);

// B. StateManagerç¢ºèª
console.log('B. StateManager class:', window.StateManager);
console.log('   stateManager instance:', window.drawingApp?.layerManager?.stateManager);

// C. AnimationSystemç¢ºèª
console.log('C. animationSystem:', window.animationSystem);
console.log('   getCurrentCut:', typeof window.animationSystem?.getCurrentCut);

// D. ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¢ºèª
console.log('D. currentCutContainer:', window.drawingApp?.layerManager?.currentCutContainer);
console.log('   layers count:', window.drawingApp?.layerManager?.getLayers()?.length);
console.log('   layers:', window.drawingApp?.layerManager?.getLayers());

// E. DOMè¦ç´ ç¢ºèª
console.log('E. layer-list:', document.getElementById('layer-list'));
console.log('   layer-panel-container:', document.getElementById('layer-panel-container'));

// F. åˆæœŸåŒ–çŠ¶æ…‹ç¢ºèª
console.log('F. initialCutCreated:', window.animationSystem?.initialCutCreated);
console.log('   hasInitialized:', window.animationSystem?.hasInitialized);

console.groupEnd();
```

**ã‚¹ãƒ†ãƒƒãƒ—3: å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®ä¿®æ­£**

**ãƒ‘ã‚¿ãƒ¼ãƒ³1: layerManager ãŒ undefined**
â†’ index.html ã® Phase 1-Aä¿®æ­£ãŒåæ˜ ã•ã‚Œã¦ã„ãªã„
â†’ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é…ç½®ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢

**ãƒ‘ã‚¿ãƒ¼ãƒ³2: stateManager ãŒ null**
â†’ StateManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„
â†’ state-manager.js ã®èª­ã¿è¾¼ã¿ç¢ºèª

**ãƒ‘ã‚¿ãƒ¼ãƒ³3: layers ãŒç©ºé…åˆ—**
â†’ åˆæœŸãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒä½œæˆã•ã‚Œã¦ã„ãªã„
â†’ animation-system.js ã® createInitialCutIfNeeded() ãŒå¤±æ•—ã—ã¦ã„ã‚‹

ä¿®æ­£æ–¹æ³•ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³3ã®å ´åˆï¼‰:
animation-system.js ã®åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’èª¿æ•´

**ãƒ‘ã‚¿ãƒ¼ãƒ³4: DOMè¦ç´ ãŒ null**
â†’ HTMLæ§‹é€ ã®å•é¡Œ
â†’ index.html ã® layer-panel-container ç¢ºèª

[Phase 2-D: StateManagerçµ±åˆç¢ºèªï¼ˆMEDIUMï¼‰]

å„ªå…ˆåº¦: ğŸŸ¡ MEDIUM
å¯¾è±¡: state-manager.js, layer-system.js

LayerSystemãŒ StateManager ã«æ­£ã—ãä¾å­˜ã—ã¦ã„ã‚‹ã‹ç¢ºèªï¼š

```javascript
// layer-system.js: constructor
constructor(pixiApp, config, stateManager, eventBus) {
    this.stateManager = stateManager || null;  // â† ã“ã‚ŒãŒ null ã®å ´åˆ
}
```

**å•é¡Œ:**
StateManager ãŒæ¸¡ã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œãŒå…¨ã¦å¤±æ•—ã™ã‚‹

**ä¿®æ­£æ–¹é‡:**
1. CoreEngine ã§ StateManager ã‚’åˆæœŸåŒ–
2. LayerSystem ã« StateManager ã‚’æ¸¡ã™

ä¿®æ­£ç®‡æ‰€: core-engine.js

```javascript
class CoreEngine {
    constructor(app) {
        // ... æ—¢å­˜ã‚³ãƒ¼ãƒ‰
        
        // StateManageråˆæœŸåŒ–
        this.stateManager = window.StateManager ? new window.StateManager() : null;
        
        // LayerSystemåˆæœŸåŒ–æ™‚ã«æ¸¡ã™
        this.layerSystem = new window.TegakiLayerSystem(
            app,
            CONFIG,
            this.stateManager,  // â† è¿½åŠ 
            this.eventBus
        );
    }
}
```

================================================================================
5. å®Ÿè£…é †åº
================================================================================

[æœ€å„ªå…ˆ: Phase 2-A]
1. index.html: goToNextCut â†’ goToNextFrame ã«ä¿®æ­£
2. index.html: goToPreviousCut â†’ goToPreviousFrame ã«ä¿®æ­£
   â†’ æ–¹å‘ã‚­ãƒ¼ã®å®‰å®šå‹•ä½œã‚’ç¢ºä¿

[æ¬¡å„ªå…ˆ: Phase 2-B]
3. layer-system.js: _setupLayerOperations() ã‹ã‚‰é‡è¤‡å‡¦ç†å‰Šé™¤
   â†’ ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸‰é‡å®Ÿè¡Œã‚’é˜²æ­¢

[è¨ºæ–­: Phase 2-C]
4. ãƒ–ãƒ©ã‚¦ã‚¶ã§Consoleè¨ºæ–­ã‚’å®Ÿæ–½
5. å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç‰¹å®š
6. ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®ä¿®æ­£ã‚’é©ç”¨

[è£œè¶³: Phase 2-D]
7. StateManagerçµ±åˆç¢ºèªï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

================================================================================
6. æ¤œè¨¼é …ç›®
================================================================================

[Phase 2-Aå®Œäº†å¾Œ]
â–¡ æ–¹å‘ã‚­ãƒ¼â† ã§CUTãŒå³ã«ç§»å‹•ï¼ˆå®‰å®šï¼‰
â–¡ æ–¹å‘ã‚­ãƒ¼â†’ ã§CUTãŒå·¦ã«ç§»å‹•ï¼ˆå®‰å®šï¼‰
â–¡ ä¸€ã¤é£›ã°ã—ã®ç¾è±¡ãŒç™ºç”Ÿã—ãªã„
â–¡ Console ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„

[Phase 2-Bå®Œäº†å¾Œ]
â–¡ Ctrl+Z ã§Undoï¼ˆCUTç§»å‹•ã—ãªã„ï¼‰
â–¡ Ctrl+Y ã§Redoï¼ˆCUTç§»å‹•ã—ãªã„ï¼‰
â–¡ æ–¹å‘ã‚­ãƒ¼â†â†’ ãŒä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹
â–¡ æ–¹å‘ã‚­ãƒ¼â†‘â†“ ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ç§»å‹•ï¼ˆä¸€åº¦ã ã‘ï¼‰

[Phase 2-Cå®Œäº†å¾Œ]
â–¡ ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ãŒç”»é¢å³å´ã«è¡¨ç¤ºã•ã‚Œã‚‹
â–¡ ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆ+ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
â–¡ åˆæœŸãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ1ã¤è¡¨ç¤ºã•ã‚Œã‚‹
â–¡ ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒä¸­å¤®ã«è¡¨ç¤ºã•ã‚Œã‚‹
â–¡ ãƒšãƒ³ã§æç”»ã§ãã‚‹

================================================================================
7. Consoleæ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ï¼ˆä¿®æ­£å¾Œï¼‰
================================================================================

```javascript
// === ä¿®æ­£ç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆ ===
console.group('âœ… Phase 2 ä¿®æ­£ç¢ºèª');

// 1. ãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨ç¢ºèª
console.log('1. goToPreviousFrame:', typeof window.animationSystem?.goToPreviousFrame);
console.log('   goToNextFrame:', typeof window.animationSystem?.goToNextFrame);
console.log('   goToPreviousCut:', typeof window.animationSystem?.goToPreviousCut);  // undefined ã§ã‚ã‚‹ã¹ã
console.log('   goToNextCut:', typeof window.animationSystem?.goToNextCut);  // undefined ã§ã‚ã‚‹ã¹ã

// 2. LayerManagerç¢ºèª
console.log('2. layerManager:', typeof window.drawingApp?.layerManager);
console.log('   stateManager:', window.drawingApp?.layerManager?.stateManager);

// 3. ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¢ºèª
console.log('3. layers:', window.drawingApp?.layerManager?.getLayers());

// 4. DOMç¢ºèª
console.log('4. layer-list:', document.getElementById('layer-list'));
console.log('   innerHTML length:', document.getElementById('layer-list')?.innerHTML.length);

console.groupEnd();
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:**
```
âœ… Phase 2 ä¿®æ­£ç¢ºèª
  1. goToPreviousFrame: "function"
     goToNextFrame: "function"
     goToPreviousCut: "undefined"
     goToNextCut: "undefined"
  2. layerManager: "object"
     stateManager: StateManager {...}
  3. layers: [Container {...}]
  4. layer-list: <div id="layer-list">...</div>
     innerHTML length: > 0
```

================================================================================
8. ãƒªã‚¹ã‚¯åˆ†æ
================================================================================

[Phase 2-A: ãƒ¡ã‚½ãƒƒãƒ‰åä¿®æ­£]
ãƒªã‚¹ã‚¯: ğŸŸ¢ LOW
ç†ç”±: å˜ç´”ãªåå‰å¤‰æ›´ã®ã¿

[Phase 2-B: ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆé‡è¤‡å‰Šé™¤]
ãƒªã‚¹ã‚¯: ğŸŸ¡ MEDIUM
ç†ç”±: layer-system.js ã®ã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ã‚’éƒ¨åˆ†å‰Šé™¤
å¯¾ç­–: V ã‚­ãƒ¼é–¢é€£ã®å‡¦ç†ã¯å¿…ãšæ®‹ã™

[Phase 2-C: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«è¡¨ç¤º]
ãƒªã‚¹ã‚¯: ğŸŸ¡ MEDIUM
ç†ç”±: æ ¹æœ¬åŸå› ãŒä¸æ˜ç¢ºï¼ˆè¨ºæ–­ãŒå¿…è¦ï¼‰
å¯¾ç­–: Consoleè¨ºæ–­ã§åŸå› ã‚’ç‰¹å®šã—ã¦ã‹ã‚‰ä¿®æ­£

[Phase 2-D: StateManagerçµ±åˆ]
ãƒªã‚¹ã‚¯: ğŸŸ¢ LOW
ç†ç”±: æ—¢å­˜ã®è¨­è¨ˆã«å¾“ã£ãŸä¿®æ­£

================================================================================
9. å®Œäº†åˆ¤å®šåŸºæº–
================================================================================

[Phase 2å®Œäº†ã®æ¡ä»¶]
âœ“ æ–¹å‘ã‚­ãƒ¼â†â†’ãŒå®‰å®šã—ã¦CUTç§»å‹•ï¼ˆä¸€ã¤é£›ã°ã—ãªã—ï¼‰
âœ“ Ctrl+Z/Y ãŒUndo/Redoã®ã¿ï¼ˆCUTç§»å‹•ã—ãªã„ï¼‰
âœ“ ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹
âœ“ ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹
âœ“ æç”»æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹
âœ“ Console ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„

================================================================================
10. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
================================================================================

Phase 2å®Œäº†å¾Œ:
1. æ–°è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼/CUTä½œæˆã®ã‚¢ãƒ³ãƒ‰ã‚¥å‹•ä½œã‚’æ¤œè¨¼
2. CUTãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³â—€â–¶ã®å‹•ä½œç¢ºèª
3. å…¨ä½“çš„ãªå®‰å®šæ€§ãƒ†ã‚¹ãƒˆ

================================================================================
ä»¥ä¸Š
================================================================================