# Phase1b6 æ”¹ä¿®è¨ˆç”»æ›¸ - ã‚¨ãƒ©ãƒ¼è§£æ±ºã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£çµ±ä¸€

## ğŸš¨ è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã®åŸå› åˆ†æ

### ã‚¨ãƒ©ãƒ¼: `Cannot read properties of null (reading 'worldContainer')`

**ç™ºç”Ÿå ´æ‰€**: `DrawingApp.initialize` (index.html:828:70)

**åŸå› **:
1. **äºŒé‡å®šç¾©å•é¡Œ**: `index.html`å†…ã¨`core-runtime.js`ã§`CoreRuntime`ãŒé‡è¤‡å®šç¾©
2. **APIå‚ç…§ä¸æ•´åˆ**: `coreRuntime.getWorldContainer()`ã‚’å‘¼ã‚“ã§ã„ã‚‹ãŒå®Ÿéš›ã¯`CoreRuntime.getWorldContainer()`
3. **åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒç•°ãªã‚‹åˆæœŸåŒ–é †åºã§ç«¶åˆ

## ğŸ“‹ å•é¡Œã®è©³ç´°åˆ†æ

### 1. åº§æ¨™å¤‰æ›APIã®ä¸ä¸€è‡´
- **ç¾çŠ¶**: å„ãƒ•ã‚¡ã‚¤ãƒ«ã§`CoordinateSystem`ã®ä½¿ã„æ–¹ãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„
- **å•é¡Œ**: `screenToWorld`ã€`worldToScreen`ã®å®Ÿè£…ãŒåˆ†æ•£ã—ã€å‚ç…§å…ˆãŒä¸æ˜ç¢º

### 2. ãƒ¬ã‚¤ãƒ¤ãƒ¼APIã®æ–­ç‰‡åŒ–  
- **ç¾çŠ¶**: `index.html`å†…ã®`LayerSystem`ã¨`layer-system.js`ã®`LayerSystem`ãŒåˆ¥ç‰©
- **å•é¡Œ**: åŒã˜åå‰ã§ç•°ãªã‚‹APIã‚’æä¾›ã—ã€æ··ä¹±ã‚’æ‹›ã„ã¦ã„ã‚‹

### 3. EventBusçµ±åˆã®ä¸å®Œå…¨æ€§
- **ç¾çŠ¶**: å„ã‚·ã‚¹ãƒ†ãƒ ãŒç‹¬è‡ªã®`SimpleEventBus`ã‚’æŒã£ã¦ã„ã‚‹
- **å•é¡Œ**: ã‚·ã‚¹ãƒ†ãƒ é–“é€šä¿¡ãŒæ–­çµ¶ã—ã€çµ±ä¸€ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ãŒã§ããªã„

### 4. è¨­å®šå‚ç…§ã®æ··åœ¨
- **ç¾çŠ¶**: `window.TEGAKI_CONFIG`ã‚’å„æ‰€ã§å€‹åˆ¥å‚ç…§
- **å•é¡Œ**: è¨­å®šã®ä¸€å…ƒç®¡ç†ãŒã§ããšã€ä¾å­˜é–¢ä¿‚ãŒè¤‡é›‘

### 5. PixiJS v8.13æº–æ‹ ã®ç¢ºèªä¸è¶³
- **ç¾çŠ¶**: `new PIXI.Application()`ã¨`await app.init()`ãŒæ··åœ¨
- **å•é¡Œ**: v8.13ã®æ–°ã—ã„åˆæœŸåŒ–æ–¹æ³•ã«çµ±ä¸€ã•ã‚Œã¦ã„ãªã„

## ğŸ¯ æ”¹ä¿®æ–¹é‡ï¼ˆåŸå‰‡ï¼‰

### å˜ä¸€è²¬å‹™åŸå‰‡
- 1ã¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« = 1ã¤ã®è²¬å‹™
- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®æ’é™¤
- æ˜ç¤ºçš„ãªä¾å­˜é–¢ä¿‚

### æ˜ç¤ºåˆæœŸåŒ–
- critical resourceï¼ˆPIXI.Applicationã€worldContainerã€EventBusï¼‰ã¯æ˜ç¤ºçš„ç”Ÿæˆ
- æš—é»™ã®ä½œæˆãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¦æ­¢
- ã‚¨ãƒ©ãƒ¼æ™‚ã¯å³åº§ã«ä¾‹å¤–ã§åœæ­¢

### åˆæœŸåŒ–é †åºã®å›ºå®šåŒ–
```
1. CoreRuntime.init() (PIXI.Application + EventBus + worldContainer)
2. CoordinateSystem.init() 
3. CameraSystem.init()
4. LayerSystem.init()
5. CoreEngine.init()
6. DrawingApp.initialize()
```

### APIå¥‘ç´„ã®å³æ ¼åŒ–
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã¯æ˜ç¤ºçš„accessoré–¢æ•°ã§ã‚„ã‚Šã¨ã‚Š
- æ–‡å­—åˆ—åã‚„ç›´ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
- `getWorldContainer()`ãªã©ã®çµ±ä¸€API

## ğŸ”§ å„ªå…ˆä¿®æ­£é …ç›®ï¼ˆå¿…é ˆï¼‰

### 1. CoreRuntimeã®ä¸€æœ¬åŒ–ï¼ˆæœ€å„ªå…ˆï¼‰

**å•é¡Œ**: `index.html`ã¨`core-runtime.js`ã§é‡è¤‡å®šç¾©

**è§£æ±ºç­–**:
- `index.html`å†…ã®`CoreRuntime`å®šç¾©ã‚’å‰Šé™¤
- `core-runtime.js`ã®èª­ã¿è¾¼ã¿ã‚’æœ€å„ªå…ˆã«
- çµ±ä¸€ã•ã‚ŒãŸåˆæœŸåŒ–ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã®æä¾›

```javascript
// ä¿®æ­£å¾Œã®index.html
<script src="core-runtime.js"></script>
<script src="coordinate-system.js"></script>
<script src="layer-system.js"></script>
<script src="camera-system.js"></script>
<script src="core-engine.js"></script>

<script>
async function initializeApp() {
    // 1. CoreRuntimeåˆæœŸåŒ–ï¼ˆæœ€å„ªå…ˆï¼‰
    await CoreRuntime.init({
        canvasElement: document.getElementById('drawing-canvas'),
        width: window.innerWidth - 50,
        height: window.innerHeight
    });
    
    // 2. å„ã‚·ã‚¹ãƒ†ãƒ é †æ¬¡åˆæœŸåŒ–
    await CoordinateSystem.init(CoreRuntime.getApp());
    await CameraSystem.init(CoreRuntime.getApp(), CoreRuntime.getWorldContainer());
    await LayerSystem.init(CoreRuntime.getApp(), CoreRuntime.getWorldContainer());
    
    // 3. DrawingAppåˆæœŸåŒ–
    const app = new DrawingApp();
    await app.initialize();
}

initializeApp().catch(console.error);
</script>
```

### 2. åº§æ¨™å¤‰æ›APIã®çµ±ä¸€

**å•é¡Œ**: `CoordinateSystem`ã®å®Ÿè£…ãŒãƒãƒ©ãƒãƒ©

**è§£æ±ºç­–**:
```javascript
// coordinate-system.js çµ±ä¸€API
window.CoordinateSystem = {
    init(app, worldContainer) {
        this._app = app;
        this._worldContainer = worldContainer;
    },
    
    screenToWorld(screenPoint) {
        // worldContainerã®é€†å¤‰æ›ã‚’ä½¿ç”¨
        const worldTransform = this._worldContainer.worldTransform;
        const inverted = new PIXI.Matrix();
        worldTransform.copyTo(inverted);
        inverted.invert();
        return inverted.apply(screenPoint);
    },
    
    worldToScreen(worldPoint) {
        const worldTransform = this._worldContainer.worldTransform;
        return worldTransform.apply(worldPoint);
    },
    
    // ãã®ä»–ã®API...
};
```

### 3. EventBusã®çµ±ä¸€

**å•é¡Œ**: å„ã‚·ã‚¹ãƒ†ãƒ ãŒç‹¬è‡ªEventBus

**è§£æ±ºç­–**:
```javascript
// core-runtime.jså†…ã§å˜ä¸€EventBusç®¡ç†
class CoreRuntime {
    static init() {
        this._eventBus = new PIXI.EventEmitter(); // PixiJS v8.13æº–æ‹ 
        this._app = new PIXI.Application();
        await this._app.init({ /* options */ });
        // ...
    }
    
    static getEventBus() {
        if (!this._eventBus) throw new Error('CoreRuntime not initialized');
        return this._eventBus;
    }
}

// å„ã‚·ã‚¹ãƒ†ãƒ ã¯å…±æœ‰EventBusã‚’ä½¿ç”¨
// layer-system.js
class LayerSystem {
    init(options) {
        this.eventBus = CoreRuntime.getEventBus(); // å…±æœ‰EventBus
        // ...
    }
}
```

### 4. PixiJS v8.13ã¸ã®å®Œå…¨å¯¾å¿œ

**å•é¡Œ**: åˆæœŸåŒ–æ–¹æ³•ã®æ··åœ¨

**è§£æ±ºç­–**:
```javascript
// core-runtime.js - PixiJS v8.13æº–æ‹ 
async function init() {
    const app = new PIXI.Application();
    await app.init({
        width: opts.width || 1200,
        height: opts.height || 800,
        backgroundAlpha: 0,
        resizeTo: window
    });
    
    // DOMè¿½åŠ 
    const root = document.getElementById(opts.rootId || 'drawing-canvas');
    root.appendChild(app.canvas); // app.view â†’ app.canvas
    
    // EventBus (v8.13å¯¾å¿œ)
    const eventBus = new PIXI.EventEmitter();
    
    // worldContainerä½œæˆ
    const worldContainer = new PIXI.Container();
    worldContainer.name = 'worldContainer';
    app.stage.addChild(worldContainer);
    
    return { app, worldContainer, eventBus };
}
```

## ğŸš€ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### ã‚¹ãƒ†ãƒƒãƒ—1: ç·Šæ€¥ä¿®æ­£ï¼ˆå³åº§ã«å®Ÿè¡Œï¼‰
1. `index.html`å†…ã®`CoreRuntime`å®šç¾©å‰Šé™¤
2. ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é †åºã®ä¿®æ­£
3. `DrawingApp.initialize`ã®å‚ç…§ä¿®æ­£

### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚·ã‚¹ãƒ†ãƒ çµ±åˆï¼ˆ1-2æ™‚é–“ï¼‰
1. EventBusã®çµ±ä¸€
2. åº§æ¨™å¤‰æ›APIã®çµ±ä¸€
3. åˆæœŸåŒ–é †åºã®å›ºå®šåŒ–

### ã‚¹ãƒ†ãƒƒãƒ—3: APIæ•´ç†ï¼ˆ2-3æ™‚é–“ï¼‰
1. ãƒ¬ã‚¤ãƒ¤ãƒ¼APIçµ±ä¸€
2. ã‚«ãƒ¡ãƒ©APIæ•´ç†
3. è¨­å®šç®¡ç†ã®ä¸€å…ƒåŒ–

### ã‚¹ãƒ†ãƒƒãƒ—4: å‹•ä½œç¢ºèªï¼ˆ1æ™‚é–“ï¼‰
1. åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª

## ğŸ“ æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„åŠ¹æœ

### å³åº§ã®åŠ¹æœ
- âŒ ã‚¨ãƒ©ãƒ¼ã€ŒCannot read properties of nullã€ã®è§£æ±º
- âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ­£å¸¸èµ·å‹•
- âœ… åŸºæœ¬æç”»æ©Ÿèƒ½ã®å‹•ä½œ

### ä¸­æœŸçš„åŠ¹æœ  
- ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ é–“é€£æºã®å®‰å®šåŒ–
- ğŸš€ é–‹ç™ºåŠ¹ç‡ã®å‘ä¸Š
- ğŸ¯ æ©Ÿèƒ½è¿½åŠ ã®å®¹æ˜“æ€§

### é•·æœŸçš„åŠ¹æœ
- ğŸ“ˆ AIæ”¹ä¿®å®¹æ˜“æ€§ã®å‘ä¸Š
- ğŸ¨ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½è¿½åŠ ã®æº–å‚™
- ğŸŒŸ Phase2ç§»è¡Œã®åŸºç›¤ç¢ºç«‹

## ğŸš¨ æ³¨æ„äº‹é …

### çµ¶å¯¾ã«é¿ã‘ã‚‹ã¹ãã“ã¨
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã®è¿½åŠ ï¼ˆå•é¡Œã‚’éš è”½ã™ã‚‹ã ã‘ï¼‰
- è¤‡æ•°ã®åˆæœŸåŒ–ãƒ‘ã‚¹ã®ä¸¦å­˜
- ã‚¨ãƒ©ãƒ¼æ•æ‰ã«ã‚ˆã‚‹å¼·åˆ¶ç¶™ç¶š

### æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œ
- ã‚¨ãƒ©ãƒ¼æ™‚ã®å³åº§åœæ­¢
- æ˜ç¤ºçš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- ä¾å­˜é–¢ä¿‚ã®æ˜ç¢ºåŒ–

## ğŸ“Š æˆåŠŸæŒ‡æ¨™

### æŠ€è¡“æŒ‡æ¨™
- [ ] ã‚¨ãƒ©ãƒ¼ãªã—ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
- [ ] å…¨ã‚·ã‚¹ãƒ†ãƒ ã®æ­£å¸¸åˆæœŸåŒ–
- [ ] ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãªã—
- [ ] FPS 60ç¶­æŒ

### æ©Ÿèƒ½æŒ‡æ¨™  
- [ ] ãƒšãƒ³æç”»æ©Ÿèƒ½æ­£å¸¸å‹•ä½œ
- [ ] ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œæ­£å¸¸å‹•ä½œ
- [ ] ã‚«ãƒ¡ãƒ©æ“ä½œæ­£å¸¸å‹•ä½œ
- [ ] UIé€£æºæ­£å¸¸å‹•ä½œ

---

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ä¸Šè¨˜ã‚¹ãƒ†ãƒƒãƒ—1ã®ç·Šæ€¥ä¿®æ­£ã‚’å³åº§ã«å®Ÿè¡Œã—ã€ã‚¨ãƒ©ãƒ¼ã‚’è§£æ±ºã—ã¾ã™ã€‚