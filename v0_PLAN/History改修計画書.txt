================================================================================
Historyæ”¹ä¿®è¨ˆç”»æ›¸ - v8.13_History6
è¨ºæ–­æ—¥: 2025å¹´10æœˆ6æ—¥
================================================================================

ã€0. ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ã€‘

ç¾åœ¨ã®Historyã‚·ã‚¹ãƒ†ãƒ ã¯ã€Œå¤–éƒ¨ã‹ã‚‰ã®æ˜ç¤ºçš„ãªå‘¼ã³å‡ºã—ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ã€æ–¹å¼
ã‚’æ¡ç”¨ã—ã¦ãŠã‚Šã€å‘¼ã³å‡ºã—æ¼ã‚Œãƒ»éåŒæœŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ã‚ºãƒ¬ãƒ»äºŒé‡è¨˜éŒ²ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®å•é¡Œ
ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™:

1. æç”»ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å¾Œã«Historyè¨˜éŒ²ã•ã‚Œãªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹
2. ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œï¼ˆç§»å‹•ãƒ»å¤‰å½¢ï¼‰ãŒHistoryè¨˜éŒ²ã•ã‚Œãªã„
3. Undo/Redoã®ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºãŒä¸æ•´åˆ
4. å‡¦ç†ãŒç·©æ…¢ï¼ˆsetTimeout 50mså¤šç”¨ï¼‰

æ ¹æœ¬åŸå› ã¯ã€Œèª°ãŒãƒ»ã„ã¤ãƒ»History.saveState()ã‚’å‘¼ã¶ã‹ã€ãŒæ›–æ˜§ã§ã‚ã‚‹ã“ã¨ã§ã™ã€‚


ã€1. ç¾çŠ¶ã®å•é¡Œåˆ†æã€‘

â–  1-1. æç”»ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ²ã®æ¬ é™¥

ç¾åœ¨ã®å®Ÿè£…:
- core-engine.js: stopDrawing()ã§History.saveState()ã‚’å‘¼ã‚“ã§ã„ã‚‹
- ã—ã‹ã—ã€isExecutingUndoRedo/isRecordingStateã®ã‚¬ãƒ¼ãƒ‰æ¡ä»¶ã«ã‚ˆã‚Šã€è¨˜éŒ²ãŒã‚¹ã‚­ãƒƒãƒ—
  ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ãŒå­˜åœ¨

å•é¡Œç®‡æ‰€ï¼ˆcore-engine.js: 146-149è¡Œç›®ï¼‰:
```
if (window.History && typeof window.History.saveState === 'function') {
    if (!window.History._manager?.isExecutingUndoRedo && 
        !window.History._manager?.isRecordingState) {
        window.History.saveState();  // â†ã“ã®æ¡ä»¶ãŒå³ã—ã™ãã‚‹
    }
}
```

æ”¹å–„æ–¹é‡:
â†’ æç”»å®Œäº†æ™‚ã«ã¯å¿…ãšHistoryè¨˜éŒ²ã‚’è¡Œã†ï¼ˆãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯ã‚’ç·©å’Œï¼‰


â–  1-2. ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ»å¤‰å½¢ã®è¨˜éŒ²æ¬ é™¥

ç¾åœ¨ã®å®Ÿè£…:
- layer-system.js: Vã‚­ãƒ¼ãƒ¢ãƒ¼ãƒ‰ä¸­ã®ç§»å‹•ãƒ»å›è»¢ãƒ»æ‹¡ç¸®ã¯å³åº§ã«é©ç”¨ã•ã‚Œã‚‹ãŒã€
  exitLayerMoveMode()æ™‚ã«confirmLayerTransform()ãŒå‘¼ã°ã‚Œã¦ãƒ‘ã‚¹ã«ç„¼ãè¾¼ã¾ã‚Œã‚‹
- confirmLayerTransform()å†…ã§Historyè¨˜éŒ²ã¯å­˜åœ¨ã—ãªã„

å•é¡Œç®‡æ‰€ï¼ˆlayer-system.js: confirmLayerTransform()ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰:
```
confirmLayerTransform() {
    // ... ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ é©ç”¨å‡¦ç† ...
    // ğŸ”¥ Historyè¨˜éŒ²ãŒå­˜åœ¨ã—ãªã„ï¼
}
```

æ”¹å–„æ–¹é‡:
â†’ exitLayerMoveMode()å®Œäº†æ™‚ã«å¿…ãšHistory.saveState()ã‚’å‘¼ã¶


â–  1-3. setTimeouté…å»¶ã«ã‚ˆã‚‹éåŒæœŸã‚ºãƒ¬

ç¾åœ¨ã®å®Ÿè£…ï¼ˆhistory.js: 65-75è¡Œç›®ï¼‰:
```
this.eventBus.on('animation:cut-deleted', () => {
    if (this.isExecutingUndoRedo || this.isRecordingState) return;
    setTimeout(() => this.saveStateFull(), 50);  // â†50msé…å»¶
});
```

å•é¡Œ:
- UIå¤‰æ›´ã¨Historyè¨˜éŒ²ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚ºãƒ¬ã‚‹
- ã‚«ãƒƒãƒˆå‰Šé™¤ç›´å¾Œã«åˆ¥æ“ä½œã‚’è¡Œã†ã¨è¨˜éŒ²é †åºãŒé€†è»¢ã™ã‚‹å¯èƒ½æ€§

æ”¹å–„æ–¹é‡:
â†’ setTimeoutã‚’å‰Šé™¤ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆå®Œäº†æ™‚ã«åŒæœŸçš„ã«è¨˜éŒ²


â–  1-4. ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ç§»å‹•ã®è¨˜éŒ²æ¬ é™¥

ç¾åœ¨ã®å®Ÿè£…ï¼ˆlayer-system.js: moveActiveLayerHierarchy()ï¼‰:
```
if (newIndex !== currentIndex) {
    if (window.History && typeof window.History.saveState === 'function') {
        if (!window.History._manager?.isExecutingUndoRedo && 
            !window.History._manager?.isRecordingState) {
            window.History.saveState();  // â†éšå±¤ç§»å‹•å‰ã«è¨˜éŒ²
        }
    }
    this.setActiveLayer(newIndex);  // â†ç§»å‹•å®Ÿè¡Œ
}
```

å•é¡Œ:
- ç§»å‹•å‰ã®çŠ¶æ…‹ã‚’è¨˜éŒ²ã—ã¦ã„ã‚‹ãŸã‚ã€Undoæ™‚ã«æ•´åˆæ€§ãŒå–ã‚Œãªã„å¯èƒ½æ€§
- setActiveLayer()ã¯å˜ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´
  ã§ã¯ãªã„ãŸã‚ã€è¨˜éŒ²ã™ã‚‹æ„å‘³ãŒè–„ã„

æ”¹å–„æ–¹é‡:
â†’ reorderLayers()ãŒå‘¼ã°ã‚ŒãŸå ´åˆã®ã¿Historyè¨˜éŒ²ï¼ˆå®Ÿéš›ã®é †åºå¤‰æ›´æ™‚ï¼‰


ã€2. æ”¹ä¿®è¨­è¨ˆã€‘

â–  2-1. æ”¹ä¿®æ–¹é‡ã®åŸå‰‡

1. ã€Œæ“ä½œå®Œäº†æ™‚ã«ä¸€åº¦ã ã‘è¨˜éŒ²ã€ã®å¾¹åº•
2. setTimeouté…å»¶ã‚’æ’é™¤ã—åŒæœŸçš„è¨˜éŒ²
3. isExecutingUndoRedo/isRecordingStateã‚¬ãƒ¼ãƒ‰ã®é©åˆ‡åŒ–
4. è¨˜éŒ²è²¬ä»»ã®æ˜ç¢ºåŒ–ï¼ˆèª°ãŒãƒ»ã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ï¼‰


â–  2-2. æ”¹ä¿®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã¨å†…å®¹

ã€ãƒ•ã‚¡ã‚¤ãƒ«1ã€‘history.js
ä¿®æ­£å†…å®¹:
1. setTimeouté…å»¶ã‚’å‰Šé™¤ï¼ˆ65-75è¡Œç›®ï¼‰
   - 'animation:cut-deleted' ã‚¤ãƒ™ãƒ³ãƒˆ
   - 'cut:pasted-right-adjacent' ã‚¤ãƒ™ãƒ³ãƒˆ
   - 'cut:pasted-new' ã‚¤ãƒ™ãƒ³ãƒˆ
   â†’ å³åº§ã«saveStateFull()ã‚’å‘¼ã¶

2. saveState()ã®ã‚¬ãƒ¼ãƒ‰æ¡ä»¶ã‚’ç·©å’Œï¼ˆ91-124è¡Œç›®ï¼‰
   - æç”»ç³»æ“ä½œã¯ isRecordingState ã®ã¿ãƒã‚§ãƒƒã‚¯
   - isExecutingUndoRedo ã¯é™¤å¤–ï¼ˆUndoä¸­ã§ã‚‚æ–°è¦æ“ä½œã¯è¨˜éŒ²ï¼‰


ã€ãƒ•ã‚¡ã‚¤ãƒ«2ã€‘core-engine.js
ä¿®æ­£å†…å®¹:
1. stopDrawing()ã®Historyè¨˜éŒ²ã‚’ç¢ºå®ŸåŒ–ï¼ˆ143-169è¡Œç›®ï¼‰
   - isExecutingUndoRedo ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤
   - æç”»å®Œäº†æ™‚ã¯å¿…ãšè¨˜éŒ²

2. layer:clear-active ã‚¤ãƒ™ãƒ³ãƒˆã®Historyè¨˜éŒ²ã‚’ç¢ºå®ŸåŒ–ï¼ˆ530-563è¡Œç›®ï¼‰
   - åŒæ§˜ã«ã‚¬ãƒ¼ãƒ‰æ¡ä»¶ã‚’ç·©å’Œ


ã€ãƒ•ã‚¡ã‚¤ãƒ«3ã€‘layer-system.js
ä¿®æ­£å†…å®¹:
1. exitLayerMoveMode()ã«Historyè¨˜éŒ²è¿½åŠ ï¼ˆ944-968è¡Œç›®ï¼‰
   - confirmLayerTransform()å®Ÿè¡Œå¾Œã«History.saveState()ã‚’å‘¼ã¶

2. confirmLayerTransform()ã®è¨˜éŒ²ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ˜ç¢ºåŒ–ï¼ˆ978-1021è¡Œç›®ï¼‰
   - ç¾åœ¨ã¯è¨˜éŒ²ãªã— â†’ exitLayerMoveMode()ã§ä¸€æ‹¬è¨˜éŒ²

3. reorderLayers()ã«Historyè¨˜éŒ²è¿½åŠ ï¼ˆ140-183è¡Œç›®ï¼‰
   - ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´æˆåŠŸæ™‚ã«History.saveState()

4. moveActiveLayerHierarchy()ã®Historyè¨˜éŒ²ã‚’å‰Šé™¤ï¼ˆ690-720è¡Œç›®ï¼‰
   - å®Ÿéš›ã®é †åºå¤‰æ›´ã¯ reorderLayers() ã§è¡Œã‚ã‚Œã‚‹
   - setActiveLayer()ã¯å˜ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¤‰æ›´ãªã®ã§è¨˜éŒ²ä¸è¦


ã€ãƒ•ã‚¡ã‚¤ãƒ«4ã€‘animation-system.js
ä¿®æ­£å†…å®¹:
- Phase 3ã§æ—¢ã«æ‰‹å‹•Historyè¨˜éŒ²ã‚’å‰Šé™¤æ¸ˆã¿ï¼ˆ555-567è¡Œç›®ï¼‰
- ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã®ã¿ã§ history.js ãŒè‡ªå‹•è¨˜éŒ²ã™ã‚‹è¨­è¨ˆ
- ç¾çŠ¶ç¶­æŒï¼ˆå¤‰æ›´ä¸è¦ï¼‰


â–  2-3. è¨˜éŒ²ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä¸€è¦§è¡¨

| æ“ä½œ                     | è¨˜éŒ²è²¬ä»»      | ãƒ¡ã‚½ãƒƒãƒ‰                    | ã‚¿ã‚¤ãƒŸãƒ³ã‚°        |
|--------------------------|---------------|----------------------------|-------------------|
| æç”»ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯çµ‚äº†       | core-engine   | stopDrawing()              | pointerupç›´å¾Œ     |
| ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¶ˆå»             | core-engine   | layer:clear-active         | æ¶ˆå»å®Ÿè¡Œç›´å¾Œ      |
| ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ»å¤‰å½¢ç¢ºå®š   | layer-system  | exitLayerMoveMode()        | Vã‚­ãƒ¼è§£é™¤æ™‚       |
| ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´         | layer-system  | reorderLayers()            | é †åºå¤‰æ›´æˆåŠŸå¾Œ    |
| ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤             | layer-system  | deleteLayer()              | å‰Šé™¤å®Ÿè¡Œç›´å¾Œ      |
| ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ             | layer-system  | createLayer()              | ä½œæˆç›´å¾Œ          |
| ã‚«ãƒƒãƒˆå‰Šé™¤               | history.js    | ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼           | ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ç›´å¾Œ  |
| ã‚«ãƒƒãƒˆè²¼ã‚Šä»˜ã‘           | history.js    | ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼           | ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ç›´å¾Œ  |


ã€3. å®Ÿè£…è©³ç´°ã€‘

â–  3-1. history.js ã®ä¿®æ­£

ä¿®æ­£ç®‡æ‰€1: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®setTimeoutå‰Šé™¤ï¼ˆ65-75è¡Œç›®ï¼‰

ã€å¤‰æ›´å‰ã€‘
```javascript
this.eventBus.on('animation:cut-deleted', () => {
    if (this.isExecutingUndoRedo || this.isRecordingState) return;
    setTimeout(() => this.saveStateFull(), 50);  // â†å‰Šé™¤
});
```

ã€å¤‰æ›´å¾Œã€‘
```javascript
this.eventBus.on('animation:cut-deleted', () => {
    if (this.isExecutingUndoRedo || this.isRecordingState) return;
    this.saveStateFull();  // â†å³åº§ã«å®Ÿè¡Œ
});
```


ä¿®æ­£ç®‡æ‰€2: saveState()ã®ã‚¬ãƒ¼ãƒ‰æ¡ä»¶ç·©å’Œï¼ˆ91-124è¡Œç›®ï¼‰

ã€å¤‰æ›´å‰ã€‘
```javascript
saveState() {
    if (this.isExecutingUndoRedo || this.isRecordingState) {
        return;  // â†isExecutingUndoRedoãƒã‚§ãƒƒã‚¯å‰Šé™¤
    }
    // ...
}
```

ã€å¤‰æ›´å¾Œã€‘
```javascript
saveState() {
    if (this.isRecordingState) {
        return;  // â†isRecordingStateã®ã¿ãƒã‚§ãƒƒã‚¯
    }
    // ...
}
```


â–  3-2. core-engine.js ã®ä¿®æ­£

ä¿®æ­£ç®‡æ‰€1: stopDrawing()ã®Historyè¨˜éŒ²ç¢ºå®ŸåŒ–ï¼ˆ143-169è¡Œç›®ï¼‰

ã€å¤‰æ›´å‰ã€‘
```javascript
if (window.History && typeof window.History.saveState === 'function') {
    if (!window.History._manager?.isExecutingUndoRedo && 
        !window.History._manager?.isRecordingState) {
        window.History.saveState();
    }
}
```

ã€å¤‰æ›´å¾Œã€‘
```javascript
if (window.History && typeof window.History.saveState === 'function') {
    window.History.saveState();  // â†ã‚¬ãƒ¼ãƒ‰æ¡ä»¶å‰Šé™¤ï¼ˆå¸¸ã«è¨˜éŒ²ï¼‰
}
```


ä¿®æ­£ç®‡æ‰€2: layer:clear-active ã®è¨˜éŒ²ç¢ºå®ŸåŒ–ï¼ˆ530-563è¡Œç›®ï¼‰

ã€å¤‰æ›´å‰ã€‘
```javascript
if (window.History && typeof window.History.saveState === 'function') {
    if (!window.History._manager?.isExecutingUndoRedo && 
        !window.History._manager?.isRecordingState) {
        window.History.saveState();
    }
}
```

ã€å¤‰æ›´å¾Œã€‘
```javascript
if (window.History && typeof window.History.saveState === 'function') {
    window.History.saveState();  // â†ã‚¬ãƒ¼ãƒ‰æ¡ä»¶å‰Šé™¤
}
```


â–  3-3. layer-system.js ã®ä¿®æ­£

ä¿®æ­£ç®‡æ‰€1: exitLayerMoveMode()ã«Historyè¨˜éŒ²è¿½åŠ ï¼ˆ944-968è¡Œç›®ï¼‰

ã€å¤‰æ›´å‰ã€‘
```javascript
exitLayerMoveMode() {
    // ...æ—¢å­˜å‡¦ç†...
    this.updateCursor();
    this.confirmLayerTransform();  // â†å¤‰å½¢ç¢ºå®š
    
    if (this.eventBus) {
        this.eventBus.emit('layer:move-mode-exited');
    }
}
```

ã€å¤‰æ›´å¾Œã€‘
```javascript
exitLayerMoveMode() {
    // ...æ—¢å­˜å‡¦ç†...
    this.updateCursor();
    this.confirmLayerTransform();  // â†å¤‰å½¢ç¢ºå®š
    
    // ğŸ”¥ å¤‰å½¢ç¢ºå®šå¾Œã«Historyè¨˜éŒ²
    if (window.History && typeof window.History.saveState === 'function') {
        window.History.saveState();
    }
    
    if (this.eventBus) {
        this.eventBus.emit('layer:move-mode-exited');
    }
}
```


ä¿®æ­£ç®‡æ‰€2: reorderLayers()ã«Historyè¨˜éŒ²è¿½åŠ ï¼ˆ140-183è¡Œç›®ï¼‰

ã€å¤‰æ›´å‰ã€‘
```javascript
reorderLayers(fromIndex, toIndex) {
    // ...ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´å‡¦ç†...
    
    if (this.eventBus) {
        this.eventBus.emit('layer:reordered', { /* ... */ });
    }
    
    console.log(`âœ… Layers reordered: ${fromIndex} â†’ ${toIndex}`);
    return true;
}
```

ã€å¤‰æ›´å¾Œã€‘
```javascript
reorderLayers(fromIndex, toIndex) {
    // ...ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´å‡¦ç†...
    
    // ğŸ”¥ é †åºå¤‰æ›´æˆåŠŸæ™‚ã«Historyè¨˜éŒ²
    if (window.History && typeof window.History.saveState === 'function') {
        window.History.saveState();
    }
    
    if (this.eventBus) {
        this.eventBus.emit('layer:reordered', { /* ... */ });
    }
    
    console.log(`âœ… Layers reordered: ${fromIndex} â†’ ${toIndex}`);
    return true;
}
```


ä¿®æ­£ç®‡æ‰€3: moveActiveLayerHierarchy()ã®Historyè¨˜éŒ²å‰Šé™¤ï¼ˆ690-720è¡Œç›®ï¼‰

ã€å¤‰æ›´å‰ã€‘
```javascript
if (newIndex !== currentIndex) {
    if (window.History && typeof window.History.saveState === 'function') {
        if (!window.History._manager?.isExecutingUndoRedo && 
            !window.History._manager?.isRecordingState) {
            window.History.saveState();  // â†å‰Šé™¤
        }
    }
    
    this.setActiveLayer(newIndex);
    // ...
}
```

ã€å¤‰æ›´å¾Œã€‘
```javascript
if (newIndex !== currentIndex) {
    // Historyè¨˜éŒ²å‰Šé™¤ï¼ˆreorderLayers()ã§è¨˜éŒ²ã•ã‚Œã‚‹ï¼‰
    
    this.setActiveLayer(newIndex);
    // ...
}
```


ã€4. ãƒ†ã‚¹ãƒˆè¨ˆç”»ã€‘

â–  4-1. åŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆ

ãƒ†ã‚¹ãƒˆ1: æç”»ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ²
1. ãƒšãƒ³ãƒ„ãƒ¼ãƒ«ã§1ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”»
2. History.getDebugInfo() ã§ undoStackSize ã‚’ç¢ºèª
3. æœŸå¾…å€¤: +1

ãƒ†ã‚¹ãƒˆ2: ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ»å¤‰å½¢è¨˜éŒ²
1. Vã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ¢ãƒ¼ãƒ‰
2. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç§»å‹•ãƒ»å›è»¢ãƒ»æ‹¡ç¸®
3. Vã‚­ãƒ¼ã‚’é›¢ã—ã¦ãƒ¢ãƒ¼ãƒ‰è§£é™¤
4. History.getDebugInfo() ã§ undoStackSize ã‚’ç¢ºèª
5. æœŸå¾…å€¤: +1

ãƒ†ã‚¹ãƒˆ3: ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´è¨˜éŒ²
1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
2. History.getDebugInfo() ã§ undoStackSize ã‚’ç¢ºèª
3. æœŸå¾…å€¤: +1

ãƒ†ã‚¹ãƒˆ4: ã‚«ãƒƒãƒˆå‰Šé™¤è¨˜éŒ²
1. ã‚«ãƒƒãƒˆã‚’å‰Šé™¤
2. History.getDebugInfo() ã§ undoStackSize ã‚’ç¢ºèª
3. æœŸå¾…å€¤: +1


â–  4-2. Undo/Redoæ•´åˆæ€§ãƒ†ã‚¹ãƒˆ

ãƒ†ã‚¹ãƒˆ5: æç”»â†’Undoâ†’Redo
1. 1ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”» â†’ Undo â†’ Redo
2. æœŸå¾…å€¤: æç”»ãŒå¾©å…ƒã•ã‚Œã‚‹

ãƒ†ã‚¹ãƒˆ6: ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•â†’Undoâ†’Redo
1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹• â†’ Undo â†’ Redo
2. æœŸå¾…å€¤: ç§»å‹•ãŒå¾©å…ƒã•ã‚Œã‚‹

ãƒ†ã‚¹ãƒˆ7: è¤‡æ•°æ“ä½œã®é€£ç¶šUndo
1. æç”»3ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ + ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•1å›
2. Undo 4å›
3. æœŸå¾…å€¤: å…¨ã¦å…ƒã«æˆ»ã‚‹


â–  4-3. æ€§èƒ½ãƒ†ã‚¹ãƒˆ

ãƒ†ã‚¹ãƒˆ8: é«˜é€Ÿæç”»æ™‚ã®è¨˜éŒ²æ¼ã‚Œãƒã‚§ãƒƒã‚¯
1. 10ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é«˜é€Ÿé€£ç¶šæç”»
2. History.getDebugInfo() ã§ undoStackSize ã‚’ç¢ºèª
3. æœŸå¾…å€¤: 10

ãƒ†ã‚¹ãƒˆ9: ã‚«ãƒƒãƒˆå‰Šé™¤ç›´å¾Œã®æ“ä½œ
1. ã‚«ãƒƒãƒˆå‰Šé™¤ â†’ å³åº§ã«æç”»
2. Undo 2å›
3. æœŸå¾…å€¤: æç”»ãƒ»ã‚«ãƒƒãƒˆå‰Šé™¤ã®é †ã«Undoã•ã‚Œã‚‹


ã€5. ãƒªã‚¹ã‚¯è©•ä¾¡ã€‘

â–  é«˜ãƒªã‚¹ã‚¯
- stopDrawing()ã®ã‚¬ãƒ¼ãƒ‰æ¡ä»¶å‰Šé™¤
  â†’ æç”»ä¸­ã®é‡è¤‡è¨˜éŒ²ã®å¯èƒ½æ€§ï¼ˆisRecordingStateã§é˜²æ­¢ï¼‰

â–  ä¸­ãƒªã‚¹ã‚¯
- setTimeoutã®å‰Šé™¤
  â†’ ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†é †åºã®å¤‰åŒ–ï¼ˆåŒæœŸåŒ–ã«ã‚ˆã‚Šæ”¹å–„ã•ã‚Œã‚‹è¦‹è¾¼ã¿ï¼‰

â–  ä½ãƒªã‚¹ã‚¯
- reorderLayers()ã¸ã®è¨˜éŒ²è¿½åŠ 
  â†’ æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ãªã—ï¼ˆæ–°è¦è¿½åŠ ï¼‰


ã€6. å®Ÿè£…å„ªå…ˆé †ä½ã€‘

å„ªå…ˆåº¦1: core-engine.js ã®ä¿®æ­£ï¼ˆæç”»è¨˜éŒ²ã®ç¢ºå®ŸåŒ–ï¼‰
å„ªå…ˆåº¦2: layer-system.js ã® exitLayerMoveMode() ä¿®æ­£
å„ªå…ˆåº¦3: history.js ã® setTimeout å‰Šé™¤
å„ªå…ˆåº¦4: layer-system.js ã® reorderLayers() ä¿®æ­£


ã€7. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»ã€‘

ä¿®æ­£ç®‡æ‰€ãŒæ˜ç¢ºãªãŸã‚ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿æŒã€‚
å•é¡Œç™ºç”Ÿæ™‚ã¯è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å…ƒã«æˆ»ã™ã€‚


ã€8. æ”¹ä¿®å¾Œã®æœŸå¾…åŠ¹æœã€‘

1. æç”»ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãŒ100%è¨˜éŒ²ã•ã‚Œã‚‹
2. ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ»å¤‰å½¢ãŒUndoã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
3. Historyã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºãŒå¸¸ã«æ­£ç¢º
4. å‡¦ç†é€Ÿåº¦ãŒå‘ä¸Šï¼ˆsetTimeoutå‰Šé™¤ã«ã‚ˆã‚‹ï¼‰


ã€9. è£œè¶³äº‹é …ã€‘

â–  æ—¢å­˜ã®ä¿è­·æ©Ÿæ§‹ï¼ˆç¶­æŒï¼‰
- isRecordingState: è¨˜éŒ²ä¸­ã®å†å¸°é˜²æ­¢ï¼ˆç¶­æŒï¼‰
- isExecutingUndoRedo: Undo/Redoå®Ÿè¡Œä¸­ã®è¨˜éŒ²é˜²æ­¢ï¼ˆéƒ¨åˆ†çš„ã«ç·©å’Œï¼‰

â–  ä»Šå¾Œã®æ‹¡å¼µæ€§
- å·®åˆ†ã‚³ãƒãƒ³ãƒ‰æ–¹å¼ã¸ã®ç§»è¡Œã‚’è¦‹æ®ãˆãŸè¨­è¨ˆ
- ãƒ‘ã‚¹å˜ä½ã®è¨˜éŒ²ã¸ã®ç§»è¡Œæº–å‚™

================================================================================
ä»¥ä¸Š
================================================================================