ğŸ“‹ Undo/Redo ã‚·ã‚¹ãƒ†ãƒ æ®µéšçš„æ”¹ä¿®è¨ˆç”»æ›¸
ğŸ¯ æ”¹ä¿®æ–¹é‡

æ—¢å­˜æ©Ÿèƒ½ã‚’ä¸€åˆ‡ç ´å£Šã—ãªã„
ãƒ•ã‚¡ã‚¤ãƒ«ã¯1ã¤ãšã¤å®Œå…¨ç‰ˆã§æå‡º
å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ + æœ€å°é™ã®æ”¹ä¿®ã®ã¿
æ®µéšçš„ã«çµ±åˆãƒ†ã‚¹ãƒˆå¯èƒ½ãªé †åº


ğŸ“Š æ”¹ä¿®å„ªå…ˆé †ä½ã¨ä¾å­˜é–¢ä¿‚
Phase 1: ã‚³ã‚¢å±¥æ­´ã‚·ã‚¹ãƒ†ãƒ 
  â””â”€ system/history.js (å®Œå…¨æ›¸ãæ›ãˆ)

Phase 2: ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹å¼·åŒ–
  â””â”€ system/event-bus.js (å„ªå…ˆåº¦æ©Ÿèƒ½è¿½åŠ )

Phase 3: çŠ¶æ…‹ç®¡ç†çµ±åˆ
  â””â”€ system/state-manager.js (commit APIè¿½åŠ )

Phase 4: ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
  â””â”€ system/layer-system.js (æ—¢å­˜ã® History.push å‘¼ã³å‡ºã—ã‚’æ–°APIå¯¾å¿œ)

Phase 5: æç”»ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
  â””â”€ core-engine.js (æç”»å®Œäº†æ™‚ã®å±¥æ­´è¨˜éŒ²ã‚’æ–°APIå¯¾å¿œ)

Phase 6: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰çµ±åˆ
  â””â”€ system/drawing-clipboard.js (ãƒšãƒ¼ã‚¹ãƒˆæ“ä½œã®å±¥æ­´è¨˜éŒ²ã‚’æ–°APIå¯¾å¿œ)

ğŸ“ å„Phaseè©³ç´°
Phase 1: system/history.jsï¼ˆå®Œå…¨æ›¸ãæ›ãˆï¼‰
ç¾çŠ¶ã®å•é¡Œ:

currentIndex ã®å®šç¾©ãŒæ›–æ˜§ï¼ˆæœ€å¾Œã«é©ç”¨æ¸ˆã¿ã‹ã€æ¬¡ã«é©ç”¨ã™ã‚‹ã‹ä¸æ˜ç¢ºï¼‰
saveState() ãŒçŠ¶æ…‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼ã§å·¨å¤§åŒ–
undo/redo å®Ÿè¡Œä¸­ã®å†å…¥é˜²æ­¢ãŒä¸å®Œå…¨

æ”¹ä¿®å†…å®¹:

ã‚³ãƒãƒ³ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³æ–¹å¼ã«å®Œå…¨ç§»è¡Œ
index = æœ€å¾Œã«é©ç”¨æ¸ˆã¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆåˆæœŸå€¤ -1ï¼‰ ã«çµ±ä¸€
push(entry) â†’ entry.do() å®Ÿè¡Œ â†’ é…åˆ—è¿½åŠ  â†’ index++
isApplying ãƒ•ãƒ©ã‚°ã§å†å…¥é˜²æ­¢
CompositeEntry ã‚µãƒãƒ¼ãƒˆ

äº’æ›æ€§:

å¤ã„ saveState() API ã¯å‰Šé™¤
æ–°ã—ã„ push() API ã®ã¿æä¾›

ãƒ†ã‚¹ãƒˆé …ç›®:

 push â†’ undo â†’ redo ã®å¾ªç’°
 CompositeEntry ã®å‹•ä½œ
 ä¾‹å¤–ç™ºç”Ÿæ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯


Phase 2: system/event-bus.jsï¼ˆå„ªå…ˆåº¦æ©Ÿèƒ½è¿½åŠ ï¼‰
ç¾çŠ¶ã®å•é¡Œ:

ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«é †åºãŒä¸å®š
undo/redo å®Ÿè¡Œä¸­ã®è­˜åˆ¥ãŒå›°é›£

æ”¹ä¿®å†…å®¹:

ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²æ™‚ã« priority ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 
å„ªå…ˆåº¦é †ï¼ˆé™é †ï¼‰ã§ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
emit() ã« internal ãƒ•ãƒ©ã‚°ã‚µãƒãƒ¼ãƒˆï¼ˆæ—¢å­˜ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«è¿½åŠ ï¼‰

äº’æ›æ€§:

æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ä¸è¦ï¼ˆpriority çœç•¥æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ0ï¼‰
æ—¢å­˜ã® on(), off(), emit() ã®å¼•æ•°ã¯ãã®ã¾ã¾

ãƒ†ã‚¹ãƒˆé …ç›®:

 å„ªå…ˆåº¦é †ã®å®Ÿè¡Œç¢ºèª
 æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒæ­£å¸¸å‹•ä½œ


Phase 3: system/state-manager.jsï¼ˆcommit APIè¿½åŠ ï¼‰
ç¾çŠ¶ã®å•é¡Œ:

çŠ¶æ…‹å¤‰æ›´ãŒç›´æ¥è¡Œã‚ã‚Œã€å±¥æ­´ã«è¨˜éŒ²ã•ã‚Œãªã„ç®‡æ‰€ãŒã‚ã‚‹

æ”¹ä¿®å†…å®¹:

commit(action) API ã‚’è¿½åŠ ï¼ˆaction = { name, do, undo, meta }ï¼‰
æ—¢å­˜ã®çŠ¶æ…‹å–å¾—é–¢æ•°ï¼ˆgetState() ç­‰ï¼‰ã¯ãã®ã¾ã¾ç¶­æŒ
è»½é‡ãªçŠ¶æ…‹å¤‰æ›´ï¼ˆãƒ„ãƒ¼ãƒ«é¸æŠç­‰ï¼‰ã¯å±¥æ­´åŒ–ã—ãªã„è¨­è¨ˆã‚’ç¶­æŒ

äº’æ›æ€§:

æ—¢å­˜ã®çŠ¶æ…‹èª­ã¿å–ã‚Šã‚³ãƒ¼ãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ä¸è¦
æ–°è¦ã« commit() ã‚’ä½¿ã†ç®‡æ‰€ã®ã¿è¿½åŠ 

ãƒ†ã‚¹ãƒˆé …ç›®:

 commit() çµŒç”±ã§ History ã«è¨˜éŒ²ã•ã‚Œã‚‹ã‹
 æ—¢å­˜ã® getState() ãŒæ­£å¸¸å‹•ä½œ


Phase 4: system/layer-system.jsï¼ˆæœ€å°é™æ”¹ä¿®ï¼‰
ç¾çŠ¶:

æ—¢ã«ä¸€éƒ¨ã§ History.push() ã‚’ä½¿ç”¨ï¼ˆreorderLayers, createLayer, deleteLayer, exitLayerMoveModeï¼‰
ã—ã‹ã— window.History._manager.isApplying ã¨ã„ã†å¤ã„APIã‚’å‚ç…§

æ”¹ä¿®å†…å®¹:

window.History._manager.isApplying â†’ History.isApplying() ã«çµ±ä¸€
entry ã®æ§‹é€ ã‚’æ–°APIä»•æ§˜ã«é©åˆï¼ˆname, do, undo, metaï¼‰
ãã®ä»–ã®æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ã—ãªã„

æ”¹ä¿®ç®‡æ‰€ï¼ˆ4ç®‡æ‰€ã®ã¿ï¼‰:

reorderLayers() - æ—¢å­˜ã® History.push å‘¼ã³å‡ºã—ã‚’æ–°APIå¯¾å¿œ
createLayer() - åŒä¸Š
deleteLayer() - åŒä¸Š
exitLayerMoveMode() - åŒä¸Š

äº’æ›æ€§:

ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ã—ãªã„
UIæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ã€ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã€åº§æ¨™å¤‰æ›ç­‰ã¯å…¨ã¦ç¶­æŒ

ãƒ†ã‚¹ãƒˆé …ç›®:

 ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹• â†’ undo â†’ redo
 ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ/å‰Šé™¤ â†’ undo â†’ redo
 ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢ç¢ºå®š â†’ undo â†’ redo


Phase 5: core-engine.jsï¼ˆæç”»å®Œäº†æ™‚ã®å±¥æ­´è¨˜éŒ²æ”¹ä¿®ï¼‰
ç¾çŠ¶ã®å•é¡Œ:

stopDrawing() ã§ window.History.saveState() ã‚’å‘¼ã‚“ã§ã„ã‚‹
layer:clear-active ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã§ã‚‚åŒæ§˜

æ”¹ä¿®å†…å®¹:

stopDrawing() å†…ã®æç”»å®Œäº†æ™‚ã«æ–°ã—ã„ History.push() ã‚’ä½¿ç”¨
layer:clear-active ãƒãƒ³ãƒ‰ãƒ©å†…ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒªã‚¢ã‚’å±¥æ­´åŒ–

æ”¹ä¿®ç®‡æ‰€ï¼ˆ2ç®‡æ‰€ã®ã¿ï¼‰:

DrawingEngine.stopDrawing() - å±¥æ­´è¨˜éŒ²ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ–°APIå¯¾å¿œ
CoreEngine.setupSystemEventIntegration() ã® layer:clear-active ãƒãƒ³ãƒ‰ãƒ©

å…·ä½“çš„å®Ÿè£…:
javascript// stopDrawing() å†…
if (this.currentPath) {
    this.currentPath.isComplete = true;
    
    const layerIndex = this.layerManager.activeLayerIndex;
    const pathSnapshot = structuredClone(this.currentPath);
    
    History.push({
        name: 'draw-stroke',
        do: () => {
            // æ—¢ã«è¿½åŠ æ¸ˆã¿ãªã®ã§ä½•ã‚‚ã—ãªã„
        },
        undo: () => {
            const activeLayer = this.layerManager.getActiveLayer();
            if (activeLayer) {
                const pathIndex = activeLayer.layerData.paths.findIndex(p => p.id === pathSnapshot.id);
                if (pathIndex !== -1) {
                    const path = activeLayer.layerData.paths[pathIndex];
                    activeLayer.removeChild(path.graphics);
                    if (path.graphics?.destroy) path.graphics.destroy();
                    activeLayer.layerData.paths.splice(pathIndex, 1);
                }
            }
            this.layerManager.requestThumbnailUpdate(layerIndex);
        },
        meta: { type: 'stroke', pathId: pathSnapshot.id }
    });
}
äº’æ›æ€§:

ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ã—ãªã„
DrawingEngine ã®ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰ã€UnifiedKeyHandlerã€CoreEngine ã®åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ç­‰ã¯å…¨ã¦ç¶­æŒ

ãƒ†ã‚¹ãƒˆé …ç›®:

 1ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”» â†’ undo â†’ redo
 ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒªã‚¢ â†’ undo â†’ redo


Phase 6: system/drawing-clipboard.jsï¼ˆãƒšãƒ¼ã‚¹ãƒˆå±¥æ­´æ”¹ä¿®ï¼‰
ç¾çŠ¶:

recordHistory() ãƒ¡ã‚½ãƒƒãƒ‰ã§ç‹¬è‡ªã®å±¥æ­´ç®¡ç†
window.History.push() ã‚’å‘¼ã‚“ã§ã„ã‚‹ãŒã€å¤ã„APIå½¢å¼

æ”¹ä¿®å†…å®¹:

recordHistory() ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚¨ãƒ³ãƒˆãƒªæ§‹é€ ã‚’æ–°APIå¯¾å¿œ
ãã®ä»–ã®ã‚³ãƒ¼ãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ã—ãªã„

æ”¹ä¿®ç®‡æ‰€ï¼ˆ1ç®‡æ‰€ã®ã¿ï¼‰:

recordHistory() ãƒ¡ã‚½ãƒƒãƒ‰

äº’æ›æ€§:

ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ã—ãªã„
ã‚³ãƒ”ãƒ¼/ãƒšãƒ¼ã‚¹ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆç­‰ã¯å…¨ã¦ç¶­æŒ

ãƒ†ã‚¹ãƒˆé …ç›®:

 ãƒšãƒ¼ã‚¹ãƒˆ â†’ undo â†’ redo
 ä¸Šæ›¸ããƒšãƒ¼ã‚¹ãƒˆ â†’ undo â†’ redo


ğŸ”„ çµ±åˆãƒ†ã‚¹ãƒˆè¨ˆç”»
å„Phaseã”ã¨ã«ä»¥ä¸‹ã‚’ãƒ†ã‚¹ãƒˆ:

Phase 1å®Œäº†å¾Œ:

Historyå˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆHistoryTest() å®Ÿè¡Œï¼‰


Phase 2å®Œäº†å¾Œ:

EventBus ã®æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆå‹•ä½œç¢ºèª


Phase 3å®Œäº†å¾Œ:

StateManager ã® commit() å‹•ä½œç¢ºèª


Phase 4å®Œäº†å¾Œ:

ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œã® undo/redo ç¢ºèª


Phase 5å®Œäº†å¾Œ:

æç”» â†’ undo/redo ç¢ºèª


Phase 6å®Œäº†å¾Œ:

ãƒšãƒ¼ã‚¹ãƒˆ â†’ undo/redo ç¢ºèª
å…¨æ©Ÿèƒ½çµ±åˆãƒ†ã‚¹ãƒˆ




ğŸ“¦ æå‡ºå½¢å¼
å„Phaseã”ã¨ã«:

å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’æç¤º
æ”¹ä¿®ç®‡æ‰€ã®ã¿ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æ˜ç¤º
å‹•ä½œç¢ºèªæ–¹æ³•ã‚’è¨˜è¼‰

