==========================================================
Tegaki v8 æ˜Ÿå‹åˆ†é›¢ æ”¹ä¿®è¨ˆç”»æ›¸ï¼ˆrev1bãƒ™ãƒ¼ã‚¹ï¼‰
==========================================================

1. æ”¹ä¿®å¯¾è±¡ã¨ç¯„å›²
----------------------------------------------------------
- drawing-engine.js
  - ãƒšãƒ³ãƒ»æ¶ˆã—ã‚´ãƒ æç”»ãƒ•ãƒ­ãƒ¼ã®æ˜ç¢ºåŒ–
  - drawTemporaryStroke / commitStroke ã®åˆ†é›¢
  - Worldåº§æ¨™å¤‰æ›å¯¾å¿œ
- tool-manager.js
  - activeTool ç®¡ç†
  - start/move/end/cancelã®ãƒ•ãƒ­ãƒ¼æ•´å‚™
- layer-manager.js
  - éç ´å£Šãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ï¼ˆTransformToolï¼‰
  - reorderLayer / addLayer / removeLayer
  - å±¥æ­´ç”¨ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆWorldåº§æ¨™ãƒ™ãƒ¼ã‚¹ï¼‰
- position-manager.js
  - canvas<->worldåº§æ¨™å¤‰æ›
  - zoom / pan ç®¡ç†
- ui-manager.js
  - ç¾çŠ¶UIç¶­æŒã€ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆæ“ä½œã®ã¿å¯¾å¿œ
- error-service.js
  - åˆæœŸåŒ–ä¿®æ­£ï¼ˆwindow.ErrorService = ErrorServiceæ§‹æ–‡ç¢ºèªï¼‰
  - MainControllerã‹ã‚‰ã®é€šçŸ¥å—ä»˜

2. æ”¹ä¿®æ–¹é‡
----------------------------------------------------------
- æ”¹ä¿®ã¯å¯èƒ½ãªé™ã‚Šã€Œä¸»æ˜Ÿï¼‹å˜ä¸€è¡›æ˜Ÿã€ã§å®Œçµ
- Toolæ¯ã®æç”»ãƒ•ãƒ­ãƒ¼ã¯DrawingEngineã«ã¾ã¨ã‚ã€å¿…è¦ã«å¿œã˜ã¦è¡›æ˜Ÿåˆ†é›¢å¯èƒ½
- ãƒšãƒ³ï¼æ¶ˆã—ã‚´ãƒ ã®å‡¦ç†ã¯å†…éƒ¨ã§æ˜ç¢ºã«åˆ†é›¢
  - æ¶ˆã—ã‚´ãƒ ã¯BLEND_MODE_ERASEã‚’ç”¨ã„ã€Worldåº§æ¨™ã§æç”»
- éç ´å£Šãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ã¯LayerManagerã¨PositionManagerã®é€£æºã§è¡Œã„ã€HistoryServiceã«å·®åˆ†ã‚’è¨˜éŒ²
- Canvas2Dæ’é™¤ã€å…¨ã¦PixiJS Graphicsã§æç”»
- UIã¯å¤‰æ›´ã›ãšã€ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§æ“ä½œ

3. å„è¡›æ˜Ÿã®è²¬å‹™ã¨æ”¹ä¿®ãƒã‚¤ãƒ³ãƒˆ
----------------------------------------------------------
(1) DrawingEngine
  - commitStroke / drawTemporaryStroke ã®åˆ†é›¢
  - Worldåº§æ¨™å¤‰æ›å¯¾å¿œ
  - ãƒšãƒ³ï¼æ¶ˆã—ã‚´ãƒ æç”»ãƒ­ã‚¸ãƒƒã‚¯æ•´ç†
  - å°†æ¥çš„ã«ãƒšãƒ³ã¨æ¶ˆã—ã‚´ãƒ ã‚’ç‹¬ç«‹Toolè¡›æ˜ŸåŒ–å¯èƒ½ãªæ§‹é€ ã«ã™ã‚‹

(2) ToolManager
  - activeToolç®¡ç†ã€start/move/end/cancelã®ãƒ•ãƒ­ãƒ¼ã‚’æ•´ç†
  - DrawingEngineã¨ã®é€šä¿¡ã¯MainControllerçµŒç”±
  - å°†æ¥çš„ã«Toolè¿½åŠ ã‚„å‰Šé™¤ãŒå®¹æ˜“ã«

(3) LayerManager
  - éç ´å£Šç§»å‹•(transform)ã¨å†æç”»ãƒ•ãƒ­ãƒ¼
  - reorderLayer/addLayer/removeLayerã®å±¥æ­´ç”Ÿæˆï¼ˆWorldåº§æ¨™ï¼‰
  - æç”»ç¢ºå®šæ™‚ã«ã¯MainControllerçµŒç”±ã§HistoryServiceã«record

(4) PositionManager
  - canvas<->worldå¤‰æ›
  - zoom/panã®ç®¡ç†
  - æç”»/ç§»å‹•æ™‚ã®åº§æ¨™è£œæ­£

(5) UIManager
  - ç¾çŠ¶ç¶­æŒ
  - ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆæ“ä½œå¯¾å¿œï¼ˆP: Pen / E: Eraser / CTRL+Z: Undo / CTRL+Y: Redoï¼‰
  - å°†æ¥çš„ã«ç‹¬ç«‹è¡›æ˜Ÿã¨ã—ã¦åˆ†é›¢å¯èƒ½ãªæ§‹é€ 

(6) ErrorService
  - window.ErrorService = ErrorService ã®åˆæœŸåŒ–ç¢ºèª
  - MainControllerçµŒç”±ã§å…¨è¡›æ˜Ÿã®ã‚¨ãƒ©ãƒ¼å—ä¿¡

4. æ”¹ä¿®ãƒ•ãƒ­ãƒ¼ä¾‹ï¼šãƒšãƒ³æç”»ç¢ºå®š
----------------------------------------------------------
1) ToolManager.start(point)
2) DrawingEngine.drawTemporaryStroke(layerId, points)
3) LayerManager/PositionManagerã«Worldåº§æ¨™ã§è£œæ­£
4) ToolManager.end(point)
5) DrawingEngine.commitStroke(layerId, strokeData)
6) MainController.notify({type:'history.record', payload:{action}})
7) HistoryService.record(action)

5. æ”¹ä¿®ãƒ•ãƒ­ãƒ¼ä¾‹ï¼šæ¶ˆã—ã‚´ãƒ æç”»ç¢ºå®š
----------------------------------------------------------
1) ToolManager.start(point)
2) DrawingEngine.drawTemporaryStroke(layerId, points, eraseMode=true)
3) LayerManager/PositionManagerã«Worldåº§æ¨™ã§è£œæ­£
4) ToolManager.end(point)
5) DrawingEngine.commitStroke(layerId, eraseStrokeData)
6) MainController.notify({type:'history.record', payload:{action}})
7) HistoryService.record(action)

6. æ”¹ä¿®ã®æ³¨æ„ç‚¹
----------------------------------------------------------
- è¡›æ˜Ÿé–“ä¾å­˜ã¯æœ€å°åŒ–
- æç”»ãƒ•ãƒ­ãƒ¼ã®Worldåº§æ¨™ç®¡ç†ã‚’å¾¹åº•
- å±¥æ­´ã¯éç ´å£Šãƒ™ãƒ¼ã‚¹ã§ä¿å­˜
- Canvas2Dã¯æ’é™¤ã€PixiJS Graphicsã§çµ±ä¸€
- UIã¯å¤‰æ›´ã›ãšã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®ã¿å¯¾å¿œ
- å°†æ¥çš„ã«Toolè¡›æ˜Ÿã‚’åˆ†é›¢å¯èƒ½ãªæ§‹é€ ã‚’ä¿æŒ

7. æ”¹ä¿®å¾Œã®æˆæœç‰©
----------------------------------------------------------
- drawing-engine.jsï¼šãƒšãƒ³ãƒ»æ¶ˆã—ã‚´ãƒ ãƒ•ãƒ­ãƒ¼æ˜ç¢ºåŒ–ã€Worldåº§æ¨™å¯¾å¿œ
- tool-manager.jsï¼šactiveToolãƒ•ãƒ­ãƒ¼æ•´ç†ã€MainControllerçµŒç”±
- layer-manager.jsï¼šéç ´å£Šç§»å‹•ãƒ»å±¥æ­´ç®¡ç†
- position-manager.jsï¼šcanvas<->worldåº§æ¨™å¤‰æ›ã€ã‚ºãƒ¼ãƒ ï¼ãƒ‘ãƒ³å¯¾å¿œ
- ui-manager.jsï¼šã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå¯¾å¿œã®ã¿
- error-service.jsï¼šåˆæœŸåŒ–ä¿®æ­£

==========================================================


â€»ä»¥ä¸‹ã¯ã€Tegaki v8 æ˜Ÿå‹åˆ†é›¢ rev1b ãƒ™ãƒ¼ã‚¹ã®æ”¹ä¿®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚


<!-- main.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Tegaki v8 - StarPlan Sample</title>
<script src="https://cdn.jsdelivr.net/npm/pixi.js@8.0.5/dist/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
</head>
<body>
<div id="canvas-container"></div>

<script src="drawing-engine.js"></script>
<script src="layer-manager.js"></script>
<script src="position-manager.js"></script>
<script src="tool-manager.js"></script>
<script src="ui-manager.js"></script>
<script src="error-service.js"></script>

<script>
const mainController = new MainController({
  container: document.getElementById('canvas-container')
});
mainController.initialize();
</script>
</body>
</html>

// drawing-engine.js
class DrawingEngine {
  constructor(app, layerManager, positionManager) {
    this.app = app;
    this.layerManager = layerManager;
    this.positionManager = positionManager;
  }

  // ä¸€æ™‚æç”»ï¼ˆãƒšãƒ³/æ¶ˆã—ã‚´ãƒ ï¼‰
  drawTemporaryStroke(layerId, points, eraseMode=false) {
    const layer = this.layerManager.getLayerById(layerId);
    const g = layer.graphics;
    const pts = points.map(p => this.positionManager.worldToCanvas(p));
    g.lineStyle(eraseMode ? 20 : 2, 0x000000, eraseMode ? 0 : 1, false, eraseMode ? PIXI.BLEND_MODES.ERASE : PIXI.BLEND_MODES.NORMAL);
    g.moveTo(pts[0].x, pts[0].y);
    pts.slice(1).forEach(pt => g.lineTo(pt.x, pt.y));
  }

  // ç¢ºå®šæç”»
  commitStroke(layerId, strokeData) {
    const layer = this.layerManager.getLayerById(layerId);
    layer.commitStroke(strokeData);
  }
}
window.DrawingEngine = DrawingEngine;

// tool-manager.js
class ToolManager {
  constructor(drawingEngine, mainController) {
    this.drawingEngine = drawingEngine;
    this.mainController = mainController;
    this.activeTool = 'pen';
    this.strokePoints = [];
  }

  setActiveTool(tool) {
    this.activeTool = tool;
  }

  start(point) {
    this.strokePoints = [point];
  }

  move(point) {
    this.strokePoints.push(point);
    this.drawingEngine.drawTemporaryStroke(
      this.mainController.getActiveLayerId(),
      this.strokePoints,
      this.activeTool === 'eraser'
    );
  }

  end(point) {
    this.strokePoints.push(point);
    this.drawingEngine.commitStroke(
      this.mainController.getActiveLayerId(),
      { points: this.strokePoints.slice(), erase: this.activeTool==='eraser' }
    );
    this.mainController.notify({
      type: 'history.record',
      payload: { action: { type: 'stroke', layerId: this.mainController.getActiveLayerId(), points: this.strokePoints.slice(), erase: this.activeTool==='eraser' } }
    });
    this.strokePoints = [];
  }
}
window.ToolManager = ToolManager;

// ui-manager.js
class UIManager {
  constructor(toolManager) {
    this.toolManager = toolManager;
    this.initShortcuts();
  }

  initShortcuts() {
    window.addEventListener('keydown', e => {
      if (e.ctrlKey && e.key === 'z') {
        this.toolManager.mainController.history.undo();
        e.preventDefault();
      } else if (e.ctrlKey && e.key === 'y') {
        this.toolManager.mainController.history.redo();
        e.preventDefault();
      } else if (e.key.toLowerCase() === 'p') {
        this.toolManager.setActiveTool('pen');
      } else if (e.key.toLowerCase() === 'e') {
        this.toolManager.setActiveTool('eraser');
      }
    });
  }
}
window.UIManager = UIManager;

// position-manager.js
class PositionManager {
  constructor() {
    this.offset = { x:0, y:0 };
    this.scale = 1;
  }
  worldToCanvas(p) {
    return { x: p.x*this.scale+this.offset.x, y: p.y*this.scale+this.offset.y };
  }
  canvasToWorld(p) {
    return { x: (p.x-this.offset.x)/this.scale, y: (p.y-this.offset.y)/this.scale };
  }
  setOffset(x,y){ this.offset={x,y}; }
  setScale(s){ this.scale=s; }
}
window.PositionManager = PositionManager;

// layer-manager.js
class LayerManager {
  constructor(app) {
    this.app = app;
    this.layers = [];
  }
  addLayer(id) {
    const g = new PIXI.Graphics();
    this.app.stage.addChild(g);
    this.layers.push({ id, graphics: g });
  }
  getLayerById(id) {
    return this.layers.find(l => l.id===id);
  }
  commitStroke({ points, erase }) {
    // ç¢ºå®šæç”»ã®å‡¦ç†ã€ã“ã“ã§ã¯Graphicsã«ãã®ã¾ã¾æ®‹ã™
  }
}
window.LayerManager = LayerManager;

// error-service.js
class ErrorService {
  report(error) {
    console.error('[ErrorService]', error);
  }
}
window.ErrorService = ErrorService;

ğŸ’¡ ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã®ãƒã‚¤ãƒ³ãƒˆï¼š

ãƒšãƒ³ï¼æ¶ˆã—ã‚´ãƒ æç”»ãƒ•ãƒ­ãƒ¼ã‚’DrawingEngineå†…ã§çµ±ä¸€

Worldåº§æ¨™ã«åŸºã¥ã„ãŸæç”»

UIã¯ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®ã¿

å°†æ¥çš„ã«Toolã”ã¨ã«è¡›æ˜ŸåŒ–ã—ã‚„ã™ã„æ§‹é€ 

Canvas2Dã¯æ’é™¤ã€PixiJS Graphicsã®ã¿
