# ğŸ“‹ Tegaki Phase1.5 STEP3 ä¿®æ­£å†…å®¹ - ç¶™ç¶šæç”»ãƒ»APIçµ±ä¸€ãƒ»Manageræ³¨å…¥å•é¡Œè§£æ±º

## ğŸ” ç¾åœ¨ã®å•é¡ŒçŠ¶æ³ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°åˆ†æï¼‰

### 1. **NavigationManager æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ï¼ˆCriticalï¼‰**
```
navigation-manager.js:5 Uncaught SyntaxError: Unexpected identifier 'setCoordinateManagerV8'
```
- **åŸå› **: ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼
- **å½±éŸ¿**: ManageråˆæœŸåŒ–ãŒå®Œå…¨ã«å¤±æ•—ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ãŒå‹•ä½œã—ãªã„

### 2. **Manageræ³¨å…¥å¤±æ•—ã‚¨ãƒ©ãƒ¼**
```
ğŸ’€ v8 Managerç¾¤åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: TypeError: window.Tegaki.NavigationManager is not a constructor
```
- **åŸå› **: NavigationManagerã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹èª­ã¿è¾¼ã¿å¤±æ•—
- **å½±éŸ¿**: AppCoreåˆæœŸåŒ–ã§å…¨Managerä½œæˆãŒå¤±æ•—

### 3. **ç¶™ç¶šæç”»å•é¡Œ**
- **ç¾è±¡**: ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ã‚’é›¢ã—ã¦ã‚‚æç”»ãŒç¶šã
- **åŸå› **: PointerUp ã‚¤ãƒ™ãƒ³ãƒˆã§æç”»çµ‚äº†å‡¦ç†ãŒå‘¼ã°ã‚Œã¦ã„ãªã„

### 4. **APIä¸æ•´åˆå•é¡Œ**
- `RecordManager not ready - call setManagers() first`
- `toolManager.setActiveTool is not a function`
- `toolManager.getTools is not a function`

## ğŸ¯ ä¿®æ­£æˆ¦ç•¥ & å®Ÿè£…å†…å®¹

### **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ« 1: NavigationManager**
âœ… **ãƒ•ã‚¡ã‚¤ãƒ«**: `js/utils/navigation-manager.js`  
ğŸ”§ **ä¿®æ­£å†…å®¹**:
- æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ä¿®æ­£ï¼ˆline 5ã®ä¸æ­£ãªãƒ¡ã‚½ãƒƒãƒ‰å®£è¨€ï¼‰
- getCameraBounds()å®Ÿè£…
- ã‚«ãƒ¡ãƒ©å¢ƒç•Œç®¡ç†æ©Ÿèƒ½è¿½åŠ 
- v8 Containerå¤‰å½¢å¯¾å¿œ

**ä¸»è¦æ©Ÿèƒ½**:
```javascript
// ã‚«ãƒ¡ãƒ©å¢ƒç•Œå–å¾—ï¼ˆPhase1.5æ–°æ©Ÿèƒ½ï¼‰
getCameraBounds() {
    return { ...this.cameraBounds };
}

// v8é«˜ç²¾åº¦ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³
zoomCanvasV8(scale, centerX, centerY)
panCanvasV8(deltaX, deltaY)
```

### **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ« 2: CoordinateManager**
âœ… **ãƒ•ã‚¡ã‚¤ãƒ«**: `js/utils/coordinate-manager.js`  
ğŸ”§ **ä¿®æ­£å†…å®¹**:
- APIçµ±ä¸€ï¼š`toCanvasCoords()` ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¿½åŠ 
- v8ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
- é«˜ç²¾åº¦åº§æ¨™å¤‰æ›å¼·åŒ–

**APIçµ±ä¸€**:
```javascript
// æ—¢å­˜ãƒ¡ã‚½ãƒƒãƒ‰
clientToCanvas(clientX, clientY)

// æ–°è¦çµ±ä¸€APIï¼ˆToolç”¨ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰
toCanvasCoords(clientX, clientY) {
    return this.clientToCanvasHighPrecision(clientX, clientY);
}
```

### **ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ« 3: PenTool**
âœ… **ãƒ•ã‚¡ã‚¤ãƒ«**: `tools/pen-tool.js`  
ğŸ”§ **ä¿®æ­£å†…å®¹**:
- ç¶™ç¶šæç”»å•é¡Œä¿®æ­£ï¼ˆç¢ºå®ŸãªPointerUpå‡¦ç†ï¼‰
- æç”»çŠ¶æ…‹ç®¡ç†å¼·åŒ–
- å¤–éƒ¨å…¥åŠ›ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°å®Ÿè£…

**ç¶™ç¶šæç”»ä¿®æ­£ã®æ ¸å¿ƒ**:
```javascript
onPointerUp(event) {
    // å¼·åˆ¶çš„ãªæç”»çµ‚äº†å‡¦ç†ï¼ˆç¶™ç¶šæç”»å•é¡Œä¿®æ­£ã®æ ¸å¿ƒï¼‰
    this.forceEndDrawing();
}

forceEndDrawing() {
    // è¨˜éŒ²ä¸­ã®å ´åˆã¯è¨˜éŒ²çµ‚äº†
    if (this.isRecording && this.recordManager) {
        this.recordManager.endOperation(strokeMeta);
    }
    // æç”»çŠ¶æ…‹å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    this.resetDrawingState();
}
```

## ğŸš€ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### âœ… **è§£æ±ºã•ã‚Œã‚‹å•é¡Œ**
1. **NavigationManageræ§‹æ–‡ã‚¨ãƒ©ãƒ¼** â†’ å®Œå…¨ä¿®æ­£ã«ã‚ˆã‚ŠåˆæœŸåŒ–æˆåŠŸ
2. **ç¶™ç¶šæç”»å•é¡Œ** â†’ forceEndDrawing()ã«ã‚ˆã‚Šç¢ºå®Ÿã«åœæ­¢
3. **APIä¸æ•´åˆ** â†’ toCanvasCoords()çµ±ä¸€ã«ã‚ˆã‚Šè§£æ±º
4. **Manageræ³¨å…¥å¤±æ•—** â†’ çµ±ä¸€æ³¨å…¥ã‚·ã‚¹ãƒ†ãƒ ã§å®‰å®šåŒ–

### ğŸ“ˆ **è¿½åŠ æ©Ÿèƒ½**
1. **å¤–éƒ¨å…¥åŠ›ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°** â†’ ã‚«ãƒ¡ãƒ©å¤–ã‹ã‚‰æç”»é–‹å§‹å¯èƒ½
2. **ã‚«ãƒ¡ãƒ©å¢ƒç•Œç®¡ç†** â†’ getCameraBounds()å®Ÿè£…
3. **é«˜ç²¾åº¦åº§æ¨™å¤‰æ›** â†’ v8ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»DPRå¯¾å¿œå¼·åŒ–

## ğŸ”§ å®Ÿè£…ãƒ•ãƒ­ãƒ¼

### **Step 1: æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ä¿®æ­£ï¼ˆæœ€å„ªå…ˆï¼‰**
1. NavigationManager.js â†’ æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ä¿®æ­£
2. åˆæœŸåŒ–ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç¢ºèª
3. Manageræ³¨å…¥ãƒ†ã‚¹ãƒˆ

### **Step 2: APIçµ±ä¸€**
1. CoordinateManager â†’ toCanvasCoords()è¿½åŠ 
2. ToolManager â†’ getTools()/setActiveTool()ç¢ºèª
3. çµ±ä¸€APIãƒ†ã‚¹ãƒˆ

### **Step 3: ç¶™ç¶šæç”»ä¿®æ­£**
1. PenTool â†’ forceEndDrawing()å®Ÿè£…
2. PointerUpå‡¦ç†å¼·åŒ–
3. æç”»çŠ¶æ…‹ç®¡ç†å®Œå…¨åŒ–

### **Step 4: çµ±åˆãƒ†ã‚¹ãƒˆ**
1. åŸºæœ¬æç”»ãƒ†ã‚¹ãƒˆ
2. ãƒ„ãƒ¼ãƒ«åˆ‡æ›¿ãƒ†ã‚¹ãƒˆ
3. å¤–éƒ¨å…¥åŠ›ãƒ†ã‚¹ãƒˆ

## ğŸ¯ æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] **åˆæœŸåŒ–æˆåŠŸ**: NavigationManager constructorå‹•ä½œ
- [ ] **æç”»é–‹å§‹**: ãƒšãƒ³ã§ç·šãŒå¼•ã‘ã‚‹
- [ ] **æç”»çµ‚äº†**: ãƒã‚¦ã‚¹é›¢ã™ã¨ç¢ºå®Ÿã«åœæ­¢
- [ ] **ãƒ„ãƒ¼ãƒ«åˆ‡æ›¿**: æ¶ˆã—ã‚´ãƒ ãƒœã‚¿ãƒ³ãŒå‹•ä½œ
- [ ] **å¤–éƒ¨æç”»**: ã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ã‹ã‚‰æç”»é–‹å§‹
- [ ] **åº§æ¨™ç²¾åº¦**: åº§æ¨™ã‚ºãƒ¬ãªã—
- [ ] **ã‚¨ãƒ©ãƒ¼ã‚¼ãƒ­**: Console errorè§£æ¶ˆ

## ğŸ“ ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

1. **js/utils/navigation-manager.js** - æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãƒ»getCameraBoundså®Ÿè£…
2. **js/utils/coordinate-manager.js** - toCanvasCoords APIçµ±ä¸€ãƒ»v8ã‚­ãƒ£ãƒƒã‚·ãƒ¥
3. **tools/pen-tool.js** - ç¶™ç¶šæç”»å•é¡Œãƒ»forceEndDrawingå®Ÿè£…

---

*ã“ã®ä¿®æ­£ã«ã‚ˆã‚Šã€Phase1.5ã®æ ¸å¿ƒæ©Ÿèƒ½ã§ã‚ã‚‹ã€Œå®‰å®šã—ãŸæç”»ã€ã€ŒManagerçµ±ä¸€æ³¨å…¥ã€ã€Œå¤–éƒ¨å…¥åŠ›å¯¾å¿œã€ãŒå®Œæˆã—ã€Phase2ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½ã¸ã®åŸºç›¤ãŒç¢ºç«‹ã•ã‚Œã¾ã™ã€‚*