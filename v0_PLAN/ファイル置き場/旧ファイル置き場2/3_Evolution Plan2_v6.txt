# ğŸ¨ Phase2 Evolution Plan - ãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½ãƒ»å¤‰å½¢ãƒ»ç¯„å›²é¸æŠ

> **Phase1.5åŸºç›¤æ´»ç”¨ãƒ»ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸­å¿ƒè¨­è¨ˆ** - Phase1.5å®Œæˆå¾Œé–‹å§‹

## ğŸŒŠ Phase2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å…¨ä½“åƒ

### ğŸ¨ ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ãƒ•ãƒ­ãƒ¼
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ â†’ ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«UI
2. LayerPanel.onAddLayer() â†’ LayerManager.createNamedLayer()
3. LayerManager.createLayer() â†’ CanvasManager.createLayer()
4. PIXI.Containerä½œæˆ â†’ stage.addChild()
5. RecordManager.recordLayerOperation() â†’ æ“ä½œè¨˜éŒ²
6. LayerPanel.updateDisplay() â†’ UIåæ˜ 
```

### ğŸ”„ ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢ãƒ•ãƒ­ãƒ¼
```
1. TransformToolé¸æŠ â†’ LayerManager.setActiveLayer()
2. å¤‰å½¢æ“ä½œé–‹å§‹ â†’ TransformTool.onPointerDown()
3. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¤‰å½¢ â†’ NavigationManager.transformLayer()
4. PIXI.Container.transformæ›´æ–° â†’ å³åº§åæ˜ 
5. å¤‰å½¢ç¢ºå®š â†’ RecordManager.recordTransform()
6. LayerManager.saveLayerState() â†’ çŠ¶æ…‹ä¿å­˜
```

### ğŸ“¦ ç¯„å›²é¸æŠãƒ•ãƒ­ãƒ¼
```
1. SelectToolé¸æŠ â†’ é¸æŠãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
2. ç¯„å›²æŒ‡å®š â†’ SelectTool.onPointerDrag()
3. é¸æŠé ˜åŸŸç¢ºå®š â†’ LayerManager.getSelectedContent()
4. é¸æŠå†…å®¹æ“ä½œ â†’ ç§»å‹•ãƒ»å¤‰å½¢ãƒ»å‰Šé™¤
5. RecordManager.recordSelection() â†’ é¸æŠæ“ä½œè¨˜éŒ²
```

## ğŸš§ Phase2 å‰ææ¡ä»¶ï¼ˆå¿…é ˆï¼‰

### âœ… Phase1.5å®Œæˆç¢ºèªé …ç›®
- [ ] NavigationManagerãƒ»RecordManagerãƒ»CoordinateManagerãƒ»ShortcutManagerå®Œå…¨å‹•ä½œ
- [ ] ãƒšãƒ³ãƒ»æ¶ˆã—ã‚´ãƒ ãƒ„ãƒ¼ãƒ«å®Œæˆãƒ»Undo/Redoé€£æº
- [ ] ã‚­ãƒ£ãƒ³ãƒã‚¹ç§»å‹•ãƒ»ã‚ºãƒ¼ãƒ ãƒ»åŸºæœ¬ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå‹•ä½œ
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†ãƒ»ã‚¨ãƒ©ãƒ¼ç„¡ã—å‹•ä½œ

### ğŸš« Phase2é–‹å§‹ç¦æ­¢æ¡ä»¶
- Phase1.5ã®ä¸å®Œå…¨ãªçŠ¶æ…‹ã§ã®é–‹å§‹
- åŸºç›¤Managerã®æœªå®Ÿè£…ãƒ»ä¸å®‰å®šå‹•ä½œ
- æ—¢å­˜æ©Ÿèƒ½ã®ç ´å£Šçš„å¤‰æ›´ã‚’ä¼´ã†è¨­è¨ˆ

## ğŸ“¦ Phase2-Step1: ãƒ¬ã‚¤ãƒ¤ãƒ¼åŸºæœ¬æ©Ÿèƒ½

### ğŸ¯ Step1å®Ÿè£…ç›®æ¨™
- è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒ»å‰Šé™¤ãƒ»é †åºå¤‰æ›´
- ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º/éè¡¨ç¤ºãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«UIãƒ»ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—

### ğŸ“ æ–°è¦è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«
```
managers/layer-manager.js           # ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†å°‚ä»»
ui/layer-panel.js                   # ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«UI
tools/layer-tool.js                 # ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œãƒ„ãƒ¼ãƒ«ï¼ˆè£œåŠ©ï¼‰
```

### ğŸ¨ LayerManagerå®Ÿè£…è©³ç´°

**ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«**: `managers/layer-manager.js`

```javascript
/**
 * ğŸ¨ LayerManager - ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†å°‚ä»»ï¼ˆPhase2åŸºç›¤ï¼‰
 * ğŸ“‹ RESPONSIBILITY: ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒ»å‰Šé™¤ãƒ»é †åºãƒ»è¡¨ç¤ºç®¡ç†ãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç®¡ç†
 * ğŸš« PROHIBITION: æç”»å‡¦ç†ãƒ»ãƒ„ãƒ¼ãƒ«å‡¦ç†ãƒ»UIæ“ä½œãƒ»ã‚¨ãƒ©ãƒ¼é€šçŸ¥
 * âœ… PERMISSION: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œãƒ»CanvasManageré€£æºãƒ»RecordManageré€£æº
 * 
 * ğŸ“ DESIGN_PRINCIPLE: ãƒ¬ã‚¤ãƒ¤ãƒ¼å°‚é–€ãƒ»Phase1.5åŸºç›¤æ´»ç”¨ãƒ»éç ´å£Šç·¨é›†å¯¾å¿œ
 * ğŸ”„ INTEGRATION: CanvasManageré€£æº â†’ RecordManagerè¨˜éŒ² â†’ UIé€šçŸ¥
 * ğŸŒŠ DATA_FLOW: UIæ“ä½œ â†’ ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç† â†’ CanvasManagerå®Ÿè¡Œ â†’ è¨˜éŒ²ãƒ»é€šçŸ¥
 */
class LayerManager {
    constructor() {
        console.log('ğŸ¨ LayerManagerä½œæˆï¼ˆPhase2åŸºç›¤ï¼‰');
        
        this.canvasManager = null;
        this.recordManager = null;
        
        this.layers = new Map(); // layerId â†’ LayerInfo
        this.layerOrder = []; // ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºï¼ˆä¸‹ã‹ã‚‰ä¸Šï¼‰
        this.activeLayerId = null;
        this.layerCounter = 0;
        
        this.initialized = false;
    }
    
    /**
     * Phase1.5åŸºç›¤Managerè¨­å®š
     */
    setCanvasManager(canvasManager) {
        if (!canvasManager) {
            throw new Error('CanvasManager is required');
        }
        this.canvasManager = canvasManager;
    }
    
    setRecordManager(recordManager) {
        if (!recordManager) {
            throw new Error('RecordManager is required');
        }
        this.recordManager = recordManager;
    }
    
    /**
     * åˆæœŸåŒ–ï¼ˆPhase1.5åŸºç›¤ç¢ºèªå¾Œï¼‰
     */
    initialize() {
        if (!this.canvasManager || !this.recordManager) {
            throw new Error('Required managers not set');
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ç¢ºèªãƒ»è¿½åŠ 
        this.setupDefaultLayers();
        
        this.initialized = true;
        console.log('âœ… LayerManageråˆæœŸåŒ–å®Œäº†');
    }
    
    /**
     * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
     */
    setupDefaultLayers() {
        // æ—¢å­˜ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¢ºèª
        const existingLayers = ['layer0', 'layer1']; // Phase1.5ã‹ã‚‰ã®ç¶™ç¶š
        
        existingLayers.forEach((layerId, index) => {
            const pixiContainer = this.canvasManager.getLayer(layerId);
            if (pixiContainer) {
                this.layers.set(layerId, {
                    id: layerId,
                    name: layerId === 'layer0' ? 'èƒŒæ™¯' : 'ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼',
                    visible: true,
                    locked: layerId === 'layer0', // èƒŒæ™¯ã¯ãƒ­ãƒƒã‚¯
                    pixiContainer: pixiContainer,
                    zIndex: index
                });
                this.layerOrder.push(layerId);
            }
        });
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
        this.activeLayerId = 'layer1';
        console.log('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šå®Œäº†:', Array.from(this.layers.keys()));
    }
    
    /**
     * åå‰ä»˜ããƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ
     */
    createNamedLayer(name = null, index = null) {
        const layerId = `layer${++this.layerCounter}`;
        const layerName = name || `ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${this.layerCounter}`;
        
        // CanvasManagerçµŒç”±ã§PixiJS Containerä½œæˆ
        const pixiContainer = this.canvasManager.createLayer(layerId);
        
        // ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ä½œæˆ
        const layerInfo = {
            id: layerId,
            name: layerName,
            visible: true,
            locked: false,
            pixiContainer: pixiContainer,
            zIndex: this.getNextZIndex()
        };
        
        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²
        this.layers.set(layerId, layerInfo);
        
        // é †åºç®¡ç†
        if (index !== null && index >= 0 && index < this.layerOrder.length) {
            this.layerOrder.splice(index, 0, layerId);
            this.updateZIndices();
        } else {
            this.layerOrder.push(layerId);
        }
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
        this.setActiveLayer(layerId);
        
        // è¨˜éŒ²
        this.recordManager?.recordLayerOperation({
            type: 'layer_create',
            layerId: layerId,
            name: layerName,
            index: this.layerOrder.indexOf(layerId)
        });
        
        console.log('âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ:', { layerId, layerName });
        return layerId;
    }
    
    /**
     * ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤
     */
    deleteLayer(layerId) {
        if (!this.layers.has(layerId)) {
            throw new Error(`Layer not found: ${layerId}`);
        }
        
        const layerInfo = this.layers.get(layerId);
        
        // å‰Šé™¤ç¦æ­¢ãƒã‚§ãƒƒã‚¯ï¼ˆèƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã©ï¼‰
        if (layerInfo.locked) {
            throw new Error(`Cannot delete locked layer: ${layerId}`);
        }
        
        // å”¯ä¸€ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤ç¦æ­¢
        if (this.layers.size <= 1) {
            throw new Error('Cannot delete last layer');
        }
        
        // CanvasManagerçµŒç”±ã§å‰Šé™¤
        this.canvasManager.removeLayer(layerId);
        
        // ç®¡ç†ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        this.layers.delete(layerId);
        const orderIndex = this.layerOrder.indexOf(layerId);
        this.layerOrder.splice(orderIndex, 1);
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼èª¿æ•´
        if (this.activeLayerId === layerId) {
            const newActiveIndex = Math.min(orderIndex, this.layerOrder.length - 1);
            this.activeLayerId = this.layerOrder[newActiveIndex];
        }
        
        // è¨˜éŒ²
        this.recordManager?.recordLayerOperation({
            type: 'layer_delete',
            layerId: layerId,
            layerInfo: layerInfo
        });
        
        console.log('âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤:', layerId);
    }
    
    /**
     * ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´
     */
    moveLayerOrder(layerId, newIndex) {
        if (!this.layers.has(layerId)) {
            throw new Error(`Layer not found: ${layerId}`);
        }
        
        const currentIndex = this.layerOrder.indexOf(layerId);
        if (currentIndex === -1) return;
        
        // é †åºé…åˆ—æ›´æ–°
        this.layerOrder.splice(currentIndex, 1);
        this.layerOrder.splice(newIndex, 0, layerId);
        
        // PixiJS zIndexæ›´æ–°
        this.updateZIndices();
        
        // è¨˜éŒ²
        this.recordManager?.recordLayerOperation({
            type: 'layer_reorder',
            layerId: layerId,
            oldIndex: currentIndex,
            newIndex: newIndex
        });
        
        console.log('âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´:', { layerId, newIndex });
    }
    
    /**
     * ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º/éè¡¨ç¤º
     */
    setLayerVisibility(layerId, visible) {
        const layerInfo = this.layers.get(layerId);
        if (!layerInfo) {
            throw new Error(`Layer not found: ${layerId}`);
        }
        
        layerInfo.visible = visible;
        layerInfo.pixiContainer.visible = visible;
        
        // è¨˜éŒ²
        this.recordManager?.recordLayerOperation({
            type: 'layer_visibility',
            layerId: layerId,
            visible: visible
        });
        
        console.log('âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºå¤‰æ›´:', { layerId, visible });
    }
    
    /**
     * ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
     */
    setActiveLayer(layerId) {
        if (!this.layers.has(layerId)) {
            throw new Error(`Layer not found: ${layerId}`);
        }
        
        this.activeLayerId = layerId;
        
        // CanvasManagerã«é€šçŸ¥ï¼ˆæç”»å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ›´ï¼‰
        this.canvasManager.setActiveLayer?.(layerId);
        
        console.log('âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ›´:', layerId);
    }
    
    /**
     * ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—
     */
    getActiveLayer() {
        return this.activeLayerId ? this.layers.get(this.activeLayerId) : null;
    }
    
    getActiveLayerId() {
        return this.activeLayerId;
    }
    
    /**
     * ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§å–å¾—ï¼ˆé †åºä»˜ãï¼‰
     */
    getLayersInOrder() {
        return this.layerOrder.map(layerId => this.layers.get(layerId));
    }
    
    /**
     * Z-Indexæ›´æ–°
     */
    updateZIndices() {
        this.layerOrder.forEach((layerId, index) => {
            const layerInfo = this.layers.get(layerId);
            if (layerInfo) {
                layerInfo.zIndex = index;
                layerInfo.pixiContainer.zIndex = index;
            }
        });
    }
    
    getNextZIndex() {
        return this.layers.size;
    }
    
    /**
     * Phase1.5åŸºç›¤é€£æºï¼šå¤‰å½¢è¨˜éŒ²
     */
    recordTransformOperation(layerId, transform) {
        this.recordManager?.recordLayerOperation({
            type: 'layer_transform',
            layerId: layerId,
            transform: { ...transform }
        });
    }
    
    /**
     * æº–å‚™çŠ¶æ…‹ç¢ºèª
     */
    isReady() {
        return this.initialized && 
               this.canvasManager && 
               this.recordManager && 
               this.layers.size > 0;
    }
    
    /**
     * ãƒ‡ãƒãƒƒã‚°æƒ…å ±
     */
    getDebugInfo() {
        return {
            className: 'LayerManager',
            initialized: this.initialized,
            hasRequiredDeps: !!(this.canvasManager && this.recordManager),
            layerCount: this.layers.size,
            activeLayerId: this.activeLayerId,
            layerOrder: [...this.layerOrder],
            layers: Array.from(this.layers.entries()).map(([id, info]) => ({
                id,
                name: info.name,
                visible: info.visible,
                locked: info.locked,
                zIndex: info.zIndex
            }))
        };
    }
}

// Tegakiåå‰ç©ºé–“ç™»éŒ²
if (!window.Tegaki) window.Tegaki = {};
window.Tegaki.LayerManager = LayerManager;

console.log('ğŸ¨ LayerManager Loaded (Phase2åŸºç›¤)');
```

### ğŸ¨ LayerPanel UIå®Ÿè£…è©³ç´°

**ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«**: `ui/layer-panel.js`

```javascript
/**
 * ğŸ¨ LayerPanel - ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«UIå°‚ä»»ï¼ˆPhase2 UIï¼‰
 * ğŸ“‹ RESPONSIBILITY: ãƒ¬ã‚¤ãƒ¤ãƒ¼UIè¡¨ç¤ºãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãƒ»LayerManageré€£æº
 * ğŸš« PROHIBITION: ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ãƒ»PixiJSæ“ä½œãƒ»è¨˜éŒ²å‡¦ç†
 * âœ… PERMISSION: DOMæ“ä½œãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ»LayerManagerå‘¼ã³å‡ºã—
 * 
 * ğŸ“ DESIGN_PRINCIPLE: UIå°‚é–€ãƒ»LayerManagerå§”è­²ãƒ»ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
 * ğŸ”„ INTEGRATION: LayerManageré€£æº â†’ DOMæ›´æ–° â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå—ä»˜
 * ğŸŒŠ DATA_FLOW: LayerManagerçŠ¶æ…‹ â†’ UIè¡¨ç¤º â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ â†’ LayerManagerå‘¼ã³å‡ºã—
 */
class LayerPanel {
    constructor() {
        console.log('ğŸ¨ LayerPanelä½œæˆï¼ˆPhase2 UIï¼‰');
        
        this.layerManager = null;
        this.panelElement = null;
        this.layerListElement = null;
        
        this.initialized = false;
    }
    
    /**
     * LayerManagerè¨­å®š
     */
    setLayerManager(layerManager) {
        if (!layerManager) {
            throw new Error('LayerManager is required');
        }
        this.layerManager = layerManager;
    }
    
    /**
     * UIåˆæœŸåŒ–
     */
    initialize(containerElement) {
        if (!this.layerManager) {
            throw new Error('LayerManager not set');
        }
        
        this.createPanelUI(containerElement);
        this.setupEventListeners();
        this.updateDisplay();
        
        this.initialized = true;
        console.log('âœ… LayerPanelåˆæœŸåŒ–å®Œäº†');
    }
    
    /**
     * ãƒ‘ãƒãƒ«UIä½œæˆ
     */
    createPanelUI(container) {
        // ãƒ‘ãƒãƒ«ä½œæˆ
        this.panelElement = document.createElement('div');
        this.panelElement.className = 'layer-panel';
        this.panelElement.innerHTML = `
            <div class="layer-panel-header">
                <h3>ãƒ¬ã‚¤ãƒ¤ãƒ¼</h3>
                <button class="add-layer-btn">+</button>
            </div>
            <div class="layer-list"></div>
        `;
        
        this.layerListElement = this.panelElement.querySelector('.layer-list');
        
        // ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
        if (typeof container === 'string') {
            container = document.getElementById(container);
        }
        container.appendChild(this.panelElement);
        
        // CSSé©ç”¨
        this.applyStyles();
    }
    
    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
     */
    setupEventListeners() {
        // ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³
        const addBtn = this.panelElement.querySelector('.add-layer-btn');
        addBtn.addEventListener('click', () => {
            const layerName = prompt('ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›:', `ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${Date.now()}`);
            if (layerName) {
                this.layerManager.createNamedLayer(layerName);
                this.updateDisplay();
            }
        });
    }
    
    /**
     * è¡¨ç¤ºæ›´æ–°
     */
    updateDisplay() {
        if (!this.layerListElement) return;
        
        // æ—¢å­˜å†…å®¹ã‚¯ãƒªã‚¢
        this.layerListElement.innerHTML = '';
        
        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§å–å¾—ï¼ˆé †åºä»˜ãï¼‰
        const layers = this.layerManager.getLayersInOrder();
        const activeLayerId = this.layerManager.getActiveLayerId();
        
        // ãƒ¬ã‚¤ãƒ¤ãƒ¼è¦ç´ ä½œæˆï¼ˆé€†é †ï¼šä¸Šã‹ã‚‰ä¸‹ï¼‰
        layers.reverse().forEach((layerInfo) => {
            const layerElement = this.createLayerElement(layerInfo, activeLayerId);
            this.layerListElement.appendChild(layerElement);
        });
    }
    
    /**
     * ãƒ¬ã‚¤ãƒ¤ãƒ¼è¦ç´ ä½œæˆ
     */
    createLayerElement(layerInfo, activeLayerId) {
        const layerDiv = document.createElement('div');
        layerDiv.className = `layer-item ${layerInfo.id === activeLayerId ? 'active' : ''}`;
        layerDiv.dataset.layerId = layerInfo.id;
        
        layerDiv.innerHTML = `
            <div class="layer-visibility">
                <input type="checkbox" ${layerInfo.visible ? 'checked' : ''} 
                       ${layerInfo.locked ? 'disabled' : ''}>
            </div>
            <div class="layer-name">${layerInfo.name}</div>
            <div class="layer-controls">
                ${!layerInfo.locked ? '<button class="delete-layer">Ã—</button>' : ''}
            </div>
        `;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        this.setupLayerElementEvents(layerDiv, layerInfo);
        
        return layerDiv;
    }
    
    /**
     * ãƒ¬ã‚¤ãƒ¤ãƒ¼è¦ç´ ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
     */
    setupLayerElementEvents(layerElement, layerInfo) {
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠ
        layerElement.addEventListener('click', (e) => {
            if (e.target.type !== 'checkbox' && !e.target.classList.contains('delete-layer')) {
                this.layerManager.setActiveLayer(layerInfo.id);
                this.updateDisplay();
            }
        });
        
        // è¡¨ç¤º/éè¡¨ç¤º
        const checkbox = layerElement.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', (e) => {
            this.layerManager.setLayerVisibility(layerInfo.id, e.target.checked);
        });
        
        // å‰Šé™¤
        const deleteBtn = layerElement.querySelector('.delete-layer');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€Œ${layerInfo.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    try {
                        this.layerManager.deleteLayer(layerInfo.id);
                        this.updateDisplay();
                    } catch (error) {
                        alert(error.message);
                    }
                }
            });
        }
    }
    
    /**
     * ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
     */
    applyStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .layer-panel {
                position: fixed;
                right: 10px;
                top: 60px;
                width: 200px;
                background: #2a2a2a;
                border: 1px solid #555;
                border-radius: 5px;
                padding: 10px;
                font-family: Arial, sans-serif;
                z-index: 1000;
            }
            
            .layer-panel-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                color: white;
            }
            
            .layer-panel-header h3 {
                margin: 0;
                font-size: 14px;
            }
            
            .add-layer-btn {
                background: #007acc;
                color: white;
                border: none;
                border-radius: 3px;
                padding: 4px 8px;
                cursor: pointer;
                font-size: 16px;
                line-height: 1;
            }
            
            .add-layer-btn:hover {
                background: #0086cc;
            }
            
            .layer-list {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .layer-item {
                display: flex;
                align-items: center;
                padding: 5px;
                margin-bottom: 2px;
                background: #3a3a3a;
                border-radius: 3px;
                cursor: pointer;
                color: white;
                font-size: 12px;
            }
            
            .layer-item.active {
                background: #007acc;
            }
            
            .layer-item:hover:not(.active) {
                background: #4a4a4a;
            }
            
            .layer-visibility {
                margin-right: 8px;
            }
            
            .layer-name {
                flex: 1;
                overflow: hidden;