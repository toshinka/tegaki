ToonCrafter導入計画書（ブラウザお絵かきツール用）
目標: GIFアニメ機能導入後、手描き原画（キーフレーム）からAIで中割りを自動生成する機能を実装する。

前提条件:

クライアント: PixiJS v7+JavaScript (ES2023) / fetch API / windowグローバル公開

AIモデル: ToonCrafter（PythonベースのオープンソースAIモデル）

開発ロードマップ:

この計画は3つのフェーズに分かれています。

フェーズ1：サーバーAPIの構築 (担当: サーバーサイド)
AIモデルの推論処理を担うサーバーAPIを構築します。この部分はブラウザ側の制約から独立して開発できます。

AI実行環境のセットアップ:

ToonCrafterモデルを動作させるためのサーバー環境を構築します。Python環境にPyTorch、Diffusers、および必要なライブラリをインストールします。

サーバーOS: LinuxやWindowsなど。

推奨ハードウェア: 高性能なGPU（NVIDIA RTX 3060以上など）を搭載したマシン。

APIエンドポイントの実装:

クライアント（ブラウザ）から画像データを受け取るためのAPIエンドポイント（例: /api/generate_inbetweens）を作成します。

入力: 2つのキーフレーム画像データ（base64形式など）。

出力: 生成された中間フレームの画像データ（複数枚のbase64形式、またはGIF形式など）。

AI推論ロジックの実装:

受け取った画像データをToonCrafterモデルに入力し、中間フレームを生成します。

生成されたフレームをクライアントが扱いやすい形式に変換し、レスポンスとして返します。

フェーズ2：クライアント（ブラウザ）側の機能追加 (担当: クライアントサイド)
あなたの既存のお絵かきツールに、サーバーと連携するための機能を組み込みます。

UI/UXの設計と実装:

ユーザーが2つのキーフレームを選択できるUIを作成します。例えば、タイムライン上の2つのレイヤーを選択させるボタンなど。

中割り生成を実行するボタンを追加します。

AI処理中のローディング表示や、エラーメッセージ表示を実装します。

画像データの取得と送信:

選択された2つのキーフレームの画像データを取得します。HTML Canvasから画像データをtoDataURL()などで取得し、それをfetch APIでサーバーに送信できる形式に変換します。

fetch APIによる通信処理:

fetch APIを使って、フェーズ1で作成したAPIエンドポイントに画像データをPOSTリクエストとして送信します。

サーバーからのレスポンス（中間フレーム画像データ）を非同期で受け取ります。

生成結果の表示:

サーバーから返ってきた中間フレーム画像を、GIFアニメーションとして表示したり、タイムラインの新しいレイヤーとして追加したりするロジックを実装します。

フェーズ3：連携のテストと最適化
クライアントとサーバーがスムーズに連携するように調整します。

総合テスト:

ブラウザからAPIを呼び出し、AIによる中割りが正しく生成され、意図したとおりに表示されるかを確認します。

様々な画像パターン（線画、色付き、複雑な構図など）でテストし、AIの出力品質を評価します。

パフォーマンス改善:

サーバー側の推論速度を最適化します。

クライアントとサーバー間のデータ通信量を削減するための工夫（圧縮など）を検討します。

制約に関する考察
あなたの開発ルールはAIモデルのクライアントサイド実行には非常に厳しいものですが、本計画のサーバーサイド・アーキテクチャであれば、完全に準拠可能です。

Vite / TypeScript / ESM禁止:

サーバーサイドのAIモデルはPythonで動作するため、これらの制約は影響しません。

クライアントサイドはすべて生のJavaScriptとfetch APIで完結するため、問題ありません。

HTML直開きで動くことが必須:

この場合、APIを呼び出す際にCORS（Cross-Origin Resource Sharing）設定が必要になる場合があります。サーバー側で適切なCORSヘッダーを設定することで、この要件を満たせます。

windowグローバル公開:

AI連携機能も、他のモジュールと同様にwindow.InbetweeningManagerといった形でグローバルに公開する設計が可能です。

この計画書は、技術的な制約をクリアしつつ、あなたのプロジェクトの将来的な目標（AI活用）を達成するための現実的なステップです。
ご不明な点や、さらに詳細な計画が必要な場合は、お気軽にお知らせください。