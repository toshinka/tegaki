<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ ãµãŸã°â˜†ã¡ã‚ƒã‚“ã­ã‚‹é¢¨ãƒ™ã‚¯ã‚¿ãƒ¼ãŠçµµã‹ããƒ„ãƒ¼ãƒ« v8 åˆ—è»Šå‹ (è»½é‡ç‰ˆ)</title>
</head>
<body>
    <!-- Pixi.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    
    <script>
        /**
         * ============================================================
         * Tegaki v8 åˆ—è»Šå‹ - ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡è»Šä¸¡ (è»½é‡ç‰ˆ)
         * å„è»Šä¸¡ã®ãƒ­ãƒ¼ãƒ‰ã¨çµ±åˆåˆ¶å¾¡ã®ã¿ã‚’æ‹…å½“
         * ============================================================
         */

        // ==== Train Controller - è»Šä¸¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ====
        class TrainController {
            constructor() {
                this.cars = [];
                this.loadedCars = new Set();
                this.isInitialized = false;
            }

            /**
             * è»Šä¸¡é †æ¬¡ãƒ­ãƒ¼ãƒ‰ï¼ˆä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ï¼‰
             */
            async loadCars() {
                console.log('[Main] ğŸš‚ åˆ—è»Šå‹ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹ - è»Šä¸¡ãƒ­ãƒ¼ãƒ‰é–‹å§‹');

                // Phase 1: åŸºç›¤è»Šä¸¡ï¼ˆã‚¹ã‚¿ã‚¤ãƒ« + A1ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
                await this.loadCar('https://raw.githubusercontent.com/toshinka/tegaki/refs/heads/main/v7_train_rev7/tegaki-styles.html');
                await this.loadCar('https://raw.githubusercontent.com/toshinka/tegaki/refs/heads/main/v7_train_rev7/tegaki-a1-header.html');
                
                // A1åˆæœŸåŒ–å®Œäº†å¾…ã¡
                await this.waitForCarReady('a1Ready');

                // Phase 2: ã‚³ã‚¢è»Šä¸¡ï¼ˆA2ï¼‰
                await this.loadCar('https://raw.githubusercontent.com/toshinka/tegaki/refs/heads/main/v7_train_rev7/tegaki-a2-core.html');
                
                // A2åˆæœŸåŒ–å®Œäº†å¾…ã¡
                await this.waitForCarReady('a2Ready');

                // Phase 3: çµ±åˆè»Šä¸¡ï¼ˆA3ï¼‰
                await this.loadCar('https://raw.githubusercontent.com/toshinka/tegaki/refs/heads/main/v7_train_rev7/tegaki-a3-integration.html');
                
                // Aåˆ—è»Šå®Œæˆå¾…ã¡
                await this.waitForCarReady('aTrainReady');

                // Phase 4: UIãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è»Šä¸¡ï¼ˆB1, B2ï¼‰
                await this.loadCar('https://raw.githubusercontent.com/toshinka/tegaki/refs/heads/main/v7_train_rev7/tegaki-b1-ui.html');
                await this.loadCar('https://raw.githubusercontent.com/toshinka/tegaki/refs/heads/main/v7_train_rev7/tegaki-b2-status.html');

                console.log('[Main] âœ… å…¨è»Šä¸¡ãƒ­ãƒ¼ãƒ‰å®Œäº†');
            }

            /**
             * è»Šä¸¡æº–å‚™å®Œäº†å¾…ã¡
             */
            async waitForCarReady(readyFlag) {
                return new Promise((resolve) => {
                    const checkReady = () => {
                        if (window.TEGAKI_STATE?.[readyFlag]) {
                            console.log(`[Main] âœ… ${readyFlag} æº–å‚™å®Œäº†ç¢ºèª`);
                            resolve();
                        } else {
                            setTimeout(checkReady, 50);
                        }
                    };
                    checkReady();
                });
            }

            /**
             * å€‹åˆ¥è»Šä¸¡ãƒ­ãƒ¼ãƒ‰
             */
            async loadCar(url) {
                try {
                    const response = await fetch(url);
                    const content = await response.text();
                    
                    // HTMLãƒ‘ãƒ¼ã‚¹
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(content, 'text/html');
                    
                    // ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
                    const styles = doc.querySelectorAll('style');
                    styles.forEach(style => {
                        if (!document.querySelector(`style[data-source="${url}"]`)) {
                            const newStyle = document.createElement('style');
                            newStyle.textContent = style.textContent;
                            newStyle.setAttribute('data-source', url);
                            document.head.appendChild(newStyle);
                        }
                    });
                    
                    // HTMLè¦ç´ è¿½åŠ 
                    const bodyContent = doc.body.innerHTML;
                    if (bodyContent.trim()) {
                        const container = document.createElement('div');
                        container.innerHTML = bodyContent;
                        container.setAttribute('data-car', this.getCarName(url));
                        document.body.appendChild(container);
                    }
                    
                    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
                    const scripts = doc.querySelectorAll('script');
                    for (const script of scripts) {
                        if (script.src) {
                            await this.loadExternalScript(script.src);
                        } else if (script.textContent.trim()) {
                            this.executeScript(script.textContent, url);
                        }
                    }

                    const carName = this.getCarName(url);
                    this.loadedCars.add(carName);
                    console.log(`[Main] ğŸšƒ ${carName} è»Šä¸¡ãƒ­ãƒ¼ãƒ‰å®Œäº†`);

                } catch (error) {
                    console.error(`[Main] âš  è»Šä¸¡ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${url}`, error);
                }
            }

            /**
             * å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ãƒ‰
             */
            loadExternalScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            /**
             * ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
             */
            executeScript(content, sourceUrl) {
                try {
                    const script = document.createElement('script');
                    script.textContent = content;
                    script.setAttribute('data-source', sourceUrl);
                    document.head.appendChild(script);
                } catch (error) {
                    console.error(`[Main] ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ ${sourceUrl}:`, error);
                }
            }

            /**
             * è»Šä¸¡åå–å¾—
             */
            getCarName(url) {
                const filename = url.split('/').pop();
                const match = filename.match(/tegaki-(.+)\.html$/);
                return match ? match[1] : filename;
            }

            /**
             * åˆæœŸåŒ–å®Œäº†ãƒã‚§ãƒƒã‚¯
             */
            async waitForInitialization() {
                return new Promise((resolve) => {
                    const checkInterval = setInterval(() => {
                        // åŸºæœ¬çš„ãªè»Šä¸¡ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                        if (window.TEGAKI_STATE?.a2Ready && 
                            window.TEGAKI_CanvasManager?.app &&
                            document.getElementById('drawing-canvas')) {
                            
                            clearInterval(checkInterval);
                            this.isInitialized = true;
                            resolve();
                        }
                    }, 50);
                });
            }

            /**
             * ã‚·ã‚¹ãƒ†ãƒ çµ±åˆé–‹å§‹
             */
            async initializeSystem() {
                await this.loadCars();
                await this.waitForInitialization();
                
                console.log('[Main] ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ çµ±åˆå®Œäº† - æç”»ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
                this.showDebugInfo();
            }

            /**
             * ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
             */
            showDebugInfo() {
                console.log(`[Main] ğŸ“Š ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿è»Šä¸¡: ${Array.from(this.loadedCars).join(', ')}`);
                console.log(`[Main] ğŸ–¼ ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹:`, window.TEGAKI_CanvasManager?.app ? 'âœ… æ­£å¸¸' : 'âŒ æœªåˆæœŸåŒ–');
                console.log(`[Main] ğŸ› UIçŠ¶æ…‹:`, document.querySelector('.main-layout') ? 'âœ… æ­£å¸¸' : 'âŒ æœªé…ç½®');
            }
        }

        // ==== Bootstrap - ã‚·ã‚¹ãƒ†ãƒ èµ·å‹• ====
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('[Main] ğŸš€ Tegaki v8 åˆ—è»Šå‹ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
                
                window.trainController = new TrainController();
                await window.trainController.initializeSystem();
                
                console.log('[Main] âœ¨ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†');
                
            } catch (error) {
                console.error('[Main] âš  ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
            }
        });
    </script>
</body>
</html>