問題点と原因の推測
1. 画面外描画が最初の数ピクセルで止まる

原因候補

pointerdown → startStroke で最初のポイント座標が誤変換されている（画面座標 → world/canvas座標）

オフキャンバス判定ロジックが、キャンバス外スタートの座標を無視または無効化している

半透明プレビューが最初の数ピクセルしか描画していない可能性

対応

座標フローの統一（画面座標 → world座標 → layer座標 → renderer描画）

オフキャンバスでも最初の pointerdown で必ずストローク記録を開始

2. Undo/Redo が未実装

原因

履歴管理（HistoryManager）自体は設計に記述されているが、ストロークイベントを履歴に積む処理が未接続

ショートカットのキーイベントリスナーも未実装

対応

pointerup や commitStroke 時に必ず HistoryEvent を生成してスタックに追加

Ctrl+Z / Ctrl+Y で undo/redo を適用するキーリスナーを追加

3. ポップアップ後のペンサイズ変更が効かない

原因

ペンサイズ変更UIと InputManager / currentBrush が連動していない

オフキャンバス描画中は currentBrush がローカルコピーで固定され、UI変更が反映されていない

対応

ポップアップからのプロパティ変更を即時反映する InputManager.currentBrush 更新処理を追加

ストローク作成時に参照ではなく最新のブラシ設定を使用

4. チェックボックス「キャンバス外描画を許可」連動不具合

現象

チェックON → 描画判定がおかしい（描画範囲が移動中のキャンバスと同期）

チェックOFF → 描画可能だが、既存描画との座標整合が崩れる

原因

オフキャンバス機能ON/OFFで座標系変換が二重化

描画判定：カーソル座標 + camera offset

表示：canvas描画座標 + camera offset

orphan管理と commit の座標フローが一致していない

対応

座標フローを整理

pointer → screen座標

screen → world座標（カメラ・Viewport考慮）

world → layer座標（描画記録・レンダリング用）

オフキャンバスON/OFFで座標変換を分岐させず、常に統一フローで管理

orphanストロークも world座標で保持し、commit時に layer座標に変換

推奨フロー整理
描画の仕組み（理想フロー）
[PointerEvent] 
     │
     ▼
[InputManager] 
  - pointerdown / move / up
  - screen → world座標変換
  - currentBrush情報参照
  │
  ▼
[StrokeBuilder / TempElement] (半透明プレビュー)
  - world座標で points追加
  - orphan / commit 状態保持
  │
  ▼
[RendererManager]
  - world座標 → layer座標 → PIXI.Graphics描画
  - commit後 cacheAsBitmap optional
  │
  ▼
[Document / Layer]
  - 非破壊で elementを記録
  - TransformRecord + historyEvent登録
  │
  ▼
[HistoryManager]
  - undoStack / redoStack管理
  - Ctrl+Z / Ctrl+Y で操作反映

座標系フロー
層	用途	備考
Screen	pointerの生座標	画面上の位置、viewport無視
World	無限キャンバス座標	camera/viewportを考慮して変換
Layer	実際の描画座標	element payloadに記録。レンダリング時にPIXI.Graphicsに反映
Render	PIXI描画	layer座標 + camera offset
改修ポイントまとめ

InputManagerでオフキャンバスでもpointerdownを必ず開始

座標変換フローを screen → world → layer に統一

orphanストローク管理の再整理

ブラシ/ペンサイズ変更を即時反映

Undo/Redoのスタックとショートカットを実装

オフキャンバスON/OFFで座標判定を分岐させず統一

RendererManagerでの描画・プレビュー処理をworld座標基準で描画

💡 結論：

現状は「機能概念はあるが、フローと座標管理が混線している」状態。

フロー整理＋座標統一＋履歴接続 が完了すれば、最初の数ピクセルで止まる問題や、チェックボックス連動不具合、Undo/Redo未実装問題もまとめて解消可能です。

