# ğŸ“˜ Tegaki Rulebook v8 - Design Contract
**è¨­è¨ˆå¥‘ç´„ãƒ»è²¬ä»»åˆ†ç•Œãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡**  
Rev.2025-08-31-Design-Contract | å¥‘ç´„æ¡é …ã®ã¿ãƒ»ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰æ’é™¤ç‰ˆ
ğŸš¨æœ€æ–°ã®"pixi.js v8.12.0"ã‚’ä½¿ç”¨ã™ã‚‹äº‹ğŸš¨
---

## ğŸ¯ **åŸºæœ¬ç†å¿µï¼ˆä¸å¤‰ï¼‰**

### ğŸ’ Tegaki Core Philosophy
- **ã‚·ãƒ³ãƒ—ãƒ«ç‰¹åŒ–**: æ‰‹æããƒ»ãƒšãƒ³æç”»ã«ç‰¹åŒ–ã—ãŸè¨­è¨ˆ
- **é«˜å“è³ªæç”»**: 60FPSå®‰å®šï¼ˆ120FPSç›®æ¨™ï¼‰ãƒ»WebGPUæ´»ç”¨ãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ€å„ªå…ˆ
- **éç ´å£Šç·¨é›†**: TPFï¼ˆTegakiPathFormatï¼‰ã«ã‚ˆã‚‹å®Œå…¨å¯é€†æ“ä½œ
- **æ‹¡å¼µæ€§ç¢ºä¿**: æ®µéšçš„é€²åŒ–ãƒ»ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å¯¾å¿œãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŸºç›¤
- **ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒ†ã‚£ãƒ–**: HTMLç›´é–‹ããƒ»ES2023æº–æ‹ ãƒ»è»Šè¼ªã®å†ç™ºæ˜ã‚’ã—ãªã„ã‚ˆã†ç›¸æ€§ã®è‰¯ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç©æ¥µæ´»ç”¨ã€‚
- **æ§‹æ–‡å®Œæ•´æ€§ã¨DRYãƒ»SOLIDåŸå‰‡ã‚’éµå®ˆã€ãƒ•ã‚¡ã‚¤ãƒ«ã®æ˜ç¢ºãªè²¬ä»»åˆ†ç•ŒåŒ–ã€‚

### ğŸš« æ°¸ç¶šçš„ç¦æ­¢äº‹é …ï¼ˆEternal Prohibitionsï¼‰
```
ğŸ’€ åŒæ–¹å‘ä¾å­˜ - å¾ªç’°å‚ç…§ã«ã‚ˆã‚‹ç ´ç¶»é˜²æ­¢
ğŸš« ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç† - æ›–æ˜§ãªå‹•ä½œãƒ»æš—é»™ä¿®å¾©ç¦æ­¢  
ğŸš« ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ• - ã‚¨ãƒ©ãƒ¼éš è”½ãƒ»å•é¡Œå…ˆé€ã‚Šç¦æ­¢
ğŸš« ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ··åœ¨ - v7/v8åŒæ™‚å¯¾å¿œãƒ»äºŒé‡ç®¡ç†ç¦æ­¢
ğŸš« å¤–éƒ¨ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ« - Vite/TypeScript/ESM/Webpackç¦æ­¢
ğŸš« æš—é»™çš„ã‚°ãƒ­ãƒ¼ãƒãƒ« - æœªå®£è¨€å¤‰æ•°ãƒ»äºˆæœŸã—ãªã„å‰¯ä½œç”¨ç¦æ­¢
```
ğŸš« ä»Šå¾Œã®è‚¥å¤§åŒ–é˜²æ­¢ãƒ«ãƒ¼ãƒ«ï¼ˆè¿½åŠ ï¼‰
åˆæœŸåŒ–åˆ¶å¾¡ãƒ«ãƒ¼ãƒ«
ã€€1.ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³å¿…é ˆ
ã€€ãƒ»Bootstrap, TegakiApplication, AppCore
ã€€ãƒ»é‡è¤‡å®Ÿè¡Œã®å®Œå…¨ç¦æ­¢
ã€€2.åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼æ¤œè¨¼å¿…é ˆ
ã€€ãƒ»å„ã‚¹ãƒ†ãƒƒãƒ—ã§å‰ææ¡ä»¶ç¢ºèª
ã€€ãƒ»verifyInjection() ã®ç¢ºå®Ÿãªå®Ÿè¡Œ
ã€€3.Manager é–“å‚ç…§ã®å‹å®‰å…¨æ€§
ã€€ãƒ»å‚ç…§å‰ã®å­˜åœ¨ç¢ºèªå¿…é ˆ
ã€€ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ±ä¸€
ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°åŸå‰‡ï¼ˆå¼·åŒ–ï¼‰
ã€€4.Manager ã¯çŠ¶æ…‹ã‚’è‡ªå·±å®Œçµã§ç®¡ç†
ã€€ãƒ»getStatus(), getContainerStatus() ç­‰ã®çŠ¶æ…‹ç¢ºèªãƒ¡ã‚½ãƒƒãƒ‰å¿…é ˆ
ã€€ãƒ»ä»– Manager ã®å†…éƒ¨çŠ¶æ…‹ã«ç›´æ¥ä¾å­˜ç¦æ­¢
ã€€5.ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€
ã€€ãƒ»å…¨ Manager ã§åŒä¸€ã‚¨ãƒ©ãƒ¼å½¢å¼
ã€€ãƒ»ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®æ¨™æº–åŒ–
---

## ğŸ¯ **Design Contract Philosophy**

### ğŸ’ Core Principlesï¼ˆä¸å¤‰åŸå‰‡ï¼‰
- **Single Responsibility**: å„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ã‚¯ãƒ©ã‚¹ã¯å˜ä¸€è²¬å‹™ã®ã¿
- **Explicit Dependencies**: ä¾å­˜é–¢ä¿‚ã¯æ˜ç¤ºçš„ã«å®£è¨€ãƒ»æ³¨å…¥
- **Immutable Contracts**: ä¸€åº¦ç¢ºç«‹ã—ãŸAPIã¯ç ´å£Šçš„å¤‰æ›´ç¦æ­¢
- **Fail Fast**: ã‚¨ãƒ©ãƒ¼ã¯éš è”½ã›ãšæ—©æœŸç™ºè¦‹ãƒ»å³åº§å ±å‘Š
- **Zero Ambiguity**: æ›–æ˜§ãªå‹•ä½œãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¦æ­¢

---

## ğŸ“‹ **Contract 1: Manager Lifecycleï¼ˆå¿…é ˆå®Ÿè£…ï¼‰**

### ğŸ”„ çµ±ä¸€ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«API
```
configure(config) â†’ attach(context) â†’ init() â†’ isReady() â†’ dispose()
     â†“                â†“               â†“          â†“           â†“
   è¨­å®šæ³¨å…¥        ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ³¨å…¥   åˆæœŸåŒ–    æº–å‚™ç¢ºèª    ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾
```

### ğŸ“ Contract Details
- **configure(config)**: åŒæœŸãƒ»è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ³¨å…¥ãƒ»æˆ»ã‚Šå€¤boolean
- **attach(context)**: åŒæœŸãƒ»Pixi Applicationç­‰ã®å‚ç…§æ³¨å…¥ãƒ»æˆ»ã‚Šå€¤boolean  
- **init()**: éåŒæœŸå¯èƒ½ï¼ˆPromiseå¯¾å¿œï¼‰ãƒ»å†…éƒ¨åˆæœŸåŒ–ãƒ»å®Œäº†å¾ŒisReady=true
- **isReady()**: åŒæœŸãƒ»æº–å‚™å®Œäº†åˆ¤å®šãƒ»AppCoreãŒä¾å­˜ãƒ»æˆ»ã‚Šå€¤boolean
- **dispose()**: åŒæœŸ/éåŒæœŸå¯¾å¿œãƒ»ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾ãƒ»ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢

### ğŸš¨ Lifecycle Violations
- configureå‰ã®attachå®Ÿè¡Œ â†’ **CONTRACT VIOLATION**
- initå‰ã®isReady()=true â†’ **CONTRACT VIOLATION**  
- disposeå¾Œã®ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã— â†’ **CONTRACT VIOLATION**
- ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®ã‚¹ã‚­ãƒƒãƒ— â†’ **CONTRACT VIOLATION**

---

## ğŸ“‹ **Contract 2: Dependency Injectionï¼ˆä¾å­˜æ³¨å…¥å¥‘ç´„ï¼‰**

### ğŸ¯ çµ±ä¸€æ³¨å…¥ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

#### **Managerç³»**: setManagersObject(managers) Contract
```
å…¥åŠ›: Objectå½¢å¼ { canvas: CanvasManager, tool: ToolManager, ... }
å‡¦ç†: 1. å‹æ¤œè¨¼ â†’ 2. å¿…é ˆManagerç¢ºèª â†’ 3. å†…éƒ¨ä¿å­˜ â†’ 4. ä¾å­˜é–¢ä¿‚æ§‹ç¯‰
å‡ºåŠ›: booleanï¼ˆæˆåŠŸ=trueã€å¤±æ•—=falseï¼‰
ä¾‹å¤–: å¼•æ•°ä¸æ­£ãƒ»å¿…é ˆManagerä¸è¶³ãƒ»å‹ä¸æ•´åˆæ™‚ã®ã¿throw
```

#### **Toolç³»**: setManagersObject(managers) Contract
```
å…¥åŠ›: Objectå½¢å¼ { canvas: CanvasManager, coordinate: CoordinateManager, record: RecordManager }
å‡¦ç†: 1. AbstractTool.setManagersObject()ç¶™æ‰¿ â†’ 2. Toolå›ºæœ‰Managerè¿½åŠ ä¿å­˜
å‡ºåŠ›: booleanï¼ˆæˆåŠŸ=trueã€å¤±æ•—=falseï¼‰ 
è²¬å‹™: Managerå‚ç…§ä¿å­˜ãƒ»ä¾å­˜é–¢ä¿‚ç¢ºç«‹ãƒ»åˆæœŸåŒ–æº–å‚™
```

### ğŸš« Injection Anti-Patterns
- **Silent Fallback**: Managerä¸è¶³ã‚’æš—é»™è£œå®Œ â†’ **FORBIDDEN**
- **Direct Global Access**: window.Tegakiç›´æ¥å‚ç…§ â†’ **FORBIDDEN**
- **Circular Injection**: Aâ†’Bã€Bâ†’A ã®åŒæ–¹å‘æ³¨å…¥ â†’ **FORBIDDEN**
- **Late Binding**: ä½¿ç”¨æ™‚ã®Manageræ¢ç´¢ â†’ **FORBIDDEN**

---

## ğŸ“‹ **Contract 3: Event Flowï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå¥‘ç´„ï¼‰**

### ğŸ® Pointer Event Contract
```
DOM Event â†’ bootstrapå±¤ â†’ CoordinateManager â†’ ToolManager â†’ ActiveTool
    â†“            â†“              â†“               â†“           â†“
  raw event  åº§æ¨™æ­£è¦åŒ–    Canvasåº§æ¨™å¤‰æ›   Toolé¸æŠ    æç”»å®Ÿè¡Œ
```

### ğŸ“ Event Processing Rules
1. **DOM Binding**: app.viewï¼ˆcanvasè¦ç´ ï¼‰ã®ã¿ãƒ»passive:falseå¿…é ˆ
2. **Coordinate Normalization**: clientX/Yç›´æ¥ä½¿ç”¨ç¦æ­¢ãƒ»CoordinateManagerå¿…é ˆçµŒç”±
3. **Tool Delegation**: ToolManager â†’ ActiveTool ã¸ã®å§”è­²å‡¦ç†
4. **Event Lifecycle**: onPointerDown â†’ onPointerMove* â†’ onPointerUp ã®é †åºä¿è¨¼

### ğŸš¨ Event Violations
- clientX/Yç›´æ¥å‚ç…§ â†’ **CONTRACT VIOLATION**
- DOMä»¥å¤–ã¸ã®ç›´æ¥ãƒã‚¤ãƒ³ãƒ‰ â†’ **CONTRACT VIOLATION**
- ã‚¤ãƒ™ãƒ³ãƒˆé †åºã®éä¿è¨¼ â†’ **CONTRACT VIOLATION**
- åº§æ¨™å¤‰æ›ã®é‡è¤‡é©ç”¨ â†’ **CONTRACT VIOLATION**

---

## ğŸ“‹ **Contract 4: Coordinate Systemï¼ˆåº§æ¨™å¥‘ç´„ï¼‰**

### ğŸ“ åº§æ¨™å¤‰æ›ãƒã‚§ãƒ¼ãƒ³ï¼ˆå³æ ¼ï¼‰
```
DOMåº§æ¨™(clientX/Y) â†’ CoordinateManager.toCanvasCoords() â†’ Canvasåº§æ¨™(x/y)
                              â†“
NavigationManager.worldToView() â†’ Viewåº§æ¨™(è¡¨ç¤ºç”¨)
```

### ğŸ¯ Coordinate Rules
- **Single Source of Truth**: CoordinateManagerãŒå”¯ä¸€ã®åº§æ¨™å¤‰æ›å…ƒ
- **DPR Handling**: devicePixelRatioè£œæ­£ã¯ä¸€åº¦ã®ã¿ãƒ»é‡è¤‡ç¦æ­¢
- **Precision Control**: å°æ•°ç‚¹ä»¥ä¸‹2æ¡å›ºå®šãƒ»ä¸¸ã‚èª¤å·®é˜²æ­¢
- **Bounds Checking**: ã‚­ãƒ£ãƒ³ãƒã‚¹å¢ƒç•Œåˆ¤å®šã¯CoordinateManagerè²¬å‹™

### ğŸš« Coordinate Anti-Patterns
- Toolå†…ã§ã®ç‹¬è‡ªåº§æ¨™è¨ˆç®— â†’ **FORBIDDEN**
- DPRã®é‡è¤‡é©ç”¨ â†’ **FORBIDDEN**
- ç²¾åº¦ã‚’è€ƒæ…®ã—ãªã„åº§æ¨™æ“ä½œ â†’ **FORBIDDEN**
- å¢ƒç•Œåˆ¤å®šã®é‡è¤‡å®Ÿè£… â†’ **FORBIDDEN**

---

## ğŸ“‹ **Contract 5: Tool Interfaceï¼ˆãƒ„ãƒ¼ãƒ«å¥‘ç´„ï¼‰**

### ğŸ› ï¸ Tool Required Interface
```javascript
// âœ… AbstractToolç¶™æ‰¿å¿…é ˆãƒ¡ã‚½ãƒƒãƒ‰
class CustomTool extends AbstractTool {
    // å¿…é ˆå®Ÿè£…
    onPointerDown(event) { /* æç”»é–‹å§‹å‡¦ç† */ }
    onPointerMove(event) { /* æç”»ç¶™ç¶šå‡¦ç† */ }
    onPointerUp(event)   { /* æç”»çµ‚äº†å‡¦ç† */ }
    
    // å¿…é ˆå®Ÿè£…
    activate()           { /* ãƒ„ãƒ¼ãƒ«æœ‰åŠ¹åŒ– */ }
    deactivate()         { /* ãƒ„ãƒ¼ãƒ«ç„¡åŠ¹åŒ– */ }
    forceEndDrawing()    { /* å¼·åˆ¶æç”»çµ‚äº†ãƒ»å†ªç­‰æ€§ä¿è¨¼ */ }
    
    // å¿…é ˆå®Ÿè£…
    getState()           { /* ç¾åœ¨çŠ¶æ…‹è¿”å´ */ }
    destroy()            { /* ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾ */ }
}
```

### ğŸ¨ Drawing Operation Contract
```
startOperation() â†’ addPoint() â†’ addPoint() â†’ ... â†’ endOperation()
     â†“               â†“            â†“                      â†“
RecordManager    åº§æ¨™è¿½åŠ     Graphicsæ›´æ–°           TPFç¢ºå®š
```

### ğŸš« Tool Violations
- RecordManagerçµŒç”±ã—ãªã„æç”» â†’ **CONTRACT VIOLATION**
- forceEndDrawing()ã®éå†ªç­‰å®Ÿè£… â†’ **CONTRACT VIOLATION**
- activate/deactivateéå¯¾å¿œ â†’ **CONTRACT VIOLATION**
- çŠ¶æ…‹ç®¡ç†ã®ç›´æ¥æ“ä½œ â†’ **CONTRACT VIOLATION**

---

## ğŸ“‹ **Contract 6: Record Systemï¼ˆè¨˜éŒ²å¥‘ç´„ï¼‰**

### ğŸ“ TPF Operation Contract
```javascript
// âœ… æ­£è¦TPFæ“ä½œãƒ•ãƒ­ãƒ¼
RecordManager.startOperation(kind, initialPoints?)
    â†“
RecordManager.addPoint(canvasPoint) 
    â†“ (ç¹°ã‚Šè¿”ã—)
RecordManager.endOperation(metadata)
    â†“
TPFStrokeç”Ÿæˆãƒ»å±¥æ­´è¿½åŠ ãƒ»EventBusé€šçŸ¥
```

### ğŸ¯ TPF Data Integrity
- **UUID Uniqueness**: Stroke IDã¯é‡è¤‡ç¦æ­¢ãƒ»UUIDå¿…é ˆ
- **Point Validation**: åº§æ¨™ã¯æ•°å€¤ã®ã¿ãƒ»NaN/null/undefinedç¦æ­¢
- **Metadata Required**: meta ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¿…é ˆãƒ»çœç•¥ç¦æ­¢
- **Kind Strict**: 'stroke'|'erase'ã®ã¿è¨±å¯ãƒ»æ–‡å­—åˆ—å³å¯†

### ğŸš« Record Violations
- ç›´æ¥TPFStrokeç”Ÿæˆ â†’ **CONTRACT VIOLATION**
- RecordManagerçµŒç”±ã—ãªã„å±¥æ­´æ“ä½œ â†’ **CONTRACT VIOLATION**
- TPFæ§‹é€ ã®éƒ¨åˆ†å¤‰æ›´ â†’ **CONTRACT VIOLATION**
- ä¸å®Œå…¨ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ â†’ **CONTRACT VIOLATION**

---

## ğŸ“‹ **Contract 7: Error Handlingï¼ˆã‚¨ãƒ©ãƒ¼å¥‘ç´„ï¼‰**

### ğŸš¨ Error Level Contract
```
CRITICAL â†’ throw Error       // åˆæœŸåŒ–å¤±æ•—ãƒ»ã‚¢ãƒ—ãƒªç¶™ç¶šä¸å¯
ERROR    â†’ return false      // å‡¦ç†å¤±æ•—ãƒ»å›å¾©å¯èƒ½ãƒ»ãƒ­ã‚°å¿…é ˆ
WARNING  â†’ console.warn      // ä¸€æ™‚çš„å•é¡Œãƒ»ç¶™ç¶šå¯èƒ½
INFO     â†’ console.log       // æ­£å¸¸å‹•ä½œæƒ…å ±ãƒ»é–‹ç™ºç”¨
DEBUG    â†’ console.debug     // è©³ç´°ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ»æœ¬ç•ªéå‡ºåŠ›
```

### ğŸ¯ Error Response Rules
- **Fast Fail**: è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã¯å³åº§ã«throwãƒ»éš è”½ç¦æ­¢
- **Graceful Degradation**: å¯èƒ½ãªå ´åˆã®ã¿ãƒ»å¿…ãšãƒ­ã‚°å‡ºåŠ›
- **Error Context**: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯ååˆ†ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ä»˜ä¸
- **Recovery Path**: ã‚¨ãƒ©ãƒ¼å¾Œã®å›å¾©æ‰‹é †ã‚’æ˜ç¤º

### ğŸš« Error Anti-Patterns
- Silent Error Swallow â†’ **FORBIDDEN**
- æœªå®šç¾©ã‚¨ãƒ©ãƒ¼ã®ç„¡è¦– â†’ **FORBIDDEN**
- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¸æ˜ãªã‚¨ãƒ©ãƒ¼ â†’ **FORBIDDEN**
- ã‚¨ãƒ©ãƒ¼å¾Œã®æš—é»™ç¶™ç¶š â†’ **FORBIDDEN**

---

## ğŸ“‹ **Contract 8: Performanceï¼ˆæ€§èƒ½å¥‘ç´„ï¼‰**

### âš¡ Performance Targets
- **Frame Rate**: 60FPSç¶­æŒãƒ»16msä»¥å†…å‡¦ç†å®Œäº†
- **Memory Usage**: æç”»å¾Œã®å³åº§è§£æ”¾ãƒ»ãƒªãƒ¼ã‚¯ç¦æ­¢
- **Startup Time**: 500msä»¥å†…åˆæœŸåŒ–å®Œäº†ãƒ»é…å»¶æœ€å°åŒ–  
- **Response Time**: ãƒã‚¤ãƒ³ã‚¿ãƒ¼å…¥åŠ›ã‹ã‚‰æç”»ã¾ã§50msä»¥å†…

### ğŸ¯ Optimization Rules
- **RAF Usage**: é‡ã„å‡¦ç†ã¯requestAnimationFrameå†…ã§å®Ÿè¡Œ
- **Object Pooling**: å¤§é‡ä½œæˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ãƒ—ãƒ¼ãƒ«æ´»ç”¨
- **Lazy Loading**: ä½¿ç”¨æ™‚ãƒ­ãƒ¼ãƒ‰ãƒ»åˆæœŸåŒ–ã‚³ã‚¹ãƒˆå‰Šæ¸›
- **Cleanup Required**: deactivate/destroyæ™‚ã®ç¢ºå®Ÿãªãƒªã‚½ãƒ¼ã‚¹è§£æ”¾

### ğŸš« Performance Violations
- 16msè¶…éå‡¦ç† â†’ **CONTRACT VIOLATION**
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ â†’ **CONTRACT VIOLATION**
- ä¸è¦ãªå†è¨ˆç®— â†’ **CONTRACT VIOLATION**  
- ãƒªã‚½ãƒ¼ã‚¹æœªè§£æ”¾ â†’ **CONTRACT VIOLATION**

---

## ğŸ“‹ **Contract 9: Testingï¼ˆãƒ†ã‚¹ãƒˆå¥‘ç´„ï¼‰**

### ğŸ§ª Required Testing Interface
```javascript
// âœ… å…¨Managerãƒ»Toolå¿…é ˆå®Ÿè£…
class SomeManager {
    getDebugInfo() { /* ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¿”å´ */ }
    isReady() { /* æº–å‚™çŠ¶æ…‹è¿”å´ */ }
    resetForTesting() { /* ãƒ†ã‚¹ãƒˆç”¨ãƒªã‚»ãƒƒãƒˆ */ }
}
```

### ğŸ¯ Testing Standards
- **Debug Info**: ç¾åœ¨çŠ¶æ…‹ãƒ»ä¾å­˜é–¢ä¿‚ãƒ»ã‚¨ãƒ©ãƒ¼å±¥æ­´ã‚’å«ã‚€
- **Ready State**: isReady()ã§æ­£ç¢ºãªæº–å‚™çŠ¶æ…‹è¿”å´
- **Test Reset**: ãƒ†ã‚¹ãƒˆé–“ã§ã®çŠ¶æ…‹å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
- **Error Simulation**: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹å†ç¾æ©Ÿèƒ½

### ğŸš« Testing Violations
- getDebugInfo()æœªå®Ÿè£… â†’ **CONTRACT VIOLATION**
- isReady()ã®ä¸æ­£ç¢ºãªè¿”å´ â†’ **CONTRACT VIOLATION**
- ãƒ†ã‚¹ãƒˆé–“çŠ¶æ…‹ãƒªãƒ¼ã‚¯ â†’ **CONTRACT VIOLATION**
- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ä¸è¶³ â†’ **CONTRACT VIOLATION**

---

## ğŸ“‹ **Contract 10: Architectural Boundariesï¼ˆå¢ƒç•Œå¥‘ç´„ï¼‰**

### ğŸ—ï¸ Layer Boundaries
```
UI Layer (icons.js) â† EventBus â†’ AppCore Layer (app-core.js)
                                      â†“
                               Manager Layer (å„Manager)
                                      â†“  
                               Tool Layer (AbstractToolç¶™æ‰¿)
                                      â†“
                              Graphics Layer (PixiJS v8)
```

### ğŸ¯ Boundary Rules
- **Layer Skip Prohibition**: å±¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
- **Upward Communication**: ä¸‹ä½å±¤ã‹ã‚‰ä¸Šä½å±¤ã¸ã¯EventBusã®ã¿
- **Downward Injection**: ä¸Šä½å±¤ã‹ã‚‰ä¸‹ä½å±¤ã¸ã¯ä¾å­˜æ³¨å…¥ã®ã¿
- **Peer Communication**: åŒå±¤é–“ã®ç›´æ¥é€šä¿¡ç¦æ­¢

### ğŸš« Boundary Violations
- UIå±¤ã‹ã‚‰Managerç›´æ¥æ“ä½œ â†’ **ARCHITECTURAL VIOLATION**
- Toolå±¤ã‹ã‚‰AppCoreç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ â†’ **ARCHITECTURAL VIOLATION**
- Manageré–“ã®ç›¸äº’ç›´æ¥å‘¼ã³å‡ºã— â†’ **ARCHITECTURAL VIOLATION**
- æš—é»™çš„ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ â†’ **ARCHITECTURAL VIOLATION**

---

## ğŸ“‹ **Contract 11: Global Namespaceï¼ˆåå‰ç©ºé–“å¥‘ç´„ï¼‰**

### ğŸŒ Namespace Structure Contract
```javascript
window.Tegaki = {
    // Manager Instancesï¼ˆInstanceæ¥å°¾è¾å¿…é ˆï¼‰
    CanvasManagerInstance: CanvasManager,
    ToolManagerInstance: ToolManager,
    
    // Tool Classesï¼ˆTools.é…ä¸‹å¿…é ˆï¼‰  
    Tools: {
        AbstractTool: AbstractTool,
        PenTool: PenTool,
        EraserTool: EraserTool
    },
    
    // Application Core
    TegakiApplicationInstance: TegakiApplication,
    AppCoreInstance: AppCore
};
```

### ğŸ¯ Naming Rules
- **Manager Instance**: `[ClassName]Instance` å½¢å¼å¿…é ˆ
- **Tool Classes**: `Tools.[ClassName]` éšå±¤å¿…é ˆ
- **Constants**: `Constants.[CONSTANT_NAME]` å¤§æ–‡å­—å¿…é ˆ
- **Case Consistency**: PascalCase(ã‚¯ãƒ©ã‚¹)ãƒ»camelCase(ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹)å³å®ˆ

### ğŸš« Namespace Violations
- Instanceæ¥å°¾è¾ãªã—Managerç™»éŒ² â†’ **NAMING VIOLATION**
- Toolséšå±¤å¤–ã®Toolç™»éŒ² â†’ **NAMING VIOLATION**
- camelCase/PascalCaseæ··åœ¨ â†’ **NAMING VIOLATION**
- åå‰ç©ºé–“æ±šæŸ“ â†’ **NAMESPACE VIOLATION**

---

## ğŸ“‹ **Contract 12: PixiJS v8 Integrationï¼ˆv8çµ±åˆå¥‘ç´„ï¼‰**

### ğŸ¨ v8 API Exclusive Usage
```javascript
// âœ… v8æº–æ‹ Graphicsæ“ä½œ
const graphics = new PIXI.Graphics();
graphics.circle(x, y, radius).fill(color);        // v8æ–°API
graphics.roundRect(x, y, w, h, radius).stroke({   // v8æ–°API
    color: 0xff0000, 
    width: 2 
});

// ğŸš« v7äº’æ›APIä½¿ç”¨ç¦æ­¢
graphics.beginFill(color);                        // v7å»ƒæ­¢
graphics.drawCircle(x, y, radius);                // v7å»ƒæ­¢  
graphics.endFill();                               // v7å»ƒæ­¢
```

### ğŸ¯ v8 Container Hierarchy
```
Application.stage
â”œâ”€â”€ backgroundContainer (èƒŒæ™¯ãƒ»ã‚°ãƒªãƒƒãƒ‰)
â”œâ”€â”€ drawContainer (ãƒ¡ã‚¤ãƒ³æç”»ãƒ»Toolå¯¾è±¡)
â”‚   â”œâ”€â”€ layerContainer[0] (default layer)
â”‚   â””â”€â”€ tempStrokeContainer (ä¸€æ™‚æç”»)
â”œâ”€â”€ uiContainer (UIè¦ç´ )
â””â”€â”€ debugContainer (é–‹ç™ºç”¨)
```

### ğŸš« v8 Integration Violations
- v7 APIä½¿ç”¨ â†’ **VERSION VIOLATION**
- Containeréšå±¤ç„¡è¦– â†’ **ARCHITECTURE VIOLATION**
- WebGPU/WebGLæ··åœ¨å¯¾å¿œ â†’ **COMPLEXITY VIOLATION**
- v8ç‰¹æ€§æœªæ´»ç”¨ â†’ **PERFORMANCE VIOLATION**

---

## ğŸ“‹ **Contract 13: File Headerï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å¥‘ç´„ï¼‰**

### ğŸ“ Mandatory Header Tags
```javascript
/**
 * @provides    - å¤–éƒ¨å…¬é–‹ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ã‚¯ãƒ©ã‚¹ï¼ˆå®Ÿè£…æ¸ˆã¿ã®ã¿ï¼‰
 * @uses        - ä»–ãƒ•ã‚¡ã‚¤ãƒ«ä¾å­˜ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå­˜åœ¨ç¢ºèªæ¸ˆã¿ã®ã¿ï¼‰
 * @initflow    - åˆæœŸåŒ–é †åºï¼ˆç•ªå·ä»˜ãå¿…é ˆï¼‰
 * @forbids     - ç¦æ­¢äº‹é …ï¼ˆæœ€ä½é™5é …ç›®å¿…é ˆï¼‰
 * @manager-key - ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²ã‚­ãƒ¼ï¼ˆå®Ÿè£…ã¨å®Œå…¨ä¸€è‡´ï¼‰
 * @dependencies-strict - REQUIRED/OPTIONAL/FORBIDDENåˆ†é¡
 * @integration-flow    - ä¸Šä½ã‹ã‚‰ã®å‘¼ã³å‡ºã—çµŒè·¯
 * @method-naming-rules - APIå‘½åè¦å‰‡éµå®ˆ
 */
```

### ğŸ¯ Header Quality Rules
- **Accuracy**: å®Ÿè£…ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®Œå…¨ä¸€è‡´
- **Completeness**: å¿…é ˆã‚¿ã‚°ã®å®Œå…¨è¨˜è¼‰
- **Consistency**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§ã®ç”¨èªçµ±ä¸€
- **Traceability**: å¤‰æ›´å±¥æ­´ã®æ˜ç¢ºãªè¨˜éŒ²

### ğŸš« Header Violations
- æœªå®Ÿè£…ãƒ¡ã‚½ãƒƒãƒ‰ã®@providesè¨˜è¼‰ â†’ **DOCUMENTATION VIOLATION**
- å­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰ã®@usesè¨˜è¼‰ â†’ **INTEGRATION VIOLATION**
- @manager-keyã¨å®Ÿè£…ã®ä¸ä¸€è‡´ â†’ **REGISTRY VIOLATION**
- å¿…é ˆã‚¿ã‚°ã®æ¬ è½ â†’ **COMPLIANCE VIOLATION**

---

## ğŸ“‹ **Contract 14: Memory Managementï¼ˆãƒ¡ãƒ¢ãƒªå¥‘ç´„ï¼‰**

### ğŸ§¹ Resource Lifecycle
```
acquire â†’ use â†’ release â†’ verify
   â†“       â†“       â†“        â†“
ãƒªã‚½ãƒ¼ã‚¹å–å¾— â†’ åˆ©ç”¨ â†’ æ˜ç¤ºçš„è§£æ”¾ â†’ ãƒªãƒ¼ã‚¯æ¤œè¨¼
```

### ğŸ¯ Memory Rules
- **Explicit Cleanup**: destroy()/dispose()ã§ã®æ˜ç¤ºçš„è§£æ”¾
- **Event Listener Cleanup**: addEventListenerå¾Œã®ç¢ºå®ŸãªremoveEventListener
- **Graphics Cleanup**: PixiJS Graphics/Container ã® destroy()å®Ÿè¡Œ
- **Reference Cleanup**: å¾ªç’°å‚ç…§å›é¿ãƒ»nullä»£å…¥

### ğŸš« Memory Violations
- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼æœªè§£æ”¾ â†’ **MEMORY LEAK**
- Graphics/Containeræœªç ´æ£„ â†’ **MEMORY LEAK**
- å¾ªç’°å‚ç…§ä½œæˆ â†’ **MEMORY LEAK**
- WeakMapæœªæ´»ç”¨ï¼ˆè©²å½“æ™‚ï¼‰ â†’ **MEMORY LEAK**

---

## ğŸ“‹ **Contract 15: External Dependencyï¼ˆå¤–éƒ¨ä¾å­˜å¥‘ç´„ï¼‰**

### ğŸ“¦ Approved Dependencies
- **PixiJS v8.12.0**: æç”»ã‚¨ãƒ³ã‚¸ãƒ³ãƒ»WebGPU/WebGLå¯¾å¿œ
- **Browser APIs**: DOMãƒ»Canvasãƒ»Pointer Eventsãƒ»localStorage

### ğŸš« Forbidden Dependencies
- **Build Tools**: Viteãƒ»TypeScriptãƒ»Webpackãƒ»ESM bundlers
- **Framework**: Reactãƒ»Vueãƒ»Angularãƒ»jQuery
- **Polyfills**: babelãƒ»core-jsãƒ»Legacy browser support
- **CDN**: å¤–éƒ¨CDNãƒ»ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆé–‹ç™ºæ™‚é™¤ãï¼‰

### ğŸ¯ Dependency Rules
- **Vanilla JavaScript**: ES2023æº–æ‹ ãƒ»ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ–ãƒ©ã‚¦ã‚¶APIå„ªå…ˆ
- **Direct Loading**: HTML script tagã«ã‚ˆã‚‹ç›´æ¥èª­ã¿è¾¼ã¿
- **No Transpilation**: å‹•çš„å¤‰æ›ãªã—ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ç›´æ¥å®Ÿè¡Œ
- **Offline Capable**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç„¡ã—ã§ã‚‚åŸºæœ¬æ©Ÿèƒ½å‹•ä½œ

---

## ğŸ“Š **Contract Verificationï¼ˆå¥‘ç´„æ¤œè¨¼ï¼‰**

### âœ… Verification Checklist
```
[ ] Manager Lifecycle APIå®Ÿè£…å®Œäº†
[ ] Dependency Injectionæ­£å¸¸å‹•ä½œ
[ ] Event Flowé †åºä¿è¨¼
[ ] Coordinate Systemå˜ä¸€çµŒè·¯
[ ] Tool Interfaceå®Œå…¨å®Ÿè£…
[ ] Record System TPFæº–æ‹ 
[ ] Error Handlingé©åˆ‡åˆ†é¡
[ ] Performance Targeté”æˆ
[ ] Testing Interfaceå®Œå‚™
[ ] Architectural Boundaryéµå®ˆ
[ ] Global Namespaceé©åˆ‡
[ ] PixiJS v8 APIé™å®šä½¿ç”¨
[ ] File Headerå®Œå…¨è¨˜è¼‰
[ ] Memory Managementç¢ºå®Ÿ
[ ] External Dependencyæº–æ‹ 
```

### ğŸ¯ Contract Compliance Rating
- **A+**: å…¨Contract 100%éµå®ˆãƒ»å“è³ªä¿è¨¼å®Œäº†
- **A**: ä¸»è¦Contractéµå®ˆãƒ»è»½å¾®é•åã®ã¿
- **B**: é‡è¦Contractéµå®ˆãƒ»æ”¹ä¿®è¦é …ã‚ã‚Š
- **C**: Contracté•åå¤šæ•°ãƒ»è¨­è¨ˆè¦‹ç›´ã—å¿…è¦
- **F**: Contractæ ¹æœ¬é•åãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç ´ç¶»

---

**ğŸ“ é‡è¦æ³¨æ„**: 
- ã“ã®Rulebookã¯ **Design Contract** ã§ã‚ã‚Šã€å®Ÿè£…ä¾‹ãƒ»ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯å«ã¾ãªã„
- å…·ä½“çš„APIä»•æ§˜ãƒ»ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ **Symbol Dictionary** ã‚’å‚ç…§
- Contracté•åã¯è¨­è¨ˆä¸Šã®æ¬ é™¥ã§ã‚ã‚Šã€ç·Šæ€¥ä¿®æ­£å¯¾è±¡ã¨ã™ã‚‹
- Phaseé€²åŒ–æ™‚ã‚‚Contractå®‰å®šæ€§ã‚’æœ€å„ªå…ˆã¨ã™ã‚‹

**ğŸ¯ æˆåŠŸåŸºæº–**: å…¨Contractéµå®ˆã«ã‚ˆã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®‰å®šæ€§ç¢ºä¿
**ğŸš« ç¦æ­¢äº‹é …**: Contractè¿‚å›ãƒ»æš—é»™ä¿®æ­£ãƒ»è¤‡é›‘åŒ–ã«ã‚ˆã‚‹å•é¡Œéš è”½
---

**ğŸ“ é‡è¦**: ã“ã®Rulebookã¯æ’ä¹…çš„æŒ‡é‡ã§ã‚ã‚Šã€æŠ€è¡“å¤‰æ›´ã«å¿œã˜ã¦æœ€å°é™ã®æ”¹è¨‚ã®ã¿è¡Œã†  
**ğŸ¯ åŸå‰‡**: ã‚·ãƒ³ãƒ—ãƒ«ãƒ»é«˜å“è³ªãƒ»éç ´å£Šãƒ»æ‹¡å¼µæ€§ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚’ä¸€è²«ã—ã¦è¿½æ±‚  
**ğŸš« ç¦å¿Œ**: ç†å¿µå¤‰æ›´ãƒ»è¤‡é›‘åŒ–ãƒ»å“è³ªå¦¥å”ãƒ»ä¾å­˜å¢—åŠ ã¯çµ¶å¯¾å›é¿
**ğŸ’€ åŸºæœ¬åŸå‰‡**: é‡è¤‡ã‚„éåº¦ãªä¿è­·ã§è‚¥å¤§åŒ–ã—ãŸæ€ªç‰©ã‚³ãƒ¼ãƒ‰æ’²æ»…ã‚’å…¨Phaseé€šã—ã¦ç¶™ç¶š