# Phase 2 Step 2.1 - originalPointså°å…¥è¨ˆç”»

## ğŸ¯ ç›®çš„

Transformé©ç”¨æ™‚ã«å…ƒã®pointsé…åˆ—ã‚’ä¿è­·ã—ã€éç ´å£Šçš„ãªå¤‰æ›ã‚’å®Ÿç¾ã™ã‚‹ã€‚

---

## ğŸ“Š ç¾åœ¨ã®å•é¡Œ

### å•é¡Œ1: TransformãŒå…ƒãƒ‡ãƒ¼ã‚¿ã‚’ç ´å£Š

```javascript
// âŒ ç¾åœ¨ã®å®Ÿè£…ï¼ˆç ´å£Šçš„ï¼‰
function applyTransform(path, transform) {
    path.points.forEach(point => {
        point.x = point.x * transform.scaleX + transform.x;
        point.y = point.y * transform.scaleY + transform.y;
    });
    // å…ƒã®pointsãŒå¤±ã‚ã‚Œã‚‹ï¼
}
```

### å•é¡Œ2: Transformè§£é™¤æ™‚ã«å…ƒã«æˆ»ã›ãªã„

```javascript
// âŒ å…ƒã®åº§æ¨™ãŒå¤±ã‚ã‚Œã¦ã„ã‚‹ãŸã‚å¾©å…ƒä¸å¯èƒ½
function resetTransform(path) {
    // ã©ã†ã‚„ã£ã¦å…ƒã«æˆ»ã™ï¼Ÿ
}
```

---

## âœ… è§£æ±ºç­–: originalPointså°å…¥

### æ–°ã—ã„Pathæ§‹é€ 

```javascript
Path {
    id: string,
    points: Point[],         // Transformé©ç”¨å¾Œï¼ˆæç”»ç”¨ï¼‰
    originalPoints: Point[], // Transformå‰ï¼ˆæ°¸ç¶šãƒ‡ãƒ¼ã‚¿ï¼‰
    size: number,
    color: number,
    opacity: number,
    tool: string,
    isComplete: boolean
}
```

### å‹•ä½œåŸç†

```javascript
// âœ… éç ´å£Šçš„ãªTransformé©ç”¨
function applyTransform(path, transform) {
    // originalPointsã‚’åŸºæº–ã«å¤‰æ›
    const basePoints = path.originalPoints || path.points;
    
    // æ–°ã—ã„pointsé…åˆ—ã‚’ç”Ÿæˆ
    const transformedPoints = basePoints.map(p => ({
        x: p.x * transform.scaleX + transform.x,
        y: p.y * transform.scaleY + transform.y
    }));
    
    return {
        ...path,
        points: transformedPoints,      // æç”»ç”¨
        originalPoints: basePoints      // ä¿æŒ
    };
}
```

---

## ğŸ”§ å®Ÿè£…å†…å®¹

### 1. AnimationSystemã®æ”¹ä¿®

#### 1-1. Pathç”Ÿæˆæ™‚ã«originalPointsã‚’è¨­å®š

```javascript
// copyCurrentLayersToIndependentState()å†…
const independentPaths = originalLayer.layerData.paths.map(path => {
    const points = DataUtils.deepClone(path.points);
    
    return {
        id: 'path_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        points: points,
        originalPoints: DataUtils.deepClone(points), // â˜…è¿½åŠ 
        size: path.size || 16,
        color: path.color || 0x800000,
        opacity: path.opacity || 1.0,
        tool: path.tool || 'pen',
        isComplete: true
    };
});
```

#### 1-2. Pathå†æ§‹ç¯‰æ™‚ã«originalPointsã‚’ä¿æŒ

```javascript
// rebuildPathFromData()å†…
return {
    id: pathData.id,
    points: DataUtils.deepClone(pathData.points),
    originalPoints: DataUtils.deepClone(pathData.originalPoints || pathData.points), // â˜…è¿½åŠ 
    size: pathData.size || 16,
    color: pathData.color || 0x800000,
    opacity: pathData.opacity || 1.0,
    tool: pathData.tool || 'pen',
    graphics: graphics
};
```

### 2. LayerSystemã®æ”¹ä¿®

#### 2-1. Pathè¿½åŠ æ™‚ã«originalPointsã‚’è¨­å®š

æç”»ã‚¨ãƒ³ã‚¸ãƒ³ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹pathã«originalPointsã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯æ¬¡ã®Step 2.2ã§`core-engine.js`ã‚’æ”¹ä¿®ã™ã‚‹éš›ã«å¯¾å¿œã—ã¾ã™ã€‚

#### 2-2. Transformç¢ºå®šæ™‚ã«originalPointsã‚’æ›´æ–°

```javascript
// safeApplyTransformToPaths()å†…
// Transformç¢ºå®šæ™‚ã¯ã€transformedPointsã‚’æ–°ã—ã„originalPointsã¨ã—ã¦ä¿å­˜
const transformedPath = {
    id: path.id,
    points: transformedPoints,
    originalPoints: transformedPoints, // â˜…ç¢ºå®šæ™‚ã¯åŒã˜å€¤
    size: path.size,
    color: path.color,
    opacity: path.opacity,
    tool: path.tool,
    isComplete: path.isComplete || true,
    graphics: null
};
```

### 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°

æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç”¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã‚’è¿½åŠ ï¼š

```javascript
/**
 * æ—¢å­˜Pathãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
 */
migratePathData(path) {
    if (!path.originalPoints && path.points) {
        path.originalPoints = DataUtils.deepClone(path.points);
    }
    return path;
}

/**
 * CUTå…¨ä½“ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
 */
migrateCutData(cut) {
    if (!cut || !cut.layers) return cut;
    
    cut.layers.forEach(layer => {
        if (layer.paths && Array.isArray(layer.paths)) {
            layer.paths = layer.paths.map(path => this.migratePathData(path));
        }
    });
    
    return cut;
}
```

---

## ğŸ“ æ”¹ä¿®ãŒå¿…è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§

### AnimationSystem
- [x] `copyCurrentLayersToIndependentState()` - originalPointsè¿½åŠ 
- [x] `rebuildPathFromData()` - originalPointsä¿æŒ
- [x] `migratePathData()` - æ–°è¦è¿½åŠ 
- [x] `migrateCutData()` - æ–°è¦è¿½åŠ 

### LayerSystem
- [ ] `addPathToLayer()` - æ¬¡ã®Stepã§å¯¾å¿œ
- [x] `safeApplyTransformToPaths()` - originalPointsæ›´æ–°

### CoreEngineï¼ˆæ¬¡ã®Stepã§å¯¾å¿œï¼‰
- [ ] æç”»å®Œäº†æ™‚ã®Pathç”Ÿæˆã§originalPointsè¿½åŠ 

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### ãƒ†ã‚¹ãƒˆ1: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```javascript
// æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆoriginalPointsãªã—ï¼‰
const oldPath = {
    id: 'path1',
    points: [{ x: 10, y: 20 }, { x: 30, y: 40 }],
    size: 16
};

// ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
const migrated = animationSystem.migratePathData(oldPath);

console.assert(
    migrated.originalPoints.length === migrated.points.length,
    'Migration failed'
);
console.log('âœ… Migration test passed');
```

### ãƒ†ã‚¹ãƒˆ2: Transforméç ´å£Š

```javascript
// Transformé©ç”¨
const path = {
    points: [{ x: 10, y: 20 }],
    originalPoints: [{ x: 10, y: 20 }]
};

const transform = { x: 5, y: 5, scaleX: 2, scaleY: 2 };
const transformed = applyTransform(path, transform);

// originalPointsã¯å¤‰æ›´ã•ã‚Œã¦ã„ãªã„
console.assert(
    transformed.originalPoints[0].x === 10,
    'originalPoints was modified'
);

// pointsã¯å¤‰æ›ã•ã‚Œã¦ã„ã‚‹
console.assert(
    transformed.points[0].x === 25, // 10 * 2 + 5
    'Transform not applied'
);

console.log('âœ… Non-destructive transform test passed');
```

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å¢—åŠ 

`originalPoints`ã‚’ä¿æŒã™ã‚‹ãŸã‚ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒç´„2å€ã«ãªã‚Šã¾ã™ã€‚

**å¯¾ç­–**: 
- Transformã—ã¦ã„ãªã„pathã¯`originalPoints`ã‚’çœç•¥å¯èƒ½
- ç¢ºå®šæ™‚ã¯`originalPoints`ã‚’å‰Šé™¤å¯èƒ½

### 2. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®äº’æ›æ€§

æ—¢å­˜ã®CUTãƒ‡ãƒ¼ã‚¿ã«ã¯`originalPoints`ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

**å¯¾ç­–**:
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã‚’ç”¨æ„
- èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### 3. æç”»ã‚¨ãƒ³ã‚¸ãƒ³ã¨ã®æ•´åˆæ€§

æç”»å®Œäº†æ™‚ã«ç”Ÿæˆã•ã‚Œã‚‹pathã«`originalPoints`ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**å¯¾ç­–**:
- Phase 2 Step 2.3ã§`core-engine.js`ã‚’æ”¹ä¿®

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

Step 2.1å®Œäº†å¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªï¼š

1. âœ… AnimationSystemã«originalPointså¯¾å¿œè¿½åŠ 
2. âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°è¿½åŠ 
3. â³ LayerSystem Transformç¢ºå®šå‡¦ç†ã®æ”¹ä¿®ï¼ˆã“ã®Stepå†…ï¼‰
4. â³ æç”»ã‚¨ãƒ³ã‚¸ãƒ³å¯¾å¿œï¼ˆæ¬¡ã®Stepï¼‰

---

## ğŸ“‹ Step 2.1 å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] AnimationSystemã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°è¿½åŠ 
- [ ] Pathç”Ÿæˆæ™‚ã«originalPointsè¨­å®š
- [ ] Pathå†æ§‹ç¯‰æ™‚ã«originalPointsä¿æŒ
- [ ] LayerSystem Transformç¢ºå®šæ™‚ã®å‡¦ç†æ”¹ä¿®
- [ ] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- [ ] æ—¢å­˜CUTã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª

---

æ¬¡ã®artifactã§å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’æä¾›ã—ã¾ã™ã€‚