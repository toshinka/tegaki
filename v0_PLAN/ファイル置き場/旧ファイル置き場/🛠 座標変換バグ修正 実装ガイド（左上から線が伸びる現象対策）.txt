# ğŸ›  åº§æ¨™å¤‰æ›ãƒã‚°ä¿®æ­£ å®Ÿè£…ã‚¬ã‚¤ãƒ‰ï¼ˆå·¦ä¸Šã‹ã‚‰ç·šãŒä¼¸ã³ã‚‹ç¾è±¡å¯¾ç­–ï¼‰

## ğŸ¯ æ¦‚è¦

ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ã€ãƒšãƒ³æç”»æ™‚ã«å·¦ä¸Šï¼ˆ0,0ï¼‰ã‹ã‚‰æ„å›³ã—ãªã„ç›´ç·šãŒæç”»ã•ã‚Œã‚‹åº§æ¨™å¤‰æ›ãƒã‚°ã®ä¿®æ­£æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ” å•é¡Œã®åŸå› 

### 1. `canvasRect` æ¸¡ã—å¿˜ã‚Œ/ä¸æ•´åˆ
- `screenToCanvas` å¤‰æ›æ™‚ã« `canvasRect` ãŒ `null` ã‚„å¤ã„å€¤
- `screenX - canvasRect.left` ãŒ `NaN` ã«ãªã‚Šã€å¼·åˆ¶çš„ã« `(0,0)` ã«è£œæ­£ã•ã‚Œã‚‹

### 2. PixiJS ã®åº§æ¨™å¤‰æ›åˆæœŸå€¤
- `stage.scale` ã‚„ `stage.position` ã®åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ãšã‚Œ
- `pixiCoords` ãŒ `null` ã§å‡¦ç†ã•ã‚Œã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ `(0,0)` ãŒä½¿ç”¨ã•ã‚Œã‚‹

### 3. åˆå›ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®èª¤ç™»éŒ²
- `coordinateCache` ã« `(0,0)` ãŒä¿å­˜ã•ã‚Œã‚‹
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆã§å¾Œç¶šã‚‚èª¤åº§æ¨™ã‚’è¿”ã™

## âœ… ä¿®æ­£æ‰‹é †

### Step 1: CoordinateManager ã®ç½®ãæ›ãˆ

å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«: `js/utils/coordinate-manager.js`

```javascript
// å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Œå…¨ã«ç½®ãæ›ãˆ
// æ–°ã—ã„CoordinateManagerã«ã¯ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ï¼š
// - screenToCanvasSafe() / canvasToPixiSafe() å®‰å…¨ç‰ˆãƒ¡ã‚½ãƒƒãƒ‰
// - (0,0)åº§æ¨™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥é˜²æ­¢
// - ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å¼·åŒ–
// - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
```

### Step 2: CanvasManager ã®æ›´æ–°

å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«: `managers/canvas-manager.js`

```javascript
// ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä¿®æ­£ç‰ˆã«æ›´æ–°ï¼š
// - handlePointerDownWithCoordinateIntegrationFixed()
// - handlePointerMoveWithCoordinateIntegrationFixed() 
// - handlePointerUpWithCoordinateIntegrationFixed()
// - getUnifiedCanvasCoordinatesFixed()
```

### Step 3: ToolManager ã®æ›´æ–°

å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«: `managers/tool-manager.js`

```javascript
// æç”»å‡¦ç†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿®æ­£ï¼š
// - extractPointerCoordinatesSafe()
// - startDrawing() / continueDrawing() ã®eventå¼•æ•°å¯¾å¿œ
// - canvasElementå‚ç…§ã®è¨­å®š
```

## ğŸ”§ ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ

### 1. canvasRectæ¯å›å–å¾—ï¼ˆå¿…é ˆï¼‰

```javascript
// âŒ æ‚ªã„ä¾‹ï¼ˆãƒã‚°ã®åŸå› ï¼‰
const canvasRect = this.cachedCanvasRect; // å¤ã„å€¤ã‚„nullã®å¯èƒ½æ€§

// âœ… è‰¯ã„ä¾‹ï¼ˆä¿®æ­£å¾Œï¼‰
const canvasRect = this.canvasElement.getBoundingClientRect(); // æ¯å›å–å¾—
```

### 2. åº§æ¨™ã®å¦¥å½“æ€§ç¢ºèªå¼·åŒ–

```javascript
// âœ… ä¿®æ­£å¾Œã®ç¢ºèªå‡¦ç†
if (canvasX === 0 && canvasY === 0 && (screenX > canvasRect.left + 10 || screenY > canvasRect.top + 10)) {
    console.warn('âš ï¸ ç•°å¸¸ãª(0,0)åº§æ¨™ã‚’æ¤œå‡º');
    throw new Error('ç•°å¸¸ãª(0,0)åº§æ¨™å¤‰æ›ã‚’æ¤œå‡º');
}
```

### 3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç™»éŒ²ã®é˜²å¾¡

```javascript
// âœ… ä¿®æ­£å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‡¦ç†
if (canvasCoords.x === 0 && canvasCoords.y === 0) {
    console.warn("âš ï¸ (0,0)åº§æ¨™ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã›ã‚“", canvasCoords);
    return; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„
}
this.saveToCacheWithCleanup(cacheKey, coordinateData);
```

### 4. PixiJSåº§æ¨™å¤‰æ›ã®å®‰å…¨åŒ–

```javascript
// âœ… ä¿®æ­£å¾Œã®PixiJSå¤‰æ›
const scale = pixiApp.stage.scale || { x: 1, y: 1 };
const position = pixiApp.stage.position || { x: 0, y: 0 };

if (!scale || !position || scale.x === 0 || scale.y === 0) {
    return { x: canvasX, y: canvasY }; // fallback
}
```

## ğŸš€ å®Ÿè£…æ–¹æ³•

### 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®ç½®ãæ›ãˆ

1. `js/utils/coordinate-manager.js` ã‚’æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ç½®ãæ›ãˆ
2. `managers/canvas-manager.js` ã‚’ä¿®æ­£ç‰ˆã«ç½®ãæ›ãˆ  
3. `managers/tool-manager.js` ã‚’ä¿®æ­£ç‰ˆã«ç½®ãæ›ãˆ

### 2. åˆæœŸåŒ–ã®æ›´æ–°

```javascript
// ToolManagerã®åˆæœŸåŒ–æ™‚ã«canvasElementã‚’æ¸¡ã™
const toolManager = new ToolManager();
await toolManager.initialize(canvasElement); // canvasElementå¿…é ˆ

// CanvasManagerã®åˆæœŸåŒ–ã‚‚ç¢ºèª
const canvasManager = new CanvasManager();
await canvasManager.initialize(appCore, canvasElement);
```

### 3. ãƒ‡ãƒãƒƒã‚°ã®å®Ÿè¡Œ

```javascript
// ãƒã‚°ä¿®æ­£çŠ¶æ…‹ã®ç¢ºèª
const coordinateManager = new CoordinateManager();
coordinateManager.runCoordinateBugDiagnosis();

const canvasManager = new CanvasManager();
canvasManager.runCanvasCoordinateBugDiagnosis();

const toolManager = new ToolManager();
toolManager.runToolCoordinateBugDiagnosis();
```

## ğŸ“Š ä¿®æ­£åŠ¹æœã®ç¢ºèª

### 1. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ç¢ºèª

ä¿®æ­£å¾Œã¯ä»¥ä¸‹ã®ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
ğŸ“åº§æ¨™ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›å‰ï¼‰ {screen: {x: 150, y: 200}, canvasRect: {left: 10, top: 50, ...}}
ğŸ“åº§æ¨™ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›å¾Œï¼‰ {screen: {x: 150, y: 200}, canvas: {x: 140, y: 150}, valid: true}
ğŸ¨ CoordinateManagerçµ±åˆæç”»é–‹å§‹: (140.0, 150.0)
```

### 2. çµ±è¨ˆæƒ…å ±ã®ç¢ºèª

```javascript
// CoordinateManagerã®çµ±è¨ˆ
const stats = coordinateManager.getStats();
console.log('ç„¡åŠ¹åº§æ¨™æ¤œå‡ºæ•°:', stats.invalidCoordinateCount);
console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨æ•°:', stats.fallbackUsageCount);

// ã‚¨ãƒ©ãƒ¼ç‡ãŒ10%ä»¥ä¸‹ãªã‚‰æ­£å¸¸
const errorRate = stats.errorCount / stats.conversionCount * 100;
console.log('ã‚¨ãƒ©ãƒ¼ç‡:', errorRate + '%');
```

### 3. ç•°å¸¸åº§æ¨™ã®ç›£è¦–

```javascript
// (0,0)åº§æ¨™ã®ç•°å¸¸æ¤œå‡º
if (coordinates.canvas.x === 0 && coordinates.canvas.y === 0) {
    console.warn('âš ï¸ (0,0)åº§æ¨™æ¤œå‡º - åŸå› ã‚’èª¿æŸ»');
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### 1. åŸºæœ¬çš„ãªæç”»ãƒ†ã‚¹ãƒˆ

1. ãƒšãƒ³ãƒ„ãƒ¼ãƒ«ã‚’é¸æŠ
2. ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç·šã‚’æç”»
3. å·¦ä¸Šã‹ã‚‰ç›´ç·šãŒä¼¸ã³ãªã„ã“ã¨ã‚’ç¢ºèª

### 2. å¢ƒç•Œä»˜è¿‘ã§ã®ãƒ†ã‚¹ãƒˆ

1. ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ç«¯ä»˜è¿‘ã§æç”»
2. ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ãƒªã‚µã‚¤ã‚ºã—ãªãŒã‚‰æç”»
3. åº§æ¨™ãŒæ­£å¸¸ã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### 3. ã‚¨ãƒ©ãƒ¼çŠ¶æ³ã§ã®å®‰å…¨æ€§ãƒ†ã‚¹ãƒˆ

1. `canvasElement` ãŒä¸€æ™‚çš„ã«ç„¡åŠ¹ã«ãªã‚‹çŠ¶æ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
2. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
3. æç”»ãŒå®Œå…¨ã«åœæ­¢ã›ãšã«ç¶™ç¶šã™ã‚‹ã“ã¨ã‚’ç¢ºèª

## âš ï¸ æ³¨æ„äº‹é …

### 1. æ—¢å­˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢

ä¿®æ­£å¾Œã¯åº§æ¨™ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ï¼š

```javascript
coordinateManager.reset(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
```

### 2. ãƒ–ãƒ©ã‚¦ã‚¶ã®äº’æ›æ€§

- `getBoundingClientRect()` ã¯ãƒ¢ãƒ€ãƒ³ãƒ–ãƒ©ã‚¦ã‚¶ã§åˆ©ç”¨å¯èƒ½
- IE11ä»¥é™ã§å‹•ä½œç¢ºèªæ¸ˆã¿

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- `getBoundingClientRect()` ã®æ¯å›å‘¼ã³å‡ºã—ã¯è‹¥å¹²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã™
- ã—ã‹ã—ã€æ­£ç¢ºãªåº§æ¨™å–å¾—ã®ãŸã‚ã«ã¯å¿…é ˆã§ã™
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã«ã‚ˆã‚Šå…¨ä½“çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯ç¶­æŒã•ã‚Œã¾ã™

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q: ã¾ã å·¦ä¸Šã‹ã‚‰ç·šãŒä¼¸ã³ã‚‹

**A:** ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
1. `canvasElement.getBoundingClientRect()` ãŒæ­£ã—ãå‘¼ã°ã‚Œã¦ã„ã‚‹ã‹
2. `CoordinateManager.runCoordinateBugDiagnosis()` ã§ã‚¨ãƒ©ãƒ¼ç‡ã‚’ç¢ºèª
3. ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§åº§æ¨™å¤‰æ›ãƒ­ã‚°ã‚’ç¢ºèª

### Q: æç”»ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹ã—ãŸ

**A:** ä»¥ä¸‹ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ï¼š
1. åº§æ¨™ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚µã‚¤ã‚ºï¼ˆ`cacheMaxSize`ï¼‰ã‚’èª¿æ•´
2. æœ€å°æç”»è·é›¢ï¼ˆ`minDistance`ï¼‰ã‚’èª¿æ•´
3. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ¬ç•ªç’°å¢ƒã§ç„¡åŠ¹åŒ–

### Q: ç‰¹å®šã®ãƒ‡ãƒã‚¤ã‚¹ã§å•é¡ŒãŒç™ºç”Ÿ

**A:** ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š
1. ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã§ã® `pressure` å€¤
2. é«˜DPIãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã§ã®åº§æ¨™ã‚¹ã‚±ãƒ¼ãƒ«
3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹

## ğŸ‰ å®Œäº†ç¢ºèª

ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ä»¥ä¸‹ã‚’ç¢ºèªï¼š

- âœ… å·¦ä¸Šã‹ã‚‰ã®ç›´ç·šãŒè¡¨ç¤ºã•ã‚Œãªã„
- âœ… æ­£å¸¸ãªä½ç½®ã«ãƒšãƒ³æç”»ã•ã‚Œã‚‹  
- âœ… ã‚¨ãƒ©ãƒ¼ç‡ãŒ10%ä»¥ä¸‹
- âœ… ãƒ‡ãƒãƒƒã‚°è¨ºæ–­ã§å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒåˆæ ¼
- âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒé©åˆ‡ã«å‹•ä½œã—ã¦ã„ã‚‹

ã“ã‚Œã§åº§æ¨™å¤‰æ›ãƒã‚°ã®ä¿®æ­£ã¯å®Œäº†ã§ã™ï¼