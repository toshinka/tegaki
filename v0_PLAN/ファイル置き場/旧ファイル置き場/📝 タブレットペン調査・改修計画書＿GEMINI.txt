ğŸ“ èª¿æŸ»ãƒ»æ”¹ä¿®è¨ˆç”»æ›¸
1. ç¾è±¡

ãƒã‚¦ã‚¹ã§ã¯æç”»å¯èƒ½ã ãŒã€ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã•ã‚Œãªã„ã€‚

ãƒšãƒ³ã‚’è¿‘ã¥ã‘ã‚‹ã¨ã‚«ãƒ¼ã‚½ãƒ«ã¯å‹•ãã€UIãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‚‚åå¿œã™ã‚‹ã€‚

ç­†åœ§å€¤ã‚‚å–å¾—ã•ã‚Œãªã„ã€‚

2. æŠ€è¡“çš„èª¿æŸ»çµæœ
(1) ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®äºŒé‡æ§‹é€ 

PenTool ã¯ DOMè¦ç´ ï¼ˆcanvasè¦ç´ ï¼‰ã«å¯¾ã—ã¦ pointerdown/move/up ã‚’ç›´æ¥ addEventListener ã—ã¦ã„ã‚‹
ã€‚

ä¸€æ–¹ã€AppCore ã¯ PixiJS ã® stage ã« pointerdown/move/up ã‚’ãƒã‚¤ãƒ³ãƒ‰ã—ã¦ã„ã‚‹
ã€‚
ğŸ‘‰ ä¸¡æ–¹ãŒåˆ¥ã€…ã®ã‚¤ãƒ™ãƒ³ãƒˆçµŒè·¯ã‚’ä½¿ã£ã¦ãŠã‚Šã€è¡çªã‚„ç‰‡æ–¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒæ¶ˆè²»ã•ã‚Œã‚‹å¯èƒ½æ€§ã€‚

(2) ã‚¤ãƒ™ãƒ³ãƒˆåº§æ¨™è§£æ±ºã®ç›¸é•

PenTool ã¯ getCanvasCoordinates(event) ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãŒã€ã“ã®å®šç¾©ã¯ pen-tool.js å†…ã«æœªç¢ºèªï¼ˆåˆ¥ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ä¾å­˜ï¼‰ã€‚

AppCore ã¯ getLocalPointerPosition(event) ã§ PIXI.InteractionEvent ã‚’ä½¿ã„æ­£ã—ãã‚¹ãƒ†ãƒ¼ã‚¸åº§æ¨™ã‚’è¨ˆç®—ã—ã¦ã„ã‚‹ã€‚
ğŸ‘‰ ãƒšãƒ³å…¥åŠ›ã®å ´åˆã€event.data.originalEvent ã‚’å‚ç…§ã—ãªã„ã¨ Pixi å´ã®åº§æ¨™è§£æ±ºãŒè¡Œã‚ã‚Œãªã„ã€‚ã“ã“ãŒåŸå› ã§ åº§æ¨™ãŒå¸¸ã« null ã¨ãªã‚Šæç”»é–‹å§‹ã•ã‚Œãªã„å¯èƒ½æ€§ãŒé«˜ã„ã€‚

(3) isActive ãƒ•ãƒ©ã‚°

PenTool ã®æç”»é–‹å§‹æ¡ä»¶ã« if (!this.isActive) return; ãŒã‚ã‚‹
ã€‚

ã—ã‹ã—ã€main.js / AppCore å´ã§ penTool.isActive = true ã‚’è¨­å®šã—ã¦ã„ã‚‹ç®‡æ‰€ãŒç¢ºèªã§ããªã„ã€‚
ğŸ‘‰ ãƒšãƒ³ãƒ„ãƒ¼ãƒ«è‡ªä½“ãŒå¸¸ã«éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã§ã€pointerdown ãŒç„¡è¦–ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã€‚

(4) ç­†åœ§å¯¾å¿œ

PenTool ã¯ event.pressure ã‚’ãã®ã¾ã¾åˆ©ç”¨ã—ã¦ã„ã‚‹ã€‚

ãŸã ã—ã€Pixi ã® InteractionEvent ã‚’çµŒç”±ã—ãŸå ´åˆã€event.data.originalEvent.pressure ã‚’å‚ç…§ã—ãªã„ã¨å€¤ãŒå–ã‚Œãªã„ã€‚
ğŸ‘‰ ç­†åœ§ãŒå¸¸ã« 0 ã‹ undefined ã¨ãªã‚Šç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ã€‚

3. æ ¹æœ¬åŸå› ã¾ã¨ã‚

PenTool ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒ DOMç›´ä»˜ã‘æ–¹å¼ã€PixiJS å´ã¨ã¯åˆ¥çµŒè·¯ â†’ ã‚¹ã‚¿ã‚¤ãƒ©ã‚¹å…¥åŠ›ãŒå–ã‚Šã“ã¼ã•ã‚Œã‚‹ã€‚

isActive ãŒ true ã«ã•ã‚Œã¦ã„ãªã„ â†’ pointerdown ã‚’ç„¡è¦–ã€‚

ç­†åœ§å€¤ã®å‚ç…§å…ƒãŒèª¤ã‚Š â†’ event.pressure ã§ã¯ãªã event.data.originalEvent.pressure ãŒå¿…è¦ã€‚

4. æ”¹ä¿®è¨ˆç”»
ãƒ•ã‚§ãƒ¼ã‚ºA: å³åŠ¹æ€§ãƒ‘ãƒƒãƒ

main.js ã®ãƒ„ãƒ¼ãƒ«é¸æŠå‡¦ç†ã§å¿…ãš penTool.isActive = true ã‚’è¨­å®šã€‚

PenTool.extractPointerInfo() å†…ã§ event.data?.originalEvent?.pressure ?? event.pressure ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚

PenTool.setupEventListeners() ã§ PixiJS stage ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹ï¼ˆappCore.app.stageï¼‰ã‹ã€å°‘ãªãã¨ã‚‚ appCore.app.view ã«çµ±ä¸€ã€‚

ãƒ•ã‚§ãƒ¼ã‚ºB: æ§‹é€ æ•´ç†

ã‚¤ãƒ™ãƒ³ãƒˆçµŒè·¯ã‚’ PixiJS ã® InteractionManager ã«çµ±ä¸€ã€‚

AppCore.handlePointerDown/Move/Up ã§ PenTool ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å§”è­²ã™ã‚‹æ–¹å¼ã¸ç§»è¡Œã€‚

// app-core.js å†…
handlePointerDown(event) {
    const point = this.getLocalPointerPosition(event);
    this.toolSystem.getCurrentTool().onPointerDown(event, point);
}


PenTool å´ã§ã¯ åº§æ¨™ã‚’è‡ªå‰è¨ˆç®—ã›ãš AppCore ã‹ã‚‰å—ã‘å–ã‚‹ã€‚

ãƒ•ã‚§ãƒ¼ã‚ºC: ç­†åœ§ã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–

PointerEvent.getCoalescedEvents() ã«å¯¾å¿œã—ã€ã‚¹ã‚¿ã‚¤ãƒ©ã‚¹ã®é«˜ç²¾åº¦è¿½å¾“ã‚’æ´»ç”¨ã€‚

ç­†åœ§è£œé–“ã‚’å°å…¥ã—ã¦æ»‘ã‚‰ã‹ãªã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚’å®Ÿç¾ã€‚

5. æ”¹ä¿®å„ªå…ˆåº¦

è‡´å‘½çš„ä¸å…·åˆä¿®æ­£

isActive ãƒ•ãƒ©ã‚°å¼·åˆ¶ON

originalEvent.pressure å‚ç…§ä¿®æ­£

ã‚¤ãƒ™ãƒ³ãƒˆçµŒè·¯çµ±ä¸€ (PixiJS stage)

ç­†åœ§ãƒ»coalescedEvents æœ€é©åŒ–

6. æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ï¼ˆWacom, Surface Pen, Apple Pencil ç­‰ï¼‰ã§æç”»å¯èƒ½ã«ãªã‚‹ã€‚

ç­†åœ§ã®åæ˜ ï¼ˆç·šã®å¤ªã•å¤‰åŒ–ï¼‰ãŒæœ‰åŠ¹åŒ–ã€‚

ã‚¤ãƒ™ãƒ³ãƒˆäºŒé‡ç®¡ç†ã‚’è§£æ¶ˆã—ã€å®‰å®šæ€§ãƒ»æ‹¡å¼µæ€§å‘ä¸Šã€‚


ğŸ”§ ãƒ‘ãƒƒãƒå†…å®¹
1. pen-tool.js

extractPointerInfo() ãŒ pressure ã‚’æ­£ã—ãå–ã‚Œã¦ã„ãªã„ã®ã§ä¿®æ­£ã—ã¾ã™ã€‚

    /**
     * ğŸ¯ Pointer æƒ…å ±æŠ½å‡º
     */
    extractPointerInfo(event) {
-       return {
-           pointerId: event.pointerId || 0,
-           pointerType: event.pointerType || 'mouse',
-           isPrimary: event.isPrimary !== false,
-           pressure: event.pressure || 0.5
-       };
+       const original = event.data?.originalEvent || event.originalEvent || event;
+       return {
+           pointerId: original.pointerId || event.pointerId || 0,
+           pointerType: original.pointerType || event.pointerType || 'mouse',
+           isPrimary: original.isPrimary !== false,
+           // ç­†åœ§ã‚’å¿…ãš originalEvent ã‹ã‚‰å„ªå…ˆå–å¾—
+           pressure: (typeof original.pressure === 'number')
+               ? original.pressure
+               : (typeof event.pressure === 'number' ? event.pressure : 0.5)
+       };
    }

2. main.js

ãƒšãƒ³ãƒ„ãƒ¼ãƒ«ãŒå¸¸ã« isActive = false ãªã®ã§ã€ãƒ„ãƒ¼ãƒ«é¸æŠæ™‚ã«æœ‰åŠ¹åŒ–ã€‚

    /**
     * ãƒšãƒ³ãƒ„ãƒ¼ãƒ«é¸æŠï¼ˆã‚¨ãƒ©ãƒ¼å‡¦ç†ä»˜ãï¼‰
     */
    selectPenTool() {
        try {
            if (!this.appCore || !this.appCore.toolSystem) {
                this.logWarning('âš ï¸ ãƒ„ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ æœªåˆæœŸåŒ–');
                return;
            }
            
-           this.appCore.toolSystem.setTool('pen');
+           this.appCore.toolSystem.setTool('pen');
+           // å³åŠ¹ãƒ‘ãƒƒãƒ: PenTool ã‚’æœ‰åŠ¹åŒ–
+           if (this.appCore.toolSystem.currentTool?.name === 'pen') {
+               this.appCore.toolSystem.currentTool.isActive = true;
+           }
            
            // UIæ›´æ–°
            this.updateToolUI('pen-tool', 'ãƒ™ã‚¯ã‚¿ãƒ¼ãƒšãƒ³');

ğŸ“‹ é©ç”¨å¾Œã®åŠ¹æœ

ã‚¹ã‚¿ã‚¤ãƒ©ã‚¹ã§æç”»é–‹å§‹å¯èƒ½ï¼ˆisActive ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã‚‹ãŸã‚ï¼‰ã€‚

ç­†åœ§åæ˜ ï¼ˆoriginalEvent.pressure ã‚’æ­£ã—ãå‚ç…§ï¼‰ã€‚

ãƒã‚¦ã‚¹ã¨ãƒšãƒ³ã®ä¸¡æ–¹ã§æŒ™å‹•ãŒçµ±ä¸€ã€‚

ğŸ‘‰ ã“ã®ãƒ‘ãƒƒãƒã‚’å½“ã¦ã‚Œã° ã€Œæã‘ãªã„ï¼ç­†åœ§åŠ¹ã‹ãªã„ã€ç—‡çŠ¶ã¯ã™ãè§£æ¶ˆã™ã‚‹ã¯ãšã§ã™ã€‚
