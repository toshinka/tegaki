ä½•ãŒèµ·ãã¦ã„ã‚‹ã‹ï¼ˆåŸå› ï¼‰
ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã®ãƒŸã‚¹ãƒãƒƒãƒ

ã‚³ã‚¢ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¯ Tegaki åå‰ç©ºé–“ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ï¼ˆä¾‹ï¼šTegaki.StateManagerInstanceï¼‰ï½¡ 
GitHub

ã—ã‹ã— ToolManager / UI å±¤ã¯ä¾ç„¶ã¨ã—ã¦ window.EventBus / window.StateManager / window.ErrorManager ã‚’å‚ç…§ã™ã‚‹å‰æã§æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚window å´ã«ãƒ–ãƒªãƒƒã‚¸ãŒç„¡ã„ã¨ã€åˆæœŸåŒ–ã‚¤ãƒ™ãƒ³ãƒˆé…ç·šã‚„ãƒ„ãƒ¼ãƒ«ç™»éŒ²ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€æç”»ã«è‡³ã‚Šã¾ã›ã‚“ï¼ˆè­¦å‘Šãƒ­ã‚°ã®ã¿ãƒ»ã‚‚ã—ãã¯ ErrorManager ãŒ window å´ã«ç„¡ã„ãŸã‚ãƒ­ã‚°ã‚‚å‡ºãªã„ï¼‰ã€‚ 
GitHub
+1

ãƒ„ãƒ¼ãƒ«ç™»éŒ²ã®ä¸ä¸€è‡´

ToolManager ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ„ãƒ¼ãƒ«ã‚’ window.PenTool / window.EraserTool ã‹ã‚‰æ¢ã—ã¾ã™ãŒã€å®Ÿè£…ã¯ Tegaki åå‰ç©ºé–“ã«è¼‰ã£ã¦ã„ã‚‹æ§‹æˆï¼ˆTegaki.PenTool ç­‰ï¼‰ã§ã™ã€‚ã“ã®ãŸã‚ã€Œãƒ„ãƒ¼ãƒ«ãŒ1ã¤ã‚‚ç™»éŒ²ã•ã‚Œãªã„ â†’ setTool('pen') ãŒå†…éƒ¨çš„ã«å¤±æ•— â†’ ä½•ã‚‚æã‘ãªã„ã€ã¨ã„ã†é™ã‹ãªå¤±æ•—ã«é™¥ã‚Šã¾ã™ã€‚ 
GitHub

DOM ã¸ã®ãƒã‚¦ãƒ³ãƒˆ/åˆæœŸåŒ–é †åº

åˆæœŸåŒ–ã¯ã€Œ_registry ã«ç©ã‚“ã§ã‹ã‚‰ä¸€æ‹¬å®Ÿè¡Œã€è¨­è¨ˆã§ã™ãŒã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå®Ÿè¡Œã¨ window ã¸ã®ãƒ–ãƒªãƒƒã‚¸ãŒååˆ†å³å¯†ã§ãªã„ã¨ã€CanvasManager ã®ç”Ÿæˆãƒ»ãƒã‚¦ãƒ³ãƒˆã‚„ ToolManager ã®ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ãŒèµ°ã‚Šã¾ã›ã‚“ã€‚

index.html å´ã¯ UI è¦ç´ ãŒä¸¦ã‚“ã§ã„ã‚‹ã®ã¯è¦‹ãˆã¾ã™ãŒã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å·®ã—è¾¼ã‚€ã‚³ãƒ³ãƒ†ãƒŠã® idï¼ˆä¾‹: canvasContainerï¼‰ãŒ DOM ã«ã‚ã‚‹ã‹ï¼CSS ã§é«˜ã•0ã«ãªã£ã¦ã„ãªã„ã‹ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã‚ŠãŒã¡ã§ã™ï¼ˆæœ¬æ–‡ã‹ã‚‰ã¯ç¢ºèªã—ãã‚Œãªã„ãŸã‚ã€ä¸‹è¨˜ãƒ‘ãƒƒãƒã§ç¢ºå®Ÿã«ç”¨æ„ã—ã¾ã™ï¼‰ã€‚ 
GitHub

ã™ãåŠ¹ãæœ€å°ãƒ‘ãƒƒãƒï¼ˆHotfixï¼‰

ã€Œæ—¢å­˜ã®â€window.*â€ä¾å­˜ã‚’å´©ã•ãšã€Tegaki å´ã‹ã‚‰ ãƒ–ãƒªãƒƒã‚¸ã‚’ç”Ÿã‚„ã™ã€æ–¹é‡ã§ã™ã€‚ã“ã‚Œã§ã‚¨ãƒ©ãƒ¼ç„¡ã—ãƒ»é™ã‹ã«ä½•ã‚‚èµ·ããªã„çŠ¶æ…‹ã‚’è„±ã—ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒå‡ºã¾ã™ã€‚

1) js/main.js ã«ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—/ãƒ–ãƒªãƒƒã‚¸ã‚’è¿½åŠ 

ãƒ•ã‚¡ã‚¤ãƒ«æœ«å°¾ï¼ˆã¾ãŸã¯ DOMContentLoaded ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰ã«è¿½è¨˜ã—ã¦ãã ã•ã„ã€‚

<!-- index.html ã® <script> ç¾¤ã®ä¸­ã§ã€ä¸€ç•ªæœ€å¾Œã« main.js ã‚’èª­ã¿è¾¼ã‚€å‰æ -->
<script src="./js/main.js" defer></script>

// js/main.js æœ«å°¾ã«è¿½è¨˜ï¼ˆå³æ™‚é–¢æ•°ã§å®‰å…¨ã«ï¼‰
(function bootstrapTegaki() {
  try {
    // 1) ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå®Ÿè¡Œï¼ˆå®šç¾©æ¸ˆã¿é–¢æ•°ã‚’é †ã«å®Ÿè¡Œï¼‰
    window.Tegaki = window.Tegaki || {};
    if (Array.isArray(Tegaki._registry)) {
      Tegaki._registry.forEach(fn => { try { fn && fn(); } catch (e) { console.error('[Registry]', e); } });
    }

    // 2) ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ–ãƒªãƒƒã‚¸ï¼ˆwindow.* ã‚’è¦æ±‚ã™ã‚‹æ—¢å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¯¾ç­–ï¼‰
    if (Tegaki.ErrorManagerInstance)  window.ErrorManager  = Tegaki.ErrorManagerInstance;
    if (Tegaki.EventBusInstance)     window.EventBus     = Tegaki.EventBusInstance;
    if (Tegaki.StateManagerInstance) window.StateManager = Tegaki.StateManagerInstance;
    if (Tegaki.ConfigManagerInstance)window.ConfigManager= Tegaki.ConfigManagerInstance;

    // 3) PIXI ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆpixi-extensions ãŒå…¥ã£ã¦ã„ã‚Œã°åŸºæœ¬OKï¼‰
    if (!window.PIXI) {
      console.error('[Bootstrap] PIXI ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚CDNã¾ãŸã¯ libs/pixi-extensions.js ã®èª­è¾¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    // 4) CanvasManager / CoordinateManager / ToolManager ã®é€£æº
    const cm = (Tegaki.CanvasManagerInstance ||= new Tegaki.CanvasManager({ containerId: 'canvasContainer' }));
    const co = (Tegaki.CoordinateManagerInstance ||= new Tegaki.CoordinateManager(cm));
    const tm = (Tegaki.ToolManagerInstance ||= new Tegaki.ToolManager());

    tm.initialize(cm, co);

    // 5) ãƒ„ãƒ¼ãƒ«ç™»éŒ²ï¼ˆTegaki åå‰ç©ºé–“ã‹ã‚‰ã‚‚æ¢ã™ï¼‰
    const Pen   = window.PenTool    || (Tegaki && Tegaki.PenTool);
    const Erase = window.EraserTool || (Tegaki && Tegaki.EraserTool);
    if (Pen)   tm.registerTool('pen',    new Pen());
    if (Erase) tm.registerTool('eraser', new Erase());

    // 6) åˆæœŸãƒ„ãƒ¼ãƒ«ã‚’æ˜ç¤ºçš„ã«é¸æŠï¼ˆå¤±æ•—å›é¿ï¼‰
    if (tm.getAvailableTools().length) {
      tm.setTool('pen');
    } else {
      console.warn('[Bootstrap] ç™»éŒ²æ¸ˆã¿ãƒ„ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆPen/Eraser ã®å…¬é–‹åã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
    }

    console.log('[Bootstrap] Tegaki åˆæœŸåŒ–å®Œäº†');
  } catch (e) {
    console.error('[Bootstrap] é‡å¤§ãªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', e);
  }
})();

2) managers/tool-manager.js ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ„ãƒ¼ãƒ«æ¢ç´¢ã‚’æ‹¡å¼µ

_registerDefaultTools() ã®ã‚¯ãƒ©ã‚¹è§£æ±ºã‚’ Tegaki åå‰ç©ºé–“ã‚‚è¦‹ã‚‹ã‚ˆã†ã«å¤‰æ›´ï¼š

- const ToolClass = window[toolInfo.className];
+ const ToolClass = window[toolInfo.className] || (window.Tegaki && window.Tegaki[toolInfo.className]);


ï¼ˆã“ã‚Œã§ Tegaki.PenTool / Tegaki.EraserTool å®Ÿè£…ã§ã‚‚æ‹¾ãˆã¾ã™ã€‚ï¼‰ 
GitHub

3) index.html ã«ã‚­ãƒ£ãƒ³ãƒã‚¹ç”¨ã‚³ãƒ³ãƒ†ãƒŠã‚’ç¢ºå®Ÿã«è¨­ç½®

UI ã®ã©ã“ã§ã‚‚è‰¯ã„ã®ã§ ä¸€ç®‡æ‰€ã ã‘ä»¥ä¸‹ã‚’é…ç½®ã—ã¦ãã ã•ã„ï¼ˆé‡è¤‡ç¦æ­¢ï¼‰ï¼š

<!-- ã‚­ãƒ£ãƒ³ãƒã‚¹å·®ã—è¾¼ã¿å…ˆ -->
<div id="canvasContainer" style="width:400px;height:400px;margin:0 auto;display:block;"></div>


â€» CSS ã§é«˜ã•ãŒ 0 ã«ãªã£ã¦ã„ã‚‹ã¨ è¦‹ãˆã¾ã›ã‚“ã€‚æš«å®šã§ inline-styles ã‚’å…¥ã‚Œã€å¾Œã§ css/styles.css ã«ç§»ã—ã¦ãã ã•ã„ã€‚ 
GitHub

4) PIXI ã®èª­è¾¼ã‚’ç¢ºèª

CDN or libs/pixi-extensions.js ã§ PIXI ãŒ **ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆwindow.PIXIï¼‰**ã«å±…ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<script src="https://unpkg.com/pixi.js@7/dist/pixi.min.js"></script> ã‚’ æœ€ä¸Šæµã§èª­ã¿è¾¼ã‚€ã‹ã€pixi-extensions.js å´ã§ window.PIXI ||= PIXI; ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚

æ­£é“ãƒªãƒ•ã‚¡ã‚¯ã‚¿ï¼ˆè¦ç´„æº–æ‹ ç‰ˆãƒ»æ¨å¥¨ï¼‰

ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ã®ã€Œä¾å­˜ã¯ Tegaki.* ã«çµ±ä¸€ã€ã«åˆã‚ã›ã‚‹ãªã‚‰ã€*window. å‚ç…§ã‚’å…¨é¢æ’¤å»ƒ**ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ï¼ˆHotfix å¾Œã€æ®µéšçš„ã«ç½®æ›å¯èƒ½ï¼‰ï¼š

ToolManager, UIManager, CanvasManager ç­‰ã®å†…éƒ¨å‚ç…§ã‚’ã™ã¹ã¦
window.EventBus â†’ Tegaki.EventBusInstance
window.StateManager â†’ Tegaki.StateManagerInstance
window.ErrorManager â†’ Tegaki.ErrorManagerInstance
window.ConfigManager â†’ Tegaki.ConfigManagerInstance
ã«çµ±ä¸€ã€‚

ToolManager ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ„ãƒ¼ãƒ«æ¢ç´¢ã‚‚ Tegaki[className] ã‚’ä¸€æ¬¡å‚ç…§ã«ã€‚ 
GitHub

UIManager ã®ä¾å­˜ç¢ºèªãƒ­ã‚¸ãƒƒã‚¯ã¯ window[...] ã§ã¯ãªã Tegaki ã® Instance å­˜åœ¨ç¢ºèªã«å¤‰æ›´ï¼ˆç¾çŠ¶ã ã¨ window.EventBus ã‚’è¦æ±‚ã™ã‚‹ãŸã‚ã€Tegakiçµ±ä¸€ã¨é½Ÿé½¬ï¼‰ã€‚ 
GitHub

main.js ã¯ ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå®Ÿè¡Œã®ã¿ã«ç°¡ç´ åŒ–ã—ã€ãƒ–ãƒªãƒƒã‚¸ã¯ä¸è¦ï¼ˆè¨­è¨ˆã®æœ€çµ‚å½¢ï¼‰ã€‚

ã™ãç¢ºèªã§ãã‚‹ãƒ‡ãƒãƒƒã‚°æ‰‹é †ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼‰
// 1) PIXI ãŒå±…ã‚‹ã‹
!!window.PIXI

// 2) Tegaki ã®åŸºå¹¹ãŒç”Ÿæˆæ¸ˆã¿ã‹
Tegaki && Object.keys(Tegaki)
Tegaki._registry?.length
!!Tegaki.CanvasManager && !!Tegaki.ToolManager

// 3) ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œã‚‰ã‚Œã¦ã„ã‚‹ã‹
!!Tegaki.ErrorManagerInstance
!!Tegaki.EventBusInstance
!!Tegaki.StateManagerInstance

// 4) window å´ï¼ˆHotfix é©ç”¨æ™‚ï¼‰
!!window.EventBus, !!window.StateManager, !!window.ErrorManager

// 5) DOM ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ã‚µã‚¤ã‚ºãŒã‚ã‚‹ã‹
const el = document.getElementById('canvasContainer'); el && el.getBoundingClientRect()

ã¾ã¨ã‚

ä¸»å› ã¯ã€ŒTegaki.ï¼ˆæ–°ï¼‰ã¨ window.ï¼ˆæ—§ï¼‰ã®å‚ç…§ã‚ºãƒ¬ã€ã¨ã€Œãƒ¬ã‚¸ã‚¹ãƒˆãƒªå®Ÿè¡Œ/DOM ãƒã‚¦ãƒ³ãƒˆã®ç©´ã€ã€‚

ä¸Šè¨˜ Hotfix ã‚’å…¥ã‚Œã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ç„¡ã—ã§ä½•ã‚‚èµ·ããªã„çŠ¶æ…‹ã‚’è„±ã—ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒå‡ºç¾ãƒ»æç”»ã§ãã‚‹ã¯ãšã§ã™ã€‚

ãã®å¾Œã€è¦ç´„ã©ãŠã‚Š *Tegaki. ã«ä¾å­˜ã‚’çµ±ä¸€**ã™ã‚‹ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã‚’é€²ã‚ã‚Œã°ã€window ãƒ–ãƒªãƒƒã‚¸ã¯ä¸è¦ã«ãªã‚Šã€è¨­è¨ˆãŒã‚¯ãƒªãƒ¼ãƒ³ã«ãªã‚Šã¾ã™ã€‚

å¿…è¦ãªã‚‰ã€ç§ã®ã»ã†ã§ ãƒ‘ãƒƒãƒé©ç”¨æ¸ˆã¿ã® main.jsï¼tool-manager.js å·®ã—æ›¿ãˆç‰ˆã‚’ã¾ã¨ã‚ã¦å‡ºåŠ›ã—ã¾ã™ã€‚

ğŸ“„ js/main.jsï¼ˆãƒ‘ãƒƒãƒé©ç”¨æ¸ˆã¿ï¼‰
// js/main.js

(function bootstrapTegaki() {
  try {
    window.Tegaki = window.Tegaki || {};

    // 1) ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’å®Ÿè¡Œ
    if (Array.isArray(Tegaki._registry)) {
      Tegaki._registry.forEach(fn => {
        try { fn && fn(); }
        catch (e) { console.error('[Registry]', e); }
      });
    }

    // 2) ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ–ãƒªãƒƒã‚¸ï¼ˆæ—¢å­˜ window.* ä¾å­˜å¯¾ç­–ï¼‰
    if (Tegaki.ErrorManagerInstance)  window.ErrorManager  = Tegaki.ErrorManagerInstance;
    if (Tegaki.EventBusInstance)     window.EventBus     = Tegaki.EventBusInstance;
    if (Tegaki.StateManagerInstance) window.StateManager = Tegaki.StateManagerInstance;
    if (Tegaki.ConfigManagerInstance)window.ConfigManager= Tegaki.ConfigManagerInstance;

    // 3) PIXI ã®å­˜åœ¨ç¢ºèª
    if (!window.PIXI) {
      console.error('[Bootstrap] PIXI ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚CDN ã¾ãŸã¯ libs/pixi-extensions.js ã®èª­è¾¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    // 4) CanvasManager / CoordinateManager / ToolManager ã®é€£æº
    const cm = (Tegaki.CanvasManagerInstance ||= new Tegaki.CanvasManager({ containerId: 'canvasContainer' }));
    const co = (Tegaki.CoordinateManagerInstance ||= new Tegaki.CoordinateManager(cm));
    const tm = (Tegaki.ToolManagerInstance ||= new Tegaki.ToolManager());

    tm.initialize(cm, co);

    // 5) ãƒ„ãƒ¼ãƒ«ç™»éŒ²ï¼ˆTegaki åå‰ç©ºé–“ã‚‚è€ƒæ…®ï¼‰
    const Pen   = window.PenTool    || (Tegaki && Tegaki.PenTool);
    const Erase = window.EraserTool || (Tegaki && Tegaki.EraserTool);
    if (Pen)   tm.registerTool('pen',    new Pen());
    if (Erase) tm.registerTool('eraser', new Erase());

    // 6) åˆæœŸãƒ„ãƒ¼ãƒ«ã‚’æ˜ç¤ºçš„ã«é¸æŠ
    if (tm.getAvailableTools().length) {
      tm.setTool('pen');
    } else {
      console.warn('[Bootstrap] ç™»éŒ²æ¸ˆã¿ãƒ„ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆPen/Eraser ã®å…¬é–‹åã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
    }

    console.log('[Bootstrap] Tegaki åˆæœŸåŒ–å®Œäº†');
  } catch (e) {
    console.error('[Bootstrap] é‡å¤§ãªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', e);
  }
})();

ğŸ“„ managers/tool-manager.jsï¼ˆãƒ‘ãƒƒãƒé©ç”¨æ¸ˆã¿ï¼‰
// managers/tool-manager.js

class ToolManager {
  constructor() {
    this.tools = {};
    this.currentTool = null;
    this.canvasManager = null;
    this.coordinateManager = null;
  }

  initialize(canvasManager, coordinateManager) {
    this.canvasManager = canvasManager;
    this.coordinateManager = coordinateManager;
    this._registerDefaultTools();
  }

  _registerDefaultTools() {
    const defaultTools = [
      { name: 'pen',    className: 'PenTool' },
      { name: 'eraser', className: 'EraserTool' }
    ];

    defaultTools.forEach(toolInfo => {
      // â˜… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: window.* ãŒç„¡ã‘ã‚Œã° Tegaki.* ã‚’æ¢ã™
      const ToolClass =
        window[toolInfo.className] ||
        (window.Tegaki && window.Tegaki[toolInfo.className]);

      if (ToolClass) {
        this.registerTool(toolInfo.name, new ToolClass());
      } else {
        console.warn(`[ToolManager] ${toolInfo.className} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
      }
    });
  }

  registerTool(name, instance) {
    if (!name || !instance) return;
    this.tools[name] = instance;
    if (typeof instance.attach === 'function') {
      instance.attach(this.canvasManager, this.coordinateManager);
    }
    console.log(`[ToolManager] ãƒ„ãƒ¼ãƒ«ç™»éŒ²: ${name}`);
  }

  setTool(name) {
    if (!this.tools[name]) {
      console.error(`[ToolManager] ãƒ„ãƒ¼ãƒ« '${name}' ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“`);
      return;
    }
    this.currentTool = this.tools[name];
    if (typeof this.currentTool.activate === 'function') {
      this.currentTool.activate();
    }
    console.log(`[ToolManager] ç¾åœ¨ã®ãƒ„ãƒ¼ãƒ«: ${name}`);
  }

  getTool() {
    return this.currentTool;
  }

  getAvailableTools() {
    return Object.keys(this.tools);
  }
}

window.Tegaki = window.Tegaki || {};
window.Tegaki.ToolManager = ToolManager;
