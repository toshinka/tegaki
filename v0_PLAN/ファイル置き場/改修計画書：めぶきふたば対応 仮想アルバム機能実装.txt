===============================================================================
  ToshinkaTegakiTool - ã‚ã¶ã/ãµãŸã°é€£æºæ©Ÿèƒ½ å®Ÿè£…è¨ˆç”»æ›¸
  Version: v8.13_Album1
  Date: 2025-10-07
  Target: IndexedDBä»®æƒ³ã‚¢ãƒ«ãƒãƒ  + ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰é€£æº
===============================================================================

ã€ç›®çš„ã€‘
- ã‚ã¶ãã¡ã‚ƒã‚“ã­ã‚‹/ãµãŸã°ã¡ã‚ƒã‚“ã­ã‚‹ã¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æŠ•ç¨¿ã‚’ç°¡ç´ åŒ–
- IndexedDBã‚’ä»®æƒ³ã‚¢ãƒ«ãƒãƒ ã¨ã—ã¦æ´»ç”¨ã—ã€APNG/GIFã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰çµŒç”±ã§è²¼ä»˜å¯èƒ½ã«
- ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆèµ·å‹•æ™‚ã¯ã€Œæ²ç¤ºæ¿ãƒ¢ãƒ¼ãƒ‰ã€ã€é€šå¸¸èµ·å‹•æ™‚ã¯ã€Œæ±ç”¨ãƒ¢ãƒ¼ãƒ‰ã€ã¨ã—ã¦å‹•ä½œ

ã€æŠ€è¡“åˆ¶ç´„ã€‘
âœ… APNG: image/png ã¨ã—ã¦ ClipboardAPI å¯¾å¿œå¯èƒ½æ€§ã‚ã‚Š
âŒ GIF: ClipboardAPI éå¯¾å¿œï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä»•æ§˜ï¼‰
âœ… IndexedDB: åŒä¸€ã‚ªãƒªã‚¸ãƒ³å†…ã§æ°¸ç¶šåŒ–å¯èƒ½
âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: åˆ¥ã‚¿ãƒ–é–“ã®ç›´æ¥ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã¯ä¸å¯

ã€å®Ÿè£…æ–¹é‡ã€‘
1. ä»®æƒ³ã‚¢ãƒ«ãƒãƒ æ©Ÿèƒ½ï¼ˆIndexedDBï¼‰ã‚’æ–°è¦å®Ÿè£…
2. ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æ—¢å­˜ã‚¢ãƒ«ãƒãƒ ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ´»ç”¨
3. ã‚¢ãƒ«ãƒãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«ä¿å­˜/ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½è¿½åŠ 
4. mebuki-loader.js ã‹ã‚‰èµ·å‹•æ™‚ã¯ã€Œã‚¹ãƒ—ãƒ©ã‚¦ãƒˆãƒœã‚¿ãƒ³ã€ã‚’è¡¨ç¤º
5. APNGã‚’å„ªå…ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨ã—ã¦æ¨å¥¨

===============================================================================
ã€å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã€‘
===============================================================================

[æ–°è¦ä½œæˆ]
- system/virtual-album.js          ä»®æƒ³ã‚¢ãƒ«ãƒãƒ ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ 
- ui/album-popup.js                ã‚¢ãƒ«ãƒãƒ UIç®¡ç†
- mebuki-mode.js                   ã‚ã¶ããƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡

[æ”¹ä¿®]
- ui/ui-panels.js                  ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¢ãƒ«ãƒãƒ ã‚¢ã‚¤ã‚³ãƒ³é€£æº
- system/export-manager.js         ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã®ã‚¢ãƒ«ãƒãƒ ä¿å­˜å¯¾å¿œ
- index.html                       æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
- mebuki-loader.js                 ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå´ã®å®Ÿè£…

===============================================================================

ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥å®Ÿè£…è©³ç´°1. system/virtual-album.jsï¼ˆæ–°è¦ä½œæˆï¼‰
1. system/virtual-album.jsï¼ˆæ–°è¦ä½œæˆï¼‰
===============================================================================
ãƒ•ã‚¡ã‚¤ãƒ«: system/virtual-album.js
å½¹å‰²: IndexedDBã‚’ä½¿ã£ãŸä»®æƒ³ã‚¢ãƒ«ãƒãƒ ã®ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ 
ä¾å­˜: ãªã—
å…¬é–‹API:
  - init()                        åˆæœŸåŒ–
  - saveAnimation(blob, metadata) ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¿å­˜
  - getAllAnimations()            å…¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å–å¾—
  - getLatest()                   æœ€æ–°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å–å¾—
  - deleteAnimation(id)           å‰Šé™¤
  - copyToClipboard(id)           ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
===============================================================================

class VirtualAlbum {
    constructor() {
        this.dbName = 'ToshinkaTegakiAlbum';
        this.version = 1;
        this.storeName = 'animations';
        this.db = null;
        this.maxItems = 20; // æœ€å¤§ä¿å­˜ä»¶æ•°
    }

    // åˆæœŸåŒ–
    async init() {
        if (this.db) return;
        
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(this.dbName, this.version);
            
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    const store = db.createObjectStore(this.storeName, { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
            
            req.onsuccess = (e) => {
                this.db = e.target.result;
                resolve();
            };
            
            req.onerror = () => reject(new Error('IndexedDBåˆæœŸåŒ–å¤±æ•—'));
        });
    }

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¿å­˜
    async saveAnimation(blob, metadata = {}) {
        await this.init();
        
        const data = {
            blob: blob,
            format: metadata.format || 'apng',
            width: metadata.width || 0,
            height: metadata.height || 0,
            frames: metadata.frames || 1,
            timestamp: Date.now(),
            thumbnail: metadata.thumbnail || null // Base64ã‚µãƒ ãƒã‚¤ãƒ«
        };
        
        const tx = this.db.transaction(this.storeName, 'readwrite');
        const store = tx.objectStore(this.storeName);
        
        // å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆmaxItemsä»¥ä¸Šã®å ´åˆï¼‰
        const all = await this._getAllKeys();
        if (all.length >= this.maxItems) {
            const deleteCount = all.length - this.maxItems + 1;
            for (let i = 0; i < deleteCount; i++) {
                store.delete(all[i]);
            }
        }
        
        return new Promise((resolve, reject) => {
            const req = store.add(data);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(new Error('ä¿å­˜å¤±æ•—'));
        });
    }

    // å…¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å–å¾—
    async getAllAnimations() {
        await this.init();
        
        const tx = this.db.transaction(this.storeName, 'readonly');
        const store = tx.objectStore(this.storeName);
        const index = store.index('timestamp');
        
        return new Promise((resolve, reject) => {
            const req = index.openCursor(null, 'prev'); // æ–°ã—ã„é †
            const items = [];
            
            req.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    items.push(cursor.value);
                    cursor.continue();
                } else {
                    resolve(items);
                }
            };
            req.onerror = () => reject(new Error('å–å¾—å¤±æ•—'));
        });
    }

    // æœ€æ–°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å–å¾—
    async getLatest() {
        const all = await this.getAllAnimations();
        return all.length > 0 ? all[0] : null;
    }

    // å‰Šé™¤
    async deleteAnimation(id) {
        await this.init();
        
        const tx = this.db.transaction(this.storeName, 'readwrite');
        const store = tx.objectStore(this.storeName);
        
        return new Promise((resolve, reject) => {
            const req = store.delete(id);
            req.onsuccess = () => resolve();
            req.onerror = () => reject(new Error('å‰Šé™¤å¤±æ•—'));
        });
    }

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ï¼ˆAPNGå„ªå…ˆï¼‰
    async copyToClipboard(id) {
        await this.init();
        
        const tx = this.db.transaction(this.storeName, 'readonly');
        const store = tx.objectStore(this.storeName);
        
        return new Promise(async (resolve, reject) => {
            const req = store.get(id);
            
            req.onsuccess = async () => {
                const item = req.result;
                if (!item) {
                    reject(new Error('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'));
                    return;
                }
                
                try {
                    // APNGã¯ image/png ã¨ã—ã¦ã€GIFã¯è«¦ã‚ã‚‹
                    const mimeType = item.format === 'apng' ? 'image/png' : 'image/gif';
                    
                    await navigator.clipboard.write([
                        new ClipboardItem({ [mimeType]: item.blob })
                    ]);
                    
                    resolve();
                } catch (err) {
                    reject(new Error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼å¤±æ•—: ' + err.message));
                }
            };
            
            req.onerror = () => reject(new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—'));
        });
    }

    // å†…éƒ¨ï¼šå…¨ã‚­ãƒ¼å–å¾—
    async _getAllKeys() {
        const tx = this.db.transaction(this.storeName, 'readonly');
        const store = tx.objectStore(this.storeName);
        
        return new Promise((resolve, reject) => {
            const req = store.getAllKeys();
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(new Error('ã‚­ãƒ¼å–å¾—å¤±æ•—'));
        });
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
window.virtualAlbum = new VirtualAlbum();

2. ui/album-popup.jsï¼ˆæ–°è¦ä½œæˆï¼‰

===============================================================================
ãƒ•ã‚¡ã‚¤ãƒ«: ui/album-popup.js
å½¹å‰²: ã‚¢ãƒ«ãƒãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—UIã®ç®¡ç†
ä¾å­˜: system/virtual-album.js, system/event-bus.js
å…¬é–‹API:
  - show()                        ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
  - hide()                        ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—éè¡¨ç¤º
  - refresh()                     ã‚¢ãƒ«ãƒãƒ å†…å®¹æ›´æ–°
===============================================================================

class AlbumPopup {
    constructor(eventBus) {
        this.eventBus = eventBus;
        this.container = null;
        this.isVisible = false;
    }

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½œæˆ
    create() {
        this.container = document.createElement('div');
        this.container.id = 'album-popup';
        this.container.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            max-height: 80vh;
            background: #f5e6e0;
            border: 2px solid #800000;
            border-radius: 8px;
            padding: 20px;
            z-index: 10000;
            display: none;
            overflow-y: auto;
        `;
        
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        `;
        
        const title = document.createElement('h3');
        title.textContent = 'ä»®æƒ³ã‚¢ãƒ«ãƒãƒ ';
        title.style.cssText = 'margin: 0; color: #800000;';
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = `
            background: none;
            border: none;
            color: #800000;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        `;
        closeBtn.onclick = () => this.hide();
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        const grid = document.createElement('div');
        grid.id = 'album-grid';
        grid.style.cssText = `
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        `;
        
        this.container.appendChild(header);
        this.container.appendChild(grid);
        document.body.appendChild(this.container);
    }

    // è¡¨ç¤º
    async show() {
        if (!this.container) this.create();
        
        this.container.style.display = 'block';
        this.isVisible = true;
        
        await this.refresh();
    }

    // éè¡¨ç¤º
    hide() {
        if (this.container) {
            this.container.style.display = 'none';
            this.isVisible = false;
        }
    }

    // å†…å®¹æ›´æ–°
    async refresh() {
        const grid = document.getElementById('album-grid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        const items = await window.virtualAlbum.getAllAnimations();
        
        if (items.length === 0) {
            grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #800000;">ã‚¢ãƒ«ãƒãƒ ã¯ç©ºã§ã™</p>';
            return;
        }
        
        items.forEach(item => {
            const card = this.createCard(item);
            grid.appendChild(card);
        });
    }

    // ã‚«ãƒ¼ãƒ‰ä½œæˆ
    createCard(item) {
        const card = document.createElement('div');
        card.style.cssText = `
            background: #ede0d8;
            border: 1px solid #c0a090;
            border-radius: 4px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        `;
        
        // ã‚µãƒ ãƒã‚¤ãƒ«
        const thumb = document.createElement('div');
        thumb.style.cssText = `
            width: 100%;
            aspect-ratio: 4/3;
            background: #d0c0b0;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        `;
        
        if (item.thumbnail) {
            const img = document.createElement('img');
            img.src = item.thumbnail;
            img.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain;';
            thumb.appendChild(img);
        } else {
            thumb.textContent = 'No Preview';
            thumb.style.color = '#800000';
        }
        
        thumb.onclick = () => this.loadAnimation(item);
        
        // æƒ…å ±
        const info = document.createElement('div');
        info.style.cssText = 'font-size: 12px; color: #800000;';
        info.innerHTML = `
            ${item.format.toUpperCase()} | ${item.width}Ã—${item.height} | ${item.frames}f<br>
            ${new Date(item.timestamp).toLocaleString('ja-JP')}
        `;
        
        // ãƒœã‚¿ãƒ³ç¾¤
        const buttons = document.createElement('div');
        buttons.style.cssText = 'display: flex; gap: 8px;';
        
        const downloadBtn = this.createIconButton('â¬‡', 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', async () => {
            const url = URL.createObjectURL(item.blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `animation-${item.id}.${item.format}`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        const copyBtn = this.createIconButton('ğŸ“‹', 'ã‚³ãƒ”ãƒ¼', async () => {
            try {
                await window.virtualAlbum.copyToClipboard(item.id);
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            } catch (err) {
                alert('ã‚³ãƒ”ãƒ¼å¤±æ•—: ' + err.message);
            }
        });
        
        const deleteBtn = this.createIconButton('ğŸ—‘', 'å‰Šé™¤', async () => {
            if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                await window.virtualAlbum.deleteAnimation(item.id);
                await this.refresh();
            }
        });
        
        buttons.appendChild(downloadBtn);
        buttons.appendChild(copyBtn);
        buttons.appendChild(deleteBtn);
        
        card.appendChild(thumb);
        card.appendChild(info);
        card.appendChild(buttons);
        
        return card;
    }

    // ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ä½œæˆ
    createIconButton(icon, tooltip, onClick) {
        const btn = document.createElement('button');
        btn.textContent = icon;
        btn.title = tooltip;
        btn.style.cssText = `
            flex: 1;
            padding: 8px;
            background: #c0a090;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        `;
        btn.onclick = onClick;
        return btn;
    }

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿
    loadAnimation(item) {
        // TODO: ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«èª­ã¿è¾¼ã‚€å‡¦ç†ï¼ˆæœªå®Ÿè£…ï¼‰
        console.log('Load animation:', item);
        alert('ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™');
    }
}

3. mebuki-mode.jsï¼ˆæ–°è¦ä½œæˆï¼‰

===============================================================================
ãƒ•ã‚¡ã‚¤ãƒ«: mebuki-mode.js
å½¹å‰²: ã‚ã¶ã/ãµãŸã°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã€Œã‚¹ãƒ—ãƒ©ã‚¦ãƒˆãƒœã‚¿ãƒ³ã€åˆ¶å¾¡
ä¾å­˜: system/virtual-album.js, system/export-manager.js
å…¬é–‹API:
  - init()                        ã‚ã¶ããƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
  - createSproutButton()          ã‚¹ãƒ—ãƒ©ã‚¦ãƒˆãƒœã‚¿ãƒ³ä½œæˆ
===============================================================================

class MebukiMode {
    constructor(app) {
        this.app = app;
        this.sproutButton = null;
        this.isEnabled = false;
    }

    // åˆæœŸåŒ–ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§åˆ¤å®šï¼‰
    init() {
        const params = new URLSearchParams(window.location.search);
        this.isEnabled = params.get('mode') === 'mebuki';
        
        if (this.isEnabled) {
            this.createSproutButton();
        }
    }

    // ã‚¹ãƒ—ãƒ©ã‚¦ãƒˆãƒœã‚¿ãƒ³ä½œæˆ
    createSproutButton() {
        this.sproutButton = document.createElement('button');
        this.sproutButton.id = 'mebuki-sprout-btn';
        this.sproutButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#800000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 9.536V7a4 4 0 0 1 4-4h1.5a.5.5 0 0 1 .5.5V5a4 4 0 0 1-4 4 4 4 0 0 0-4 4c0 2 1 3 1 5a5 5 0 0 1-1 3"/>
                <path d="M4 9a5 5 0 0 1 8 4 5 5 0 0 1-8-4"/>
                <path d="M5 21h14"/>
            </svg>
        `;
        this.sproutButton.title = 'ã‚ã¶ãã«æŠ•ç¨¿';
        this.sproutButton.style.cssText = `
            position: fixed;
            top: 16px;
            right: 60px;
            width: 48px;
            height: 48px;
            background: rgba(255, 245, 230, 0.95);
            border: 2px solid #800000;
            border-radius: 50%;
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        `;
        
        this.sproutButton.onclick = async () => {
            await this.exportToMebuki();
        };
        
        document.body.appendChild(this.sproutButton);
    }

    // ã‚ã¶ãã¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆè‡ªå‹•å‡¦ç†ï¼‰
    async exportToMebuki() {
        try {
            // 1. APNGç”Ÿæˆ
            const blob = await this.app.exportManager.exportAPNG();
            
            // 2. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
            const thumbnail = await this.generateThumbnail();
            
            // 3. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
            const metadata = {
                format: 'apng',
                width: this.app.stateManager.state.canvasWidth,
                height: this.app.stateManager.state.canvasHeight,
                frames: this.app.animationSystem.totalFrames,
                thumbnail: thumbnail
            };
            
            // 4. ä»®æƒ³ã‚¢ãƒ«ãƒãƒ ã«ä¿å­˜
            const id = await window.virtualAlbum.saveAnimation(blob, metadata);
            
            // 5. ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            await window.virtualAlbum.copyToClipboard(id);
            
            // 6. å®Œäº†é€šçŸ¥
            alert('ã‚ã¶ãã‚¢ãƒ«ãƒãƒ ã«ä¿å­˜ã—ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\næ²ç¤ºæ¿ã§Ctrl+Vã—ã¦ãã ã•ã„ã€‚');
            
            // 7. ãƒ„ãƒ¼ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            // window.close();
            
        } catch (err) {
            console.error('Export error:', err);
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—: ' + err.message);
        }
    }

    // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
    async generateThumbnail() {
        const canvas = document.createElement('canvas');
        canvas.width = 200;
        canvas.height = 150;
        const ctx = canvas.getContext('2d');
        
        // TODO: ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        // æš«å®šï¼šç©ºã®ã‚­ãƒ£ãƒ³ãƒã‚¹
        ctx.fillStyle = '#d0c0b0';
        ctx.fillRect(0, 0, 200, 150);
        
        return canvas.toDataURL('image/png');
    }
}

4. ui/ui-panels.jsï¼ˆæ”¹ä¿®ï¼‰

===============================================================================
ãƒ•ã‚¡ã‚¤ãƒ«: ui/ui-panels.jsï¼ˆæ”¹ä¿®ï¼‰
æ”¹ä¿®å†…å®¹: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¢ãƒ«ãƒãƒ ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ AlbumPopup ã‚’è¡¨ç¤º
===============================================================================

// æ—¢å­˜ã®ã‚¢ãƒ«ãƒãƒ ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ï¼ˆè©²å½“ç®‡æ‰€ã‚’æ¢ã—ã¦ä¿®æ­£ï¼‰

+ // AlbumPopup ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆï¼ˆã‚¯ãƒ©ã‚¹å†…ï¼‰
+ this.albumPopup = new AlbumPopup(this.eventBus);

  // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¢ãƒ«ãƒãƒ ãƒœã‚¿ãƒ³ä½œæˆéƒ¨åˆ†ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼‰
  const albumBtn = document.createElement('button');
  albumBtn.innerHTML = `<svg>...</svg>`; // æ—¢å­˜ã®ã‚¢ãƒ«ãƒãƒ ã‚¢ã‚¤ã‚³ãƒ³
+ albumBtn.onclick = () => {
+     this.albumPopup.show();
+ };

5. system/export-manager.jsï¼ˆæ”¹ä¿®ï¼‰

===============================================================================
ãƒ•ã‚¡ã‚¤ãƒ«: system/export-manager.jsï¼ˆæ”¹ä¿®ï¼‰
æ”¹ä¿®å†…å®¹: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã«ä»®æƒ³ã‚¢ãƒ«ãƒãƒ ã¸ã®ä¿å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ 
===============================================================================

  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰å†…ã«è¿½åŠ 
  async exportAPNG() {
      const blob = await this.apngExporter.export(/* ... */);
      
+     // ä»®æƒ³ã‚¢ãƒ«ãƒãƒ ã«è‡ªå‹•ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
+     if (this.stateManager.state.autoSaveToAlbum) {
+         const thumbnail = await this.generateThumbnail();
+         await window.virtualAlbum.saveAnimation(blob, {
+             format: 'apng',
+             width: this.stateManager.state.canvasWidth,
+             height: this.stateManager.state.canvasHeight,
+             frames: this.animationSystem.totalFrames,
+             thumbnail: thumbnail
+         });
+     }
      
      return blob;
  }


6. index.htmlï¼ˆæ”¹ä¿®ï¼‰

===============================================================================
ãƒ•ã‚¡ã‚¤ãƒ«: index.htmlï¼ˆæ”¹ä¿®ï¼‰
æ”¹ä¿®å†…å®¹: æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿è¿½åŠ 
===============================================================================

  <script src="system/history.js"></script>
+ <script src="system/virtual-album.js"></script>
  <script src="system/animation-system.js"></script>
  
  <script src="ui/timeline-ui.js"></script>
+ <script src="ui/album-popup.js"></script>
  <script src="ui/ui-panels.js"></script>
  
+ <script src="mebuki-mode.js"></script>
  <script src="core-runtime.js"></script>

7. mebuki-loader.jsï¼ˆæ”¹ä¿®ï¼‰

===============================================================================
ãƒ•ã‚¡ã‚¤ãƒ«: mebuki-loader.jsï¼ˆæ”¹ä¿®ï¼‰
æ”¹ä¿®å†…å®¹: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ ?mode=mebuki ã‚’ä»˜ä¸ã—ã¦ãƒ„ãƒ¼ãƒ«ã‚’èµ·å‹•
===============================================================================

javascript:void(((d) => {
    // ãƒ„ãƒ¼ãƒ«URLã«ã‚ã¶ããƒ¢ãƒ¼ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ä¸
    const toolUrl = 'https://toshinka.github.io/tegaki/?mode=mebuki';
    
    // ãƒ„ãƒ¼ãƒ«ã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ã
    const toolTab = window.open(toolUrl, 'mebuki_tegaki');
    
    if (!toolTab) {
        alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚\nãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    toolTab.focus();
    
})(document));

ğŸ“‹ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

Phase 1: ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ 
â–¡ system/virtual-album.js ä½œæˆ
â–¡ ui/album-popup.js ä½œæˆ
â–¡ index.html ã«èª­ã¿è¾¼ã¿è¿½åŠ 
â–¡ ui/ui-panels.js ã«ã‚¢ãƒ«ãƒãƒ è¡¨ç¤ºå‡¦ç†è¿½åŠ 

Phase 2: ã‚ã¶ããƒ¢ãƒ¼ãƒ‰
â–¡ mebuki-mode.js ä½œæˆ
â–¡ ã‚¹ãƒ—ãƒ©ã‚¦ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤ºç¢ºèª
â–¡ è‡ªå‹•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‹•ä½œç¢ºèª

Phase 3: çµ±åˆãƒ†ã‚¹ãƒˆ
â–¡ ã‚¢ãƒ«ãƒãƒ ä¿å­˜/å‰Šé™¤ãƒ†ã‚¹ãƒˆ
â–¡ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ãƒ†ã‚¹ãƒˆï¼ˆAPNGï¼‰
â–¡ ã‚ã¶ã/ãµãŸã°ã¸ã®æŠ•ç¨¿ãƒ†ã‚¹ãƒˆ
â–¡ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã®å‹•ä½œç¢ºèª

Phase 4: UXæ”¹å–„
â–¡ ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆå®Ÿè£…
â–¡ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
â–¡ ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¿½åŠ ï¼ˆCtrl+Shift+A: ã‚¢ãƒ«ãƒãƒ è¡¨ç¤ºï¼‰

âš ï¸ æ³¨æ„äº‹é …
1. GIFã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIéå¯¾å¿œ
   â†’ APNGã‚’å„ªå…ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨ã—ã¦æ¨å¥¨

2. IndexedDBã¯åŒä¸€ã‚ªãƒªã‚¸ãƒ³é™å®š
   â†’ toshinka.github.io å†…ã§ã®ã¿æ©Ÿèƒ½

3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶ç´„
   â†’ åˆ¥ã‚¿ãƒ–/åˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³é–“ã®ç›´æ¥ãƒ‡ãƒ¼ã‚¿å…±æœ‰ã¯ä¸å¯
   â†’ postMessageã‚‚ä½¿ç”¨ä¸å¯ï¼ˆç•°ãªã‚‹ã‚ªãƒªã‚¸ãƒ³ã®ãŸã‚ï¼‰

4. ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ
   â†’ Chrome/Edge: å®Œå…¨å¯¾å¿œ
   â†’ Firefox: APNGå¯¾å¿œã‚ã‚Š
   â†’ Safari: è¦æ¤œè¨¼

ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

system/virtual-album.js ã‹ã‚‰å®Ÿè£…é–‹å§‹
ui/album-popup.js ã§UIæ§‹ç¯‰
ui/ui-panels.js ã«é€£æºå‡¦ç†è¿½åŠ 
å‹•ä½œç¢ºèªå¾Œã€ã‚ã¶ããƒ¢ãƒ¼ãƒ‰å®Ÿè£…