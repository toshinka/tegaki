# Undo/Redo ã‚·ã‚¹ãƒ†ãƒ  ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°è¨ˆç”»æ›¸

**ä½œæˆæ—¥**: 2025-10-04  
**å¯¾è±¡**: v8.13_anime23  
**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿æ‰€æœ‰æ¨©ã®æ˜ç¢ºåŒ–ã¨å …ç‰¢ãªUndo/Redoã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰

---

## ğŸ“Š ç¾çŠ¶åˆ†æ

### å•é¡Œç‚¹ãƒãƒˆãƒªã‚¯ã‚¹

| å•é¡Œ | å½±éŸ¿åº¦ | åŸå›  | å¯¾å¿œå„ªå…ˆåº¦ |
|------|--------|------|-----------|
| ãƒ‡ãƒ¼ã‚¿æ‰€æœ‰æ¨©ã®æ›–æ˜§ã• | â­â­â­â­â­ | LayerSystem ã¨ AnimationSystem ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒé‡è¤‡ | **æœ€å„ªå…ˆ** |
| ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã®é †åºä¸å®š | â­â­â­â­ | EventBusã«ã‚ˆã‚‹éåŒæœŸå‡¦ç† | é«˜ |
| Historyè¨˜éŒ²ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä¸çµ±ä¸€ | â­â­â­â­ | å„æ‰€ã§saveState()å‘¼ã³å‡ºã— | é«˜ |
| ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼ã®é™ç•Œ | â­â­â­ | å…¨ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ”ãƒ¼ã§é‡ã„ | ä¸­ |
| PixiJSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç®¡ç† | â­â­â­â­â­ | Graphics/Container ãŒã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸å¯ | **æœ€å„ªå…ˆ** |

### è¨ºæ–­çµæœã‚ˆã‚Š

```
âŒ LayerSystem API - LayerSystem instance not found
âŒ Configuration Consistency - Missing config section: drawing
21Ã— Sortable initialized for layer panel
```

â†’ ã‚·ã‚¹ãƒ†ãƒ é–“ã®çµåˆåº¦ãŒé«˜ã™ãã€å¤‰æ›´ãŒæ³¢åŠã—ã‚„ã™ã„

---

## ğŸ¯ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ç›®æ¨™

### 1. Single Source of Truth ã®ç¢ºç«‹
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’**1ç®‡æ‰€**ã§ç®¡ç†
- å„ã‚·ã‚¹ãƒ†ãƒ ã¯çŠ¶æ…‹ã‚’ã€Œå‚ç…§ã€ã™ã‚‹ã®ã¿

### 2. Command ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¾¹åº•
- ã™ã¹ã¦ã®æ“ä½œã‚’ Command ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒ–
- Execute / Undo ã‚’å¿…ãšå®Ÿè£…

### 3. çŠ¶æ…‹ã¨ãƒ“ãƒ¥ãƒ¼ã®åˆ†é›¢
- State: ç´”ç²‹ãªãƒ‡ãƒ¼ã‚¿ï¼ˆJSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ï¼‰
- View: PixiJS ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆState ã‹ã‚‰ç”Ÿæˆï¼‰

### 4. å·®åˆ†ç®¡ç†ã®å°å…¥
- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼ã‹ã‚‰å·®åˆ†ç®¡ç†ã¸
- ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®å‘ä¸Š

---

## ğŸ—ï¸ æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Application State Manager        â”‚
â”‚  (Single Source of Truth)               â”‚
â”‚  - cuts: Cut[]                          â”‚
â”‚  - currentCutIndex: number              â”‚
â”‚  - settings: AnimationSettings          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Command Queue  â”‚  â”‚  History Stack â”‚
â”‚ (Execute)      â”‚  â”‚  (Undo/Redo)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   View Renderer   â”‚
        â”‚  (PixiJS Layer)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```javascript
// State (ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½)
{
  cuts: [
    {
      id: "cut_xxx",
      name: "CUT1",
      duration: 0.5,
      layers: [
        {
          id: "layer_xxx",
          name: "ãƒ¬ã‚¤ãƒ¤ãƒ¼1",
          visible: true,
          opacity: 1.0,
          transform: { x, y, rotation, scaleX, scaleY },
          paths: [
            {
              id: "path_xxx",
              points: [{x, y}, ...],
              size: 16,
              color: 0x800000,
              opacity: 1.0,
              tool: "pen"
            }
          ]
        }
      ]
    }
  ],
  currentCutIndex: 0,
  settings: { loop: true }
}

// View (PixiJS ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
// State ã‹ã‚‰å‹•çš„ã«ç”Ÿæˆ
```

---

## ğŸ“¦ æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
system/
â”œâ”€â”€ state/
â”‚   â”œâ”€â”€ state-manager.js          # çŠ¶æ…‹ç®¡ç†ã®ä¸­æ ¸
â”‚   â”œâ”€â”€ state-serializer.js       # State â‡” JSON å¤‰æ›
â”‚   â””â”€â”€ state-validator.js        # çŠ¶æ…‹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
â”‚
â”œâ”€â”€ commands/
â”‚   â”œâ”€â”€ command-base.js            # Command åŸºåº•ã‚¯ãƒ©ã‚¹
â”‚   â”œâ”€â”€ layer-commands.js          # ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ Commands
â”‚   â”œâ”€â”€ cut-commands.js            # CUTæ“ä½œ Commands
â”‚   â””â”€â”€ drawing-commands.js        # æç”»æ“ä½œ Commands
â”‚
â”œâ”€â”€ history/
â”‚   â”œâ”€â”€ history-manager.js         # Undo/Redo ç®¡ç†ï¼ˆæ”¹ä¿®ç‰ˆï¼‰
â”‚   â””â”€â”€ diff-tracker.js            # å·®åˆ†ç®¡ç†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
â”‚
â””â”€â”€ view/
    â””â”€â”€ view-renderer.js           # State â†’ PixiJS å¤‰æ›
```

---

## ğŸ”§ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Phase 1: åŸºç›¤æ§‹ç¯‰ï¼ˆ3-4æ™‚é–“ï¼‰

#### Step 1.1: StateManager ã®å®Ÿè£…
```javascript
class StateManager {
  constructor() {
    this.state = this.createDefaultState();
    this.listeners = new Set();
  }
  
  // State å–å¾—ï¼ˆImmutableï¼‰
  getState() {
    return Object.freeze(structuredClone(this.state));
  }
  
  // State æ›´æ–°ï¼ˆCommandçµŒç”±ã®ã¿ï¼‰
  setState(newState) {
    this.state = newState;
    this.notifyListeners();
  }
  
  // Command å®Ÿè¡Œ
  execute(command) {
    const oldState = this.getState();
    const newState = command.execute(oldState);
    this.setState(newState);
    return { oldState, newState };
  }
}
```

#### Step 1.2: Command åŸºåº•ã‚¯ãƒ©ã‚¹
```javascript
class Command {
  constructor(metadata = {}) {
    this.id = `cmd_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    this.metadata = metadata;
    this.timestamp = Date.now();
  }
  
  // å¿…é ˆå®Ÿè£…
  execute(state) {
    throw new Error('execute() must be implemented');
  }
  
  // é€†æ“ä½œã®ç”Ÿæˆ
  createInverse(oldState, newState) {
    throw new Error('createInverse() must be implemented');
  }
}
```

#### Step 1.3: ViewRenderer ã®å®Ÿè£…
```javascript
class ViewRenderer {
  constructor(pixiApp, stateManager) {
    this.app = pixiApp;
    this.stateManager = stateManager;
    this.containerCache = new Map();
  }
  
  // State â†’ PixiJS Container
  render(state) {
    const cut = state.cuts[state.currentCutIndex];
    const container = this.createCutContainer(cut);
    return container;
  }
  
  createCutContainer(cutData) {
    const container = new PIXI.Container();
    cutData.layers.forEach(layerData => {
      const layer = this.createLayer(layerData);
      container.addChild(layer);
    });
    return container;
  }
  
  createLayer(layerData) {
    const layer = new PIXI.Container();
    layer.label = layerData.id;
    
    // Transform é©ç”¨
    layer.position.set(layerData.transform.x, layerData.transform.y);
    layer.rotation = layerData.transform.rotation;
    layer.scale.set(layerData.transform.scaleX, layerData.transform.scaleY);
    
    // Paths ã‚’æç”»
    layerData.paths.forEach(pathData => {
      const graphics = this.createPathGraphics(pathData);
      layer.addChild(graphics);
    });
    
    return layer;
  }
  
  createPathGraphics(pathData) {
    const graphics = new PIXI.Graphics();
    pathData.points.forEach(point => {
      graphics.circle(point.x, point.y, pathData.size / 2);
      graphics.fill({ color: pathData.color, alpha: pathData.opacity });
    });
    return graphics;
  }
}
```

---

### Phase 2: Command å®Ÿè£…ï¼ˆ2-3æ™‚é–“ï¼‰

#### CreateLayerCommand
```javascript
class CreateLayerCommand extends Command {
  constructor(cutIndex, layerData) {
    super({ type: 'layer:create' });
    this.cutIndex = cutIndex;
    this.layerData = layerData;
  }
  
  execute(state) {
    const newState = structuredClone(state);
    newState.cuts[this.cutIndex].layers.push(this.layerData);
    return newState;
  }
  
  createInverse(oldState, newState) {
    return new DeleteLayerCommand(
      this.cutIndex, 
      this.layerData.id
    );
  }
}
```

#### DeleteLayerCommand
```javascript
class DeleteLayerCommand extends Command {
  constructor(cutIndex, layerId) {
    super({ type: 'layer:delete' });
    this.cutIndex = cutIndex;
    this.layerId = layerId;
    this.deletedLayer = null; // Undoç”¨ã«ä¿å­˜
  }
  
  execute(state) {
    const newState = structuredClone(state);
    const layers = newState.cuts[this.cutIndex].layers;
    const index = layers.findIndex(l => l.id === this.layerId);
    
    if (index !== -1) {
      this.deletedLayer = layers[index];
      layers.splice(index, 1);
    }
    
    return newState;
  }
  
  createInverse(oldState, newState) {
    return new CreateLayerCommand(this.cutIndex, this.deletedLayer);
  }
}
```

#### DrawingCommand
```javascript
class DrawingCommand extends Command {
  constructor(cutIndex, layerId, pathData) {
    super({ type: 'drawing:add' });
    this.cutIndex = cutIndex;
    this.layerId = layerId;
    this.pathData = pathData;
  }
  
  execute(state) {
    const newState = structuredClone(state);
    const layer = newState.cuts[this.cutIndex].layers.find(l => l.id === this.layerId);
    
    if (layer) {
      layer.paths.push(this.pathData);
    }
    
    return newState;
  }
  
  createInverse(oldState, newState) {
    return new DeletePathCommand(
      this.cutIndex, 
      this.layerId, 
      this.pathData.id
    );
  }
}
```

---

### Phase 3: History çµ±åˆï¼ˆ1-2æ™‚é–“ï¼‰

#### æ–° HistoryManager
```javascript
class HistoryManager {
  constructor(stateManager) {
    this.stateManager = stateManager;
    this.undoStack = [];
    this.redoStack = [];
    this.maxHistory = 50;
  }
  
  // Command å®Ÿè¡Œ & å±¥æ­´è¨˜éŒ²
  execute(command) {
    const result = this.stateManager.execute(command);
    
    const inverseCommand = command.createInverse(
      result.oldState, 
      result.newState
    );
    
    this.undoStack.push(inverseCommand);
    this.redoStack = []; // Redo ã‚¹ã‚¿ãƒƒã‚¯ã‚’ã‚¯ãƒªã‚¢
    
    if (this.undoStack.length > this.maxHistory) {
      this.undoStack.shift();
    }
  }
  
  undo() {
    if (this.undoStack.length === 0) return false;
    
    const command = this.undoStack.pop();
    const result = this.stateManager.execute(command);
    
    const redoCommand = command.createInverse(
      result.oldState, 
      result.newState
    );
    
    this.redoStack.push(redoCommand);
    return true;
  }
  
  redo() {
    if (this.redoStack.length === 0) return false;
    
    const command = this.redoStack.pop();
    const result = this.stateManager.execute(command);
    
    const undoCommand = command.createInverse(
      result.oldState, 
      result.newState
    );
    
    this.undoStack.push(undoCommand);
    return true;
  }
}
```

---

### Phase 4: æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆï¼ˆ3-4æ™‚é–“ï¼‰

#### LayerSystem ã®æ”¹ä¿®
```javascript
class LayerSystem {
  constructor(stateManager, historyManager, viewRenderer) {
    this.stateManager = stateManager;
    this.historyManager = historyManager;
    this.viewRenderer = viewRenderer;
    
    // State å¤‰æ›´ã‚’ç›£è¦–
    this.stateManager.addListener((state) => {
      this.syncWithState(state);
    });
  }
  
  // æ–°è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ
  createLayer(name) {
    const state = this.stateManager.getState();
    const layerData = {
      id: `layer_${Date.now()}`,
      name: name,
      visible: true,
      opacity: 1.0,
      transform: { x: 0, y: 0, rotation: 0, scaleX: 1, scaleY: 1 },
      paths: []
    };
    
    const command = new CreateLayerCommand(
      state.currentCutIndex, 
      layerData
    );
    
    this.historyManager.execute(command);
  }
  
  // State ã¨ã®åŒæœŸ
  syncWithState(state) {
    const cut = state.cuts[state.currentCutIndex];
    
    // View ã‚’å†æ§‹ç¯‰
    const newContainer = this.viewRenderer.render(state);
    
    // æ—¢å­˜ Container ã¨ç½®ãæ›ãˆ
    this.replaceContainer(newContainer);
    
    // UI æ›´æ–°
    this.updateLayerPanelUI(cut.layers);
  }
}
```

---

## ğŸ“ˆ ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

### âœ… ãƒ¡ãƒªãƒƒãƒˆ

1. **å …ç‰¢æ€§**
   - ãƒ‡ãƒ¼ã‚¿ã®ä¸€è²«æ€§ãŒä¿è¨¼ã•ã‚Œã‚‹
   - Undo/Redo ãŒç¢ºå®Ÿã«å‹•ä½œ

2. **ä¿å®ˆæ€§**
   - ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãŒæ˜ç¢º
   - ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„

3. **æ‹¡å¼µæ€§**
   - æ–°ã—ã„æ“ä½œã‚’ Command ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã ã‘
   - å·®åˆ†ç®¡ç†ã¸ã®ç§»è¡ŒãŒå®¹æ˜“

4. **ãƒ‡ãƒãƒƒã‚°æ€§**
   - State ã®å±¥æ­´ã‚’ãƒˆãƒ¬ãƒ¼ã‚¹å¯èƒ½
   - Time Travel Debugging ãŒå¯èƒ½

### âŒ ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

1. **åˆæœŸå®Ÿè£…ã‚³ã‚¹ãƒˆ**
   - 3-4æ—¥ã®é–‹ç™ºæœŸé–“
   - æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®çµ±åˆä½œæ¥­

2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
   - `structuredClone()` ã®ã‚³ã‚¹ãƒˆ
   - å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã§ã¯å·®åˆ†ç®¡ç†ãŒå¿…è¦

3. **å­¦ç¿’ã‚³ã‚¹ãƒˆ**
   - Command ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç†è§£
   - Immutable æ€è€ƒã¸ã®è»¢æ›

---

## â±ï¸ å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| Phase | ä½œæ¥­å†…å®¹ | æ‰€è¦æ™‚é–“ | ç´¯è¨ˆ |
|-------|---------|---------|------|
| Phase 0 | è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»è©³ç´°ä»•æ§˜ | 2æ™‚é–“ | 2æ™‚é–“ |
| Phase 1 | åŸºç›¤æ§‹ç¯‰ | 4æ™‚é–“ | 6æ™‚é–“ |
| Phase 2 | Command å®Ÿè£… | 3æ™‚é–“ | 9æ™‚é–“ |
| Phase 3 | History çµ±åˆ | 2æ™‚é–“ | 11æ™‚é–“ |
| Phase 4 | æ—¢å­˜çµ±åˆ | 4æ™‚é–“ | 15æ™‚é–“ |
| Phase 5 | ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚° | 3æ™‚é–“ | 18æ™‚é–“ |
| Phase 6 | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ | 2æ™‚é–“ | **20æ™‚é–“** |

**åˆè¨ˆ**: ç´„20æ™‚é–“ï¼ˆ2.5æ—¥ï¼‰

---

## ğŸš€ æ®µéšçš„ç§»è¡Œè¨ˆç”»

### Option A: ãƒ“ãƒƒã‚°ãƒãƒ³ç§»è¡Œï¼ˆæ¨å¥¨ã—ãªã„ï¼‰
- ä¸€åº¦ã«å…¨ã‚·ã‚¹ãƒ†ãƒ ã‚’ç½®ãæ›ãˆ
- ãƒªã‚¹ã‚¯é«˜ã€ãƒ‡ãƒãƒƒã‚°å›°é›£

### Option B: æ®µéšçš„ç§»è¡Œï¼ˆæ¨å¥¨ï¼‰

#### Step 1: æç”»ã®ã¿ç§»è¡Œ
- DrawingCommand ã®å®Ÿè£…
- æ—¢å­˜ã® Layer/CUT ã‚·ã‚¹ãƒ†ãƒ ã¯ãã®ã¾ã¾

#### Step 2: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œç§»è¡Œ
- CreateLayerCommand, DeleteLayerCommand å®Ÿè£…
- LayerSystem ã‚’æ®µéšçš„ã«ç½®ãæ›ãˆ

#### Step 3: CUTæ“ä½œç§»è¡Œ
- CreateCutCommand, DeleteCutCommand å®Ÿè£…
- AnimationSystem ã‚’çµ±åˆ

#### Step 4: å®Œå…¨ç§»è¡Œ
- æ—¢å­˜ History ã‚·ã‚¹ãƒ†ãƒ ã‚’å‰Šé™¤
- æ–°ã‚·ã‚¹ãƒ†ãƒ ã«ä¸€æœ¬åŒ–

---

## ğŸ” ä»£æ›¿æ¡ˆ: æœ€å°é™ã®ä¿®æ­£

ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãŒå¤§è¦æ¨¡ã™ãã‚‹å ´åˆã€ä»¥ä¸‹ã®æœ€å°é™ä¿®æ­£ã‚‚å¯èƒ½ï¼š

### 1. Command Queue ã®å°å…¥
```javascript
class CommandQueue {
  constructor() {
    this.queue = [];
    this.isProcessing = false;
  }
  
  enqueue(command) {
    this.queue.push(command);
    this.process();
  }
  
  async process() {
    if (this.isProcessing) return;
    this.isProcessing = true;
    
    while (this.queue.length > 0) {
      const command = this.queue.shift();
      await command.execute();
      // History è¨˜éŒ²ã¯ã“ã“ã§ä¸€æ‹¬
      History.saveState();
    }
    
    this.isProcessing = false;
  }
}
```

### 2. State Synchronizer ã®è¿½åŠ 
```javascript
class StateSynchronizer {
  constructor(layerSystem, animationSystem) {
    this.layerSystem = layerSystem;
    this.animationSystem = animationSystem;
  }
  
  // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
  capture() {
    const cut = this.animationSystem.getCurrentCut();
    return {
      cutId: cut.id,
      layers: cut.getLayers().map(this.serializeLayer)
    };
  }
  
  // çŠ¶æ…‹ã‚’å¾©å…ƒ
  restore(snapshot) {
    const cut = this.animationSystem.getCurrentCut();
    // ... å¾©å…ƒå‡¦ç†
  }
}
```

**æ‰€è¦æ™‚é–“**: 4-6æ™‚é–“

---

## ğŸ“Š æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### ğŸ¯ çŸ­æœŸï¼ˆä»Šã™ãï¼‰
**æœ€å°é™ä¿®æ­£** ã‚’å®Ÿæ–½
- Command Queue å°å…¥
- State Synchronizer è¿½åŠ 
- æ‰€è¦æ™‚é–“: 4-6æ™‚é–“

### ğŸ¯ ä¸­æœŸï¼ˆ1-2é€±é–“å¾Œï¼‰
**æ®µéšçš„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°** é–‹å§‹
- Phase 1-2 ã®å®Ÿè£…
- æç”»ã‚·ã‚¹ãƒ†ãƒ ã®ã¿ç§»è¡Œ
- æ‰€è¦æ™‚é–“: 8-10æ™‚é–“

### ğŸ¯ é•·æœŸï¼ˆ1ãƒ¶æœˆå¾Œï¼‰
**å®Œå…¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°** å®Œäº†
- Phase 3-6 å®Œäº†
- å…¨ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
- æ‰€è¦æ™‚é–“: ç´¯è¨ˆ20æ™‚é–“

---

## ğŸ“¦ æˆæœç‰©

ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Œäº†å¾Œã€ä»¥ä¸‹ã‚’æä¾›ï¼š

1. **æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**
   - `state-manager.js`
   - `command-base.js`
   - `layer-commands.js`
   - `drawing-commands.js`
   - `history-manager.js`
   - `view-renderer.js`

2. **æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«**
   - `layer-system.js`ï¼ˆçµ±åˆç‰ˆï¼‰
   - `animation-system.js`ï¼ˆçµ±åˆç‰ˆï¼‰
   - `core-engine.js`ï¼ˆçµ±åˆç‰ˆï¼‰

3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**
   - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³
   - API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
   - ç§»è¡Œã‚¬ã‚¤ãƒ‰

---

## ğŸ¤ æ±ºå®šäº‹é …

ä»¥ä¸‹ã‚’æ±ºå®šã—ã¦ãã ã•ã„ï¼š

1. **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒé¸æŠ**
   - [ ] æœ€å°é™ä¿®æ­£ï¼ˆ4-6æ™‚é–“ï¼‰
   - [ ] æ®µéšçš„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆ20æ™‚é–“ï¼‰
   - [ ] ç¾çŠ¶ç¶­æŒï¼ˆå€‹åˆ¥ãƒã‚°ä¿®æ­£ã®ã¿ï¼‰

2. **å„ªå…ˆåº¦**
   - [ ] Undo/Redo ã®å®Œå…¨å‹•ä½œãŒæœ€å„ªå…ˆ
   - [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚‚é‡è¦–
   - [ ] ä¿å®ˆæ€§ãƒ»æ‹¡å¼µæ€§ã‚‚è€ƒæ…®

3. **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**
   - å®Ÿè£…é–‹å§‹æ—¥: ____________
   - å®Œäº†ç›®æ¨™æ—¥: ____________

---

**ä½œæˆè€…**: Claude  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**æœ€çµ‚æ›´æ–°**: 2025-10-04