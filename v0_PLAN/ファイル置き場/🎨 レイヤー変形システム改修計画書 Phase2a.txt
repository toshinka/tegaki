ğŸ¨ ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢ã‚·ã‚¹ãƒ†ãƒ æ”¹ä¿®è¨ˆç”»æ›¸ Phase2a
åº§æ¨™ç³»çµ±ä¸€ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–å®‰å…¨åŒ–å¯¾å¿œ
ğŸ“‹ ç¾çŠ¶å•é¡Œã®è©³ç´°åˆ†æ
ğŸš¨ Critical Issue 1: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹æ™‚ã®åº§æ¨™é£›ã³
ç—‡çŠ¶: VæŠ¼ä¸‹æ™‚ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå·¦ä¸Š(0,0ä»˜è¿‘)ã«ç§»å‹•
æ ¹æœ¬åŸå› :
javascript// å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ï¼ˆcore-engine.js:L1089-1111ï¼‰
updateActiveLayerTransform(property, value) {
    switch(property) {
        case 'x':
            transform.x = value;
            activeLayer.position.set(centerX + value, centerY + transform.y); // âŒå•é¡Œ
            break;
        case 'rotation':
            transform.rotation = value;
            activeLayer.pivot.set(centerX, centerY);  // âŒ æ¯å›pivotå†è¨­å®š
            activeLayer.position.set(centerX + transform.x, centerY + transform.y);
            activeLayer.rotation = value;
            break;
    }
}
åŸå› åˆ†æ:

enterLayerMoveMode() æ™‚ã«æ—¢å­˜ã®positionçŠ¶æ…‹ã‚’transform dataã«åæ˜ ã—ã¦ã„ãªã„
pivotè¨­å®šãŒå¤‰å½¢ç¨®åˆ¥ã«ã‚ˆã£ã¦ä¸æ•´åˆ
åº§æ¨™ç³»ã®åŸºæº–ç‚¹ãŒå‡¦ç†ã«ã‚ˆã£ã¦ç•°ãªã‚‹

ğŸš¨ Critical Issue 2: XYç§»å‹•å¾Œã®å›è»¢è»¸ã‚ºãƒ¬
ç—‡çŠ¶: XYç§»å‹•å¾Œã®å›è»¢è»¸ãŒçµµã®ä¸­å¿ƒã«ãªã‚‹ï¼ˆæœŸå¾…ï¼šã‚«ãƒ¡ãƒ©ãƒ•ãƒ¬ãƒ¼ãƒ ä¸­å¤®ï¼‰
æ ¹æœ¬åŸå› :
javascript// å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ï¼ˆcore-engine.js:L1393-1420ï¼‰
if (e.shiftKey) {
    // åŸºæº–ç‚¹ã‚’ã‚«ãƒ¡ãƒ©ä¸­å¤®ã«è¨­å®š
    activeLayer.pivot.set(centerX, centerY);
    activeLayer.position.set(centerX + transform.x, centerY + transform.y);
    // âŒ transform.x, transform.y ãŒç´¯ç©ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å®Ÿéš›ã®å›è»¢è»¸ãŒã‚ºãƒ¬ã‚‹
}
ğŸ¯ è¨­è¨ˆåŸå‰‡ãƒ»çµ±ä¸€ãƒ«ãƒ¼ãƒ«å®šç¾©
Coordinate System Rules (åº§æ¨™ç³»çµ±ä¸€ãƒ«ãƒ¼ãƒ«)
javascript/**
 * åº§æ¨™ç³»çµ±ä¸€å®šç¾©:
 * 
 * 1. CAMERA_CENTER: ã‚«ãƒ¡ãƒ©ãƒ•ãƒ¬ãƒ¼ãƒ ä¸­å¤®åº§æ¨™ (CONFIG.canvas.width/2, CONFIG.canvas.height/2)
 *    - å…¨ã¦ã®å¤‰å½¢ã®åŸºæº–ç‚¹
 *    - pivotè¨­å®šã®å›ºå®šåŸºæº–
 * 
 * 2. TRANSFORM_DATA: å¤‰å½¢ãƒ‡ãƒ¼ã‚¿åº§æ¨™ç³»
 *    - ã‚«ãƒ¡ãƒ©ä¸­å¤®åŸºæº–ã®ç›¸å¯¾åº§æ¨™ (-âˆ to +âˆ)
 *    - ç·¨é›†ç”¨ã®è«–ç†åº§æ¨™
 *    - å½¢å¼: { x: number, y: number, rotation: radian, scaleX: number, scaleY: number }
 * 
 * 3. DISPLAY_COORDINATES: è¡¨ç¤ºåº§æ¨™ç³»
 *    - PixiJSå®Ÿåº§æ¨™ (position/pivot/rotation/scale)
 *    - è¨ˆç®—å¼: position = CAMERA_CENTER + TRANSFORM_DATA.offset
 *    - pivot = CAMERA_CENTER (å›ºå®š)
 * 
 * 4. INVARIANT_RULES (ä¸å¤‰æ¡ä»¶):
 *    - pivot ã¯å¸¸ã« CAMERA_CENTER
 *    - å›è»¢è»¸ã¯å¸¸ã« CAMERA_CENTER
 *    - position = CAMERA_CENTER + transform offset
 */
Transform State Management (å¤‰å½¢çŠ¶æ…‹ç®¡ç†)
javascript/**
 * å¤‰å½¢çŠ¶æ…‹ã®å®šç¾©:
 * 
 * EDIT_MODE: ç·¨é›†ä¸­çŠ¶æ…‹
 *   - transform data: ç·¨é›†ä¸­ã®ç´¯ç©å€¤
 *   - display state: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
 *   - åŸºæº–: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ = transform data
 * 
 * CONFIRMED_MODE: ç¢ºå®šæ¸ˆã¿çŠ¶æ…‹  
 *   - transform data: ç¢ºå®šæ¸ˆã¿ç´¯ç©å€¤
 *   - display state: ç¢ºå®šæ¸ˆã¿è¡¨ç¤º
 *   - åŸºæº–: è¡¨ç¤ºçŠ¶æ…‹ = transform data
 * 
 * STATE_TRANSITION: çŠ¶æ…‹é·ç§»
 *   CONFIRMED â†’ EDIT: normalize â†’ apply unified transform
 *   EDIT â†’ CONFIRMED: preserve display state â†’ update transform data
 */
ğŸ—ï¸ APIè¨­è¨ˆãƒ»ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©
Core Methods (ã‚³ã‚¢ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©)
1. åº§æ¨™æ­£è¦åŒ–ãƒ¡ã‚½ãƒƒãƒ‰
javascript/**
 * ç¾åœ¨ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’å¤‰å½¢ãƒ‡ãƒ¼ã‚¿ã«æ­£è¦åŒ–
 * @param {PIXI.Container} layer - å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼
 * @returns {TransformData} æ­£è¦åŒ–ã•ã‚ŒãŸå¤‰å½¢ãƒ‡ãƒ¼ã‚¿
 */
normalizeTransformFromDisplayState(layer) {
    const centerX = CONFIG.canvas.width / 2;
    const centerY = CONFIG.canvas.height / 2;
    
    return {
        x: layer.position.x - centerX,
        y: layer.position.y - centerY,
        rotation: layer.rotation,
        scaleX: layer.scale.x,
        scaleY: layer.scale.y
    };
}
2. çµ±ä¸€å¤‰å½¢é©ç”¨ãƒ¡ã‚½ãƒƒãƒ‰
javascript/**
 * å¤‰å½¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºçŠ¶æ…‹ã«çµ±ä¸€é©ç”¨
 * @param {PIXI.Container} layer - å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼
 * @param {TransformData} transform - å¤‰å½¢ãƒ‡ãƒ¼ã‚¿
 * @param {boolean} preserveRotationCenter - å›è»¢ä¸­å¿ƒä¿æŒãƒ•ãƒ©ã‚°
 */
applyUnifiedTransform(layer, transform, preserveRotationCenter = true) {
    const centerX = CONFIG.canvas.width / 2;
    const centerY = CONFIG.canvas.height / 2;
    
    if (preserveRotationCenter) {
        // pivot ã‚’å¸¸ã«ã‚«ãƒ¡ãƒ©ä¸­å¤®å›ºå®šï¼ˆå›è»¢è»¸çµ±ä¸€ï¼‰
        layer.pivot.set(centerX, centerY);
    }
    
    // position = ä¸­å¤® + å¤‰å½¢ã‚ªãƒ•ã‚»ãƒƒãƒˆ
    layer.position.set(centerX + transform.x, centerY + transform.y);
    
    // rotation/scale ç›´æ¥é©ç”¨
    layer.rotation = transform.rotation;
    layer.scale.set(transform.scaleX, transform.scaleY);
}
3. å®‰å…¨ãªç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
javascript/**
 * ç·¨é›†ãƒ¢ãƒ¼ãƒ‰å®‰å…¨åˆæœŸåŒ–ï¼ˆåº§æ¨™é£›ã³é˜²æ­¢ï¼‰
 */
enterLayerMoveModeSafe() {
    if (this.isLayerMoveMode) return;
    
    const activeLayer = this.getActiveLayer();
    if (!activeLayer) return;
    
    // Step 1: ç¾åœ¨ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ­£è¦åŒ–
    const normalizedTransform = this.normalizeTransformFromDisplayState(activeLayer);
    
    // Step 2: æ­£è¦åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    this.layerTransforms.set(activeLayer.layerData.id, normalizedTransform);
    
    // Step 3: çµ±ä¸€å¤‰å½¢ã‚’é©ç”¨ï¼ˆåº§æ¨™ç³»çµ±ä¸€ï¼‰
    this.applyUnifiedTransform(activeLayer, normalizedTransform);
    
    // Step 4: UIçŠ¶æ…‹æ›´æ–°
    this.isLayerMoveMode = true;
    this.vKeyPressed = true;
    this.cameraSystem.setVKeyPressed(true);
    
    // Step 5: ãƒ‘ãƒãƒ«ãƒ»ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³è¡¨ç¤º
    if (this.layerTransformPanel) {
        this.layerTransformPanel.classList.add('show');
        this.updateLayerTransformPanelValues();
    }
    this.cameraSystem.showGuideLines();
    this.updateCursor();
}
Data Flow Definition (ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å®šç¾©)
mermaidgraph TD
    A[Display State] -->|normalizeTransformFromDisplayState| B[Transform Data]
    B -->|applyUnifiedTransform| C[Unified Display State]
    C -->|User Interaction| D[Modified Transform Data]
    D -->|Real-time Update| E[Live Display]
    E -->|Confirm V Key| F[Preserved Display State]
    F -->|Next Edit Mode| A
ğŸ”§ ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰
core-engine.js ä¿®æ­£ç®‡æ‰€
1. LayerManager Class
ä¿®æ­£ãƒ¡ã‚½ãƒƒãƒ‰:

enterLayerMoveMode() â†’ enterLayerMoveModeSafe()
updateActiveLayerTransform() â†’ çµ±ä¸€åº§æ¨™ç³»å¯¾å¿œ
confirmLayerTransform() â†’ æ—¢å­˜preserveæ©Ÿèƒ½ç¶­æŒ

è¿½åŠ ãƒ¡ã‚½ãƒƒãƒ‰:

normalizeTransformFromDisplayState(layer)
applyUnifiedTransform(layer, transform, preserveRotationCenter)
getCanvasCenter() - DRYåŸå‰‡

2. å½±éŸ¿ç¯„å›²
Direct Impact:

Line 1050-1200: LayerManager.updateActiveLayerTransform()
Line 1250-1300: LayerManager.enterLayerMoveMode()
Line 800-850: LayerManager.updateLayerTransformPanelValues()

Indirect Impact:

ClipboardSystem.getEffectiveTransform() - åº§æ¨™ç³»çµ±ä¸€å¯¾å¿œ
Thumbnailç”Ÿæˆ - pivot/positionçŠ¶æ…‹å¤‰æ›´å¯¾å¿œ

ğŸ§ª ãƒ†ã‚¹ãƒˆé …ç›®ãƒ»æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ
Regression Tests (ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ)

éç ´å£Šç·¨é›†: å›è»¢â†’ç¢ºå®šâ†’å†ç·¨é›†ã§çŠ¶æ…‹ç¶­æŒ
å±¥æ­´æ©Ÿèƒ½: ã‚¢ãƒ³ãƒ‰ã‚¥ãƒ»ãƒªãƒ‰ã‚¥ã®æ­£å¸¸å‹•ä½œ
ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ: å¤‰å½¢çŠ¶æ…‹ã®æ­£ç¢ºãªã‚³ãƒ”ãƒ¼
ã‚µãƒ ãƒã‚¤ãƒ«: ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢ã®æ­£ç¢ºãªåæ˜ 

New Feature Tests (æ–°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ)

åº§æ¨™é£›ã³é˜²æ­¢: VæŠ¼ä¸‹æ™‚ã®åˆæœŸä½ç½®ç¶­æŒ
å›è»¢è»¸çµ±ä¸€: XYç§»å‹•å¾Œã‚‚ã‚«ãƒ¡ãƒ©ä¸­å¤®è»¸å›è»¢
ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ•´åˆæ€§: è¡¨ç¤ºçŠ¶æ…‹ã¨UIå€¤ã®ä¸€è‡´

ğŸ¯ å®Ÿè£…å„ªå…ˆé †ä½ãƒ»Phaseåˆ†ã‘
Phase 2a-1: Critical Fix (ç·Šæ€¥ä¿®æ­£)
æœŸé–“: å³åº§
å†…å®¹:

åº§æ¨™é£›ã³é˜²æ­¢ (enterLayerMoveModeSafe())
åŸºæœ¬åº§æ¨™ç³»çµ±ä¸€ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 

Phase 2a-2: Rotation Center Fix (å›è»¢è»¸ä¿®æ­£)
æœŸé–“: Phase 2a-1å®Œäº†å¾Œ
å†…å®¹:

å›è»¢è»¸ã‚«ãƒ¡ãƒ©ä¸­å¤®å›ºå®šåŒ–
applyUnifiedTransform() å®Œå…¨çµ±ä¸€

Phase 2a-3: Code Cleanup (ã‚³ãƒ¼ãƒ‰æ•´ç†)
æœŸé–“: Phase 2a-2å®Œäº†å¾Œ
å†…å®¹:

é‡è¤‡ã‚³ãƒ¼ãƒ‰é™¤å»
çµ±ä¸€APIä½¿ç”¨ã¸ã®ç½®ãæ›ãˆ

ğŸš¨ ãƒªã‚¹ã‚¯è¦å› ãƒ»å¯¾ç­–
High Risk

pivotå¤‰æ›´ã«ã‚ˆã‚‹ã‚µãƒ ãƒã‚¤ãƒ«æç”»å½±éŸ¿

å¯¾ç­–: ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ™‚ã®ä¸€æ™‚çš„stateä¿å­˜ãƒ»å¾©å…ƒ


æ—¢å­˜ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åº§æ¨™ç³»ä¸æ•´åˆ

å¯¾ç­–: é–‹å§‹æ™‚ã®è‡ªå‹•æ­£è¦åŒ–å‡¦ç†



Medium Risk

ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿ï¼ˆæ­£è¦åŒ–å‡¦ç†å¢—åŠ ï¼‰

å¯¾ç­–: å¿…è¦æ™‚ã®ã¿å®Ÿè¡Œãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨



ğŸ’¡ æ”¹ä¿®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ¨å¥¨
æ®µéšçš„ä¿®æ­£ + å¾Œæ–¹äº’æ›æ€§ç¶­æŒã‚’æ¨å¥¨
ç†ç”±:

æ—¢å­˜æ©Ÿèƒ½ï¼ˆéç ´å£Šç·¨é›†ãƒ»å±¥æ­´ï¼‰ã®å®‰å®šç¨¼åƒ
å€‹åˆ¥æ¤œè¨¼ãƒ»ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½å¯èƒ½æ€§
å•é¡Œç™ºç”Ÿæ™‚ã®åˆ‡ã‚Šåˆ†ã‘ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®¹æ˜“æ€§
Claudeæ”¹ä¿®æ™‚ã®ä½œæ¥­ç¯„å›²æ˜ç¢ºåŒ–