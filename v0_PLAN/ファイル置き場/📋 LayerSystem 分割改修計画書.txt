ğŸ“‹ LayerSystem åˆ†å‰²æ”¹ä¿®è¨ˆç”»æ›¸
ğŸ¯ æ”¹ä¿®ç›®çš„
ç¾çŠ¶: layer-system.js ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ å®šç¾©ãƒ»åº§æ¨™ç³»å‡¦ç†ãƒ»æç”»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒæ··åœ¨
ç›®æ¨™: åº§æ¨™ç³»åŸºç›¤ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’åˆ†é›¢ã—ã€CUTãƒ•ã‚©ãƒ«ãƒ€æ–¹å¼ã®ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã«å‚™ãˆã‚‹
ğŸ“ åˆ†å‰²æ–¹é‡
ç¾è¡Œ: layer-system.js (1000+ lines)
  â”œâ”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ å®šç¾©
  â”œâ”€ åº§æ¨™ç³»ç›´çµå‡¦ç†
  â”œâ”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  â””â”€ æç”»è£œåŠ©é–¢æ•°
  
æ”¹ä¿®å¾Œ:
  â”œâ”€ layer-system.js (600 lines)
  â”‚   â”œâ”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ å®šç¾©ï¼ˆbackgroundLayer, drawingLayerç­‰ï¼‰
  â”‚   â”œâ”€ Pixi Containeréšå±¤ç®¡ç†
  â”‚   â”œâ”€ CameraSystemé€£æº
  â”‚   â””â”€ åˆæœŸåŒ–/ç ´æ£„å‡¦ç†
  â”‚
  â””â”€ layer-utils.js (300 lines) â˜…æ–°è¦
      â”œâ”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œï¼ˆè¿½åŠ /å‰Šé™¤/å¯è¦–æ€§ï¼‰
      â”œâ”€ åº§æ¨™ç³»å¤‰æ›è£œåŠ©
      â”œâ”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒªã‚¢/æ¤œç´¢
      â””â”€ Transformè£œåŠ©é–¢æ•°
ğŸ—‚ï¸ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
æ–°è¦ä½œæˆ: system/layer-utils.js
javascript/**
 * LayerUtils - ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * åº§æ¨™ç³»å¤‰æ›ãƒ»ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œã®è£œåŠ©é–¢æ•°ç¾¤
 * LayerSystemã‹ã‚‰åˆ†é›¢ã—ã€å†åˆ©ç”¨æ€§ã‚’å‘ä¸Š
 */
window.LayerUtils = {
    // ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ
    clearLayer(layer) { /*...*/ },
    addGraphicsToLayer(layer, graphics) { /*...*/ },
    removeGraphicsFromLayer(layer, graphics) { /*...*/ },
    
    // åº§æ¨™ç³»å¤‰æ›
    toLocalCoordinates(layer, globalX, globalY) { /*...*/ },
    toGlobalCoordinates(layer, localX, localY) { /*...*/ },
    
    // ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¶å¾¡
    setLayerVisibility(layer, visible) { /*...*/ },
    setLayerOpacity(layer, alpha) { /*...*/ },
    
    // æ¤œç´¢ãƒ»å–å¾—
    findLayerByLabel(container, label) { /*...*/ },
    getAllDrawableLayers(container) { /*...*/ }
};
æ”¹ä¿®: system/layer-system.js

å‰Šé™¤: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤
è¿½åŠ : LayerUtils ã¸ã®ä¾å­˜
ä¿æŒ: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ å®šç¾©ã€CameraSystemé€£æº


ğŸ“š ãƒ¡ã‚½ãƒƒãƒ‰è¾å…¸
ğŸ†• LayerUtilsï¼ˆæ–°è¦ä½œæˆï¼‰
ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œç³»
ãƒ¡ã‚½ãƒƒãƒ‰èª¬æ˜å¼•æ•°æˆ»ã‚Šå€¤clearLayer(layer)ãƒ¬ã‚¤ãƒ¤ãƒ¼å†…ã®å…¨æç”»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤PIXI.ContainervoidaddGraphicsToLayer(layer, graphics)Graphicsã‚’ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿½åŠ Container, GraphicsvoidremoveGraphicsFromLayer(layer, graphics)Graphicsã‚’ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰å‰Šé™¤Container, Graphicsboolean
åº§æ¨™ç³»å¤‰æ›
ãƒ¡ã‚½ãƒƒãƒ‰èª¬æ˜å¼•æ•°æˆ»ã‚Šå€¤toLocalCoordinates(layer, globalX, globalY)ã‚°ãƒ­ãƒ¼ãƒãƒ«åº§æ¨™â†’ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™Container, number, number{x, y}toGlobalCoordinates(layer, localX, localY)ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™â†’ã‚°ãƒ­ãƒ¼ãƒãƒ«åº§æ¨™Container, number, number{x, y}screenToLayerCoordinates(layer, screenX, screenY, renderer)ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™â†’ãƒ¬ã‚¤ãƒ¤ãƒ¼åº§æ¨™Container, number, number, Renderer{x, y}
ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¶å¾¡
ãƒ¡ã‚½ãƒƒãƒ‰èª¬æ˜å¼•æ•°æˆ»ã‚Šå€¤setLayerVisibility(layer, visible)ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯è¦–æ€§è¨­å®šContainer, booleanvoidsetLayerOpacity(layer, alpha)ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸é€æ˜åº¦è¨­å®šContainer, numbervoidtoggleLayerVisibility(layer)ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯è¦–æ€§ãƒˆã‚°ãƒ«Containerboolean
æ¤œç´¢ãƒ»å–å¾—
ãƒ¡ã‚½ãƒƒãƒ‰èª¬æ˜å¼•æ•°æˆ»ã‚Šå€¤findLayerByLabel(container, label)ãƒ©ãƒ™ãƒ«ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¤œç´¢Container, stringContainer | nullgetAllDrawableLayers(container)æç”»å¯èƒ½ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§å–å¾—ContainerArray<Container>getLayerAtIndex(container, index)ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—Container, numberContainer | null
Transformè£œåŠ©
ãƒ¡ã‚½ãƒƒãƒ‰èª¬æ˜å¼•æ•°æˆ»ã‚Šå€¤getLayerTransform(layer)ãƒ¬ã‚¤ãƒ¤ãƒ¼Transformå–å¾—Container{x, y, rotation, scaleX, scaleY}setLayerTransform(layer, transform)ãƒ¬ã‚¤ãƒ¤ãƒ¼Transformè¨­å®šContainer, ObjectvoidresetLayerTransform(layer)ãƒ¬ã‚¤ãƒ¤ãƒ¼Transformãƒªã‚»ãƒƒãƒˆContainervoid

ğŸ”„ LayerSystemï¼ˆæ”¹ä¿®ï¼‰
ç¶™æ‰¿ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå¤‰æ›´ãªã—ï¼‰
ãƒ¡ã‚½ãƒƒãƒ‰èª¬æ˜çŠ¶æ…‹setupLayers(stage, config)ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤åˆæœŸåŒ–ç¶™æ‰¿getDrawingLayer()æç”»ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—ç¶™æ‰¿getUILayer()UIãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—ç¶™æ‰¿getOverlayLayer()ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—ç¶™æ‰¿destroy()ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ç ´æ£„ç¶™æ‰¿
æ”¹ä¿®ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆLayerUtilså‘¼ã³å‡ºã—ã«å¤‰æ›´ï¼‰
ãƒ¡ã‚½ãƒƒãƒ‰å¤‰æ›´å†…å®¹clearDrawingLayer()å†…éƒ¨ã§LayerUtils.clearLayer()å‘¼ã³å‡ºã—addToDrawingLayer(obj)å†…éƒ¨ã§LayerUtils.addGraphicsToLayer()å‘¼ã³å‡ºã—screenToDrawingCoords(x, y)å†…éƒ¨ã§LayerUtils.screenToLayerCoordinates()å‘¼ã³å‡ºã—
æ–°è¦è¿½åŠ ï¼ˆCUTãƒ•ã‚©ãƒ«ãƒ€å¯¾å¿œï¼‰
ãƒ¡ã‚½ãƒƒãƒ‰èª¬æ˜å¼•æ•°æˆ»ã‚Šå€¤setCurrentCutContainer(cutContainer)ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTè¨­å®šContainervoidgetCurrentCutContainer()ç¾åœ¨ã®CUTå–å¾—ãªã—Container

ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼
åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼
1. index.html
   â†“ <script src="system/layer-utils.js"></script>
   â†“ <script src="system/layer-system.js"></script>
   
2. LayerUtils ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ç™»éŒ²
   window.LayerUtils = { ... }
   
3. LayerSystem åˆæœŸåŒ–æ™‚
   setupLayers(stage, config) {
       this.backgroundLayer = new PIXI.Container();
       // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£åˆ©ç”¨ä¾‹
       LayerUtils.setLayerVisibility(this.backgroundLayer, true);
   }
CUTåˆ‡ã‚Šæ›¿ãˆãƒ•ãƒ­ãƒ¼ï¼ˆä»Šå¾Œã®ã‚µãƒ ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
1. AnimationSystem.switchToActiveCut(cutIndex)
   â†“
2. LayerSystem.setCurrentCutContainer(cut.container)
   â†“
3. LayerUtils.getAllDrawableLayers(cut.container)
   â†’ ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§å–å¾—
   â†“
4. UIæ›´æ–°
   â†’ ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«è¡¨ç¤º
åº§æ¨™å¤‰æ›ãƒ•ãƒ­ãƒ¼
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¦ã‚¹ç§»å‹•ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ï¼‰
   â†“
2. LayerUtils.screenToLayerCoordinates(layer, x, y, renderer)
   â†“ å†…éƒ¨å‡¦ç†
   - renderer.events.pointer ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«åº§æ¨™å–å¾—
   - layer.toLocal() ã§ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™å¤‰æ›
   â†“
3. æç”»ã‚·ã‚¹ãƒ†ãƒ ã«æ¸¡ã™