ğŸ¨ Futaba Drawing Tool v8 â€” Pixi UI + Layers å®Ÿè£…è¨ˆç”»ï¼ˆæ”¹è¨‚ç‰ˆï¼‰
1. ç›®çš„

@pixi/ui ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã‚’æ§‹ç¯‰ï¼ˆï¼‹ï¼å‰Šé™¤ã®ã¿ã®æœ€å°UIï¼‰

@pixi/layers ã§èƒŒæ™¯ï¼‹æç”»ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç®¡ç†

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆLayer 0ï¼‰ï¼‹é€æ˜ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆLayer 1ï¼‰ ã‚’ç”¨æ„ã—ã€Layer 1 ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–

ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ã®ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã§é †åºå¤‰æ›´ã‚’å¯èƒ½ã«ï¼ˆä½™è£•ãŒã‚ã‚Œã°å®Ÿè£…ï¼‰

2. æ§‹é€ è¨­è¨ˆ
2.1 Pixi Application éšå±¤
PIXI.Application
 â”œâ”€ Stage (root)
 â”‚   â”œâ”€ UILayer (@pixi/ui)
 â”‚   â””â”€ DrawingLayerGroup (@pixi/layers)
 â”‚        â”œâ”€ Layer 0: èƒŒæ™¯   â† è‰² #f0e0d6 å›ºå®š
 â”‚        â””â”€ Layer 1: æç”»   â† ç„¡è‰²é€æ˜ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–

2.2 UIæ§‹é€ ï¼ˆPixi UIï¼‰

ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«

ãƒªã‚¹ãƒˆå½¢å¼ã§ Layer 0, 1 ã‚’è¡¨ç¤º

å„é …ç›®ã¯ï¼š

ğŸ—‚ ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼ˆãƒ©ãƒ™ãƒ«ï¼‰

â• æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆæœ«å°¾ã« Layer n ã‚’è¿½åŠ ï¼‰

ğŸ—‘ å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆLayer 0 ã¯å‰Šé™¤ä¸å¯ï¼‰

ä¸¦ã¹æ›¿ãˆï¼šUIDraggable ã‚’ä½¿ã£ã¦ãƒ‰ãƒ©ãƒƒã‚°é †åºã‚’ã‚µãƒãƒ¼ãƒˆï¼ˆä½™è£•ãŒã‚ã‚Œã°å°å…¥ï¼‰

3. æ©Ÿèƒ½åˆ¥è¨ˆç”»
3.1 ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ï¼ˆ@pixi/layersï¼‰

åˆæœŸåŒ–

Layer 0 = èƒŒæ™¯ï¼ˆPIXI.Graphics ã§å¡—ã‚Š #f0e0d6ã€ä¸€åˆ‡å‰Šé™¤ä¸å¯ï¼‰

Layer 1 = ç„¡è‰²é€æ˜ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æç”»å¯¾è±¡

è¿½åŠ 

ï¼‹ãƒœã‚¿ãƒ³ â†’ new Layer() ã§ç”Ÿæˆã—ã€ãƒªã‚¹ãƒˆã¨ DrawingLayerGroup ã«åŒæœŸ

å‰Šé™¤

ğŸ—‘ãƒœã‚¿ãƒ³ â†’ å¯¾è±¡ Layer ã‚’å‰Šé™¤ï¼ˆLayer 0 ã¯å¯¾è±¡å¤–ï¼‰

é †åºå¤‰æ›´

UIãƒªã‚¹ãƒˆã®ä¸¦ã¹æ›¿ãˆ â†’ LayerGroup å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†è¨­å®š

3.2 ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ï¼ˆ@pixi/uiï¼‰

ã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆï¼ˆè² æ‹…ã‚’æ¸›ã‚‰ã™ãŸã‚æ©Ÿèƒ½ã‚’æœ€å°åŒ–ï¼‰

å„ãƒ¬ã‚¤ãƒ¤ãƒ¼é …ç›®ã¯ UICard ã¨ã—ã¦æ§‹ç¯‰ã—ã€ä»¥ä¸‹ã‚’é…ç½®ï¼š

UILabel (Layer name: "èƒŒæ™¯", "ãƒ¬ã‚¤ãƒ¤ãƒ¼1", â€¦)

UIButton â•ï¼ˆæ–°è¦ä½œæˆï¼‰

UIButton ğŸ—‘ï¼ˆå‰Šé™¤ï¼‰

é¸æŠã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ highlight è¡¨ç¤º â†’ currentLayer ã‚’æ›´æ–°

3.3 ã‚¤ãƒ™ãƒ³ãƒˆåˆ¶å¾¡

æç”»ãƒ„ãƒ¼ãƒ« â†’ currentLayer ã® Container ã«è¿½åŠ 

UIæ“ä½œ

stopPropagation() ã§ã‚­ãƒ£ãƒ³ãƒã‚¹æ“ä½œã¨ç«¶åˆã•ã›ãªã„

Space+Drag = ã‚«ãƒ¡ãƒ©ç§»å‹•ï¼ˆæ—¢å­˜ä»•æ§˜ç¶­æŒï¼‰

4. å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—
Step 1: ä¸‹æº–å‚™

npm install @pixi/ui @pixi/layers

Pixi Application ä½œæˆæ™‚ã« UILayer ã¨ DrawingLayerGroup ã‚’æ§‹ç¯‰

Step 2: ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ–

Layer 0 ã‚’ Graphics å¡—ã‚Šã§ #f0e0d6 å›ºå®šèƒŒæ™¯

Layer 1 ã‚’é€æ˜ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦ä½œæˆã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¨­å®š

Step 3: ãƒ‘ãƒãƒ« UI

ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’ UIList ã§å®Ÿè£…

é …ç›®ã«ã€Œãƒ©ãƒ™ãƒ«ãƒ»è¿½åŠ ãƒœã‚¿ãƒ³ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã€é…ç½®

å‰Šé™¤æ™‚ã¯èƒŒæ™¯ä»¥å¤–ã®ã¿å¯¾è±¡

Step 4: æ“ä½œãƒ­ã‚¸ãƒƒã‚¯

â• â†’ addLayer()

ğŸ—‘ â†’ removeLayer(layerId)

ãƒ‰ãƒ©ãƒƒã‚°ä¸¦ã¹æ›¿ãˆ â†’ LayerGroup ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ï¼ˆå¯èƒ½ãªã‚‰ï¼‰

Step 5: çµ±åˆãƒ†ã‚¹ãƒˆ

èƒŒæ™¯ãŒå¸¸ã«æ®‹ã£ã¦ã„ã‚‹ã‹ç¢ºèª

ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ­£ã—ãæç”»å¯¾è±¡ã«ãªã‚‹ã‹ç¢ºèª

è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¸¦ã¹æ›¿ãˆãŒ UI ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã«åŒæœŸã™ã‚‹ã‹ç¢ºèª

5. ä»Šå¾Œã®æ‹¡å¼µ

ãƒ¬ã‚¤ãƒ¤ãƒ¼åã®ç·¨é›†ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›ï¼‰

ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒã‚¹ã‚¯ / ãƒ–ãƒ¬ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ

Undo / Redo å±¥æ­´ç®¡ç†

Pixi UI å®Œå…¨çµ±åˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãªã© DOM UI ã‚’ç¸®å°ï¼‰

âœ… è¦ç‚¹ã¾ã¨ã‚

èƒŒæ™¯ Layer 0 (#f0e0d6 å›ºå®š) + Layer 1 (é€æ˜ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–)

UIã¯ï¼‹ã¨å‰Šé™¤ã®ã¿ã®æœ€å°æ§‹æˆã€ãƒ‰ãƒ©ãƒƒã‚°ã§é †åºå¤‰æ›´ã¯ä½™è£•ãŒã‚ã‚Œã°å°å…¥

AIçš„ã«æ‰±ã„ã‚„ã™ã„æœ€å°å®Ÿè£… â†’ æ©Ÿèƒ½æ‹¡å¼µã—ã‚„ã™ã„è¨­è¨ˆ



â€»ä»¥ä¸‹ã¯è¦‹æœ¬ãƒ»é››å½¢ã‚³ãƒ¼ãƒ‰

// ========================
// Futaba Drawing Tool v8 - Pixi UI + Layers é››å½¢
// ========================

import * as PIXI from 'pixi.js';
import { UIContainer, UIButton, UILabel, UIList, UIDraggable } from '@pixi/ui';
import { Layer, LayerGroup, Stage } from '@pixi/layers';

// ---- 1. PIXI Application ----
const app = new PIXI.Application({
    width: 400,
    height: 400,
    backgroundColor: 0xf0e0d6, // CanvasèƒŒæ™¯è‰²
});
document.body.appendChild(app.view);

// ---- 2. LayerGroupä½œæˆ ----
const drawingLayerGroup = new LayerGroup();
app.stage.addChild(drawingLayerGroup);

// ---- 3. èƒŒæ™¯ Layer 0 ----
const layer0 = new PIXI.Container();
const bg = new PIXI.Graphics();
bg.beginFill(0xf0e0d6);
bg.drawRect(0, 0, app.view.width, app.view.height);
bg.endFill();
layer0.addChild(bg);
drawingLayerGroup.addChild(layer0);

// ---- 4. æç”» Layer 1 (é€æ˜, ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–) ----
const layer1 = new PIXI.Container();
drawingLayerGroup.addChild(layer1);
let currentLayer = layer1;

// ---- 5. Pixi UI Layer ----
const uiLayer = new UIContainer();
app.stage.addChild(uiLayer);

// ---- 6. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ä½œæˆ ----
const layerPanel = new UIList({
    orientation: 'vertical',
    spacing: 5,
});
uiLayer.addChild(layerPanel);

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°: UIãƒªã‚¹ãƒˆã‚’LayerGroupã¨åŒæœŸ
const updateLayerPanel = () => {
    layerPanel.removeChildren();

    const layers = [layer0, layer1]; // ä»Šå›ã¯æœ€å°2ãƒ¬ã‚¤ãƒ¤ãƒ¼
    layers.forEach((layer, index) => {
        const item = new UIContainer();

        // ãƒ©ãƒ™ãƒ«
        const label = new UILabel({ text: index === 0 ? 'èƒŒæ™¯' : `ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${index}` });
        item.addChild(label);

        // â•è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆæœ«å°¾è¿½åŠ ï¼‰
        if(index === layers.length - 1){
            const addBtn = new UIButton({ text: '+' });
            addBtn.on('click', () => {
                const newLayer = new PIXI.Container();
                drawingLayerGroup.addChild(newLayer);
                currentLayer = newLayer;
                updateLayerPanel();
            });
            item.addChild(addBtn);
        }

        // ğŸ—‘å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆèƒŒæ™¯ã¯å‰Šé™¤ä¸å¯ï¼‰
        if(index !== 0){
            const delBtn = new UIButton({ text: 'ğŸ—‘' });
            delBtn.on('click', () => {
                drawingLayerGroup.removeChild(layer);
                if(currentLayer === layer) currentLayer = layer1;
                updateLayerPanel();
            });
            item.addChild(delBtn);
        }

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        if(layer === currentLayer){
            label.style.fill = 0xff0000; // èµ¤ã§å¼·èª¿
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ã§é †åºå¤‰æ›´ï¼ˆä½™åŠ›ãŒã‚ã‚Œã°ï¼‰
        const draggable = new UIDraggable(item, { axis: 'y' });
        draggable.on('dragend', () => {
            // LayerGroupå†…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°å‡¦ç†ï¼ˆæœªå®Ÿè£…:ç°¡æ˜“ã‚µãƒ³ãƒ—ãƒ«ï¼‰
            // å®Ÿè£…æ™‚ã¯layerGroup.childrené †åºã‚’UIãƒªã‚¹ãƒˆé †ã«åˆã‚ã›ã‚‹
        });

        layerPanel.addChild(item);
    });
};
updateLayerPanel();

// ---- 7. æç”»ãƒ„ãƒ¼ãƒ«ã‚µãƒ³ãƒ—ãƒ«ï¼ˆãƒšãƒ³ï¼‰ ----
let drawing = false;
app.view.addEventListener('pointerdown', e => {
    drawing = true;
    const rect = app.view.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const graphics = new PIXI.Graphics();
    graphics.lineStyle(2, 0x000000);
    graphics.moveTo(x, y);
    currentLayer.addChild(graphics);

    app.view.addEventListener('pointermove', onPointerMove);
    function onPointerMove(ev){
        if(!drawing) return;
        const nx = ev.clientX - rect.left;
        const ny = ev.clientY - rect.top;
        graphics.lineTo(nx, ny);
    }
});

app.view.addEventListener('pointerup', () => {
    drawing = false;
    app.view.removeEventListener('pointermove', null);
});

âš¡ ãƒã‚¤ãƒ³ãƒˆ

Layer 0 = èƒŒæ™¯è‰²å›ºå®š (#f0e0d6)ã€å‰Šé™¤ä¸å¯

Layer 1 = ç„¡è‰²é€æ˜ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–

UI = æœ€å°æ§‹æˆï¼ˆï¼‹ãƒœã‚¿ãƒ³ã§è¿½åŠ ã€ğŸ—‘ãƒœã‚¿ãƒ³ã§å‰Šé™¤ï¼‰

ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆã¯ UIDraggable ã‚’åˆ©ç”¨ã€LayerGroupé †åºæ›´æ–°éƒ¨åˆ†ã¯é››å½¢ã¨ã—ã¦è¨˜è¼‰

æç”»ãƒ„ãƒ¼ãƒ«ã¯ currentLayer ã«ç›´æ¥æç”»


// ---- 6.1 ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºå¤‰æ›´ ----
const enableLayerDragReorder = () => {
    const items = layerPanel.children;
    items.forEach((item, uiIndex) => {
        const draggable = new UIDraggable(item, { axis: 'y' });

        draggable.on('dragend', () => {
            // 1. UIãƒªã‚¹ãƒˆé †ã‚’å–å¾—
            const newOrder = layerPanel.children;

            // 2. LayerGroup å†…ã®é †åºã‚’ UIé †ã«åˆã‚ã›ã‚‹
            newOrder.forEach((uiItem, newIndex) => {
                // ãƒ©ãƒ™ãƒ«ã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åˆ¤å®š
                const labelText = uiItem.children[0].text; // UILabel
                let targetLayer;
                if(labelText === 'èƒŒæ™¯'){
                    targetLayer = layer0;
                } else {
                    const index = parseInt(labelText.replace('ãƒ¬ã‚¤ãƒ¤ãƒ¼ ', ''), 10);
                    targetLayer = drawingLayerGroup.children[index];
                }

                // è¦ªã®LayerGroupã«é †åºã‚’åˆã‚ã›ã‚‹
                if(targetLayer && drawingLayerGroup.getChildIndex(targetLayer) !== newIndex){
                    drawingLayerGroup.setChildIndex(targetLayer, newIndex);
                }
            });

            // 3. UIãƒ‘ãƒãƒ«æ›´æ–°ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆåæ˜ 
            updateLayerPanel();
        });
    });
};

// åˆå›é©ç”¨
enableLayerDragReorder();

// ---- 6.2 updateLayerPanel ã«ãƒ‰ãƒ©ãƒƒã‚°å†é©ç”¨ã‚’çµ„ã¿è¾¼ã‚€ ----
const updateLayerPanel = () => {
    layerPanel.removeChildren();
    const layers = [layer0, layer1, ...drawingLayerGroup.children.slice(2)];
    layers.forEach((layer, index) => {
        const item = new UIContainer();

        // ãƒ©ãƒ™ãƒ«
        const label = new UILabel({ text: index === 0 ? 'èƒŒæ™¯' : `ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${index}` });
        item.addChild(label);

        // â•è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆæœ«å°¾ã®ã¿ï¼‰
        if(index === layers.length - 1){
            const addBtn = new UIButton({ text: '+' });
            addBtn.on('click', () => {
                const newLayer = new PIXI.Container();
                drawingLayerGroup.addChild(newLayer);
                currentLayer = newLayer;
                updateLayerPanel();
            });
            item.addChild(addBtn);
        }

        // ğŸ—‘å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆèƒŒæ™¯ã¯å‰Šé™¤ä¸å¯ï¼‰
        if(index !== 0){
            const delBtn = new UIButton({ text: 'ğŸ—‘' });
            delBtn.on('click', () => {
                drawingLayerGroup.removeChild(layer);
                if(currentLayer === layer) currentLayer = layer1;
                updateLayerPanel();
            });
            item.addChild(delBtn);
        }

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        if(layer === currentLayer){
            label.style.fill = 0xff0000;
        }

        layerPanel.addChild(item);
    });

    // ãƒ‰ãƒ©ãƒƒã‚°å†é©ç”¨
    enableLayerDragReorder();
};


âš¡ ãƒã‚¤ãƒ³ãƒˆ

UIDraggable ã§UIã‚«ãƒ¼ãƒ‰ã‚’ç¸¦ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«

dragend ã‚¤ãƒ™ãƒ³ãƒˆã§ LayerGroup å†…ã®é †åºã‚’ UIé †ã«æ›´æ–°

æ›´æ–°å¾Œã« updateLayerPanel() ã‚’å‘¼ã‚“ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆå†æç”»

èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å›ºå®šã€å‰Šé™¤ã‚„ä¸¦ã¹æ›¿ãˆä¸å¯


