# CUT = ã‚¢ãƒ‹ãƒ¡ç”¨å¤§ãƒ•ã‚©ãƒ«ãƒ€æ–¹å¼ æ”¹ä¿®è¨ˆç”»æ›¸ï¼ˆå®Œå…¨ç‰ˆï¼‰

## ğŸš¨ è©¦è¡ŒéŒ¯èª¤ã®çµè«–: ãªãœBæ¡ˆï¼ˆãƒ•ã‚©ãƒ«ãƒ€æ–¹å¼ï¼‰ãŒæ­£è§£ãªã®ã‹

### å¤±æ•—ã—ãŸAæ¡ˆã®å•é¡Œç‚¹
```javascript
// âŒ Aæ¡ˆ: 2æ¬¡å…ƒãƒãƒˆãƒªã‚¯ã‚¹ç®¡ç†ã®å•é¡Œ
// 1. LayerSystemã¨AnimationSystemã®äºŒé‡ç®¡ç†ãŒè¤‡é›‘åŒ–
// 2. Deep Copyã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å¿…ãšå‚ç…§æ¼ã‚ŒãŒç™ºç”Ÿ
// 3. CUTåˆ‡æ›¿æ™‚ã®syncå‡¦ç†ãŒè¤‡é›‘ã™ãã¦ç ´ç¶»
// 4. ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£ï¼ˆã©ã“ã§å‚ç…§ãŒå…±æœ‰ã•ã‚ŒãŸã‹è¿½ãˆãªã„ï¼‰

AnimationSystem.cuts[0].layers â† ã“ã‚Œã¨LayerSystem.layersã®åŒæœŸãŒç ´ç¶»ã™ã‚‹
```

### Bæ¡ˆãŒæ­£è§£ã§ã‚ã‚‹ç†ç”±
```javascript
// âœ… Bæ¡ˆ: CUT = ãƒ•ã‚©ãƒ«ãƒ€ã®åˆ©ç‚¹
// 1. LayerSystemã¯ã€Œç¾åœ¨é–‹ã„ã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­èº«ã‚’è¦‹ã¦ã„ã‚‹ã ã‘ã€
// 2. ãƒ•ã‚©ãƒ«ãƒ€åˆ‡æ›¿ = ä¸­èº«ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã ã‘ï¼ˆå‚ç…§ç®¡ç†ä¸è¦ï¼‰
// 3. å°†æ¥ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€ã¨ã®çµ±ä¸€çš„ãªæ‰±ã„
// 4. PixiJSã®Containerãƒ„ãƒªãƒ¼æ§‹é€ ã¨æ¦‚å¿µãŒä¸€è‡´

CUTãƒ•ã‚©ãƒ«ãƒ€1/
  â”œâ”€ èƒŒæ™¯Layer (Container)
  â”œâ”€ Layer1 (Container)
  â””â”€ Layer2 (Container)

// LayerSystemã¯ã€Œã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã ã‘ã€
```

---

## ğŸ¯ æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: CUT = PIXI.Container ãƒ•ã‚©ãƒ«ãƒ€

### ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
```
ã€å”¯ä¸€ã®çœŸå®Ÿã€‘AnimationSystem.cutsContainer (PIXI.Container)
  â”‚
  â”œâ”€ CUT1 (PIXI.Container) â† ãƒ•ã‚©ãƒ«ãƒ€
  â”‚   â”œâ”€ èƒŒæ™¯Layer (PIXI.Container)
  â”‚   â”œâ”€ Layer1 (PIXI.Container)
  â”‚   â””â”€ Layer2 (PIXI.Container)
  â”‚
  â”œâ”€ CUT2 (PIXI.Container) â† ãƒ•ã‚©ãƒ«ãƒ€
  â”‚   â”œâ”€ èƒŒæ™¯Layer (PIXI.Container)
  â”‚   â””â”€ Layer1 (PIXI.Container)
  â”‚
  â””â”€ CUT3 (PIXI.Container) â† ãƒ•ã‚©ãƒ«ãƒ€
      â””â”€ Layer1 (PIXI.Container)

ã€Viewã€‘LayerSystem.layersContainer
  â†“
  ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªCUTã‚³ãƒ³ãƒ†ãƒŠã‚’ã€Œå‚ç…§ã€ã™ã‚‹ã ã‘
  ï¼ˆã‚³ãƒ”ãƒ¼ä¸è¦ã€åˆ‡æ›¿ = å‚ç…§å…ˆå¤‰æ›´ï¼‰
```

---

## ğŸ“ ãƒ‡ãƒ¼ã‚¿æ§‹é€ å®šç¾©

### AnimationSystem

```javascript
class AnimationSystem {
  constructor() {
    // â˜…â˜…â˜… ã™ã¹ã¦ã®CUTã‚’ä¿æŒã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠï¼ˆPIXI.Containerï¼‰ â˜…â˜…â˜…
    this.cutsContainer = new PIXI.Container();
    this.cutsContainer.label = 'AnimationSystem_CutsContainer';
    
    // â˜…â˜…â˜… CUTãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿é…åˆ—ï¼ˆè¡¨ç¤ºé †åºãƒ»durationç®¡ç†ç”¨ï¼‰ â˜…â˜…â˜…
    this.cutMetadata = [
      // {
      //   cutId: 'cut_001',
      //   name: 'CUT1',
      //   duration: 0.5,
      //   cutContainer: <PIXI.Container>,  // â† å®Ÿä½“ã¸ã®å‚ç…§
      //   thumbnailCanvas: <Canvas>,
      //   order: 0  // è¡¨ç¤ºé †åº
      // }
    ];
    
    // â˜…â˜…â˜… ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªCUTã®Index â˜…â˜…â˜…
    this.activeCutIndex = 0;
    
    // Playbackç”¨
    this.playbackState = {
      isPlaying: false,
      startTime: 0,
      loop: true
    };
  }
}
```

### LayerSystem

```javascript
class LayerSystem {
  constructor() {
    // â˜…â˜…â˜… LayersContainerã¯ã€Œç¾åœ¨ã®CUTã‚³ãƒ³ãƒ†ãƒŠã€ã¸ã®å‚ç…§ãƒã‚¤ãƒ³ãƒˆ â˜…â˜…â˜…
    this.layersContainer = null;  // â† AnimationSystemã®cutContainerã‚’å‚ç…§
    
    // â˜…â˜…â˜… layersé…åˆ— = layersContainer.childrenï¼ˆgetterçµŒç”±ï¼‰ â˜…â˜…â˜…
    // this.layers ã¯å‰Šé™¤ â†’ getter ã§ this.layersContainer.children ã‚’è¿”ã™
    
    this.activeLayerIndex = -1;
    this.layerTransforms = new Map();  // cutId_layerId â†’ transform
  }
  
  // â˜…â˜…â˜… layers ã¯ getter ã§å®šç¾©ï¼ˆå¸¸ã«æœ€æ–°ã®childrenï¼‰ â˜…â˜…â˜…
  get layers() {
    return this.layersContainer ? Array.from(this.layersContainer.children) : [];
  }
}
```

---

## ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼è©³ç´°

### A. åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼

```
1. AnimationSystem.init()
   â”‚
   â”œâ”€ this.cutsContainer = new PIXI.Container()
   â”œâ”€ this.cutsContainer ã‚’ä¸–ç•Œã®å¤–ï¼ˆéè¡¨ç¤ºé ˜åŸŸï¼‰ã«é…ç½®
   â”‚   â†’ app.stage.addChild(this.cutsContainer)
   â”‚   â†’ this.cutsContainer.visible = false  // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¯¾è±¡å¤–
   â”‚
   â””â”€ åˆæœŸCUTä½œæˆ
       â””â”€ createInitialCut()
           â”‚
           â”œâ”€ cutContainer = new PIXI.Container()
           â”œâ”€ cutContainer.label = 'cut_001'
           â”œâ”€ èƒŒæ™¯Layerä½œæˆ â†’ cutContainer.addChild(bgLayer)
           â”œâ”€ Layer1ä½œæˆ â†’ cutContainer.addChild(layer1)
           â”œâ”€ this.cutsContainer.addChild(cutContainer)
           â”‚
           â””â”€ this.cutMetadata.push({
                 cutId: 'cut_001',
                 name: 'CUT1',
                 duration: 0.5,
                 cutContainer: cutContainer,  // â† å®Ÿä½“å‚ç…§
                 thumbnailCanvas: null,
                 order: 0
               })

2. LayerSystem.init()
   â”‚
   â””â”€ this.layersContainer = null  // ã¾ã æœªæ¥ç¶š

3. AnimationSystem.setActiveCut(0)
   â”‚
   â”œâ”€ const cutData = this.cutMetadata[0]
   â”œâ”€ const cutContainer = cutData.cutContainer
   â”‚
   â”œâ”€ LayerSystem ã¸ã®æ¥ç¶š
   â”‚   â””â”€ this.layerSystem.switchToCutContainer(cutContainer)
   â”‚       â”‚
   â”‚       â”œâ”€ æ—§ layersContainer ã‚’ canvasContainer ã‹ã‚‰å‰Šé™¤
   â”‚       â”œâ”€ this.layersContainer = cutContainer  // â† å‚ç…§åˆ‡æ›¿
   â”‚       â”œâ”€ this.canvasContainer.addChild(cutContainer)
   â”‚       â””â”€ cutContainer.visible = true
   â”‚
   â””â”€ UIæ›´æ–°
       â”œâ”€ this.layerSystem.updateLayerPanelUI()
       â””â”€ eventBus.emit('animation:cut-applied')
```

---

### B. æç”»ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæç”»é–‹å§‹
   â”‚
2. DrawingEngine: ãƒã‚¦ã‚¹åº§æ¨™ã‚’å–å¾—
   â”‚
3. DrawingEngine: pathä½œæˆ
   â”‚
   const path = {
     id: 'path_xxx',
     points: [],
     graphics: new PIXI.Graphics(),
     ...
   }
   â”‚
4. LayerSystem.addPathToActiveLayer(path)
   â”‚
   â”œâ”€ const activeLayer = this.layers[this.activeLayerIndex]
   â”‚   // â˜…â˜…â˜… this.layers ã¯ getter â†’ this.layersContainer.children[index] â˜…â˜…â˜…
   â”‚
   â”œâ”€ activeLayer.layerData.paths.push(path)
   â”œâ”€ activeLayer.addChild(path.graphics)
   â”‚
   â””â”€ â˜…â˜…â˜… ä½•ã‚‚ã‚³ãƒ”ãƒ¼ä¸è¦ï¼ã™ã§ã«CUTã‚³ãƒ³ãƒ†ãƒŠå†…ã«å­˜åœ¨ â˜…â˜…â˜…
   
5. æç”»å®Œäº†æ™‚
   â”‚
   â””â”€ AnimationSystem.onDrawingComplete()
       â”‚
       â””â”€ const currentCutIndex = this.activeCutIndex
           const cutData = this.cutMetadata[currentCutIndex]
           â”‚
           â””â”€ this.generateCutThumbnail(currentCutIndex)
               // cutData.cutContainer ã‚’ç›´æ¥ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
```

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ**:
- **ã‚³ãƒ”ãƒ¼ä¸è¦**: LayerSystem.layersContainer ã¯ CUTã‚³ãƒ³ãƒ†ãƒŠãã®ã‚‚ã®
- **è‡ªå‹•ä¿å­˜**: PIXI.Containerãƒ„ãƒªãƒ¼ã«è¿½åŠ ã—ãŸæ™‚ç‚¹ã§ä¿å­˜å®Œäº†
- **å‚ç…§æ¼ã‚Œã‚¼ãƒ­**: ã™ã¹ã¦Containerã®è¦ªå­é–¢ä¿‚ã§ç®¡ç†

---

### C. CUTåˆ‡æ›¿ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCUT2ã‚’ã‚¯ãƒªãƒƒã‚¯
   â”‚
2. TimelineUI: AnimationSystem.switchToActiveCut(1)
   â”‚
3. AnimationSystem.switchToActiveCut(newIndex)
   â”‚
   â”œâ”€ if (this.activeCutIndex === newIndex) return  // åŒã˜CUTãªã‚‰ä½•ã‚‚ã—ãªã„
   â”‚
   â”œâ”€ const oldCutData = this.cutMetadata[this.activeCutIndex]
   â”œâ”€ const newCutData = this.cutMetadata[newIndex]
   â”‚
   â”œâ”€ â˜…â˜…â˜… æ—§CUTã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤ºé ˜åŸŸã¸æˆ»ã™ â˜…â˜…â˜…
   â”‚   â””â”€ this.canvasContainer.removeChild(oldCutData.cutContainer)
   â”‚       this.cutsContainer.addChild(oldCutData.cutContainer)
   â”‚       oldCutData.cutContainer.visible = false
   â”‚
   â”œâ”€ â˜…â˜…â˜… æ–°CUTã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤ºé ˜åŸŸã¸ç§»å‹• â˜…â˜…â˜…
   â”‚   â””â”€ this.cutsContainer.removeChild(newCutData.cutContainer)
   â”‚       this.canvasContainer.addChild(newCutData.cutContainer)
   â”‚       newCutData.cutContainer.visible = true
   â”‚
   â”œâ”€ â˜…â˜…â˜… LayerSystemã®å‚ç…§å…ˆã‚’åˆ‡æ›¿ â˜…â˜…â˜…
   â”‚   â””â”€ this.layerSystem.layersContainer = newCutData.cutContainer
   â”‚
   â”œâ”€ this.activeCutIndex = newIndex
   â”‚
   â””â”€ UIæ›´æ–°
       â”œâ”€ this.layerSystem.updateLayerPanelUI()
       â”‚   // this.layers getter ãŒæ–°CUTã®childrenè¿”ã™
       â”‚
       â””â”€ eventBus.emit('animation:cut-applied', { 
            cutIndex: newIndex, 
            cutId: newCutData.cutId 
          })
```

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ**:
- **ã‚³ãƒ”ãƒ¼ä¸è¦**: Containerã®è¦ªå­é–¢ä¿‚ã‚’å¤‰æ›´ã™ã‚‹ã ã‘
- **é«˜é€Ÿ**: `removeChild()` ã¨ `addChild()` ã®ã¿
- **ç¢ºå®Ÿ**: å‚ç…§ãŒæ˜ç¢ºï¼ˆcutContainer â†’ canvasContainer or cutsContainerï¼‰

---

### D. æ–°è¦CUTä½œæˆãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œ+CUTã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
   â”‚
2. AnimationSystem.createNewCut(sourceType)
   â”‚
   sourceType: 'blank' | 'copy_current'
   â”‚
3. â˜…â˜…â˜… Case A: ç©ºCUTä½œæˆ â˜…â˜…â˜…
   â”‚
   if (sourceType === 'blank') {
     â”‚
     â”œâ”€ cutContainer = new PIXI.Container()
     â”œâ”€ cutContainer.label = 'cut_' + Date.now()
     â”‚
     â”œâ”€ åˆæœŸLayeræ§‹é€ ã‚’ä½œæˆ
     â”‚   â”‚
     â”‚   â”œâ”€ bgLayer = new PIXI.Container()
     â”‚   â”œâ”€ bgLayer.layerData = { id, name: 'èƒŒæ™¯', paths: [], ... }
     â”‚   â”œâ”€ èƒŒæ™¯Graphicsä½œæˆ â†’ bgLayer.addChild(bgGraphics)
     â”‚   â”œâ”€ cutContainer.addChild(bgLayer)
     â”‚   â”‚
     â”‚   â”œâ”€ layer1 = new PIXI.Container()
     â”‚   â”œâ”€ layer1.layerData = { id, name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼1', paths: [], ... }
     â”‚   â””â”€ cutContainer.addChild(layer1)
     â”‚
     â”œâ”€ this.cutsContainer.addChild(cutContainer)
     â”œâ”€ cutContainer.visible = false  // éè¡¨ç¤ºé ˜åŸŸã«ä¿ç®¡
     â”‚
     â””â”€ this.cutMetadata.push({
          cutId: cutContainer.label,
          name: 'CUT' + (this.cutMetadata.length + 1),
          duration: 0.5,
          cutContainer: cutContainer,
          thumbnailCanvas: null,
          order: this.cutMetadata.length
        })
   }

4. â˜…â˜…â˜… Case B: ç¾åœ¨CUTã‚’ã‚³ãƒ”ãƒ¼ â˜…â˜…â˜…
   â”‚
   if (sourceType === 'copy_current') {
     â”‚
     â”œâ”€ const sourceCutData = this.cutMetadata[this.activeCutIndex]
     â”œâ”€ const sourceCutContainer = sourceCutData.cutContainer
     â”‚
     â”œâ”€ â˜…â˜…â˜… PIXI.Containerã®ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¯ãƒ­ãƒ¼ãƒ³ â˜…â˜…â˜…
     â”‚   â”‚
     â”‚   â””â”€ cutContainer = this.cloneCutContainer(sourceCutContainer)
     â”‚       â”‚
     â”‚       â”œâ”€ const cloned = new PIXI.Container()
     â”‚       â”œâ”€ cloned.label = 'cut_' + Date.now()
     â”‚       â”‚
     â”‚       â”œâ”€ sourceCutContainer.children.forEach(sourceLayer => {
     â”‚       â”‚     const clonedLayer = this.cloneLayer(sourceLayer)
     â”‚       â”‚     cloned.addChild(clonedLayer)
     â”‚       â”‚   })
     â”‚       â”‚
     â”‚       â””â”€ return cloned
     â”‚
     â”œâ”€ this.cutsContainer.addChild(cutContainer)
     â”œâ”€ cutContainer.visible = false
     â”‚
     â””â”€ this.cutMetadata.push({
          cutId: cutContainer.label,
          name: sourceCutData.name + '_copy',
          duration: sourceCutData.duration,
          cutContainer: cutContainer,
          thumbnailCanvas: null,
          order: this.cutMetadata.length
        })
   }

5. æ–°CUTã«åˆ‡æ›¿
   â”‚
   â””â”€ this.switchToActiveCut(this.cutMetadata.length - 1)

6. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
   â”‚
   â””â”€ setTimeout(() => {
        this.generateCutThumbnail(this.cutMetadata.length - 1)
      }, 100)
```

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ**:
- **æ˜ç¢ºãªæ‰€æœ‰æ¨©**: cutContainer ãŒå”¯ä¸€ã®å®Ÿä½“
- **ã‚¯ãƒ­ãƒ¼ãƒ³ã®ç°¡æ½”ã•**: PIXI.Containerãƒ„ãƒªãƒ¼ã‚’ãã®ã¾ã¾è¤‡è£½
- **ã‚³ãƒ”ãƒ¼å¾Œã®ç‹¬ç«‹æ€§**: åˆ¥ã®Container = åˆ¥ã®ãƒ¡ãƒ¢ãƒªé ˜åŸŸ

---

### E. CUTå‰Šé™¤ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
   â”‚
2. AnimationSystem.deleteCut(cutIndex)
   â”‚
   â”œâ”€ if (this.cutMetadata.length <= 1) return false  // æœ€å¾Œã®1ã¤ã¯å‰Šé™¤ä¸å¯
   â”‚
   â”œâ”€ const cutData = this.cutMetadata[cutIndex]
   â”œâ”€ const cutContainer = cutData.cutContainer
   â”‚
   â”œâ”€ â˜…â˜…â˜… CUTã‚³ãƒ³ãƒ†ãƒŠã‚’å®Œå…¨ç ´æ£„ â˜…â˜…â˜…
   â”‚   â”‚
   â”‚   â”œâ”€ cutContainer.children.forEach(layer => {
   â”‚   â”‚     layer.children.forEach(child => {
   â”‚   â”‚       if (child.destroy) child.destroy()
   â”‚   â”‚     })
   â”‚   â”‚     layer.destroy({ children: true })
   â”‚   â”‚   })
   â”‚   â”‚
   â”‚   â”œâ”€ cutContainer.destroy({ children: true })
   â”‚   â”‚
   â”‚   â””â”€ this.cutMetadata.splice(cutIndex, 1)
   â”‚
   â”œâ”€ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–Indexèª¿æ•´
   â”‚   â”‚
   â”‚   â””â”€ if (this.activeCutIndex >= cutIndex) {
          this.activeCutIndex = Math.max(0, this.activeCutIndex - 1)
        }
   â”‚
   â””â”€ æ–°ã—ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTã«åˆ‡æ›¿
       â””â”€ this.switchToActiveCut(this.activeCutIndex)
```

---

### F. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆãƒ•ãƒ­ãƒ¼

```
1. AnimationSystem.generateCutThumbnail(cutIndex)
   â”‚
   â”œâ”€ const cutData = this.cutMetadata[cutIndex]
   â”œâ”€ const cutContainer = cutData.cutContainer
   â”‚
   â”œâ”€ â˜…â˜…â˜… ä¸€æ™‚çš„ã«è¡¨ç¤ºå¯èƒ½çŠ¶æ…‹ã«ã™ã‚‹ â˜…â˜…â˜…
   â”‚   â”‚
   â”‚   â”œâ”€ const wasVisible = cutContainer.visible
   â”‚   â”œâ”€ const originalParent = cutContainer.parent
   â”‚   â”‚
   â”‚   â”œâ”€ if (!wasVisible) {
   â”‚   â”‚     // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆç”¨ã«ä¸€æ™‚çš„ã«ã‚¹ãƒ†ãƒ¼ã‚¸ã¸
   â”‚   â”‚     if (originalParent) originalParent.removeChild(cutContainer)
   â”‚   â”‚     this.app.stage.addChild(cutContainer)
   â”‚   â”‚     cutContainer.visible = true
   â”‚   â”‚     cutContainer.position.set(-10000, -10000)  // ç”»é¢å¤–
   â”‚   â”‚   }
   â”‚   â”‚
   â”‚   â”œâ”€ await nextFrame()  // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾…æ©Ÿ
   â”‚   â”‚
   â”‚   â”œâ”€ â˜…â˜…â˜… cutContainerå…¨ä½“ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° â˜…â˜…â˜…
   â”‚   â”‚   â”‚
   â”‚   â”‚   â”œâ”€ const renderTexture = PIXI.RenderTexture.create({
   â”‚   â”‚   â”‚     width: canvasWidth,
   â”‚   â”‚   â”‚     height: canvasHeight
   â”‚   â”‚   â”‚   })
   â”‚   â”‚   â”‚
   â”‚   â”‚   â”œâ”€ this.app.renderer.render({
   â”‚   â”‚   â”‚     container: cutContainer,
   â”‚   â”‚   â”‚     target: renderTexture
   â”‚   â”‚   â”‚   })
   â”‚   â”‚   â”‚
   â”‚   â”‚   â”œâ”€ const canvas = this.app.renderer.extract.canvas(renderTexture)
   â”‚   â”‚   â”‚
   â”‚   â”‚   â”œâ”€ â˜…â˜…â˜… Canvas2Dã§ãƒªã‚µã‚¤ã‚ºï¼ˆ72x54ï¼‰ â˜…â˜…â˜…
   â”‚   â”‚   â”‚   â”‚
   â”‚   â”‚   â”‚   â”œâ”€ const thumbCanvas = document.createElement('canvas')
   â”‚   â”‚   â”‚   â”œâ”€ thumbCanvas.width = 72
   â”‚   â”‚   â”‚   â”œâ”€ thumbCanvas.height = 54
   â”‚   â”‚   â”‚   â”‚
   â”‚   â”‚   â”‚   â”œâ”€ const ctx = thumbCanvas.getContext('2d')
   â”‚   â”‚   â”‚   â”œâ”€ ctx.imageSmoothingEnabled = true
   â”‚   â”‚   â”‚   â”œâ”€ ctx.imageSmoothingQuality = 'high'
   â”‚   â”‚   â”‚   â””â”€ ctx.drawImage(canvas, 0, 0, 72, 54)
   â”‚   â”‚   â”‚
   â”‚   â”‚   â”œâ”€ renderTexture.destroy()
   â”‚   â”‚   â”‚
   â”‚   â”‚   â””â”€ cutData.thumbnailCanvas = thumbCanvas
   â”‚   â”‚
   â”‚   â””â”€ â˜…â˜…â˜… å…ƒã®çŠ¶æ…‹ã«æˆ»ã™ â˜…â˜…â˜…
   â”‚       â”‚
   â”‚       â”œâ”€ if (!wasVisible) {
   â”‚       â”‚     this.app.stage.removeChild(cutContainer)
   â”‚       â”‚     if (originalParent) originalParent.addChild(cutContainer)
   â”‚       â”‚     cutContainer.visible = false
   â”‚       â”‚   }
   â”‚       â”‚
   â”‚       â””â”€ cutContainer.position.set(0, 0)
   â”‚
   â””â”€ eventBus.emit('animation:thumbnail-generated', { cutIndex })
```

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ**:
- **ç›´æ¥ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°**: cutContainer ã‚’ä¸¸ã”ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- **çŠ¶æ…‹å¾©å…ƒ**: ä¸€æ™‚çš„ã«è¡¨ç¤º â†’ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° â†’ å…ƒã«æˆ»ã™
- **é«˜é€Ÿ**: Layerã”ã¨ã§ã¯ãªãã€Containerå…¨ä½“ã‚’1å›ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

---

## ğŸ“š ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©è¾å…¸

### AnimationSystem

| ãƒ¡ã‚½ãƒƒãƒ‰å | è²¬å‹™ | å¼•æ•° | æˆ»ã‚Šå€¤ | è©³ç´° |
|-----------|------|-----|--------|------|
| `init(layerSystem, app)` | ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ– | LayerSystem, PIXI.Application | void | cutsContainerä½œæˆãƒ»åˆæœŸCUTä½œæˆ |
| `createInitialCut()` | åˆæœŸCUTä½œæˆ | ãªã— | CutMetadata | èƒŒæ™¯+Layer1ã®ç©ºCUTä½œæˆ |
| `createNewCut(sourceType)` | æ–°è¦CUTä½œæˆ | 'blank' \| 'copy_current' | CutMetadata | ç©º or ã‚³ãƒ”ãƒ¼CUTä½œæˆ |
| `cloneCutContainer(sourceCutContainer)` | CUTã‚³ãƒ³ãƒ†ãƒŠã®å®Œå…¨è¤‡è£½ | PIXI.Container | PIXI.Container | Containerãƒ„ãƒªãƒ¼å…¨ä½“ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ |
| `cloneLayer(sourceLayer)` | Layerå®Œå…¨è¤‡è£½ | PIXI.Container | PIXI.Container | layerDataãƒ»pathsãƒ»graphicså…¨è¤‡è£½ |
| `clonePath(sourcePath)` | Pathå®Œå…¨è¤‡è£½ | PathObject | PathObject | pointsé…åˆ—ãƒ»graphicsè¤‡è£½ |
| `switchToActiveCut(newIndex)` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTåˆ‡æ›¿ | number | void | Containerè¦ªå­é–¢ä¿‚å¤‰æ›´ãƒ»LayerSystemå‚ç…§åˆ‡æ›¿ |
| `deleteCut(cutIndex)` | CUTå‰Šé™¤ | number | boolean | Containerç ´æ£„ãƒ»metadataå‰Šé™¤ |
| `generateCutThumbnail(cutIndex)` | ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ | number | Promise\<void\> | cutContainerå…¨ä½“ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° |
| `play()` | å†ç”Ÿé–‹å§‹ | ãªã— | void | ã‚¿ã‚¤ãƒãƒ¼èµ·å‹•ãƒ»CUTè‡ªå‹•åˆ‡æ›¿ |
| `stop()` | å†ç”Ÿåœæ­¢ | ãªã— | void | ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ |
| `goToNextFrame()` | æ¬¡CUTã¸ | ãªã— | void | activeCutIndex++ â†’ switchToActiveCut() |
| `goToPreviousFrame()` | å‰CUTã¸ | ãªã— | void | activeCutIndex-- â†’ switchToActiveCut() |
| `updateCutDuration(cutIndex, duration)` | CUTç¶™ç¶šæ™‚é–“æ›´æ–° | number, number | void | metadata.durationæ›´æ–° |
| `reorderCuts(oldIndex, newIndex)` | CUTä¸¦ã³æ›¿ãˆ | number, number | void | metadataé…åˆ—ä¸¦ã³æ›¿ãˆ |

---

### LayerSystem

| ãƒ¡ã‚½ãƒƒãƒ‰å | è²¬å‹™ | å¼•æ•° | æˆ»ã‚Šå€¤ | è©³ç´° |
|-----------|------|-----|--------|------|
| `get layers()` | ãƒ¬ã‚¤ãƒ¤ãƒ¼é…åˆ—å–å¾— | ãªã— | Array\<PIXI.Container\> | layersContainer.childrenè¿”å´ |
| `switchToCutContainer(cutContainer)` | CUTã‚³ãƒ³ãƒ†ãƒŠåˆ‡æ›¿ | PIXI.Container | void | layersContainerå‚ç…§å…ˆå¤‰æ›´ |
| `createLayer(name, isBackground)` | æ–°è¦Layerä½œæˆ | string, boolean | {layer, index} | Containerä½œæˆ â†’ ç¾åœ¨ã®cutContainerã«è¿½åŠ  |
| `deleteLayer(layerIndex)` | Layerå‰Šé™¤ | number | boolean | layersContainer.children[index]å‰Šé™¤ |
| `addPathToActiveLayer(path)` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–Layerã«Pathè¿½åŠ  | PathObject | void | layers[activeIndex].addChild(path.graphics) |
| `setActiveLayer(index)` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–Layeråˆ‡æ›¿ | number | void | activeLayerIndexæ›´æ–°ãƒ»UIæ›´æ–° |
| `toggleLayerVisibility(layerIndex)` | Layerå¯è¦–æ€§ãƒˆã‚°ãƒ« | number | void | layer.visibleåˆ‡æ›¿ |
| `updateActiveLayerTransform(property, value)` | Transformæ›´æ–° | string, number | void | layerTransformsæ›´æ–°ãƒ»PIXIã«åæ˜  |
| `flipActiveLayer(direction)` | Layeråè»¢ | 'horizontal' \| 'vertical' | void | transform.scaleX/Y *= -1 |
| `confirmLayerTransform()` | Transformç¢ºå®š | ãªã— | void | pathsã«Bakeãƒ»transformåˆæœŸåŒ– |
| `updateLayerPanelUI()` | Layerãƒ‘ãƒãƒ«UIæ›´æ–° | ãªã— | void | this.layers getterçµŒç”±ã§HTMLç”Ÿæˆ |
| `updateThumbnail(layerIndex)` | Layerå€‹åˆ¥ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–° | number | void | Layerå˜ä½“ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° |

---

### é‡è¦ãªå†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰

#### AnimationSystem.cloneCutContainer()
```javascript
/**
 * CUTã‚³ãƒ³ãƒ†ãƒŠã®å®Œå…¨è¤‡è£½
 * â˜…â˜…â˜… PIXI.Containerãƒ„ãƒªãƒ¼å…¨ä½“ã‚’å†å¸°çš„ã«ã‚¯ãƒ­ãƒ¼ãƒ³ â˜…â˜…â˜…
 */
cloneCutContainer(sourceCutContainer) {
  const cloned = new PIXI.Container();
  cloned.label = 'cut_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  // å­Layerå…¨è¤‡è£½
  sourceCutContainer.children.forEach(sourceLayer => {
    const clonedLayer = this.cloneLayer(sourceLayer);
    cloned.addChild(clonedLayer);
  });
  
  return cloned;
}
```

#### AnimationSystem.cloneLayer()
```javascript
/**
 * Layerå®Œå…¨è¤‡è£½
 * â˜…â˜…â˜… layerDataãƒ»pathsãƒ»graphicså…¨è¤‡è£½ â˜…â˜…â˜…
 */
cloneLayer(sourceLayer) {
  const clonedLayer = new PIXI.Container();
  clonedLayer.label = sourceLayer.label + '_clone_' + Date.now();
  
  // layerDataè¤‡è£½
  clonedLayer.layerData = {
    id: clonedLayer.label,
    name: sourceLayer.layerData.name,
    visible: sourceLayer.layerData.visible,
    opacity: sourceLayer.layerData.opacity,
    isBackground: sourceLayer.layerData.isBackground,
    paths: []  // å¾Œã§è¿½åŠ 
  };
  
  // Transformè¤‡è£½
  clonedLayer.position.set(sourceLayer.position.x, sourceLayer.position.y);
  clonedLayer.pivot.set(sourceLayer.pivot.x, sourceLayer.pivot.y);
  clonedLayer.rotation = sourceLayer.rotation;
  clonedLayer.scale.set(sourceLayer.scale.x, sourceLayer.scale.y);
  clonedLayer.alpha = sourceLayer.alpha;
  clonedLayer.visible = sourceLayer.visible;
  
  // èƒŒæ™¯Graphicsè¤‡è£½
  if (sourceLayer.layerData.isBackground && sourceLayer.layerData.backgroundGraphics) {
    const clonedBg = new PIXI.Graphics();
    const canvasWidth = this.layerSystem.config.canvas.width;
    const canvasHeight = this.layerSystem.config.canvas.height;
    const bgColor = this.layerSystem.config.background.color;
    clonedBg.rect(0, 0, canvasWidth, canvasHeight);
    clonedBg.fill(bgColor);
    clonedLayer.addChild(clonedBg);
    clonedLayer.layerData.backgroundGraphics = clonedBg;
  }
  
  // pathsè¤‡è£½
  if (sourceLayer.layerData.paths) {
    sourceLayer.layerData.paths.forEach(sourcePath => {
      const clonedPath = this.clonePath(sourcePath);
      clonedLayer.layerData.paths.push(clonedPath);
      clonedLayer.addChild(clonedPath.graphics);
    });
  }
  
  return clonedLayer;
}
```

#### AnimationSystem.clonePath()
```javascript
/**
 * Pathå®Œå…¨è¤‡è£½
 * â˜…â˜…â˜… pointsé…åˆ—ãƒ»PIXI.Graphicså†ç”Ÿæˆ â˜…â˜…â˜…
 */
clonePath(sourcePath) {
  const clonedGraphics = new PIXI.Graphics();
  
  // pointsé…åˆ—è¤‡è£½
  const clonedPoints = sourcePath.points.map(p => ({
    x: p.x,
    y: p.y
  }));
  
  // Graphicså†æç”»
  clonedPoints.forEach(point => {
    clonedGraphics.circle(point.x, point.y, sourcePath.size / 2);
    clonedGraphics.fill({
      color: sourcePath.color,
      alpha: sourcePath.opacity
    });
  });
  
  return {
    id: 'path_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    points: clonedPoints,
    size: sourcePath.size,
    color: sourcePath.color,
    opacity: sourcePath.opacity,
    tool: sourcePath.tool,
    graphics: clonedGraphics
  };
}
```

---

## ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ»æ¤œè¨¼æ–¹æ³•

### CUTç‹¬ç«‹æ€§ã®ç¢ºèª

```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ç¢ºèªã‚³ãƒãƒ³ãƒ‰

// 1. CUTæ§‹é€ ã®ç¢ºèª
console.log('CutsContainer:', animationSystem.cutsContainer);
console.log('CUTæ•°:', animationSystem.cutsContainer.children.length);
console.log('Metadataæ•°:', animationSystem.cutMetadata.length);

// 2. å„CUTã®å†…å®¹ç¢ºèª
animationSystem.cutMetadata.forEach((cutData, i) => {
  console.log(`CUT${i+1}:`, {
    name: cutData.name,
    layerCount: cutData.cutContainer.children.length,
    layers: cutData.cutContainer.children.map(l => ({
      name: l.layerData?.name,
      pathCount: l.layerData?.paths?.length || 0
    }))
  });
});

// 3. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTã®ç¢ºèª
console.log('Active CUT Index:', animationSystem.activeCutIndex);
console.log('LayerSystem.layersContainer === Active CUT?', 
  layerSystem.layersContainer === animationSystem.cutMetadata[animationSystem.activeCutIndex].cutContainer
);

// 4. ç‹¬ç«‹æ€§ãƒ†ã‚¹ãƒˆ
// CUT1ã§æç”» â†’ CUT2ã«åˆ‡æ›¿ â†’ CUT1ã«æˆ»ã‚‹ â†’ æç”»ãŒæ®‹ã£ã¦ã„ã‚‹ã‹ç¢ºèª
function testCutIndependence() {
  console.log('=== CUTç‹¬ç«‹æ€§ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
  
  // CUT1ã®Layer1ã®Pathæ•°ã‚’è¨˜éŒ²
  const cut1 = animationSystem.cutMetadata[0];
  const cut1Layer1 = cut1.cutContainer.children[1]; // Layer1
  const initialPathCount = cut1Layer1.layerData.paths.length;
  console.log('CUT1 Layer1 åˆæœŸPathæ•°:', initialPathCount);
  
  // CUT2ã«åˆ‡æ›¿
  animationSystem.switchToActiveCut(1);
  console.log('CUT2ã«åˆ‡æ›¿å®Œäº†');
  
  // CUT2ã®Layer1ã®Pathæ•°ç¢ºèª
  const cut2 = animationSystem.cutMetadata[1];
  const cut2Layer1 = cut2.cutContainer.children[1];
  const cut2PathCount = cut2Layer1.layerData.paths.length;
  console.log('CUT2 Layer1 Pathæ•°:', cut2PathCount);
  
  // CUT1ã«æˆ»ã‚‹
  animationSystem.switchToActiveCut(0);
  console.log('CUT1ã«æˆ»ã‚‹');
  
  // CUT1ã®Pathæ•°ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹ç¢ºèª
  const finalPathCount = cut1Layer1.layerData.paths.length;
  console.log('CUT1 Layer1 æœ€çµ‚Pathæ•°:', finalPathCount);
  
  if (initialPathCount === finalPathCount) {
    console.log('âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ: CUTã¯ç‹¬ç«‹ã—ã¦ã„ã‚‹');
  } else {
    console.error('âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: Pathæ•°ãŒå¤‰åŒ–ã—ãŸ');
  }
}

// 5. ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ç¢ºèª
function checkMemoryLeaks() {
  console.log('=== ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ç¢ºèª ===');
  
  // CUTå‰Šé™¤å‰ã®Containeræ•°
  const beforeCount = animationSystem.cutsContainer.children.length;
  console.log('å‰Šé™¤å‰CUTæ•°:', beforeCount);
  
  // CUTå‰Šé™¤
  const deletedCutId = animationSystem.cutMetadata[1].cutId;
  animationSystem.deleteCut(1);
  
  // å‰Šé™¤å¾Œã®Containeræ•°
  const afterCount = animationSystem.cutsContainer.children.length;
  console.log('å‰Šé™¤å¾ŒCUTæ•°:', afterCount);
  
  // cutsContainerã«å‰Šé™¤ã—ãŸCUTãŒæ®‹ã£ã¦ã„ãªã„ã‹ç¢ºèª
  const leaked = animationSystem.cutsContainer.children.find(c => c.label === deletedCutId);
  
  if (!leaked && afterCount === beforeCount - 1) {
    console.log('âœ… ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ç„¡ã—: CUTã¯å®Œå…¨ã«å‰Šé™¤ã•ã‚ŒãŸ');
  } else {
    console.error('âŒ ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œå‡º: CUTãŒæ®‹ã£ã¦ã„ã‚‹');
  }
}
```

---

## âš ï¸ é‡è¦ãªå®Ÿè£…æ³¨æ„äº‹é …

### 1. cutsContainer ã®é…ç½®

```javascript
// âŒ NG: ã‚¹ãƒ†ãƒ¼ã‚¸ã«ç›´æ¥è¿½åŠ ã™ã‚‹ã¨å…¨CUTãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
app.stage.addChild(this.cutsContainer);
this.cutsContainer.visible = true;  // å…¨CUTæç”»ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹

// âœ… OK: cutsContainerã¯éè¡¨ç¤ºé ˜åŸŸã«é…ç½®
app.stage.addChild(this.cutsContainer);
this.cutsContainer.visible = false;  // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¯¾è±¡å¤–
this.cutsContainer.position.set(-999999, -999999);  // ç”»é¢å¤–

// âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªCUTã®ã¿ã‚’canvasContainerã«é…ç½®
canvasContainer.addChild(activeCutContainer);
activeCutContainer.visible = true;  // ã“ã‚Œã ã‘ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
```

**ç†ç”±**: ã™ã¹ã¦ã®CUTã‚’å¸¸æ™‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã¨GPUãƒ¡ãƒ¢ãƒªã¨CPUè² è·ãŒå¢—å¤§

---

### 2. LayerSystem.layers getter ã®å®Ÿè£…

```javascript
// âŒ NG: é…åˆ—ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨å‚ç…§ãŒå¤ããªã‚‹
get layers() {
  if (!this._cachedLayers) {
    this._cachedLayers = Array.from(this.layersContainer.children);
  }
  return this._cachedLayers;
}

// âœ… OK: å¸¸ã«æœ€æ–°ã®childrenã‚’è¿”ã™
get layers() {
  return this.layersContainer ? Array.from(this.layersContainer.children) : [];
}
```

**ç†ç”±**: CUTåˆ‡æ›¿æ™‚ã«è‡ªå‹•çš„ã«æ–°ã—ã„childrenãŒå–å¾—ã•ã‚Œã‚‹

---

### 3. Transformæƒ…å ±ã®ç®¡ç†

```javascript
// â˜…â˜…â˜… layerTransforms Mapã®ã‚­ãƒ¼ã¯ã€ŒcutId_layerIdã€â˜…â˜…â˜…
const transformKey = `${cutData.cutId}_${layer.layerData.id}`;
this.layerTransforms.set(transformKey, {
  x: 0, y: 0, rotation: 0, scaleX: 1, scaleY: 1
});

// CUTåˆ‡æ›¿æ™‚ã€Transformå¾©å…ƒ
const transform = this.layerTransforms.get(transformKey);
if (transform) {
  layer.position.set(transform.x, transform.y);
  layer.rotation = transform.rotation;
  layer.scale.set(transform.scaleX, transform.scaleY);
}
```

**ç†ç”±**: åŒã˜Layerã§ã‚‚CUTã”ã¨ã«ç•°ãªã‚‹Transformã‚’æŒã¤å¯èƒ½æ€§ãŒã‚ã‚‹

---

### 4. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°

```javascript
// âœ… CUTä½œæˆç›´å¾Œ
createNewCut(sourceType) {
  // ... CUTä½œæˆå‡¦ç† ...
  
  const newIndex = this.cutMetadata.length - 1;
  
  // æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾…æ©Ÿï¼‰
  requestAnimationFrame(() => {
    this.generateCutThumbnail(newIndex);
  });
}

// âœ… æç”»å®Œäº†å¾Œ
LayerSystem.addPathToActiveLayer(path) {
  // ... Pathè¿½åŠ å‡¦ç† ...
  
  // AnimationSystemã«é€šçŸ¥
  if (this.eventBus) {
    this.eventBus.emit('layer:path-added', {
      cutIndex: this.animationSystem.activeCutIndex
    });
  }
}

// AnimationSystemã§å—ä¿¡
this.eventBus.on('layer:path-added', (data) => {
  // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆ100msä»¥å†…ã®é€£ç¶šæç”»ã¯ã¾ã¨ã‚ã‚‹ï¼‰
  clearTimeout(this.thumbnailDebounceTimer);
  this.thumbnailDebounceTimer = setTimeout(() => {
    this.generateCutThumbnail(data.cutIndex);
  }, 100);
});
```

**ç†ç”±**: æ¯ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã§ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã™ã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹

---

### 5. CUTå‰Šé™¤æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```javascript
deleteCut(cutIndex) {
  const cutData = this.cutMetadata[cutIndex];
  const cutContainer = cutData.cutContainer;
  
  // â˜…â˜…â˜… Step 1: å­è¦ç´ ã‹ã‚‰é †ã«ç ´æ£„ â˜…â˜…â˜…
  cutContainer.children.forEach(layer => {
    // Graphicsç ´æ£„
    layer.children.forEach(child => {
      if (child.destroy) {
        child.destroy({ children: true, texture: false, baseTexture: false });
      }
    });
    
    // Layerç ´æ£„
    layer.destroy({ children: true, texture: false, baseTexture: false });
  });
  
  // â˜…â˜…â˜… Step 2: Containerç ´æ£„ â˜…â˜…â˜…
  if (cutContainer.parent) {
    cutContainer.parent.removeChild(cutContainer);
  }
  cutContainer.destroy({ children: true, texture: false, baseTexture: false });
  
  // â˜…â˜…â˜… Step 3: Metadataå‰Šé™¤ â˜…â˜…â˜…
  this.cutMetadata.splice(cutIndex, 1);
  
  // â˜…â˜…â˜… Step 4: Transformæƒ…å ±å‰Šé™¤ â˜…â˜…â˜…
  // cutId ã«ç´ã¥ã Transform ã‚’å…¨å‰Šé™¤
  const cutId = cutData.cutId;
  for (let key of this.layerSystem.layerTransforms.keys()) {
    if (key.startsWith(cutId + '_')) {
      this.layerSystem.layerTransforms.delete(key);
    }
  }
  
  // â˜…â˜…â˜… Step 5: ã‚µãƒ ãƒã‚¤ãƒ«Canvaså‰Šé™¤ â˜…â˜…â˜…
  cutData.thumbnailCanvas = null;
}
```

**ç†ç”±**: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ããŸã‚ã®å®Œå…¨ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–

```javascript
// â˜…â˜…â˜… éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªCUTã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¯¾è±¡å¤– â˜…â˜…â˜…
switchToActiveCut(newIndex) {
  const oldCutData = this.cutMetadata[this.activeCutIndex];
  const newCutData = this.cutMetadata[newIndex];
  
  // æ—§CUTã‚’éè¡¨ç¤ºé ˜åŸŸã¸ï¼ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°åœæ­¢ï¼‰
  oldCutData.cutContainer.renderable = false;  // â† é‡è¦
  oldCutData.cutContainer.visible = false;
  
  // æ–°CUTã‚’è¡¨ç¤ºé ˜åŸŸã¸ï¼ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹ï¼‰
  newCutData.cutContainer.renderable = true;  // â† é‡è¦
  newCutData.cutContainer.visible = true;
}
```

**åŠ¹æœ**: ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¯¾è±¡ãŒ1 CUTåˆ†ã®ã¿ã«ãªã‚‹

---

### 2. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã®æœ€é©åŒ–

```javascript
// â˜…â˜…â˜… ä½è§£åƒåº¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° â˜…â˜…â˜…
generateCutThumbnail(cutIndex) {
  const cutData = this.cutMetadata[cutIndex];
  const cutContainer = cutData.cutContainer;
  
  // ã‚µãƒ ãƒã‚¤ãƒ«ã¯72x54ã®å°ã‚µã‚¤ã‚º
  const thumbScale = 72 / this.config.canvas.width;
  
  const renderTexture = PIXI.RenderTexture.create({
    width: 72,
    height: 54,
    resolution: 1  // ä½è§£åƒåº¦
  });
  
  // ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  const tempContainer = new PIXI.Container();
  tempContainer.addChild(cutContainer);
  tempContainer.scale.set(thumbScale);
  
  this.app.renderer.render({
    container: tempContainer,
    target: renderTexture
  });
  
  // ... CanvasæŠ½å‡º ...
}
```

**åŠ¹æœ**: ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ™‚é–“ãŒ1/10ä»¥ä¸‹ã«çŸ­ç¸®

---

### 3. ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹æ›´æ–°

```javascript
// âŒ NG: ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆæ¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒã‚§ãƒƒã‚¯ï¼‰
app.ticker.add(() => {
  if (needsUpdate) {
    updateUI();
  }
});

// âœ… OK: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•
eventBus.on('layer:path-added', () => {
  updateUI();
});

eventBus.on('animation:cut-applied', () => {
  updateUI();
});
```

**åŠ¹æœ**: ä¸è¦ãªæ›´æ–°å‡¦ç†ã‚’å‰Šæ¸›

---

## ğŸ¨ å°†æ¥ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€å®Ÿè£…ã¸ã®æ‹¡å¼µ

### ç¾åœ¨ã®æ§‹é€ 
```
CUT (PIXI.Container)
â”œâ”€ Layer1 (PIXI.Container)
â”œâ”€ Layer2 (PIXI.Container)
â””â”€ Layer3 (PIXI.Container)
```

### ãƒ•ã‚©ãƒ«ãƒ€å®Ÿè£…å¾Œ
```
CUT (PIXI.Container)
â”œâ”€ Folder1 (PIXI.Container)  â† type: 'folder'
â”‚   â”œâ”€ Layer1 (PIXI.Container)
â”‚   â””â”€ Layer2 (PIXI.Container)
â”œâ”€ Layer3 (PIXI.Container)
â””â”€ Folder2 (PIXI.Container)  â† type: 'folder'
    â””â”€ Layer4 (PIXI.Container)
```

### å®Ÿè£…æ–¹æ³•

```javascript
// Container ã« type ã‚’è¿½åŠ 
container.containerType = 'folder';  // or 'layer'

// ãƒ•ã‚©ãƒ«ãƒ€åˆ¤å®š
function isFolder(container) {
  return container.containerType === 'folder';
}

// å†å¸°çš„ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
function renderLayerTree(container, indent = 0) {
  if (isFolder(container)) {
    console.log('  '.repeat(indent) + 'ğŸ“ ' + container.layerData.name);
    container.children.forEach(child => {
      renderLayerTree(child, indent + 1);
    });
  } else {
    console.log('  '.repeat(indent) + 'ğŸ“„ ' + container.layerData.name);
  }
}

// ãƒ•ã‚©ãƒ«ãƒ€ã‚µãƒ ãƒã‚¤ãƒ« = å­Layeråˆæˆ
function generateFolderThumbnail(folderContainer) {
  // ãƒ•ã‚©ãƒ«ãƒ€å…¨ä½“ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆå­Layerã™ã¹ã¦å«ã‚€ï¼‰
  const renderTexture = PIXI.RenderTexture.create({...});
  app.renderer.render({
    container: folderContainer,  // ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    target: renderTexture
  });
  return app.renderer.extract.canvas(renderTexture);
}
```

**åˆ©ç‚¹**: 
- CUTã‚‚ãƒ•ã‚©ãƒ«ãƒ€ã‚‚åŒã˜Containeræ§‹é€ 
- æ—¢å­˜ã®ã‚¯ãƒ­ãƒ¼ãƒ³ãƒ»å‰Šé™¤ãƒ»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç†ãŒãã®ã¾ã¾ä½¿ãˆã‚‹
- éšå±¤æ§‹é€ ãŒè‡ªç„¶ã«è¡¨ç¾ã•ã‚Œã‚‹

---

## ğŸš€ ç§»è¡Œã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ®µéšçš„å®Ÿè£…ï¼‰

### Phase 1: AnimationSystemã®ContaineråŒ–
1. `cutsContainer` ã‚’ä½œæˆ
2. `cutMetadata` é…åˆ—ã‚’å®Ÿè£…
3. `createInitialCut()` ã§åˆæœŸCUTä½œæˆ
4. `switchToActiveCut()` ã§Containeråˆ‡æ›¿å®Ÿè£…

**æ¤œè¨¼**: 
- CUTãŒ cutsContainer.children ã«å­˜åœ¨ã™ã‚‹ã‹
- åˆ‡æ›¿ã§ canvasContainer ã®å­ãŒå¤‰ã‚ã‚‹ã‹

---

### Phase 2: LayerSystemã®getteråŒ–
1. `this.layers` ã‚’å‰Šé™¤
2. `get layers()` getterå®Ÿè£…
3. `switchToCutContainer()` å®Ÿè£…

**æ¤œè¨¼**:
- `layerSystem.layers` ãŒå‹•çš„ã«å¤‰ã‚ã‚‹ã‹
- CUTåˆ‡æ›¿å¾Œã€layersé…åˆ—ãŒæ–°CUTã®childrenã‹

---

### Phase 3: ã‚¯ãƒ­ãƒ¼ãƒ³æ©Ÿèƒ½å®Ÿè£…
1. `cloneCutContainer()` å®Ÿè£…
2. `cloneLayer()` å®Ÿè£…
3. `clonePath()` å®Ÿè£…
4. `createNewCut('copy_current')` å®Ÿè£…

**æ¤œè¨¼**:
- ã‚³ãƒ”ãƒ¼ã—ãŸCUTã¯å®Œå…¨ã«ç‹¬ç«‹ã—ã¦ã„ã‚‹ã‹
- å…ƒCUTã«æç”»ã—ã¦ã‚‚ã‚³ãƒ”ãƒ¼å…ˆã¯å¤‰åŒ–ã—ãªã„ã‹

---

### Phase 4: ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
1. `generateCutThumbnail()` å®Ÿè£…
2. TimelineUIã§ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
3. ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†è¿½åŠ 

**æ¤œè¨¼**:
- ã‚µãƒ ãƒã‚¤ãƒ«ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‹
- æç”»å¾Œã«ã‚µãƒ ãƒã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã‚‹ã‹

---

### Phase 5: ãƒ—ãƒ¬ã‚¤ãƒãƒƒã‚¯æ©Ÿèƒ½
1. `play()` / `stop()` å®Ÿè£…
2. ã‚¿ã‚¤ãƒãƒ¼ã§CUTè‡ªå‹•åˆ‡æ›¿
3. ãƒ«ãƒ¼ãƒ—è¨­å®šå®Ÿè£…

**æ¤œè¨¼**:
- CUTãŒé †ç•ªã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ã‹
- durationé€šã‚Šã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ã‹

---

## ğŸ“ å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ä¾‹ï¼ˆæŠœç²‹ï¼‰

### AnimationSystem.switchToActiveCut()

```javascript
switchToActiveCut(newIndex) {
  // åŒã˜CUTãªã‚‰ä½•ã‚‚ã—ãªã„
  if (this.activeCutIndex === newIndex) return;
  
  // ç¯„å›²ãƒã‚§ãƒƒã‚¯
  if (newIndex < 0 || newIndex >= this.cutMetadata.length) return;
  
  const oldCutData = this.cutMetadata[this.activeCutIndex];
  const newCutData = this.cutMetadata[newIndex];
  
  // â˜…â˜…â˜… Step 1: æ—§CUTã‚’éè¡¨ç¤ºé ˜åŸŸã¸æˆ»ã™ â˜…â˜…â˜…
  if (oldCutData.cutContainer.parent === this.canvasContainer) {
    this.canvasContainer.removeChild(oldCutData.cutContainer);
    this.cutsContainer.addChild(oldCutData.cutContainer);
    oldCutData.cutContainer.visible = false;
    oldCutData.cutContainer.renderable = false;
  }
  
  // â˜…â˜…â˜… Step 2: æ–°CUTã‚’è¡¨ç¤ºé ˜åŸŸã¸ç§»å‹• â˜…â˜…â˜…
  if (newCutData.cutContainer.parent === this.cutsContainer) {
    this.cutsContainer.removeChild(newCutData.cutContainer);
    this.canvasContainer.addChild(newCutData.cutContainer);
    newCutData.cutContainer.visible = true;
    newCutData.cutContainer.renderable = true;
    newCutData.cutContainer.position.set(0, 0);
  }
  
  // â˜…â˜…â˜… Step 3: LayerSystemã®å‚ç…§å…ˆã‚’åˆ‡æ›¿ â˜…â˜…â˜…
  this.layerSystem.switchToCutContainer(newCutData.cutContainer);
  
  // â˜…â˜…â˜… Step 4: Indexæ›´æ–° â˜…â˜…â˜…
  this.activeCutIndex = newIndex;
  
  // â˜…â˜…â˜… Step 5: UIæ›´æ–° â˜…â˜…â˜…
  this.layerSystem.updateLayerPanelUI();
  
  if (this.eventBus) {
    this.eventBus.emit('animation:cut-applied', {
      cutIndex: newIndex,
      cutId: newCutData.cutId
    });
  }
}
```

---

### LayerSystem.switchToCutContainer()

```javascript
switchToCutContainer(newCutContainer) {
  // â˜…â˜…â˜… å‚ç…§å…ˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã ã‘ï¼ˆã‚³ãƒ”ãƒ¼ä¸è¦ï¼‰ â˜…â˜…â˜…
  this.layersContainer = newCutContainer;
  
  // activeLayerIndexèª¿æ•´
  if (this.activeLayerIndex >= this.layers.length) {
    this.activeLayerIndex = Math.max(0, this.layers.length - 1);
  }
  
  // UIæ›´æ–°
  this.updateLayerPanelUI();
  this.updateStatusDisplay();
  
  if (this.eventBus) {
    this.eventBus.emit('layer:container-switched', {
      layerCount: this.layers.length
    });
  }
}
```

---

### AnimationSystem.cloneCutContainer()

```javascript
cloneCutContainer(sourceCutContainer) {
  const cloned = new PIXI.Container();
  cloned.label = 'cut_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  // å­Layerå…¨è¤‡è£½
  sourceCutContainer.children.forEach(sourceLayer => {
    const clonedLayer = this.cloneLayer(sourceLayer);
    cloned.addChild(clonedLayer);
  });
  
  // Transformç¶™æ‰¿
  cloned.position.set(sourceCutContainer.position.x, sourceCutContainer.position.y);
  cloned.scale.set(sourceCutContainer.scale.x, sourceCutContainer.scale.y);
  cloned.rotation = sourceCutContainer.rotation;
  cloned.alpha = sourceCutContainer.alpha;
  cloned.visible = false;  // éè¡¨ç¤ºé ˜åŸŸã§ä½œæˆ
  cloned.renderable = false;
  
  return cloned;
}
```

---

## âœ… æ”¹ä¿®å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### AnimationSystem
- [ ] `cutsContainer` ä½œæˆãƒ»éè¡¨ç¤ºé ˜åŸŸé…ç½®
- [ ] `cutMetadata` é…åˆ—å®Ÿè£…
- [ ] `createInitialCut()` å®Ÿè£…
- [ ] `createNewCut(sourceType)` å®Ÿè£…
- [ ] `cloneCutContainer()` / `cloneLayer()` / `clonePath()` å®Ÿè£…
- [ ] `switchToActiveCut()` å®Ÿè£…ï¼ˆContainerè¦ªå­é–¢ä¿‚å¤‰æ›´ï¼‰
- [ ] `deleteCut()` å®Ÿè£…ï¼ˆå®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
- [ ] `generateCutThumbnail()` å®Ÿè£…

### LayerSystem
- [ ] `this.layers` å‰Šé™¤ â†’ `get layers()` getterå®Ÿè£…
- [ ] `switchToCutContainer()` å®Ÿè£…
- [ ] `updateLayerPanelUI()` ã‚’getterå¯¾å¿œã«ä¿®æ­£
- [ ] `addPathToActiveLayer()` ã§EventBusé€šçŸ¥

### çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] CUT1ã§æç”» â†’ CUT2ã§ç©ºç™½ â†’ CUT1ã«æˆ»ã‚‹ã¨æç”»ãŒæ®‹ã‚‹
- [ ] CUTã‚³ãƒ”ãƒ¼ã§å®Œå…¨ã«ç‹¬ç«‹ã—ãŸCUTä½œæˆ
- [ ] CUTå‰Šé™¤ã§ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ç„¡ã—
- [ ] ã‚µãƒ ãƒã‚¤ãƒ«ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ—ãƒ¬ã‚¤ãƒãƒƒã‚¯ã§CUTãŒé †ç•ªã«åˆ‡ã‚Šæ›¿ã‚ã‚‹

---

## ğŸ¯ ã¾ã¨ã‚: ãªãœã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒæˆåŠŸã™ã‚‹ã®ã‹

### 1. **ã‚·ãƒ³ãƒ—ãƒ«ã•**
- Container = ãƒ•ã‚©ãƒ«ãƒ€ã¨ã„ã†ç›´æ„Ÿçš„ãªæ§‹é€ 
- å‚ç…§ç®¡ç†ã®ã¿ï¼ˆã‚³ãƒ”ãƒ¼å‡¦ç†ãŒæœ€å°é™ï¼‰

### 2. **ç¢ºå®Ÿæ€§**
- PIXI.Containerã®è¦ªå­é–¢ä¿‚ã§ç®¡ç†
- å‚ç…§æ¼ã‚ŒãŒåŸç†çš„ã«ç™ºç”Ÿã—ãªã„

### 3. **æ‹¡å¼µæ€§**
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€ã¨çµ±ä¸€çš„ãªæ‰±ã„
- éšå±¤æ§‹é€ ã®è‡ªç„¶ãªè¡¨ç¾

### 4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªCUTã®ã¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- Containeråˆ‡æ›¿ã¯é«˜é€Ÿ

### 5. **ãƒ‡ãƒãƒƒã‚°æ€§**
- Containeræ§‹é€ ãŒãã®ã¾ã¾ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
- Chrome DevToolsã§å¯è¦–åŒ–å¯èƒ½

---

**æ”¹ä¿®æ–¹é‡**: Bæ¡ˆï¼ˆCUT = ã‚¢ãƒ‹ãƒ¡ç”¨å¤§ãƒ•ã‚©ãƒ«ãƒ€ï¼‰ã‚’æ¡ç”¨  
**ç†ç”±**: Aæ¡ˆã®äºŒæ¡ã®è©¦è¡ŒéŒ¯èª¤ã‚’çµŒã¦ã€å‚ç…§ç®¡ç†ã®è¤‡é›‘ã•ãŒæœ¬è³ªçš„ãªå•é¡Œã¨åˆ¤æ˜  
**ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: Container = çœŸå®Ÿã€LayerSystem = View  
**æˆåŠŸã®éµ**: ã‚³ãƒ”ãƒ¼å‡¦ç†ã‚’æœ€å°åŒ–ã—ã€å‚ç…§ã®æ˜ç¢ºåŒ–ã‚’å¾¹åº•

---

## ğŸ“š å‚è€ƒ: PIXI.Container APIè¦ç‚¹

```javascript
// å­è¦ç´ è¿½åŠ 
container.addChild(child);

// å­è¦ç´ å‰Šé™¤
container.removeChild(child);

// å­è¦ç´ é…åˆ—
container.children  // Array<DisplayObject>

// è¦ªè¦ç´ 
container.parent  // Container | null

// ç ´æ£„
container.destroy({
  children: true,      // å­è¦ç´ ã‚‚ç ´æ£„
  texture: false,      // ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¯ç ´æ£„ã—ãªã„
  baseTexture: false   // ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¯ç ´æ£„ã—ãªã„
});

// ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°åˆ¶å¾¡
container.visible = false;     // éè¡¨ç¤º
container.renderable = false;  // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¯¾è±¡å¤–
```

---

**ä½œæˆæ—¥**: 2025-09-30  
**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v8.13_gif_phase2_folder  
**æ”¹ä¿®æ‹…å½“AI**: Claude Sonnet 4.5