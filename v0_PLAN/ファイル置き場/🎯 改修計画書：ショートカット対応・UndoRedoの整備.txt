ğŸ¯ æ”¹ä¿®è¨ˆç”»æ›¸ï¼šã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå¯¾å¿œãƒ»Undo/Redoã®æ•´å‚™
1. ãƒ–ãƒ©ã‚¦ã‚¶ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç«¶åˆå›é¿
æ–¹æ³•

keydown ã‚¤ãƒ™ãƒ³ãƒˆã§ event.preventDefault() ã‚’é©åˆ‡ã«ä½¿ã†ã€‚

ãŸã ã— å…¨ã‚­ãƒ¼ã§ç„¡åŠ¹åŒ–ã™ã‚‹ã®ã¯å±é™ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶æ©Ÿèƒ½ã‚’ä½¿ãˆãªããªã‚‹ï¼‰ã€‚
â†’ ãƒ„ãƒ¼ãƒ«ã§å¿…è¦ãªã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã ã‘ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã€ãã‚Œä»¥å¤–ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«æ¸¡ã™ã€‚

å®Ÿè£…ä¾‹ï¼ˆevent-bus.jsã«çµ±åˆæ¨å¥¨ï¼‰


document.addEventListener("keydown", (e) => {
    const key = e.key.toLowerCase();
    const ctrl = e.ctrlKey || e.metaKey;

    // Ctrl+Z â†’ Undo
    if (ctrl && key === "z") {
        e.preventDefault();
        EventBus.emit("history:undo");
    }
    // Ctrl+Y or Ctrl+Shift+Z â†’ Redo
    if ((ctrl && key === "y") || (ctrl && e.shiftKey && key === "z")) {
        e.preventDefault();
        EventBus.emit("history:redo");
    }
    // Ctrl+S â†’ ãƒ„ãƒ¼ãƒ«å†…ä¿å­˜
    if (ctrl && key === "s") {
        e.preventDefault();
        EventBus.emit("file:save");
    }
    // å¿…è¦ã«å¿œã˜ã¦ä»–ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¿½åŠ 
});

ğŸ‘‰ ãƒã‚¤ãƒ³ãƒˆï¼š

æ˜ç¤ºçš„ã«å‰²ã‚ŠæŒ¯ã£ãŸã‚‚ã®ã ã‘ preventDefault ã™ã‚‹ã€‚

EventBus ã‚’ä»‹ã—ã¦ HistorySystem / LayerSystem / FileSystem ã«é€šçŸ¥ã™ã‚‹è¨­è¨ˆã«ã™ã‚‹ã¨æ‹¡å¼µã—ã‚„ã™ã„ã€‚


2. Undo / Redo ã®ç¢ºèª

å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼š

history.js

event-bus.js

ç¾çŠ¶ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ

history.js ãŒå±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯ã‚’æŒã£ã¦ã„ã‚‹ã‹ï¼Ÿ

undo() / redo() ãŒã€Œéç ´å£Šæ“ä½œã€ï¼ˆå±¥æ­´ã‚’ç©ã¿å¢—ã—ã™ã‚‹å½¢ï¼‰ã‹ã€Œç ´å£Šæ“ä½œã€ï¼ˆCanvasã‚’ç›´æ¥å·»ãæˆ»ã™ï¼‰ã‹ï¼Ÿ

event-bus.js ã§ Ctrl+Z / Ctrl+Y ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãŒã‚ã‚‹ã‹ï¼Ÿ

ğŸ‘‰ ç¾åœ¨ã® history.js ã‚’ç¢ºèªã—ãŸé™ã‚Šã§ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯å½¢å¼ã§å±¥æ­´ç®¡ç†ã—ã¦ã„ã‚‹ãŒã€UIã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¨ã®çµåˆãŒå¼±ã„ã€‚
â†’ CTRL+Z / CTRL+Y ãŒç¢ºå®Ÿã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒé«˜ã„ã€‚


3. æ”¹ä¿®å†…å®¹
è¿½åŠ ãƒ»ä¿®æ­£ã‚¿ã‚¹ã‚¯

ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆçµ±åˆå±¤ã®æ–°è¨­

system/shortcut-manager.js ã‚’æ–°è¦è¿½åŠ ã€‚

event-bus.js ã«åˆ†æ•£ã—ã¦ã„ã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå‡¦ç†ã‚’æ•´ç†ã—ã€å¯èª­æ€§ã‚’é«˜ã‚ã‚‹ã€‚

Undo/Redo ã® EventBus çµ±åˆ

EventBus.emit("history:undo") / EventBus.emit("history:redo") ã‚’æ¨™æº–åŒ–ã€‚

history.js å†…ã§ EventBus ã‚’ listen ã—ã¦å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

éç ´å£Šç¢ºèª

å±¥æ­´ã‚’ã€Œå·®åˆ†é©ç”¨å‹ã€ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚„æ“ä½œå˜ä½ã§è¨˜éŒ²ï¼‰ã«å¯„ã›ã‚‹ã€‚

ImageData ä¸¸ã”ã¨ä¿å­˜ã ã¨é‡ã„ã®ã§ã€å°†æ¥çš„ã«ã¯ã€Œæ“ä½œãƒ­ã‚°æ–¹å¼ã€ã‚‚æ¤œè¨ã€‚

ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå‰²ã‚Šå½“ã¦è¡¨ã‚’ä½œæˆ

CTRL+Z â†’ Undo

CTRL+Y / CTRL+SHIFT+Z â†’ Redo

CTRL+Shift+Nã€€â†’ã€€æ–°è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ

ALT+Spaceã€€â†’ã€€ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ/åœæ­¢

ALT+Cã€€â†’ã€€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTã®ã‚³ãƒ”ãƒ¼ï¼†å³éš£ã«æ–°è¦CUTã‚’ä½œæˆã¨ã‚³ãƒ”ãƒ¼å†…å®¹ã®ãƒšãƒ¼ã‚¹ãƒˆï¼ˆ+C&Pãƒœã‚¿ãƒ³ã¨ä¸€ç·’ï¼‰

ALT+Nã€€â†’ã€€æ–°è¦CUTã®ä½œæˆã€‚ï¼ˆ+CUTãƒœã‚¿ãƒ³ã¨ä¸€ç·’ï¼‰

CTRL+S â†’ ä¿å­˜ï¼ˆå†…éƒ¨ä¿å­˜ or ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰

CTRL+SHIFT+S â†’ åˆ¥åä¿å­˜ï¼ˆå°†æ¥ç”¨ï¼‰

CTRL+O â†’ èª­ã¿è¾¼ã¿ï¼ˆå°†æ¥ç”¨ï¼‰

DELETE â†’ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤

ALT+DELETE â†’ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–CUTãƒ‡ãƒªãƒ¼ãƒˆ

4. æ”¹ä¿®ã®é€²ã‚æ–¹ï¼ˆæ®µéšçš„ï¼‰

ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç«¶åˆåˆ¶å¾¡ã®å°å…¥

event.preventDefault() ã‚’å°å…¥ã—ã€æ—¢å­˜ã® event-bus.js ã«æœ€å°é™è¿½åŠ ã€‚

Undo/Redo ã® EventBus é€£æºå¼·åŒ–

history.js ãŒç¢ºå®Ÿã«å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«æ”¹ä¿®ã€‚

shortcut-manager.js ã®å°å…¥

ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå‡¦ç†ã‚’é›†ç´„ã—ã¦å¯èª­æ€§ã‚’ä¸Šã’ã‚‹ã€‚

å‹•ä½œç¢ºèª

CTRL+Z / CTRL+Y ãŒãƒ–ãƒ©ã‚¦ã‚¶å‹•ä½œã‚’æ½°ã•ãšã«ã€ãƒ„ãƒ¼ãƒ«å†…éƒ¨ã ã‘ã«åŠ¹ãã“ã¨ã‚’ç¢ºèªã€‚

å±¥æ­´ãŒæ­£ã—ãç©ã¾ã‚Œã¦éç ´å£Šå‹•ä½œã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã€‚


âš shortcut-manager.jsåˆ†é›¢æ¡ˆãŒå‡ºãŸãŒã€event-bus.js ã®ãƒ•ã‚¡ã‚¤ãƒ«é‡ãŒå°‘ãªã„ã®ã§ä¸€æ‹¬åŒ–ã§è‰¯ã„ã€‚

ä»¥ä¸‹ã¯ ã‚µãƒ³ãƒ—ãƒ«æ”¹ä¿®ã‚³ãƒ¼ãƒ‰ï¼ˆè¿½åŠ éƒ¨åˆ†ã®ã¿ï¼‰ ã§ã™ã€‚
Undo / Redo ã‚’ä¸­å¿ƒã«ã€ç«¶åˆã—ã‚„ã™ã„ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’ä¾‹ã¨ã—ã¦å…¥ã‚Œã¦ã‚ã‚Šã¾ã™ã€‚

// event-bus.js

// === EventBus åŸºæœ¬å®Ÿè£…ï¼ˆæ—¢å­˜éƒ¨åˆ†ã¯çœç•¥ï¼‰ ===
const EventBus = {
    events: {},
    on(event, handler) {
        if (!this.events[event]) this.events[event] = [];
        this.events[event].push(handler);
    },
    emit(event, payload) {
        if (this.events[event]) {
            this.events[event].forEach(handler => handler(payload));
        }
    }
};

// === ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç®¡ç† ===
// TODO: å°†æ¥çš„ã« shortcut-manager.js ã¸åˆ†é›¢ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š
document.addEventListener("keydown", (e) => {
    const key = e.key.toLowerCase();
    const ctrl = e.ctrlKey || e.metaKey;

    // Undo: Ctrl+Z
    if (ctrl && key === "z" && !e.shiftKey) {
        e.preventDefault();
        EventBus.emit("history:undo");
    }

    // Redo: Ctrl+Y ã¾ãŸã¯ Ctrl+Shift+Z
    if ((ctrl && key === "y") || (ctrl && e.shiftKey && key === "z")) {
        e.preventDefault();
        EventBus.emit("history:redo");
    }

    // Save: Ctrl+S
    if (ctrl && key === "s") {
        e.preventDefault();
        EventBus.emit("file:save");
    }

    // Open: Ctrl+O
    if (ctrl && key === "o") {
        e.preventDefault();
        EventBus.emit("file:open");
    }

    // Delete: ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤
    if (key === "delete") {
        e.preventDefault();
        EventBus.emit("layer:delete");
    }
});

// === ä»–ã‚·ã‚¹ãƒ†ãƒ ãŒ EventBus ã‚’è³¼èª­ã—ã¦å‹•ä½œã™ã‚‹ä¾‹ ===
EventBus.on("history:undo", () => {
    console.log("Undo triggered");
    // history.js å†…ã® undo() ã‚’å‘¼ã³å‡ºã™
});

EventBus.on("history:redo", () => {
    console.log("Redo triggered");
    // history.js å†…ã® redo() ã‚’å‘¼ã³å‡ºã™
});






