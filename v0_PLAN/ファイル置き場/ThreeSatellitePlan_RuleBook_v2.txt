# â­ ä¸‰åˆ†å‰²é‹ç”¨ç”¨ AIæ”¹ä¿®æœ€é©åŒ–ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ v2.0

## 1. åŸºæœ¬ç†å¿µ
- **ä¸»æ˜Ÿï¼ˆMainControllerï¼‰**: ã‚¤ãƒ™ãƒ³ãƒˆä»²ä»‹ãƒ»çŠ¶æ…‹ç®¡ç†ãƒ»åˆæœŸåŒ–åˆ¶å¾¡ã®ã¿
- **è¡›æ˜Ÿ**: æ©Ÿèƒ½æä¾›ã®ã¿ã€çŠ¶æ…‹ä¿æŒç¦æ­¢ã€ç›´æ¥é€šä¿¡ç¦æ­¢
- **AIæ”¹ä¿®å®¹æ˜“æ€§**: äºˆæ¸¬å¯èƒ½ãƒ»è¿½è·¡å¯èƒ½ãƒ»ãƒ‡ãƒãƒƒã‚°å¯èƒ½ãªã‚³ãƒ¼ãƒ‰æ§‹é€ ã‚’æœ€å„ªå…ˆ

## 2. æŠ€è¡“ä»•æ§˜ï¼ˆå³æ ¼ï¼‰
```
å®Ÿè¡Œç’°å¢ƒ    : Chromeæœ€æ–°ã€ãƒ­ãƒ¼ã‚«ãƒ«HTMLç›´é–‹ãï¼ˆfile://ï¼‰
æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: PixiJS v8ï¼ˆCDNï¼‰ã€ES2023ã€fetch APIå¯
ç¦æ­¢æŠ€è¡“   : Canvas2D, TypeScript, Vite, ESM, bundler, Babel
ãƒ•ã‚¡ã‚¤ãƒ«æ•°  : 4ãƒ•ã‚¡ã‚¤ãƒ«å›ºå®šï¼ˆmain.html + 3è¡›æ˜Ÿ.jsï¼‰
```

## 3. ãƒ•ã‚¡ã‚¤ãƒ«è²¬å‹™è¡¨ï¼ˆå³æ ¼å®šç¾©ï¼‰

### main.html (MainController) 
**å˜ä¸€è²¬å‹™**: ã‚¤ãƒ™ãƒ³ãƒˆä»²ä»‹ãƒ»çŠ¶æ…‹ç®¡ç†ãƒ»åˆæœŸåŒ–
```javascript
// ç®¡ç†ã™ã‚‹çŠ¶æ…‹
const appState = {
  initialized: boolean,
  spacePressed: boolean,
  currentTool: string,
  activeLayerId: number,
  camera: { x: number, y: number }
};

// æä¾›ã™ã‚‹API
MainController.emit(eventType, payload)
MainController.on(eventType, handler) 
MainController.getState(key)
MainController.setState(key, value)
```
**ç¦æ­¢äº‹é …**: æç”»å‡¦ç†ã€UIæ“ä½œã€åº§æ¨™è¨ˆç®—ã®ç›´æ¥å®Ÿè¡Œ

### engine-position.js (PositionManager)
**å˜ä¸€è²¬å‹™**: åº§æ¨™ç®¡ç†ãƒ»ã‚«ãƒ¡ãƒ©åˆ¶å¾¡
```javascript
// ç®¡ç†ã™ã‚‹çŠ¶æ…‹ï¼ˆMainControllerã‹ã‚‰å—ä¿¡ã®ã¿ï¼‰
// æä¾›ã™ã‚‹æ©Ÿèƒ½
screenToWorld(x, y)
worldToScreen(x, y) 
setCamera(dx, dy)
resetCamera()
```
**ç¦æ­¢äº‹é …**: UIæ“ä½œã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã€æç”»å†…å®¹ã®å¤‰æ›´

### layer-tool-ui.js (LayerManager + UIManager)
**å˜ä¸€è²¬å‹™**: ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ãƒ»ãƒ„ãƒ¼ãƒ«ç®¡ç†ãƒ»UIåˆ¶å¾¡
```javascript
// æä¾›ã™ã‚‹æ©Ÿèƒ½  
createLayer(name)
deleteLayer(id)
setActiveLayer(id)
toggleLayerVisibility(id)
selectTool(toolName)
updateUI()
```
**ç¦æ­¢äº‹é …**: åº§æ¨™è¨ˆç®—ã€ã‚«ãƒ¡ãƒ©åˆ¶å¾¡ã€ç›´æ¥æç”»

### error-service.js (ErrorService)
**å˜ä¸€è²¬å‹™**: ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ»ãƒ­ã‚°ç®¡ç†
```javascript
// æä¾›ã™ã‚‹æ©Ÿèƒ½
reportError(code, details)
logDebug(category, message)
showErrorDialog(message)
```
**ç¦æ­¢äº‹é …**: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã€ã‚¨ãƒ©ãƒ¼éš è”½ã€å•é¡Œå…ˆé€ã‚Š

## 4. ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•è¨­è¨ˆï¼ˆAIè¿½è·¡æœ€é©åŒ–ï¼‰

### ã‚¤ãƒ™ãƒ³ãƒˆå‹å®šç¾©ï¼ˆå®Œå…¨ç¶²ç¾…ï¼‰
```javascript
const EVENT_TYPES = {
  // å…¥åŠ›ç³»
  'input-pointer-down': { x: 'number', y: 'number', pressure: 'number' },
  'input-pointer-move': { x: 'number', y: 'number', pressure: 'number' },  
  'input-pointer-up': { x: 'number', y: 'number' },
  'input-space-press': { pressed: 'boolean' },
  'input-arrow-key': { direction: 'string', pressed: 'boolean' },
  
  // ã‚«ãƒ¡ãƒ©ç³»
  'camera-move-request': { dx: 'number', dy: 'number' },
  'camera-position-changed': { x: 'number', y: 'number' },
  'camera-reset-request': {},
  'camera-bounds-check': { x: 'number', y: 'number' },
  
  // æç”»ç³»  
  'draw-start-request': { x: 'number', y: 'number', layerId: 'number' },
  'draw-continue-request': { x: 'number', y: 'number' },
  'draw-end-request': {},
  'stroke-created': { strokeId: 'string', layerId: 'number' },
  
  // ãƒ¬ã‚¤ãƒ¤ãƒ¼ç³»
  'layer-create-request': { name: 'string' },
  'layer-created': { layerId: 'number', name: 'string' },
  'layer-delete-request': { layerId: 'number' },
  'layer-activate-request': { layerId: 'number' },
  'layer-visibility-toggle': { layerId: 'number', visible: 'boolean' },
  
  // ãƒ„ãƒ¼ãƒ«ç³»
  'tool-select-request': { toolName: 'string' },
  'tool-selected': { toolName: 'string' },
  'brush-size-change': { size: 'number' },
  'brush-opacity-change': { opacity: 'number' },
  
  // UIç³»
  'ui-popup-toggle': { popupId: 'string' },
  'ui-coordinates-update': { x: 'number', y: 'number' },
  'ui-status-update': { key: 'string', value: 'any' },
  
  // ã‚·ã‚¹ãƒ†ãƒ ç³»
  'system-init-complete': {},
  'system-resize-request': { width: 'number', height: 'number' },
  'system-error': { code: 'string', details: 'object' },
  'system-debug': { category: 'string', message: 'string', data: 'object' }
};
```

### ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ï¼ˆæ®µéšæ˜ç¤ºï¼‰
```
[æ®µéš1: å…¥åŠ›æ¤œå‡º] â†’ MainController.emit()
[æ®µéš2: çŠ¶æ…‹æ›´æ–°] â†’ MainController.setState()  
[æ®µéš3: å‡¦ç†ä¾é ¼] â†’ å¯¾è±¡è¡›æ˜Ÿ.onEvent()
[æ®µéš4: çµæœé€šçŸ¥] â†’ MainController.emit()
[æ®µéš5: UIåæ˜ ] â†’ UIç³»è¡›æ˜Ÿ.onEvent()
```

## 5. ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ï¼ˆAIè§£ææœ€é©åŒ–ï¼‰

### é–¢æ•°å‘½åè¦ç´„
```javascript
// ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆå¿…é ˆprefixï¼‰
handle[EventName](payload) // handleCameraMove(payload)

// çŠ¶æ…‹æ›´æ–°ï¼ˆå¿…é ˆprefixï¼‰ 
update[StateName](value)   // updateCameraPosition(x, y)

// UIæ“ä½œï¼ˆå¿…é ˆprefixï¼‰
render[ComponentName]()    // renderLayerList()

// åº§æ¨™å¤‰æ›ï¼ˆå¿…é ˆå½¢å¼ï¼‰
[source]To[target](x, y)   // screenToWorld(x, y)
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•å®Œå…¨ç¦æ­¢ï¼‰
```javascript
// âŒ ç¦æ­¢: æš—é»™çš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
function getLayer(id) {
  return layers.get(id) || layers.get(0); // NG
}

// âœ… æ¨å¥¨: æ˜ç¤ºçš„ã‚¨ãƒ©ãƒ¼
function getLayer(id) {
  const layer = layers.get(id);
  if (!layer) {
    MainController.emit('system-error', { 
      code: 'LAYER_NOT_FOUND', 
      details: { layerId: id } 
    });
    throw new Error(`Layer ${id} not found`);
  }
  return layer;
}
```

### çŠ¶æ…‹ç®¡ç†ï¼ˆMainControlleré›†ç´„ï¼‰
```javascript
// âŒ ç¦æ­¢: è¡›æ˜Ÿå†…çŠ¶æ…‹ä¿æŒ
class LayerManager {
  constructor() {
    this.activeLayerId = null; // NG
  }
}

// âœ… æ¨å¥¨: MainControllerçµŒç”±
class LayerManager {
  getActiveLayerId() {
    return MainController.getState('activeLayerId'); // OK
  }
}
```

## 6. ãƒ‡ãƒãƒƒã‚°æ”¯æ´ï¼ˆAIè¿½è·¡å¼·åŒ–ï¼‰

### ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ­ã‚°ï¼ˆå¿…é ˆå®Ÿè£…ï¼‰
```javascript
// å„å‡¦ç†ã®é–‹å§‹ãƒ»çµ‚äº†ã‚’è¨˜éŒ²
function handleCameraMove(payload) {
  MainController.emit('system-debug', { 
    category: 'camera', 
    message: 'move-start', 
    data: payload 
  });
  
  // å‡¦ç†å®Ÿè¡Œ
  const result = this.moveCamera(payload.dx, payload.dy);
  
  MainController.emit('system-debug', { 
    category: 'camera', 
    message: 'move-end', 
    data: result 
  });
  
  return result;
}
```

### çŠ¶æ…‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
```javascript
// é‡è¦ãªçŠ¶æ…‹å¤‰åŒ–æ™‚ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
MainController.setState = function(key, value) {
  const oldValue = this.state[key];
  this.state[key] = value;
  
  if (APP_CONFIG.debug) {
    console.log(`State changed: ${key}`, { 
      from: oldValue, 
      to: value, 
      timestamp: Date.now() 
    });
  }
  
  this.emit('state-changed', { key, oldValue, newValue: value });
};
```

## 7. åº§æ¨™ç³»çµ±ä¸€ï¼ˆæ··åœ¨è§£æ¶ˆï¼‰

### DOMåº§æ¨™ç³»ãƒ™ãƒ¼ã‚¹æ¡ç”¨
```javascript
// åŸºæº–: DOMè¦ç´ ã®clientX, clientY
// canvas containerã®transformã§è¦–è¦šçš„ç§»å‹•ã‚’å®Ÿç¾
// PixiJSå†…åº§æ¨™ã¯å¤‰æ›å¾Œã®å€¤ã¨ã—ã¦æ‰±ã†

class PositionManager {
  screenToWorld(screenX, screenY) {
    return {
      x: screenX - this.camera.x,
      y: screenY - this.camera.y
    };
  }
  
  worldToScreen(worldX, worldY) {
    return {
      x: worldX + this.camera.x,
      y: worldY + this.camera.y  
    };
  }
}
```

## 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ¶ç´„

### å‡¦ç†æ™‚é–“åˆ¶é™
- ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†: 16msä»¥å†…ï¼ˆ60fpsç¶­æŒï¼‰
- åº§æ¨™å¤‰æ›: 1msä»¥å†…
- UIæ›´æ–°: 8msä»¥å†…

### ãƒ¡ãƒ¢ãƒªç®¡ç†
- å¾ªç’°å‚ç…§ã®å®Œå…¨æ’é™¤
- ä¸è¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å³åº§è§£æ”¾
- WeakMapã®æ´»ç”¨

## 9. ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§

### å˜ä½“ãƒ†ã‚¹ãƒˆæ”¯æ´
```javascript
// å„è¡›æ˜Ÿã¯ç´”ç²‹é–¢æ•°ã¨ã—ã¦è¨­è¨ˆ
// MainController.emitã‚’ãƒ¢ãƒƒã‚¯åŒ–ã™ã‚‹ã“ã¨ã§ç‹¬ç«‹ãƒ†ã‚¹ãƒˆå¯èƒ½
const mockMainController = {
  emit: jest.fn(),
  getState: jest.fn(),
  setState: jest.fn()
};
```

### çµ±åˆãƒ†ã‚¹ãƒˆæ”¯æ´  
```javascript
// ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ã®æ¤œè¨¼
const eventHistory = [];
MainController.emit = function(type, payload) {
  eventHistory.push({ type, payload, timestamp: Date.now() });
  // å…ƒã®å‡¦ç†ç¶šè¡Œ
};
```

## 10. AIæ”¹ä¿®æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### âœ… æ”¹ä¿®å‰ç¢ºèª
- [ ] å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®è²¬å‹™ãŒãƒ«ãƒ¼ãƒ«ã«é©åˆã—ã¦ã„ã‚‹ã‹
- [ ] å¤‰æ›´ãŒã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ã«å½±éŸ¿ã—ãªã„ã‹  
- [ ] å¾ªç’°å‚ç…§ãŒç™ºç”Ÿã—ãªã„ã‹

### âœ… æ”¹ä¿®å¾Œç¢ºèª
- [ ] å…¨ã‚¤ãƒ™ãƒ³ãƒˆå‹ãŒå®šç¾©æ¸ˆã¿ã‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã‹
- [ ] ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‹
- [ ] çŠ¶æ…‹ãŒMainControllerã«é›†ç´„ã•ã‚Œã¦ã„ã‚‹ã‹

### âœ… å‹•ä½œç¢ºèªé …ç›®
1. ã‚«ãƒ¡ãƒ©ç§»å‹•ï¼ˆSpace+Drag, Space+Arrowï¼‰
2. ãƒšãƒ³æç”»ï¼ˆå·¦ã‚¯ãƒªãƒƒã‚¯+ãƒ‰ãƒ©ãƒƒã‚°ï¼‰ 
3. æ¶ˆã—ã‚´ãƒ ï¼ˆãƒ„ãƒ¼ãƒ«åˆ‡æ›¿+ä½¿ç”¨ï¼‰
4. ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œï¼ˆè¿½åŠ ãƒ»å‰Šé™¤ãƒ»è¡¨ç¤ºåˆ‡æ›¿ãƒ»é †åºå¤‰æ›´ï¼‰
5. UIæ“ä½œï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ»ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ»ãƒªã‚µã‚¤ã‚ºï¼‰

## 11. ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆAIåˆ¤æ–­è¿·ã„é˜²æ­¢ï¼‰

### ğŸš« çµ¶å¯¾ç¦æ­¢
```javascript
// è¡›æ˜Ÿé–“ç›´æ¥å‚ç…§
layerManager.drawingEngine.createPath(); // NG

// try-catch ã§ã®å•é¡Œéš è”½  
try { riskyOperation(); } catch(e) { /* ç„¡è¦– */ } // NG

// undefinedã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
const value = maybeUndefined || defaultValue; // NG

// éåŒæœŸå‡¦ç†ã®æš—é»™çš„å¾…æ©Ÿ
setTimeout(() => fixSomething(), 100); // NG
```

### âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³
```javascript
// MainControllerçµŒç”±ã®é€šä¿¡
MainController.emit('draw-request', payload); // OK

// æ˜ç¤ºçš„ã‚¨ãƒ©ãƒ¼å‡¦ç†
if (!isValid) throw new Error('æ˜ç¤ºçš„ç†ç”±'); // OK  

// å³å¯†ãªå€¤ãƒã‚§ãƒƒã‚¯
if (value === undefined) handleError(); // OK

// Promise/async-awaitã®ä½¿ç”¨
await operation(); // OK
```

---

ã“ã®ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ã«ã‚ˆã‚Šã€AIã¯è¿·ã‚ãšã«æ”¹ä¿®ä½œæ¥­ã‚’è¡Œãˆã€äººé–“ã‚‚çµæœã‚’äºˆæ¸¬ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚