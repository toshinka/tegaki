# CUTÃ—Layer 2æ¬¡å…ƒãƒãƒˆãƒªã‚¯ã‚¹ç®¡ç† æ”¹ä¿®è¨ˆç”»æ›¸

## ğŸ“‹ ç¾çŠ¶ã®å•é¡Œåˆ†æ

### ç™ºç”Ÿã—ã¦ã„ã‚‹ä¸å…·åˆ
1. **ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚µãƒ ãƒã‚¤ãƒ«ãŒåæ˜ ã•ã‚Œãªã„**
2. **CUT1 Layer1ã§æã„ãŸçµµãŒCUT2 Layer1ã«åæ˜ ã•ã‚Œã‚‹**

### æ ¹æœ¬åŸå› 
ç¾çŠ¶ã¯ **éƒ¨åˆ†çš„ãªDeep Copy** ã«ç•™ã¾ã£ã¦ãŠã‚Šã€ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼š

```javascript
// âŒ å•é¡Œ1: LayerSystemã®layersé…åˆ—ãŒå‚ç…§ã‚’ä¿æŒ
this.layers = []; // AnimationSystemã®CUTãƒ‡ãƒ¼ã‚¿ã¸ã®å‚ç…§ãŒæ··åœ¨

// âŒ å•é¡Œ2: saveCutLayerStates()ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œ
// æç”»ä¸­ã«LayerSystemã®layersãŒæ›´æ–°ã•ã‚Œã¦ã‚‚ã€AnimationSystemã¸ã®ä¿å­˜ãŒé…å»¶

// âŒ å•é¡Œ3: CUTåˆ‡æ›¿æ™‚ã®syncå‡¦ç†ãŒä¸å®Œå…¨
// _syncLayersContainerFromAnimationSystem()ã§Deep Copyã›ãšã«å‚ç…§ã‚’æ¸¡ã—ã¦ã„ã‚‹
```

---

## ğŸ¯ æ¡ç”¨ã™ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### **é¸æŠ: Aæ¡ˆ - 2æ¬¡å…ƒãƒãƒˆãƒªã‚¯ã‚¹ç®¡ç†**

#### ç†ç”±
- **Bæ¡ˆï¼ˆãƒ•ã‚©ãƒ«ãƒ€ç®¡ç†ï¼‰** ã¯å°†æ¥ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€æ©Ÿèƒ½ã¨ç«¶åˆã™ã‚‹å¯èƒ½æ€§
- **Aæ¡ˆ** ã¯CUTè»¸ã¨Layerè»¸ã‚’æ˜ç¢ºã«åˆ†é›¢ã—ã€æ—¢å­˜æ§‹é€ ã‚’æ´»ã‹ã›ã‚‹
- AnimationSystemãŒã€Œå”¯ä¸€ã®çœŸå®Ÿã®æƒ…å ±æºï¼ˆSingle Source of Truthï¼‰ã€ã¨ã—ã¦æ©Ÿèƒ½

#### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
```javascript
AnimationSystem.animationData.cuts = [
  {
    id: 'cut_001',
    name: 'CUT1',
    duration: 0.5,
    layers: [
      { id: 'cut_001_layer_bg', name: 'èƒŒæ™¯', paths: [...], transform: {...} },
      { id: 'cut_001_layer_01', name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼1', paths: [...], transform: {...} },
      { id: 'cut_001_layer_02', name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼2', paths: [...], transform: {...} }
    ],
    thumbnailCanvas: <Canvas>
  },
  {
    id: 'cut_002',
    name: 'CUT2',
    duration: 0.5,
    layers: [
      { id: 'cut_002_layer_bg', name: 'èƒŒæ™¯', paths: [...], transform: {...} },
      { id: 'cut_002_layer_01', name: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼1', paths: [...], transform: {...} }  // â† å®Œå…¨ç‹¬ç«‹
    ],
    thumbnailCanvas: <Canvas>
  }
];

// LayerSystemã¯ã€Œç¾åœ¨ã®CUTã®Viewã€ã§ã—ã‹ãªã„
LayerSystem.layers = []; // PIXI.Containerã®é…åˆ—ï¼ˆæç”»ç”¨ï¼‰
```

---

## ğŸ”§ æ”¹ä¿®æ–¹é‡

### åŸå‰‡
1. **AnimationSystem = ãƒ‡ãƒ¼ã‚¿ã®å”¯ä¸€ã®æ‰€æœ‰è€…**
2. **LayerSystem = æç”»ã¨UIæ“ä½œã®View**
3. **ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã¯AnimationSystemã‚’çµŒç”±**
4. **å‚ç…§ã®å…±æœ‰ã‚’å®Œå…¨æ’é™¤**

### ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
- `LayerSystem.layers`ã¯**èª­ã¿å–ã‚Šå°‚ç”¨ã®View**
- æç”»å®Œäº†æ™‚ã¯**å³åº§ã«AnimationSystemã¸Deep Copyä¿å­˜**
- CUTåˆ‡æ›¿æ™‚ã¯**å®Œå…¨ãªLayerå†æ§‹ç¯‰**

---

## ğŸ“ è©³ç´°æ”¹ä¿®å†…å®¹

### 1. AnimationSystem ã®æ”¹ä¿®

#### 1-1. `copyCurrentLayersToIndependentState()` - å®Œå…¨æ€§ä¿è¨¼
**ç›®çš„**: LayerSystemã®ç¾åœ¨çŠ¶æ…‹ã‹ã‚‰å®Œå…¨ç‹¬ç«‹ã®CUTãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ

**æ”¹ä¿®å†…å®¹**:
```javascript
copyCurrentLayersToIndependentState(cutId) {
  // âœ… pathsé…åˆ—ã®å®Œå…¨Deep Copy
  // âœ… pointsé…åˆ—ã‚‚æ–°è¦ä½œæˆ
  // âœ… transformæƒ…å ±ã‚‚è¤‡è£½
  // âŒ å‚ç…§ã®å…±æœ‰ã‚’çµ¶å¯¾ã«ã—ãªã„
}
```

**ä½¿ç”¨ç®‡æ‰€**:
- `createNewCutFromCurrentLayers()` - CUTä½œæˆæ™‚
- `saveCutLayerStates()` - æç”»å¾Œã®çŠ¶æ…‹ä¿å­˜
- `saveCutLayerStatesBeforeSwitch()` - CUTåˆ‡æ›¿å‰ã®ä¿å­˜

---

#### 1-2. `deepCloneCutLayers()` - äºŒé‡é˜²å¾¡
**ç›®çš„**: CUTã®Layeré…åˆ—ã‚’å®Œå…¨ã«è¤‡è£½ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰

**æ”¹ä¿®å†…å®¹**:
```javascript
deepCloneCutLayers(cutLayers) {
  // âœ… ã™ã¹ã¦ã®éšå±¤ã§æ–°è¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
  // âœ… paths, pointsé…åˆ—ã‚‚æ–°è¦ä½œæˆ
  // âŒ Object.assign()ã¯ä½¿ç”¨ã—ãªã„ï¼ˆæµ…ã„ã‚³ãƒ”ãƒ¼ã«ãªã‚‹ãŸã‚ï¼‰
}
```

**ä½¿ç”¨ç®‡æ‰€**:
- `createNewCutFromCurrentLayers()` - ä½œæˆæ™‚
- `createNewBlankCut()` - ç©ºCUTä½œæˆæ™‚
- `saveCutLayerStates()` - ä¿å­˜æ™‚ï¼ˆMapç”¨ï¼‰
- `deepCopyCutData()` - ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ç”¨

---

#### 1-3. `saveCutLayerStates()` - å³æ™‚ä¿å­˜ã®å¾¹åº•
**ç›®çš„**: æç”»å¤‰æ›´ã‚’å³åº§ã«AnimationSystemã«åæ˜ 

**æ”¹ä¿®å‰ã®å•é¡Œ**:
```javascript
// âŒ LayerSystemã®layersé…åˆ—ã‚’å‚ç…§ã—ã¦ã„ãŸ
currentCut.layers = this.layerSystem.layers; // å‚ç…§ã®å…±æœ‰ï¼
```

**æ”¹ä¿®å¾Œ**:
```javascript
saveCutLayerStates() {
  const currentCut = this.getCurrentCut();
  if (!currentCut || !this.layerSystem) return;
  
  // âœ… Deep Copyã§å®Œå…¨ç‹¬ç«‹ä¿å­˜
  const currentState = this.copyCurrentLayersToIndependentState(currentCut.id);
  
  // âœ… CUTãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜ï¼ˆå‚ç…§ã§ã¯ãªãã‚³ãƒ”ãƒ¼ï¼‰
  currentCut.layers = this.deepCloneCutLayers(currentState);
  
  // âœ… Mapã«ã‚‚ä¿å­˜ï¼ˆäºŒé‡ä¿å­˜ï¼‰
  this.cutLayerStates.set(currentCut.id, this.deepCloneCutLayers(currentState));
  
  // âœ… ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  this.eventBus.emit('animation:cut-updated', { 
    cutIndex: this.animationData.playback.currentCutIndex,
    cutId: currentCut.id
  });
}
```

**å‘¼ã³å‡ºã—å…ƒ**:
- `LayerSystem.addPathToLayer()` - æç”»å®Œäº†æ™‚
- `LayerSystem.updateActiveLayerTransform()` - Transformå¤‰æ›´æ™‚
- `LayerSystem.flipActiveLayer()` - åè»¢æ™‚
- EventBus: `layer:updated`, `layer:visibility-changed`, `layer:path-added`

---

#### 1-4. `setActiveCut()` - å®Œå…¨å†æ§‹ç¯‰
**ç›®çš„**: CUTåˆ‡æ›¿æ™‚ã«LayerSystemã‚’å®Œå…¨ã«å†æ§‹ç¯‰

**æ”¹ä¿®å†…å®¹**:
```javascript
setActiveCut(cutIndex, resetTransform = false) {
  const cut = this.animationData.cuts[cutIndex];
  if (!cut || !this.layerSystem) return;
  
  // âœ… Step 1: LayerSystemã‚’å®Œå…¨ã‚¯ãƒªã‚¢
  this.clearLayerSystemLayers();
  
  // âœ… Step 2: æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ï¼ˆMapå„ªå…ˆï¼‰
  const cutLayers = this.cutLayerStates.get(cut.id) || cut.layers || [];
  
  // âœ… Step 3: å®Œå…¨å†æ§‹ç¯‰ï¼ˆæ–°ã—ã„PIXI.Containerç”Ÿæˆï¼‰
  this.rebuildLayersFromCutData(cutLayers, resetTransform);
  
  // âœ… UIæ›´æ–°
  if (this.layerSystem.updateLayerPanelUI) {
    this.layerSystem.updateLayerPanelUI();
  }
}
```

---

#### 1-5. `rebuildLayersFromCutData()` - PIXI.Containeræ–°è¦ç”Ÿæˆ
**ç›®çš„**: CUTãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å®Œå…¨ã«æ–°ã—ã„PIXIæ§‹é€ ã‚’ç”Ÿæˆ

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ**:
```javascript
rebuildLayersFromCutData(cutLayers, resetTransform) {
  cutLayers.forEach((cutLayerData, index) => {
    // âœ… æ–°ã—ã„PIXI.Containerä½œæˆ
    const layer = new PIXI.Container();
    layer.label = cutLayerData.id;
    
    // âœ… æ–°ã—ã„layerDataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆå‚ç…§ã‚’æŒãŸãªã„ï¼‰
    layer.layerData = {
      id: cutLayerData.id,
      name: cutLayerData.name,
      visible: cutLayerData.visible !== false,
      opacity: cutLayerData.opacity || 1.0,
      isBackground: cutLayerData.isBackground || false,
      paths: []  // â† ç©ºã‹ã‚‰é–‹å§‹
    };
    
    // âœ… pathså†æ§‹ç¯‰ï¼ˆæ–°ã—ã„PIXI.Graphicsç”Ÿæˆï¼‰
    if (cutLayerData.paths && Array.isArray(cutLayerData.paths)) {
      cutLayerData.paths.forEach(pathData => {
        const reconstructedPath = this.rebuildPathFromData(pathData);
        if (reconstructedPath) {
          layer.layerData.paths.push(reconstructedPath);
          layer.addChild(reconstructedPath.graphics);
        }
      });
    }
    
    this.layerSystem.layers.push(layer);
    this.layerSystem.layersContainer.addChild(layer);
  });
}
```

---

### 2. LayerSystem ã®æ”¹ä¿®

#### 2-1. `_syncLayersContainerFromAnimationSystem()` - å‰Šé™¤
**ç†ç”±**: 
- AnimationSystemã®`setActiveCut()`ãŒå®Œå…¨å†æ§‹ç¯‰ã‚’è¡Œã†ãŸã‚ä¸è¦
- äºŒé‡ç®¡ç†ã‚’é¿ã‘ã‚‹

**ä»£æ›¿**:
```javascript
// âœ… AnimationSystemã®ã‚¤ãƒ™ãƒ³ãƒˆã«å¿œç­”ã™ã‚‹ã ã‘
this.eventBus.on('animation:cut-applied', (data) => {
  setTimeout(() => {
    // AnimationSystemãŒæ—¢ã«layersã‚’å†æ§‹ç¯‰æ¸ˆã¿
    this.updateLayerPanelUI();
    this.updateStatusDisplay();
  }, 100);
});
```

---

#### 2-2. `addPathToLayer()` - å³æ™‚ä¿å­˜ã®å¾¹åº•
**ç›®çš„**: æç”»å®Œäº†æ™‚ã«å³åº§ã«AnimationSystemã¸ä¿å­˜

**æ”¹ä¿®å¾Œ**:
```javascript
addPathToLayer(layerIndex, path) {
  if (layerIndex >= 0 && layerIndex < this.layers.length) {
    const layer = this.layers[layerIndex];
    
    // âœ… LayerSystemã®layersã«è¿½åŠ 
    layer.layerData.paths.push(path);
    layer.addChild(path.graphics);
    
    this.requestThumbnailUpdate(layerIndex);
    
    // âœ… AnimationSystemã¸å³åº§ã«ä¿å­˜
    if (this.animationSystem?.saveCutLayerStates) {
      requestAnimationFrame(() => {
        this.animationSystem.saveCutLayerStates();
        
        // âœ… ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã‚‚é€£å‹•
        const currentCutIndex = this.animationSystem.getCurrentCutIndex();
        setTimeout(() => {
          this.animationSystem.generateCutThumbnailOptimized(currentCutIndex);
        }, 50);
      });
    }
    
    // âœ… ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
    if (this.eventBus) {
      this.eventBus.emit('layer:path-added', { 
        layerIndex, 
        pathId: path.id,
        layerId: layer.layerData.id
      });
    }
  }
}
```

---

#### 2-3. Transformæ“ä½œç³»ãƒ¡ã‚½ãƒƒãƒ‰ - ä¿å­˜é€£å‹•
**å¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰**:
- `updateActiveLayerTransform()`
- `flipActiveLayer()`
- `confirmLayerTransform()`

**æ”¹ä¿®å†…å®¹**:
```javascript
updateActiveLayerTransform(property, value) {
  // ... Transformé©ç”¨å‡¦ç† ...
  
  // âœ… AnimationSystemã¸å³åº§ã«é€šçŸ¥
  if (this.animationSystem?.updateCurrentCutLayer) {
    this.animationSystem.updateCurrentCutLayer(this.activeLayerIndex, {
      transform: { ...transform }
    });
  }
  
  // âœ… AnimationSystemã¸ä¿å­˜
  if (this.animationSystem?.saveCutLayerStates) {
    this.animationSystem.saveCutLayerStates();
  }
}
```

---

### 3. EventBusé€£å‹•ã®å¼·åŒ–

#### 3-1. è¿½åŠ ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ

| ã‚¤ãƒ™ãƒ³ãƒˆå | ç™ºç«ã‚¿ã‚¤ãƒŸãƒ³ã‚° | ç”¨é€” |
|-----------|---------------|------|
| `layer:path-added` | æç”»å®Œäº†æ™‚ | AnimationSystemã¸ã®ä¿å­˜ãƒˆãƒªã‚¬ãƒ¼ |
| `layer:updated` | Layerå¤‰æ›´æ™‚ | AnimationSystemã¸ã®ä¿å­˜ãƒˆãƒªã‚¬ãƒ¼ |
| `animation:cut-updated` | CUTä¿å­˜å®Œäº†æ™‚ | ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³UIæ›´æ–° |
| `animation:thumbnail-generated` | ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆå®Œäº†æ™‚ | ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³UIåæ˜  |

#### 3-2. ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼å›³
```
[æç”»å®Œäº†]
    â†“
LayerSystem.addPathToLayer()
    â†“
eventBus.emit('layer:path-added')
    â†“
AnimationSystem: saveCutLayerStates()
    â†“
eventBus.emit('animation:cut-updated')
    â†“
[ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³UIæ›´æ–°]
```

---

## ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼

### A. æç”»æ™‚ã®ãƒ•ãƒ­ãƒ¼
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæç”»
   â†“
2. DrawingEngine: pathä½œæˆ
   â†“
3. LayerSystem.addPathToActiveLayer(path)
   â†“
4. layer.layerData.paths.push(path) â† LayerSystemã«è¿½åŠ 
   â†“
5. requestAnimationFrame(() => {
     AnimationSystem.saveCutLayerStates()  â† Deep Copyä¿å­˜
   })
   â†“
6. currentCut.layers = deepCloneCutLayers(...)  â† AnimationSystemã«ä¿å­˜
   â†“
7. cutLayerStates.set(cutId, deepCloneCutLayers(...))  â† Mapä¿å­˜
   â†“
8. generateCutThumbnailOptimized(cutIndex)  â† ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
   â†“
9. eventBus.emit('animation:cut-updated')
   â†“
10. TimelineUI: ã‚µãƒ ãƒã‚¤ãƒ«åæ˜ 
```

### B. CUTåˆ‡æ›¿æ™‚ã®ãƒ•ãƒ­ãƒ¼
```
1. AnimationSystem.switchToActiveCutSafely(cutIndex)
   â†“
2. saveCutLayerStatesBeforeSwitch()  â† ç¾åœ¨CUTã‚’ä¿å­˜
   â†“
3. clearLayerSystemLayers()  â† LayerSystemã‚’å®Œå…¨ã‚¯ãƒªã‚¢
   â†“
4. cutLayers = cutLayerStates.get(newCutId)  â† æ–°CUTãƒ‡ãƒ¼ã‚¿å–å¾—
   â†“
5. rebuildLayersFromCutData(cutLayers)  â† å®Œå…¨å†æ§‹ç¯‰
   â”‚
   â”œâ”€ new PIXI.Container()  â† æ–°ã—ã„Layerä½œæˆ
   â”œâ”€ new layerData { paths: [] }  â† æ–°ã—ã„layerDataä½œæˆ
   â”œâ”€ rebuildPathFromData()  â† å„Pathã‚’å†æ§‹ç¯‰
   â”‚   â””â”€ new PIXI.Graphics()  â† æ–°ã—ã„Graphicsä½œæˆ
   â†“
6. LayerSystem.layers = [...æ–°ã—ã„Layeré…åˆ—]  â† Viewæ›´æ–°
   â†“
7. updateLayerPanelUI()  â† UIãƒ‘ãƒãƒ«æ›´æ–°
   â†“
8. eventBus.emit('animation:cut-applied')
```

### C. CUTä½œæˆæ™‚ã®ãƒ•ãƒ­ãƒ¼
```
1. AnimationSystem.createNewCutFromCurrentLayers()
   â†“
2. copyCurrentLayersToIndependentState(cutId)
   â”‚
   â”œâ”€ LayerSystemã®layersã‚’èª­ã¿å–ã‚Š
   â”œâ”€ å„Layerã‚’ãƒ«ãƒ¼ãƒ—
   â”‚   â”œâ”€ generateUniqueCutLayerId(cutId)  â† æ–°ã—ã„IDç”Ÿæˆ
   â”‚   â”œâ”€ pathsé…åˆ—ã‚’Deep Copy
   â”‚   â”‚   â””â”€ pointsé…åˆ—ã‚‚Deep Copy
   â”‚   â””â”€ transformæƒ…å ±ã‚‚ã‚³ãƒ”ãƒ¼
   â†“
3. cut.layers = independentLayers  â† ç‹¬ç«‹ãƒ‡ãƒ¼ã‚¿ä¿å­˜
   â†“
4. cutLayerStates.set(cutId, deepCloneCutLayers(independentLayers))  â† Mapä¿å­˜
   â†“
5. switchToActiveCutSafely(newCutIndex)  â† æ–°CUTã¸åˆ‡æ›¿
   â†“
6. generateCutThumbnailOptimized(newCutIndex)  â† ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
   â†“
7. eventBus.emit('animation:cut-created')
```

---

## ğŸ“š ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰è¾å…¸

### AnimationSystem

| ãƒ¡ã‚½ãƒƒãƒ‰å | è²¬å‹™ | å…¥åŠ› | å‡ºåŠ› | å‚™è€ƒ |
|-----------|------|-----|------|------|
| `copyCurrentLayersToIndependentState(cutId)` | LayerSystemã®ç¾åœ¨çŠ¶æ…‹ã‹ã‚‰CUTç‹¬ç«‹ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ | cutId: string | Array<LayerData> | Deep Copyå®Ÿè¡Œ |
| `deepCloneCutLayers(cutLayers)` | CUT Layeré…åˆ—ã®å®Œå…¨è¤‡è£½ | Array<LayerData> | Array<LayerData> | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ |
| `saveCutLayerStates()` | ç¾åœ¨CUTã®çŠ¶æ…‹ã‚’AnimationSystemã«ä¿å­˜ | ãªã— | void | æç”»å®Œäº†æ™‚ã«å‘¼ã¶ |
| `saveCutLayerStatesBeforeSwitch()` | CUTåˆ‡æ›¿å‰ã®çŠ¶æ…‹ä¿å­˜ | ãªã— | void | åˆ‡æ›¿å‰ã«å¿…ãšå‘¼ã¶ |
| `setActiveCut(cutIndex, resetTransform)` | CUTåˆ‡æ›¿ãƒ»LayerSystemå†æ§‹ç¯‰ | cutIndex: number, resetTransform: boolean | void | å®Œå…¨å†æ§‹ç¯‰ |
| `rebuildLayersFromCutData(cutLayers, resetTransform)` | CUTãƒ‡ãƒ¼ã‚¿ã‹ã‚‰PIXIæ§‹é€ ã‚’ç”Ÿæˆ | Array<LayerData>, boolean | void | æ–°è¦Containerç”Ÿæˆ |
| `rebuildPathFromData(pathData)` | Pathãƒ‡ãƒ¼ã‚¿ã‹ã‚‰PIXI.Graphicsç”Ÿæˆ | PathData | Path | æ–°è¦Graphicsç”Ÿæˆ |
| `generateCutThumbnailOptimized(cutIndex)` | CUTã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ | cutIndex: number | Promise<void> | Canvas2Dä½¿ç”¨ |
| `createNewCutFromCurrentLayers()` | ç¾åœ¨Layerã‹ã‚‰æ–°CUTä½œæˆ | ãªã— | Cut | Deep Copyä¿å­˜ |
| `createNewBlankCut()` | ç©ºCUTä½œæˆ | ãªã— | Cut | åˆæœŸLayeræ§‹é€ ç”Ÿæˆ |
| `switchToActiveCutSafely(cutIndex, resetTransform)` | å®‰å…¨ãªCUTåˆ‡æ›¿ | cutIndex: number, resetTransform: boolean | void | ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã‚ã‚Š |

### LayerSystem

| ãƒ¡ã‚½ãƒƒãƒ‰å | è²¬å‹™ | å…¥åŠ› | å‡ºåŠ› | å‚™è€ƒ |
|-----------|------|-----|------|------|
| `addPathToLayer(layerIndex, path)` | Layerã«Pathè¿½åŠ ãƒ»AnimationSystemä¿å­˜ | layerIndex: number, Path | void | å³æ™‚ä¿å­˜ |
| `addPathToActiveLayer(path)` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–Layerã«Pathè¿½åŠ  | Path | void | addPathToLayerã‚’å‘¼ã¶ |
| `updateActiveLayerTransform(property, value)` | Transformæ›´æ–°ãƒ»AnimationSystemä¿å­˜ | property: string, value: number | void | å³æ™‚ä¿å­˜ |
| `flipActiveLayer(direction)` | Layeråè»¢ãƒ»AnimationSystemä¿å­˜ | direction: 'horizontal'\|'vertical' | void | å³æ™‚ä¿å­˜ |
| `confirmLayerTransform()` | Transformç¢ºå®šãƒ»Pathã¸Bake | ãªã— | void | V Keyé›¢è„±æ™‚ |
| `updateLayerPanelUI()` | Layerãƒ‘ãƒãƒ«UIæ›´æ–° | ãªã— | void | HTMLç”Ÿæˆ |
| `updateThumbnail(layerIndex)` | Layerå€‹åˆ¥ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–° | layerIndex: number | void | Canvas2Dä½¿ç”¨ |
| `setActiveLayer(index)` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–Layerå¤‰æ›´ | index: number | void | UIæ›´æ–°é€£å‹• |
| `toggleLayerVisibility(layerIndex)` | Layerå¯è¦–æ€§ãƒˆã‚°ãƒ« | layerIndex: number | void | AnimationSystemä¿å­˜ |
| `createLayer(name, isBackground)` | æ–°Layerä½œæˆ | name: string, isBackground: boolean | {layer, index} | AnimationSystemé€šçŸ¥ |
| `deleteLayer(layerIndex)` | Layerå‰Šé™¤ | layerIndex: number | boolean | AnimationSystemä¿å­˜ |

---

## ğŸš¨ é‡è¦ãªæ³¨æ„äº‹é …

### 1. å‚ç…§ã®å…±æœ‰ã‚’çµ¶å¯¾ã«é¿ã‘ã‚‹
```javascript
// âŒ NGä¾‹
currentCut.layers = this.layerSystem.layers;  // å‚ç…§ã®å…±æœ‰ï¼

// âœ… OKä¾‹
currentCut.layers = this.deepCloneCutLayers(
  this.copyCurrentLayersToIndependentState(currentCut.id)
);
```

### 2. Deep Copyã®å¾¹åº•
```javascript
// âŒ NGä¾‹
const newLayer = { ...originalLayer };  // æµ…ã„ã‚³ãƒ”ãƒ¼ï¼ˆpathsé…åˆ—ã¯å‚ç…§ï¼‰

// âœ… OKä¾‹
const newLayer = {
  ...originalLayer,
  paths: originalLayer.paths.map(path => ({
    ...path,
    points: path.points.map(p => ({ x: p.x, y: p.y }))
  }))
};
```

### 3. ä¿å­˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°
```javascript
// âœ… æç”»å®Œäº†å¾Œã¯å¿…ãšä¿å­˜
addPathToActiveLayer(path) {
  // ... pathè¿½åŠ  ...
  
  requestAnimationFrame(() => {
    this.animationSystem.saveCutLayerStates();  // â† å¿…é ˆ
  });
}
```

### 4. CUTåˆ‡æ›¿æ™‚ã®å®Œå…¨ã‚¯ãƒªã‚¢
```javascript
// âœ… å¿…ãšå®Œå…¨ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰å†æ§‹ç¯‰
switchToActiveCutSafely(cutIndex) {
  this.saveCutLayerStatesBeforeSwitch();  // â† ç¾åœ¨CUTä¿å­˜
  this.clearLayerSystemLayers();  // â† å®Œå…¨ã‚¯ãƒªã‚¢
  this.rebuildLayersFromCutData(...);  // â† å†æ§‹ç¯‰
}
```

---

## ğŸ“Š æ”¹ä¿®å‰å¾Œã®æ¯”è¼ƒ

### å•é¡Œ1: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚µãƒ ãƒã‚¤ãƒ«åæ˜ 

| | æ”¹ä¿®å‰ | æ”¹ä¿®å¾Œ |
|---|-------|-------|
| åŸå›  | `saveCutLayerStates()`ãŒå‚ç…§ã‚’ä¿å­˜ | `deepCloneCutLayers()`ã§å®Œå…¨ç‹¬ç«‹ |
| ç—‡çŠ¶ | ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ™‚ã«ãƒ‡ãƒ¼ã‚¿ãŒç©º | å¸¸ã«æœ€æ–°çŠ¶æ…‹ã‚’åæ˜  |
| è§£æ±º | âŒ | âœ… |

### å•é¡Œ2: CUTé–“ã®Layeræ··åœ¨

| | æ”¹ä¿®å‰ | æ”¹ä¿®å¾Œ |
|---|-------|-------|
| åŸå›  | `LayerSystem.layers`ãŒå‚ç…§ã‚’ä¿æŒ | å®Œå…¨å†æ§‹ç¯‰ã§æ–°è¦Containerç”Ÿæˆ |
| ç—‡çŠ¶ | CUT1ã®æç”»ãŒCUT2ã«åæ˜  | CUTæ¯ã«å®Œå…¨ç‹¬ç«‹ |
| è§£æ±º | âŒ | âœ… |

---

## âœ… æ”¹ä¿®å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### AnimationSystem
- [ ] `copyCurrentLayersToIndependentState()`: paths/points Deep Copyç¢ºèª
- [ ] `deepCloneCutLayers()`: å…¨éšå±¤Deep Copyç¢ºèª
- [ ] `saveCutLayerStates()`: äºŒé‡Deep Copyä¿å­˜ç¢ºèª
- [ ] `setActiveCut()`: å®Œå…¨å†æ§‹ç¯‰ç¢ºèª
- [ ] `rebuildLayersFromCutData()`: æ–°è¦Containerç”Ÿæˆç¢ºèª

### LayerSystem
- [ ] `addPathToLayer()`: å³æ™‚ä¿å­˜ç¢ºèª
- [ ] `updateActiveLayerTransform()`: å³æ™‚ä¿å­˜ç¢ºèª
- [ ] `flipActiveLayer()`: å³æ™‚ä¿å­˜ç¢ºèª
- [ ] `_syncLayersContainerFromAnimationSystem()`: å‰Šé™¤ç¢ºèª

### çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] CUT1ã§æç”» â†’ CUT2ã§ç©ºç™½ â†’ CUT1ã«æˆ»ã‚‹ã¨æç”»ãŒæ®‹ã‚‹
- [ ] CUTä½œæˆæ™‚ã«ã‚µãƒ ãƒã‚¤ãƒ«å³åº§ã«åæ˜ 
- [ ] CUTåˆ‡æ›¿æ™‚ã«ã‚µãƒ ãƒã‚¤ãƒ«æ­£ã—ãè¡¨ç¤º
- [ ] Transformæ“ä½œå¾Œã«ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
- [ ] ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼/ãƒšãƒ¼ã‚¹ãƒˆã§ç‹¬ç«‹æ€§ç¶­æŒ

---

## ğŸ“ˆ ä»Šå¾Œã®æ‹¡å¼µæ€§

### ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€å®Ÿè£…æ™‚
```javascript
// ç¾åœ¨ã®æ§‹é€ ã‚’æ‹¡å¼µ
cut.layers = [
  { 
    id: 'folder_001', 
    name: 'ãƒ•ã‚©ãƒ«ãƒ€A',
    type: 'folder',  // â† è¿½åŠ 
    children: [  // â† è¿½åŠ 
      { id: 'layer_001', ... },
      { id: 'layer_002', ... }
    ]
  }
];

// ãƒ•ã‚©ãƒ«ãƒ€ã‚µãƒ ãƒã‚¤ãƒ« = å­Layeråˆæˆ
generateFolderThumbnail(folder) {
  const composite = folder.children.reduce(...);
  return composite;
}
```

### LIVE2D/SPINEã‚¢ãƒ‹ãƒ¡å®Ÿè£…æ™‚
```javascript
// Transformæƒ…å ±ã‚’æ‹¡å¼µ
layer.transform = {
  x, y, rotation, scaleX, scaleY,
  // â†“ è¿½åŠ 
  keyframes: [
    { time: 0, x: 0, y: 0 },
    { time: 0.5, x: 10, y: 20 }
  ]
};
```

---

## ğŸ¯ ã¾ã¨ã‚

### æ”¹ä¿®ã®ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
1. **AnimationSystem = å”¯ä¸€ã®çœŸå®Ÿã®æƒ…å ±æº**
2. **LayerSystem = æç”»Viewï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰**
3. **å‚ç…§ã®å…±æœ‰ã‚’å®Œå…¨æ’é™¤**
4. **Deep Copyã®å¾¹åº•**
5. **å³æ™‚ä¿å­˜ã®åŸå‰‡**

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ
âœ… CUTæ¯ã®Layerå®Œå…¨ç‹¬ç«‹æ€§  
âœ… ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«å³æ™‚åæ˜   
âœ… CUTåˆ‡æ›¿æ™‚ã®ãƒ‡ãƒ¼ã‚¿æ··åœ¨è§£æ¶ˆ  
âœ… ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§å‘ä¸Š  
âœ… å°†æ¥ã®æ©Ÿèƒ½æ‹¡å¼µã¸ã®æŸ”è»Ÿæ€§ç¢ºä¿

---

**æ”¹ä¿®æ‹…å½“AI**: Claude Sonnet 4.5  
**æ”¹ä¿®æ—¥**: 2025-09-30  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v8.13_gif_phase2_matrix