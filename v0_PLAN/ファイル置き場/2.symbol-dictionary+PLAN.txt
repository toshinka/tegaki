============================================================
ğŸ“– 1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¾å…¸ï¼ˆManager / Service / Engineï¼‰
============================================================

â–  main.html
- èµ·ç‚¹ã€‚å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–ã—ã€ä¸»æ˜Ÿ(MainController)ã¨ã—ã¦è¡›æ˜Ÿã‚’æŸã­ã‚‹ã€‚

â–  layer-manager.js
- æä¾›: createLayer, removeLayer, reorderLayer, getActiveLayer
- å½¹å‰²: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã‚’ç®¡ç†ã€‚Containerå˜ä½ã§PixiJSä¸Šã«æ§‹ç¯‰ã€‚

â–  drawing-engine.js
- æä¾›: getEngineBridge, drawTemporaryStroke, commitStroke, clearLayer, takeSnapshot
- å½¹å‰²: 
  - PixiJS.Graphics ã‚’åˆ©ç”¨ã—ãŸæç”»å°‚ç”¨ã‚¨ãƒ³ã‚¸ãƒ³ã€‚
  - Strokeã‚’ãƒ™ã‚¯ã‚¿ãƒ¼ã§ä¿æŒã€å¤‰å½¢ãƒ»æ‹¡ç¸®ã«è€ãˆã‚‰ã‚Œã‚‹ã€‚
  - Eraserã¯ blendMode=ERASE ã¾ãŸã¯ Mask/å‰Šé™¤æ–¹å¼ã§å®Ÿè£…ã€‚

â–  position-manager.js
- æä¾›: setCamera, moveCamera, zoomCamera, getWorldPosition
- å½¹å‰²: ã‚«ãƒ¡ãƒ©ï¼ˆstage.position, stage.scaleï¼‰åˆ¶å¾¡ã€‚
  - ç„¡é™ã‚­ãƒ£ãƒ³ãƒã‚¹åŒ–ã‚’å¯èƒ½ã«ã™ã‚‹ã€‚
  - ãƒã‚¦ã‚¹ã‚„ã‚¿ãƒƒãƒåº§æ¨™ã‚’ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã«å¤‰æ›ã€‚

â–  ui-manager.js
- æä¾›: togglePopup, updateToolbar, bindUIEvents
- å½¹å‰²: UIåˆ¶å¾¡ã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—/ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãŒå£Šã‚Œãªã„ã‚ˆã†è²¬ä»»ã‚’æŒã¤ã€‚

â–  history-service.js
- æä¾›: record, undo, redo, clear
- å½¹å‰²: Strokeå˜ä½ã§éç ´å£Šå±¥æ­´ã‚’ç®¡ç†ã€‚
  - è¨˜éŒ²å†…å®¹ã¯ã€Œ{type: stroke, layerId, pathPoints, style}ã€å½¢å¼ã€‚
  - Undoæ™‚ã¯ Graphics ã‚’ removeChild ã—ã¦å¾©å…ƒã€‚

============================================================
ğŸ“– 2. ãƒ•ãƒ­ãƒ¼è¾å…¸ï¼ˆä¸»è¦ãªå‹•ä½œï¼‰
============================================================

â–  ãƒšãƒ³æç”»ãƒ•ãƒ­ãƒ¼
1. ToolManager â†’ DrawingEngine.drawTemporaryStroke(layerId, points, style)
2. UIã§ penUp â†’ DrawingEngine.commitStroke(layerId, strokeData)
3. HistoryService.record(strokeData)

â–  æ¶ˆã—ã‚´ãƒ ãƒ•ãƒ­ãƒ¼
1. ToolManager(eraser) â†’ DrawingEngine.drawTemporaryStroke(layerId, points, {tool: 'eraser'})
   - Graphics.blendMode = ERASE
2. commitæ™‚ã‚‚åŒæ§˜ã« strokeData ã‚’ History ã«è¨˜éŒ²

â–  ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œãƒ•ãƒ­ãƒ¼
1. UI â†’ LayerManager.reorderLayer(...)
2. LayerManager â†’ WorldContainer å†…ã® childIndex ã‚’æ›´æ–°
3. HistoryService.record({type: layerReorder,...})

â–  ã‚«ãƒ¡ãƒ©æ“ä½œãƒ•ãƒ­ãƒ¼ï¼ˆSpace + Drag / Wheelï¼‰
1. PositionManager.moveCamera(dx,dy) â†’ stage.position å¤‰æ›´
2. PositionManager.zoomCamera(scale,center) â†’ stage.scale ã‚»ãƒƒãƒˆ
3. DrawingEngine.getWorldPosition(localX,localY) ã§åº§æ¨™å¤‰æ›

============================================================
ğŸ“– 3. æ”¹ä¿®è¨ˆç”»ï¼ˆCanvas2Dæ’¤å»ƒï¼‰
============================================================

ç¾çŠ¶å•é¡Œ:
- ä¸€éƒ¨ãƒ•ãƒ­ãƒ¼ã« CanvasRenderingContext2D ãŒæ®‹å­˜
- erase ãŒã€Œç™½ã§ä¸Šæ›¸ãã€â†’ãƒšãƒ³ã¨åŒã˜æŒ™å‹•ã«ãªã‚‹
- å±¥æ­´ãŒãƒ©ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¾å­˜ â†’ éç ´å£ŠUndoãŒã§ããªã„

æ”¹ä¿®æŒ‡é‡:
1. **å…¨æç”»APIã‚’ PixiJS.Graphics ã«çµ±ä¸€**
   - ctx.moveTo/lineTo/stroke â†’ graphics.moveTo/lineTo/stroke({color,...})
   - fillStyle = 'white' æ–¹å¼å‰Šé™¤
2. **æ¶ˆã—ã‚´ãƒ ã‚’ PixiJS ãƒã‚¤ãƒ†ã‚£ãƒ–ã«**
   - åŸºæœ¬: graphics.blendMode = PIXI.BLEND_MODES.ERASE
   - äº’æ›æ€§ç¢ºä¿: ãƒã‚¹ã‚¯æ–¹å¼ fallback
3. **å±¥æ­´ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒ‘ã‚¹æƒ…å ±ãƒ™ãƒ¼ã‚¹ã«**
   - strokeData = {points: [...], style: {...}, layerId}
   - record/undo/redo ã¯ container.children ã®è¿½åŠ ãƒ»å‰Šé™¤ã§å®Œçµ
4. **PositionManagerã‚’ã‚«ãƒ¡ãƒ©åˆ¶å¾¡å°‚ç”¨ã«**
   - worldåº§æ¨™ç³»ã‚’æ˜ç¢ºã«åˆ†é›¢ã—ã€UIã‚„ãƒ„ãƒ¼ãƒ«ãŒåº§æ¨™æ··ä¹±ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
5. **UIæ”¹ä¿®æ™‚ã®æ³¨æ„ç‚¹**
   - rev4ã®UIå®Ÿè£…ã‚’å´©ã•ãªã„
   - PopupæŒ™å‹•ãƒ»Toolbarã‚¤ãƒ™ãƒ³ãƒˆã‚’DrawingEngineã«æ··ãœãªã„
   - UIManagerå°‚è²¬

============================================================
ğŸ“– 4. é‹ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆè¡›æ˜Ÿãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
============================================================

å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†’é ­ã«å¿…é ˆãƒ˜ãƒƒãƒ€ãƒ¼:
- @module åå‰
- @role è²¬å‹™
- @depends ä»–ã«ä¾å­˜ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- @provides å¤–éƒ¨ã«å…¬é–‹ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§
- @notes è¨­è¨ˆä¸Šã®æ³¨æ„ç‚¹

ä¾‹: drawing-engine.js
/**
 * @module DrawingEngine
 * @role PixiJSãƒ™ã‚¯ã‚¿ãƒ¼æç”»ã‚¨ãƒ³ã‚¸ãƒ³
 * @depends MainController, LayerManager
 * @provides getEngineBridge, drawTemporaryStroke, commitStroke, takeSnapshot
 * @notes Canvas2Dç¦æ­¢ / UIãƒ­ã‚¸ãƒƒã‚¯ã‚’æ··ãœãªã„ã“ã¨
 */

============================================================
ğŸ“– 5. ä»Šå¾Œã®å±•æœ›
============================================================
- WebGPUå¯¾å¿œã®PixiJS v9ãŒå®‰å®šã—ãŸã‚‰Rendererå·®ã—æ›¿ãˆã§æ€§èƒ½å‘ä¸Š
- ãƒ™ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®JSONå…¥å‡ºåŠ›ï¼ˆä¿å­˜ãƒ»èª­ã¿è¾¼ã¿æ©Ÿèƒ½ï¼‰ã‚‚å®¹æ˜“ã«ãªã‚‹



ğŸ“˜ drawing-engine.jsï¼ˆæ”¹ä¿®å¾Œã‚µãƒ³ãƒ—ãƒ«ï¼‰

/**
 * ==========================================================
 * @module DrawingEngine
 * @role   PixiJSãƒ™ã‚¯ã‚¿ãƒ¼æç”»ã‚¨ãƒ³ã‚¸ãƒ³ãƒ»EngineBridgeæä¾›ãƒ»æç”»å‡¦ç†ç®¡ç†
 * @depends MainController, LayerService
 * @provides
 *   - getEngineBridge()
 *   - drawTemporaryStroke(layerId, strokePoints, style)
 *   - commitStroke(layerId, strokeData)
 *   - clearLayer(layerId)
 *   - takeSnapshot(layerId)
 * @notes
 *   - Canvas2Då®Œå…¨æ’é™¤ã€‚PixiJS.Graphicså°‚ç”¨ã€‚
 *   - Eraserã¯ blendMode=ERASE ã‚’åˆ©ç”¨ã€‚fallbackä¸è¦ã€‚
 *   - UIãƒ­ã‚¸ãƒƒã‚¯ã¯æŒãŸãªã„ï¼ˆUIManagerå°‚è²¬ï¼‰ã€‚
 * ==========================================================
 */

window.MyApp = window.MyApp || {};
(function(global) {

  class DrawingEngine {
    constructor() {
      this.name = "DrawingEngine";
      this.mainApi = null;
      this.app = null;
      this.containers = { world: null, ui: null };
      this._layers = {}; // {layerId: {container, graphicsList}}
      this._initialized = false;
      this.engineBridge = null;
    }

    register(mainApi) {
      this.mainApi = mainApi;
      this._createPixiApp();
      return true;
    }

    _createPixiApp() {
      const container = document.getElementById("drawing-canvas");
      if (!container) {
        this._notifyFatal("NO_CANVAS_CONTAINER", "Canvas container not found");
        return;
      }

      try {
        this.app = new PIXI.Application();
        this.app
          .init({
            width: 800,
            height: 600,
            backgroundColor: 0xf0e0d6,
            backgroundAlpha: 1,
            antialias: true,
            resolution: 1,
          })
          .then(() => {
            container.appendChild(this.app.canvas);
            this._setupContainers();
            this._createEngineBridge();
            this._initialized = true;
          });
      } catch (err) {
        this._notifyFatal("PIXI_INIT_FAIL", err.message);
      }
    }

    _setupContainers() {
      this.containers.world = new PIXI.Container();
      this.containers.ui = new PIXI.Container();
      this.app.stage.addChild(this.containers.world);
      this.app.stage.addChild(this.containers.ui);
    }

    _createEngineBridge() {
      this.engineBridge = {
        app: this.app,
        drawTemporaryStroke: (layerId, strokePoints, style) =>
          this._drawTempStroke(layerId, strokePoints, style),
        commitStroke: (layerId, strokeData) =>
          this._commitStroke(layerId, strokeData),
        clearLayer: (layerId) => this._clearLayer(layerId),
        takeSnapshot: (layerId) => this._takeSnapshot(layerId),
      };
      global.MyApp.DrawingEngineInstance = this;
    }

    getEngineBridge() {
      return this.engineBridge;
    }

    ensureLayerContainer(layerId) {
      if (!this._layers[layerId]) {
        const container = new PIXI.Container();
        container.name = `layer-${layerId}`;
        this.containers.world.addChild(container);
        this._layers[layerId] = { container, graphicsList: [] };
      }
      return this._layers[layerId].container;
    }

    _drawTempStroke(layerId, strokePoints, style = {}) {
      if (!this._initialized) return null;
      if (!strokePoints || strokePoints.length === 0) return null;

      const container = this.ensureLayerContainer(layerId);
      const graphics = new PIXI.Graphics();

      const size = style.size || 4;
      const color = style.color ?? 0x800000;
      const alpha = style.alpha ?? 1;

      graphics.blendMode =
        style.tool === "eraser"
          ? PIXI.BLEND_MODES.ERASE
          : PIXI.BLEND_MODES.NORMAL;

      graphics.moveTo(strokePoints[0].x, strokePoints[0].y);
      for (let i = 1; i < strokePoints.length; i++) {
        graphics.lineTo(strokePoints[i].x, strokePoints[i].y);
      }

      graphics.stroke({ width: size, color, alpha });

      container.addChild(graphics);
      this._layers[layerId].graphicsList.push(graphics);

      return graphics;
    }

    _commitStroke(layerId, strokeData) {
      if (!this._initialized) return false;
      if (!strokeData || !strokeData.points) return false;

      const container = this.ensureLayerContainer(layerId);
      const graphics = new PIXI.Graphics();

      const style = strokeData.style || {};
      const size = style.size || 4;
      const color = style.color ?? 0x800000;
      const alpha = style.alpha ?? 1;

      graphics.blendMode =
        style.tool === "eraser"
          ? PIXI.BLEND_MODES.ERASE
          : PIXI.BLEND_MODES.NORMAL;

      const points = strokeData.points;
      graphics.moveTo(points[0].x, points[0].y);
      for (let i = 1; i < points.length; i++) {
        graphics.lineTo(points[i].x, points[i].y);
      }
      graphics.stroke({ width: size, color, alpha });

      container.addChild(graphics);
      this._layers[layerId].graphicsList.push(graphics);

      return true;
    }

    _clearLayer(layerId) {
      const layerData = this._layers[layerId];
      if (layerData && layerData.container) {
        layerData.container.removeChildren();
        layerData.graphicsList = [];
      }
    }

    _takeSnapshot(layerId) {
      const layerData = this._layers[layerId];
      return {
        layerId,
        childCount: layerData?.container?.children.length || 0,
        timestamp: Date.now(),
      };
    }

    resize(width, height) {
      if (this.app && this._initialized) {
        try {
          this.app.renderer.resize(width, height);
          return true;
        } catch (err) {
          this._notifyRecoverable("RESIZE_FAIL", err.message);
        }
      }
      return false;
    }

    destroy() {
      if (this.app) {
        this.app.destroy(true);
      }
      this.mainApi = null;
      this.app = null;
      this.containers = { world: null, ui: null };
      this._layers = {};
    }

    _notifyFatal(code, msg) {
      this.mainApi?.notify({
        type: "error.fatal",
        payload: { code, msg },
      });
    }

    _notifyRecoverable(code, msg) {
      this.mainApi?.notify({
        type: "error.recoverable",
        payload: { code, msg },
      });
    }
  }

  global.MyApp.DrawingEngine = DrawingEngine;

})(window);

âœ… ã“ã®æ”¹ä¿®ã§ã®ãƒã‚¤ãƒ³ãƒˆ

Canvas2D APIå®Œå…¨å‰Šé™¤ â†’ PixiJS.Graphics ã®ã¿ä½¿ç”¨

EraserãŒãƒšãƒ³æ‰±ã„ã«ãªã‚‹å•é¡Œã‚’ä¿®æ­£

style.tool === "eraser" ãªã‚‰ blendMode = ERASE ã‚’å¼·åˆ¶

å±¥æ­´ï¼ˆHistoryServiceï¼‰ã¯ strokeData ã‚’ä¿æŒã™ã‚Œã°éç ´å£ŠUndoå¯¾å¿œå¯èƒ½

UIã‚„Toolbarå‡¦ç†ã‚’ DrawingEngine ã«æ··ãœãªã„ â†’ ui-manager.js ã«ä»»ã›ã‚‹


ğŸ“˜ æ”¹ä¿®å¾Œ history-service.js

/**
 * ==========================================================
 * @module HistoryService
 * @role   æç”»æ“ä½œã®éç ´å£Šçš„è¨˜éŒ²ã¨Undo/Redoç®¡ç†
 * @depends DrawingEngine
 * @provides
 *   - recordStroke(layerId, strokeData)
 *   - undo()
 *   - redo()
 *   - clear()
 *   - getHistoryState()
 * @notes
 *   - strokeData ã¯ { points:[], style:{} } ã®ç´”ç²‹ãƒ‡ãƒ¼ã‚¿ã€‚
 *   - Eraserã¯ style.tool="eraser" ã¨ã—ã¦ä¿æŒã—ã€å†æç”»æ™‚ã« blendMode=ERASE ã‚’é©ç”¨ã€‚
 *   - æç”»è‡ªä½“ã¯ DrawingEngine ã«å§”è­²ã€‚HistoryServiceã¯ãƒ‡ãƒ¼ã‚¿ã®ã¿ä¿æŒã€‚
 * ==========================================================
 */

window.MyApp = window.MyApp || {};
(function(global) {
  class HistoryService {
    constructor(engineBridge) {
      this.name = "HistoryService";
      this.engineBridge = engineBridge;
      this.undoStack = [];
      this.redoStack = [];
      this.maxHistory = 100;
    }

    recordStroke(layerId, strokeData) {
      if (!strokeData || !strokeData.points) return;

      this.undoStack.push({ layerId, strokeData });
      if (this.undoStack.length > this.maxHistory) {
        this.undoStack.shift();
      }
      this.redoStack = [];
    }

    undo() {
      if (this.undoStack.length === 0) return;

      const last = this.undoStack.pop();
      this.redoStack.push(last);
      this._rebuildLayers();
    }

    redo() {
      if (this.redoStack.length === 0) return;

      const redoAction = this.redoStack.pop();
      this.undoStack.push(redoAction);
      this._rebuildLayers();
    }

    clear() {
      this.undoStack = [];
      this.redoStack = [];
      this._rebuildLayers();
    }

    _rebuildLayers() {
      // å±¥æ­´ã‚’ãƒªãƒ—ãƒ¬ã‚¤ã—ã¦å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å†æç”»
      const all = [...this.undoStack];
      const layers = [...new Set(all.map(a => a.layerId))];

      layers.forEach(layerId => {
        this.engineBridge.clearLayer(layerId);
      });

      all.forEach(action => {
        this.engineBridge.commitStroke(action.layerId, action.strokeData);
      });
    }

    getHistoryState() {
      return {
        undoCount: this.undoStack.length,
        redoCount: this.redoStack.length,
        max: this.maxHistory,
      };
    }
  }

  global.MyApp.HistoryService = HistoryService;
})(window);

ğŸ“˜ ä½¿ç”¨ä¾‹ï¼ˆmain.html ãªã©ã§ã®çµ±åˆï¼‰

// DrawingEngineåˆæœŸåŒ–
const engine = new MyApp.DrawingEngine();
engine.register({
  notify: (msg) => console.log("Notify:", msg),
});

// DrawingEngineãŒå†…éƒ¨ã§PixiJSèµ·å‹•å¾Œã«Bridgeã‚’å–å¾—
setTimeout(() => {
  const bridge = engine.getEngineBridge();
  const history = new MyApp.HistoryService(bridge);

  // --- ãƒšãƒ³ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚’è¨˜éŒ² ---
  const stroke1 = {
    points: [{x:10,y:10},{x:100,y:100}],
    style: { tool: "pen", size: 5, color: 0x0000ff, alpha: 1 }
  };
  bridge.commitStroke("layer1", stroke1);
  history.recordStroke("layer1", stroke1);

  // --- æ¶ˆã—ã‚´ãƒ ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚’è¨˜éŒ² ---
  const stroke2 = {
    points: [{x:50,y:50},{x:120,y:120}],
    style: { tool: "eraser", size: 20 }
  };
  bridge.commitStroke("layer1", stroke2);
  history.recordStroke("layer1", stroke2);

  // --- Undo/Redoãƒ†ã‚¹ãƒˆ ---
  setTimeout(() => {
    console.log("UNDO");
    history.undo();

    setTimeout(() => {
      console.log("REDO");
      history.redo();
    }, 2000);
  }, 2000);

}, 1000);


âœ… ã“ã®è¨­è¨ˆã®ãƒ¡ãƒªãƒƒãƒˆ

éç ´å£ŠUndo/Redo
â†’ æç”»ã¯å…¨ã¦ã€Œãƒ‡ãƒ¼ã‚¿ã®ãƒªãƒ—ãƒ¬ã‚¤ã€ã§å†ç¾ã€‚Canvasã‚’ç ´å£Šçš„ã«æˆ»ã™å¿…è¦ãªã—ã€‚

Eraserã¯PixiJS.BLEND_MODES.ERASEã§å†ç¾
â†’ è¨˜éŒ²æ™‚ã« tool="eraser" ã‚’æŒãŸã›ã‚Œã°æ­£ã—ãå†æç”»ã•ã‚Œã‚‹ã€‚

æç”»ãƒ»å±¥æ­´ã®è²¬å‹™åˆ†é›¢

DrawingEngine = å®Ÿæç”»

HistoryService = ãƒ‡ãƒ¼ã‚¿ä¿æŒã¨ãƒªãƒ—ãƒ¬ã‚¤

ğŸ“˜ shortcut-manager.jsï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰


