# バグ修正改修計画書 v8.13_SatellitePlan_phase1e7

## 🚨 確認された問題

### 1. Spaceキー操作が機能しない
- **問題**: Space+ドラッグ（方向キー）によるキャンバス移動や回転縮小ができない
- **症状**: Spaceキーを押しても`spacePressed`フラグが正しく更新されていない

### 2. レイヤー変形確定時に絵が消失する
- **問題**: V+回転/縮小操作後、再度Vを押して確定すると描画が消える
- **症状**: 変形確定処理での座標変換計算エラーにより、パスデータが無効になる

## 🔍 根本原因分析

### 原因1: CameraSystem内のキーボードイベント処理の不完全性

**問題箇所**: `camera-system.js` 
```javascript
// 問題のコード
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
        this.spacePressed = true;
        this.updateCursor();
        e.preventDefault(); // ← ここで処理が止まっている
    }
    // ...他の処理が実行されない場合がある
});
```

**根本原因**:
- `e.preventDefault()`が早すぎる段階で呼ばれ、他のキー処理に影響
- `keyup`イベントで`spacePressed`が正しくリセットされない場合がある
- `shiftPressed`の状態管理が不安定

### 原因2: LayerSystem内の変形行列計算エラー

**問題箇所**: `layer-system.js`の`createTransformMatrix`と`safeApplyTransformToPaths`
```javascript
createTransformMatrix(transform, centerX, centerY) {
    const matrix = new PIXI.Matrix();
    
    matrix.translate(centerX + transform.x, centerY + transform.y);
    matrix.rotate(transform.rotation);
    matrix.scale(transform.scaleX, transform.scaleY);
    matrix.translate(-centerX, -centerY); // ← 変形順序が間違っている
    
    return matrix;
}
```

**根本原因**:
- 変形行列の適用順序が正しくない（PixiJS標準と異なる）
- 基準点（pivot）の計算が不正確
- スケール値が負値の場合の処理が不完全

## 🛠️ 修正方針

### 修正1: キーボードイベント処理の安定化

1. **キー状態管理の改良**:
   - `spacePressed`/`shiftPressed`の状態管理を独立させる
   - `keydown`/`keyup`のペア処理を確実にする
   - `preventDefault()`の呼び出しタイミングを最適化

2. **イベント処理順序の整理**:
   - キー状態更新を最優先にする
   - 条件判定を簡潔にし、処理の抜け穴を塞ぐ

### 修正2: レイヤー変形行列の正確な実装

1. **変形行列の順序修正**:
   ```javascript
   // 正しい順序（PixiJS標準）
   matrix.translate(-centerX, -centerY);    // 1. 基準点を原点に
   matrix.scale(scaleX, scaleY);            // 2. スケール
   matrix.rotate(rotation);                 // 3. 回転
   matrix.translate(centerX + x, centerY + y); // 4. 位置移動
   ```

2. **座標変換の安全性向上**:
   - 無限大・NaN値のチェック強化
   - 変形前後の座標検証
   - エラー時のフォールバック処理

3. **基準点計算の正確化**:
   - レイヤー変形時の`pivot`設定を統一
   - `position`と`pivot`の相互関係を正しく管理

## 📋 修正タスク

### Phase 1: CameraSystem修正
- [ ] キー状態管理ロジックの改良
- [ ] `_setupKeyboardEvents`の処理順序最適化
- [ ] マウスイベントとキーイベントの競合解消
- [ ] カーソル更新タイミングの調整

### Phase 2: LayerSystem修正  
- [ ] `createTransformMatrix`の変形順序修正
- [ ] `safeApplyTransformToPaths`の座標検証強化
- [ ] `updateActiveLayerTransform`の基準点計算修正
- [ ] レイヤー確定処理の安全性向上

### Phase 3: 統合テスト対応
- [ ] CameraSystemとLayerSystemの相互作用確認
- [ ] イベント競合の解消
- [ ] パフォーマンス最適化

## 🎯 期待される修正効果

### 修正後の動作
1. **Spaceキー操作の正常化**:
   - Space+ドラッグでキャンバス移動が正常に動作
   - Space+Shift+ドラッグで回転・縮小が正常に動作
   - キー状態が正確に管理される

2. **レイヤー変形の安定化**:
   - V+回転/縮小操作が正常に動作
   - 再度V押下での確定時に絵が消失しない
   - 変形前後で描画内容が保持される

3. **システム全体の安定性向上**:
   - キーイベント処理の競合がなくなる
   - 座標変換計算が正確になる
   - エラー時の復旧機能が向上する

## ⚠️ 注意事項

### 破壊的変更の可能性
- 変形行列の計算順序変更により、既存の変形状態に影響する可能性
- キーイベント処理の変更により、他のショートカット機能に影響する可能性

### テスト必須項目
1. **基本操作テスト**:
   - Space+各種操作の動作確認
   - V+各種操作の動作確認
   - キー競合状況での動作確認

2. **変形処理テスト**:
   - 単純移動・回転・縮小の確認
   - 複合変形（移動+回転+縮小）の確認
   - 変形確定後の描画内容確認

3. **エッジケーステスト**:
   - 極端なスケール値での動作
   - 高速キー操作での状態管理
   - 連続変形操作の安定性

## 📅 実装スケジュール

### Phase 1: 緊急修正（即座）
- CameraSystemのキー処理修正
- LayerSystemの変形行列修正

### Phase 2: 安定化（次回）  
- エラーハンドリング強化
- パフォーマンス最適化

### Phase 3: 拡張対応（将来）
- より複雑な変形処理への対応
- アニメーション機能への拡張

## 🚀 修正完了後の品質向上

- **ユーザビリティ**: 基本操作が確実に動作する
- **安定性**: エラー時でも画像データが失われない  
- **拡張性**: 将来のアニメーション機能追加が容易
- **保守性**: 明確な変形ロジックでデバッグが簡単