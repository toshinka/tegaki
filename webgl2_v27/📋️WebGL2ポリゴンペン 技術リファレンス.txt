# WebGL2ãƒãƒªã‚´ãƒ³ãƒšãƒ³ æŠ€è¡“ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ v26

**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** webgl2_v26  
**æœ€çµ‚æ›´æ–°:** 2025-01-XX  
**çŠ¶æ…‹:** âœ… æ­£å¸¸ç¨¼åƒä¸­

---

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼:** WebGL2ï¼ˆå¿…é ˆï¼‰ã€PixiJS v8.14ï¼ˆUIå±¤ã®ã¿ï¼‰
- **ãƒšãƒ³æ–¹å¼:** Perfect Freehand â†’ Earcutä¸‰è§’å½¢åˆ†å‰² â†’ MSDFè·é›¢å ´
- **åº§æ¨™ç³»:** Screen â†’ Canvas â†’ World â†’ Localï¼ˆå³æ ¼åˆ†é›¢ï¼‰
- **çŠ¶æ…‹ç®¡ç†:** EventBusä¸­å¿ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°

### ç¦æ­¢äº‹é …
ğŸš« Canvas2Dä½¿ç”¨  
ğŸš« Pixi.Graphicsä½¿ç”¨ï¼ˆCPUãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚ºï¼‰  
ğŸš« localStorage/sessionStorageï¼ˆArtifactsåˆ¶ç´„ï¼‰  
ğŸš« åº§æ¨™ã®äºŒé‡å¤‰æ›  
ğŸš« Pixi.toLocal()/toGlobal()ã®ä½¿ç”¨

---

## 2. ãƒ•ã‚¡ã‚¤ãƒ«ä¾å­˜é–¢ä¿‚ãƒãƒƒãƒ—

### ğŸ“ ã‚³ã‚¢åˆæœŸåŒ–ï¼ˆãƒ­ãƒ¼ãƒ‰é †ï¼‰

```
index.html
â”œâ”€ config.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šï¼ˆä¾å­˜ãªã—ï¼‰
â”œâ”€ coordinate-system.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
â”‚  â””â”€ ä¾å­˜: event-bus.js
â”œâ”€ system/event-bus.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ï¼ˆä¾å­˜ãªã—ï¼‰
â”œâ”€ system/camera-system.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· worldContainerã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³
â”‚  â””â”€ ä¾å­˜: event-bus.js
â””â”€ core-initializer.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· åˆæœŸåŒ–åˆ¶å¾¡
   â”œâ”€ ä¾å­˜: å…¨ã‚·ã‚¹ãƒ†ãƒ 
   â””â”€ CoordinateSystem.initialize() ã‚’ CoreEngineåˆæœŸåŒ–å¾Œã«å®Ÿè¡Œ
```

### ğŸ“ WebGL2æç”»ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```
system/drawing/webgl2/
â”œâ”€ webgl2-drawing-layer.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· WebGL2ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†
â”‚  â”œâ”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«: window.WebGLContextï¼ˆä¸»è¦ï¼‰
â”‚  â”œâ”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«: window.WebGL2DrawingLayerï¼ˆäº’æ›ï¼‰
â”‚  â”œâ”€ ãƒ¡ã‚½ãƒƒãƒ‰: getGL(), createFBO(), createProgram()
â”‚  â””â”€ ä¾å­˜: ãªã—ï¼ˆWebGL2 APIç›´æ¥ï¼‰
â”‚
â”œâ”€ gl-stroke-processor.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· ãƒãƒªã‚´ãƒ³ç”Ÿæˆãƒ»GPUè»¢é€
â”‚  â”œâ”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«: window.glStrokeProcessor
â”‚  â”œâ”€ ãƒ¡ã‚½ãƒƒãƒ‰: createPolygonVertexBuffer(), uploadToGPU()
â”‚  â””â”€ ä¾å­˜: perfect-freehand, earcut-triangulator.js, webgl2-drawing-layer.js
â”‚
â”œâ”€ gl-msdf-pipeline.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· MSDFè·é›¢å ´ç”Ÿæˆï¼ˆJFAï¼‰
â”‚  â”œâ”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«: window.glMSDFPipeline
â”‚  â”œâ”€ ãƒ¡ã‚½ãƒƒãƒ‰: generateMSDF(), seedInitPass(), jfaPass()
â”‚  â””â”€ ä¾å­˜: webgl2-drawing-layer.js, gl-stroke-processor.js
â”‚
â”œâ”€ gl-texture-bridge.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· WebGLTexture â†’ PIXI.Spriteå¤‰æ›
â”‚  â”œâ”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«: window.glTextureBridge
â”‚  â”œâ”€ ãƒ¡ã‚½ãƒƒãƒ‰: createSpriteFromGLTexture()
â”‚  â””â”€ ä¾å­˜: webgl2-drawing-layer.js, PixiJS v8
â”‚
â””â”€ gl-mask-layer.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· æ¶ˆã—ã‚´ãƒ ãƒã‚¹ã‚¯å‡¦ç†
   â”œâ”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«: window.glMaskLayer
   â”œâ”€ ãƒ¡ã‚½ãƒƒãƒ‰: renderCircleMask(), composeMask()
   â””â”€ ä¾å­˜: webgl2-drawing-layer.js
```

### ğŸ“ æç”»çµ±åˆå±¤

```
system/drawing/
â”œâ”€ pointer-handler.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· PointerEventæ­£è¦åŒ–
â”‚  â””â”€ ä¾å­˜: ãªã—
â”‚
â”œâ”€ pressure-handler.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· ç­†åœ§è¨ˆç®—
â”‚  â””â”€ ä¾å­˜: ãªã—
â”‚
â”œâ”€ stroke-recorder.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· Localåº§æ¨™è¨˜éŒ²å°‚ç”¨
â”‚  â”œâ”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«: window.strokeRecorder
â”‚  â”œâ”€ ãƒ¡ã‚½ãƒƒãƒ‰: startStroke(), addPoint(), getRawPoints()
â”‚  â””â”€ ä¾å­˜: ãªã—ï¼ˆåº§æ¨™å¤‰æ›ä¸€åˆ‡ãªã—ï¼‰
â”‚
â”œâ”€ brush-core.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å‡¦ç†çµ±åˆ
â”‚  â”œâ”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«: window.brushCore
â”‚  â”œâ”€ ãƒ¡ã‚½ãƒƒãƒ‰: startStroke(), updateStroke(), renderPreview()
â”‚  â””â”€ ä¾å­˜: stroke-recorder, gl-stroke-processor, gl-msdf-pipeline,
â”‚            gl-texture-bridge, gl-mask-layer, layer-system, history
â”‚
â””â”€ drawing-engine.js Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· PointerEventå—ä¿¡ãƒ»åº§æ¨™å¤‰æ›å®Ÿè¡Œ
   â”œâ”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«: window.drawingEngine
   â”œâ”€ ãƒ¡ã‚½ãƒƒãƒ‰: _handlePointerDown(), _transformPointerToLocal()
   â””â”€ ä¾å­˜: coordinate-system, camera-system, layer-system,
            brush-core, pointer-handler, pressure-handler
```

---

## 3. åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### åº§æ¨™ç³»ã®å®šç¾©

| åº§æ¨™ç³» | åŸºæº– | ç”¨é€” |
|--------|------|------|
| **Screen** | ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ | PointerEvent.clientX/Y |
| **Canvas** | WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹ | DPIè£œæ­£å¾Œ |
| **World** | worldContainer | ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³é©ç”¨å‰ |
| **Local** | activeLayer | ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢é©ç”¨å‰ |
| **ç›¸å¯¾** | bounds | WebGL2é ‚ç‚¹åº§æ¨™ [0, w/h] |

### å¤‰æ›ãƒ•ãƒ­ãƒ¼ï¼ˆdrawing-engine.jsï¼‰

```javascript
// 1. Screen â†’ Canvasï¼ˆDPIè£œæ­£ï¼‰
const {canvasX, canvasY} = CoordinateSystem.screenClientToCanvas(clientX, clientY);

// 2. Canvas â†’ Worldï¼ˆworldContaineré€†è¡Œåˆ—ï¼‰
const {worldX, worldY} = CoordinateSystem.canvasToWorld(canvasX, canvasY);

// 3. World â†’ Localï¼ˆè¦ªãƒã‚§ãƒ¼ãƒ³é¡åŠï¼‰
const {localX, localY} = CoordinateSystem.worldToLocal(worldX, worldY, activeLayer);

// 4. BrushCoreã¸å§”è¨—
brushCore.startStroke(localX, localY, pressure);
```

### âš ï¸ é‡è¦åŸå‰‡

1. **åº§æ¨™å¤‰æ›ã¯ drawing-engine ã§å®Œçµ**  
   stroke-recorder ã¯å—ã‘å–ã£ãŸåº§æ¨™ã‚’ãã®ã¾ã¾ä¿å­˜

2. **worldContainer.updateTransform() å¿…é ˆ**  
   CoordinateSystem.canvasToWorld() å†…ã§æ˜ç¤ºçš„ã«å‘¼ã³å‡ºã—

3. **Pixiåº§æ¨™APIã¯ä½¿ç”¨ç¦æ­¢**  
   toLocal()/toGlobal() ã¯ worldContainer.position ãŒæ··å…¥ã—NaNç™ºç”Ÿ

4. **NaNæ¤œå‡ºå¿…é ˆ**  
   å„å¤‰æ›ã‚¹ãƒ†ãƒƒãƒ—ã§ `isNaN(x) || isNaN(y)` ãƒã‚§ãƒƒã‚¯

---

## 4. WebGL2æç”»ãƒ•ãƒ­ãƒ¼

### ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”»ï¼ˆbrush-core.jsï¼‰

```
1. startStroke(localX, localY, pressure)
   â””â”€ strokeRecorder.startStroke(localX, localY, pressure)

2. updateStroke(localX, localY, pressure) Ã—N
   â””â”€ strokeRecorder.addPoint(localX, localY, pressure)

3. renderPreview() [throttle 100ms]
   â””â”€ _updatePreview(strokeRecorder.getRawPoints())
      â”œâ”€ glStrokeProcessor.createPolygonVertexBuffer(points, size)
      â”‚  â”œâ”€ PerfectFreehandå®Ÿè¡Œ â†’ outlinePoints
      â”‚  â”œâ”€ boundsè¨ˆç®—: {minX, minY, maxX, maxY, width, height}
      â”‚  â”œâ”€ åº§æ¨™å¤‰æ›: localX â†’ (localX - bounds.minX) ç›¸å¯¾åº§æ¨™åŒ–
      â”‚  â””â”€ Earcutä¸‰è§’å½¢åˆ†å‰² â†’ Float32Array
      â”‚
      â”œâ”€ glStrokeProcessor.createEdgeBuffer(points, size)
      â”‚
      â”œâ”€ glMSDFPipeline.generateMSDF(edgeBuffer, bounds, ...)
      â”‚  â”œâ”€ seedInitPass: ã‚¨ãƒƒã‚¸åˆæœŸåŒ–
      â”‚  â”œâ”€ jfaPass: Jump Flooding Algorithm
      â”‚  â”œâ”€ encodePass: è·é›¢ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
      â”‚  â””â”€ renderPass: æœ€çµ‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° â†’ WebGLTexture
      â”‚
      â”œâ”€ glTextureBridge.createSpriteFromGLTexture(texture, w, h)
      â”‚  â””â”€ PIXI.Spriteç”Ÿæˆ
      â”‚
      â””â”€ Spriteé…ç½®ï¼ˆLocalåº§æ¨™ï¼‰
         â”œâ”€ sprite.x = bounds.minX
         â”œâ”€ sprite.y = bounds.minY
         â”œâ”€ sprite.width = bounds.width
         â”œâ”€ sprite.height = bounds.height
         â””â”€ previewContainer.addChild(sprite)

4. finalizeStroke()
   â”œâ”€ _cleanupPreview()ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰Šé™¤ï¼‰
   â””â”€ _finalizeMSDFStroke(points, activeLayer)
      â”œâ”€ åŒæ§˜ã®WebGL2ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
      â”œâ”€ æœ€çµ‚Spriteç”Ÿæˆãƒ»é…ç½®
      â”œâ”€ layer.pathsé…åˆ—ã«è¿½åŠ 
      â”œâ”€ history.push()ï¼ˆUndo/Redoï¼‰
      â””â”€ EventBusç™ºç«: layer:path-added
```

### boundsã®åº§æ¨™ç³»

```javascript
// gl-stroke-processor.js
const bounds = calculateBounds(points, margin);
// bounds.minX/minY/maxX/maxY ã¯ Localåº§æ¨™ç³»ã®å€¤

// Vertex Buffer ã® aPosition ã¯ç›¸å¯¾åº§æ¨™ [0, bounds.width/height]
const relativeX = localX - bounds.minX;
const relativeY = localY - bounds.minY;

// Spriteé…ç½®ã¯Localåº§æ¨™
sprite.x = bounds.minX;  // Localåº§æ¨™
sprite.y = bounds.minY;  // Localåº§æ¨™
```

---

## 5. åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼ï¼ˆv26ï¼‰

### core-initializer.js ã®å‡¦ç†é †

```javascript
async function initializeApp() {
  // 1. ä¾å­˜ãƒã‚§ãƒƒã‚¯
  checkGlobalDependencies();
  
  // 2. CoreEngineåˆæœŸåŒ–ï¼ˆworldContainerç”Ÿæˆï¼‰
  await CoreEngine.initialize();
  
  // 3. CoordinateSystemåˆæœŸåŒ–ï¼ˆworldContainerå–å¾—å¾Œï¼‰
  const worldContainer = CoreEngine.getWorldContainer();
  CoordinateSystem.initialize(canvas, worldContainer);
  
  // 4. WebGL2ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åˆæœŸåŒ–
  WebGLContext.initialize(canvas);
  glStrokeProcessor.initialize();
  glMSDFPipeline.initialize();
  glTextureBridge.initialize();
  glMaskLayer.initialize();
  
  // 5. BrushCoreå†åˆæœŸåŒ–ï¼ˆWebGL2ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ³¨å…¥ï¼‰
  brushCore.updateComponents({
    strokeRecorder,
    glStrokeProcessor,
    glMSDFPipeline,
    glTextureBridge,
    glMaskLayer
  });
}
```

### âš ï¸ åˆæœŸåŒ–ã®æ³¨æ„ç‚¹

- **worldContainerå–å¾—ã‚¿ã‚¤ãƒŸãƒ³ã‚°**  
  CoreEngine.initialize()å®Œäº†å¾Œã§ãªã„ã¨ undefined

- **CoordinateSystemåˆæœŸåŒ–é †åº**  
  worldContainer.position/scale å‚ç…§ãŒå¿…è¦ãªãŸã‚å¾Œå›ã—

- **å¾ªç’°ä¾å­˜ã®å›é¿**  
  ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯å„ãƒ•ã‚¡ã‚¤ãƒ«ã§ç”Ÿæˆã€åˆæœŸåŒ–ã¯åˆ†é›¢

---

## 6. ãƒ‡ãƒãƒƒã‚°æ‰‹é †

### åˆæœŸåŒ–ç¢ºèª

```javascript
// WebGL2ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
console.log('WebGLContext:', window.WebGLContext);
console.log('GL:', window.WebGLContext?.gl);

// CoordinateSystem
console.log('CoordinateSystem:', window.CoordinateSystem);
window.CoordinateSystem?.dumpState();
```

### åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ

```javascript
// Screen â†’ Local ã®å…¨å¤‰æ›
const testX = 500, testY = 300;
const canvas = window.CoordinateSystem.screenClientToCanvas(testX, testY);
console.log('Canvas:', canvas);

const world = window.CoordinateSystem.canvasToWorld(canvas.canvasX, canvas.canvasY);
console.log('World:', world);

const layer = window.layerManager.getActiveLayer();
const local = window.CoordinateSystem.worldToLocal(world.worldX, world.worldY, layer);
console.log('Local:', local);
```

### ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯åº§æ¨™ç¢ºèª

```javascript
// è¨˜éŒ²ã•ã‚ŒãŸåº§æ¨™
const points = window.strokeRecorder.getRawPoints();
console.log('Points:', points.length);
console.log('Range:', {
  minX: Math.min(...points.map(p => p.x)),
  maxX: Math.max(...points.map(p => p.x)),
  minY: Math.min(...points.map(p => p.y)),
  maxY: Math.max(...points.map(p => p.y))
});
```

### ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ç¢ºèª

```javascript
// parent chain ãƒˆãƒ¬ãƒ¼ã‚¹
let node = window.layerManager.getActiveLayer();
const chain = [];
while (node) {
  chain.push(node.label || node.name || 'unknown');
  node = node.parent;
}
console.log('Parent chain:', chain);
// æœŸå¾…: ['Layer 1', 'worldContainer', 'stage', ...]
```

---

## 7. ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

### å•é¡Œ: ãƒšãƒ³å…¥åŠ›ä½ç½®ã¨æç”»ä½ç½®ãŒã‚ºãƒ¬ã‚‹

**åŸå› :**
- worldContainer.updateTransform()æœªå‘¼ã³å‡ºã—
- activeLayer.parent chain ãŒ worldContainer ã¾ã§ç¹‹ãŒã£ã¦ã„ãªã„
- DPI/DPRè¨ˆç®—ã®ä¸ä¸€è‡´

**è§£æ±º:**
```javascript
// coordinate-system.js ã® canvasToWorld() å†…ã§
this.worldContainer.updateTransform();

// parent chainç¢ºèª
const layer = layerManager.getActiveLayer();
console.assert(layer.parent?.parent === worldContainer);
```

### å•é¡Œ: é•·ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã§æç”»ãŒå¤‰å½¢ã™ã‚‹

**åŸå› :**
- Shader ã® aPosition æ­£è¦åŒ–ãŒ bounds ã¨ä¸ä¸€è‡´
- uResolution = 512å›ºå®š vs bounds.width/height

**è§£æ±º:**
```glsl
// render.vert.glsl
uniform vec2 uBoundsSize;  // è¿½åŠ 
vec2 normalized = aPosition / uBoundsSize;  // ä¿®æ­£
```

```javascript
// gl-msdf-pipeline.js ã® renderPass()
gl.uniform2f(uniformLocs.uBoundsSize, bounds.width, bounds.height);
```

### å•é¡Œ: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« NaN ãŒå‡ºã‚‹

**åŸå› :**
- åº§æ¨™å¤‰æ›ã®é€”ä¸­ã§NaNæ··å…¥
- worldContainer.position ãŒ undefined

**è§£æ±º:**
```javascript
// å„å¤‰æ›ã‚¹ãƒ†ãƒƒãƒ—ã§æ¤œå‡º
if (isNaN(localX) || isNaN(localY)) {
  console.error('[Drawing] NaN detected:', {localX, localY, worldX, worldY});
  return;
}
```

---

## 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

### Perfect Freehandè¨­å®šï¼ˆconfig.jsï¼‰

```javascript
window.TegakiConfig = {
  perfectFreehand: {
    thinning: 0.7,    // ç­†åœ§ã«ã‚ˆã‚‹å¤ªã•å¤‰åŒ–ï¼ˆ0.5-0.9æ¨å¥¨ï¼‰
    smoothing: 0.4,   // è£œé–“ã®å¼·ã•ï¼ˆ0.3-0.6æ¨å¥¨ï¼‰
    streamline: 0.3   // é…å»¶å®‰å®šåŒ–ï¼ˆ0.2-0.4æ¨å¥¨ï¼‰
  }
};
```

### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°é »åº¦ï¼ˆbrush-core.jsï¼‰

```javascript
// renderPreview ã¯ throttle 100ms
// é«˜é€Ÿå…¥åŠ›æ™‚ã®è² è·è»½æ¸›
```

### FBOå†åˆ©ç”¨ï¼ˆgl-msdf-pipeline.jsï¼‰

```javascript
// existingMSDF ã‚’æ¸¡ã™ã¨ãƒ†ã‚¯ã‚¹ãƒãƒ£å†åˆ©ç”¨
generateMSDF(edgeBuffer, bounds, existingMSDF, ...);
```

---

## 9. å°†æ¥ã®æ‹¡å¼µäºˆå®š

### Phase 2: ç­†åœ§å¯¾å¿œ
- âœ… Perfect Freehand ã® thinning ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å®Ÿè£…æ¸ˆã¿
- pointer-handler.js, pressure-handler.js ã§ç­†åœ§å–å¾—æ¸ˆã¿

### Phase 3: æ¶ˆã—ã‚´ãƒ çµ±åˆ
- âœ… gl-mask-layer.js å®Ÿè£…æ¸ˆã¿ï¼ˆCircle mask, Additive blendï¼‰
- Compose Pass çµ±åˆãŒå¿…è¦

### Phase 4: ãƒ™ã‚¯ã‚¿ãƒ¼å‡ºåŠ›
- SVG/PDF ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒãƒªã‚´ãƒ³ãƒ‡ãƒ¼ã‚¿ä¿æŒï¼‰
- PSD ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯¾å¿œï¼ˆå®Ÿè£…äºˆå®šï¼‰

### Phase 5: GPU Computeæœ€é©åŒ–
- WebGPUç§»è¡Œæ¤œè¨ï¼ˆWebGL2ã¨ã®å…±å­˜ï¼‰
- Compute Shader ã«ã‚ˆã‚‹ SDF ç”Ÿæˆé«˜é€ŸåŒ–

---

## 10. å‘½åè¦å‰‡ãƒ»ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

### åº§æ¨™ç³»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å

```javascript
// âœ… æ­£ã—ã„
function transform(localX, localY, worldX, worldY) { ... }

// âŒ é–“é•ã„
function transform(x, y) { ... }  // åº§æ¨™ç³»ä¸æ˜
```

### ãƒ¡ã‚½ãƒƒãƒ‰å

```javascript
// âœ… æ­£ã—ã„
screenClientToCanvas(clientX, clientY)
canvasToWorld(canvasX, canvasY)
worldToLocal(worldX, worldY, container)

// âŒ é–“é•ã„
toCanvas(x, y)  // å…ƒåº§æ¨™ç³»ä¸æ˜
```

### ã‚¤ãƒ™ãƒ³ãƒˆå

```javascript
// âœ… æ­£ã—ã„
EventBus.emit('layer:transform-updated', data);
EventBus.emit('camera:zoom-changed', data);

// âŒ é–“é•ã„
EventBus.emit('update', data);  // æ›–æ˜§
```

### WebGL2å‘½å

```javascript
// âœ… æ­£ã—ã„
const glContext = WebGLContext.getGL();
const glBuffer = gl.createBuffer();
const glTexture = gl.createTexture();

// âŒ é–“é•ã„
const context = ...;  // WebGL2ã‹ä¸æ˜
const buffer = ...;   // CPU/GPUä¸æ˜
```

---

## ä»˜éŒ²: ä¸»è¦APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### CoordinateSystem

```javascript
window.CoordinateSystem.initialize(canvas, worldContainer)
window.CoordinateSystem.screenClientToCanvas(clientX, clientY)
  â†’ {canvasX, canvasY}
window.CoordinateSystem.canvasToWorld(canvasX, canvasY)
  â†’ {worldX, worldY}
window.CoordinateSystem.worldToLocal(worldX, worldY, container)
  â†’ {localX, localY}
window.CoordinateSystem.dumpState()  // ãƒ‡ãƒãƒƒã‚°ç”¨
```

### WebGLContext

```javascript
window.WebGLContext.initialize(canvas)
window.WebGLContext.getGL() â†’ WebGL2RenderingContext
window.WebGLContext.getCanvas() â†’ HTMLCanvasElement
window.WebGLContext.createProgram(vs, fs) â†’ WebGLProgram
window.WebGLContext.createFBO(width, height, options) â†’ FBO
```

### GLStrokeProcessor

```javascript
window.glStrokeProcessor.initialize()
window.glStrokeProcessor.createPolygonVertexBuffer(points, baseSize)
  â†’ {buffer:Float32Array, vertexCount, bounds}
window.glStrokeProcessor.uploadToGPU(data, usage, elementStrideBytes)
  â†’ {glBuffer, elementCount, data}
```

### GLMSDFPipeline

```javascript
window.glMSDFPipeline.initialize()
window.glMSDFPipeline.generateMSDF(edgeBuffer, bounds, existingMSDF, settings, ...)
  â†’ {texture:WebGLTexture, width, height}
```

### BrushCore

```javascript
window.brushCore.startStroke(localX, localY, pressure)
window.brushCore.updateStroke(localX, localY, pressure)
window.brushCore.renderPreview()
window.brushCore.finalizeStroke()
```

---

**End of Reference v26**