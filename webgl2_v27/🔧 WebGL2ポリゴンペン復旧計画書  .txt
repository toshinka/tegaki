================================================================================
WebGL2ãƒãƒªã‚´ãƒ³ãƒšãƒ³å¾©æ—§è¨ˆç”»æ›¸ v24
================================================================================
ä½œæˆæ—¥: 2025-01-XX
å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³: webgl2_v24
çŠ¶æ…‹: æç”»ä¸èƒ½ â†’ å¾©æ—§ä½œæ¥­å¿…è¦

ã€ç¾è±¡ã€‘
âŒ ãƒšãƒ³ã§æã‘ãªã„ï¼ˆå…¥åŠ›ã¯å—ã‘ä»˜ã‘ã‚‹ãŒç”»é¢ã«åæ˜ ã•ã‚Œãªã„ï¼‰
âŒ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼: window.WebGLContext is undefined
âŒ åˆæœŸåŒ–å¤±æ•—: core-initializer.js ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¾å­˜ãƒã‚§ãƒƒã‚¯å¤±æ•—

ã€æ ¹æœ¬åŸå› ã€‘
ğŸ” window.WebGLContext ã‚¯ãƒ©ã‚¹ãŒå­˜åœ¨ã—ãªã„
ğŸ” webgl2-drawing-layer.js ãŒ WebGLContext ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ãŒæœªå®šç¾©
ğŸ” WebGPUåŒ–ã®è©¦ã¿ã§ WebGL2 ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ãŒå‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§

================================================================================
Phase 1: ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ãƒ»ä¾å­˜é–¢ä¿‚è¾å…¸
================================================================================

### ğŸ“ ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ï¼ˆåˆæœŸåŒ–ãƒ»åº§æ¨™ãƒ»ã‚«ãƒ¡ãƒ©ï¼‰

ã€index.htmlã€‘
  å½¹å‰²: ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ãƒ‰é †åºç®¡ç†
  ä¾å­˜: ãªã—
  å­: å…¨ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ­ãƒ¼ãƒ‰é †åºã§ä¾å­˜ï¼‰
  
ã€config.jsã€‘v8.14.3
  å½¹å‰²: ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã€PerfectFreehandã‚ªãƒ—ã‚·ãƒ§ãƒ³
  ä¾å­˜: ãªã—
  å­: å…¨ã‚·ã‚¹ãƒ†ãƒ ï¼ˆè¨­å®šå‚ç…§å…ƒï¼‰
  ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£:
    - window.TegakiConfig
    - perfectFreehand: {thinning:0.7, smoothing:0.4, streamline:0.3}

ã€coordinate-system.jsã€‘v8.14.0 Phase 1.2
  å½¹å‰²: Screenâ†’Canvasâ†’Worldâ†’Local åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
  ä¾å­˜: config.js, event-bus.js, camera-system.js
  å­: drawing-engine.js
  ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: window.CoordinateSystem (ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³)
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - screenClientToCanvas(clientX, clientY) â†’ {canvasX, canvasY}
    - canvasToWorld(canvasX, canvasY) â†’ {worldX, worldY}
    - worldToLocal(worldX, worldY, container) â†’ {localX, localY}
    - initialize(canvas, worldContainer)
  âš ï¸ å•é¡Œ: worldContainer.updateTransform() å‘¼ã³å‡ºã—ãŒå¿…è¦

ã€camera-system.jsã€‘
  å½¹å‰²: worldContainer ã®ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³åˆ¶å¾¡
  ä¾å­˜: event-bus.js
  å­: coordinate-system.js
  ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«:
    - camera:transform-changed
    - camera:resized

ã€event-bus.jsã€‘
  å½¹å‰²: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡
  ä¾å­˜: ãªã—
  å­: å…¨ã‚·ã‚¹ãƒ†ãƒ 
  ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: window.EventBus

### ğŸ“ æç”»ã‚·ã‚¹ãƒ†ãƒ åŸºç›¤

ã€system/drawing/pointer-handler.jsã€‘Phase 1
  å½¹å‰²: PointerEvent æ­£è¦åŒ–ã€pressure å–å¾—
  ä¾å­˜: ãªã—
  è¦ª: drawing-engine.js
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - getPressure(event) â†’ number
    - normalizePointerEvent(event)

ã€system/drawing/pressure-handler.jsã€‘Phase 1
  å½¹å‰²: ç­†åœ§è¨ˆç®—ã€ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç®¡ç†
  ä¾å­˜: ãªã—
  è¦ª: drawing-engine.js
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - getPressure(event) â†’ number (0.0-1.0)

ã€system/drawing/stroke-recorder.jsã€‘Phase 0
  å½¹å‰²: Localåº§æ¨™ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²å°‚ç”¨ï¼ˆåº§æ¨™å¤‰æ›ãªã—ï¼‰
  ä¾å­˜: ãªã—
  è¦ª: drawing-engine.js â†’ brush-core.js
  ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: window.strokeRecorder
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - startStroke(localX, localY, pressure, options)
    - addPoint(localX, localY, pressure, tiltX?, tiltY?)
    - endStroke()
    - getRawPoints() â†’ Array<{x, y, pressure, ...}>
  âš ï¸ é‡è¦: åº§æ¨™å¤‰æ›ã‚’ä¸€åˆ‡è¡Œã‚ãªã„ã€å—ã‘å–ã£ãŸå€¤ã‚’ãã®ã¾ã¾è¨˜éŒ²

ã€system/drawing/drawing-engine.jsã€‘v8.14.2 Phase 1.1
  å½¹å‰²: PointerEventå—ä¿¡ã€åº§æ¨™å¤‰æ›å®Ÿè¡Œã€BrushCoreã¸å§”è¨—
  ä¾å­˜: coordinate-system.js, camera-system.js, layer-system.js, 
        brush-core.js, pointer-handler.js, pressure-handler.js
  è¦ª: core-engine.jsï¼ˆåˆæœŸåŒ–å…ƒï¼‰
  ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: window.drawingEngine
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - _handlePointerDown(e)
    - _handlePointerMove(e)
    - _handlePointerUp(e)
    - _transformPointerToLocal(e) â†’ {localX, localY, worldX, worldY, ...}
    - flushPendingPoints()
  ãƒ•ãƒ­ãƒ¼:
    PointerEvent â†’ _transformPointerToLocal() 
    â†’ CoordinateSystem.screenClientToCanvas()
    â†’ CoordinateSystem.canvasToWorld()
    â†’ CoordinateSystem.worldToLocal(activeLayer)
    â†’ BrushCore.startStroke(localX, localY, pressure)

### ğŸ“ WebGL2æç”»ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

âŒã€system/drawing/webgl2/webgl2-drawing-layer.jsã€‘Phase 1
  å½¹å‰²: WebGL2ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ã€FBO/Textureç®¡ç†ã€ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ«ãƒ¼ãƒ—
  ä¾å­˜: ãªã—ï¼ˆWebGL2 APIç›´æ¥ï¼‰
  è¦ª: gl-stroke-processor.js, gl-msdf-pipeline.js, gl-texture-bridge.js
  æœŸå¾…ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: window.WebGLContext
  æœŸå¾…ãƒ¡ã‚½ãƒƒãƒ‰:
    - getGL() â†’ WebGL2RenderingContext
    - getCanvas() â†’ HTMLCanvasElement
    - createFBO(width, height, options)
    - initialize()
  ğŸ”§ å•é¡Œ: ã“ã®ã‚¯ãƒ©ã‚¹ãŒå­˜åœ¨ã—ãªã„ã‹ã€window.WebGLContext ãŒæœªç™»éŒ²

ã€system/drawing/webgl2/gl-stroke-processor.jsã€‘Phase 1.6
  å½¹å‰²: PerfectFreehand â†’ Earcutä¸‰è§’å½¢åˆ†å‰² â†’ GPUé ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ç”Ÿæˆ
  ä¾å­˜: perfect-freehand, earcut-triangulator.js, config.js, 
        webgl2-drawing-layer.js
  è¦ª: brush-core.js
  ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: window.glStrokeProcessor
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - createPolygonVertexBuffer(points, baseSize) 
      â†’ {buffer:Float32Array, vertexCount, bounds}
    - createEdgeBuffer(points, baseSize)
      â†’ {buffer:Float32Array, edgeCount, bounds}
    - calculateBounds(points, margin)
      â†’ {minX, minY, maxX, maxY, width, height}
    - uploadToGPU(data, usage, elementStrideBytes)
      â†’ {glBuffer, elementCount, data}
  âš ï¸ åº§æ¨™å¤‰æ›:
    - å…¥åŠ›: Localåº§æ¨™ points
    - å‡ºåŠ›: boundsç›¸å¯¾åº§æ¨™ [0, bounds.width/height]

ã€system/drawing/webgl2/gl-msdf-pipeline.jsã€‘Phase 1.8
  å½¹å‰²: MSDFè·é›¢å ´ç”Ÿæˆï¼ˆJFA: Jump Flooding Algorithmï¼‰
  ä¾å­˜: webgl2-drawing-layer.js, gl-stroke-processor.js
  è¦ª: brush-core.js
  ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: window.glMSDFPipeline
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - generateMSDF(edgeBuffer, bounds, existingMSDF, settings, 
                   vertexBuffer, vertexCount, edgeCount)
      â†’ {texture:WebGLTexture, width, height}
    - seedInitPass()
    - jfaPass()
    - encodePass()
    - renderPass()
  âš ï¸ Shaderå•é¡Œ:
    - render.vert.glsl ã§ aPosition / uResolution æ­£è¦åŒ–
    - uResolution = 512x512 å›ºå®šã ãŒ bounds.width/height ã¨ä¸ä¸€è‡´
    - é•·ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã§å¤‰å½¢ç™ºç”Ÿ

ã€system/drawing/webgl2/gl-texture-bridge.jsã€‘Phase 5
  å½¹å‰²: WebGLTexture â†’ PIXI.Sprite å¤‰æ›
  ä¾å­˜: webgl2-drawing-layer.js, PixiJS
  è¦ª: brush-core.js
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - createSpriteFromGLTexture(texture, width, height)
      â†’ PIXI.Sprite

ã€system/drawing/webgl2/gl-mask-layer.jsã€‘Phase 6
  å½¹å‰²: æ¶ˆã—ã‚´ãƒ ç”¨ãƒã‚¹ã‚¯å‡¦ç†ï¼ˆCircle mask, Additive blendï¼‰
  ä¾å­˜: webgl2-drawing-layer.js
  è¦ª: brush-core.js
  âŒ ç¾çŠ¶: å®Ÿè£…æ¸ˆã¿ã ãŒå‹•ä½œæœªç¢ºèª

### ğŸ“ æç”»çµ±åˆãƒ»ãƒ–ãƒ©ã‚·

ã€system/drawing/brush-core.jsã€‘Phase 2.2
  å½¹å‰²: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å‡¦ç†çµ±åˆã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”»ã€æœ€çµ‚æç”»ã€æ¶ˆã—ã‚´ãƒ 
  ä¾å­˜: stroke-recorder.js, gl-stroke-processor.js, gl-msdf-pipeline.js,
        gl-texture-bridge.js, gl-mask-layer.js, layer-system.js, 
        history.js, event-bus.js
  è¦ª: drawing-engine.jsï¼ˆstartStroke/updateStrokeå‘¼ã³å‡ºã—å…ƒï¼‰
      core-engine.jsï¼ˆrenderPreviewå‘¼ã³å‡ºã—å…ƒï¼‰
  ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: window.brushCore
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - startStroke(localX, localY, pressure)
    - updateStroke(localX, localY, pressure)
    - renderPreview() [throttle 100ms]
    - _updatePreview(points)
    - finalizeStroke()
    - _finalizeMSDFStroke(points, activeLayer)
  ãƒ•ãƒ­ãƒ¼:
    startStroke â†’ strokeRecorder.startStroke(localX, localY, pressure)
    updateStroke â†’ strokeRecorder.addPoint(localX, localY, pressure)
    renderPreview â†’ _updatePreview(strokeRecorder.getRawPoints())
    â†’ glStrokeProcessor.createPolygonVertexBuffer(points, size)
    â†’ glMSDFPipeline.generateMSDF(edgeBuffer, bounds, ...)
    â†’ glTextureBridge.createSpriteFromGLTexture(texture, ...)
    â†’ sprite.x/y = bounds.minX/minY (Localåº§æ¨™)
    â†’ sprite.width/height = bounds.width/height
    â†’ previewContainer.addChild(sprite)

ã€system/drawing/brush-settings.jsã€‘Phase 3-D
  å½¹å‰²: ãƒ–ãƒ©ã‚·è¨­å®šç®¡ç†
  ä¾å­˜: event-bus.js
  ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: window.brushSettings
  ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£:
    - size, opacity, color, mode (pen/eraser)

### ğŸ“ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 

ã€system/layer-system.jsã€‘Phase 8
  å½¹å‰²: ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ç®¡ç†ã€activeLayerç®¡ç†
  ä¾å­˜: data-models.js, event-bus.js, PixiJS
  ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: window.layerManager
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - getActiveLayer() â†’ LayerModel
    - createLayer(options)
  ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£:
    - activeLayer.drawingContainer (PIXI.Container)
    - activeLayer.container (PIXI.Container)
  âš ï¸ é‡è¦: activeLayer.parent chain ãŒ worldContainer ã¾ã§ç¹‹ãŒã£ã¦ã„ã‚‹å¿…è¦

### ğŸ“ åˆæœŸåŒ–ãƒ»ã‚³ã‚¢

ã€core-initializer.jsã€‘Phase 1.1
  å½¹å‰²: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã€ä¾å­˜ãƒã‚§ãƒƒã‚¯
  ä¾å­˜: å…¨ã‚·ã‚¹ãƒ†ãƒ 
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - initializeApp()
    - checkGlobalDependencies() â†’ Array<string> (missing names)
  âŒ å•é¡Œ: window.WebGLContext ãŒå­˜åœ¨ã—ãªã„ãŸã‚å¤±æ•—

ã€core-engine.jsã€‘Phase 4-C
  å½¹å‰²: ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµ±åˆ
  ä¾å­˜: å…¨ã‚·ã‚¹ãƒ†ãƒ 
  ãƒ¡ã‚½ãƒƒãƒ‰:
    - _renderLoop()
      - pointerå‡¦ç† â†’ preview â†’ render

ã€core-runtime.jsã€‘Phase 5
  å½¹å‰²: ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç®¡ç†ã€UIä¾‹å¤–å‡¦ç†
  ä¾å­˜: å…¨ã‚·ã‚¹ãƒ†ãƒ 

================================================================================
Phase 2: ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å®Œå…¨ãƒãƒƒãƒ—
================================================================================

### ãƒšãƒ³å…¥åŠ› â†’ æç”»å®Œäº†ã¾ã§ã®å…¨ãƒ•ãƒ­ãƒ¼

1. ã€å…¥åŠ›å—ä»˜ã€‘
   DOM: Canvas(pointerdown)
   â†’ PointerHandler.normalizePointerEvent(e)
   â†’ DrawingEngine._handlePointerDown(e)

2. ã€åº§æ¨™å¤‰æ›ã€‘Screen â†’ Canvas â†’ World â†’ Local
   DrawingEngine._transformPointerToLocal(e)
   â”œâ”€ CoordinateSystem.screenClientToCanvas(clientX, clientY)
   â”‚  â””â”€ DPI/CSSè£œæ­£ â†’ {canvasX, canvasY}
   â”œâ”€ CoordinateSystem.canvasToWorld(canvasX, canvasY)
   â”‚  â”œâ”€ âš ï¸ worldContainer.updateTransform() å¿…è¦
   â”‚  â””â”€ worldTransform.applyInverse() â†’ {worldX, worldY}
   â””â”€ CoordinateSystem.worldToLocal(worldX, worldY, activeLayer)
      â”œâ”€ parent chainé¡æŸ»: activeLayer â†’ ... â†’ worldContainer
      â””â”€ æ‰‹å‹•é€†è¡Œåˆ—è¨ˆç®— â†’ {localX, localY}

3. ã€ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ²ã€‘Localåº§æ¨™ä¿å­˜
   BrushCore.startStroke(localX, localY, pressure)
   â†’ StrokeRecorder.startStroke(localX, localY, pressure)
      â””â”€ pointsé…åˆ—ã« {x:localX, y:localY, pressure} è¿½åŠ 

4. ã€ãƒã‚¤ãƒ³ã‚¿ãƒ¼ç§»å‹•ã€‘coalesced eventså¯¾å¿œ
   DrawingEngine._handlePointerMove(e)
   â†’ pendingPoints.push({localX, localY, pressure})
   â†’ flushPendingPoints() [maxPendingPoints=3]
   â†’ BrushCore.updateStroke(localX, localY, pressure) Ã—N
   â†’ StrokeRecorder.addPoint(localX, localY, pressure) Ã—N

5. ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”»ã€‘throttle 100ms
   CoreEngine._renderLoop()
   â†’ BrushCore.renderPreview()
   â†’ BrushCore._updatePreview(strokeRecorder.getRawPoints())

6. ã€ãƒ¡ãƒƒã‚·ãƒ¥ç”Ÿæˆã€‘Localåº§æ¨™ â†’ boundsç›¸å¯¾åº§æ¨™
   GLStrokeProcessor.createPolygonVertexBuffer(points, size)
   â”œâ”€ PerfectFreehandå®Ÿè¡Œ: points â†’ outlinePoints
   â”œâ”€ boundsè¨ˆç®—: {minX, minY, maxX, maxY, width, height}
   â”œâ”€ åº§æ¨™å¤‰æ›: outlinePoints[x] - bounds.minX â†’ ç›¸å¯¾åº§æ¨™
   â”œâ”€ Earcutä¸‰è§’å½¢åˆ†å‰²: flatArray â†’ indices
   â””â”€ Float32Arrayç”Ÿæˆ: [posX, posY, texU, texV, ...] Ã—7 floats/vertex

7. ã€ã‚¨ãƒƒã‚¸ãƒãƒƒãƒ•ã‚¡ç”Ÿæˆã€‘
   GLStrokeProcessor.createEdgeBuffer(points, size)
   â””â”€ åŒæ§˜ã«boundsç›¸å¯¾åº§æ¨™åŒ–

8. ã€GPUè»¢é€ã€‘
   GLStrokeProcessor.uploadToGPU(vertexBuffer)
   GLStrokeProcessor.uploadToGPU(edgeBuffer)
   âŒ å•é¡Œ: WebGLContext.gl ãŒå­˜åœ¨ã—ãªã„

9. ã€MSDFç”Ÿæˆã€‘JFAè·é›¢å ´è¨ˆç®—
   GLMSDFPipeline.generateMSDF(edgeBuffer, bounds, ...)
   â”œâ”€ seedInitPass: ã‚¨ãƒƒã‚¸åˆæœŸåŒ–
   â”œâ”€ jfaPass: Jump Flooding (è¤‡æ•°å›)
   â”œâ”€ encodePass: è·é›¢ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
   â””â”€ renderPass: æœ€çµ‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      âš ï¸ Shaderå•é¡Œ: aPosition / uResolution ã®ä¸ä¸€è‡´

10. ã€ãƒ†ã‚¯ã‚¹ãƒãƒ£â†’Spriteå¤‰æ›ã€‘
    GLTextureBridge.createSpriteFromGLTexture(texture, 512, 512)
    â†’ PIXI.Spriteç”Ÿæˆ

11. ã€Spriteé…ç½®ã€‘Localåº§æ¨™ã§previewContainerã«é…ç½®
    sprite.x = bounds.minX (Localåº§æ¨™)
    sprite.y = bounds.minY (Localåº§æ¨™)
    sprite.width = bounds.width
    sprite.height = bounds.height
    previewContainer.addChild(sprite)

12. ã€ãƒã‚¤ãƒ³ã‚¿ãƒ¼çµ‚äº†ã€‘
    DrawingEngine._handlePointerUp(e)
    â†’ BrushCore.finalizeStroke()
    â”œâ”€ _cleanupPreview() (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰Šé™¤)
    â””â”€ _finalizeMSDFStroke(points, activeLayer)
       â”œâ”€ åŒæ§˜ã®WebGL2ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
       â”œâ”€ æœ€çµ‚Spriteç”Ÿæˆãƒ»é…ç½®
       â”œâ”€ layer.pathsé…åˆ—ã«è¿½åŠ 
       â”œâ”€ history.push() (Undo/Redo)
       â””â”€ EventBusç™ºç«: layer:path-added

13. ã€æç”»å®Œäº†ã€‘
    StrokeRecorder.endStroke()
    â†’ isRecording = false

================================================================================
Phase 3: è‡´å‘½çš„å•é¡Œã®è¨ºæ–­
================================================================================

### âŒ å•é¡Œ1: WebGLContext ã‚¯ãƒ©ã‚¹ä¸åœ¨ï¼ˆæœ€å„ªå…ˆï¼‰

ã€ç—‡çŠ¶ã€‘
- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«: window.WebGLContext is undefined
- core-initializer.js: checkGlobalDependencies() å¤±æ•—
- å…¨WebGL2ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒæ©Ÿèƒ½ä¸å…¨

ã€åŸå› ã€‘
- webgl2-drawing-layer.js ãŒ WebGLContext ã‚’å®šç¾©ã—ã¦ã„ãªã„
- ã¾ãŸã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²ãŒæ¬ è½ã—ã¦ã„ã‚‹

ã€å½±éŸ¿ç¯„å›²ã€‘
- gl-stroke-processor.js â†’ uploadToGPU() å¤±æ•—
- gl-msdf-pipeline.js â†’ å…¨PassãŒå®Ÿè¡Œä¸å¯
- gl-texture-bridge.js â†’ ãƒ†ã‚¯ã‚¹ãƒãƒ£å¤‰æ›ä¸å¯
- gl-mask-layer.js â†’ ãƒã‚¹ã‚¯å‡¦ç†ä¸å¯

ã€å¿…è¦ãªå®Ÿè£…ã€‘
```
class WebGLContext {
  constructor() {
    this.canvas = null;
    this.gl = null;
    this.programs = {};
    this.shaders = {};
  }
  
  initialize(canvas) {
    this.canvas = canvas;
    this.gl = canvas.getContext('webgl2', {
      alpha: true,
      premultipliedAlpha: true,
      antialias: false
    });
    if (!this.gl) throw new Error('WebGL2 not supported');
    return this.gl;
  }
  
  getGL() { return this.gl; }
  getCanvas() { return this.canvas; }
  createProgram(vs, fs) { ... }
  createShader(type, source) { ... }
  createFBO(width, height, options) { ... }
  deleteFBO(fbo) { ... }
}

window.WebGLContext = new WebGLContext();
```

### âš ï¸ å•é¡Œ2: åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä¸å®Œå…¨æ€§

ã€ç—‡çŠ¶ã€‘
- ãƒšãƒ³å…¥åŠ›ä½ç½®ã¨ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»ä½ç½®ãŒã‚ºãƒ¬ã‚‹

ã€åŸå› ä»®èª¬ã€‘
1. worldContainer.updateTransform() ãŒå‘¼ã°ã‚Œã¦ã„ãªã„
   â†’ worldTransform ãŒå¤ã„çŠ¶æ…‹ã§å¤‰æ›ã•ã‚Œã‚‹
2. activeLayer.parent chain ãŒ worldContainer ã¾ã§ç¹‹ãŒã£ã¦ã„ãªã„
   â†’ worldToLocal() ã®é€†ç®—ãŒä¸å®Œå…¨
3. DPI/DPRè¨ˆç®—ã®ä¸ä¸€è‡´

ã€æ¤œè¨¼æ–¹æ³•ã€‘
- coordinate-system.js ã®å„ãƒ¡ã‚½ãƒƒãƒ‰ã« console.log è¿½åŠ 
- NaN/Infinity æ¤œå‡º
- activeLayer.parent chain ãƒˆãƒ¬ãƒ¼ã‚¹

### âš ï¸ å•é¡Œ3: WebGL2ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®åº§æ¨™ä¸ä¸€è‡´

ã€ç—‡çŠ¶ã€‘
- é•·ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã§æç”»ãŒç¸¦æ¨ªã«å¤‰å½¢ã™ã‚‹

ã€åŸå› ã€‘
- gl-msdf-pipeline.js ã® renderPass()
  - aPosition ã¯ [0, bounds.width/height] åº§æ¨™
  - uResolution = 512x512 å›ºå®š
  - bounds.width > 512 ã®å ´åˆã€æ­£è¦åŒ–ãŒä¸æ­£ç¢º

ã€Shaderå•é¡Œç®‡æ‰€ã€‘
```glsl
// render.vert.glsl
vec2 normalized = aPosition / uResolution;  // âŒ ä¸ä¸€è‡´
vec2 clipSpace = normalized * 2.0 - 1.0;
```

ã€ä¿®æ­£æ¡ˆã€‘
```glsl
uniform vec2 uBoundsSize;  // bounds.width/height ã‚’è¿½åŠ 

vec2 normalized = aPosition / uBoundsSize;  // âœ… æ­£ã—ã„æ­£è¦åŒ–
vec2 clipSpace = normalized * 2.0 - 1.0;
```

### âš ï¸ å•é¡Œ4: WebGPUæ®‹éª¸ã®å¯èƒ½æ€§

ã€èª¿æŸ»ç®‡æ‰€ã€‘
- fill-tool.js: WebGPUç«¶åˆä¿®æ­£ç‰ˆã¨ã®è¨˜è¼‰ã‚ã‚Š
- ç‹¬è‡ªWebGPUåˆæœŸåŒ–ã‚’å‰Šé™¤ã—ãŸã¨ã®è¨˜è¿°
- ä»–ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚‚æ®‹éª¸ãŒãªã„ã‹ç¢ºèªå¿…è¦

================================================================================
Phase 4: æ®µéšçš„å¾©æ—§è¨ˆç”»ï¼ˆå„ªå…ˆé †ä½é †ï¼‰
================================================================================

### Step 1: WebGLContext ã‚¯ãƒ©ã‚¹å®Ÿè£…ï¼ˆæœ€å„ªå…ˆãƒ»å¿…é ˆï¼‰

ã€ç›®çš„ã€‘
WebGL2ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ã®åŸºç›¤ã‚’ç¢ºç«‹

ã€ä½œæ¥­å†…å®¹ã€‘
1. webgl2-drawing-layer.js ã®ç¢ºèª
   - WebGLContext ã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹
   - window.WebGLContext ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹

2. æ¬ è½ã—ã¦ã„ã‚‹å ´åˆã¯å®Ÿè£…
   - WebGL2ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆæœŸåŒ–
   - Shader/Programç®¡ç†
   - FBO/Textureç®¡ç†
   - ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²: window.WebGLContext = new WebGLContext()

3. åˆæœŸåŒ–é †åºã®ç¢ºä¿
   - core-initializer.js ã‚ˆã‚Šå‰ã«ãƒ­ãƒ¼ãƒ‰
   - ã¾ãŸã¯ core-initializer.js å†…ã§åˆæœŸåŒ–

ã€æœŸå¾…çµæœã€‘
âœ… window.WebGLContext å­˜åœ¨ç¢ºèª
âœ… core-initializer.js ã®ä¾å­˜ãƒã‚§ãƒƒã‚¯é€šé
âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–æˆåŠŸ

### Step 2: åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼ç¢ºèª

ã€ç›®çš„ã€‘
å…¨ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£ã—ã„é †åºã§åˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

ã€ä½œæ¥­å†…å®¹ã€‘
1. index.html ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ãƒ‰é †ç¢ºèª
   - webgl2-drawing-layer.js ãŒæ—©æœŸãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹
   - ä¾å­˜é–¢ä¿‚ã«åŸºã¥ãé †åºã«ãªã£ã¦ã„ã‚‹ã‹

2. core-initializer.js ã®ç¢ºèª
   - checkGlobalDependencies() ãŒæœŸå¾…ã™ã‚‹ä¾å­˜ãƒªã‚¹ãƒˆ
   - å…¨ä¾å­˜ãŒæƒã£ã¦ã„ã‚‹ã‹

3. å„ã‚·ã‚¹ãƒ†ãƒ ã® initialize() å‘¼ã³å‡ºã—ç¢ºèª
   - CoordinateSystem.initialize(canvas, worldContainer)
   - WebGLContext.initialize(canvas)
   - ãã®ä»–ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–

ã€æœŸå¾…çµæœã€‘
âœ… ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—
âœ… å…¨ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†

### Step 3: åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ¤œè¨¼

ã€ç›®çš„ã€‘
PointerEvent â†’ Localåº§æ¨™å¤‰æ›ã®å®Œå…¨æ€§ã‚’ç¢ºä¿

ã€ä½œæ¥­å†…å®¹ã€‘
1. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
   - drawing-engine._transformPointerToLocal() ã®å„ã‚¹ãƒ†ãƒƒãƒ—
   - coordinate-system.js ã®å„ãƒ¡ã‚½ãƒƒãƒ‰
   - NaN/Infinity æ¤œå‡º

2. worldContainer.updateTransform() è¿½åŠ 
   - coordinate-system.canvasToWorld() å†…ã§å‘¼ã³å‡ºã—

3. activeLayer.parent chain æ¤œè¨¼
   - layerManager.getActiveLayer() ã®æˆ»ã‚Šå€¤ç¢ºèª
   - parent chain ãƒˆãƒ¬ãƒ¼ã‚¹: activeLayer â†’ ... â†’ worldContainer

4. DPI/DPR è¨ˆç®—ç¢ºèª
   - screenClientToCanvas() ã® scaleX/scaleY è¨ˆç®—
   - canvas.width/height vs rect.width/height

ã€æœŸå¾…çµæœã€‘
âœ… åº§æ¨™ã‚ºãƒ¬è§£æ¶ˆ
âœ… NaN/Infinity ç™ºç”Ÿãªã—
âœ… ãƒšãƒ³å…¥åŠ›ä½ç½®ã¨ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»ä½ç½®ãŒä¸€è‡´

### Step 4: WebGL2ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‹•ä½œç¢ºèª

ã€ç›®çš„ã€‘
ãƒ¡ãƒƒã‚·ãƒ¥ç”Ÿæˆã‹ã‚‰ãƒ†ã‚¯ã‚¹ãƒãƒ£ç”Ÿæˆã¾ã§ã®å…¨ãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèª

ã€ä½œæ¥­å†…å®¹ã€‘
1. GLStrokeProcessor å‹•ä½œç¢ºèª
   - createPolygonVertexBuffer() ã®å‡ºåŠ›
   - boundsè¨ˆç®—ã®æ­£ç¢ºæ€§
   - åº§æ¨™å¤‰æ›ã®æ­£ã—ã•

2. GLMSDFPipeline å‹•ä½œç¢ºèª
   - å„Passï¼ˆseedInit, jfa, encode, renderï¼‰ã®å®Ÿè¡Œ
   - ãƒ†ã‚¯ã‚¹ãƒãƒ£ç”Ÿæˆç¢ºèª
   - uResolution vs uBoundsSize å•é¡Œã®ç‰¹å®š

3. GLTextureBridge å‹•ä½œç¢ºèª
   - WebGLTexture â†’ PIXI.Sprite å¤‰æ›
   - ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚µã‚¤ã‚ºç¢ºèª

ã€æœŸå¾…çµæœã€‘
âœ… ãƒ¡ãƒƒã‚·ãƒ¥ç”ŸæˆæˆåŠŸ
âœ… MSDFãƒ†ã‚¯ã‚¹ãƒãƒ£ç”ŸæˆæˆåŠŸ
âœ… Spriteç”ŸæˆæˆåŠŸ

### Step 5: Spriteé…ç½®ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

ã€ç›®çš„ã€‘
æœ€çµ‚çš„ãªæç”»ãŒæ­£ã—ãè¡Œã‚ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

ã€ä½œæ¥­å†…å®¹ã€‘
1. BrushCore._updatePreview() ç¢ºèª
   - sprite.x/y = bounds.minX/minY (Localåº§æ¨™)
   - sprite.width/height = bounds.width/height
   - previewContainer ã¸ã® addChild

2. Containeréšå±¤ç¢ºèª
   - previewContainer.parent ãŒ activeLayer.drawingContainer
   - drawingContainer.parent ãŒ activeLayer.container
   - æœ€çµ‚çš„ã« worldContainer ã¾ã§ç¹‹ãŒã£ã¦ã„ã‚‹ã‹

3. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ç¢ºèª
   - PixiJS ã® stage.render()
   - WebGL2 ã®ç‹¬è‡ªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆã‚ã‚‹å ´åˆï¼‰

ã€æœŸå¾…çµæœã€‘
âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”»ãŒè¡¨ç¤ºã•ã‚Œã‚‹
âœ… ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯çµ‚äº†æ™‚ã«æœ€çµ‚æç”»ãŒç¢ºå®šã•ã‚Œã‚‹
âœ… åº§æ¨™ã‚ºãƒ¬ãªã—ã€å¤‰å½¢ãªã—

### Step 6: é•·ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å¤‰å½¢å•é¡Œã®ä¿®æ­£

ã€ç›®çš„ã€‘
Shader ã®åº§æ¨™æ­£è¦åŒ–ã‚’ä¿®æ­£

ã€ä½œæ¥­å†…å®¹ã€‘
1. gl-msdf-pipeline.js ã® renderPass() ä¿®æ­£
   - uBoundsSize uniform è¿½åŠ 
   - render.vert.glsl ã« uBoundsSize è¿½åŠ 

2. Vertex Shaderä¿®æ­£
   ```glsl
   uniform vec2 uBoundsSize;
   vec2 normalized = aPosition / uBoundsSize;
   ```

3. _drawStroke() ãƒ¡ã‚½ãƒƒãƒ‰ä¿®æ­£
   - uBoundsSize ã« bounds.width/height ã‚’è¨­å®š

ã€æœŸå¾…çµæœã€‘
âœ… é•·ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã§ã‚‚å¤‰å½¢ã—ãªã„
âœ… ä»»æ„ã®ã‚µã‚¤ã‚ºã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãŒæ­£ç¢ºã«æç”»ã•ã‚Œã‚‹

### Step 7: WebGPUæ®‹éª¸ã®å‰Šé™¤

ã€ç›®çš„ã€‘
ä¸è¦ãªã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ä¿ã¤

ã€ä½œæ¥­å†…å®¹ã€‘
1. å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã§ "GPU" "WebGPU" "gpu" æ–‡å­—åˆ—æ¤œç´¢
2. WebGPUé–¢é€£ã®ã‚³ãƒ¼ãƒ‰ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
3. WebGL2ã«çµ±ä¸€

ã€æœŸå¾…çµæœã€‘
âœ… WebGPUé–¢é€£ã‚³ãƒ¼ãƒ‰ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã‚‹
âœ… ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«WebGPUé–¢é€£ã®è­¦å‘Šãƒ»ã‚¨ãƒ©ãƒ¼ãªã—

### Step 8: ç·åˆãƒ†ã‚¹ãƒˆ

ã€ç›®çš„ã€‘
å…¨æ©Ÿèƒ½ãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

ã€ä½œæ¥­å†…å®¹ã€‘
1. çŸ­ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”»ãƒ†ã‚¹ãƒˆ
2. é•·ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”»ãƒ†ã‚¹ãƒˆï¼ˆ1000pxä»¥ä¸Šï¼‰
3. ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³æ“ä½œä¸‹ã§ã®æç”»ãƒ†ã‚¹ãƒˆ
4. è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã®æç”»ãƒ†ã‚¹ãƒˆ
5. æ¶ˆã—ã‚´ãƒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆå®Ÿè£…æ¸ˆã¿ã®å ´åˆï¼‰

ã€æœŸå¾…çµæœã€‘
âœ… å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§æ­£å¸¸å‹•ä½œ
âœ… åº§æ¨™ã‚ºãƒ¬ãªã—
âœ… å¤‰å½¢ãªã—
âœ… ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—

================================================================================
Phase 5: å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
================================================================================

### WebGLContext ã‚¯ãƒ©ã‚¹å®Ÿè£…
- [ ] webgl2-drawing-layer.js ã« WebGLContext ã‚¯ãƒ©ã‚¹å®šç¾©
- [ ] window.WebGLContext ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
- [ ] initialize(canvas) ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] getGL() ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] getCanvas() ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] createProgram(vs, fs) ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] createShader(type, source) ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] createFBO(width, height, options) ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- [ ] WebGL2ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—æˆåŠŸç¢ºèª

### åˆæœŸåŒ–é †åº
- [ ] index.html ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ãƒ‰é †ç¢ºèª
- [ ] core-initializer.js ã®ä¾å­˜ãƒã‚§ãƒƒã‚¯é€šé
- [ ] CoordinateSystem.initialize() æˆåŠŸ
- [ ] WebGLContext.initialize() æˆåŠŸ
- [ ] å…¨ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†

### åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
- [ ] screenClientToCanvas() å‹•ä½œç¢ºèª
- [ ] canvasToWorld() å‹•ä½œç¢ºèª
- [ ] worldContainer.updateTransform() å‘¼ã³å‡ºã—è¿½åŠ 
- [ ] worldToLocal() å‹•ä½œç¢ºèª
- [ ] activeLayer.parent chain ç¢ºèª
- [ ] NaN/Infinity æ¤œå‡ºãªã—

### WebGL2ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
- [ ] GLStrokeProcessor.createPolygonVertexBuffer() å‹•ä½œç¢ºèª
- [ ] GLStrokeProcessor.createEdgeBuffer() å‹•ä½œç¢ºèª
- [ ] GLStrokeProcessor.uploadToGPU() å‹•ä½œç¢ºèª
- [ ] GLMSDFPipeline.generateMSDF() å‹•ä½œç¢ºèª
- [ ] GLTextureBridge.createSpriteFromGLTexture() å‹•ä½œç¢ºèª

### æç”»ç¢ºèª
- [ ] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”»è¡¨ç¤º
- [ ] æœ€çµ‚æç”»ç¢ºå®š
- [ ] sprite.x/y/width/height æ­£ç¢ºæ€§
- [ ] Containeréšå±¤æ­£ç¢ºæ€§

### Shaderä¿®æ­£
- [ ] render.vert.glsl ã« uBoundsSize è¿½åŠ 
- [ ] _drawStroke() ã« uBoundsSize è¨­å®šè¿½åŠ 
- [ ] é•·ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å¤‰å½¢å•é¡Œè§£æ¶ˆ

### WebGPUæ®‹éª¸å‰Šé™¤
- [ ] å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã§ WebGPU æ–‡å­—åˆ—æ¤œç´¢
- [ ] WebGPUé–¢é€£ã‚³ãƒ¼ãƒ‰å‰Šé™¤
- [ ] WebGL2çµ±ä¸€ç¢ºèª

### ç·åˆãƒ†ã‚¹ãƒˆ
- [ ] çŸ­ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”»æˆåŠŸ
- [ ] é•·ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”»æˆåŠŸ
- [ ] ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ä¸‹ã§æç”»æˆåŠŸ
- [ ] è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼æç”»æˆåŠŸ
- [ ] æ¶ˆã—ã‚´ãƒ å‹•ä½œç¢ºèªï¼ˆå®Ÿè£…æ¸ˆã¿ã®å ´åˆï¼‰
- [ ] ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—

================================================================================
Phase 6: é‡è¦ãªè¨­è¨ˆåŸå‰‡ã®å†ç¢ºèª
================================================================================

### åº§æ¨™ç³»ã®å³æ ¼ãªåŒºåˆ¥
- Screenåº§æ¨™: PointerEvent.clientX/Yï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åŸºæº–ï¼‰
- Canvasåº§æ¨™: WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹å†…åº§æ¨™ï¼ˆDPIè£œæ­£å¾Œï¼‰
- Worldåº§æ¨™: worldContaineråŸºæº–ã®åº§æ¨™ï¼ˆã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³é©ç”¨å‰ï¼‰
- Localåº§æ¨™: activeLayeråŸºæº–ã®åº§æ¨™ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢é©ç”¨å‰ï¼‰
- ç›¸å¯¾åº§æ¨™: boundsåŸºæº–ã®åº§æ¨™ [0, bounds.width/height]ï¼ˆWebGL2å†…éƒ¨ï¼‰

### äºŒé‡å¤‰æ›ã®å³ç¦
- åº§æ¨™å¤‰æ›ã¯ drawing-engine ã§å®Œçµ
- stroke-recorder ã¯å—ã‘å–ã£ãŸåº§æ¨™ã‚’ãã®ã¾ã¾ä¿å­˜
- brush-core ã¯ stroke-recorder ã‹ã‚‰åº§æ¨™ã‚’å–å¾—
- gl-stroke-processor ã¯å—ã‘å–ã£ãŸåº§æ¨™ã‚’ç›¸å¯¾åº§æ¨™ã«å¤‰æ›
- **ã©ã®æ®µéšã§ã‚‚å†å¤‰æ›ã—ã¦ã¯ãªã‚‰ãªã„**

### Boundsã®åº§æ¨™ç³»
- gl-stroke-processor.calculateBounds() ã®å…¥åŠ›: Localåº§æ¨™
- bounds.minX/minY/maxX/maxY: Localåº§æ¨™ç³»ã®å€¤
- sprite.x/y ã«è¨­å®šã™ã‚‹å€¤: bounds.minX/minYï¼ˆLocalåº§æ¨™ï¼‰
- Vertex Buffer aPosition: ç›¸å¯¾åº§æ¨™ [0, bounds.width/height]

### worldTransformæ›´æ–°ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- PixiJS Tickeråœæ­¢æ™‚ã¯ worldTransform ãŒè‡ªå‹•æ›´æ–°ã•ã‚Œãªã„
- coordinate-system.canvasToWorld() å†…ã§æ˜ç¤ºçš„ã«å‘¼ã¶:
  ```javascript
  worldContainer.updateTransform();
  ```

### NaN/Infinityæ¤œå‡ºã®é‡è¦æ€§
- åº§æ¨™å¤‰æ›ã®å„ã‚¹ãƒ†ãƒƒãƒ—ã§ isNaN() ãƒã‚§ãƒƒã‚¯å¿…é ˆ
- NaNæ··å…¥æ™‚ã¯å³åº§ã«ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›
- ç„¡è¦–ã—ã¦é€²ã‚ã‚‹ã¨æç”»ãŒå®Œå…¨ã«ç ´ç¶»ã™ã‚‹

### Spriteé…ç½®å…ˆContainerã®ç¢ºèª
- Sprite.parent ã¯ activeLayer.drawingContainer ã§ã‚ã‚‹ã¹ã
- drawingContainer ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ activeLayer.container
- Containeréšå±¤: worldContainer > activeLayer.container > drawingContainer > sprite

================================================================================
Phase 7: ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰
================================================================================

### WebGLContextç¢ºèª
```javascript
console.log('WebGLContext:', window.WebGLContext);
console.log('GL:', window.WebGLContext?.gl);
console.log('Canvas:', window.WebGLContext?.canvas);
```

### åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ
```javascript
const testCoords = window.CoordinateSystem.screenClientToCanvas(500, 300);
console.log('Canvas coords:', testCoords);

const worldCoords = window.CoordinateSystem.canvasToWorld(testCoords.canvasX, testCoords.canvasY);
console.log('World coords:', worldCoords);

const activeLayer = window.layerManager.getActiveLayer();
const localCoords = window.CoordinateSystem.worldToLocal(worldCoords.worldX, worldCoords.worldY, activeLayer);
console.log('Local coords:', localCoords);
```

### activeLayerç¢ºèª
```javascript
const layer = window.layerManager.getActiveLayer();
console.log('ActiveLayer:', {
  id: layer.id,
  label: layer.label,
  position: layer.position,
  scale: layer.scale,
  rotation: layer.rotation,
  parent: layer.parent?.label,
  drawingContainer: layer.drawingContainer
});
```

### parent chain ãƒˆãƒ¬ãƒ¼ã‚¹
```javascript
let node = window.layerManager.getActiveLayer();
const chain = [];
while (node) {
  chain.push(node.label || node.name || 'unknown');
  node = node.parent;
}
console.log('Parent chain:', chain);
```

### ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯åº§æ¨™ç¢ºèª
```javascript
const points = window.strokeRecorder.getRawPoints();
console.log('Stroke points:', points.length);
console.log('First:', points[0]);
console.log('Last:', points[points.length - 1]);
console.log('Range:', {
  minX: Math.min(...points.map(p => p.x)),
  maxX: Math.max(...points.map(p => p.x)),
  minY: Math.min(...points.map(p => p.y)),
  maxY: Math.max(...points.map(p => p.y))
});
```

================================================================================
Phase 8: æˆåŠŸåŸºæº–
================================================================================

### æœ€çµ‚ç¢ºèªäº‹é …
âœ… window.WebGLContext å­˜åœ¨ç¢ºèª
âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–æˆåŠŸ
âœ… ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—
âœ… ãƒšãƒ³ã§æç”»å¯èƒ½
âœ… ãƒšãƒ³å…¥åŠ›ä½ç½®ã¨ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»ä½ç½®ãŒ1pxä»¥å†…ã§ä¸€è‡´
âœ… çŸ­ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ï¼ˆ10pxï½100pxï¼‰ãŒæ­£ç¢ºã«æç”»ã•ã‚Œã‚‹
âœ… é•·ã„ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ï¼ˆ1000pxä»¥ä¸Šï¼‰ã§ã‚‚å¤‰å½¢ã—ãªã„
âœ… ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³æ“ä½œä¸‹ã§ã‚‚æ­£ç¢ºã«æç”»ã•ã‚Œã‚‹
âœ… è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§æç”»ã—ã¦ã‚‚å•é¡Œãªã„
âœ… åº§æ¨™ç³»ãŒæ˜ç¢ºã«åŒºåˆ¥ã•ã‚Œã¦ã„ã‚‹
âœ… äºŒé‡å¤‰æ›ãŒç™ºç”Ÿã—ã¦ã„ãªã„
âœ… WebGPUæ®‹éª¸ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹

### æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºæº–å‚™
âœ… ãƒãƒªã‚´ãƒ³ãƒšãƒ³ã®å®Œå…¨å®‰å®šåŒ–å®Œäº†
â†’ ç­†åœ§å¯¾å¿œå®Ÿè£…æº–å‚™
â†’ æ¶ˆã—ã‚´ãƒ çµ±åˆå®Ÿè£…æº–å‚™
â†’ SDF/WSDFå®Ÿè£…æº–å‚™

================================================================================
å¾©æ—§è¨ˆç”»æ›¸ END
ä½œæˆè€…: Claude (Anthropic)
å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: WebGL2 Polygon Pen Drawing Tool
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v24 Phase 1 æç”»ä¸èƒ½çŠ¶æ…‹å¾©æ—§ç‰ˆ
================================================================================