<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® Fixed Phase2b5 - PixiJS v8.13 „ÅäÁµµ„Åã„Åç„ÉÑ„Éº„É´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --futaba-maroon: #800000;
            --futaba-light-maroon: #aa5a56;
            --futaba-medium: #cf9c97;
            --futaba-light-medium: #e9c2ba;
            --futaba-cream: #f0e0d6;
            --futaba-background: #ffffee;
            --text-primary: #2c1810;
            --text-secondary: #5d4037;
            --text-inverse: #ffffff;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: var(--futaba-background);
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 50px 1fr;
            height: 100vh;
            width: 100vw;
            gap: 0;
        }
        
        .sidebar {
            background: var(--futaba-cream);
            border-right: 2px solid var(--futaba-light-medium);
            display: flex;
            flex-direction: column;
            padding: 12px 6px;
            gap: 4px;
            overflow-y: auto;
            position: relative;
            z-index: 100;
        }
        
        .tool-button {
            width: 36px;
            height: 36px;
            border: 2px solid var(--futaba-light-medium);
            background: var(--futaba-background);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--futaba-maroon);
            position: relative;
            user-select: none;
        }
        
        .tool-button svg { width: 20px; height: 20px; stroke: #800000; }
        
        .tool-button:hover {
            background: var(--futaba-medium);
            border-color: var(--futaba-light-maroon);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(128, 0, 0, 0.2);
        }
        
        .tool-button.active {
            background: var(--futaba-maroon);
            color: var(--text-inverse);
            border-color: var(--futaba-maroon);
            box-shadow: 0 2px 8px rgba(128, 0, 0, 0.3);
        }
        
        .tool-button.active svg { stroke: #ffffff; }
        
        .tool-separator {
            height: 1px;
            background: var(--futaba-light-medium);
            margin: 4px 2px;
        }
        
        .canvas-area {
            background: var(--futaba-background);
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #drawing-canvas {
            border: none;
            display: block;
            cursor: crosshair;
            touch-action: none;
        }
        
        .layer-panel-container {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        
        .layer-add-button {
            width: 36px;
            height: 36px;
            background: var(--futaba-cream);
            border: 2px solid var(--futaba-light-medium);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(128, 0, 0, 0.1);
            pointer-events: all;
        }
        
        .layer-add-button:hover {
            background: var(--futaba-medium);
            transform: scale(1.1);
        }
        
        .layer-add-button svg { width: 18px; height: 18px; stroke: #800000; }
        
        .layer-panel-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: transparent;
            border-radius: 8px;
            padding: 8px;
            pointer-events: all;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .layer-item {
            width: 180px;
            height: 64px;
            background: var(--futaba-cream);
            border: 1px solid var(--futaba-light-medium);
            border-radius: 6px;
            padding: 6px 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            display: grid;
            grid-template-columns: 20px 1fr auto;
            grid-template-rows: 1fr 1fr;
            gap: 4px 8px;
            align-items: center;
            user-select: none;
            position: relative;
            box-shadow: 0 1px 2px rgba(128, 0, 0, 0.05);
        }
        
        .layer-item:hover {
            border-color: var(--futaba-medium);
            background: var(--futaba-background);
        }
        
        .layer-item.active {
            border-color: var(--futaba-maroon);
            background: var(--futaba-light-medium);
            box-shadow: 0 2px 4px rgba(128, 0, 0, 0.15);
        }
        
        .sortable-ghost {
            opacity: 0.3;
            background: rgba(100, 150, 255, 0.15) !important;
            border: 2px dashed #6496ff !important;
            transform: rotate(2deg);
        }
        
        .sortable-chosen {
            background: rgba(100, 150, 255, 0.08) !important;
            border-color: #6496ff !important;
            box-shadow: 0 4px 12px rgba(100, 150, 255, 0.2) !important;
        }
        
        .layer-visibility {
            grid-column: 1;
            grid-row: 1 / 3;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
            align-self: center;
        }
        
        .layer-visibility:hover { background: var(--futaba-light-medium); }
        .layer-visibility svg { width: 16px; height: 16px; stroke: #800000; }
        .layer-visibility.hidden svg { opacity: 0.3; }
        
        .layer-opacity {
            grid-column: 2;
            grid-row: 1;
            font-size: 10px;
            color: var(--text-secondary);
            font-family: monospace;
            align-self: start;
            margin-top: 2px;
        }
        
        .layer-name {
            grid-column: 2;
            grid-row: 2;
            font-size: 12px;
            color: var(--text-primary);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            align-self: end;
            margin-bottom: 2px;
            max-width: calc(100% - 8px);
        }
        
        .layer-thumbnail {
            grid-column: 3;
            grid-row: 1 / 3;
            min-width: 24px;
            max-width: 72px;
            height: 48px;
            background: var(--futaba-background);
            border: 1px solid var(--futaba-light-medium);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            align-self: center;
            flex-shrink: 0;
        }
        
        .layer-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 3px;
            transition: opacity 0.2s ease;
        }
        
        .layer-thumbnail-placeholder {
            width: 24px;
            height: 24px;
            background: var(--futaba-light-medium);
            border-radius: 2px;
            opacity: 0.5;
        }
        
        .status-panel {
            position: fixed;
            bottom: 20px;
            left: 70px;
            right: 20px;
            background: var(--futaba-cream);
            border: 2px solid var(--futaba-medium);
            border-radius: 12px;
            padding: 8px 16px;
            font-family: monospace;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 16px rgba(128, 0, 0, 0.1);
            z-index: 50;
        }
        
        .status-group {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <div class="sidebar">
            <div class="tool-button" id="resize-tool" title="„É™„Çµ„Ç§„Ç∫">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#800000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M14 15H9v-5"/><path d="M16 3h5v5"/><path d="M21 3 9 15"/></svg>
            </div>
            
            <div class="tool-separator"></div>
                   
            <div class="tool-button active" id="pen-tool" title="„Éô„ÇØ„Çø„Éº„Éö„É≥ (P)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#800000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13 21h8"/><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg>
            </div>
            
            <div class="tool-button" id="eraser-tool" title="Ê∂à„Åó„Ç¥„É† (E)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#800000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21H8a2 2 0 0 1-1.42-.587l-3.994-3.999a2 2 0 0 1 0-2.828l10-10a2 2 0 0 1 2.829 0l5.999 6a2 2 0 0 1 0 2.828L12.834 21"/><path d="m5.082 11.09 8.828 8.828"/></svg>
            </div>
        </div>
        
        <div class="canvas-area">
            <div id="drawing-canvas"></div>
        </div>
    </div>
    
    <div class="layer-panel-container" id="layer-panel-container">
        <div class="layer-add-button" id="add-layer-btn" title="„É¨„Ç§„É§„ÉºËøΩÂä†">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#800000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="15" x2="15" y1="12" y2="18"/><line x1="12" x2="18" y1="15" y2="15"/><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2 2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
        </div>
        
        <div class="layer-panel-items" id="layer-list"></div>
    </div>
    
    <div class="status-panel">
        <div class="status-group">
            <div class="status-item">Canvas: <span id="canvas-info">400√ó400px</span></div>
            <div class="status-item">Tool: <span id="current-tool">„Éô„ÇØ„Çø„Éº„Éö„É≥</span></div>
            <div class="status-item">Layer: <span id="current-layer">„É¨„Ç§„É§„Éº0</span></div>
            <div class="status-item">Â∫ßÊ®ô: <span id="coordinates">x: 0, y: 0</span></div>
            <div class="status-item">Transform: <span id="transform-info">x:0 y:0 s:1.0 r:0¬∞</span></div>
            <div class="status-item">DPR: <span id="dpr-info">1.0</span></div>
        </div>
        
        <div class="status-group">
            <div class="status-item">FPS: <span id="fps">60</span></div>
            <div class="status-item">History: <span id="history-info">1/10</span></div>
        </div>
    </div>

    <!-- PixiJS v8.13 + ÊúâÁî®„Å™„É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„Åø -->
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@8.13.0/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Ë®≠ÂÆö„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø -->
    <script src="config.js"></script>
    
    <!-- Âü∫Êú¨‰æùÂ≠òÈñ¢‰øÇ„ÉÅ„Çß„ÉÉ„ÇØ -->
    <script>
function checkDependencies() {
    const dependencies = [
        { name: 'PIXI', obj: window.PIXI },
        { name: 'TEGAKI_CONFIG', obj: window.TEGAKI_CONFIG },
        { name: 'Sortable', obj: window.Sortable }
    ];
    
    const missing = dependencies.filter(dep => !dep.obj);
    
    if (missing.length > 0) {
        console.error('‚ùå Missing dependencies:', missing.map(d => d.name));
        throw new Error(`Dependencies not loaded: ${missing.map(d => d.name).join(', ')}`);
    }
    
    console.log('‚úÖ Basic dependencies loaded successfully');
    return true;
}

checkDependencies();
    </script>
    
    <!-- „Ç®„É≥„Ç∏„É≥„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø -->
    <script src="engine/coordinate-system.js"></script>
    <script src="engine/camera-system.js"></script>
    <script src="engine/layer-system.js"></script>
    <script src="engine/drawing-system.js"></script>
    <script src="ui/ui-state.js"></script>
    <script src="ui/ui-core.js"></script>
    <script src="core-runtime.js"></script>
    <script src="core-engine.js"></script>
    
    <!-- ===== Áµ±Âêà‰øÆÊ≠£„Éë„ÉÉ„ÉÅÈÅ©Áî® ===== -->
    <script>
// ===== Integration Fix Patch - Phase2b5 Complete Repair =====
// ÂàÜÂâ≤Áâà„ÅÆÂïèÈ°å„Çí‰øÆÊ≠£„Åó„ÄÅÂÖÉÁâà„ÅÆÊ©üËÉΩ„ÇíÂÆåÂÖ®Á∂ôÊâø

// === 1. ConfigÁµ±‰∏Ä„Éë„ÉÉ„ÉÅ ===
(function fixConfigReferences() {
    'use strict';
    
    console.log('üîß Applying config reference unification patch...');
    
    // TegakiConfig -> TEGAKI_CONFIG Áµ±‰∏Ä
    if (window.TEGAKI_CONFIG && !window.TegakiConfig) {
        window.TegakiConfig = window.TEGAKI_CONFIG;
        console.log('‚úÖ TegakiConfig reference unified');
    }
    
    // defaultWidth/Height Á¢∫‰øù
    if (window.TEGAKI_CONFIG?.canvas) {
        if (!window.TEGAKI_CONFIG.canvas.defaultWidth) {
            window.TEGAKI_CONFIG.canvas.defaultWidth = window.TEGAKI_CONFIG.canvas.width;
        }
        if (!window.TEGAKI_CONFIG.canvas.defaultHeight) {
            window.TEGAKI_CONFIG.canvas.defaultHeight = window.TEGAKI_CONFIG.canvas.height;
        }
    }
})();

// === 2. CoordinateSystem Áµ±Âêà„Éë„ÉÉ„ÉÅ ===
(function fixCoordinateSystem() {
    'use strict';
    
    console.log('üîß Applying coordinate system integration patch...');
    
    if (window.CoordinateSystem) {
        // ÂÖÉÁâà‰∫íÊèõ„É°„ÇΩ„ÉÉ„Éâ„ÇíËøΩÂä†
        window.CoordinateSystem.prototype.screenToCanvasForDrawing = function(screenX, screenY) {
            // ÂÖÉÁâà„Å®Âêå„ÅòÂ∫ßÊ®ôÂ§âÊèõ„ÇíÂÆüË°å
            const canvas = this.app.canvas || this.app.view;
            const rect = canvas.getBoundingClientRect();
            const localX = (screenX - rect.left) * (canvas.width / rect.width);
            const localY = (screenY - rect.top) * (canvas.height / rect.height);
            
            // canvasContainer„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„ÇíÈÄö„Åó„Å¶Â§âÊèõ
            const canvasContainer = this._canvasContainer || this.getCanvasContainer?.();
            if (canvasContainer) {
                return canvasContainer.toLocal({ x: localX, y: localY });
            }
            
            return { x: localX, y: localY };
        };
        
        // Ë®∫Êñ≠Ê©üËÉΩËøΩÂä†
        window.CoordinateSystem.diagnoseReferences = function() {
            return {
                worldContainerRef: !!(window.CoordinateSystem._worldContainer || window.CoordinateSystem.getWorldContainer),
                canvasContainerRef: !!(window.CoordinateSystem._canvasContainer || window.CoordinateSystem.getCanvasContainer),
                appRef: !!window.CoordinateSystem._app,
                screenToWorldAvailable: !!window.CoordinateSystem.prototype.screenToWorld,
                screenToCanvasForDrawingAvailable: !!window.CoordinateSystem.prototype.screenToCanvasForDrawing
            };
        };
        
        console.log('‚úÖ CoordinateSystem integration patch applied');
    }
})();

// === 3. CameraSystem ‰øÆÊ≠£„Éë„ÉÉ„ÉÅ ===
(function fixCameraSystem() {
    'use strict';
    
    console.log('üîß Applying camera system integration patch...');
    
    if (window.CameraSystem) {
        // „Éó„É≠„Éà„Çø„Ç§„Éó„Å´‰øÆÊ≠£„É°„ÇΩ„ÉÉ„Éâ„ÇíËøΩÂä†
        window.CameraSystem.prototype.screenToCanvasForDrawing = function(screenX, screenY) {
            if (this.canvasContainer) {
                const globalPoint = { x: screenX, y: screenY };
                return this.canvasContainer.toLocal(globalPoint);
            }
            
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöCoordinateSystem„Çí‰ΩøÁî®
            if (this.coord && this.coord.screenToCanvasForDrawing) {
                return this.coord.screenToCanvasForDrawing(screenX, screenY);
            }
            
            // ÊúÄÁµÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            const canvas = this.app.canvas || this.app.view;
            const rect = canvas.getBoundingClientRect();
            const localX = screenX - rect.left;
            const localY = screenY - rect.top;
            return { x: localX, y: localY };
        };
        
        // Â¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ‰øÆÊ≠£
        window.CameraSystem.prototype.isPointInExtendedCanvas = function(canvasPoint, margin = 50) {
            const config = window.TEGAKI_CONFIG || window.TegakiConfig;
            if (!config) return true;
            
            const width = config.canvas.defaultWidth || config.canvas.width || 400;
            const height = config.canvas.defaultHeight || config.canvas.height || 400;
            
            return canvasPoint.x >= -margin && 
                   canvasPoint.x <= width + margin &&
                   canvasPoint.y >= -margin && 
                   canvasPoint.y <= height + margin;
        };
        
        console.log('‚úÖ CameraSystem integration patch applied');
    }
})();

// === 4. DrawingSystem ‰øÆÊ≠£„Éë„ÉÉ„ÉÅ ===
(function fixDrawingSystem() {
    'use strict';
    
    console.log('üîß Applying drawing system integration patch...');
    
    if (window.DrawingSystem) {
        // „É¨„Ç§„É§„Éº„Éá„Éº„Çø‰∫íÊèõÊÄß„Éë„ÉÉ„ÉÅ
        window.DrawingSystem.prototype.addStrokeToActiveLayer = function(stroke) {
            const activeLayer = this.layerSystem?.getActiveLayer();
            if (!activeLayer) return;
            
            try {
                // ÂÖÉÁâà‰∫íÊèõ„ÅÆlayerData.pathsÊßãÈÄ†„Å´ËøΩÂä†
                if (!activeLayer.layerData) {
                    activeLayer.layerData = {
                        id: activeLayer.id || activeLayer.label || `layer_${Date.now()}`,
                        name: activeLayer.name || 'Layer',
                        visible: true,
                        opacity: 1.0,
                        paths: []
                    };
                }
                
                if (!activeLayer.layerData.paths) {
                    activeLayer.layerData.paths = [];
                }
                
                // stroke„ÇípathÂΩ¢Âºè„Å´Â§âÊèõ„Åó„Å¶ËøΩÂä†
                const pathData = {
                    id: stroke.id,
                    points: [...stroke.points],
                    color: stroke.color,
                    size: stroke.size,
                    opacity: stroke.opacity,
                    isComplete: stroke.isComplete,
                    graphics: stroke.graphics
                };
                
                activeLayer.layerData.paths.push(pathData);
                
                // „Ç≥„É≥„ÉÜ„Éä„Å´ËøΩÂä†
                if (activeLayer.addChild && stroke.graphics) {
                    activeLayer.addChild(stroke.graphics);
                }
                
            } catch (error) {
                console.error('DrawingSystem stroke addition failed:', error);
            }
        };
        
        // APIÁµ±‰∏Ä„Éë„ÉÉ„ÉÅ
        if (window.DrawingSystem.prototype.startStroke && !window.DrawingSystem.prototype.startDrawing) {
            window.DrawingSystem.prototype.startDrawing = window.DrawingSystem.prototype.startStroke;
        }
        if (window.DrawingSystem.prototype.continueStroke && !window.DrawingSystem.prototype.continueDrawing) {
            window.DrawingSystem.prototype.continueDrawing = window.DrawingSystem.prototype.continueStroke;
        }
        if (window.DrawingSystem.prototype.endStroke && !window.DrawingSystem.prototype.endDrawing) {
            window.DrawingSystem.prototype.endDrawing = window.DrawingSystem.prototype.endStroke;
        }
        
        console.log('‚úÖ DrawingSystem integration patch applied');
    }
})();

// === 5. LayerSystem ‰øÆÊ≠£„Éë„ÉÉ„ÉÅ ===
(function fixLayerSystem() {
    'use strict';
    
    console.log('üîß Applying layer system integration patch...');
    
    if (window.LayerSystem) {
        // ÂÖÉÁâà‰∫íÊèõ„ÅÆcreateLayer‰øÆÊ≠£
        window.LayerSystem.prototype.createLayer = function(name, isBackground = false) {
            try {
                const layer = new PIXI.Container();
                const layerId = `layer_${this.layerCounter || 0}`;
                this.layerCounter = (this.layerCounter || 0) + 1;
                
                layer.label = layerId;
                layer.layerData = {
                    id: layerId,
                    name: name,
                    visible: true,
                    opacity: 1.0,
                    isBackground: isBackground,
                    paths: []
                };

                // layerTransformsÂàùÊúüÂåñ
                if (!this.layerTransforms) {
                    this.layerTransforms = new Map();
                }
                this.layerTransforms.set(layerId, {
                    x: 0, y: 0, rotation: 0, scaleX: 1, scaleY: 1
                });

                if (isBackground) {
                    const config = window.TEGAKI_CONFIG || window.TegakiConfig || { canvas: { width: 400, height: 400 }, background: { color: 0xf0e0d6 } };
                    const bg = new PIXI.Graphics();
                    bg.rect(0, 0, config.canvas.width, config.canvas.height);
                    bg.fill(config.background.color);
                    layer.addChild(bg);
                    layer.layerData.backgroundGraphics = bg;
                }

                if (!this.layers) this.layers = [];
                this.layers.push(layer);
                
                if (this.layersContainer) {
                    this.layersContainer.addChild(layer);
                }

                return { layer, index: this.layers.length - 1 };
                
            } catch (error) {
                console.error('LayerSystem.createLayer failed:', error);
                return null;
            }
        };
        
        // getActiveLayerÁ¢∫‰øù
        if (!window.LayerSystem.prototype.getActiveLayer) {
            window.LayerSystem.prototype.getActiveLayer = function() {
                if (!this.layers || this.activeLayerIndex < 0 || this.activeLayerIndex >= this.layers.length) {
                    return null;
                }
                return this.layers[this.activeLayerIndex];
            };
        }
        
        // setActiveLayerÁ¢∫‰øù
        if (!window.LayerSystem.prototype.setActiveLayer) {
            window.LayerSystem.prototype.setActiveLayer = function(index) {
                if (index >= 0 && index < this.layers.length) {
                    this.activeLayerIndex = index;
                    if (this.updateLayerPanelUI) this.updateLayerPanelUI();
                    if (this.updateStatusDisplay) this.updateStatusDisplay();
                }
            };
        }
        
        // „Çµ„É†„Éç„Ç§„É´Êõ¥Êñ∞Á¢∫‰øù
        if (!window.LayerSystem.prototype.requestThumbnailUpdate) {
            window.LayerSystem.prototype.requestThumbnailUpdate = function(index) {
                if (!this.thumbnailUpdateQueue) this.thumbnailUpdateQueue = new Set();
                this.thumbnailUpdateQueue.add(index);
            };
        }
        
        if (!window.LayerSystem.prototype.processThumbnailUpdates) {
            window.LayerSystem.prototype.processThumbnailUpdates = function() {
                if (!this.thumbnailUpdateQueue || this.thumbnailUpdateQueue.size === 0) return;
                
                this.thumbnailUpdateQueue.forEach(layerIndex => {
                    console.log(`Processing thumbnail for layer: ${layerIndex}`);
                });
                this.thumbnailUpdateQueue.clear();
            };
        }
        
        console.log('‚úÖ LayerSystem integration patch applied');
    }
})();

// === 6. UIÁµ±Âêà„Éë„ÉÉ„ÉÅ ===
(function fixUIIntegration() {
    'use strict';
    
    console.log('üîß Applying UI integration patch...');
    
    // TegakiUIÁµ±ÂêàÁ¢∫‰øù
    if (!window.TegakiUI) {
        window.TegakiUI = {};
    }
    
    // updateLayerPanelUI Âü∫Êú¨ÂÆüË£Ö
    if (!window.TegakiUI.updateLayerPanelUI) {
        window.TegakiUI.updateLayerPanelUI = function(layerManager) {
            const layerList = document.getElementById('layer-list');
            if (!layerList || !layerManager.layers) return;

            layerList.innerHTML = '';

            for (let i = layerManager.layers.length - 1; i >= 0; i--) {
                const layer = layerManager.layers[i];
                const layerItem = document.createElement('div');
                layerItem.className = `layer-item ${i === layerManager.activeLayerIndex ? 'active' : ''}`;
                layerItem.dataset.layerId = layer.layerData?.id || layer.label;
                layerItem.dataset.layerIndex = i;

                layerItem.innerHTML = `
                    <div class="layer-visibility ${layer.layerData?.visible !== false ? '' : 'hidden'}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            ${layer.layerData?.visible !== false ? 
                                '<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>' :
                                '<path d="m15 18-.722-3.25"/><path d="m2 2 20 20"/>'}
                        </svg>
                    </div>
                    <div class="layer-opacity">100%</div>
                    <div class="layer-name">${layer.layerData?.name || 'Layer'}</div>
                    <div class="layer-thumbnail">
                        <div class="layer-thumbnail-placeholder"></div>
                    </div>
                `;

                layerItem.addEventListener('click', () => {
                    layerManager.setActiveLayer(i);
                });

                layerList.appendChild(layerItem);
            }
        };
    }
    
    // initializeSortable Âü∫Êú¨ÂÆüË£Ö
    if (!window.TegakiUI.initializeSortable) {
        window.TegakiUI.initializeSortable = function(layerManager) {
            const layerList = document.getElementById('layer-list');
            if (!layerList || !window.Sortable) return;

            const sortable = window.Sortable.create(layerList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: function (evt) {
                    const oldIndex = layerManager.layers.length - 1 - evt.newIndex;
                    const newIndex = layerManager.layers.length - 1 - evt.oldIndex;
                    
                    if (oldIndex !== newIndex && layerManager.layers) {
                        // „É¨„Ç§„É§„ÉºÈ†ÜÂ∫èÂ§âÊõ¥
                        const [movedLayer] = layerManager.layers.splice(oldIndex, 1);
                        layerManager.layers.splice(newIndex, 0, movedLayer);
                        
                        // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¨„Ç§„É§„Éº„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπË™øÊï¥
                        if (layerManager.activeLayerIndex === oldIndex) {
                            layerManager.activeLayerIndex = newIndex;
                        } else if (layerManager.activeLayerIndex === newIndex) {
                            layerManager.activeLayerIndex = oldIndex;
                        }
                        
                        layerManager.updateLayerPanelUI();
                    }
                }
            });
        };
    }
    
    console.log('‚úÖ UI integration patch applied');
})();

console.log('üéâ Integration Fix Patch Applied Successfully!');
    </script>
    
    <!-- „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ -->
    <script>
(function() {
    'use strict';
    
    // === ‰øÆÊ≠£ÁâàÔºöÁµ±Âêà„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ ===
    function checkCoreRuntime() {
        if (!window.CoreRuntime) {
            console.error('‚ùå CoreRuntime not loaded');
            return false;
        }
        
        if (!window.TegakiCore?.CoreEngine) {
            console.error('‚ùå TegakiCore.CoreEngine not found');
            return false;
        }
        
        console.log('‚úÖ CoreRuntime and TegakiCore loaded successfully');
        return true;
    }
    
    function initializeApp() {
        const CoreEngine = window.TegakiCore.CoreEngine;
        const CONFIG = window.TEGAKI_CONFIG;
        
        class FixedDrawingApp {
            constructor() {
                this.pixiApp = null;
                this.coreEngine = null;
            }
            
            async initialize() {
                const containerEl = document.getElementById('drawing-canvas');
                if (!containerEl) {
                    throw new Error('Canvas container not found');
                }
                
                // PixiJSÂàùÊúüÂåñ
                this.pixiApp = new PIXI.Application();
                
                const screenWidth = window.innerWidth - 50;
                const screenHeight = window.innerHeight;
                
                await this.pixiApp.init({
                    width: screenWidth,
                    height: screenHeight,
                    backgroundAlpha: 0,
                    resolution: 1,
                    antialias: true,
                    eventMode: 'static'
                });
                
                containerEl.innerHTML = '';
                containerEl.appendChild(this.pixiApp.canvas);
                
                this.pixiApp.canvas.style.width = `${screenWidth}px`;
                this.pixiApp.canvas.style.height = `${screenHeight}px`;
                
                // ‰øÆÊ≠£ÁâàCoreEngineÂàùÊúüÂåñ
                this.coreEngine = new CoreEngine(this.pixiApp);
                const drawingApp = this.coreEngine.initialize();
                
                // CoreRuntimeÂàùÊúüÂåñÔºà‰øÆÊ≠£ÁâàÔºâ
                if (window.CoreRuntime.init) {
                    try {
                        window.CoreRuntime.init({
                            app: this.pixiApp,
                            worldContainer: this.coreEngine.getCameraSystem().worldContainer,
                            canvasContainer: this.coreEngine.getCameraSystem().canvasContainer,
                            cameraSystem: this.coreEngine.getCameraSystem(),
                            layerManager: this.coreEngine.getLayerManager(),
                            drawingEngine: this.coreEngine.getDrawingEngine()
                        });
                        console.log('‚úÖ CoreRuntime initialized successfully');
                    } catch (error) {
                        console.warn('CoreRuntime initialization failed:', error);
                    }
                }
                
                // UIÂàùÊúüÂåñ
                if (window.TegakiUI) {
                    const layerManager = this.coreEngine.getLayerManager();
                    
                    // UI „É°„ÇΩ„ÉÉ„Éâ„ÅÆÁµ±Âêà
                    layerManager.updateLayerPanelUI = () => window.TegakiUI.updateLayerPanelUI(layerManager);
                    
                    // ÂàùÊúüUIÊõ¥Êñ∞
                    layerManager.updateLayerPanelUI();
                    
                    // SortableJSÂàùÊúüÂåñ
                    if (window.TegakiUI.initializeSortable) {
                        window.TegakiUI.initializeSortable(layerManager);
                    }
                }
                
                // „É¨„Ç§„É§„ÉºËøΩÂä†„Éú„Çø„É≥„Ç§„Éô„É≥„Éà
                const addLayerBtn = document.getElementById('add-layer-btn');
                if (addLayerBtn) {
                    addLayerBtn.addEventListener('click', () => {
                        const layerManager = this.coreEngine.getLayerManager();
                        const layerName = `„É¨„Ç§„É§„Éº${layerManager.layers.length}`;
                        const result = layerManager.createLayer(layerName);
                        if (result) {
                            layerManager.setActiveLayer(result.index);
                        }
                    });
                }
                
                // „ÉÑ„Éº„É´„Éú„Çø„É≥„Ç§„Éô„É≥„Éà
                document.getElementById('pen-tool')?.addEventListener('click', () => {
                    this.coreEngine.switchTool('pen');
                });
                
                document.getElementById('eraser-tool')?.addEventListener('click', () => {
                    this.coreEngine.switchTool('eraser');
                });
                
                // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫Âá¶ÁêÜ
                window.addEventListener('resize', () => {
                    const newWidth = window.innerWidth - 50;
                    const newHeight = window.innerHeight;
                    
                    this.pixiApp.renderer.resize(newWidth, newHeight);
                    this.pixiApp.canvas.style.width = `${newWidth}px`;
                    this.pixiApp.canvas.style.height = `${newHeight}px`;
                });
                
                // „Ç≠„É£„É≥„Éê„Çπ„É™„Çµ„Ç§„Ç∫Ê©üËÉΩ
                window.drawingAppResizeCanvas = (newWidth, newHeight) => {
                    console.log('Fixed DrawingApp: Canvas resize request:', newWidth, 'x', newHeight);
                    return this.coreEngine.resizeCanvas(newWidth, newHeight);
                };
                
                // ÊÉÖÂ†±Ë°®Á§∫„Éª„É¢„Éã„Çø„É™„É≥„Ç∞
                this.updateCanvasInfo();
                this.updateDPRInfo();
                this.startFPSMonitor();
                
                // „Ç∞„É≠„Éº„Éê„É´ÂèÇÁÖßË®≠ÂÆö
                window.drawingApp = drawingApp;
                
                return true;
            }
            
            updateCanvasInfo() {
                const element = document.getElementById('canvas-info');
                if (element) {
                    element.textContent = `${CONFIG.canvas.width}√ó${CONFIG.canvas.height}px`;
                }
            }
            
            updateDPRInfo() {
                const element = document.getElementById('dpr-info');
                if (element) {
                    element.textContent = (window.devicePixelRatio || 1).toFixed(1);
                }
            }
            
            startFPSMonitor() {
                let frameCount = 0;
                let lastTime = performance.now();
                
                const updateFPS = () => {
                    frameCount++;
                    const currentTime = performance.now();
                    
                    if (currentTime - lastTime >= 1000) {
                        const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                        const element = document.getElementById('fps');
                        if (element) element.textContent = fps;
                        
                        frameCount = 0;
                        lastTime = currentTime;
                    }
                    
                    requestAnimationFrame(updateFPS);
                };
                
                updateFPS();
            }
        }
        
        return FixedDrawingApp;
    }
    
    // === DOMContentLoadedÊôÇ„ÅÆÂàùÊúüÂåñ ===
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            console.log('üöÄ Starting Fixed Phase2b5 initialization...');
            
            // Step 1: CoreRuntime‰æùÂ≠òÈñ¢‰øÇ„ÉÅ„Çß„ÉÉ„ÇØ
            if (!checkCoreRuntime()) {
                throw new Error('CoreRuntime initialization failed');
            }
            
            // Step 2: „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
            const DrawingApp = initializeApp();
            const app = new DrawingApp();
            await app.initialize();
            
            // Step 3: Â∫ßÊ®ôÁ≥ªË®∫Êñ≠ÂÆüË°å
            if (window.CoordinateSystem.diagnoseReferences) {
                const diagnosis = window.CoordinateSystem.diagnoseReferences();
                console.log('üîç Coordinate System Diagnosis:', diagnosis);
            }
            
            console.log('‚úÖ Fixed Phase2b5 SUCCESS: Drawing App initialized!');
            console.log('‚úÖ Integration patches applied and working');
            console.log('‚úÖ Pen drawing should now work correctly');
            console.log('‚úÖ Layer operations should function properly');
            console.log('‚úÖ Coordinate system unified and stable');
            
        } catch (error) {
            console.error('‚ùå Fixed Phase2b5 FAILED:', error);
            console.error('Stack trace:', error.stack);
            
            // „Ç®„É©„ÉºÊôÇ„ÅÆ‰ª£ÊõøË°®Á§∫
            const canvasArea = document.querySelector('.canvas-area');
            if (canvasArea) {
                canvasArea.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #800000; font-family: monospace;">
                        <h2>‚ö†Ô∏è ÂàùÊúüÂåñ„Ç®„É©„Éº</h2>
                        <p>„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</p>
                        <p>„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #800000; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            „É™„É≠„Éº„Éâ
                        </button>
                    </div>
                `;
            }
        }
    });
})();
    </script>
</body>
</html>