# Tegaki WebGL2 æ”¹ä¿®å®Ÿæ–½æ‰‹é †æ›¸

## ğŸ“‹ æº–å‚™

### 1. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
æ”¹ä¿®å‰ã«å¿…ãšå…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p webgl2_v27_backup

# å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
cp webgl2_v27/core-engine.js webgl2_v27_backup/
cp webgl2_v27/system/drawing/brush-core.js webgl2_v27_backup/
```

---

## ğŸ”§ Phase 1: ç·Šæ€¥ä¿®æ­£ï¼ˆæç”»æ©Ÿèƒ½å¾©æ—§ï¼‰

### Step 1-1: core-engine.js ã®ç½®ãæ›ãˆ

**ç›®çš„**: DrawingEngineåˆæœŸåŒ–ã®è¿½åŠ 

**æ‰‹é †**:
1. Artifactsã‹ã‚‰ `core-engine.js (Phase 5ä¿®æ­£ç‰ˆ)` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
2. `webgl2_v27/core-engine.js` ã‚’ç½®ãæ›ãˆ
3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜

**å¤‰æ›´ç‚¹ã‚µãƒãƒªãƒ¼**:
- `_initializeDrawingEngine()` ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
- `initialize()` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§DrawingEngineåˆæœŸåŒ–å‘¼ã³å‡ºã—è¿½åŠ 
- PointerHandlerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã¨æ¥ç¶š
- åˆæœŸåŒ–ãƒ­ã‚°ã®è©³ç´°åŒ–

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**:
```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
// "[CoreEngine] [Phase 5] Initializing DrawingEngine..."
// "[CoreEngine] âœ… DrawingEngine initialized successfully"
```

---

### Step 1-2: brush-core.js ã®ç½®ãæ›ãˆ

**ç›®çš„**: BrushCoreåˆæœŸåŒ–ã®æ”¹å–„

**æ‰‹é †**:
1. Artifactsã‹ã‚‰ `brush-core.js (Phase 2.3ä¿®æ­£ç‰ˆ)` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
2. `webgl2_v27/system/drawing/brush-core.js` ã‚’ç½®ãæ›ãˆ
3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜

**å¤‰æ›´ç‚¹ã‚µãƒãƒªãƒ¼**:
- `_updateWebGL2Components()` ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
- åˆæœŸåŒ–é‡è¤‡å‘¼ã³å‡ºã—å¯¾å¿œ
- Phase 2.2ã®ã‚¹ã‚±ãƒ¼ãƒ«ä¿®æ­£ã‚’ç¶™æ‰¿

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**:
```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
// "[BrushCore] âœ… Initialization complete"
// "[BrushCore] WebGL2 components updated"
```

---

### Step 1-3: debug-utils.js ã®è¿½åŠ 

**ç›®çš„**: ãƒ‡ãƒãƒƒã‚°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®å°å…¥

**æ‰‹é †**:
1. Artifactsã‹ã‚‰ `debug-utils.js (Phase 3æ–°è¦)` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
2. `webgl2_v27/system/debug-utils.js` ã¨ã—ã¦ä¿å­˜
3. `index.html` ã«èª­ã¿è¾¼ã¿ã‚’è¿½åŠ 

**index.html ä¿®æ­£ç®‡æ‰€**:
```html
<!-- ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
<script src="system/event-bus.js"></script>
<script src="system/data-models.js"></script>
<script src="system/batch-api.js"></script>
<!-- â­ è¿½åŠ  -->
<script src="system/debug-utils.js"></script>
```

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**:
```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
TegakiDebug.help()
// ãƒ˜ãƒ«ãƒ—ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OK
```

---

## âœ… Phase 1å®Œäº†å¾Œã®å‹•ä½œç¢ºèª

### 1. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ç¢ºèª

**æ‰‹é †**:
1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `index.html` ã‚’é–‹ãï¼ˆã¾ãŸã¯ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
2. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ãï¼ˆF12ï¼‰
3. ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°**:
```
âœ… core-engine.js Phase 5 DrawingEngineåˆæœŸåŒ–çµ±åˆç‰ˆ loaded
âœ… brush-core.js Phase 2.3 åˆæœŸåŒ–çµ±åˆæ”¹å–„ç‰ˆ loaded
âœ… debug-utils.js loaded
[CoreEngine] ========================================
[CoreEngine] Starting initialization sequence...
[CoreEngine] ========================================
[CoreEngine] [1/8] Initializing CameraSystem...
âœ… CameraSystem initialized
...
[CoreEngine] [Phase 5] Initializing DrawingEngine...
âœ… DrawingEngine initialized successfully
[CoreEngine] ========================================
âœ… Initialization complete!
[CoreEngine] ========================================
```

---

### 2. åˆæœŸåŒ–è¨ºæ–­

**ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ**:
```javascript
TegakiDebug.checkInitialization()
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
```
ğŸ” Tegaki Initialization Check
âœ… CoordinateSystem: OK
âœ… CameraSystem: OK
âœ… LayerManager: OK
âœ… DrawingEngine: OK
âœ… PointerHandler: OK
âœ… BrushCore: OK
âœ… StrokeRecorder: OK
âœ… WebGL2: OK
âœ… EventBus: OK
âœ… All systems initialized correctly!
```

**ã‚‚ã—ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆ**:
```javascript
// è©³ç´°è¨ºæ–­å®Ÿè¡Œ
TegakiDebug.fullDiagnostic()
```

---

### 3. æç”»ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ

**ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ**:
```javascript
TegakiDebug.testDrawingFlow()
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
```
ğŸ¨ Drawing Flow Test
âœ… Step 1: DrawingEngine OK
âœ… Step 2: PointerHandler OK
âœ… Step 3: Coordinate transform successful
âœ… Step 4: BrushCore OK
âœ… Step 5: WebGL2 MSDF Pipeline OK
âœ… All steps passed! Drawing should work.
```

---

### 4. å®Ÿéš›ã®æç”»ãƒ†ã‚¹ãƒˆ

**æ‰‹é †**:
1. WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã§ãƒã‚¦ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚’æã
3. ãƒã‚¦ã‚¹ã‚’é›¢ã™

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ**:
- âœ… ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ãƒã‚¦ã‚¹ã‚’é›¢ã™ã¨ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãŒç¢ºå®šã•ã‚Œã‚‹
- âœ… æç”»ãŒæ®‹ã‚‹

**ã‚‚ã—æç”»ã§ããªã„å ´åˆ**:
```javascript
// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–
window.drawingEngine.setDebugMode(true)

// å†åº¦æç”»ãƒ†ã‚¹ãƒˆ
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹
```

---

### 5. åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ

**ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ**:
```javascript
// ãƒã‚¦ã‚¹ä½ç½®ã§ãƒ†ã‚¹ãƒˆï¼ˆä¾‹: x=200, y=200ï¼‰
TegakiDebug.testCoordinateTransform(200, 200)
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
```
ğŸ“ Coordinate Transform Test
Input: {clientX: 200, clientY: 200}
âœ… Transform successful:
  Canvas: {x: ..., y: ...}
  World: {x: ..., y: ...}
  Local: {x: ..., y: ...}
```

---

## ğŸ›¡ï¸ Phase 2: å®‰å®šæ€§å‘ä¸Šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

Phase 1ã§æç”»ãŒå‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã‚‰ã€Phase 2ã¯å¾Œæ—¥å®Ÿæ–½ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

### Step 2-1: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

ã™ã§ã« `core-engine.js Phase 5ä¿®æ­£ç‰ˆ` ã«å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

### Step 2-2: åˆæœŸåŒ–ãƒ­ã‚°ã®ç¢ºèª

åˆæœŸåŒ–æ™‚ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã€è­¦å‘ŠãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

---

## ğŸ“Š ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: "WebGL2 canvas not found" ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**:
```
[CoreEngine] âŒ WebGL2 canvas not found
```

**åŸå› **: `#webgl2-canvas` ãŒå­˜åœ¨ã—ãªã„

**å¯¾å‡¦æ³•**:
```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèª
document.querySelector('#webgl2-canvas')
// null ã®å ´åˆã€DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„

// åˆ©ç”¨å¯èƒ½ãªcanvasã‚’ç¢ºèª
Array.from(document.querySelectorAll('canvas')).map(c => c.id || c.className)
```

**è§£æ±ºç­–**: index.htmlã§canvasã®idå±æ€§ã‚’ç¢ºèª

---

### å•é¡Œ2: "CoordinateSystem not initialized" è­¦å‘Š

**ç—‡çŠ¶**:
```
[CoreEngine] âš ï¸ CoordinateSystem not initialized yet
```

**åŸå› **: worldContainerãŒæœªç”Ÿæˆ

**å¯¾å‡¦æ³•**:
```javascript
// çŠ¶æ…‹ç¢ºèª
window.CoordinateSystem.dumpState()

// worldContainerç¢ºèª
window.cameraSystem?.worldContainer
```

**è§£æ±ºç­–**: 
- Phase 1.2.2ã§æ—¢ã«å¯¾å‡¦æ¸ˆã¿
- é…å»¶åˆæœŸåŒ–ã§è‡ªå‹•çš„ã«è§£æ±ºã•ã‚Œã‚‹

---

### å•é¡Œ3: PointerEventãŒå–å¾—ã§ããªã„

**ç—‡çŠ¶**: ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ä½•ã‚‚èµ·ã“ã‚‰ãªã„

**è¨ºæ–­**:
```javascript
// PointerHandlerç¢ºèª
console.log('PointerHandler:', window.drawingEngine?.pointerHandler)

// attachedç¢ºèª
console.log('Attached:', window.drawingEngine?.pointerHandler?.attached)

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç¢ºèª
TegakiDebug.checkEventListeners()
```

**å¯¾å‡¦æ³•**:
```javascript
// æ‰‹å‹•ã§PointerHandlerãƒ†ã‚¹ãƒˆ
const glCanvas = document.querySelector('#webgl2-canvas')
const testHandler = new window.PointerHandler(glCanvas)
testHandler.on('pointerdown', (e) => console.log('Test pointerdown:', e))
// ã“ã®å¾Œã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ­ã‚°ãŒå‡ºã‚‹ã‹ç¢ºèª
```

---

### å•é¡Œ4: BrushCoreåˆæœŸåŒ–å¤±æ•—

**ç—‡çŠ¶**:
```
[BrushCore] strokeRecorder not found
[BrushCore] layerManager not found
```

**å¯¾å‡¦æ³•**:
```javascript
// ä¾å­˜é–¢ä¿‚ç¢ºèª
console.log({
  strokeRecorder: !!window.strokeRecorder,
  layerManager: !!window.layerManager,
  eventBus: !!window.TegakiEventBus
})

// å†åˆæœŸåŒ–è©¦è¡Œ
await window.BrushCore.initialize()
```

---

### å•é¡Œ5: MSDF Pipeline not available

**ç—‡çŠ¶**:
```
[BrushCore] âš ï¸ WebGL2 MSDF Pipeline not fully available
```

**è¨ºæ–­**:
```javascript
TegakiDebug.checkWebGL2()
```

**å¯¾å‡¦æ³•**:
- WebGL2é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- `index.html` ã®scriptã‚¿ã‚°ã®é †åºã‚’ç¢ºèª
- WebGL2å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã‹ã©ã†ã‹ç¢ºèª

---

## ğŸ“ˆ æ€§èƒ½ç¢ºèª

### FPSç¢ºèª

**è¡¨ç¤ºå ´æ‰€**: ç”»é¢å³ä¸‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º

**æœŸå¾…å€¤**:
- ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚: 60 FPS
- æç”»ä¸­: 40-60 FPS

**ã‚‚ã—FPSãŒä½ã„å ´åˆ**:
```javascript
// ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ«ãƒ¼ãƒ—ç¢ºèª
console.log('Render loop running:', window.coreEngine?.isRenderLoopRunning)

// æ‰‹å‹•ã§FPSæ¸¬å®š
let lastTime = performance.now()
let frameCount = 0
const measureFPS = () => {
    frameCount++
    const now = performance.now()
    if (now - lastTime >= 1000) {
        console.log('FPS:', frameCount)
        frameCount = 0
        lastTime = now
    }
    requestAnimationFrame(measureFPS)
}
measureFPS()
```

---

## ğŸ¯ å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1å®Œäº†æ¡ä»¶
- [ ] core-engine.js ã‚’ç½®ãæ›ãˆãŸ
- [ ] brush-core.js ã‚’ç½®ãæ›ãˆãŸ
- [ ] debug-utils.js ã‚’è¿½åŠ ã—ãŸ
- [ ] index.html ã«debug-utils.jsã‚’èª­ã¿è¾¼ã‚“ã 
- [ ] ãƒšãƒ¼ã‚¸ãŒã‚¨ãƒ©ãƒ¼ãªãèª­ã¿è¾¼ã¾ã‚Œã‚‹
- [ ] `TegakiDebug.checkInitialization()` ãŒã™ã¹ã¦âœ…
- [ ] `TegakiDebug.testDrawingFlow()` ãŒæˆåŠŸ
- [ ] å®Ÿéš›ã«æç”»ãŒã§ãã‚‹
- [ ] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãŒç¢ºå®šã•ã‚Œã‚‹

### Phase 2å®Œäº†æ¡ä»¶ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- [ ] åˆæœŸåŒ–ãƒ­ã‚°ã«è­¦å‘ŠãŒãªã„
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å‹•ä½œ
- [ ] åˆæœŸåŒ–å¤±æ•—æ™‚ã®ãƒªãƒˆãƒ©ã‚¤ãŒå‹•ä½œ

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

### ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

```javascript
// å®Œå…¨è¨ºæ–­
TegakiDebug.fullDiagnostic()

// åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯
TegakiDebug.checkInitialization()

// æç”»ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
TegakiDebug.testDrawingFlow()

// åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ
TegakiDebug.testCoordinateTransform(x, y)

// WebGL2ç¢ºèª
TegakiDebug.checkWebGL2()

// æç”»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
TegakiDebug.simulateDrawing()

// DrawingEngineçŠ¶æ…‹ç¢ºèª
window.drawingEngine?.inspect()

// CoordinateSystemçŠ¶æ…‹ç¢ºèª
window.CoordinateSystem?.dumpState()

// ãƒ˜ãƒ«ãƒ—
TegakiDebug.help()
```

### ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š

```javascript
// DrawingEngineãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
window.drawingEngine.setDebugMode(true)  // è©³ç´°ãƒ­ã‚°æœ‰åŠ¹
window.drawingEngine.setDebugMode(false) // ç„¡åŠ¹

// CoordinateSystemãƒ‡ãƒãƒƒã‚°
// coordinate-system.js å†…ã® DEBUG = true ã«å¤‰æ›´
```

---

## ğŸ‰ å®Œäº†

Phase 1ã®æ”¹ä¿®ãŒå®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼š

âœ… ãƒšãƒ³ã§ã®æç”»
âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
âœ… MSDFæç”»
âœ… åº§æ¨™å¤‰æ›ã®æ­£ç¢ºæ€§
âœ… PointerEventã®å–å¾—
âœ… ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰ã®åˆ©ç”¨

ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼