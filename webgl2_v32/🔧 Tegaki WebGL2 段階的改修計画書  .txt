# Tegaki WebGL2 æ®µéšçš„æ”¹ä¿®è¨ˆç”»æ›¸

## ğŸ¯ å•é¡Œã®æ ¹æœ¬åŸå› 

**æç”»ãŒã§ããªã„ç†ç”±**:
1. âŒ DrawingEngine.initialize() ãŒå‘¼ã°ã‚Œã¦ã„ãªã„
2. âŒ PointerHandler ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ãªã„
3. âŒ WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹ã¸ã®PointerEventãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

â†’ **çµæœ**: PointerEventãŒå–å¾—ã§ããšã€æç”»é–‹å§‹ã§ããªã„

---

## ğŸ“‹ æ”¹ä¿®ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1: ç·Šæ€¥ä¿®æ­£ï¼ˆæç”»æ©Ÿèƒ½å¾©æ—§ï¼‰ âš¡
**ç›®æ¨™**: æœ€å°é™ã®ä¿®æ­£ã§æç”»ã‚’å‹•ä½œã•ã›ã‚‹

#### Step 1-1: DrawingEngineåˆæœŸåŒ–ã®è¿½åŠ 
**ãƒ•ã‚¡ã‚¤ãƒ«**: `core-engine.js`
**ç®‡æ‰€**: `initialize()` ãƒ¡ã‚½ãƒƒãƒ‰å†…

**ä¿®æ­£å†…å®¹**:
```javascript
// ç¾åœ¨ï¼ˆâŒå‹•ä½œã—ãªã„ï¼‰
this.drawingEngine = new DrawingEngine(
    this.app,
    this.layerSystem,
    this.cameraSystem,
    window.History
);

// ä¿®æ­£å¾Œï¼ˆâœ…å‹•ä½œã™ã‚‹ï¼‰
this.drawingEngine = new DrawingEngine(
    this.app,
    this.layerSystem,
    this.cameraSystem,
    window.History
);

// â­ è¿½åŠ : WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹å–å¾—
const glCanvas = document.querySelector('#webgl2-canvas');
if (!glCanvas) {
    console.error('[CoreEngine] WebGL2 canvas not found');
    throw new Error('WebGL2 canvas required');
}

// â­ è¿½åŠ : PointerHandlerä½œæˆ
const pointerHandler = new window.PointerHandler(glCanvas, {
    preventDefault: true,
    capture: false
});

// â­ è¿½åŠ : DrawingEngineåˆæœŸåŒ–
const engineInitSuccess = this.drawingEngine.initialize({
    coordSystem: window.CoordinateSystem,
    cameraSystem: this.cameraSystem,
    layerManager: this.layerSystem,
    brushCore: window.BrushCore,
    pointerHandler: pointerHandler,
    eventBus: this.eventBus,
    glCanvas: glCanvas
});

if (!engineInitSuccess) {
    console.error('[CoreEngine] DrawingEngine initialization failed');
    throw new Error('DrawingEngine initialization required');
}

console.log('[CoreEngine] âœ… DrawingEngine initialized successfully');
```

**æŒ¿å…¥ä½ç½®**: `window.BrushCore.init()` ã®ç›´å¾Œ

---

#### Step 1-2: DrawingEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ç°¡ç•¥åŒ–
**ãƒ•ã‚¡ã‚¤ãƒ«**: `drawing-engine.js`

**å•é¡Œ**: ç¾åœ¨ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå¼•æ•°ã‚’å–ã£ã¦ã„ã‚‹ãŒã€core-engine.jsã‹ã‚‰æ¸¡ã•ã‚Œã¦ã„ãªã„

**ä¿®æ­£å†…å®¹**:
```javascript
// ç¾åœ¨
constructor() {
    this.initialized = false;
    // ...
}

// ãã®ã¾ã¾ç¶­æŒï¼ˆå¤‰æ›´ãªã—ï¼‰
// ä»£ã‚ã‚Šã« core-engine.js å´ã§ initialize() ã‚’å‘¼ã¶
```

**ç†ç”±**: ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯å¤‰æ›´ã›ãšã€initialize()ã§ä¾å­˜æ³¨å…¥ã™ã‚‹è¨­è¨ˆã‚’ç¶­æŒ

---

#### Step 1-3: åˆæœŸåŒ–é †åºã®ç¢ºèª
**ãƒ•ã‚¡ã‚¤ãƒ«**: `core-initializer.js`

**ç¢ºèªäº‹é …**:
- CoordinateSystem.initialize() ãŒ CoreEngine.initialize() ã®å¾Œã«å‘¼ã°ã‚Œã¦ã„ã‚‹ã‹
- worldContainer ãŒç¢ºå®Ÿã«å­˜åœ¨ã—ã¦ã„ã‚‹ã‹

**ç¾çŠ¶**: âœ… Phase 1.2.2ã§æ—¢ã«ä¿®æ­£æ¸ˆã¿

**è¿½åŠ æ¤œè¨¼**:
```javascript
// core-initializer.js ã® DrawingApp.initialize() å†…
// CoordinateSystemåˆæœŸåŒ–å¾Œã«è¿½åŠ 
if (!coordInitSuccess) {
    console.warn('[CoreInit] âš ï¸ CoordinateSystem initialization failed');
    // â­ è¿½åŠ : å¤±æ•—æ™‚ã®è©³ç´°è¨ºæ–­
    console.log('[CoreInit] Diagnostic:', {
        glCanvas: !!document.querySelector('#webgl2-canvas'),
        cameraSystem: !!cameraSystem,
        worldContainer: !!cameraSystem?.worldContainer,
        CoordinateSystem: !!window.CoordinateSystem
    });
}
```

---

### Phase 2: å®‰å®šæ€§å‘ä¸Š ğŸ›¡ï¸
**ç›®æ¨™**: åˆæœŸåŒ–ã®å …ç‰¢æ€§ã‚’é«˜ã‚ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„

#### Step 2-1: BrushCoreåˆæœŸåŒ–ã®ä¸€æœ¬åŒ–
**å•é¡Œ**: BrushCore.init() ãŒè¤‡æ•°ç®‡æ‰€ã§å‘¼ã°ã‚Œã¦ã„ã‚‹
- core-engine.js: `window.BrushCore.init()`
- core-initializer.js: `window.BrushCore.initialize()` (WebGL2ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­å®šå¾Œ)

**ä¿®æ­£æ–¹é‡**:
1. core-engine.js ã§ã® init() ã‚’ç¶­æŒï¼ˆåŸºæœ¬åˆæœŸåŒ–ï¼‰
2. core-initializer.js ã§ã® WebGL2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­å®šã‚’çµ±åˆ
3. BrushCore ã«åˆæœŸåŒ–æ¸ˆã¿ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `brush-core.js`

**ä¿®æ­£å†…å®¹**:
```javascript
async initialize() {
    if (this.initialized) {
        console.warn('[BrushCore] Already initialized, skipping base init');
        // â­ å¤‰æ›´: æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã¯WebGL2ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ›´æ–°ã®ã¿
        this._updateWebGL2Components();
        return;
    }

    // åŸºæœ¬åˆæœŸåŒ–
    this.strokeRecorder = window.strokeRecorder || window.StrokeRecorder;
    this.layerManager = window.layerManager || window.layerSystem;
    this.eventBus = window.TegakiEventBus || window.eventBus;

    if (!this.strokeRecorder) {
        throw new Error('[BrushCore] strokeRecorder not found');
    }
    if (!this.layerManager) {
        throw new Error('[BrushCore] layerManager not found');
    }

    // WebGL2ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ›´æ–°
    this._updateWebGL2Components();

    this._setupEventListeners();
    this.initialized = true;
}

// â­ æ–°è¦è¿½åŠ 
_updateWebGL2Components() {
    this.glStrokeProcessor = window.GLStrokeProcessor;
    this.glMSDFPipeline = window.GLMSDFPipeline;
    this.textureBridge = window.GLTextureBridge || window.WebGPUTextureBridge;
    this.glMaskLayer = window.GLMaskLayer;

    this.msdfAvailable = !!(
        this.glStrokeProcessor &&
        this.glMSDFPipeline &&
        this.textureBridge
    );

    this.maskAvailable = !!(this.glMaskLayer && this.glMaskLayer.initialized);

    console.log('[BrushCore] WebGL2 components updated:', {
        msdfAvailable: this.msdfAvailable,
        maskAvailable: this.maskAvailable
    });
}
```

---

#### Step 2-2: åˆæœŸåŒ–å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
**ãƒ•ã‚¡ã‚¤ãƒ«**: `drawing-engine.js`

**ä¿®æ­£å†…å®¹**:
```javascript
initialize(dependencies) {
    if (this.initialized) {
        console.warn('[DrawingEngine] Already initialized');
        return true;
    }

    this._initAttempts++;

    const {
        coordSystem,
        cameraSystem,
        layerManager,
        brushCore,
        pointerHandler,
        eventBus,
        glCanvas
    } = dependencies;

    // å¿…é ˆä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    const missing = [];
    if (!coordSystem) missing.push('coordSystem');
    if (!cameraSystem) missing.push('cameraSystem');
    if (!layerManager) missing.push('layerManager');
    if (!brushCore) missing.push('brushCore');
    if (!pointerHandler) missing.push('pointerHandler');
    if (!eventBus) missing.push('eventBus');
    if (!glCanvas) missing.push('glCanvas');

    if (missing.length > 0) {
        console.error('[DrawingEngine] Missing dependencies:', missing);
        console.log(`[DrawingEngine] Init attempt ${this._initAttempts}/${this._maxInitAttempts}`);
        
        // â­ è¿½åŠ : å†è©¦è¡Œãƒ­ã‚¸ãƒƒã‚¯
        if (this._initAttempts < this._maxInitAttempts) {
            console.log('[DrawingEngine] Scheduling retry in 500ms...');
            setTimeout(() => {
                console.log('[DrawingEngine] Retrying initialization...');
                // å‘¼ã³å‡ºã—å…ƒã«å†è©¦è¡Œã‚’ä¿ƒã™
                this.eventBus?.emit('drawing-engine:init-retry-needed', {
                    attempt: this._initAttempts,
                    missing: missing
                });
            }, 500);
        }
        
        return false;
    }

    // ... ä»¥é™ã®åˆæœŸåŒ–å‡¦ç†
}
```

---

### Phase 3: ä¿å®ˆæ€§å‘ä¸Š ğŸ“š
**ç›®æ¨™**: ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã‚’é«˜ã‚ã€å°†æ¥ã®æ”¹ä¿®ã‚’å®¹æ˜“ã«ã™ã‚‹

#### Step 3-1: åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼æ–‡æ›¸åŒ–
**ãƒ•ã‚¡ã‚¤ãƒ«**: `docs/initialization-flow.md` (æ–°è¦ä½œæˆ)

**å†…å®¹**:
```markdown
# Tegaki WebGL2 åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼

## 1. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
- index.html
  â””â”€ DOMContentLoaded
      â””â”€ CoreInitializer.initialize()

## 2. ä¾å­˜é–¢ä¿‚èª­ã¿è¾¼ã¿é †åº
1. config.js
2. coordinate-system.js
3. event-bus.js
4. ... (å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ)

## 3. åˆæœŸåŒ–ã‚·ãƒ¼ã‚±ãƒ³ã‚¹
ï¼ˆè©³ç´°ãªãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼‰

## 4. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
ï¼ˆã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•ï¼‰
```

---

#### Step 3-2: ãƒ‡ãƒãƒƒã‚°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®è¿½åŠ 
**ãƒ•ã‚¡ã‚¤ãƒ«**: `system/debug-utils.js` (æ–°è¦ä½œæˆ)

**å†…å®¹**:
```javascript
/**
 * debug-utils.js - é–‹ç™ºç”¨ãƒ‡ãƒãƒƒã‚°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */

(function() {
    'use strict';

    const TegakiDebug = {
        /**
         * åˆæœŸåŒ–çŠ¶æ…‹ã®åŒ…æ‹¬çš„ãƒã‚§ãƒƒã‚¯
         */
        checkInitialization() {
            console.group('ğŸ” Tegaki Initialization Check');

            const checks = {
                'CoordinateSystem': {
                    exists: !!window.CoordinateSystem,
                    initialized: window.CoordinateSystem?.initialized,
                    canvas: !!window.CoordinateSystem?.canvas,
                    worldContainer: !!window.CoordinateSystem?.worldContainer
                },
                'CameraSystem': {
                    exists: !!window.cameraSystem,
                    worldContainer: !!window.cameraSystem?.worldContainer
                },
                'LayerManager': {
                    exists: !!window.layerManager,
                    layers: window.layerManager?.getLayers()?.length
                },
                'DrawingEngine': {
                    exists: !!window.drawingEngine,
                    initialized: window.drawingEngine?.initialized,
                    coordSystem: !!window.drawingEngine?.coordSystem,
                    pointerHandler: !!window.drawingEngine?.pointerHandler,
                    brushCore: !!window.drawingEngine?.brushCore
                },
                'BrushCore': {
                    exists: !!window.BrushCore,
                    initialized: window.BrushCore?.initialized,
                    strokeRecorder: !!window.BrushCore?.strokeRecorder,
                    msdfAvailable: window.BrushCore?.msdfAvailable,
                    maskAvailable: window.BrushCore?.maskAvailable
                },
                'WebGL2': {
                    canvas: !!document.querySelector('#webgl2-canvas'),
                    DrawingLayer: !!window.WebGL2DrawingLayer,
                    StrokeProcessor: !!window.GLStrokeProcessor,
                    MSDFPipeline: !!window.GLMSDFPipeline
                }
            };

            let allGood = true;
            for (const [name, status] of Object.entries(checks)) {
                const issues = Object.entries(status)
                    .filter(([k, v]) => !v)
                    .map(([k]) => k);
                
                if (issues.length > 0) {
                    console.error(`âŒ ${name}:`, issues);
                    allGood = false;
                } else {
                    console.log(`âœ… ${name}: OK`);
                }
            }

            console.groupEnd();
            return allGood;
        },

        /**
         * æç”»ãƒ•ãƒ­ãƒ¼è¨ºæ–­
         */
        testDrawingFlow(x = 100, y = 100) {
            console.group('ğŸ¨ Drawing Flow Test');

            if (!window.drawingEngine) {
                console.error('âŒ DrawingEngine not found');
                console.groupEnd();
                return;
            }

            if (!window.drawingEngine.initialized) {
                console.error('âŒ DrawingEngine not initialized');
                console.groupEnd();
                return;
            }

            const result = window.drawingEngine.testCoordinateTransform(x, y);
            
            if (result) {
                console.log('âœ… Coordinate transform successful');
                console.log('Result:', result);
            } else {
                console.error('âŒ Coordinate transform failed');
            }

            console.groupEnd();
            return result;
        },

        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç¢ºèª
         */
        checkEventListeners() {
            const glCanvas = document.querySelector('#webgl2-canvas');
            if (!glCanvas) {
                console.error('âŒ WebGL2 canvas not found');
                return;
            }

            // getEventListeners() ã¯ Chrome DevTools ã§ã®ã¿åˆ©ç”¨å¯èƒ½
            console.log('Canvas element:', glCanvas);
            console.log('Try: getEventListeners($0) in DevTools Console');
        }
    };

    window.TegakiDebug = TegakiDebug;

    console.log('âœ… debug-utils.js loaded');
    console.log('   Run: TegakiDebug.checkInitialization()');
    console.log('   Run: TegakiDebug.testDrawingFlow()');

})();
```

---

## ğŸ“ æ”¹ä¿®å®Ÿæ–½æ‰‹é †

### æ‰‹é †1: Phase 1å®Ÿæ–½ï¼ˆæœ€å„ªå…ˆï¼‰
1. `core-engine.js` ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
2. Step 1-1 ã®ä¿®æ­£ã‚’é©ç”¨
3. ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œç¢ºèª
4. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§åˆæœŸåŒ–ãƒ­ã‚°ç¢ºèª
5. å®Ÿéš›ã«æç”»ãƒ†ã‚¹ãƒˆ

**ç¢ºèªã‚³ãƒãƒ³ãƒ‰**:
```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
window.drawingEngine?.inspect()
window.TegakiDebug?.checkInitialization()  // Phase 3å®Ÿè£…å¾Œ
```

---

### æ‰‹é †2: Phase 2å®Ÿæ–½ï¼ˆå®‰å®šæ€§å‘ä¸Šï¼‰
1. `brush-core.js` ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
2. Step 2-1 ã®ä¿®æ­£ã‚’é©ç”¨
3. `drawing-engine.js` ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
4. Step 2-2 ã®ä¿®æ­£ã‚’é©ç”¨
5. å‹•ä½œç¢ºèª

---

### æ‰‹é †3: Phase 3å®Ÿæ–½ï¼ˆä¿å®ˆæ€§å‘ä¸Šï¼‰
1. `system/debug-utils.js` ã‚’æ–°è¦ä½œæˆ
2. `index.html` ã«èª­ã¿è¾¼ã¿è¿½åŠ 
3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
4. å‹•ä½œç¢ºèª

---

## ğŸ” å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### åˆæœŸåŒ–ç¢ºèª
- [ ] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„
- [ ] `window.drawingEngine` ãŒå­˜åœ¨ã™ã‚‹
- [ ] `window.drawingEngine.initialized === true`
- [ ] `window.BrushCore.initialized === true`
- [ ] `window.CoordinateSystem.initialized === true`

### æç”»ç¢ºèª
- [ ] WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã§ãƒã‚¦ã‚¹ã‚’æŠ¼ä¸‹ã§ãã‚‹
- [ ] `pointerdown` ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹
- [ ] åº§æ¨™å¤‰æ›ãŒæˆåŠŸã™ã‚‹
- [ ] `BrushCore.startStroke()` ãŒå‘¼ã°ã‚Œã‚‹
- [ ] ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- [ ] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãŒç¢ºå®šã•ã‚Œã‚‹

### ãƒ‡ãƒãƒƒã‚°ç¢ºèª
- [ ] `window.drawingEngine.inspect()` ãŒå‹•ä½œã™ã‚‹
- [ ] `window.CoordinateSystem.dumpState()` ãŒå‹•ä½œã™ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒé©åˆ‡ã«å‡ºåŠ›ã•ã‚Œã‚‹

---

## ğŸš¨ äºˆæƒ³ã•ã‚Œã‚‹å•é¡Œã¨å¯¾å‡¦æ³•

### å•é¡Œ1: WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„
**ç—‡çŠ¶**: `WebGL2 canvas not found` ã‚¨ãƒ©ãƒ¼
**åŸå› **: DOMã®èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°
**å¯¾å‡¦**: 
```javascript
// core-engine.js
const glCanvas = document.querySelector('#webgl2-canvas');
if (!glCanvas) {
    console.error('[CoreEngine] WebGL2 canvas not found, retrying...');
    // å°‘ã—å¾…ã£ã¦ãƒªãƒˆãƒ©ã‚¤
    setTimeout(() => {
        const retryCanvas = document.querySelector('#webgl2-canvas');
        if (retryCanvas) {
            console.log('[CoreEngine] WebGL2 canvas found on retry');
            // å†åˆæœŸåŒ–å‡¦ç†
        }
    }, 100);
}
```

---

### å•é¡Œ2: CoordinateSystemåˆæœŸåŒ–å¤±æ•—
**ç—‡çŠ¶**: `CoordinateSystem initialization failed`
**åŸå› **: worldContainerãŒã¾ã æœªç”Ÿæˆ
**å¯¾å‡¦**: æ—¢ã« Phase 1.2.2 ã§å¯¾å‡¦æ¸ˆã¿ã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã§çŠ¶æ…‹ç¢ºèª

---

### å•é¡Œ3: PointerEvent ãŒå–å¾—ã§ããªã„
**ç—‡çŠ¶**: ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ä½•ã‚‚èµ·ã“ã‚‰ãªã„
**åŸå› **: PointerHandlerã®åˆæœŸåŒ–å¤±æ•—
**å¯¾å‡¦**:
```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèª
console.log('PointerHandler:', window.drawingEngine?.pointerHandler);
console.log('GLCanvas:', document.querySelector('#webgl2-canvas'));

// æ‰‹å‹•å†è¨­å®šãƒ†ã‚¹ãƒˆ
const glCanvas = document.querySelector('#webgl2-canvas');
const testHandler = new window.PointerHandler(glCanvas);
testHandler.on('pointerdown', (e) => console.log('Test pointerdown:', e));
```

---

## ğŸ“Š æ”¹ä¿®å¾Œã®æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ

### æ­£å¸¸ãªæç”»ãƒ•ãƒ­ãƒ¼
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒWebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã§ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³
   â†“
2. PointerHandler._normalizeEvent() â†’ normalized info
   â†“
3. PointerHandler._emit('pointerdown', info)
   â†“
4. DrawingEngine._handlePointerDown(info)
   â†“
5. DrawingEngine._transformPointerToLocal(info)
   â”œâ”€ screenClientToCanvas()
   â”œâ”€ canvasToWorld()
   â””â”€ worldToLocal()
   â†“
6. BrushCore.startStroke(localX, localY, pressure)
   â†“
7. StrokeRecorder.addPoint()
   â†“
8. CoreEngine._renderLoop()
   â””â”€ BrushCore.renderPreview()  â† ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
   â†“
9. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—
   â†“
10. BrushCore.finalizeStroke()
    â””â”€ GLMSDFPipeline.generateMSDF()
    â””â”€ Spriteç”Ÿæˆãƒ»é…ç½®
```

---

## ğŸ¯ ã¾ã¨ã‚

### æœ€å°é™ã®ä¿®æ­£ã§æç”»ã‚’å¾©æ—§ã•ã›ã‚‹ï¼ˆPhase 1ï¼‰
- core-engine.js ã«ç´„20è¡Œã®ã‚³ãƒ¼ãƒ‰è¿½åŠ 
- DrawingEngine.initialize() ã®å‘¼ã³å‡ºã—
- PointerHandler ã®ä½œæˆã¨æ¥ç¶š

### å®‰å®šæ€§ã‚’é«˜ã‚ã‚‹ï¼ˆPhase 2ï¼‰
- BrushCoreåˆæœŸåŒ–ã®ä¸€æœ¬åŒ–
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

### ä¿å®ˆæ€§ã‚’é«˜ã‚ã‚‹ï¼ˆPhase 3ï¼‰
- ãƒ‡ãƒãƒƒã‚°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£è¿½åŠ 
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

**æ¨å®šä½œæ¥­æ™‚é–“**:
- Phase 1: 30åˆ†
- Phase 2: 1æ™‚é–“
- Phase 3: 2æ™‚é–“

**åˆè¨ˆ**: ç´„3.5æ™‚é–“ã§å®Œå…¨å¾©æ—§å¯èƒ½