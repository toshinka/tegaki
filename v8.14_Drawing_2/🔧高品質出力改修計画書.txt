================================================================================
ãƒ–ãƒ©ã‚¦ã‚¶ãŠçµµã‹ããƒ„ãƒ¼ãƒ« v8.13 - é«˜å“è³ªå‡ºåŠ›æ”¹ä¿®è¨ˆç”»æ›¸
æ®µéšçš„å®Ÿè£…ã‚¬ã‚¤ãƒ‰ï¼ˆClaude to Claudeï¼‰
================================================================================

ã€æ”¹ä¿®ç›®çš„ã€‘
ãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚ºè¨ˆç®—ã«ã‚ˆã‚‹ã‚¸ãƒ£ã‚®ãƒ¼ç™ºç”Ÿã‚’æ’é™¤ã—ã€GPUç›´æ¥è»¢é€ã«ã‚ˆã‚‹ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼ã§é«˜å“è³ªå‡ºåŠ›ã‚’å®Ÿç¾ã™ã‚‹ã€‚

ã€å‡¡ä¾‹ã€‘
âš ï¸ = å•é¡Œç®‡æ‰€ãƒ»å®Ÿè£…ä¸å®Œå…¨
ğŸ”§ = æ”¹ä¿®å¿…è¦
âœ… = æ­£å¸¸å‹•ä½œç¢ºèªæ¸ˆã¿
âŒ = æœªå®Ÿè£…ãƒ»æ©Ÿèƒ½ä¸å…¨
ğŸ” = è¦èª¿æŸ»
ğŸ“ = è¦ªãƒ•ã‚¡ã‚¤ãƒ«
ğŸ“„ = å­ãƒ•ã‚¡ã‚¤ãƒ«
ğŸ”€ = ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼é–¢é€£

================================================================================
â–  ç¾çŠ¶åˆ†æï¼šã‚¸ãƒ£ã‚®ãƒ¼ç™ºç”Ÿã®æŠ€è¡“çš„åŸå› 
================================================================================

ã€å•é¡Œã®ã‚ã‚‹ãƒ•ãƒ­ãƒ¼ã€‘
GPU SDF/MSDFãƒ™ã‚¯ã‚¿ãƒ¼æç”»
  â†“
âŒ renderer.extract / renderTexture ã§CPUè»¢é€ï¼ˆåŠ£åŒ–ç™ºç”Ÿç‚¹ï¼‰
  â†“
âŒ Canvas2D toDataURL/toBlobï¼ˆè·é›¢å ´æƒ…å ±å–ªå¤±ï¼‰
  â†“
PNG/GIF/APNG ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰

ã€æ¨å¥¨ãƒ•ãƒ­ãƒ¼ã€‘
GPU æœ€çµ‚ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡
  â†“
âœ… renderer.extract.canvas({ alpha: true }) GPUç›´æ¥è»¢é€
  â†“
âœ… toBlob('image/png' | 'image/webp')
  â†“
å‡ºåŠ›

ã€PixiJS v8 Extract APIä»•æ§˜ã€‘
- renderer.extract.canvas(options)
  options: {
    target: Container | Texture,
    frame: Rectangle,
    resolution: number,
    alpha: boolean,  // â† é€æ˜åº¦ä¿æŒã®éµ
    antialias: boolean
  }
- renderer.extract.base64(options)
  format: 'png' | 'webp' | 'jpeg'
  quality: 0-1

================================================================================
â–  Phase 1: åŸºç›¤ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ä½œæˆï¼ˆPNGé™æ­¢ç”»ï¼‰
================================================================================

ã€ç›®çš„ã€‘
ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼ã®åŸºç›¤å®Ÿè£…ã¨APIçµ±ä¸€

ã€æ”¹ä¿®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“ system/exporters/png-exporter.js âš ï¸ æ—¢å­˜å®Ÿè£…ã‚’å…¨é¢åˆ·æ–°

ã€å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“„ system/export-manager.js - ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆçµ±æ‹¬
ğŸ“„ system/layer-system.js - ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ å–å¾—
ğŸ“„ system/camera-system.js - worldContainerå‚ç…§

ã€å®Ÿè£…å†…å®¹ã€‘

1. æ—¢å­˜å®Ÿè£…ã®å•é¡Œç‚¹èª¿æŸ»
   âš ï¸ Canvas2Dä½¿ç”¨ç®‡æ‰€ã®ç‰¹å®š
   âš ï¸ åº§æ¨™å¤‰æ›ã®äºŒé‡å®Ÿè£…ãƒã‚§ãƒƒã‚¯
   âš ï¸ renderTextureä½¿ç”¨ç®‡æ‰€

2. ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼ã¸ã®å…¨é¢åˆ·æ–°
   class PngExporter {
     constructor(app, layerManager) {
       this.app = app;
       this.layerManager = layerManager;
     }

     async exportPNG(options = {}) {
       const {
         target = this.app.stage,
         alpha = true,
         resolution = 1  // DPR=1å›ºå®š
       } = options;

       // âœ… GPUç›´æ¥è»¢é€
       const canvas = this.app.renderer.extract.canvas({
         target: target,
         alpha: alpha,
         resolution: resolution,
         antialias: true
       });

       return new Promise((resolve) => {
         canvas.toBlob((blob) => {
           resolve(blob);
         }, 'image/png');
       });
     }
   }

ã€ãƒ•ãƒ­ãƒ¼ã€‘
export-manager.js:exportPNG()
  â†’ png-exporter.js:exportPNG()
    â†’ renderer.extract.canvas({alpha:true})
    â†’ canvas.toBlob('image/png')
    â†’ Blobè¿”å´

ã€æ¤œè¨¼é …ç›®ã€‘
âœ… é€æ˜åº¦å®Œå…¨ä¿æŒç¢ºèª
âœ… SDF/MSDFã‚¨ãƒƒã‚¸ã®é®®æ˜åº¦ç¢ºèª
âœ… DPR=1å›ºå®šå‹•ä½œç¢ºèª
âœ… ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ç¢ºèª

================================================================================
â–  Phase 2: WEBPé™æ­¢ç”»å‡ºåŠ›å®Ÿè£…
================================================================================

ã€ç›®çš„ã€‘
PNGåŸºç›¤ã‚’æµç”¨ã—ãŸWEBPé™æ­¢ç”»å‡ºåŠ›

ã€æ”¹ä¿®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“ system/exporters/webp-exporter.js âŒ æ–°è¦ä½œæˆ

ã€å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“„ system/exporters/png-exporter.js - Phase 1ã§ä½œæˆã—ãŸåŸºç›¤

ã€å®Ÿè£…å†…å®¹ã€‘

class WebpExporter {
  constructor(app, layerManager) {
    this.app = app;
    this.layerManager = layerManager;
  }

  async exportWEBP(options = {}) {
    const {
      target = this.app.stage,
      alpha = true,
      quality = 0.95,
      resolution = 1
    } = options;

    // PNG Exporterã¨åŒä¸€ã®æŠ½å‡ºæ–¹å¼
    const canvas = this.app.renderer.extract.canvas({
      target: target,
      alpha: alpha,
      resolution: resolution,
      antialias: true
    });

    return new Promise((resolve) => {
      canvas.toBlob((blob) => {
        resolve(blob);
      }, 'image/webp', quality);
    });
  }
}

ã€ãƒ•ãƒ­ãƒ¼ã€‘
export-manager.js:exportWEBP()
  â†’ webp-exporter.js:exportWEBP()
    â†’ renderer.extract.canvas({alpha:true})
    â†’ canvas.toBlob('image/webp', quality)
    â†’ Blobè¿”å´

ã€æ¤œè¨¼é …ç›®ã€‘
âœ… PNGå‡ºåŠ›ã¨ã®å“è³ªæ¯”è¼ƒ
âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºæœ€é©åŒ–
âœ… é€æ˜åº¦ä¿æŒç¢ºèª

================================================================================
â–  Phase 3: APNGå‹•ç”»å‡ºåŠ›å®Ÿè£…ï¼ˆè‡ªå‹•æ¤œå‡ºï¼‰
================================================================================

ã€ç›®çš„ã€‘
è¤‡æ•°ãƒ•ãƒ¬ãƒ¼ãƒ è‡ªå‹•æ¤œå‡ºã«ã‚ˆã‚‹APNGç”Ÿæˆ

ã€æ”¹ä¿®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“ system/exporters/apng-exporter.js âš ï¸ æ—¢å­˜å®Ÿè£…ã‚’åˆ·æ–°
ğŸ“ system/exporters/png-exporter.js ğŸ”§ APNGæ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 

ã€å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“„ system/animation-system.js - ãƒ•ãƒ¬ãƒ¼ãƒ ç®¡ç†
ğŸ“„ system/virtual-album.js - ã‚¢ãƒ«ãƒãƒ æ§‹é€ 

ã€å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‘
UPNG.js (CDN) - APNGç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª
https://cdnjs.cloudflare.com/ajax/libs/upng-js/2.1.0/UPNG.js

ã€å®Ÿè£…å†…å®¹ã€‘

1. PNG Exporter ã«ãƒ•ãƒ¬ãƒ¼ãƒ æ¤œå‡ºæ©Ÿèƒ½è¿½åŠ 
   async exportPNG(options = {}) {
     // ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ãƒã‚§ãƒƒã‚¯
     const frameCount = this.layerManager.getTotalFrames();
     
     if (frameCount > 1) {
       // è‡ªå‹•çš„ã«APNGå‡ºåŠ›ã¸
       return this.exportAPNG(options);
     }
     
     // å˜ä¸€ãƒ•ãƒ¬ãƒ¼ãƒ ã¯é€šå¸¸PNG
     return this.exportSingleFrame(options);
   }

2. APNG Exporter å®Ÿè£…
   class ApngExporter {
     async exportAPNG(options = {}) {
       const frames = [];
       const delays = [];
       
       // å„ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
       for (let i = 0; i < frameCount; i++) {
         this.layerManager.setCurrentFrame(i);
         await this.app.renderer.render(this.app.stage);
         
         const canvas = this.app.renderer.extract.canvas({
           target: this.app.stage,
           alpha: true,
           resolution: 1
         });
         
         const ctx = canvas.getContext('2d');
         const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
         frames.push(imageData.data.buffer);
         delays.push(frameDelay);
       }
       
       // UPNG.js ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
       const apng = UPNG.encode(frames, width, height, 0, delays);
       return new Blob([apng], {type: "image/png"});
     }
   }

ã€ãƒ•ãƒ­ãƒ¼ã€‘
export-manager.js:exportPNG()
  â†’ png-exporter.js:exportPNG()
    â†’ ãƒ•ãƒ¬ãƒ¼ãƒ æ•° > 1 ?
      YES â†’ apng-exporter.js:exportAPNG()
            â†’ å„ãƒ•ãƒ¬ãƒ¼ãƒ  renderer.extract.canvas()
            â†’ UPNG.encode()
      NO  â†’ é€šå¸¸PNGå‡ºåŠ›

ã€æ¤œè¨¼é …ç›®ã€‘
âœ… å˜ä¸€/è¤‡æ•°ãƒ•ãƒ¬ãƒ¼ãƒ è‡ªå‹•åˆ‡æ›¿
âœ… ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆä¿æŒ
âœ… é€æ˜åº¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª
âœ… ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–ï¼ˆå¤§é‡ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚ï¼‰

================================================================================
â–  Phase 4: WEBPå‹•ç”»å‡ºåŠ›å®Ÿè£…ï¼ˆè‡ªå‹•æ¤œå‡ºï¼‰
================================================================================

ã€ç›®çš„ã€‘
è¤‡æ•°ãƒ•ãƒ¬ãƒ¼ãƒ è‡ªå‹•æ¤œå‡ºã«ã‚ˆã‚‹WEBPå‹•ç”»ç”Ÿæˆ

ã€æ”¹ä¿®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“ system/exporters/webp-exporter.js ğŸ”§ å‹•ç”»å‡ºåŠ›æ©Ÿèƒ½è¿½åŠ 

ã€å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“„ system/exporters/apng-exporter.js - ãƒ•ãƒ¬ãƒ¼ãƒ é€£ç•ªå‡¦ç†ã®å‚è€ƒ

ã€å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¤œè¨ã€‘
Option A: libwebp.js (WASMç‰ˆ) - å…¬å¼ã ãŒé‡ã„
Option B: canvas.toBlob('image/webp') é€£ç•ª + æ‰‹å‹•mux - è»½é‡
â†’ æ¨å¥¨: Option B ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒ†ã‚£ãƒ–APIå„ªå…ˆï¼‰

ã€å®Ÿè£…å†…å®¹ã€‘

async exportWEBP(options = {}) {
  const frameCount = this.layerManager.getTotalFrames();
  
  if (frameCount > 1) {
    return this.exportWebpAnimation(options);
  }
  
  return this.exportWebpStatic(options);
}

async exportWebpAnimation(options = {}) {
  const frames = [];
  
  for (let i = 0; i < frameCount; i++) {
    this.layerManager.setCurrentFrame(i);
    await this.app.renderer.render(this.app.stage);
    
    const canvas = this.app.renderer.extract.canvas({
      target: this.app.stage,
      alpha: true,
      resolution: 1
    });
    
    const blob = await new Promise(resolve => {
      canvas.toBlob(resolve, 'image/webp', quality);
    });
    
    frames.push(blob);
  }
  
  // WebP Animation Muxing
  // â€» ç°¡æ˜“å®Ÿè£…: é€£ç•ªWebPã‚’zip or å€‹åˆ¥DL
  // â€» æœ¬æ ¼å®Ÿè£…: libwebp-wasmä½¿ç”¨
  return this.muxWebpFrames(frames);
}

ã€ãƒ•ãƒ­ãƒ¼ã€‘
export-manager.js:exportWEBP()
  â†’ webp-exporter.js:exportWEBP()
    â†’ ãƒ•ãƒ¬ãƒ¼ãƒ æ•° > 1 ?
      YES â†’ exportWebpAnimation()
            â†’ å„ãƒ•ãƒ¬ãƒ¼ãƒ  canvas.toBlob('image/webp')
            â†’ muxWebpFrames()
      NO  â†’ exportWebpStatic()

ã€æ¤œè¨¼é …ç›®ã€‘
âœ… é™æ­¢ç”»/å‹•ç”»è‡ªå‹•åˆ‡æ›¿
âœ… APNGã¨ã®å“è³ªæ¯”è¼ƒ
âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåŠ¹ç‡

================================================================================
â–  Phase 5: PSDå‡ºåŠ›åŸºç›¤å®Ÿè£…
================================================================================

ã€ç›®çš„ã€‘
ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã‚’ä¿æŒã—ãŸPSDå‡ºåŠ›ï¼ˆåˆæœŸå®Ÿè£…ï¼‰

ã€æ”¹ä¿®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“ system/exporters/psd-exporter.js âŒ æ–°è¦ä½œæˆ

ã€å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“„ system/layer-system.js - ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤å–å¾—
ğŸ“„ system/exporters/png-exporter.js - CanvasæŠ½å‡ºæ–¹å¼

ã€å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¤œè¨ã€‘
ag-psd (æ¨å¥¨) - æ›¸ãè¾¼ã¿å¯¾å¿œã€ãƒ–ãƒ©ã‚¦ã‚¶å‹•ä½œå¯èƒ½
https://www.npmjs.com/package/ag-psd
CDN: https://cdn.jsdelivr.net/npm/ag-psd/dist/bundle.js

psd.js - èª­ã¿è¾¼ã¿ç‰¹åŒ–ã€æ›¸ãè¾¼ã¿æœªå¯¾å¿œ
â†’ ä¸æ¡ç”¨

ã€å®Ÿè£…å†…å®¹ï¼ˆåˆæœŸç‰ˆï¼‰ã€‘

class PsdExporter {
  constructor(app, layerManager) {
    this.app = app;
    this.layerManager = layerManager;
  }

  async exportPSD(options = {}) {
    // Phase 5 åˆæœŸå®Ÿè£…: ãƒœã‚¿ãƒ³é…ç½®ã®ã¿
    // å®Ÿè£…ã¯ Phase 6+ ã§æ®µéšçš„ã«è¿½åŠ 
    
    throw new Error('PSDå‡ºåŠ›ã¯é–‹ç™ºä¸­ã§ã™');
  }

  // å°†æ¥å®Ÿè£…äºˆå®š
  async _buildPsdStructure() {
    const layers = this.layerManager.getAllLayers();
    const psdLayers = [];
    
    for (const layer of layers) {
      const canvas = this.app.renderer.extract.canvas({
        target: layer.container,
        alpha: true,
        resolution: 1
      });
      
      psdLayers.push({
        name: layer.name,
        canvas: canvas,
        opacity: layer.opacity * 255,
        blendMode: this._convertBlendMode(layer.blendMode)
      });
    }
    
    return {
      width: this.app.renderer.width,
      height: this.app.renderer.height,
      children: psdLayers
    };
  }
}

ã€ãƒ•ãƒ­ãƒ¼ï¼ˆPhase 5ï¼‰ã€‘
export-manager.js:exportPSD()
  â†’ psd-exporter.js:exportPSD()
    â†’ throw Error('é–‹ç™ºä¸­')

ã€å°†æ¥ãƒ•ãƒ­ãƒ¼ï¼ˆPhase 6+ï¼‰ã€‘
export-manager.js:exportPSD()
  â†’ psd-exporter.js:exportPSD()
    â†’ layerManager.getAllLayers()
    â†’ å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ renderer.extract.canvas()
    â†’ ag-psd.writePsd()
    â†’ Blobè¿”å´

ã€æ¤œè¨¼é …ç›®ï¼ˆPhase 5ï¼‰ã€‘
âœ… ãƒœã‚¿ãƒ³é…ç½®ã®ã¿
âœ… ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

ã€å°†æ¥æ¤œè¨¼é …ç›®ï¼ˆPhase 6+ï¼‰ã€‘
âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼éšå±¤ä¿æŒ
âœ… ãƒ–ãƒ¬ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰å¤‰æ›
âœ… Photoshopèª­ã¿è¾¼ã¿ç¢ºèª

================================================================================
â–  Phase 6: UIçµ±åˆï¼ˆexport-popup.jsæ”¹ä¿®ï¼‰
================================================================================

ã€ç›®çš„ã€‘
GIFå‰Šé™¤ã€WEBP/PSDè¿½åŠ ã€ãƒœã‚¿ãƒ³é †å¤‰æ›´

ã€æ”¹ä¿®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“ ui/export-popup.js ğŸ”§ ãƒœã‚¿ãƒ³æ§‹æˆå¤‰æ›´

ã€å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“„ system/export-manager.js - å„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿å‘¼ã³å‡ºã—

ã€å®Ÿè£…å†…å®¹ã€‘

1. ãƒœã‚¿ãƒ³é…ç½®å¤‰æ›´
   âŒ å‰Šé™¤: PDF, GIF
   âœ… è¿½åŠ : WEBP, PSD
   âœ… é †åº: PNG â†’ WEBP â†’ PSD â†’ MP4

2. export-popup.js æ”¹ä¿®
   _createFormatButtons() {
     const formats = [
       { id: 'png', label: 'PNG/APNG', icon: 'ğŸ–¼ï¸' },
       { id: 'webp', label: 'WEBP', icon: 'ğŸŒ' },  // æ–°è¦
       { id: 'psd', label: 'PSD', icon: 'ğŸ¨' },    // æ–°è¦
       { id: 'mp4', label: 'MP4', icon: 'ğŸ¬' }
     ];
     
     // GIF, PDFå‰Šé™¤
   }

   async _handleExport(format) {
     switch(format) {
       case 'png':
         // è‡ªå‹•APNGæ¤œå‡º
         await window.exportManager.exportPNG();
         break;
       case 'webp':
         // è‡ªå‹•å‹•ç”»æ¤œå‡º
         await window.exportManager.exportWEBP();
         break;
       case 'psd':
         // Phase 5æ™‚ç‚¹ã§ã¯æœªå®Ÿè£…ã‚¨ãƒ©ãƒ¼
         await window.exportManager.exportPSD();
         break;
     }
   }

ã€ãƒ•ãƒ­ãƒ¼ã€‘
ui/export-popup.js:show()
  â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  â†’ _handleExport(format)
    â†’ export-manager.js:exportXXX()
      â†’ å„exporterå®Ÿè¡Œ

ã€æ¤œè¨¼é …ç›®ã€‘
âœ… ãƒœã‚¿ãƒ³é…ç½®é †ç¢ºèª
âœ… ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºç¢ºèª
âœ… å„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‘¼ã³å‡ºã—ç¢ºèª

================================================================================
â–  Phase 7: export-manager.js çµ±åˆ
================================================================================

ã€ç›®çš„ã€‘
å…¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ã®çµ±æ‹¬ç®¡ç†ã¨APIçµ±ä¸€

ã€æ”¹ä¿®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“ system/export-manager.js ğŸ”§ æ–°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ç™»éŒ²

ã€å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ“„ å…¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«

ã€å®Ÿè£…å†…å®¹ã€‘

class ExportManager {
  constructor(app, layerManager) {
    this.app = app;
    this.layerManager = layerManager;
    
    // âœ… æ–°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ç™»éŒ²
    this.pngExporter = new PngExporter(app, layerManager);
    this.webpExporter = new WebpExporter(app, layerManager);
    this.psdExporter = new PsdExporter(app, layerManager);
    this.apngExporter = new ApngExporter(app, layerManager);
    
    // âŒ å‰Šé™¤
    // this.gifExporter = ...
  }

  // çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
  async exportPNG(options) {
    return this.pngExporter.exportPNG(options);
  }

  async exportWEBP(options) {
    return this.webpExporter.exportWEBP(options);
  }

  async exportPSD(options) {
    return this.psdExporter.exportPSD(options);
  }

  // å†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰
  _downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }
}

ã€æ¤œè¨¼é …ç›®ã€‘
âœ… å…¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿åˆæœŸåŒ–ç¢ºèª
âœ… EventBusé€£æºç¢ºèª
âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª

================================================================================
â–  Phase 8: æ—¢å­˜ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ã®Canvas2Då‰Šé™¤
================================================================================

ã€ç›®çš„ã€‘
ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³é•åã®å®Œå…¨æ’é™¤ï¼ˆãƒã‚±ãƒ„ãƒ„ãƒ¼ãƒ«ä»¥å¤–ï¼‰

ã€æ”¹ä¿®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
ğŸ” system/exporters/*.js - Canvas2Dä½¿ç”¨ç®‡æ‰€èª¿æŸ»
âš ï¸ ç‰¹ã« apng-exporter.js, gif-exporter.js

ã€èª¿æŸ»é …ç›®ã€‘
1. Canvas2D getContext('2d') ä½¿ç”¨ç®‡æ‰€
2. drawImage(), putImageData() ä½¿ç”¨ç®‡æ‰€
3. toDataURL() ç›´æ¥å‘¼ã³å‡ºã—ç®‡æ‰€

ã€æ”¹ä¿®æ–¹é‡ã€‘
âŒ å‰Šé™¤: å…¨ã¦ã®Canvas2Dä¾å­˜ã‚³ãƒ¼ãƒ‰
âœ… ç½®æ›: renderer.extract.canvas() ã«çµ±ä¸€

ã€æ¤œè¨¼é …ç›®ã€‘
âœ… Canvas2Dä½¿ç”¨ã‚¼ãƒ­ç¢ºèª
âœ… fill-tool.js ã®ã¿ä¾‹å¤–ç¢ºèª

================================================================================
â–  Phase 9: äºŒé‡å®Ÿè£…ãƒ»å¾ªç’°ä¾å­˜ã®æ’é™¤
================================================================================

ã€ç›®çš„ã€‘
ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³å“è³ªåŸºæº–ã®é”æˆ

ã€èª¿æŸ»å¯¾è±¡ã€‘
ğŸ“„ å…¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«
ğŸ“„ åº§æ¨™å¤‰æ›é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

ã€èª¿æŸ»é …ç›®ã€‘
1. åº§æ¨™å¤‰æ›ã®é‡è¤‡å®Ÿè£…
   ğŸ” å„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãŒç‹¬è‡ªã«åº§æ¨™å¤‰æ›ã—ã¦ã„ãªã„ã‹
   
2. ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—ã®é‡è¤‡å®Ÿè£…
   ğŸ” layerManagerçµŒç”±ã§çµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ã‹

3. å¾ªç’°ä¾å­˜ãƒã‚§ãƒƒã‚¯
   ğŸ” export-manager â‡„ exporter é–“ã®ä¾å­˜

4. ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé‡è¤‡
   ğŸ” window.exportManager ã®ä¸€å…ƒåŒ–

ã€æ”¹ä¿®æ–¹é‡ã€‘
âœ… åº§æ¨™å¤‰æ›: coordinate-system.js ã«å®Œå…¨å§”è­²
âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—: layer-system.js çµŒç”±ã«çµ±ä¸€
âœ… å¾ªç’°ä¾å­˜: ä¾å­˜æ–¹å‘ã‚’ export-manager â†’ exporter ã«å›ºå®š

ã€æ¤œè¨¼é …ç›®ã€‘
âœ… å¾ªç’°ä¾å­˜ã‚¼ãƒ­ç¢ºèª
âœ… DRYåŸå‰‡éµå®ˆç¢ºèª

================================================================================
â–  Phase 10: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
================================================================================

ã€ç›®çš„ã€‘
å¤§é‡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ»é«˜è§£åƒåº¦å‡ºåŠ›æ™‚ã®å®‰å®šå‹•ä½œ

ã€æœ€é©åŒ–é …ç›®ã€‘

1. ãƒ¡ãƒ¢ãƒªç®¡ç†
   - ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®Canvasç ´æ£„
   - Blob URLå³åº§è§£æ”¾
   - å¤§é‡ãƒ•ãƒ¬ãƒ¼ãƒ æ™‚ã®åˆ†å‰²å‡¦ç†

2. ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
   - EventBusçµŒç”±ã§é€²æ—é€šçŸ¥
   - UIå´ã§ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º

3. WebWorkeræ¤œè¨ï¼ˆå°†æ¥ï¼‰
   - UPNG.js ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’Workerã¸
   - ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰éãƒ–ãƒ­ãƒƒã‚¯åŒ–

ã€å®Ÿè£…ä¾‹ã€‘

async exportAPNG(options) {
  const totalFrames = this.layerManager.getTotalFrames();
  
  for (let i = 0; i < totalFrames; i++) {
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹é€šçŸ¥
    window.eventBus.emit('export:progress', {
      current: i,
      total: totalFrames,
      format: 'APNG'
    });
    
    const canvas = await this._extractFrame(i);
    frames.push(canvas);
    
    // ãƒ¡ãƒ¢ãƒªè§£æ”¾
    if (i % 10 === 0) {
      await this._flushMemory();
    }
  }
}

ã€æ¤œè¨¼é …ç›®ã€‘
âœ… 100ãƒ•ãƒ¬ãƒ¼ãƒ å‡ºåŠ›æ™‚ã®å®‰å®šæ€§
âœ… ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ç¢ºèª
âœ… ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºå‹•ä½œç¢ºèª

================================================================================
â–  ã‚·ãƒ³ãƒœãƒ«ç´¢å¼•è¾å…¸
================================================================================

ã€åº§æ¨™ç³»ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
coordinate-system.js:
  - screenClientToCanvas(screenX, screenY)
  - canvasToWorld(canvasX, canvasY)
  - worldToLocal(worldX, worldY, targetContainer)

ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
layer-system.js:
  - getAllLayers()
  - getActiveLayer()
  - getTotalFrames()
  - setCurrentFrame(index)

ã€ã‚«ãƒ¡ãƒ©ç®¡ç†ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
camera-system.js:
  - getWorldContainer()
  - getZoom()
  - getWorldPosition()

ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆçµ±æ‹¬ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
export-manager.js:
  - exportPNG(options)
  - exportWEBP(options)
  - exportPSD(options)
  - _downloadBlob(blob, filename)

ã€PixiJS Extract APIã€‘
app.renderer.extract:
  - canvas(options) â†’ HTMLCanvasElement
  - base64(options) â†’ Promise<string>
  - pixels(options) â†’ Uint8Array

ã€EventBus ã‚¤ãƒ™ãƒ³ãƒˆã€‘
export:start - å‡ºåŠ›é–‹å§‹
export:progress - é€²æ—æ›´æ–° {current, total, format}
export:complete - å‡ºåŠ›å®Œäº† {format, blob}
export:error - ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ {format, error}

ã€é‡è¦å®šæ•°ã€‘
config.js:
  - DEFAULT_RESOLUTION = 1  // DPRå›ºå®š
  - EXPORT_QUALITY_PNG = 1.0
  - EXPORT_QUALITY_WEBP = 0.95

================================================================================
â–  å®Ÿè£…å„ªå…ˆé †ä½
================================================================================

æœ€å„ªå…ˆ:
Phase 1 â†’ Phase 2 â†’ Phase 6 (PNG/WEBPå‡ºåŠ› + UIå¤‰æ›´)

é«˜å„ªå…ˆ:
Phase 3 â†’ Phase 4 (å‹•ç”»å‡ºåŠ›)

ä¸­å„ªå…ˆ:
Phase 7 â†’ Phase 8 (çµ±åˆã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—)

ä½å„ªå…ˆ:
Phase 5 â†’ å°†æ¥æ‹¡å¼µ (PSDå®Ÿè£…)

æœ€é©åŒ–:
Phase 9 â†’ Phase 10 (å“è³ªå‘ä¸Š)

================================================================================
â–  æ³¨æ„äº‹é …
================================================================================

ã€DPRå›ºå®šå³å®ˆã€‘
å…¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ã§ resolution: 1 ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ã“ã¨

ã€é€æ˜åº¦ä¿æŒã€‘
å¿…ãš alpha: true ã‚’æŒ‡å®šã™ã‚‹ã“ã¨

ã€Canvas2Dç¦æ­¢ã€‘
fill-tool.js ä»¥å¤–ã§ã®ä½¿ç”¨å³ç¦

ã€åº§æ¨™å¤‰æ›ç¦æ­¢ã€‘
ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿å†…ã§åº§æ¨™å¤‰æ›ã‚’è¡Œã‚ãªã„ã“ã¨
renderer.extract ã¯æ—¢ã«æœ€çµ‚åº§æ¨™ç³»ã§å‹•ä½œ

ã€ãƒ¡ãƒ¢ãƒªç®¡ç†ã€‘
å¤§é‡ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†æ™‚ã¯é©å®œ Canvas/Blob ã‚’ç ´æ£„

ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåˆ©ç”¨ã€‘
CDNçµŒç”±ã§å‹•çš„ãƒ­ãƒ¼ãƒ‰ã€ãƒãƒ³ãƒ‰ãƒ«ä¸è¦

================================================================================
æ”¹ä¿®è¨ˆç”»æ›¸ END
================================================================================