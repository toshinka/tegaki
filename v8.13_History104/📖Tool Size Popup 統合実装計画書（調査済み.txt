# Tool Size Popup çµ±åˆå®Ÿè£…è¨ˆç”»æ›¸

## ğŸ” ç¾çŠ¶èª¿æŸ»çµæœ

### å•é¡Œã®æ ¸å¿ƒ
1. **ui-panels.js ã« `showToolSizePopup()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„**
2. **`handleToolClick()` å†…ã§ãƒšãƒ³/æ¶ˆã—ã‚´ãƒ ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å‘¼ã³å‡ºã—ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„**
3. **`toolbarIconClickMode` ã¯å®Ÿè£…æ¸ˆã¿ã ãŒã€å®Ÿéš›ã«ä½¿ã‚ã‚Œã¦ã„ãªã„**

### æ—¢å­˜ã®å®Ÿè£…çŠ¶æ³

#### âœ… å®Ÿè£…æ¸ˆã¿
- `window.ToolSizePopup` ã‚¯ãƒ©ã‚¹ï¼ˆtool-size-popup.jsï¼‰
- BrushSettings ã¨ã®çµ±åˆ
- ã‚¹ãƒ­ãƒƒãƒˆ/ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ©Ÿèƒ½
- `toolbarIconClickMode` ãƒ•ãƒ©ã‚°ï¼ˆui-panels.jsï¼‰
- `config.js` ã« toolSizePopup è¨­å®šï¼ˆ**ä¸åœ¨**ï¼‰

#### âŒ æœªå®Ÿè£…
- ui-panels.js ã® `showToolSizePopup(tool)` ãƒ¡ã‚½ãƒƒãƒ‰
- ui-panels.js ã® `closeToolSizePopup()` ãƒ¡ã‚½ãƒƒãƒ‰
- `handleToolClick()` å†…ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
- config.js ã® `toolSizePopup` è¨­å®š

---

## ğŸ“¦ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ³ãƒœãƒ«ä¸€è¦§

### Config (config.js)
```javascript
window.TEGAKI_CONFIG = {
  pen: { size: 10, opacity: 0.85 },
  eraser: { size: 20, opacity: 1.0 },
  tools: {
    pen: { defaultSize: 10, defaultOpacity: 0.85 },
    eraser: { defaultSize: 20, defaultOpacity: 1.0 }
  },
  sizeSlots: {
    pen: [2, 4, 6, 8, 12, 16, 24, 36, 50],
    eraser: [10, 15, 20, 30, 40, 50, 60, 80, 100]
  },
  // âš ï¸ ä¸åœ¨: toolSizePopup è¨­å®š
}
```

### EventBus (system/event-bus.js)
```javascript
class EventBus {
  on(eventName, callback)
  emit(eventName, data)
  off(eventName, callback)
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
window.TegakiEventBus
```

### BrushSettings (system/drawing/brush-settings.js)
```javascript
class BrushSettings {
  setBrushSize(size)
  setBrushOpacity(opacity)
  getBrushSize()
  getBrushOpacity()
}

// å–å¾—ãƒ‘ã‚¹
window.drawingApp?.drawingEngine?.settings
window.coreEngine?.drawingEngine?.settings
window.CoreRuntime?.internal?.drawingEngine?.settings
```

### DrawingEngine (system/drawing/drawing-engine.js)
```javascript
class DrawingEngine {
  settings: BrushSettings
  setTool(tool) // 'pen' | 'eraser'
  setBrushSize(size)
  getCurrentTool()
}
```

### UIController (ui/ui-panels.js)
```javascript
class UIController {
  toolbarIconClickMode: boolean
  
  // âœ… å®Ÿè£…æ¸ˆã¿
  handleToolClick(button)
  updateToolUI(tool)
  showPopup(popup)
  closeAllPopups(exceptPopup)
  
  // âŒ æœªå®Ÿè£…
  showToolSizePopup(tool)
  closeToolSizePopup()
}

window.TegakiUI.UIController
window.TegakiUI.uiController // ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³
```

### ToolSizePopup (ui/tool-size-popup.js)
```javascript
const ToolSizePopup = {
  show(tool)       // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
  hide()           // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—éè¡¨ç¤º
  isVisible()      // è¡¨ç¤ºçŠ¶æ…‹ç¢ºèª
  forceShow(tool)  // ãƒ‡ãƒãƒƒã‚°ç”¨å¼·åˆ¶è¡¨ç¤º
  getDebugInfo()   // ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—
}

window.ToolSizePopup
```

---

## ğŸ”„ ç†æƒ³çš„ãªãƒ•ãƒ­ãƒ¼

### ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆP/Eï¼‰
```
1. KeyboardHandler ãŒ 'KeyP' æ¤œå‡º
2. EventBus.emit('ui:tool-changed', { tool: 'pen' })
3. CoreRuntime ãŒå—ä¿¡ã€drawingEngine.setTool('pen')
4. DrawingEngine.setTool('pen')
   - this.currentTool = 'pen'
   - EventBus.emit('toolChanged', { tool: 'pen' })
5. UIController.updateToolUI('pen')
   - ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
   - toolbarIconClickMode = false â†’ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºãªã—
```

### ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒšãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. UIController.setupEventDelegation() ãŒ click ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ£ãƒƒãƒ
3. toolbarIconClickMode = true è¨­å®š
4. UIController.handleToolClick(button)
   â”œâ”€ 'pen-tool' ã®å ´åˆ
   â”‚  â”œâ”€ CoreRuntime.api.setTool('pen')
   â”‚  â”œâ”€ if (toolbarIconClickMode)
   â”‚  â”‚   â””â”€ showToolSizePopup('pen') // ğŸ†• ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
   â”‚  â””â”€ updateToolUI('pen')
   â””â”€ toolbarIconClickMode = false ã«ãƒªã‚»ãƒƒãƒˆ
```

---

## ğŸš€ æœ€å°é™ã®æ”¹ä¿®å†…å®¹

### 1. config.js ã«è¿½åŠ 
```javascript
toolSizePopup: {
  slots: [1, 3, 5, 10, 30, 100],
  sliderMin: 0.1,
  sliderMax: 500,
  dotMinSize: 4,
  dotMaxSize: 20
}
```

### 2. ui-panels.js ã«è¿½åŠ ï¼ˆ2ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
```javascript
/**
 * ToolSizePopup ã‚’è¡¨ç¤º
 */
showToolSizePopup(tool) {
  if (!window.ToolSizePopup) {
    console.error('[UIController] ToolSizePopup not found');
    return;
  }
  
  this.closeAllPopups();
  window.ToolSizePopup.show(tool);
  this.activePopup = 'toolSizePopup';
}

/**
 * ToolSizePopup ã‚’é–‰ã˜ã‚‹
 */
closeToolSizePopup() {
  if (window.ToolSizePopup && window.ToolSizePopup.isVisible()) {
    window.ToolSizePopup.hide();
  }
}
```

### 3. ui-panels.js ã® handleToolClick() æ”¹ä¿®
```javascript
'pen-tool': () => {
  if (!window.CoreRuntime.api.setTool('pen')) return;
  window.CoreRuntime.api.exitLayerMoveMode();
  
  // ğŸ†• ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã¿ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
  if (this.toolbarIconClickMode) {
    this.showToolSizePopup('pen');
  } else {
    this.togglePopup('pen-settings'); // å¾“æ¥ã®ãƒ¬ã‚¬ã‚·ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
  }
  
  this.updateToolUI('pen');
},

'eraser-tool': () => {
  if (!window.CoreRuntime.api.setTool('eraser')) return;
  window.CoreRuntime.api.exitLayerMoveMode();
  
  // ğŸ†• ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã¿ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
  if (this.toolbarIconClickMode) {
    this.showToolSizePopup('eraser');
  }
  
  this.closeAllPopups();
  this.updateToolUI('eraser');
}
```

### 4. ui-panels.js ã® closeAllPopups() æ”¹ä¿®
```javascript
closeAllPopups(exceptPopup = null) {
  // ... æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å‡¦ç† ...
  
  // ğŸ†• ToolSizePopup ã‚‚é–‰ã˜ã‚‹
  if (exceptPopup !== 'toolSizePopup') {
    this.closeToolSizePopup();
  }
  
  this.activePopup = null;
}
```

---

## ğŸ¨ CSS è¦ä»¶ï¼ˆæ—¢å­˜ styles/main.css ã§å®Ÿè£…æ¸ˆã¿ï¼‰

- `.tool-size-popup-panel`
- `.slots-container`
- `.slot-item`, `.slot-item.active`
- `.slot-dot`, `.slot-number`
- `.size-slider-container`
- `.slider-step-btn`
- `.size-slider`, `.size-value-input`

---

## âœ… æ”¹ä¿®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] tool-size-popup.js å®Ÿè£…æ¸ˆã¿
- [ ] **config.js ã« `toolSizePopup` è¨­å®šè¿½åŠ **
- [ ] **ui-panels.js ã« `showToolSizePopup()` è¿½åŠ **
- [ ] **ui-panels.js ã« `closeToolSizePopup()` è¿½åŠ **
- [ ] **ui-panels.js ã® `handleToolClick()` æ”¹ä¿®**
- [ ] **ui-panels.js ã® `closeAllPopups()` æ”¹ä¿®**
- [x] CSS ã‚¹ã‚¿ã‚¤ãƒ«å®Ÿè£…æ¸ˆã¿
- [x] EventBus çµ±åˆæ¸ˆã¿
- [x] BrushSettings çµ±åˆæ¸ˆã¿

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ‰‹é †

1. **ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ P/E**: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºãªã—
2. **ãƒšãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯**: ToolSizePopup è¡¨ç¤º
3. **æ¶ˆã—ã‚´ãƒ ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯**: ToolSizePopup è¡¨ç¤º
4. **ã‚¹ãƒ­ãƒƒãƒˆã‚¯ãƒªãƒƒã‚¯**: ã‚µã‚¤ã‚ºåæ˜  + ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹å¤‰æ›´
5. **ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œ**: ã‚µã‚¤ã‚ºåæ˜  + ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆè§£é™¤
6. **â—€â–¶ãƒœã‚¿ãƒ³**: ãƒ†ãƒ¼ãƒ‘ãƒªãƒ³ã‚°åˆ»ã¿å¹…ã§å¢—æ¸›
7. **ãƒšãƒ³ â‡” æ¶ˆã—ã‚´ãƒ åˆ‡ã‚Šæ›¿ãˆ**: å„ãƒ„ãƒ¼ãƒ«ã®ã‚µã‚¤ã‚ºä¿æŒ

---

## ğŸ”§ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰

```javascript
// ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¼·åˆ¶è¡¨ç¤º
window.ToolSizePopup.forceShow('pen')

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—
window.ToolSizePopup.getDebugInfo()

// BrushSettings ç¢ºèª
window.CoreRuntime.internal.drawingEngine.settings.getBrushSize()
```