<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P/E+ãƒ‰ãƒ©ãƒƒã‚°è¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
<style>
body {
  font-family: 'Consolas', 'Monaco', monospace;
  background: #1e1e1e;
  color: #d4d4d4;
  padding: 20px;
  margin: 0;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
}
h1 {
  color: #4fc3f7;
  font-size: 24px;
  margin-bottom: 20px;
}
.section {
  background: #252526;
  border: 1px solid #3e3e42;
  border-radius: 4px;
  padding: 15px;
  margin-bottom: 15px;
}
.section-title {
  color: #4ec9b0;
  font-size: 16px;
  font-weight: bold;
  margin-bottom: 10px;
  border-bottom: 1px solid #3e3e42;
  padding-bottom: 5px;
}
button {
  background: #0e639c;
  color: white;
  border: none;
  padding: 8px 16px;
  margin: 5px;
  border-radius: 3px;
  cursor: pointer;
  font-family: inherit;
  font-size: 14px;
}
button:hover {
  background: #1177bb;
}
button:active {
  background: #0d5689;
}
.output {
  background: #1e1e1e;
  border: 1px solid #3e3e42;
  border-radius: 3px;
  padding: 10px;
  margin-top: 10px;
  white-space: pre-wrap;
  font-size: 13px;
  max-height: 400px;
  overflow-y: auto;
}
.key {
  color: #9cdcfe;
}
.value {
  color: #ce9178;
}
.true {
  color: #4ec9b0;
}
.false {
  color: #f48771;
}
.null {
  color: #808080;
}
.number {
  color: #b5cea8;
}
.error {
  color: #f48771;
  background: #3e1e1e;
  padding: 5px;
  border-radius: 3px;
  margin: 5px 0;
}
.success {
  color: #4ec9b0;
}
.warning {
  color: #dcdcaa;
}
.instruction {
  background: #264f78;
  padding: 10px;
  border-radius: 3px;
  margin-bottom: 15px;
  border-left: 4px solid #4fc3f7;
}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ” P/E+ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
  
  <div class="instruction">
    <strong>ä½¿ã„æ–¹:</strong><br>
    1. ã€ŒåˆæœŸçŠ¶æ…‹è¨ºæ–­ã€ã§ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª<br>
    2. ã‚¢ãƒ—ãƒªã§P+ãƒ‰ãƒ©ãƒƒã‚°ã‚’å®Ÿè¡Œï¼ˆãƒšãƒ³ã‚µã‚¤ã‚ºã‚’å¤‰æ›´ï¼‰<br>
    3. ã€Œãƒ‰ãƒ©ãƒƒã‚°å¾Œè¨ºæ–­ã€ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèª<br>
    4. å•é¡ŒãŒã‚ã‚Œã°ã€Œä¿®å¾©è©¦è¡Œã€ã‚’å®Ÿè¡Œ
  </div>

  <div class="section">
    <div class="section-title">ğŸ“Š åŸºæœ¬è¨ºæ–­</div>
    <button onclick="diagnoseInitial()">åˆæœŸçŠ¶æ…‹è¨ºæ–­</button>
    <button onclick="diagnoseAfterDrag()">ãƒ‰ãƒ©ãƒƒã‚°å¾Œè¨ºæ–­</button>
    <button onclick="diagnoseEventFlow()">ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼è¨ºæ–­</button>
    <div id="basic-output" class="output"></div>
  </div>

  <div class="section">
    <div class="section-title">ğŸ”¬ è©³ç´°è¨ºæ–­</div>
    <button onclick="diagnoseDrawingEngine()">DrawingEngineè©³ç´°</button>
    <button onclick="diagnoseToolSizeManager()">ToolSizeManagerè©³ç´°</button>
    <button onclick="diagnoseBrushSettings()">BrushSettingsè©³ç´°</button>
    <button onclick="diagnoseEventBus()">EventBusè¨ºæ–­</button>
    <div id="detail-output" class="output"></div>
  </div>

  <div class="section">
    <div class="section-title">ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</div>
    <button onclick="testManualSizeChange()">æ‰‹å‹•ã‚µã‚¤ã‚ºå¤‰æ›´ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="testEventEmit()">ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="simulateDrag()">ãƒ‰ãƒ©ãƒƒã‚°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
    <div id="test-output" class="output"></div>
  </div>

  <div class="section">
    <div class="section-title">ğŸ”§ ä¿®å¾©ãƒ»ç›£è¦–</div>
    <button onclick="attemptFix()">ä¿®å¾©è©¦è¡Œ</button>
    <button onclick="startMonitoring()">ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–é–‹å§‹</button>
    <button onclick="stopMonitoring()">ç›£è¦–åœæ­¢</button>
    <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    <div id="fix-output" class="output"></div>
  </div>
</div>

<script>
let monitoringActive = false;
let eventLog = [];

function log(target, message, type = 'info') {
  const output = document.getElementById(target);
  const timestamp = new Date().toLocaleTimeString();
  let color = '#d4d4d4';
  if (type === 'error') color = '#f48771';
  if (type === 'success') color = '#4ec9b0';
  if (type === 'warning') color = '#dcdcaa';
  
  output.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
  output.scrollTop = output.scrollHeight;
}

function clear(target) {
  document.getElementById(target).innerHTML = '';
}

function formatValue(val) {
  if (val === null) return '<span class="null">null</span>';
  if (val === undefined) return '<span class="null">undefined</span>';
  if (typeof val === 'boolean') return `<span class="${val}">${val}</span>`;
  if (typeof val === 'number') return `<span class="number">${val}</span>`;
  if (typeof val === 'string') return `<span class="value">"${val}"</span>`;
  if (typeof val === 'function') return '<span class="value">[Function]</span>';
  if (typeof val === 'object') return JSON.stringify(val, null, 2);
  return String(val);
}

// ===== åŸºæœ¬è¨ºæ–­ =====
function diagnoseInitial() {
  clear('basic-output');
  log('basic-output', '=== åˆæœŸçŠ¶æ…‹è¨ºæ–­ ===', 'success');
  
  // DrawingEngineç¢ºèª
  const de = window.drawingEngine || window.coreEngine?.drawingEngine;
  if (!de) {
    log('basic-output', 'âŒ DrawingEngine not found', 'error');
    return;
  }
  
  log('basic-output', '\nğŸ“ DrawingEngine:');
  log('basic-output', `  - Instance: ${!!de ? 'âœ…' : 'âŒ'}`);
  log('basic-output', `  - Has settings: ${!!de.settings ? 'âœ…' : 'âŒ'}`);
  log('basic-output', `  - Has brushSize property: ${'brushSize' in de ? 'âš ï¸ å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³' : 'âœ… æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³'}`);
  log('basic-output', `  - currentTool: ${formatValue(de.currentTool)}`);
  
  if (de.settings) {
    const size = de.settings.getBrushSize?.() || de.settings.size;
    const opacity = de.settings.getBrushOpacity?.() || de.settings.opacity;
    log('basic-output', `  - settings.size: ${formatValue(size)}`);
    log('basic-output', `  - settings.opacity: ${formatValue(opacity)}`);
  }
  
  if ('brushSize' in de) {
    log('basic-output', `  - brushSize (deprecated): ${formatValue(de.brushSize)}`, 'warning');
  }
  
  // ToolSizeManagerç¢ºèª
  log('basic-output', '\nğŸ“ ToolSizeManager:');
  const tsm = window.toolSizeManager;
  if (!tsm) {
    log('basic-output', '  âŒ Not found', 'error');
  } else {
    log('basic-output', `  - Instance: âœ…`);
    log('basic-output', `  - currentTool: ${formatValue(tsm.currentTool)}`);
    if (tsm.toolStates) {
      log('basic-output', `  - pen.size: ${formatValue(tsm.toolStates.pen?.size)}`);
      log('basic-output', `  - pen.opacity: ${formatValue(tsm.toolStates.pen?.opacity)}`);
      log('basic-output', `  - eraser.size: ${formatValue(tsm.toolStates.eraser?.size)}`);
      log('basic-output', `  - eraser.opacity: ${formatValue(tsm.toolStates.eraser?.opacity)}`);
    }
  }
  
  // EventBusç¢ºèª
  log('basic-output', '\nğŸ“ EventBus:');
  const eb = window.TegakiEventBus;
  if (!eb) {
    log('basic-output', '  âŒ Not found', 'error');
  } else {
    log('basic-output', `  - Instance: âœ…`);
    const listeners = eb.getListenerCount?.('tool:size-opacity-changed') || 0;
    log('basic-output', `  - tool:size-opacity-changed listeners: ${formatValue(listeners)}`);
  }
}

function diagnoseAfterDrag() {
  clear('basic-output');
  log('basic-output', '=== ãƒ‰ãƒ©ãƒƒã‚°å¾Œè¨ºæ–­ ===', 'success');
  log('basic-output', 'ğŸ‘‰ ã“ã®è¨ºæ–­ã®å‰ã«ã€ã‚¢ãƒ—ãƒªã§P+ãƒ‰ãƒ©ãƒƒã‚°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„\n');
  
  const de = window.drawingEngine || window.coreEngine?.drawingEngine;
  const tsm = window.toolSizeManager;
  
  if (!de || !tsm) {
    log('basic-output', 'âŒ å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }
  
  log('basic-output', 'ğŸ“Š ç¾åœ¨ã®å€¤:');
  
  // ToolSizeManagerã®çŠ¶æ…‹
  if (tsm.toolStates?.pen) {
    log('basic-output', `\nğŸ¨ ToolSizeManager (pen):`);
    log('basic-output', `  - size: ${formatValue(tsm.toolStates.pen.size)}`);
    log('basic-output', `  - opacity: ${formatValue(tsm.toolStates.pen.opacity)}`);
    log('basic-output', `  - startSize: ${formatValue(tsm.toolStates.pen.startSize)}`);
    log('basic-output', `  - startOpacity: ${formatValue(tsm.toolStates.pen.startOpacity)}`);
  }
  
  // BrushSettingsã®çŠ¶æ…‹
  if (de.settings) {
    const size = de.settings.getBrushSize?.() || de.settings.size;
    const opacity = de.settings.getBrushOpacity?.() || de.settings.opacity;
    log('basic-output', `\nğŸ–Œï¸ BrushSettings:`);
    log('basic-output', `  - size: ${formatValue(size)}`);
    log('basic-output', `  - opacity: ${formatValue(opacity)}`);
  }
  
  // DrawingEngineã®çŠ¶æ…‹ï¼ˆå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å ´åˆï¼‰
  if ('brushSize' in de) {
    log('basic-output', `\nâš ï¸ DrawingEngine (deprecated properties):`);
    log('basic-output', `  - brushSize: ${formatValue(de.brushSize)}`);
    log('basic-output', `  - brushOpacity: ${formatValue(de.brushOpacity)}`);
  }
  
  // æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
  log('basic-output', `\nâœ… æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯:`);
  const tsmSize = tsm.toolStates?.pen?.size || 0;
  const bsSize = de.settings?.getBrushSize?.() || de.settings?.size || 0;
  const deSize = de.brushSize || bsSize;
  
  if (Math.abs(tsmSize - bsSize) < 0.01) {
    log('basic-output', `  âœ… ToolSizeManager â‡” BrushSettings: ä¸€è‡´`, 'success');
  } else {
    log('basic-output', `  âŒ ToolSizeManager(${tsmSize}) â‰  BrushSettings(${bsSize})`, 'error');
  }
  
  if ('brushSize' in de && Math.abs(deSize - bsSize) > 0.01) {
    log('basic-output', `  âš ï¸ DrawingEngine.brushSize(${deSize}) â‰  settings(${bsSize})`, 'warning');
    log('basic-output', `     â†’ å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®DrawingEngineãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™`, 'warning');
  }
}

function diagnoseEventFlow() {
  clear('basic-output');
  log('basic-output', '=== ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼è¨ºæ–­ ===', 'success');
  
  const eb = window.TegakiEventBus;
  if (!eb) {
    log('basic-output', 'âŒ EventBus not found', 'error');
    return;
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼æ•°ç¢ºèª
  const events = [
    'tool:drag-size-start',
    'tool:drag-size-update',
    'tool:size-opacity-changed',
    'tool:drag-size-end',
    'brushSizeChanged',
    'brushOpacityChanged'
  ];
  
  log('basic-output', 'ğŸ“¡ EventBusç™»éŒ²çŠ¶æ³:\n');
  events.forEach(evt => {
    const count = eb.getListenerCount?.(evt) || 0;
    const status = count > 0 ? 'âœ…' : 'âŒ';
    log('basic-output', `  ${status} ${evt}: ${count} listeners`);
  });
  
  // DrawingEngineã®ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ç¢ºèª
  log('basic-output', '\nğŸ” DrawingEngine.subscribeToSettings() ç¢ºèª:');
  const de = window.drawingEngine || window.coreEngine?.drawingEngine;
  if (de) {
    const hasOldCheck = de.subscribeToSettings.toString().includes('tool === this.currentTool');
    if (hasOldCheck) {
      log('basic-output', '  âŒ å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚ã‚Šï¼ˆå•é¡Œã®åŸå› ï¼‰', 'error');
      log('basic-output', '     â†’ tool:size-opacity-changedãŒæ¡ä»¶ä»˜ãã§ç„¡è¦–ã•ã‚Œã‚‹', 'error');
    } else {
      log('basic-output', '  âœ… æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ãªã—', 'success');
    }
  }
}

// ===== è©³ç´°è¨ºæ–­ =====
function diagnoseDrawingEngine() {
  clear('detail-output');
  log('detail-output', '=== DrawingEngine è©³ç´°è¨ºæ–­ ===', 'success');
  
  const de = window.drawingEngine || window.coreEngine?.drawingEngine;
  if (!de) {
    log('detail-output', 'âŒ DrawingEngine not found', 'error');
    return;
  }
  
  log('detail-output', '\nğŸ“¦ Properties:');
  const props = [
    'settings', 'currentTool', 'isDrawing', 'cameraSystem', 'layerManager',
    'eventBus', 'recorder', 'renderer', 'pressureHandler', 'transformer',
    'brushSize', 'brushColor', 'brushOpacity'
  ];
  
  props.forEach(prop => {
    if (prop in de) {
      const val = de[prop];
      log('detail-output', `  - ${prop}: ${formatValue(val)}`);
    }
  });
  
  log('detail-output', '\nğŸ”§ Methods:');
  const methods = ['setBrushSize', 'setBrushOpacity', 'setTool', 'subscribeToSettings'];
  methods.forEach(method => {
    log('detail-output', `  - ${method}: ${typeof de[method] === 'function' ? 'âœ…' : 'âŒ'}`);
  });
  
  if (de.getDebugInfo) {
    log('detail-output', '\nğŸ“Š Debug Info:');
    try {
      const info = de.getDebugInfo();
      log('detail-output', JSON.stringify(info, null, 2));
    } catch (e) {
      log('detail-output', `  Error: ${e.message}`, 'error');
    }
  }
}

function diagnoseToolSizeManager() {
  clear('detail-output');
  log('detail-output', '=== ToolSizeManager è©³ç´°è¨ºæ–­ ===', 'success');
  
  const tsm = window.toolSizeManager;
  if (!tsm) {
    log('detail-output', 'âŒ ToolSizeManager not found', 'error');
    return;
  }
  
  log('detail-output', '\nğŸ“¦ State:');
  log('detail-output', `  currentTool: ${formatValue(tsm.currentTool)}`);
  
  if (tsm.toolStates) {
    log('detail-output', '\n  toolStates:');
    Object.entries(tsm.toolStates).forEach(([tool, state]) => {
      log('detail-output', `    ${tool}:`);
      Object.entries(state).forEach(([key, val]) => {
        log('detail-output', `      ${key}: ${formatValue(val)}`);
      });
    });
  }
  
  log('detail-output', '\nâš™ï¸ Settings:');
  log('detail-output', `  sizeSensitivity: ${formatValue(tsm.sizeSensitivity)}`);
  log('detail-output', `  opacitySensitivity: ${formatValue(tsm.opacitySensitivity)}`);
  log('detail-output', `  size range: [${tsm.sizeMin}, ${tsm.sizeMax}]`);
  log('detail-output', `  opacity range: [${tsm.opacityMin}, ${tsm.opacityMax}]`);
  
  if (tsm.getDebugInfo) {
    log('detail-output', '\nğŸ“Š Debug Info:');
    const info = tsm.getDebugInfo();
    log('detail-output', JSON.stringify(info, null, 2));
  }
}

function diagnoseBrushSettings() {
  clear('detail-output');
  log('detail-output', '=== BrushSettings è©³ç´°è¨ºæ–­ ===', 'success');
  
  const de = window.drawingEngine || window.coreEngine?.drawingEngine;
  const bs = de?.settings;
  
  if (!bs) {
    log('detail-output', 'âŒ BrushSettings not found', 'error');
    return;
  }
  
  log('detail-output', '\nğŸ“¦ Current Values:');
  const props = ['size', 'color', 'opacity', 'thinning', 'smoothing', 'streamline'];
  props.forEach(prop => {
    if (prop in bs) {
      log('detail-output', `  ${prop}: ${formatValue(bs[prop])}`);
    }
  });
  
  log('detail-output', '\nğŸ”§ Methods:');
  const getSize = bs.getBrushSize?.();
  const getOpacity = bs.getBrushOpacity?.();
  log('detail-output', `  getBrushSize(): ${formatValue(getSize)}`);
  log('detail-output', `  getBrushOpacity(): ${formatValue(getOpacity)}`);
  
  if (bs.getCurrentSettings) {
    log('detail-output', '\nğŸ“Š Full Settings:');
    const settings = bs.getCurrentSettings();
    log('detail-output', JSON.stringify(settings, null, 2));
  }
}

function diagnoseEventBus() {
  clear('detail-output');
  log('detail-output', '=== EventBus è¨ºæ–­ ===', 'success');
  
  const eb = window.TegakiEventBus;
  if (!eb) {
    log('detail-output', 'âŒ EventBus not found', 'error');
    return;
  }
  
  log('detail-output', '\nğŸ“¡ All Event Listeners:');
  const eventNames = eb.getEventNames?.() || [];
  
  if (eventNames.length === 0) {
    log('detail-output', '  (no events registered)', 'warning');
  } else {
    eventNames.forEach(name => {
      const count = eb.getListenerCount(name);
      log('detail-output', `  ${name}: ${count} listener(s)`);
    });
  }
}

// ===== ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ =====
function testManualSizeChange() {
  clear('test-output');
  log('test-output', '=== æ‰‹å‹•ã‚µã‚¤ã‚ºå¤‰æ›´ãƒ†ã‚¹ãƒˆ ===', 'success');
  
  const de = window.drawingEngine || window.coreEngine?.drawingEngine;
  if (!de?.settings) {
    log('test-output', 'âŒ DrawingEngine.settings not found', 'error');
    return;
  }
  
  const testSize = 25;
  const testOpacity = 0.7;
  
  log('test-output', `\nğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ:`);
  log('test-output', `  ã‚µã‚¤ã‚ºã‚’ ${testSize} ã«å¤‰æ›´...`);
  
  try {
    de.settings.setBrushSize(testSize);
    const result = de.settings.getBrushSize();
    
    if (Math.abs(result - testSize) < 0.01) {
      log('test-output', `  âœ… æˆåŠŸ: ${result}`, 'success');
    } else {
      log('test-output', `  âŒ å¤±æ•—: æœŸå¾…${testSize}, å®Ÿéš›${result}`, 'error');
    }
  } catch (e) {
    log('test-output', `  âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
  }
  
  log('test-output', `\n  ä¸é€æ˜åº¦ã‚’ ${testOpacity} ã«å¤‰æ›´...`);
  
  try {
    de.settings.setBrushOpacity(testOpacity);
    const result = de.settings.getBrushOpacity();
    
    if (Math.abs(result - testOpacity) < 0.01) {
      log('test-output', `  âœ… æˆåŠŸ: ${result}`, 'success');
    } else {
      log('test-output', `  âŒ å¤±æ•—: æœŸå¾…${testOpacity}, å®Ÿéš›${result}`, 'error');
    }
  } catch (e) {
    log('test-output', `  âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
  }
}

function testEventEmit() {
  clear('test-output');
  log('test-output', '=== ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ãƒ†ã‚¹ãƒˆ ===', 'success');
  
  const eb = window.TegakiEventBus;
  if (!eb) {
    log('test-output', 'âŒ EventBus not found', 'error');
    return;
  }
  
  const testSize = 30;
  const testOpacity = 0.8;
  
  log('test-output', `\nğŸ§ª tool:size-opacity-changed ã‚’ç™ºç«...`);
  log('test-output', `  tool: pen, size: ${testSize}, opacity: ${testOpacity}`);
  
  // ç™ºç«å‰ã®å€¤ã‚’è¨˜éŒ²
  const de = window.drawingEngine || window.coreEngine?.drawingEngine;
  const beforeSize = de?.settings?.getBrushSize() || 0;
  const beforeOpacity = de?.settings?.getBrushOpacity() || 0;
  
  log('test-output', `\n  ç™ºç«å‰: size=${beforeSize}, opacity=${beforeOpacity}`);
  
  try {
    eb.emit('tool:size-opacity-changed', {
      tool: 'pen',
      size: testSize,
      opacity: testOpacity
    });
    
    setTimeout(() => {
      const afterSize = de?.settings?.getBrushSize() || 0;
      const afterOpacity = de?.settings?.getBrushOpacity() || 0;
      
      log('test-output', `  ç™ºç«å¾Œ: size=${afterSize}, opacity=${afterOpacity}`);
      
      if (Math.abs(afterSize - testSize) < 0.01 && Math.abs(afterOpacity - testOpacity) < 0.01) {
        log('test-output', `\n  âœ… ã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ãåæ˜ ã•ã‚Œã¾ã—ãŸ`, 'success');
      } else {
        log('test-output', `\n  âŒ ã‚¤ãƒ™ãƒ³ãƒˆãŒåæ˜ ã•ã‚Œã¦ã„ã¾ã›ã‚“`, 'error');
        log('test-output', `     æœŸå¾…: size=${testSize}, opacity=${testOpacity}`, 'error');
        log('test-output', `     å®Ÿéš›: size=${afterSize}, opacity=${afterOpacity}`, 'error');
      }
    }, 100);
  } catch (e) {
    log('test-output', `  âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
  }
}

function simulateDrag() {
  clear('test-output');
  log('test-output', '=== ãƒ‰ãƒ©ãƒƒã‚°ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ===', 'success');
  
  const eb = window.TegakiEventBus;
  const tsm = window.toolSizeManager;
  const de = window.drawingEngine || window.coreEngine?.drawingEngine;
  
  if (!eb || !tsm || !de) {
    log('test-output', 'âŒ å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }
  
  const startSize = de.settings?.getBrushSize() || 10;
  const startOpacity = de.settings?.getBrushOpacity() || 0.85;
  
  log('test-output', `\nğŸ¬ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹:`);
  log('test-output', `  åˆæœŸå€¤: size=${startSize}, opacity=${startOpacity}`);
  
  // 1. drag-start
  log('test-output', `\n  1ï¸âƒ£ tool:drag-size-start ç™ºç«...`);
  eb.emit('tool:drag-size-start', {
    tool: 'pen',
    startSize,
    startOpacity
  });
  
  setTimeout(() => {
    // 2. drag-update (å³ã«50pxã€ä¸Šã«30pxç§»å‹•)
    log('test-output', `  2ï¸âƒ£ tool:drag-size-update ç™ºç« (deltaX=50, deltaY=-30)...`);
    eb.emit('tool:drag-size-update', {
      tool: 'pen',
      deltaX: 50,
      deltaY: -30
    });
    
    setTimeout(() => {
      const afterSize = de.settings?.getBrushSize() || 0;
      const afterOpacity = de.settings?.getBrushOpacity() || 0;
      
      log('test-output', `\n  ğŸ“Š çµæœ:`);
      log('test-output', `    size: ${startSize} â†’ ${afterSize}`);
      log('test-output', `    opacity: ${startOpacity} â†’ ${afterOpacity}`);
      
      const expectedSize = startSize + 50 * (tsm.sizeSensitivity || 0.1);
      const expectedOpacity = startOpacity - (-30) * (tsm.opacitySensitivity || 0.005);
      
      log('test-output', `\n  æœŸå¾…å€¤:`);
      log('test-output', `    size: ${expectedSize.toFixed(2)}`);
      log('test-output', `    opacity: ${expectedOpacity.toFixed(3)}`);
      
      if (Math.abs(afterSize - expectedSize) < 0.5 && Math.abs(afterOpacity - expectedOpacity) < 0.01) {
        log('test-output', `\n  âœ… ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ`, 'success');
      } else {
        log('test-output', `\n  âŒ æœŸå¾…å€¤ã¨ç•°ãªã‚Šã¾ã™`, 'error');
      }
      
      // 3. drag-end
      setTimeout(() => {
        log('test-output', `\n  3ï¸âƒ£ tool:drag-size-end ç™ºç«...`);
        eb.emit('tool:drag-size-end');
      }, 100);
    }, 100);
  }, 100);
}

// ===== ä¿®å¾©ãƒ»ç›£è¦– =====
function attemptFix() {
  clear('fix-output');
  log('fix-output', '=== ä¿®å¾©è©¦è¡Œ ===', 'success');
  
  const de = window.drawingEngine || window.coreEngine?.drawingEngine;
  
  if (!de) {
    log('fix-output', 'âŒ DrawingEngine not found', 'error');
    return;
  }
  
  log('fix-output', '\nğŸ”§ å•é¡Œã®ãƒã‚§ãƒƒã‚¯...\n');
  
  // å•é¡Œ1: å¤ã„brushSizeãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒæ®‹ã£ã¦ã„ã‚‹
  if ('brushSize' in de) {
    log('fix-output', 'âš ï¸ å•é¡Œ1: DrawingEngine.brushSize (deprecated) ãŒå­˜åœ¨', 'warning');
    log('fix-output', '  â†’ æ–°ã—ã„DrawingEngineã«å·®ã—æ›¿ãˆãŒå¿…è¦ã§ã™', 'warning');
    log('fix-output', '  â†’ artifactã®ä¿®æ­£ç‰ˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„\n');
  } else {
    log('fix-output', 'âœ… å•é¡Œ1: ãªã— (æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³)\n', 'success');
  }
  
  // å•é¡Œ2: subscribeToSettingsã«ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ãŒæ®‹ã£ã¦ã„ã‚‹
  if (de.subscribeToSettings) {
    const source = de.subscribeToSettings.toString();
    if (source.includes('tool === this.currentTool')) {
      log('fix-output', 'âŒ å•é¡Œ2: subscribeToSettings ã«ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š', 'error');
      log('fix-output', '  â†’ ã“ã‚ŒãŒåŸå› ã§P/E+ãƒ‰ãƒ©ãƒƒã‚°ãŒåæ˜ ã•ã‚Œã¾ã›ã‚“', 'error');
      log('fix-output', '  â†’ artifactã®ä¿®æ­£ç‰ˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„\n');
    } else {
      log('fix-output', 'âœ… å•é¡Œ2: ãªã— (ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯å‰Šé™¤æ¸ˆã¿)\n', 'success');
    }
  }
  
  // å•é¡Œ3: ToolSizeManagerã®çŠ¶æ…‹ãŒæ›´æ–°ã•ã‚Œã¦ã„ãªã„
  const tsm = window.toolSizeManager;
  if (tsm && tsm.toolStates) {
    const penSize = tsm.toolStates.pen?.size || 0;
    const bsSize = de.settings?.getBrushSize() || 0;
    
    if (Math.abs(penSize - bsSize) > 1) {
      log('fix-output', 'âš ï¸ å•é¡Œ3: ToolSizeManager ã¨ BrushSettings ãŒä¸ä¸€è‡´', 'warning');
      log('fix-output', `  ToolSizeManager.pen.size: ${penSize}`, 'warning');
      log('fix-output', `  BrushSettings.size: ${bsSize}`, 'warning');
      log('fix-output', '\n  ğŸ”§ åŒæœŸã‚’è©¦ã¿ã¾ã™...');
      
      try {
        tsm.toolStates.pen.size = bsSize;
        tsm.toolStates.pen.opacity = de.settings.getBrushOpacity();
        log('fix-output', '  âœ… åŒæœŸå®Œäº†\n', 'success');
      } catch (e) {
        log('fix-output', `  âŒ åŒæœŸå¤±æ•—: ${e.message}\n`, 'error');
      }
    } else {
      log('fix-output', 'âœ… å•é¡Œ3: ãªã— (å€¤ãŒä¸€è‡´)\n', 'success');
    }
  }
  
  // å•é¡Œ4: EventBusãƒªã‚¹ãƒŠãƒ¼ä¸è¶³
  const eb = window.TegakiEventBus;
  if (eb) {
    const listeners = eb.getListenerCount?.('tool:size-opacity-changed') || 0;
    if (listeners === 0) {
      log('fix-output', 'âŒ å•é¡Œ4: tool:size-opacity-changed ã®ãƒªã‚¹ãƒŠãƒ¼ãªã—', 'error');
      log('fix-output', '  â†’ DrawingEngineãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“\n', 'error');
    } else {
      log('fix-output', `âœ… å•é¡Œ4: ãªã— (${listeners} listeners)\n`, 'success');
    }
  }
  
  log('fix-output', '\nğŸ“‹ ä¿®å¾©ã‚µãƒãƒªãƒ¼:');
  log('fix-output', '  DrawingEngineãŒå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å ´åˆ:');
  log('fix-output', '  1. artifactã®ä¿®æ­£ç‰ˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰');
  log('fix-output', '  2. system/drawing/drawing-engine.js ã‚’å·®ã—æ›¿ãˆ');
  log('fix-output', '  3. ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰');
}

let monitorListeners = [];

function startMonitoring() {
  if (monitoringActive) {
    log('fix-output', 'âš ï¸ æ—¢ã«ç›£è¦–ä¸­ã§ã™', 'warning');
    return;
  }
  
  clear('fix-output');
  log('fix-output', '=== ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–é–‹å§‹ ===', 'success');
  log('fix-output', 'ğŸ‘‰ ã‚¢ãƒ—ãƒªã§P+ãƒ‰ãƒ©ãƒƒã‚°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„\n');
  
  const eb = window.TegakiEventBus;
  if (!eb) {
    log('fix-output', 'âŒ EventBus not found', 'error');
    return;
  }
  
  monitoringActive = true;
  eventLog = [];
  
  const events = [
    'tool:drag-size-start',
    'tool:drag-size-update',
    'tool:size-opacity-changed',
    'tool:drag-size-end',
    'brushSizeChanged',
    'brushOpacityChanged'
  ];
  
  events.forEach(eventName => {
    const listener = (data) => {
      const timestamp = new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds();
      const logEntry = {
        time: timestamp,
        event: eventName,
        data: data
      };
      eventLog.push(logEntry);
      
      log('fix-output', `[${timestamp}] ğŸ“¡ ${eventName}`);
      if (data) {
        Object.entries(data).forEach(([key, val]) => {
          log('fix-output', `    ${key}: ${formatValue(val)}`);
        });
      }
      
      // BrushSettingsã®ç¾åœ¨å€¤ã‚‚è¡¨ç¤º
      if (eventName === 'tool:size-opacity-changed' || eventName === 'brushSizeChanged' || eventName === 'brushOpacityChanged') {
        const de = window.drawingEngine || window.coreEngine?.drawingEngine;
        if (de?.settings) {
          const size = de.settings.getBrushSize();
          const opacity = de.settings.getBrushOpacity();
          log('fix-output', `    â†’ åæ˜ å¾Œ: size=${size}, opacity=${opacity}`, 'success');
        }
      }
    };
    
    eb.on(eventName, listener);
    monitorListeners.push({ event: eventName, listener });
  });
  
  log('fix-output', `\nâœ… ç›£è¦–ä¸­... (${events.length} events)`, 'success');
}

function stopMonitoring() {
  if (!monitoringActive) {
    log('fix-output', 'âš ï¸ ç›£è¦–ã—ã¦ã„ã¾ã›ã‚“', 'warning');
    return;
  }
  
  const eb = window.TegakiEventBus;
  if (eb) {
    monitorListeners.forEach(({ event, listener }) => {
      eb.off(event, listener);
    });
  }
  
  monitorListeners = [];
  monitoringActive = false;
  
  log('fix-output', `\nâœ… ç›£è¦–åœæ­¢ (${eventLog.length} events recorded)`, 'success');
  
  if (eventLog.length > 0) {
    log('fix-output', '\nğŸ“Š ã‚¤ãƒ™ãƒ³ãƒˆã‚µãƒãƒªãƒ¼:');
    const summary = {};
    eventLog.forEach(entry => {
      summary[entry.event] = (summary[entry.event] || 0) + 1;
    });
    Object.entries(summary).forEach(([evt, count]) => {
      log('fix-output', `  ${evt}: ${count}å›`);
    });
  }
}

function clearLogs() {
  ['basic-output', 'detail-output', 'test-output', 'fix-output'].forEach(id => {
    clear(id);
  });
  eventLog = [];
}

// åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
window.addEventListener('DOMContentLoaded', () => {
  log('basic-output', 'è¨ºæ–­ãƒ„ãƒ¼ãƒ«æº–å‚™å®Œäº†', 'success');
  log('basic-output', 'ã€ŒåˆæœŸçŠ¶æ…‹è¨ºæ–­ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„');
});
</script>
</body>
</html>