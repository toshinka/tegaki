# WebGPUå®Œå…¨ç§»è¡Œè¨ˆç”»æ›¸ v2.0

## ğŸ“‹ æ¦‚è¦

**ç›®çš„**: PerfectFreehand + WebGPU ã§é«˜å“è³ªãƒšãƒ³ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè£…  
**æ–¹é‡**: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ’é™¤ã€GPUå¿…é ˆç’°å¢ƒã€å°–ã£ãŸé‹ç”¨  
**å¯¾è±¡**: WebGPUå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼ˆChrome/Edge 113+, Safari 18+ï¼‰

---

## ğŸ¯ è¨­è¨ˆæ€æƒ³

### **ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**

```
[å…¥åŠ›] PointerEvent
  â†“
[åº§æ¨™å¤‰æ›] coordinate-system.js
  â†“
[ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²] stroke-recorder.js
  â†“
[ãƒãƒªã‚´ãƒ³ç”Ÿæˆ] PerfectFreehand
  â†“
[GPU Compute] WebGPU SDF/MSDFç”Ÿæˆ
  â†“
[ãƒ†ã‚¯ã‚¹ãƒãƒ£] GPUTexture â†’ PixiJS Sprite
  â†“
[è¡¨ç¤º] PixiJS (è¡¨ç¤ºå±¤ã®ã¿)
```

### **ç¦æ­¢äº‹é …**
- âŒ Canvas2Dï¼ˆä¸€åˆ‡ä½¿ç”¨ã—ãªã„ï¼‰
- âŒ PixiJS Graphicsï¼ˆSprite/Meshã®ã¿ï¼‰
- âŒ CPUå´ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- âŒ ãƒ©ã‚¹ã‚¿ãƒ¼æç”»

---

## ğŸ“¦ Phase 1: WebGPUåŸºç›¤å¼·åŒ–

### ç›®çš„
- WebGPUTextureBridge ã®å®Œå…¨å®Ÿè£…
- GPU â†’ PixiJS Texture å¤‰æ›ã®æœ€é©åŒ–

### æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«

#### 1. `system/drawing/webgpu/webgpu-texture-bridge.js` â˜…PRIMARY
**ç¾çŠ¶**: åŸºæœ¬å®Ÿè£…ã®ã¿  
**æ”¹ä¿®å†…å®¹**:
- GPUTexture â†’ Canvas â†’ PixiJS Texture ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‰Šé™¤
- GPUTexture â†’ ImageBitmap â†’ PixiJS Texture ã®ç›´æ¥å¤‰æ›
- Canvas2Då®Œå…¨æ’é™¤

**è¿½åŠ ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
async createPixiTextureFromGPU(gpuTexture, width, height)
  â†’ GPUTextureèª­ã¿å‡ºã—
  â†’ ImageBitmapç”Ÿæˆ
  â†’ PixiJS BaseTextureç”Ÿæˆ
  â†’ PixiJS Textureè¿”å´
```

**ä¾å­˜é–¢ä¿‚**:
- Parents: webgpu-drawing-layer.js
- Children: stroke-renderer.js

---

#### 2. `system/drawing/webgpu/webgpu-drawing-layer.js` â˜…æ‹¡å¼µ
**æ”¹ä¿®å†…å®¹**:
- ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ—ãƒ¼ãƒ«ç®¡ç†è¿½åŠ 
- GPUTextureå†åˆ©ç”¨æ©Ÿæ§‹
- ãƒ¡ãƒ¢ãƒªç®¡ç†æœ€é©åŒ–

**è¿½åŠ ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
allocateTexture(width, height) â†’ GPUTexture
releaseTexture(gpuTexture)
```

---

## ğŸ“¦ Phase 2: SDFç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### ç›®çš„
- PerfectFreehandãƒãƒªã‚´ãƒ³ â†’ SDFå¤‰æ›ã®å®Œå…¨GPUåŒ–
- webgpu-compute-sdf.js ã®å¼·åŒ–

### æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«

#### 1. `system/drawing/webgpu/webgpu-compute-sdf.js` â˜…PRIMARY
**ç¾çŠ¶**: åŸºæœ¬å®Ÿè£…æ¸ˆã¿  
**æ”¹ä¿®å†…å®¹**:
- ãƒãƒªã‚´ãƒ³é ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ã®æœ€é©åŒ–
- SDFç”Ÿæˆã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã®é«˜é€ŸåŒ–
- è¤‡æ•°ãƒãƒªã‚´ãƒ³åŒæ™‚å‡¦ç†

**è¿½åŠ ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
generateSDFBatch(polygons[], settings) â†’ GPUTexture[]
```

**Compute Shaderæœ€é©åŒ–**:
- Workgroupæœ€é©åŒ–ï¼ˆ16x16 â†’ 32x32ï¼‰
- Shared Memoryæ´»ç”¨
- Early-outæœ€é©åŒ–

---

#### 2. `system/drawing/webgpu/shaders/compute-sdf.wgsl` â˜…NEW
**æ–°è¦ä½œæˆ**: æœ€é©åŒ–æ¸ˆã¿SDFã‚·ã‚§ãƒ¼ãƒ€ãƒ¼

**æ©Ÿèƒ½**:
```wgsl
@compute @workgroup_size(32, 32)
fn computeSDF(
  @builtin(global_invocation_id) id: vec3<u32>,
  polygon: array<vec2<f32>>,
  output: texture_storage_2d<r32float, write>
)
```

---

## ğŸ“¦ Phase 3: stroke-renderer WebGPUçµ±åˆ

### ç›®çš„
- Canvas2Då®Œå…¨å‰Šé™¤
- WebGPUå°‚ç”¨ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼å®Ÿè£…

### æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«

#### 1. `system/drawing/stroke-renderer.js` â˜…PRIMARYå®Œå…¨æ”¹ä¿®
**å‰Šé™¤**:
- `_createSpriteFromPolygon()` (Canvas2Dç‰ˆ)
- Canvasé–¢é€£ã‚³ãƒ¼ãƒ‰å…¨å‰Šé™¤

**æ–°è¦å®Ÿè£…**:
```javascript
async _renderWithWebGPU(polygon, settings, container)
  â†’ webgpuComputeSDF.generateSDF(polygon)
  â†’ webgpuTextureBridge.createPixiTextureFromGPU()
  â†’ PixiJS Spriteç”Ÿæˆ
  â†’ container.addChild()
```

**ãƒ¡ã‚½ãƒƒãƒ‰æ§‹æˆ**:
```javascript
// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
renderPreview(polygon, settings, container)
  â†’ _renderWithWebGPU()

// æœ€çµ‚æç”»
async renderFinalStroke(strokeData, settings, container)
  â†’ _renderWithWebGPU()
  
// WebGPUå°‚ç”¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
async _renderWithWebGPU(polygon, settings, container)
```

---

#### 2. ä¾å­˜é–¢ä¿‚ã®æ˜ç¢ºåŒ–

**Parents**:
- webgpu-compute-sdf.js (SDFç”Ÿæˆ)
- webgpu-texture-bridge.js (Textureå¤‰æ›)
- polygon-generator.js (ãƒãƒªã‚´ãƒ³)

**Children**:
- brush-core.js (æç”»è¦æ±‚)

---

## ğŸ“¦ Phase 4: åˆæœŸåŒ–ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ç›®çš„
- WebGPUéå¯¾å¿œç’°å¢ƒã®æ—©æœŸæ¤œå‡º
- æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«

#### 1. `core-initializer.js` â˜…æ‹¡å¼µ
**è¿½åŠ å‡¦ç†**:
```javascript
async function checkWebGPUSupport() {
  if (!navigator.gpu) {
    throw new Error('WebGPU not supported. Chrome 113+ or Safari 18+ required.');
  }
  
  const adapter = await navigator.gpu.requestAdapter();
  if (!adapter) {
    throw new Error('WebGPU adapter not available. GPU required.');
  }
  
  return adapter;
}
```

**åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼**:
```javascript
async initialize() {
  // WebGPUå¿…é ˆãƒã‚§ãƒƒã‚¯
  await checkWebGPUSupport();
  
  // WebGPUåˆæœŸåŒ–
  await window.webgpuDrawingLayer.initialize();
  
  // ãã®ä»–åˆæœŸåŒ–
  ...
}
```

---

#### 2. `ui/dom-builder.js` â˜…æ‹¡å¼µ
**è¿½åŠ UI**:
- WebGPUå¯¾å¿œçŠ¶æ³ã®è¡¨ç¤º
- GPUæƒ…å ±ã®è¡¨ç¤º

```html
<div id="gpu-status">
  ğŸŸ¢ WebGPU Ready
  GPU: NVIDIA GeForce RTX 4090
</div>
```

---

## ğŸ“¦ Phase 5: æœ€é©åŒ–ãƒ»ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### ç›®çš„
- ä¸è¦ã‚³ãƒ¼ãƒ‰å‰Šé™¤
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### å‰Šé™¤ãƒ•ã‚¡ã‚¤ãƒ«
- âŒ `system/drawing/sdf-mesh-builder.js` (æœªä½¿ç”¨)
- âŒ `system/drawing/curve-interpolator.js` (PerfectFreehandã§ä»£æ›¿)

### å‰Šé™¤ã‚³ãƒ¼ãƒ‰
**stroke-renderer.js**:
- Canvas2Dé–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰å…¨å‰Šé™¤
- Graphicsé–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰å…¨å‰Šé™¤ï¼ˆSmoothå«ã‚€ï¼‰

**config.js**:
- Canvas2Dè¨­å®šå‰Šé™¤
- Legacyè¨­å®šå‰Šé™¤

---

## ğŸ”§ å®Ÿè£…å„ªå…ˆåº¦

### â­â­â­â­â­ æœ€å„ªå…ˆ
**Phase 1**: WebGPUåŸºç›¤å¼·åŒ–  
**Phase 3**: stroke-renderer WebGPUçµ±åˆ

â†’ ã“ã®2ã¤ã§æç”»ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œæˆ

### â­â­â­â­â˜† é«˜å„ªå…ˆ
**Phase 2**: SDFç”Ÿæˆæœ€é©åŒ–  
**Phase 4**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

â†’ å“è³ªãƒ»å®‰å®šæ€§å‘ä¸Š

### â­â­â­â˜†â˜† ä¸­å„ªå…ˆ
**Phase 5**: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

â†’ æœ€å¾Œã«å®Ÿæ–½

---

## ğŸ“Š å®Ÿè£…é †åº

```
Phase 1 â†’ Phase 3 â†’ Phase 4 â†’ Phase 2 â†’ Phase 5
```

**ç†ç”±**:
1. Phase 1 (åŸºç›¤) â†’ å¿…é ˆã‚¤ãƒ³ãƒ•ãƒ©
2. Phase 3 (çµ±åˆ) â†’ æç”»å‹•ä½œç¢ºèª
3. Phase 4 (ã‚¨ãƒ©ãƒ¼) â†’ å®‰å®šæ€§ç¢ºä¿
4. Phase 2 (æœ€é©åŒ–) â†’ é«˜é€ŸåŒ–
5. Phase 5 (æƒé™¤) â†’ æœ€çµ‚ä»•ä¸Šã’

---

## ğŸ¯ Phase 1 è©³ç´°å®Ÿè£…ä»•æ§˜

### webgpu-texture-bridge.js å®Œå…¨ç‰ˆ

```javascript
class WebGPUTextureBridge {
  constructor() {
    this.device = null;
    this.queue = null;
  }

  initialize(device, queue) {
    this.device = device;
    this.queue = queue;
  }

  /**
   * GPUTexture â†’ PixiJS Textureå¤‰æ›ï¼ˆCanvas2Dä¸ä½¿ç”¨ï¼‰
   */
  async createPixiTextureFromGPU(gpuTexture, width, height) {
    // 1. GPUTexture â†’ GPUBuffer (èª­ã¿å‡ºã—)
    const bufferSize = width * height * 4;
    const buffer = this.device.createBuffer({
      size: bufferSize,
      usage: GPUBufferUsage.COPY_DST | GPUBufferUsage.MAP_READ
    });

    const encoder = this.device.createCommandEncoder();
    encoder.copyTextureToBuffer(
      { texture: gpuTexture },
      { buffer, bytesPerRow: width * 4 },
      { width, height }
    );
    this.queue.submit([encoder.finish()]);

    // 2. GPUBuffer â†’ ArrayBuffer
    await buffer.mapAsync(GPUMapMode.READ);
    const arrayBuffer = buffer.getMappedRange();
    const pixels = new Uint8ClampedArray(arrayBuffer);

    // 3. ImageData â†’ ImageBitmap
    const imageData = new ImageData(pixels, width, height);
    const bitmap = await createImageBitmap(imageData);

    buffer.unmap();
    buffer.destroy();

    // 4. ImageBitmap â†’ PixiJS Texture
    const baseTexture = PIXI.BaseTexture.from(bitmap, {
      scaleMode: PIXI.SCALE_MODES.LINEAR,
      mipmap: PIXI.MIPMAP_MODES.OFF
    });
    
    return new PIXI.Texture(baseTexture);
  }
}
```

---

## ğŸ¯ Phase 3 è©³ç´°å®Ÿè£…ä»•æ§˜

### stroke-renderer.js WebGPUå°‚ç”¨ç‰ˆ

```javascript
class StrokeRenderer {
  constructor() {
    this.activePreview = null;
    this.webgpuReady = false;
  }

  async initialize() {
    // WebGPUåˆæœŸåŒ–ç¢ºèª
    if (!window.webgpuDrawingLayer?.isInitialized()) {
      throw new Error('[StrokeRenderer] WebGPU not initialized');
    }
    
    if (!window.webgpuComputeSDF) {
      throw new Error('[StrokeRenderer] WebGPU Compute SDF not available');
    }
    
    if (!window.webgpuTextureBridge) {
      throw new Error('[StrokeRenderer] WebGPU Texture Bridge not available');
    }
    
    this.webgpuReady = true;
  }

  /**
   * WebGPUå°‚ç”¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
   */
  async _renderWithWebGPU(polygon, settings, container) {
    if (!this.webgpuReady) {
      await this.initialize();
    }

    // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹
    const bounds = this._calculateBounds(polygon);
    const padding = Math.ceil(settings.size || 16);
    const width = Math.ceil(bounds.maxX - bounds.minX) + padding * 2;
    const height = Math.ceil(bounds.maxY - bounds.minY) + padding * 2;

    // ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™å¤‰æ›
    const localPolygon = new Float32Array(polygon.length);
    for (let i = 0; i < polygon.length; i += 2) {
      localPolygon[i] = polygon[i] - bounds.minX + padding;
      localPolygon[i + 1] = polygon[i + 1] - bounds.minY + padding;
    }

    // SDFç”Ÿæˆï¼ˆGPUï¼‰
    const gpuTexture = await window.webgpuComputeSDF.generateSDFTexture(
      localPolygon,
      width,
      height,
      settings.size / 2
    );

    // PixiJS Textureå¤‰æ›
    const texture = await window.webgpuTextureBridge.createPixiTextureFromGPU(
      gpuTexture,
      width,
      height
    );

    // Spriteç”Ÿæˆ
    const sprite = new PIXI.Sprite(texture);
    sprite.x = bounds.minX - padding;
    sprite.y = bounds.minY - padding;

    if (container) {
      container.addChild(sprite);
    }

    return sprite;
  }

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æœ€çµ‚æç”»ã¯å…¨ã¦ _renderWithWebGPU() ã‚’å‘¼ã¶
  async renderPreview(polygon, settings, container) {
    this.clearPreview();
    const sprite = await this._renderWithWebGPU(polygon, settings, container);
    this.activePreview = sprite;
    return sprite;
  }

  async renderFinalStroke(strokeData, settings, container) {
    this.clearPreview();
    
    let polygon = strokeData.polygon;
    if (!polygon && strokeData.points) {
      polygon = window.PolygonGenerator.generate(strokeData.points);
    }
    
    return await this._renderWithWebGPU(polygon, settings, container);
  }
}
```

---

## ğŸ“‹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1å®Œäº†æ¡ä»¶
- [ ] webgpu-texture-bridge.js å®Ÿè£…å®Œäº†
- [ ] GPUTexture â†’ PixiJS Textureå¤‰æ›å‹•ä½œç¢ºèª
- [ ] Canvas2Då®Œå…¨ä¸ä½¿ç”¨

### Phase 3å®Œäº†æ¡ä»¶
- [ ] stroke-renderer.js WebGPUå°‚ç”¨ç‰ˆå®Ÿè£…
- [ ] Canvas2Dé–¢é€£ã‚³ãƒ¼ãƒ‰å…¨å‰Šé™¤
- [ ] æç”»å‹•ä½œç¢ºèªï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æœ€çµ‚ï¼‰

### Phase 4å®Œäº†æ¡ä»¶
- [ ] WebGPUéå¯¾å¿œæ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
- [ ] GPUæƒ…å ±UIè¡¨ç¤º

### å…¨Phaseå®Œäº†æ¡ä»¶
- [ ] `grep -r "Canvas2D" system/drawing/` â†’ 0ä»¶
- [ ] `grep -r "getContext('2d')" system/drawing/` â†’ 0ä»¶
- [ ] WebGPUå°‚ç”¨å‹•ä½œç¢ºèª

---

## ğŸš€ é–‹å§‹æ–¹æ³•

**Claude ã¸ã®ä¾é ¼æ–‡ä¾‹**:

```
ã€ŒWebGPUå®Œå…¨ç§»è¡Œè¨ˆç”»æ›¸ v2.0ã€ã®Phase 1ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:
- system/drawing/webgpu/webgpu-texture-bridge.js

è¦ä»¶:
- Canvas2Då®Œå…¨ä¸ä½¿ç”¨
- GPUTexture â†’ ImageBitmap â†’ PixiJS Texture
- å…ƒãƒ•ã‚¡ã‚¤ãƒ«ç¶™æ‰¿ã®å®Œå…¨ç‰ˆã‚’æå‡º
```

---

## ğŸ“ æ³¨æ„äº‹é …

### å¯¾å¿œç’°å¢ƒ
- Chrome 113+ (Windows/Mac/Linux)
- Edge 113+
- Safari 18+ (macOS Sonoma+)

### éå¯¾å¿œç’°å¢ƒ
- Firefox (WebGPUæœªå®Ÿè£…)
- ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆä¸€éƒ¨å¯¾å¿œï¼‰
- å¤ã„GPU

### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
WebGPU not supported.
This application requires:
- Chrome 113+ or Edge 113+ or Safari 18+
- GPU with WebGPU support
```

---

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹æˆæœ

âœ… **å®Œå…¨GPUæç”»**: Canvas2D/ãƒ©ã‚¹ã‚¿ãƒ¼ä¸€åˆ‡ä¸ä½¿ç”¨  
âœ… **é«˜é€Ÿãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°**: 400é ‚ç‚¹ãƒãƒªã‚´ãƒ³ã§ã‚‚å®‰å®š  
âœ… **é«˜å“è³ª**: PerfectFreehand + SDF/MSDF  
âœ… **å°–ã£ãŸé‹ç”¨**: WebGPUå¿…é ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãªã—

---

**è¨ˆç”»æ›¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0  
**ä½œæˆæ—¥**: 2025-01-13  
**å¯¾è±¡ãƒ„ãƒ¼ãƒ«**: ãƒ–ãƒ©ã‚¦ã‚¶ãŠçµµã‹ããƒ„ãƒ¼ãƒ« v8.14