# Tegaki WebGL2 - å®Œå…¨å®Ÿè£…è¨ˆç”»æ›¸ï¼ˆPhase 3.6å®Œäº†ç‰ˆï¼‰

## æ”¹è¨‚å±¥æ­´
- **Phase 2.0**: Perfect-Freehandçµ±åˆå®Œäº†
- **Phase 3.0**: ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢æ™‚ã®ãƒ™ã‚¯ã‚¿ãƒ¼å†è¨ˆç®—å®Ÿè£…
- **Phase 3.5**: Perfect-Freehandå½¢çŠ¶è£œæ­£å•é¡Œç™ºè¦š
- **Phase 3.6**: **ç‹¬è‡ªãƒªãƒœãƒ³ç”Ÿæˆå®Ÿè£…å®Œäº†ï¼ˆæœ¬ç‰ˆï¼‰** âœ…

---

## Phase 3.6 å®Œäº†çŠ¶æ³

### âœ… é”æˆé …ç›®

#### 1. Perfect-Freehandå®Œå…¨å‰Šé™¤
- **gl-stroke-processor.js**: ç‹¬è‡ªãƒªãƒœãƒ³ç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè£…
- **webgl2-drawing-layer.js**: Perfect-Freehandå‚ç…§å®Œå…¨å‰Šé™¤
- **config.js**: Perfect-Freehandè¨­å®šå‰Šé™¤

#### 2. ç‹¬è‡ªãƒãƒªã‚´ãƒ³ç”Ÿæˆå®Ÿè£…
```
å…¥åŠ›ãƒã‚¤ãƒ³ãƒˆ â†’ ç‹¬è‡ªãƒªãƒœãƒ³ç”Ÿæˆ â†’ Earcutä¸‰è§’å½¢åˆ†å‰² â†’ Pixi.Mesh
```

**ç‰¹å¾´:**
- âœ… é‹­è§’å®Œå…¨å¯¾å¿œï¼ˆãƒ™ãƒ™ãƒ«å‡¦ç†120åº¦ï¼‰
- âœ… è‡ªå·±äº¤å·®å®Œå…¨å›é¿
- âœ… ç·šã®å¤ªã•ä¿æŒ
- âœ… ç­†åœ§ã«ã‚ˆã‚‹å…ˆç´°ã‚Šè‡ªå‹•é©ç”¨
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãã®ã¾ã¾ä¿æŒ

#### 3. ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
- âœ… éå‰°ãªãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å‰Šæ¸›
- âœ… Perfect-Freehandé–¢é€£ã‚³ãƒ¼ãƒ‰å‰Šé™¤
- âœ… ä¸è¦ãªç¢ºèªãƒ­ã‚°å‰Šé™¤

### ğŸ¯ å®Ÿè£…ã®åŠ¹æœ

| é …ç›® | Phase 3.5ä»¥å‰ | Phase 3.6 |
|------|--------------|-----------|
| å½¢çŠ¶è£œæ­£ | Perfect-Freehandã«ã‚ˆã‚‹å¤‰å½¢ã‚ã‚Š | **å¤‰å½¢ãªã—** âœ… |
| å…¥ã‚ŠæŠœã | taperç„¡åŠ¹ã§æ¶ˆå¤± | **ç­†åœ§ã«ã‚ˆã‚‹è‡ªç„¶ãªå…ˆç´°ã‚Š** âœ… |
| é‹­è§’æç”» | æ­ªã¿ãƒ»è‡ªå·±äº¤å·®ã‚ã‚Š | **å®Œå…¨å¯¾å¿œ** âœ… |
| ç·šã®å¤ªã• | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯çµ‚äº†å¾Œå¤‰åŒ– | **ä¸€å®šä¿æŒ** âœ… |
| ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | Perfect-Freehandå¿…é ˆ | **Earcutã®ã¿** âœ… |

---

## ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
PointerEvent
  â†“
coordinate-system.js (åº§æ¨™å¤‰æ›)
  â†“
pressure-handler.js (ç­†åœ§å‡¦ç†)
  â†“
stroke-recorder.js (ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²)
  â†“
gl-stroke-processor.js (ç‹¬è‡ªãƒªãƒœãƒ³ç”Ÿæˆ)
  â†“
earcut-triangulator.js (ä¸‰è§’å½¢åˆ†å‰²)
  â†“
Pixi.Mesh (GPUæç”»)
```

### ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨è²¬å‹™

#### WebGL2 Base
- **webgl2-drawing-layer.js**: WebGL2ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ã€GLStrokeProcessorçµ±åˆ
- **gl-stroke-processor.js**: ç‹¬è‡ªãƒªãƒœãƒ³ç”Ÿæˆã€ãƒ™ãƒ™ãƒ«å‡¦ç†ã€ä¸‰è§’å½¢åˆ†å‰²
- **earcut-triangulator.js**: ãƒãƒªã‚´ãƒ³ä¸‰è§’å½¢åˆ†å‰²

#### Drawing System
- **stroke-recorder.js**: ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²ã€åº§æ¨™ä¿æŒ
- **stroke-renderer.js**: ãƒ¡ãƒƒã‚·ãƒ¥ç”Ÿæˆçµ±åˆã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- **brush-core.js**: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç®¡ç†ã€ã‚¤ãƒ™ãƒ³ãƒˆçµ±åˆ

#### Support
- **pressure-handler.js**: ç­†åœ§å¹³æ»‘åŒ–ã€æ„Ÿåº¦èª¿æ•´
- **coordinate-system.js**: åº§æ¨™å¤‰æ›ï¼ˆScreen/Canvas/World/Localï¼‰

---

## Phase 4: ç­†åœ§ãƒ»è£œæ­£ãƒ»æµé‡UIçµ±åˆ

### ç›®çš„
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒUIä¸Šã§ç­†åœ§æ„Ÿåº¦ãƒ»è£œæ­£ãƒ»æµé‡ã‚’èª¿æ•´å¯èƒ½ã«ã™ã‚‹

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

#### config.js è¨­å®šè¿½åŠ 
```javascript
window.TEGAKI_CONFIG = {
    brush: {
        // ç­†åœ§è¨­å®š
        pressure: {
            enabled: true,
            sensitivity: 1.0,  // 0.1 ï½ 2.0
            minSize: 0.3,      // æœ€å°ã‚µã‚¤ã‚ºæ¯”ç‡
            maxSize: 1.0       // æœ€å¤§ã‚µã‚¤ã‚ºæ¯”ç‡
        },
        
        // è£œæ­£è¨­å®š
        smoothing: {
            enabled: true,
            strength: 0.4,     // 0.0 ï½ 1.0
            thinning: 0        // ä½¿ç”¨ã—ãªã„
        },
        
        // æµé‡ï¼ˆãƒ•ãƒ­ãƒ¼ï¼‰è¨­å®š
        flow: {
            enabled: true,
            opacity: 1.0,      // 0.0 ï½ 1.0
            sensitivity: 1.0,  // 0.1 ï½ 2.0
            accumulation: true // è“„ç©ãƒ¢ãƒ¼ãƒ‰
        }
    }
};
```

#### settings-popup.js UIè¿½åŠ 
```html
<!-- ç­†åœ§æ„Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
<input type="range" id="pressure-sensitivity" 
       min="0.1" max="2.0" step="0.1" value="1.0">

<!-- è£œæ­£å¼·åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
<input type="range" id="smoothing-strength" 
       min="0" max="1" step="0.1" value="0.4">

<!-- æµé‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
<input type="range" id="flow-opacity" 
       min="0" max="1" step="0.05" value="1.0">

<!-- è“„ç©ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
<input type="checkbox" id="flow-accumulation" checked>
```

#### stroke-renderer.js æµé‡åæ˜ 
```javascript
_renderWithPolygon(strokeData, settings) {
    const flowSettings = window.TEGAKI_CONFIG?.brush?.flow || {};
    const baseOpacity = settings.opacity || 1.0;
    const flowOpacity = flowSettings.opacity || 1.0;
    
    // ç­†åœ§ã«å¿œã˜ãŸé€æ˜åº¦è¨ˆç®—
    const avgPressure = this._calculateAveragePressure(strokeData.points);
    const pressureAdjusted = Math.pow(avgPressure, 1.0 / flowSensitivity);
    
    graphics.alpha = baseOpacity * flowOpacity * pressureAdjusted;
    
    // è“„ç©ãƒ¢ãƒ¼ãƒ‰
    if (flowSettings.accumulation) {
        graphics.blendMode = 'add';
    }
}
```

### å·¥æ•°è¦‹ç©
- **3-4æ—¥**
- ä¾å­˜é–¢ä¿‚: Phase 3.6å®Œäº†ï¼ˆâœ…ï¼‰

---

## Phase 5: ã‚¨ã‚¢ãƒ–ãƒ©ã‚·ãƒ»æ°´å½©ãƒšãƒ³åŸºç›¤ï¼ˆå®Ÿè£…ä¿ç•™ï¼‰

### ç›®çš„
å°†æ¥å®Ÿè£…ã®ãŸã‚ã®è¨­å®šåŸºç›¤ã®ã¿ä½œæˆ

### config.js åŸºç›¤ã‚³ãƒ¼ãƒ‰
```javascript
brush: {
    modes: {
        pen: { enabled: true },
        eraser: { enabled: true },
        airbrush: { enabled: false },  // å°†æ¥å®Ÿè£…
        watercolor: { enabled: false } // å°†æ¥å®Ÿè£…
    },
    
    // ã‚¨ã‚¢ãƒ–ãƒ©ã‚·è¨­å®šï¼ˆæœªä½¿ç”¨ï¼‰
    airbrush: {
        radius: 20,
        density: 0.5,
        scatter: 1.0
    },
    
    // æ°´å½©è¨­å®šï¼ˆæœªä½¿ç”¨ï¼‰
    watercolor: {
        wetness: 0.8,
        bleeding: 0.3,
        dryTime: 2.0
    }
}
```

### å·¥æ•°è¦‹ç©
- **1æ—¥**
- å®Ÿè£…: è¨­å®šè¿½åŠ ã®ã¿ã€æ©Ÿèƒ½å®Ÿè£…ã¯å¾Œå›ã—

---

## Phase 6: SDF/MSDF Shaderçµ±åˆï¼ˆé«˜å“è³ªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰

### ç›®çš„
GLSLã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã«ã‚ˆã‚‹é«˜å“è³ªã‚¢ãƒ³ãƒã‚¨ã‚¤ãƒªã‚¢ã‚¹æç”»

### å®Ÿè£…æ‰‹é †

#### 1. GLSLã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–
**shader-inline.js** (æ–°è¦ä½œæˆ)

```javascript
window.GLSLShaders = {
    seedInit: `#version 300 es...`,
    jfaPass: `#version 300 es...`,
    encode: `#version 300 es...`,
    renderVert: `#version 300 es...`,
    renderFrag: `#version 300 es...`
};
```

#### 2. gl-msdf-pipeline.js æ”¹ä¿®
```javascript
initialize(gl) {
    this.gl = gl;
    
    this.seedInitProgram = this._createProgram(
        window.GLSLShaders.renderVert,
        window.GLSLShaders.seedInit
    );
    
    this.jfaProgram = this._createProgram(
        window.GLSLShaders.renderVert,
        window.GLSLShaders.jfaPass
    );
}
```

#### 3. stroke-renderer.js MSDFå„ªå…ˆåŒ–
```javascript
async renderFinalStroke(strokeData, settings) {
    // MSDFå„ªå…ˆï¼ˆé«˜å“è³ªï¼‰
    if (this.glMSDFPipeline && this.glMSDFPipeline.initialized) {
        const mesh = await this._renderWithMSDF(strokeData, settings);
        if (mesh) return mesh;
    }
    
    // ç‹¬è‡ªãƒãƒªã‚´ãƒ³ï¼ˆæ¨™æº–å“è³ªï¼‰
    if (this.glStrokeProcessor) {
        const mesh = await this._renderWithPolygon(strokeData, settings);
        if (mesh) return mesh;
    }
    
    // Legacyï¼ˆä½å“è³ªãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    return this._renderFinalStrokeLegacy(strokeData, settings);
}
```

### å·¥æ•°è¦‹ç©
- **5-7æ—¥**
- ä¾å­˜é–¢ä¿‚: Phase 3, 4å®Œäº†å¾Œ

---

## å®Ÿè£…å„ªå…ˆé †ä½

### 1. Phase 4 - ç­†åœ§ãƒ»è£œæ­£ãƒ»æµé‡UIçµ±åˆ
- **å„ªå…ˆåº¦**: æœ€é«˜
- **å·¥æ•°**: 3-4æ—¥
- **ä¾å­˜**: Phase 3.6å®Œäº†ï¼ˆâœ…ï¼‰
- **ç†ç”±**: ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šã«ç›´çµ

### 2. Phase 5 - ã‚¨ã‚¢ãƒ–ãƒ©ã‚·ãƒ»æ°´å½©åŸºç›¤
- **å„ªå…ˆåº¦**: ä¸­
- **å·¥æ•°**: 1æ—¥
- **ä¾å­˜**: Phase 4å®Œäº†å¾Œ
- **ç†ç”±**: å°†æ¥å®Ÿè£…ã®æº–å‚™

### 3. Phase 6 - SDF/MSDFçµ±åˆ
- **å„ªå…ˆåº¦**: ä½
- **å·¥æ•°**: 5-7æ—¥
- **ä¾å­˜**: Phase 3, 4å®Œäº†å¾Œ
- **ç†ç”±**: é«˜å“è³ªåŒ–ã€å¾Œå›ã—å¯èƒ½

---

## å®Œæˆå¾Œã®æ©Ÿèƒ½ä¸€è¦§

| æ©Ÿèƒ½ | Phase2 | Phase3 | Phase3.6 | Phase4 | Phase5 | Phase6 |
|------|--------|--------|----------|--------|--------|--------|
| ãƒ™ã‚¯ã‚¿ãƒ¼ãƒšãƒ³ | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| ãƒãƒªã‚´ãƒ³ãƒ¡ãƒƒã‚·ãƒ¥ | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| æ‹¡å¤§æ™‚ãƒªãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚º | âŒ | âœ… | âœ… | âœ… | âœ… | âœ… |
| å½¢çŠ¶è£œæ­£å•é¡Œè§£æ±º | âŒ | âŒ | **âœ…** | âœ… | âœ… | âœ… |
| ç‹¬è‡ªãƒªãƒœãƒ³ç”Ÿæˆ | âŒ | âŒ | **âœ…** | âœ… | âœ… | âœ… |
| ç­†åœ§æ„Ÿåº¦UI | åŸºæœ¬ | åŸºæœ¬ | åŸºæœ¬ | **âœ…** | âœ… | âœ… |
| è£œæ­£å¼·åº¦UI | åŸºæœ¬ | åŸºæœ¬ | åŸºæœ¬ | **âœ…** | âœ… | âœ… |
| æµé‡ï¼ˆãƒ•ãƒ­ãƒ¼ï¼‰ | âŒ | âŒ | âŒ | **âœ…** | âœ… | âœ… |
| è“„ç©ãƒ¢ãƒ¼ãƒ‰ | âŒ | âŒ | âŒ | **âœ…** | âœ… | âœ… |
| ã‚¨ã‚¢ãƒ–ãƒ©ã‚·åŸºç›¤ | âŒ | âŒ | âŒ | âŒ | **âœ…** | âœ… |
| æ°´å½©åŸºç›¤ | âŒ | âŒ | âŒ | âŒ | **âœ…** | âœ… |
| SDF/MSDF | âŒ | âŒ | âŒ | âŒ | âŒ | **âœ…** |
| é«˜å“è³ªAA | âŒ | âŒ | âŒ | âŒ | âŒ | **âœ…** |

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### æ¨å¥¨å®Ÿè£…é †åº

1. **Phase 4 - ç­†åœ§ãƒ»è£œæ­£ãƒ»æµé‡UI**
   - å³åº§ã«å®Ÿè£…é–‹å§‹å¯èƒ½
   - ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šã«ç›´çµ
   - å·¥æ•°: 3-4æ—¥

2. **Phase 5 - ã‚¨ã‚¢ãƒ–ãƒ©ã‚·ãƒ»æ°´å½©åŸºç›¤**
   - Phase 4å®Œäº†å¾Œã«å®Ÿè£…
   - è¨­å®šè¿½åŠ ã®ã¿ã€æ©Ÿèƒ½å®Ÿè£…ã¯ä¿ç•™
   - å·¥æ•°: 1æ—¥

3. **Phase 6 - SDF/MSDFçµ±åˆ**
   - æ™‚é–“ãŒã‚ã‚Œã°å®Ÿè£…
   - é«˜å“è³ªåŒ–ã ãŒå¾Œå›ã—å¯èƒ½
   - å·¥æ•°: 5-7æ—¥

---

## Phase 3.6 å®Ÿè£…è©³ç´°ï¼ˆå‚è€ƒï¼‰

### ç‹¬è‡ªãƒªãƒœãƒ³ç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

#### 1. ãƒã‚¤ãƒ³ãƒˆæ³•ç·šè¨ˆç®—
```javascript
_calculateNormal(p1, p2) {
    const dx = p2.x - p1.x;
    const dy = p2.y - p1.y;
    const len = Math.sqrt(dx * dx + dy * dy);
    
    if (len < 0.001) return { x: 0, y: 1 };
    
    return {
        x: -dy / len,
        y: dx / len
    };
}
```

#### 2. ã‚ªãƒ•ã‚»ãƒƒãƒˆæ›²ç·šç”Ÿæˆ
```javascript
_generateRibbonPoints(points, halfWidth) {
    const leftEdge = [];
    const rightEdge = [];
    
    for (let i = 0; i < points.length; i++) {
        const normal = this._calculateNormal(points[i], points[i + 1]);
        const pressureWidth = halfWidth * (points[i].pressure || 0.5);
        
        leftEdge.push({
            x: points[i].x + normal.x * pressureWidth,
            y: points[i].y + normal.y * pressureWidth
        });
        
        rightEdge.push({
            x: points[i].x - normal.x * pressureWidth,
            y: points[i].y - normal.y * pressureWidth
        });
    }
    
    return { leftEdge, rightEdge };
}
```

#### 3. ãƒ™ãƒ™ãƒ«å‡¦ç†ï¼ˆé‹­è§’å¯¾å¿œï¼‰
```javascript
_applyBevel(points, threshold = 120) {
    for (let i = 1; i < points.length - 1; i++) {
        const angle = this._calculateAngle(points[i - 1], points[i], points[i + 1]);
        
        if (angle < threshold) {
            // ãƒ™ãƒ™ãƒ«æŒ¿å…¥
            const bevelPoint = this._calculateBevelPoint(points[i], angle);
            points.splice(i + 1, 0, bevelPoint);
        }
    }
}
```

---

## ã¾ã¨ã‚

### Phase 3.6 å®Œäº†
- âœ… Perfect-Freehandå®Œå…¨å‰Šé™¤
- âœ… ç‹¬è‡ªãƒªãƒœãƒ³ç”Ÿæˆå®Ÿè£…
- âœ… é‹­è§’å®Œå…¨å¯¾å¿œ
- âœ… ç­†åœ§ã«ã‚ˆã‚‹è‡ªç„¶ãªå…ˆç´°ã‚Š
- âœ… ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Œäº†

### æ¬¡ã®ç›®æ¨™: Phase 4
ç­†åœ§ãƒ»è£œæ­£ãƒ»æµé‡ã®UIçµ±åˆã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç”±ã«æç”»æ„Ÿã‚’èª¿æ•´å¯èƒ½ã«ã™ã‚‹ã€‚

---

*END OF DOCUMENT*