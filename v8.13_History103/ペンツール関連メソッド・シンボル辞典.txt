# ãƒšãƒ³ãƒ„ãƒ¼ãƒ«é–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ã‚·ãƒ³ãƒœãƒ«è¾å…¸

## ğŸ“‹ æ¦‚è¦
ç¾åœ¨ã®ãƒ„ãƒ¼ãƒ«ã‚µã‚¤ã‚ºç®¡ç†ã¨ãƒšãƒ³/æ¶ˆã—ã‚´ãƒ åˆ‡ã‚Šæ›¿ãˆãƒ•ãƒ­ãƒ¼ã‚’ä¿¯ç°çš„ã«ç¢ºèªã™ã‚‹ãŸã‚ã®è¾å…¸

---

## ğŸ¯ ç¾åœ¨ã®å•é¡Œç‚¹

### 1. **ToolSizeManager ãŒå­˜åœ¨ã—ãªã„**
- `system/tool-size-manager.js` ã®URLã¯å®Ÿéš›ã«ã¯ `system/drawing/drawing-engine.js` ã‚’æŒ‡ã—ã¦ã„ã‚‹
- çœŸã® ToolSizeManager ã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„
- config.js ã«ã¯ `tools`ã€`sizeSlots`ã€`dragAdjustment` ã®è¨­å®šã¯ã‚ã‚‹ãŒã€ãã‚Œã‚’ç®¡ç†ã™ã‚‹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒä¸åœ¨

### 2. **EventBus ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©ãŒä¸å®Œå…¨**
- `tool:size-opacity-changed` ã‚¤ãƒ™ãƒ³ãƒˆã¯ DrawingEngine ã§è³¼èª­ã•ã‚Œã¦ã„ã‚‹
- `tool:size:changed` ã‚¤ãƒ™ãƒ³ãƒˆã‚‚è³¼èª­ã•ã‚Œã¦ã„ã‚‹
- ã—ã‹ã—ã€ã“ã‚Œã‚‰ã‚’ **ç™ºç«ã™ã‚‹å´** (ToolSizePopup) ãŒæœªå®Ÿè£…

### 3. **UIController ã®ãƒ•ãƒ­ãƒ¼**
- `handleToolClick()` ã§ `toolbarIconClickMode` ã‚’ä½¿ã£ãŸåˆ¤å®šã¯å®Ÿè£…æ¸ˆã¿
- `showToolSizePopup(tool)` ãƒ¡ã‚½ãƒƒãƒ‰ã¯å®Ÿè£…æ¸ˆã¿ã ãŒã€`window.ToolSizePopup` ãŒæœªå®šç¾©

---

## ğŸ” æ—¢å­˜ã®é–¢é€£ã‚·ãƒ³ãƒœãƒ«ä¸€è¦§

### Config (config.js)
```javascript
// ãƒ„ãƒ¼ãƒ«è¨­å®š
window.TEGAKI_CONFIG.tools = {
  pen: { defaultSize: 10, defaultOpacity: 0.85 },
  eraser: { defaultSize: 20, defaultOpacity: 1.0 }
}

// ã‚µã‚¤ã‚ºã‚¹ãƒ­ãƒƒãƒˆ (1-9ã‚­ãƒ¼ç”¨)
window.TEGAKI_CONFIG.sizeSlots = {
  pen: [2, 4, 6, 8, 12, 16, 24, 36, 50],
  eraser: [10, 15, 20, 30, 40, 50, 60, 80, 100]
}

// ãƒ‰ãƒ©ãƒƒã‚°èª¿æ•´è¨­å®š
window.TEGAKI_CONFIG.dragAdjustment = {
  size: { sensitivity: 0.1, min: 0.1, max: 100 },
  opacity: { sensitivity: 0.005, min: 0.0, max: 1.0 },
  visual: { textColor: '#ffffff', fontSize: 12, showValues: true, animationDuration: 150 }
}
```

### EventBus (system/event-bus.js)
```javascript
class EventBus {
  on(eventName, callback)      // ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
  emit(eventName, data)         // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  off(eventName, callback)      // ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­è§£é™¤
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
window.TegakiEventBus
window.EventBus (æœªç¢ºèªã€è¦ãƒã‚§ãƒƒã‚¯)
```

### BrushSettings (system/drawing/brush-settings.js)
```javascript
class BrushSettings {
  // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
  size: number
  color: number
  opacity: number
  
  // ãƒ¡ã‚½ãƒƒãƒ‰
  setBrushSize(size)
  setBrushColor(color)
  setBrushOpacity(opacity)
  getBrushSize()
  getBrushColor()
  getBrushOpacity()
  getCurrentSettings()
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
window.TegakiDrawing.BrushSettings
window.BrushSettings
globalThis.BrushSettings
```

### DrawingEngine (system/tool-size-manager.js ã®å®Ÿä½“)
```javascript
class DrawingEngine {
  constructor(cameraSystem, layerManager, eventBus, config)
  
  // BrushSettings çµ±åˆ
  settings: BrushSettings
  
  // ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
  subscribeToSettings() {
    // 'tool:size:changed' è³¼èª­
    // 'tool:size-opacity-changed' è³¼èª­
  }
  
  // æç”»åˆ¶å¾¡
  setTool(tool)               // 'pen' | 'eraser'
  setBrushSize(size)          // settings.setBrushSize() ã‚’å‘¼ã¶
  setBrushColor(color)
  setBrushOpacity(opacity)
  getCurrentTool()
  getIsDrawing()
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
window.TegakiDrawing.DrawingEngine
```

### UIController (ui/ui-panels.js)
```javascript
class UIController {
  constructor(drawingEngine, layerManager, app)
  
  // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
  toolbarIconClickMode: boolean  // ã‚¢ã‚¤ã‚³ãƒ³ç›´ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç”¨
  
  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆ¶å¾¡
  showPopup(popup)
  closeAllPopups(exceptPopup)
  closeToolSizePopup()          // window.ToolSizePopup.hide() ã‚’å‘¼ã¶
  showToolSizePopup(tool)       // window.ToolSizePopup.show(tool) ã‚’å‘¼ã¶
  
  // ãƒ„ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆ
  handleToolClick(button)
  updateToolUI(tool)
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
window.TegakiUI.UIController
window.TegakiUI.uiController  // ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
```

---

## ğŸ”„ ç¾åœ¨ã®ãƒ•ãƒ­ãƒ¼ (ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ P/E)

```
1. KeyboardHandler ãŒ 'KeyP' ã‚’æ¤œå‡º
2. EventBus.emit('ui:tool-changed', { tool: 'pen' })
3. CoreRuntime ãŒå—ä¿¡ã€drawingEngine.setTool('pen')
4. DrawingEngine.setTool('pen')
   - this.currentTool = 'pen'
   - EventBus.emit('toolChanged', { tool: 'pen' })
5. UIController.updateToolUI('pen')
   - ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
```

**ç‰¹å¾´:**
- ToolSizePopup ã¯è¡¨ç¤ºã•ã‚Œãªã„ (toolbarIconClickMode = false)
- ã‚µã‚¤ã‚º/ä¸é€æ˜åº¦ã®å¤‰æ›´ãªã—

---

## ğŸ–±ï¸ ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ•ãƒ­ãƒ¼ (å®Ÿè£…è¨ˆç”»)

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒšãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. UIController.setupEventDelegation() ãŒ click ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒƒãƒ
3. toolbarIconClickMode = true ã«è¨­å®š
4. UIController.handleToolClick(button)
   â”œâ”€ 'pen-tool' ã®å ´åˆ
   â”‚  â”œâ”€ CoreRuntime.api.setTool('pen')
   â”‚  â”œâ”€ if (toolbarIconClickMode)
   â”‚  â”‚   â””â”€ showToolSizePopup('pen')  // ğŸ†• ã“ã“ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
   â”‚  â””â”€ updateToolUI('pen')
   â””â”€ toolbarIconClickMode = false ã«ãƒªã‚»ãƒƒãƒˆ
```

---

## ğŸ“¦ å®Ÿè£…ã™ã¹ãã‚‚ã®

### 1. **ToolSizeManager ã‚¯ãƒ©ã‚¹**
**è²¬å‹™:** ãƒ„ãƒ¼ãƒ«ã”ã¨ã®ã‚µã‚¤ã‚º/ä¸é€æ˜åº¦çŠ¶æ…‹ç®¡ç†ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆç®¡ç†

```javascript
class ToolSizeManager {
  constructor(eventBus, config)
  
  // çŠ¶æ…‹ç®¡ç†
  state = {
    pen: { size: 10, opacity: 0.85, activeSlot: 0 },
    eraser: { size: 20, opacity: 1.0, activeSlot: 0 }
  }
  
  // ãƒ¡ã‚½ãƒƒãƒ‰
  getSize(tool)
  getOpacity(tool)
  setSize(tool, size)
  setOpacity(tool, opacity)
  setSizeOpacity(tool, size, opacity)  // EventBus ç™ºç«å«ã‚€
  
  getActiveSlot(tool)
  setActiveSlot(tool, slotIndex)
  applySizeFromSlot(tool, slotIndex)
  
  // ã‚¹ãƒ­ãƒƒãƒˆå€¤å–å¾—
  getSlotValue(tool, slotIndex)  // config ã‹ã‚‰å–å¾—
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
window.ToolSizeManager
```

**EventBus ç™ºç«:**
- `tool:size-opacity-changed` - { tool, size, opacity }

### 2. **ToolSizePopup ã‚¯ãƒ©ã‚¹**
**è²¬å‹™:** ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—UIæ§‹ç¯‰ã€ã‚¹ãƒ­ãƒƒãƒˆ/ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œã€ToolSizeManager ã¨ã®é€£æº

```javascript
class ToolSizePopup {
  constructor(config, toolSizeManager)
  
  // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
  element: HTMLElement       // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—DOM
  currentTool: 'pen' | 'eraser'
  visible: boolean
  
  // ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«
  show(tool)
  hide()
  isVisible()
  
  // UIæ§‹ç¯‰
  _createPopupElement()
  _createSlotsContainer()
  _createSlider()
  _updateSlotUI()
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  _onSlotClick(slotIndex)
  _onSliderChange(value)
  _onStepButtonClick(direction)  // â—€â–¶ãƒœã‚¿ãƒ³
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
window.ToolSizePopup
```

**DOMæ§‹é€ :**
```html
<div class="tool-size-popup-panel">
  <div class="slots-container">
    <div class="slot-item [active]">
      <div class="slot-dot"></div>
      <div class="slot-number">1</div>
    </div>
    <!-- x6 -->
  </div>
  <div class="size-slider-container">
    <button class="slider-step-btn">â—€</button>
    <div class="slider-wrapper">
      <input type="range" class="size-slider" />
      <input type="number" class="size-value-input" />
    </div>
    <button class="slider-step-btn">â–¶</button>
  </div>
</div>
```

---

## ğŸ¨ CSS (styles/main.css)

**æ—¢å­˜:** `.tool-size-popup-panel`ã€`.slots-container`ã€`.slot-item` ãªã©åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¯å®Ÿè£…æ¸ˆã¿

**ç¢ºèªäº‹é …:**
- ã‚¹ãƒ­ãƒƒãƒˆã®â—ã‚µã‚¤ã‚ºè¨ˆç®—å¼: `Math.min(dotMaxSize, Math.max(dotMinSize, (value / 500) * 20))`
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨

---

## âš ï¸ æ”¹ä¿®æ™‚ã®æ³¨æ„ç‚¹

### 1. **tool-size-manager.js ã¯æ–°è¦ä½œæˆ**
- ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ drawing-engine.js ãªã®ã§ã€çœŸã® ToolSizeManager ã‚’æ–°è¦ä½œæˆ

### 2. **EventBus çµ±åˆ**
- `window.EventBus` ã¨ `window.TegakiEventBus` ã®ã©ã¡ã‚‰ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- å…¨ä½“ã§çµ±ä¸€ã•ã‚ŒãŸ EventBus ã‚’ä½¿ç”¨

### 3. **config.js ã®æ‹¡å¼µ**
è¨ˆç”»æ›¸ã«ã‚ã‚‹ `toolSizePopup` è¨­å®šã‚’è¿½åŠ :
```javascript
toolSizePopup: {
  slots: [1, 3, 5, 10, 30, 100],
  sliderMin: 0.1,
  sliderMax: 500,
  dotMinSize: 4,
  dotMaxSize: 20
}
```

### 4. **ã‚¹ãƒ­ãƒƒãƒˆå€¤ã®å–å¾—å…ˆ**
- è¨ˆç”»æ›¸ã§ã¯ `slots: [1, 3, 5, 10, 30, 100]` (6å€‹å›ºå®š)
- config.js ã® `sizeSlots` ã¯ `[2, 4, 6, 8, 12, 16, 24, 36, 50]` (9å€‹ã€1-9ã‚­ãƒ¼ç”¨)
- **ã©ã¡ã‚‰ã‚’ä½¿ã†ã‹æ˜ç¢ºåŒ–ãŒå¿…è¦**

### 5. **ãƒ†ãƒ¼ãƒ‘ãƒªãƒ³ã‚°ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼**
è¨ˆç”»æ›¸ã®åˆ»ã¿å¹…:
- 1ï½3: 0.1åˆ»ã¿
- 3ï½10: 0.5åˆ»ã¿
- 10ï½30: 1åˆ»ã¿
- 30ï½200: 10åˆ»ã¿
- 200ï½500: 50åˆ»ã¿

â†’ â—€â–¶ãƒœã‚¿ãƒ³ã§å®Ÿè£…

---

## âœ… æ”¹ä¿®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] **ToolSizeManager ã‚¯ãƒ©ã‚¹æ–°è¦ä½œæˆ** (system/tool-size-manager.js)
- [ ] **ToolSizePopup ã‚¯ãƒ©ã‚¹æ–°è¦ä½œæˆ** (ui/tool-size-popup.js)
- [ ] **config.js æ‹¡å¼µ** (`toolSizePopup` è¨­å®šè¿½åŠ )
- [ ] **UIController.showToolSizePopup() ã®å‹•ä½œç¢ºèª**
- [ ] **EventBus ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ç¢ºèª** (`tool:size-opacity-changed`)
- [ ] **CSS ã‚¹ã‚¿ã‚¤ãƒ«ç¢ºèª** (ã‚¹ãƒ­ãƒƒãƒˆâ—ã‚µã‚¤ã‚ºã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹)
- [ ] **index.html ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é †åº** (tool-size-manager.js â†’ tool-size-popup.js)

---

## ğŸš€ å®Ÿè£…å„ªå…ˆé †ä½

1. **Phase 1:** ToolSizeManager ã‚¯ãƒ©ã‚¹å®Ÿè£…
2. **Phase 2:** ToolSizePopup ã‚¯ãƒ©ã‚¹å®Ÿè£… (åŸºæœ¬UI)
3. **Phase 3:** ã‚¹ãƒ­ãƒƒãƒˆ/ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ©Ÿèƒ½å®Ÿè£…
4. **Phase 4:** ãƒ†ãƒ¼ãƒ‘ãƒªãƒ³ã‚°åˆ»ã¿å¹…å®Ÿè£… (â—€â–¶ãƒœã‚¿ãƒ³)
5. **Phase 5:** çµ±åˆãƒ†ã‚¹ãƒˆ (ãƒšãƒ³â‡”æ¶ˆã—ã‚´ãƒ åˆ‡ã‚Šæ›¿ãˆã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆå¾©å¸°)