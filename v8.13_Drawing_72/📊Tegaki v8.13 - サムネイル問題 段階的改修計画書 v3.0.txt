================================================================================
Tegaki v8.13 - ã‚µãƒ ãƒã‚¤ãƒ«å•é¡Œ æ®µéšçš„æ”¹ä¿®è¨ˆç”»æ›¸ v3.0
================================================================================

## ğŸ“‹ å•é¡Œã®æ ¹æœ¬åŸå› 

### 1. ThumbnailSystemã®äºŒé‡å®Ÿè£…
- `_renderLayerThumbnail()` ãŒåŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«2ã¤å­˜åœ¨
  - 1ã¤ç›®: ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ å…¨ä½“ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ–¹å¼ï¼‰
  - 2ã¤ç›®: ãƒ•ã‚¡ã‚¤ãƒ«å¾ŒåŠï¼ˆãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æ–¹å¼ï¼‰
- ã©ã¡ã‚‰ã‚’ä½¿ã†ã¹ãã‹ä¸æ˜ç¢ºã§æ··ä¹±ã‚’æ‹›ã

### 2. layer-system.jsã®ç‹¬è‡ªã‚µãƒ ãƒã‚¤ãƒ«å®Ÿè£…
- `updateThumbnail()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ç‹¬è‡ªå®Ÿè£…
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä¸€æ™‚ã‚³ãƒ³ãƒ†ãƒŠã«ç§»å‹•ã™ã‚‹ç ´å£Šçš„å‡¦ç†
- Transformä¸€æ™‚ãƒªã‚»ãƒƒãƒˆâ†’å¾©å…ƒæ™‚ã«ã‚ºãƒ¬ãŒç™ºç”Ÿ

### 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼æ–­çµ¶
```
layer-transform.js â†’ layer:transform-updated ç™ºç«
  â”œâ†’ layer-panel-renderer.js âœ… è³¼èª­ã‚ã‚Š
  â”œâ†’ timeline-thumbnail-utils.js âœ… è³¼èª­ã‚ã‚Š
  â””â†’ layer-system.js âŒ è³¼èª­ãªã—ï¼ˆç‹¬è‡ªupdateThumbnailä½¿ç”¨ï¼‰
```

### 4. Vãƒ¢ãƒ¼ãƒ‰æ™‚ã®åè»¢æ©Ÿèƒ½ã®å•é¡Œ
- Vãƒ¢ãƒ¼ãƒ‰æ™‚ã®åè»¢ãƒœã‚¿ãƒ³ãŒdisabledçŠ¶æ…‹ã®ã¾ã¾
- ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆH/Shift+Hï¼‰ã‚‚åŠ¹ã‹ãªã„
- layer-transform.jsè‡ªä½“ã¯æ­£å¸¸ã«å‹•ä½œ


================================================================================
## ğŸ—ºï¸ ãƒ•ãƒ­ãƒ¼å›³

### ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼ï¼ˆç¾çŠ¶ï¼‰

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ]
  â†“
[layer-transform.js] applyTransform()
  â†“ gsap.delayedCall(0.016)
  â†“
  â”œâ†’ layer:transform-updated ç™ºç«
  â”‚    â”œâ†’ timeline-thumbnail-utils.js âœ…
  â”‚    â””â†’ layer-panel-renderer.js âœ…
  â”‚
  â””â†’ thumbnail:layer-updated ç™ºç«
       â”œâ†’ timeline-thumbnail-utils.js âœ…
       â””â†’ layer-panel-renderer.js âœ…

âŒ layer-system.js ã¯è³¼èª­ã›ãšã€ç‹¬è‡ªã® updateThumbnail() ã‚’ä½¿ç”¨
```

### ç†æƒ³ã®ãƒ•ãƒ­ãƒ¼ï¼ˆæ”¹ä¿®å¾Œï¼‰

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ]
  â†“
[layer-transform.js] applyTransform()
  â†“ gsap.delayedCall(0.016)
  â†“
layer:transform-updated ç™ºç«
  â†“
  â”œâ†’ [ThumbnailSystem] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
  â”œâ†’ [layer-panel-renderer.js] ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
  â””â†’ [timeline-thumbnail-utils.js] ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°

âœ… ã™ã¹ã¦ThumbnailSystemã«çµ±ä¸€
âœ… layer-system.jsã®ç‹¬è‡ªå®Ÿè£…ã‚’å‰Šé™¤
```


================================================================================
## ğŸ“š ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ã‚·ãƒ³ãƒœãƒ«è¾å…¸

### ThumbnailSystem
```
generateLayerThumbnail(layer, w, h) â†’ Promise<Canvas>
  ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
  
_renderLayerThumbnail(layer, w, h) â†’ Promise<Canvas>
  âŒ å•é¡Œ: åŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«2ã¤å­˜åœ¨
  
_generateBackgroundThumbnail(layer, w, h) â†’ Promise<Canvas>
  èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼å°‚ç”¨ã‚µãƒ ãƒã‚¤ãƒ«
  
_resizeRenderTextureToCanvas(rt, w, h) â†’ Promise<Canvas>
  RenderTextureã‚’Canvasã«ãƒªã‚µã‚¤ã‚º
  
_invalidateLayerCacheByLayerId(layerId) â†’ void
  ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
  
clearAllCache() â†’ void
  å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
```

### LayerSystem
```
updateThumbnail(layerIndex) â†’ void
  âŒ ç‹¬è‡ªå®Ÿè£…ï¼ˆå‰Šé™¤å¯¾è±¡ï¼‰
  
requestThumbnailUpdate(layerIndex) â†’ void
  ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
  
processThumbnailUpdates() â†’ void
  ã‚­ãƒ¥ãƒ¼ã‚’å‡¦ç†ã—ã¦updateThumbnail()å‘¼ã³å‡ºã—
```

### LayerTransform
```
applyTransform(layer, transform, cx, cy) â†’ void
  Transformé©ç”¨ + GSAPåŒæœŸ
  gsap.delayedCall(0.016) ã§ _emitTransformUpdated() ã‚’å‘¼ã¶
  
_emitTransformUpdated(layerId, layer) â†’ void
  layer:transform-updated ç™ºç«ï¼ˆthrottleä»˜ãï¼‰
  
flipLayer(layer, direction) â†’ void
  åè»¢å‡¦ç†
  
_updateFlipButtonsAvailability(isVMode) â†’ void
  Vãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒœã‚¿ãƒ³disabledåˆ¶å¾¡
```

### LayerPanelRenderer
```
updateLayerThumbnail(layerIndex) â†’ Promise<void>
  ThumbnailSystemã‹ã‚‰ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—â†’DOMæ›´æ–°
  
_generateAndDisplayThumbnail(layer, index, img) â†’ Promise<void>
  ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆãƒ»è¡¨ç¤º
```

### EventBus
```
on(event, callback, priority=0) â†’ void
  ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ï¼ˆpriorityæŒ‡å®šå¯èƒ½ï¼‰
  
emit(event, data) â†’ void
  ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
```

### ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆ
```
keyboard:vkey-pressed        Vã‚­ãƒ¼æŠ¼ä¸‹
keyboard:vkey-released       Vã‚­ãƒ¼é›¢ã—ãŸ
layer:transform-updated      Transformæ›´æ–°ï¼ˆthrottleä»˜ãï¼‰
thumbnail:layer-updated      ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```


================================================================================
## ğŸ¯ æ®µéšçš„æ”¹ä¿®è¨ˆç”»

### Phase 1: ThumbnailSystemã®äºŒé‡å®Ÿè£…æ’²æ»…ã€æœ€å„ªå…ˆã€‘
**ç›®çš„:** `_renderLayerThumbnail()` ã®é‡è¤‡ã‚’å‰Šé™¤ã—å˜ä¸€å®Ÿè£…ã«çµ±ä¸€

**æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«:**
- `system/drawing/thumbnail-system.js`

**å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«:**
- `ğŸ“Š åº§æ¨™ç³»ã¨ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ - å…¨ä½“æ§‹é€ åˆ†æãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ.txt`

**å‡¦ç†å†…å®¹:**
1. ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã® `_renderLayerThumbnail()` ã‚’å‰Šé™¤
   - 1-80è¡Œç›®ã‚ãŸã‚Šã®å®Ÿè£…ã‚’å‰Šé™¤
   
2. ãƒ•ã‚¡ã‚¤ãƒ«å¾ŒåŠã® `_renderLayerThumbnail()` ã‚’æ®‹ã™
   - ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æ–¹å¼ã®å®Ÿè£…ï¼ˆPhase 4å®Œå…¨ç‰ˆï¼‰
   
3. å‰Šé™¤ã™ã‚‹å®Ÿè£…ã®ç‰¹å¾´:
   ```javascript
   // âŒ å‰Šé™¤å¯¾è±¡
   async _renderLayerThumbnail(layer, width, height) {
       const frameContainer = layer.parent;
       // ä»–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’éè¡¨ç¤ºåŒ–
       const siblingVisibility = new Map();
       frameContainer.children.forEach(sibling => {
           if (sibling !== layer) {
               siblingVisibility.set(sibling, sibling.visible);
               sibling.visible = false;
           }
       });
       // ...
   }
   ```

4. æ®‹ã™å®Ÿè£…ã®ç‰¹å¾´:
   ```javascript
   // âœ… ã“ã‚Œã‚’æ®‹ã™
   async _renderLayerThumbnail(layer, width, height) {
       const bounds = layer.getLocalBounds();
       // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æ–¹å¼
       // tempContainerã‚’ä½¿ç”¨
   }
   ```

**DRY/SOLIDæº–æ‹ :**
- å˜ä¸€è²¬ä»»åŸå‰‡: 1ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒ1ã¤ã®å®Ÿè£…ã®ã¿
- é‡è¤‡æ’é™¤: åŒåãƒ¡ã‚½ãƒƒãƒ‰ã®äºŒé‡å®šç¾©ã‚’æ’²æ»…


---

### Phase 2: layer-system.jsã®ç‹¬è‡ªå®Ÿè£…å‰Šé™¤ã€æœ€å„ªå…ˆã€‘
**ç›®çš„:** ThumbnailSystemã«å®Œå…¨çµ±ä¸€

**æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«:**
- `system/layer-system.js`

**å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«:**
- `system/drawing/thumbnail-system.js`
- `ui/layer-panel-renderer.js`

**å‡¦ç†å†…å®¹:**
1. `updateThumbnail(layerIndex)` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Œå…¨å‰Šé™¤
   - ç ´å£Šçš„ãªä¸€æ™‚ã‚³ãƒ³ãƒ†ãƒŠç§»å‹•å‡¦ç†ã‚’å‰Šé™¤
   
2. `requestThumbnailUpdate(layerIndex)` ã‚’ä¿®æ­£
   ```javascript
   // âŒ ç¾çŠ¶
   requestThumbnailUpdate(layerIndex) {
       this.thumbnailUpdateQueue.add(layerIndex);
       // ... updateThumbnail()ã‚’å‘¼ã¶
   }
   
   // âœ… ä¿®æ­£å¾Œ
   requestThumbnailUpdate(layerIndex) {
       if (this.eventBus) {
           this.eventBus.emit('thumbnail:layer-updated', {
               component: 'layer-system',
               action: 'update-requested',
               data: { layerIndex, immediate: false }
           });
       }
   }
   ```

3. `processThumbnailUpdates()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‰Šé™¤
   - ã‚‚ã¯ã‚„ä¸è¦

4. `_startThumbnailUpdateProcess()` ã‚’å‰Šé™¤
   - setIntervalã§å®šæœŸå®Ÿè¡Œã—ã¦ã„ãŸå‡¦ç†ã‚’å‰Šé™¤

**DRY/SOLIDæº–æ‹ :**
- å˜ä¸€è²¬ä»»åŸå‰‡: LayerSystemã¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã®ã¿ã€ã‚µãƒ ãƒã‚¤ãƒ«ã¯ThumbnailSystem
- é‡è¤‡æ’é™¤: ç‹¬è‡ªå®Ÿè£…ã‚’å‰Šé™¤ã—æ—¢å­˜ã®ThumbnailSystemã«çµ±ä¸€


---

### Phase 3: ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼çµ±åˆã€é‡è¦ã€‘
**ç›®çš„:** ã™ã¹ã¦ã®ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ã‚’ThumbnailSystemã«é›†ç´„

**æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«:**
- `system/layer-system.js`

**å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«:**
- `system/event-bus.js`
- `system/drawing/thumbnail-system.js`

**å‡¦ç†å†…å®¹:**
1. layer-system.js ã« `layer:transform-updated` è³¼èª­ã‚’è¿½åŠ 
   ```javascript
   _setupEventListeners() {
       // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ã«è¿½åŠ 
       this.eventBus.on('layer:transform-updated', ({ data }) => {
           const { layerIndex, layerId } = data || {};
           if (layerIndex !== undefined) {
               // Phase 2ã§ä¿®æ­£ã—ãŸ requestThumbnailUpdate() ã‚’å‘¼ã¶
               this.requestThumbnailUpdate(layerIndex);
           }
       });
   }
   ```

2. flipActiveLayer() ã«æ˜ç¤ºçš„ãªã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã‚’è¿½åŠ ï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ç¢ºèªï¼‰
   ```javascript
   flipActiveLayer(direction) {
       if (!this.transform) return;
       const activeLayer = this.getActiveLayer();
       if (activeLayer) {
           this.transform.flipLayer(activeLayer, direction);
           this.requestThumbnailUpdate(this.activeLayerIndex);
           
           // âœ… æ—¢ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
           if (this.eventBus) {
               this.eventBus.emit('layer:transform-updated', { 
                   layerId: activeLayer.layerData.id 
               });
           }
       }
   }
   ```

**DRY/SOLIDæº–æ‹ :**
- ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•è¨­è¨ˆ: ã™ã¹ã¦ã®æ›´æ–°ãŒEventBusçµŒç”±
- ç–çµåˆ: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒç›´æ¥ä¾å­˜ã›ãšã‚¤ãƒ™ãƒ³ãƒˆã§é€£æº


---

### Phase 4: Vãƒ¢ãƒ¼ãƒ‰æ™‚ã®åè»¢æ©Ÿèƒ½ä¿®å¾©ã€å¿…é ˆã€‘
**ç›®çš„:** Vãƒ¢ãƒ¼ãƒ‰æ™‚ã«åè»¢ãƒœã‚¿ãƒ³/ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’æœ‰åŠ¹åŒ–

**æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«:**
- `system/layer-transform.js`

**å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«:**
- `ui/keyboard-handler.js`
- `system/layer-system.js`

**å‡¦ç†å†…å®¹:**
1. `_updateFlipButtonsAvailability(isVMode)` ã‚’ç¢ºèª
   - æ—¢ã«å®Ÿè£…æ¸ˆã¿ã‚’ç¢ºèª
   - `enterMoveMode()` ã§å‘¼ã°ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   
2. ãƒœã‚¿ãƒ³ã®HTML/CSSç¢ºèª
   ```javascript
   // layer-transform.js ã® _setupTransformPanel() ã§
   flipHorizontalBtn.setAttribute('disabled', 'true');
   // â†“ Vãƒ¢ãƒ¼ãƒ‰æ™‚ã«
   flipHorizontalBtn.removeAttribute('disabled');
   ```

3. ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå‡¦ç†ç¢ºèª
   - keyboard-handler.jsã®`LAYER_FLIP_HORIZONTAL`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
   - `isVKeyPressed` ã®æ¡ä»¶åˆ¤å®šã‚’ç¢ºèª
   
4. layer-system.js ã® `flipActiveLayer()` å‘¼ã³å‡ºã—ãƒ‘ã‚¹ç¢ºèª
   - keyboard-handler â†’ layer-system.flipActiveLayer()
   - layer-transform.onFlipRequest â†’ layer-system.flipActiveLayer()

**ãƒ•ãƒ­ãƒ¼ç¢ºèª:**
```
[Vã‚­ãƒ¼æŠ¼ä¸‹]
  â†’ keyboard:vkey-pressed
  â†’ layer-system._setupVKeyEvents()
  â†’ layer-transform.enterMoveMode()
  â†’ _updateFlipButtonsAvailability(true) â† ã“ã“ã§ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–

[Hã‚­ãƒ¼æŠ¼ä¸‹ï¼ˆVãƒ¢ãƒ¼ãƒ‰ä¸­ï¼‰]
  â†’ keyboard-handler.handleKeyDown()
  â†’ action = LAYER_FLIP_HORIZONTAL
  â†’ layer-system.flipActiveLayer('horizontal')
  â†’ layer-transform.flipLayer(layer, 'horizontal')
```

**æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ:**
- Vã‚­ãƒ¼æŠ¼ä¸‹æ™‚ã«`_updateFlipButtonsAvailability(true)`ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ã‹
- ãƒœã‚¿ãƒ³ã®`disabled`å±æ€§ãŒæ­£ã—ãå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹
- keyboard-handlerã®`vKeyPressed`ãƒ•ãƒ©ã‚°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹


---

### Phase 5: Canvas2Dä¾å­˜ã®å®Œå…¨æ’²æ»…ã€å“è³ªå‘ä¸Šã€‘
**ç›®çš„:** ã™ã¹ã¦ã®ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã‚’PixiJS RenderTextureã«çµ±ä¸€

**æ”¹ä¿®ãƒ•ã‚¡ã‚¤ãƒ«:**
- `system/drawing/thumbnail-system.js`

**å‚è€ƒãƒ•ã‚¡ã‚¤ãƒ«:**
- `ui/layer-panel-renderer.js`
- `ui/timeline-thumbnail-utils.js`

**å‡¦ç†å†…å®¹:**
1. `_generateBackgroundThumbnail()` ã®ç¢ºèª
   ```javascript
   // ç¾çŠ¶: Canvas2Dã‚’ä½¿ç”¨
   const canvas = document.createElement('canvas');
   const ctx = canvas.getContext('2d');
   ctx.fillRect(0, 0, width, height);
   
   // âœ… å•é¡Œãªã—: èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å˜è‰²å¡—ã‚Šã¤ã¶ã—ãªã®ã§Canvas2Dè¨±å®¹
   // ã¾ãŸã¯ PixiJS Graphics ã§ä»£æ›¿å¯èƒ½
   ```

2. ã™ã¹ã¦ã®ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆãƒ‘ã‚¹ã‚’ç¢ºèª
   - `generateLayerThumbnail()` â†’ RenderTextureä½¿ç”¨ âœ…
   - `generateFrameThumbnail()` â†’ RenderTextureä½¿ç”¨ âœ…
   - `_renderFrameThumbnailPixiJS()` â†’ RenderTextureä½¿ç”¨ âœ…

3. DataURLå¤‰æ›ã¯è¨±å®¹
   ```javascript
   // âœ… å•é¡Œãªã—: Canvas.toDataURL()ã¯æœ€çµ‚å‡ºåŠ›ãªã®ã§è¨±å®¹
   const dataURL = canvas.toDataURL('image/png');
   ```

**Canvas2Dä½¿ç”¨ç®‡æ‰€ã®åˆ†é¡:**
- âŒ ç¦æ­¢: æç”»å‡¦ç†ãƒ»å¤‰å½¢å‡¦ç†ã§ã®Canvas2Dä½¿ç”¨
- âœ… è¨±å®¹: æœ€çµ‚å‡ºåŠ›ï¼ˆtoDataURLï¼‰ã€èƒŒæ™¯å˜è‰²å¡—ã‚Šã¤ã¶ã—

**DRY/SOLIDæº–æ‹ :**
- æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯çµ±ä¸€: PixiJSä¸­å¿ƒã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç¶­æŒ


---

### Phase 6: æœ€çµ‚æ¤œè¨¼ãƒ»ãƒ‡ãƒãƒƒã‚°ã€å“è³ªä¿è¨¼ã€‘
**ç›®çš„:** ã™ã¹ã¦ã®å•é¡ŒãŒè§£æ±ºã—ãŸã“ã¨ã‚’ç¢ºèª

**æ¤œè¨¼é …ç›®:**

1. **ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã®å³åº§æ›´æ–°**
   - Vãƒ¢ãƒ¼ãƒ‰ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ»å›è»¢ãƒ»æ‹¡ç¸®
   - ã‚µãƒ ãƒã‚¤ãƒ«ãŒå³åº§ã«æ›´æ–°ã•ã‚Œã‚‹ã‹
   - éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚æ­£ã—ãæ›´æ–°ã•ã‚Œã‚‹ã‹

2. **ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«ã®å³åº§æ›´æ–°**
   - Vãƒ¢ãƒ¼ãƒ‰ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰å½¢
   - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«ãŒå³åº§ã«æ›´æ–°ã•ã‚Œã‚‹ã‹
   - åˆå›ã§ã‚‚æ­£ã—ãåæ˜ ã•ã‚Œã‚‹ã‹

3. **Vãƒ¢ãƒ¼ãƒ‰æ™‚ã®åè»¢æ©Ÿèƒ½**
   - ãƒ‘ãƒãƒ«å†…ã®åè»¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‹
   - Hã‚­ãƒ¼ã§æ°´å¹³åè»¢ã§ãã‚‹ã‹
   - Shift+Hã‚­ãƒ¼ã§å‚ç›´åè»¢ã§ãã‚‹ã‹

4. **ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ**
   ```javascript
   // ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
   window.ThumbnailSystem.getDebugInfo()
   // â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºã€Vãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ãªã©ã‚’ç¢ºèª
   
   window.TegakiUI.LayerPanelRenderer.prototype.debugPrintCacheInfo()
   // â†’ ãƒ‘ãƒãƒ«å´ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ…‹ã‚’ç¢ºèª
   ```

5. **ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ç¢ºèª**
   ```javascript
   // event-bus.js ã§ debug ã‚’æœ‰åŠ¹åŒ–
   window.TegakiEventBus.setDebug(true);
   
   // layer:transform-updated ãŒæ­£ã—ãç™ºç«ã—ã¦ã„ã‚‹ã‹
   // thumbnail:layer-updated ãŒæ­£ã—ãç™ºç«ã—ã¦ã„ã‚‹ã‹
   ```


================================================================================
## ğŸ“Š æ”¹ä¿®å‰å¾Œã®æ¯”è¼ƒ

### æ”¹ä¿®å‰ï¼ˆç¾çŠ¶ï¼‰
```
[ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã®å®Ÿè£…ç®‡æ‰€]
â”œâ”€ ThumbnailSystem._renderLayerThumbnail() âŒ 2ã¤å­˜åœ¨
â”œâ”€ layer-system.updateThumbnail() âŒ ç‹¬è‡ªå®Ÿè£…
â””â”€ layer-panel-renderer._generateAndDisplayThumbnail() âœ…

[ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼]
layer:transform-updated
â”œâ†’ layer-panel-renderer âœ…
â”œâ†’ timeline-thumbnail-utils âœ…
â””â†’ layer-system âŒ è³¼èª­ãªã—
```

### æ”¹ä¿®å¾Œï¼ˆç›®æ¨™ï¼‰
```
[ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã®å®Ÿè£…ç®‡æ‰€]
â”œâ”€ ThumbnailSystem._renderLayerThumbnail() âœ… å˜ä¸€å®Ÿè£…
â””â”€ layer-panel-renderer._generateAndDisplayThumbnail() âœ…

[ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼]
layer:transform-updated
â”œâ†’ ThumbnailSystem âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
â”œâ†’ layer-panel-renderer âœ… ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
â”œâ†’ timeline-thumbnail-utils âœ… ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
â””â†’ layer-system âœ… requestThumbnailUpdate()
```


================================================================================
## âš ï¸ æ³¨æ„äº‹é …

### DRY/SOLIDåŸå‰‡ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] åŒåãƒ¡ã‚½ãƒƒãƒ‰ã®äºŒé‡å®Ÿè£…ãŒãªã„ã‹
- [ ] åº§æ¨™å¤‰æ›å‡¦ç†ã®é‡è¤‡ãŒãªã„ã‹
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ã®æ¼ã‚ŒãŒãªã„ã‹
- [ ] Canvas2Dã®ä¸è¦ãªä½¿ç”¨ãŒãªã„ã‹
- [ ] ç ´å£Šçš„ãªå‡¦ç†ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ï¼‰ãŒãªã„ã‹

### Canvas2Dä½¿ç”¨åˆ¤å®šåŸºæº–
- âŒ ç¦æ­¢: ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã€Transformé©ç”¨ã€æç”»å‡¦ç†
- âœ… è¨±å®¹: toDataURLï¼ˆæœ€çµ‚å‡ºåŠ›ï¼‰ã€èƒŒæ™¯å˜è‰²å¡—ã‚Šã¤ã¶ã—

### ã‚¤ãƒ™ãƒ³ãƒˆå‘½åè¦å‰‡
```
component:action
ä¾‹: layer:transform-updated
    thumbnail:layer-updated
    keyboard:vkey-pressed
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼åŸå‰‡
```
PointerEvent â†’ CoordinateSystem â†’ DrawingEngine â†’ StrokeRecorder
              â†“
        Transformé©ç”¨
              â†“
        ThumbnailSystem â† EventBusçµŒç”±ã§æ›´æ–°é€šçŸ¥
```


================================================================================
## ğŸš€ æ”¹ä¿®é †åºã®é‡è¦æ€§

1. **Phase 1å„ªå…ˆ:** äºŒé‡å®Ÿè£…æ’²æ»…ã¯æœ€å„ªå…ˆï¼ˆå¾Œç¶šPhaseã®å‰ææ¡ä»¶ï¼‰
2. **Phase 2å„ªå…ˆ:** ç‹¬è‡ªå®Ÿè£…å‰Šé™¤ã§çµ±ä¸€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç¢ºç«‹
3. **Phase 3:** ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼çµ±åˆã§å…¨ä½“é€£æºå®Œæˆ
4. **Phase 4:** UIæ©Ÿèƒ½ä¿®å¾©ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Šï¼‰
5. **Phase 5:** æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯çµ±ä¸€ï¼ˆå“è³ªå‘ä¸Šï¼‰
6. **Phase 6:** æœ€çµ‚æ¤œè¨¼ï¼ˆå“è³ªä¿è¨¼ï¼‰

**Phase 1-3ã¯å¿…é ˆã€Phase 4-6ã¯å“è³ªå‘ä¸Š**


================================================================================
æ”¹ä¿®è¨ˆç”»æ›¸ v3.0 å®Œ
================================================================================