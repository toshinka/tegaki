# ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ–¹å¼ã®å®Œå…¨æ¯”è¼ƒè¡¨

## ğŸ” èª¿æŸ»çµæœã‚µãƒãƒªãƒ¼

### Canvas2Dä½¿ç”¨çŠ¶æ³

| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ¡ã‚½ãƒƒãƒ‰ | Canvas2Dä½¿ç”¨ | ç”¨é€” | è¡Œç•ªå· |
|---------|---------|------------|------|-------|
| **thumbnail-system.js** | `generateFrameThumbnail()` | âœ… **ä½¿ç”¨** | ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ã®ãƒªã‚µã‚¤ã‚º | L263-268 |
| **thumbnail-system.js** | `_renderLayerThumbnail()` | âŒ ä¸ä½¿ç”¨ | ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ | L200-220 |
| **animation-system.js** | `generateFrameThumbnail()` | âœ… **ä½¿ç”¨** | ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ« | L754-783 |
| **layer-panel-renderer.js** | `_generateAndDisplayThumbnail()` | âŒ ä¸ä½¿ç”¨ | ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«è¡¨ç¤º | L156-191 |

### å•é¡Œã®æ ¸å¿ƒ

**ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã¯ç”Ÿæˆã•ã‚Œã¦ã„ãªã„ï¼ˆlayerCacheSize: 0ï¼‰**
â†’ `layer-panel-renderer.js` ãŒ `ThumbnailSystem.generateLayerThumbnail()` ã‚’å‘¼ã‚“ã§ã„ã‚‹ãŒã€**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„**

---

## ğŸ“Š è©³ç´°æ¯”è¼ƒè¡¨

### 1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ç”¨ï¼‰

#### A. thumbnail-system.js: `generateLayerThumbnail()`

```javascript
// å‘¼ã³å‡ºã—å…ƒ: layer-panel-renderer.js
// Canvas2Dä½¿ç”¨: âŒ ãªã—ï¼ˆPixiJS extract.canvas()ã®ã¿ï¼‰
```

| é …ç›® | å®Ÿè£…å†…å®¹ | åº§æ¨™ç³» |
|------|---------|-------|
| **ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ–¹å¼** | `app.renderer.render({ container: layer, target: rt })` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ |
| **Canvasç”Ÿæˆ** | `app.renderer.extract.canvas(rt)` | PixiJSå†…éƒ¨å‡¦ç† |
| **Canvas2Dä½¿ç”¨** | âŒ ãªã— | - |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼** | `layer_${layerId}_${width}_${height}_${transform}` | transform = position/rotation/scale |
| **Transformåæ˜ ** | âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«å«ã‚€ | layer.position, layer.rotation, layer.scale |
| **Vãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ** | âœ… `vKeyModeActive` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ã‚­ãƒƒãƒ— | - |

**å•é¡Œç‚¹:**
```javascript
// L153-167: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”Ÿæˆã‚³ãƒ¼ãƒ‰
const canvas = await this._renderLayerThumbnail(layer, width, height);

if (canvas) {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
    this.layerThumbnailCache.set(cacheKey, canvas);
}
```

**ã—ã‹ã—ã€å®Ÿéš›ã«ã¯ `layerCacheSize: 0` = ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç©º**

**åŸå› å€™è£œ:**
1. `generateLayerThumbnail()` ãŒå‘¼ã°ã‚Œã¦ã„ãªã„
2. `_renderLayerThumbnail()` ãŒ `null` ã‚’è¿”ã—ã¦ã„ã‚‹
3. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã® `position/rotation/scale` ãŒå¤‰åŒ–ã—ã¦ã„ã‚‹ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆã—ãªã„

---

#### B. layer-panel-renderer.js: `_generateAndDisplayThumbnail()`

```javascript
// å‘¼ã³å‡ºã—: createThumbnail() â†’ _generateAndDisplayThumbnail()
// Canvas2Dä½¿ç”¨: âŒ ãªã—
```

| é …ç›® | å®Ÿè£…å†…å®¹ | å‚™è€ƒ |
|------|---------|------|
| **å‘¼ã³å‡ºã—** | `ThumbnailSystem.generateLayerThumbnail(layer, 64, 64)` | thumbnail-system.js ã«å§”è­² |
| **Canvas2D** | âŒ ãªã— | - |
| **DataURLå¤‰æ›** | `canvas.toDataURL('image/png')` | Canvas2D APIä½¿ç”¨ |
| **imgè¦ç´ è¡¨ç¤º** | `img.src = dataURL` | DOMæ›´æ–° |

**å•é¡Œç‚¹:**
```javascript
// L180-182: DataURLå¤‰æ›ã§Canvas2D APIä½¿ç”¨
const dataURL = canvas.toDataURL('image/png');
img.src = dataURL;
```

**Canvas2Dä½¿ç”¨ç®‡æ‰€:**
- `canvas.toDataURL()` - Canvas2D APIã ãŒPixiJSãŒç”Ÿæˆã—ãŸCanvasã«å¯¾ã—ã¦ä½¿ç”¨
- é‹ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³é•åã§ã¯ã‚ã‚‹ãŒã€**ã‚µãƒ ãƒã‚¤ãƒ«æœªç”Ÿæˆå•é¡Œã¨ã¯ç„¡é–¢ä¿‚**

---

### 2. ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”¨ï¼‰

#### A. thumbnail-system.js: `generateFrameThumbnail()`

```javascript
// å‘¼ã³å‡ºã—å…ƒ: animation-system.js
// Canvas2Dä½¿ç”¨: âœ… ã‚ã‚Šï¼ˆãƒªã‚µã‚¤ã‚ºå‡¦ç†ï¼‰
```

| é …ç›® | å®Ÿè£…å†…å®¹ | Canvas2Dä½¿ç”¨ |
|------|---------|-------------|
| **ãƒ•ãƒ«ã‚µã‚¤ã‚ºãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°** | `app.renderer.render({ container: frame, target: fullRT })` | âŒ |
| **Canvaså–å¾—** | `app.renderer.extract.canvas(fullRT)` | âŒ |
| **ãƒªã‚µã‚¤ã‚ºCanvasä½œæˆ** | `document.createElement('canvas')` | âœ… Canvas2D |
| **ãƒªã‚µã‚¤ã‚ºæç”»** | `ctx.drawImage(fullCanvas, 0, 0, thumbWidth, thumbHeight)` | âœ… Canvas2D |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜** | `frameThumbnailCache.set(cacheKey, thumbCanvas)` | - |

**Canvas2Dä½¿ç”¨ç®‡æ‰€ï¼ˆL263-268ï¼‰:**
```javascript
const thumbCanvas = document.createElement('canvas');
thumbCanvas.width = thumbWidth;
thumbCanvas.height = thumbHeight;
const ctx = thumbCanvas.getContext('2d');

ctx.imageSmoothingEnabled = true;
ctx.imageSmoothingQuality = 'high';
ctx.drawImage(fullCanvas, 0, 0, thumbWidth, thumbHeight);
```

**é‹ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³é•å:**
- âœ… ç¦æ­¢äº‹é …ã«è©²å½“ï¼ˆCanvas2Då®Œå…¨ç¦æ­¢ï¼‰
- ä»£æ›¿æ‰‹æ®µ: PixiJS RenderTexture ã§ãƒªã‚µã‚¤ã‚º

---

#### B. animation-system.js: `generateFrameThumbnail()`

```javascript
// å‘¼ã³å‡ºã—å…ƒ: timeline-ui.js
// Canvas2Dä½¿ç”¨: âœ… ã‚ã‚Šï¼ˆãƒªã‚µã‚¤ã‚ºå‡¦ç†ï¼‰
```

| é …ç›® | å®Ÿè£…å†…å®¹ | Canvas2Dä½¿ç”¨ |
|------|---------|-------------|
| **RenderTextureå–å¾—** | `layerSystem.getFrameRenderTexture(frame.id)` | âŒ |
| **Canvaså–å¾—** | `app.renderer.extract.canvas(renderTexture)` | âŒ |
| **ãƒªã‚µã‚¤ã‚ºCanvasä½œæˆ** | `document.createElement('canvas')` | âœ… Canvas2D |
| **ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”è¨ˆç®—** | æ‰‹å‹•è¨ˆç®—ï¼ˆoffsetX, offsetYï¼‰ | - |
| **ãƒªã‚µã‚¤ã‚ºæç”»** | `ctx.drawImage(sourceCanvas, ...)` | âœ… Canvas2D |
| **frameä¿å­˜** | `frame.thumbnailCanvas = thumbCanvas` | - |

**Canvas2Dä½¿ç”¨ç®‡æ‰€ï¼ˆL754-783ï¼‰:**
```javascript
const thumbCanvas = document.createElement('canvas');
thumbCanvas.width = thumbDisplayW;
thumbCanvas.height = thumbDisplayH;

const ctx = thumbCanvas.getContext('2d');
ctx.imageSmoothingEnabled = true;
ctx.imageSmoothingQuality = 'high';

// ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ã¦ãƒªã‚µã‚¤ã‚º
ctx.drawImage(
    sourceCanvas, 
    0, 0, sourceCanvas.width, sourceCanvas.height,
    offsetX, offsetY, drawW, drawH
);

frame.thumbnailCanvas = thumbCanvas;
```

**é‹ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³é•å:**
- âœ… ç¦æ­¢äº‹é …ã«è©²å½“ï¼ˆCanvas2Då®Œå…¨ç¦æ­¢ï¼‰

---

## ğŸ”¥ åº§æ¨™ç³»ã¨ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã®ç®¡ç†

### ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆå•é¡Œã‚ã‚Šï¼‰

| è¦ç´  | åº§æ¨™ç³» | Transformé©ç”¨ | å•é¡Œ |
|------|-------|--------------|------|
| **ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ** | Worldåº§æ¨™ç³»ï¼ˆè¦ª: worldContainerï¼‰ | âœ… position/rotation/scale | - |
| **PixiJS render()** | ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° | âœ… Transformè‡ªå‹•é©ç”¨ | - |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼** | `${pos.x}_${pos.y}_${rot}_${scale.x}_${scale.y}` | âœ… Transformå€¤ã‚’å«ã‚€ | **Vãƒ¢ãƒ¼ãƒ‰ã§æ¯å›å¤‰åŒ– â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹** |
| **åº§æ¨™å¤‰æ›** | coordinate-system.js æœªä½¿ç”¨ | - | **worldToLocal()ã‚’ä½¿ã£ã¦ã„ãªã„** |

**å•é¡Œ:**
```javascript
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆï¼ˆL143-146ï¼‰
const pos = layer.position;
const rot = layer.rotation;
const scale = layer.scale;
const transform = `${pos.x.toFixed(2)}_${pos.y.toFixed(2)}_${rot.toFixed(4)}_${scale.x.toFixed(3)}_${scale.y.toFixed(3)}`;
```

**Vãƒ¢ãƒ¼ãƒ‰ã§ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã¨:**
- `layer.position` ãŒæ¯ãƒ•ãƒ¬ãƒ¼ãƒ å¤‰åŒ–
- `transform` æ–‡å­—åˆ—ãŒæ¯å›å¤‰åŒ–
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ãŒä¸€è‡´ã—ãªã„ â†’ æ¯å› `_renderLayerThumbnail()` å®Ÿè¡Œ
- ã—ã‹ã— `vKeyModeActive = true` ãªã®ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã•ã‚Œãªã„ï¼ˆL132-135ï¼‰
- **çµæœ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ°¸é ã«ç©ºï¼ˆlayerCacheSize: 0ï¼‰**

---

### ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆCanvas2Då•é¡Œï¼‰

| è¦ç´  | åº§æ¨™ç³» | Transformé©ç”¨ | å•é¡Œ |
|------|-------|--------------|------|
| **ãƒ•ãƒ¬ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ** | Worldåº§æ¨™ç³» | âœ… å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å«ã‚€ | - |
| **RenderTexture** | ãƒ•ãƒ«ã‚µã‚¤ã‚ºï¼ˆcanvasWidth Ã— canvasHeightï¼‰ | âœ… å…¨Transformé©ç”¨ | - |
| **Canvas2Dãƒªã‚µã‚¤ã‚º** | ã‚µãƒ ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆ72Ã—54ç­‰ï¼‰ | âœ… ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ä¿æŒ | **Canvas2Dä½¿ç”¨** |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼** | `frame_${frameId}_${canvasWidth}_${canvasHeight}_${thumbWidth}_${thumbHeight}` | âœ… å›ºå®šå€¤ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡é«˜ã„ |

**å•é¡Œ:**
- Canvas2Dä½¿ç”¨ï¼ˆé‹ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³é•åï¼‰
- ã—ã‹ã— **ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«ã¯æ­£å¸¸å‹•ä½œã—ã¦ã„ã‚‹**
- **ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã¨ã®å·®ç•° = ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®é•ã„**

---

## ğŸ¯ æ ¹æœ¬åŸå› ã®ç‰¹å®š

### ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œãªã„ç†ç”±

#### åŸå› 1: Vãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–

```javascript
// thumbnail-system.js L132-135
if (this.disableCacheDuringVMode && this.vKeyModeActive) {
    return await this._renderLayerThumbnail(layer, width, height);
}
```

**å•é¡Œ:**
- Vãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ `_renderLayerThumbnail()` ã‚’ç›´æ¥å‘¼ã³å‡ºã—
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã•ã‚Œãªã„**
- Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†å¾Œã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ç©ºã®ã¾ã¾

#### åŸå› 2: Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†ç”Ÿæˆãªã—

```javascript
// thumbnail-system.js L50-57
this.eventBus.on('keyboard:vkey-released', () => {
    this.vKeyModeActive = false;
});
```

**å•é¡Œ:**
- Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å†ç”Ÿæˆã—ã¦ã„ãªã„
- **ã‚µãƒ ãƒã‚¤ãƒ«ãŒå¤ã„ã¾ã¾**

#### åŸå› 3: Transformå€¤ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼å•é¡Œ

```javascript
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼: layer_${layerId}_64_64_${transform}
// transform = position/rotation/scaleã®æ–‡å­—åˆ—åŒ–
```

**å•é¡Œ:**
- Vãƒ¢ãƒ¼ãƒ‰ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‹•ã‹ã™ã¨æ¯å›é•ã†ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
- å…ƒã®ä½ç½®ã«æˆ»ã—ã¦ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆã—ãªã„ï¼ˆå°æ•°ç‚¹èª¤å·®ï¼‰
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç„¡é™ã«å¢—ãˆã‚‹å¯èƒ½æ€§**

---

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«ãŒå‹•ä½œã™ã‚‹ç†ç”±

#### æˆåŠŸè¦å› 1: ãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```javascript
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼: frame_${frameId}_${canvasWidth}_${canvasHeight}_${thumbWidth}_${thumbHeight}
```

**åˆ©ç‚¹:**
- `frameId` ã¯å›ºå®šï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ å‰Šé™¤ã¾ã§ä¸å¤‰ï¼‰
- `canvasWidth/Height` ã‚‚ãƒªã‚µã‚¤ã‚ºã—ãªã„é™ã‚Šå›ºå®š
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ãŒé«˜ã„**

#### æˆåŠŸè¦å› 2: æ˜ç¤ºçš„ãªå†ç”Ÿæˆãƒˆãƒªã‚¬ãƒ¼

```javascript
// timeline-ui.js L184
this.eventBus.on('layer:transform-updated', ({ layerId }) => {
    this.requestThumbnailUpdate();
});

// L194-200: å³æ™‚æ›´æ–°ï¼ˆ0msé…å»¶ï¼‰
requestThumbnailUpdate() {
    this.thumbnailUpdateTimer = setTimeout(() => {
        this.updateCurrentFrameThumbnail();
    }, 0);
}
```

**åˆ©ç‚¹:**
- `layer:transform-updated` ã§å³åº§ã«æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- **throttleãŒã»ã¼ç„¡ã„ï¼ˆ0msï¼‰**
- `generateFrameThumbnail()` ãŒç¢ºå®Ÿã«å‘¼ã°ã‚Œã‚‹

---

## ğŸ› ï¸ ä¿®æ­£æ–¹é‡

### Phase 1: Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†ç”Ÿæˆ

**thumbnail-system.js ä¿®æ­£:**

```javascript
this.eventBus.on('keyboard:vkey-released', () => {
    this.vKeyModeActive = false;
    
    // Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã«å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã‚’å†ç”Ÿæˆ
    const layerMgr = window.CoreRuntime?.internal?.layerManager;
    if (layerMgr) {
        const layers = layerMgr.getLayers();
        layers.forEach((layer, index) => {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
            this._invalidateLayerCacheByLayerId(layer.layerData?.id);
            
            // å†ç”Ÿæˆãƒˆãƒªã‚¬ãƒ¼
            this.eventBus.emit('thumbnail:layer-updated', {
                component: 'thumbnail-system',
                action: 'vmode-exit-refresh',
                data: { layerIndex: index, layerId: layer.layerData?.id, immediate: true }
            });
        });
    }
});
```

---

### Phase 2: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼æˆ¦ç•¥ã®å¤‰æ›´

**thumbnail-system.js ä¿®æ­£:**

```javascript
// ç¾çŠ¶: transformå€¤ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«å«ã‚€
const transform = `${pos.x.toFixed(2)}_${pos.y.toFixed(2)}_${rot.toFixed(4)}_${scale.x.toFixed(3)}_${scale.y.toFixed(3)}`;
const cacheKey = `layer_${layerId}_${width}_${height}_${transform}`;

// â†“ ä¿®æ­£æ¡ˆ1: layerIdã®ã¿ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ–¹å¼ï¼‰
const cacheKey = `layer_${layerId}_${width}_${height}`;

// â†“ ä¿®æ­£æ¡ˆ2: pathsæ›´æ–°å›æ•°ã‚’ã‚­ãƒ¼ã«å«ã‚€
const pathsVersion = layer.layerData?.paths?.length || 0;
const cacheKey = `layer_${layerId}_${width}_${height}_${pathsVersion}`;
```

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:**
- ä¿®æ­£æ¡ˆ1: Transformå¤‰æ›´ãŒåæ˜ ã•ã‚Œãªã„ï¼ˆVãƒ¢ãƒ¼ãƒ‰æ“ä½œãŒè¦‹ãˆãªã„ï¼‰
- ä¿®æ­£æ¡ˆ2: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¿½åŠ ã®ã¿æ¤œçŸ¥ã€Transformå¤‰æ›´ã¯æ¤œçŸ¥ã§ããªã„

**æ¨å¥¨: ä¿®æ­£æ¡ˆ1 + æ˜ç¤ºçš„ãªç„¡åŠ¹åŒ–**
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã¯ `layerId` ã®ã¿
- `layer:transform-updated` ã§æ˜ç¤ºçš„ã«ç„¡åŠ¹åŒ–
- Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã«å†ç”Ÿæˆ

---

### Phase 3: Canvas2Dæ’²æ»…ï¼ˆé‹ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³æº–æ‹ ï¼‰

#### æ–¹æ³•A: PixiJS RenderTextureã§ãƒªã‚µã‚¤ã‚º

**thumbnail-system.js ã¨ animation-system.js ä¸¡æ–¹ã‚’ä¿®æ­£:**

```javascript
// Canvas2Dä½¿ç”¨ã‚³ãƒ¼ãƒ‰ï¼ˆå‰Šé™¤ï¼‰
const thumbCanvas = document.createElement('canvas');
const ctx = thumbCanvas.getContext('2d');
ctx.drawImage(fullCanvas, 0, 0, thumbWidth, thumbHeight);

// â†“ PixiJS RenderTextureä½¿ç”¨ï¼ˆè¿½åŠ ï¼‰
const thumbRT = PIXI.RenderTexture.create({
    width: thumbWidth,
    height: thumbHeight,
    resolution: 1
});

// ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨ˆç®—
const scaleX = thumbWidth / fullCanvas.width;
const scaleY = thumbHeight / fullCanvas.height;

// ä¸€æ™‚ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆä½œæˆ
const tempSprite = PIXI.Sprite.from(fullRT);
tempSprite.scale.set(scaleX, scaleY);

// ãƒªã‚µã‚¤ã‚ºãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
this.app.renderer.render({
    container: tempSprite,
    target: thumbRT
});

// Canvaså–å¾—
const thumbCanvas = this.app.renderer.extract.canvas(thumbRT);

// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
tempSprite.destroy();
thumbRT.destroy();
```

**åˆ©ç‚¹:**
- Canvas2Då®Œå…¨æ’²æ»…
- PixiJSå†…ã§å®Œçµ
- GPUåŠ é€Ÿã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š

---

#### æ–¹æ³•B: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨ï¼ˆPica.jsç­‰ï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¾å­˜
- ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœ‰åŠ¹æ´»ç”¨ã€ã«ã¯åˆè‡´
- ã—ã‹ã—Canvas2D APIã‚’å†…éƒ¨ã§ä½¿ç”¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§

**éæ¨å¥¨**

---

## ğŸ“‹ å®Œå…¨ä¿®æ­£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã®å†ç”Ÿæˆï¼ˆå„ªå…ˆåº¦: æœ€é«˜ï¼‰

- [ ] `thumbnail-system.js`: `keyboard:vkey-released` è³¼èª­ã«å†ç”Ÿæˆå‡¦ç†è¿½åŠ 
- [ ] Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†å¾Œã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] `layerCacheSize > 0` ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª

### Phase 2: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼æˆ¦ç•¥å¤‰æ›´ï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

- [ ] `thumbnail-system.js`: `generateLayerThumbnail()` ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆã‚’ä¿®æ­£
- [ ] `layerId` ã®ã¿ã‚’ã‚­ãƒ¼ã«ã™ã‚‹æ–¹å¼ã«å¤‰æ›´
- [ ] `layer:transform-updated` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã‚’ç¢ºèª

### Phase 3: Canvas2Dæ’²æ»…ï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

- [ ] `thumbnail-system.js`: `generateFrameThumbnail()` ã‚’ PixiJS RenderTexture æ–¹å¼ã«å¤‰æ›´
- [ ] `animation-system.js`: `generateFrameThumbnail()` ã‚’ PixiJS RenderTexture æ–¹å¼ã«å¤‰æ›´
- [ ] Canvas2D APIï¼ˆ`getContext('2d')`ï¼‰ã®ä½¿ç”¨ãŒ0ä»¶ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª

### Phase 4: çµ±ä¸€æ€§ç¢ºä¿ï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

- [ ] ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ã®ç”Ÿæˆæ–¹å¼ã‚’çµ±ä¸€
- [ ] ä¸¡æ–¹ã¨ã‚‚ PixiJS RenderTexture ã®ã¿ä½¿ç”¨
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’çµ±ä¸€ï¼ˆlayerId/frameIdã®ã¿ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ï¼‰

---

## ğŸ¯ æ¨å¥¨ä¿®æ­£é †åº

1. **Phase 1å®Ÿæ–½** â†’ ã‚µãƒ ãƒã‚¤ãƒ«æœªç”Ÿæˆå•é¡Œã®å³æ™‚è§£æ±ºï¼ˆ30åˆ†ï¼‰
2. **Phase 2å®Ÿæ–½** â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡åŒ–ï¼ˆ1æ™‚é–“ï¼‰
3. **å‹•ä½œç¢ºèª** â†’ Vãƒ¢ãƒ¼ãƒ‰ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ä¸¡æ–¹ã§ã‚µãƒ ãƒã‚¤ãƒ«ç¢ºèª
4. **Phase 3å®Ÿæ–½** â†’ Canvas2Dæ’²æ»…ï¼ˆ2æ™‚é–“ï¼‰
5. **Phase 4å®Ÿæ–½** â†’ æœ€çµ‚çµ±ä¸€ï¼ˆ1æ™‚é–“ï¼‰

**åˆè¨ˆæ‰€è¦æ™‚é–“: 4.5æ™‚é–“**

---

## ğŸ“š å‚è€ƒæƒ…å ±

### PixiJS RenderTexture ãƒªã‚µã‚¤ã‚ºã®å®Ÿè£…ä¾‹

```javascript
function resizeRenderTexture(sourceRT, targetWidth, targetHeight, renderer) {
    // å‡ºåŠ›ç”¨RenderTextureä½œæˆ
    const outputRT = PIXI.RenderTexture.create({
        width: targetWidth,
        height: targetHeight,
        resolution: 1
    });
    
    // ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆä½œæˆ
    const sprite = PIXI.Sprite.from(sourceRT);
    
    // ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ä¿æŒï¼‰
    const scaleX = targetWidth / sourceRT.width;
    const scaleY = targetHeight / sourceRT.height;
    const scale = Math.min(scaleX, scaleY);
    
    sprite.scale.set(scale, scale);
    
    // ä¸­å¤®é…ç½®
    sprite.x = (targetWidth - sourceRT.width * scale) / 2;
    sprite.y = (targetHeight - sourceRT.height * scale) / 2;
    
    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    renderer.render({
        container: sprite,
        target: outputRT,
        clear: true
    });
    
    // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    sprite.destroy();
    
    return outputRT;
}
```

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `thumbnail-system.js` - ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã®ä¸­æ ¸
- `animation-system.js` - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
- `layer-panel-renderer.js` - ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«UIãƒ»ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
- `timeline-ui.js` - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³UIãƒ»ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
- `coordinate-system.js` - åº§æ¨™å¤‰æ›ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã§æœªä½¿ç”¨ï¼‰

---

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: Phase 1ã®ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ**