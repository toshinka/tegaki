================================================================================
åº§æ¨™ç³»ãƒ•ãƒ­ãƒ¼ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ã‚·ãƒ³ãƒœãƒ«è¾å…¸ã¨æ”¹ä¿®æ›¸
v8.13_Drawing_78 - ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³å•é¡Œå¾¹åº•è§£æç‰ˆ
================================================================================

ç›®æ¬¡
--------------------------------------------------------------------------------
1. å•é¡Œã®ç—‡çŠ¶ã¨æ ¹æœ¬åŸå› ã®ç‰¹å®š
2. åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¨ä½“ãƒ•ãƒ­ãƒ¼ï¼ˆæœ€æ–°ç‰ˆï¼‰
3. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®è²¬å‹™ã¨ã‚·ãƒ³ãƒœãƒ«è¾å…¸
4. åˆæœŸåŒ–é †åºã®ä¾å­˜é–¢ä¿‚å›³
5. ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³å•é¡Œã®æ ¹æœ¬åŸå› ï¼ˆç¢ºå®šç‰ˆï¼‰
6. æ”¹ä¿®å®Ÿæ–½æ›¸ï¼ˆå„ªå…ˆé †ä½ä»˜ããƒ»æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ä»˜ï¼‰
7. äºŒé‡å®Ÿè£…ãƒ»SOLIDé•åã®ç¢ºèªã¨æ’²æ»…
8. æ”¹ä¿®å¾Œã®å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ


================================================================================
1. å•é¡Œã®ç—‡çŠ¶ã¨æ ¹æœ¬åŸå› ã®ç‰¹å®š
================================================================================

ã€ç—‡çŠ¶ã€‘
- ãƒã‚¦ã‚¹ã§ã¯æç”»å¯èƒ½ã€ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§ã¯æç”»ä¸å¯
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ã‚‚ãƒã‚¦ã‚¹å¯ãƒ»ãƒšãƒ³ä¸å¯
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ›´ãƒœã‚¿ãƒ³ã¯æŠ¼ã›ã‚‹ï¼ˆãƒšãƒ³å…¥åŠ›è‡ªä½“ã¯å—ä»˜ï¼‰

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®ãƒ­ã‚°ã€‘
```
drawing-engine.js:58 ğŸ–±ï¸ [DrawingEngine] PointerDown: {type: 'pen', id: 1, pressure: 0.5}
VM1013:6 ğŸ” RAW PointerDown: {type: 'mouse', id: 1, pressure: 0.5, clientX: 349.5, clientY: 278}
drawing-engine.js:122 ğŸ–±ï¸ [DrawingEngine] PointerUp: {type: 'mouse', id: 1}
```

ã€é‡è¦ãªç™ºè¦‹ã€‘
1. Canvasè¦ç´ ã«ç›´æ¥ç™»éŒ²ã—ãŸãƒªã‚¹ãƒŠãƒ¼ã§ã¯ `type: 'mouse'` ã¨èªè­˜
2. DrawingEngine ã§ã¯ `type: 'pen'` ã¨èªè­˜ï¼ˆpointer-handler.jsã§è£œæ­£ï¼‰
3. **ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§ã¯ã€Canvasè¦ç´ ã®ãƒªã‚¹ãƒŠãƒ¼è‡ªä½“ãŒç™ºç«ã—ãªã„**

ã€æ ¹æœ¬åŸå› ã®ç‰¹å®šã€‘
â˜…â˜…â˜… Canvasè¦ç´ ãŒã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚Œã¦ã„ãªã„ â˜…â˜…â˜…

å¯èƒ½æ€§ã®ã‚ã‚‹åŸå› ï¼š
A. **Canvasè¦ç´ ã®ä¸Šã«é€æ˜ãªè¦ç´ ãŒé‡ãªã£ã¦ã„ã‚‹**ï¼ˆæœ€ã‚‚å¯èƒ½æ€§ãŒé«˜ã„ï¼‰
B. **passive: false ãƒ•ãƒ©ã‚°ã¨setPointerCapture()ã®ç«¶åˆ**
C. **ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šãƒ»ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç„¡åŠ¹åŒ–**
D. **Canvasè¦ç´ ã®pointer-eventsã‚¹ã‚¿ã‚¤ãƒ«å•é¡Œ**


================================================================================
2. åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¨ä½“ãƒ•ãƒ­ãƒ¼ï¼ˆæœ€æ–°ç‰ˆï¼‰
================================================================================

ã€æ­£å¸¸ãªãƒ•ãƒ­ãƒ¼ã€‘
PointerEvent (clientX, clientY, pressure, pointerType)
  â†“
pointer-handler.js: normalizeEvent()
  â”œâ”€ pointerTypeè£œæ­£ï¼ˆmouse + pressure > 0.01 â†’ penï¼‰
  â””â”€ return { pointerId, pointerType, clientX, clientY, pressure, ... }
  â†“
drawing-engine.js: _handlePointerDown(info, e)
  â”œâ”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆvKeyPressedï¼‰
  â”œâ”€ å³ã‚¯ãƒªãƒƒã‚¯ç„¡è¦–ï¼ˆbutton === 2ï¼‰
  â””â”€ BrushCore.startStroke(clientX, clientY, pressure) å‘¼ã³å‡ºã—
  â†“
brush-core.js: startStroke(clientX, clientY, pressure)
  â”œâ”€ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—
  â”œâ”€ åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
  â”‚   â”œâ”€ CoordinateSystem.screenClientToCanvas(clientX, clientY)
  â”‚   â”‚   â†’ { canvasX, canvasY }  [DPI/DPRè£œæ­£]
  â”‚   â”œâ”€ CoordinateSystem.canvasToWorld(canvasX, canvasY)
  â”‚   â”‚   â†’ { worldX, worldY }  [worldContaineré€†è¡Œåˆ—é©ç”¨]
  â”‚   â””â”€ CoordinateSystem.worldToLocal(worldX, worldY, activeLayer)
  â”‚       â†’ { localX, localY }  [è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»]
  â”œâ”€ StrokeRecorder.startStroke(localX, localY, pressure)
  â”œâ”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼Graphicsç”Ÿæˆ
  â””â”€ ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ï¼ˆdrawing:stroke-startedï¼‰
  â†“
stroke-recorder.js: startStroke(localX, localY, pressure)
  â”œâ”€ ãƒã‚¤ãƒ³ãƒˆé…åˆ—åˆæœŸåŒ–
  â”œâ”€ åˆå›ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
  â””â”€ isRecording = true
  â†“
stroke-renderer.js: renderPreview(points, settings, graphics)
  â”œâ”€ SDF/MSDFãƒ¡ãƒƒã‚·ãƒ¥ç”Ÿæˆ
  â””â”€ Graphicsæç”»

ã€ç¾åœ¨ã®ãƒ•ãƒ­ãƒ¼ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ï¼‰ã€‘
PointerEvent (pen)
  â†“
âŒ Canvasè¦ç´ ã®ãƒªã‚¹ãƒŠãƒ¼ãŒç™ºç«ã—ãªã„
  â†’ pointer-handler.js ã«åˆ°é”ã—ãªã„
  â†’ drawing-engine.js ã«åˆ°é”ã—ãªã„
  â†’ ä½•ã‚‚èµ·ã“ã‚‰ãªã„


================================================================================
3. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®è²¬å‹™ã¨ã‚·ãƒ³ãƒœãƒ«è¾å…¸
================================================================================

--------------------------------------------------------------------------------
3-1. coordinate-system.js
--------------------------------------------------------------------------------

ã€è²¬å‹™ã€‘
- Screen/Canvas/World/Local åº§æ¨™å¤‰æ›ã®ä¸€å…ƒç®¡ç†
- DPI/DPRè£œæ­£
- worldContainer/è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»ã«ã‚ˆã‚‹æ­£ç¢ºãªåº§æ¨™è¨ˆç®—

ã€ã‚¯ãƒ©ã‚¹ã€‘
CoordinateSystem

ã€ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
init(app, config, eventBus)
  - åˆæœŸåŒ–

setContainers(containers)
  - worldContainer/canvasContainer è¨­å®š

setCameraSystem(cameraSystem)
  - CameraSystem å‚ç…§è¨­å®š

screenClientToCanvas(clientX, clientY)
  - Screen â†’ Canvas å¤‰æ›ï¼ˆDPIè£œæ­£ï¼‰
  - return: { canvasX, canvasY }

canvasToWorld(canvasX, canvasY)
  - Canvas â†’ World å¤‰æ›ï¼ˆworldContaineré€†è¡Œåˆ—é©ç”¨ï¼‰
  - return: { worldX, worldY }

worldToLocal(worldX, worldY, container)
  - World â†’ Local å¤‰æ›ï¼ˆè¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»ï¼‰
  - return: { localX, localY }
  - âš ï¸ PIXI v8 toLocal() ä½¿ç”¨å³ç¦

ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ³ãƒœãƒ«ã€‘
window.CoordinateSystem
  - å‹: CoordinateSystem ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
  - åˆæœŸåŒ–: coordinate-system.js ãƒ­ãƒ¼ãƒ‰æ™‚ï¼ˆå³æ™‚å®Ÿè¡Œé–¢æ•°ï¼‰

ã€ä¾å­˜ã€‘
- window.TEGAKI_CONFIG
- window.TegakiEventBus
- this.cameraSystemï¼ˆsetCameraSystemçµŒç”±ï¼‰
- this.worldContainerï¼ˆsetContainersçµŒç”±ï¼‰


--------------------------------------------------------------------------------
3-2. pointer-handler.js
--------------------------------------------------------------------------------

ã€è²¬å‹™ã€‘
- PointerEventçµ±ä¸€å‡¦ç†ï¼ˆmouse/touch/penå¯¾å¿œï¼‰
- pointerTypeèª¤èªè£œæ­£ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯
- setPointerCapture/releasePointerCaptureç®¡ç†

ã€ã‚¯ãƒ©ã‚¹ã€‘
PointerHandlerï¼ˆé™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿ï¼‰

ã€ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
static attach(element, handlers, options)
  - è¦ç´ ã«PointerEventãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ
  - handlers: { down, move, up, cancel }
  - options: { preventDefault, capture }
  - return: detaché–¢æ•°

normalizeEvent(e)ï¼ˆå†…éƒ¨é–¢æ•°ï¼‰
  - PointerEvent â†’ æ­£è¦åŒ–æƒ…å ±
  - pointerTypeè£œæ­£ï¼ˆmouse + pressure â†’ penï¼‰
  - return: { pointerId, pointerType, clientX, clientY, pressure, tiltX, tiltY, twist, button, buttons, originalEvent }

ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ³ãƒœãƒ«ã€‘
window.PointerHandler
  - å‹: PointerHandler ã‚¯ãƒ©ã‚¹
  - åˆæœŸåŒ–: pointer-handler.js ãƒ­ãƒ¼ãƒ‰æ™‚ï¼ˆå³æ™‚å®Ÿè¡Œé–¢æ•°ï¼‰

ã€ä¾å­˜ã€‘
- ãªã—ï¼ˆæ¨™æº–PointerEventã®ã¿ï¼‰

ã€ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²è¨­å®šã€‘
```javascript
element.addEventListener('pointerdown', onPointerDown, { 
    capture: false,  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    passive: false   // preventDefaultå¯èƒ½
});
```


--------------------------------------------------------------------------------
3-3. drawing-engine.js
--------------------------------------------------------------------------------

ã€è²¬å‹™ã€‘
- PointerEventå—ä¿¡ã¨Localåº§æ¨™å¤‰æ›çµ±æ‹¬
- BrushCoreã¸ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–‹å§‹/æ›´æ–°/çµ‚äº†é€šçŸ¥
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ³ã‚¿ãƒ¼ç®¡ç†

ã€ã‚¯ãƒ©ã‚¹ã€‘
DrawingEngine

ã€ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
constructor(app, layerSystem, cameraSystem, history)
  - åˆæœŸåŒ–
  - this.brushCore = window.BrushCoreï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ï¼‰âœ… ä¿®æ­£æ¸ˆã¿

_initializeCanvas()
  - canvas å–å¾—
  - canvas.style.touchAction = 'none' è¨­å®š
  - PointerHandler.attach() ã§ã‚¤ãƒ™ãƒ³ãƒˆæ¥ç¶š

_handlePointerDown(info, e)
  - PointerDownå—ä¿¡
  - vKeyPressed ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ï¼‰
  - å³ã‚¯ãƒªãƒƒã‚¯ç„¡è¦–
  - _screenToLocal() ã§åº§æ¨™å¤‰æ›ï¼ˆå†…éƒ¨æ¤œè¨¼ç”¨ï¼‰
  - BrushCore.startStroke(clientX, clientY, pressure) å‘¼ã³å‡ºã—

_screenToLocal(clientX, clientY)
  - åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±æ‹¬ï¼ˆæ¤œè¨¼ç”¨ï¼‰
  - return: { localX, localY }

ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ³ãƒœãƒ«ã€‘
window.DrawingEngine
  - å‹: DrawingEngine ã‚¯ãƒ©ã‚¹
  - åˆæœŸåŒ–: drawing-engine.js ãƒ­ãƒ¼ãƒ‰æ™‚

ã€ä¾å­˜ã€‘
- window.BrushCoreï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
- window.CoordinateSystem
- window.PointerHandler
- this.layerSystem
- this.cameraSystem

ã€Canvasè¦ç´ ã®å–å¾—æ–¹æ³•ã€‘
```javascript
const canvas = this.app.canvas || this.app.view;
```

ã€Canvasè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šã€‘
```javascript
canvas.style.touchAction = 'none';
```


--------------------------------------------------------------------------------
3-4. brush-core.js
--------------------------------------------------------------------------------

ã€è²¬å‹™ã€‘
- ãƒšãƒ³/æ¶ˆã—ã‚´ãƒ å…±é€šã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
- ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ²åˆ¶å¾¡ï¼ˆStrokeRecorderå‘¼ã³å‡ºã—ï¼‰
- åº§æ¨™å¤‰æ›çµ±æ‹¬ï¼ˆCoordinateSystemå‘¼ã³å‡ºã—ï¼‰
- ãƒ¢ãƒ¼ãƒ‰ç®¡ç†ï¼ˆpen/eraserï¼‰

ã€ã‚¯ãƒ©ã‚¹ã€‘
BrushCore

ã€ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
constructor()
  - ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åˆæœŸåŒ–
  - âš ï¸ ä¾å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ null ã®ã¾ã¾

init()
  - ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¾å­˜å–å¾—
  - this.coordinateSystem = window.CoordinateSystem
  - this.strokeRecorder = window.strokeRecorder
  - this.layerManager = window.layerManager
  - this.strokeRenderer = window.strokeRenderer
  - å¿…é ˆä¾å­˜ãƒã‚§ãƒƒã‚¯

startStroke(clientX, clientY, pressure)
  - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—
  - åº§æ¨™å¤‰æ›ï¼ˆScreen â†’ Canvas â†’ World â†’ Localï¼‰
  - StrokeRecorder.startStroke(localX, localY, pressure)
  - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼Graphicsç”Ÿæˆ
  - ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«

updateStroke(clientX, clientY, pressure)
  - åº§æ¨™å¤‰æ›
  - ç·šå½¢è£œé–“
  - StrokeRecorder.addPoint()
  - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°

finalizeStroke()
  - StrokeRecorder.endStroke()
  - StrokeRenderer.renderStroke()
  - ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ï¼ˆlayer:path-added, thumbnail:layer-updatedï¼‰

ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ³ãƒœãƒ«ã€‘
window.BrushCore
  - å‹: BrushCore ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
  - åˆæœŸåŒ–: brush-core.js ãƒ­ãƒ¼ãƒ‰æ™‚ï¼ˆnew BrushCore()ï¼‰
  - âš ï¸ init() ã¯ core-engine.js ã§å‘¼ã³å‡ºã—

ã€ä¾å­˜ã€‘
- window.CoordinateSystemï¼ˆinit()å†…ã§å–å¾—ï¼‰
- window.strokeRecorderï¼ˆinit()å†…ã§å–å¾—ï¼‰
- window.layerManagerï¼ˆinit()å†…ã§å–å¾—ï¼‰
- window.strokeRendererï¼ˆinit()å†…ã§å–å¾—ï¼‰
- window.pressureHandlerï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- window.eventBus


--------------------------------------------------------------------------------
3-5. stroke-recorder.js
--------------------------------------------------------------------------------

ã€è²¬å‹™ã€‘
- ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã®ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²å°‚ç”¨
- åº§æ¨™å¤‰æ›ã¯è¡Œã‚ãªã„ï¼ˆäºŒé‡å¤‰æ›é˜²æ­¢ï¼‰

ã€ã‚¯ãƒ©ã‚¹ã€‘
StrokeRecorder

ã€ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ã€‘
constructor(pressureHandler, cameraSystem)
  - åˆæœŸåŒ–

startStroke(localX, localY, rawPressure)
  - ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ²é–‹å§‹
  - åˆå›ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 

addPoint(localX, localY, rawPressure)
  - ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
  - ç­†åœ§è£œæ­£é©ç”¨ï¼ˆpressureHandlerçµŒç”±ï¼‰

endStroke()
  - ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ²çµ‚äº†
  - return: { points, isSingleDot }

ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ³ãƒœãƒ«ã€‘
window.StrokeRecorder
  - å‹: StrokeRecorder ã‚¯ãƒ©ã‚¹ï¼ˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼‰
  - åˆæœŸåŒ–: stroke-recorder.js ãƒ­ãƒ¼ãƒ‰æ™‚ï¼ˆã‚¯ãƒ©ã‚¹å®šç¾©ï¼‰
  - âš ï¸ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã¯ core-engine.js ã§å®Ÿè¡Œ


--------------------------------------------------------------------------------
3-6. core-engine.js
--------------------------------------------------------------------------------

ã€è²¬å‹™ã€‘
- ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®åˆæœŸåŒ–ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- ä¾å­˜æ³¨å…¥ï¼ˆDIï¼‰ã®ä¸­æ ¸
- ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã®è¨­å®š

ã€ã‚¯ãƒ©ã‚¹ã€‘
CoreEngine

ã€initialize()ã®é‡è¦ãªå‡¦ç†é †åºã€‘
1. CameraSystem.init()
2. LayerSystem.init()
3. ClipboardSystem.init()
4. ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§è¨­å®š
   window.layerManager = this.layerSystem
   window.cameraSystem = this.cameraSystem
5. StrokeRecorder ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
   window.strokeRecorder = new window.StrokeRecorder(...)
6. StrokeRenderer ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
   window.strokeRenderer = new window.StrokeRenderer(...)
7. BrushCore.init() å‘¼ã³å‡ºã— â˜…â˜…â˜…
   this.brushCore.init()
8. DrawingEngine ç”Ÿæˆ â˜…â˜…â˜…
   this.drawingEngine = new DrawingEngine(...)


--------------------------------------------------------------------------------
3-7. core-initializer.js
--------------------------------------------------------------------------------

ã€è²¬å‹™ã€‘
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
- DOMæ§‹ç¯‰
- PixiJS Application åˆæœŸåŒ–
- CoreEngine.initialize() å‘¼ã³å‡ºã—

ã€DrawingApp.initialize()ã®ãƒ•ãƒ­ãƒ¼ã€‘
1. PIXI.Application åˆæœŸåŒ–
   ```javascript
   await this.pixiApp.init({
       width: screenWidth,
       height: screenHeight,
       backgroundAlpha: 0,
       resolution: 1,
       antialias: true,
       eventMode: 'static'
   });
   ```

2. Canvasè¦ç´ ã‚’DOMè¿½åŠ 
   ```javascript
   containerEl.appendChild(this.pixiApp.canvas);
   this.pixiApp.canvas.style.width = `${screenWidth}px`;
   this.pixiApp.canvas.style.height = `${screenHeight}px`;
   ```

3. CoreEngine åˆæœŸåŒ–
   ```javascript
   this.coreEngine = new CoreEngine(this.pixiApp);
   this.coreEngine.initialize();
   ```

4. WebGPU åˆæœŸåŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰


--------------------------------------------------------------------------------
3-8. dom-builder.js
--------------------------------------------------------------------------------

ã€è²¬å‹™ã€‘
- DOMæ§‹é€ ã®æ§‹ç¯‰
- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã€Canvasé ˜åŸŸã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®ç”Ÿæˆ

ã€Canvasé ˜åŸŸã®æ§‹é€ ã€‘
```html
<div class="canvas-area">  <!-- position: relative -->
    <div id="drawing-canvas">  <!-- PixiJSã®Canvasè¦ç´ ãŒè¿½åŠ ã•ã‚Œã‚‹ -->
        <canvas></canvas>  <!-- PixiJS Application.canvas -->
    </div>
    <!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ‘ãƒãƒ«ï¼ˆposition: fixedï¼‰ -->
</div>
```


================================================================================
4. åˆæœŸåŒ–é †åºã®ä¾å­˜é–¢ä¿‚å›³
================================================================================

ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ãƒ‰é †åºã€‘
1. config.js
2. coordinate-system.js â†’ window.CoordinateSystem ç”Ÿæˆ
3. pointer-handler.js â†’ window.PointerHandler ç”Ÿæˆ
4. stroke-recorder.js â†’ window.StrokeRecorder ã‚¯ãƒ©ã‚¹å®šç¾©
5. brush-core.js â†’ window.BrushCore ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆï¼ˆæœªåˆæœŸåŒ–ï¼‰
6. drawing-engine.js â†’ window.DrawingEngine ã‚¯ãƒ©ã‚¹å®šç¾©
7. core-engine.js â†’ TegakiCore.CoreEngine ã‚¯ãƒ©ã‚¹å®šç¾©
8. core-initializer.js â†’ window.CoreInitializer ç”Ÿæˆ

ã€å®Ÿè¡Œæ™‚åˆæœŸåŒ–é †åºï¼ˆCoreEngine.initialize()å†…ï¼‰ã€‘
Step 1: CameraSystem.init()
Step 2: LayerSystem.init()
Step 3: ClipboardSystem.init()
Step 4: ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§è¨­å®š
  - window.layerManager = this.layerSystem
  - window.cameraSystem = this.cameraSystem
Step 5: StrokeRecorder ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
  - window.strokeRecorder = new window.StrokeRecorder(...)
Step 6: StrokeRenderer ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
  - window.strokeRenderer = new window.StrokeRenderer(...)
Step 7: BrushCore.init() å‘¼ã³å‡ºã—
  - this.brushCore.init()
Step 8: DrawingEngine ç”Ÿæˆ
  - this.drawingEngine = new DrawingEngine(...)
  - Canvasè¦ç´ ã«PointerHandlerã‚’ã‚¢ã‚¿ãƒƒãƒ
Step 9: ThumbnailSystem.init()
Step 10: AnimationSystem.init()


================================================================================
5. ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³å•é¡Œã®æ ¹æœ¬åŸå› ï¼ˆç¢ºå®šç‰ˆï¼‰
================================================================================

ã€å•é¡Œã®å±¤åˆ¥ã€‘

ã€Layer 1: Canvasè¦ç´ ãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‰ãªã„ã€‘
è¨¼æ‹ ï¼š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®ãƒ­ã‚°ã§ã€ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§ã¯Canvasè¦ç´ ã®ãƒªã‚¹ãƒŠãƒ¼ãŒç™ºç«ã—ãªã„
- ãƒã‚¦ã‚¹ã§ã¯æ­£å¸¸ã«ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹

åŸå› å€™è£œï¼š
A. â˜…â˜…â˜… Canvasè¦ç´ ã®ä¸Šã«é€æ˜ãªè¦ç´ ãŒé‡ãªã£ã¦ã„ã‚‹ï¼ˆæœ€ã‚‚å¯èƒ½æ€§ãŒé«˜ã„ï¼‰â˜…â˜…â˜…
B. Canvasè¦ç´ ã®pointer-eventsã‚¹ã‚¿ã‚¤ãƒ«å•é¡Œ
C. passive: false + setPointerCapture()ã®ç«¶åˆ
D. ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šãƒ»ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç„¡åŠ¹åŒ–

ã€åŸå› A: é€æ˜ãªè¦ç´ ãŒé‡ãªã£ã¦ã„ã‚‹ã€‘
ç–‘ã‚ã—ã„è¦ç´ ï¼š
1. **ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ« (.layer-panel-container)**
   - position: fixed
   - z-index: 1000
   - pointer-events: noneï¼ˆè¦ªè¦ç´ ã®ã¿ï¼‰
   - ã—ã‹ã—å­è¦ç´ ã¯ pointer-events: all
   
   CSSã‚³ãƒ¼ãƒ‰ï¼š
   ```css
   .layer-panel-container { 
       pointer-events: none;  /* è¦ªã¯ç„¡è¦– */
   }
   .layer-controls-row { 
       pointer-events: all;  /* å­ã¯æœ‰åŠ¹ */
   }
   .layer-panel-items { 
       pointer-events: all;  /* å­ã¯æœ‰åŠ¹ */
   }
   ```

2. **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ« (.status-panel)**
   - position: fixed
   - z-index: 1000
   - pointer-eventsã®è¨­å®šãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ï¼‰

3. **ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ‘ãƒãƒ«ç¾¤**
   - position: fixed
   - z-index: 2000
   - display: noneï¼ˆé€šå¸¸ã¯éè¡¨ç¤ºï¼‰

ã€é‡è¦ãªç™ºè¦‹ã€‘
ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®è¦ªè¦ç´ ã¯ `pointer-events: none` ã ãŒã€
**å­è¦ç´ ï¼ˆ.layer-controls-row, .layer-panel-itemsï¼‰ã¯ pointer-events: all**

ã“ã‚Œã«ã‚ˆã‚Šã€å­è¦ç´ ã®é ˜åŸŸã§ã¯ï¼š
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«è¦ç´ ãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹
- Canvasè¦ç´ ã¾ã§åˆ°é”ã—ãªã„

**ã—ã‹ã—ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã¯ç”»é¢å³å´ã«ã‚ã‚‹ãŸã‚ã€Canvasä¸­å¤®éƒ¨åˆ†ã¯å½±éŸ¿ã‚’å—ã‘ãªã„ã¯ãš**

ã€åŸå› B: Canvasè¦ç´ ã®pointer-eventsã‚¹ã‚¿ã‚¤ãƒ«å•é¡Œã€‘
ç¢ºèªãƒã‚¤ãƒ³ãƒˆï¼š
1. main.cssã®è¨­å®š
   ```css
   #drawing-canvas,
   canvas { 
       cursor: crosshair; 
       touch-action: none;
       -ms-touch-action: none;
   }
   ```
   
   â†’ pointer-eventsã®è¨­å®šãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ autoï¼‰

2. drawing-engine.jsã®è¨­å®š
   ```javascript
   canvas.style.touchAction = 'none';
   ```
   
   â†’ touch-actionã®ã¿è¨­å®šï¼ˆpointer-eventsã¯è¨­å®šãªã—ï¼‰

ã€åŸå› C: passive: false + setPointerCapture()ã®ç«¶åˆã€‘
pointer-handler.jsã®ã‚³ãƒ¼ãƒ‰ï¼š
```javascript
element.addEventListener('pointerdown', onPointerDown, { 
    capture: false, 
    passive: false 
});

function onPointerDown(e) {
    try {
        e.target.setPointerCapture(e.pointerId);
    } catch (err) {
        console.warn('[PointerHandler] setPointerCapture failed:', err);
    }
}
```

å¯èƒ½æ€§ï¼š
- ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§setPointerCapture()ãŒå¤±æ•—ã—ã¦ã„ã‚‹ï¼Ÿ
- ã—ã‹ã—ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒå‡ºã¦ã„ãªã„

ã€åŸå› D: ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šå•é¡Œã€‘
ç¢ºèªãƒã‚¤ãƒ³ãƒˆï¼š
1. Chrome flags: chrome://flags/
   - Touch Events API ã®è¨­å®š
   - Pointer Events ã®è¨­å®š
2. Windows Inkè¨­å®šï¼ˆWindowsã®å ´åˆï¼‰
3. ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ‰ãƒ©ã‚¤ãƒãƒ¼è¨­å®š


ã€æœ€ã‚‚å¯èƒ½æ€§ãŒé«˜ã„åŸå› ã€‘
â˜…â˜…â˜… Canvasè¦ç´ ã®ä¸Šã«ã€è¦‹ãˆãªã„è¦ç´ ï¼ˆã¾ãŸã¯è¦ªè¦ç´ ï¼‰ãŒé‡ãªã£ã¦ã„ã‚‹ â˜…â˜…â˜…

ç–‘ã‚ã—ã„è¦ç´ ã®å€™è£œï¼š
1. **#drawing-canvas ã‚³ãƒ³ãƒ†ãƒŠè¦ç´ **
   - Canvasè¦ç´ ã‚’åŒ…å«ã—ã¦ã„ã‚‹
   - pointer-eventsã®è¨­å®šãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ autoï¼‰
   
   â†’ ã“ã‚ŒãŒåŸå› ã®å¯èƒ½æ€§ã¯ä½ã„

2. **.canvas-area è¦ç´ **
   - position: relative
   - pointer-eventsã®è¨­å®šãªã—
   
   â†’ ã“ã‚ŒãŒåŸå› ã®å¯èƒ½æ€§ã¯ä½ã„

3. **ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ‘ãƒãƒ«ã®æ®‹éª¸**
   - display: none ã§ã‚‚ z-index ãŒæ®‹ã£ã¦ã„ã‚‹ï¼Ÿ
   
   â†’ ã“ã‚ŒãŒåŸå› ã®å¯èƒ½æ€§ã¯ä½ã„

4. **PixiJS Application.canvas ã® eventMode è¨­å®š**
   - eventMode: 'static' ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
   
   â†’ ã“ã‚Œã¯æ­£ã—ã„è¨­å®š

5. â˜…â˜…â˜… ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ â˜…â˜…â˜…
   - Sortable.js ãŒãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«é€æ˜ãªè¦ç´ ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹ï¼Ÿ
   - ã“ã‚ŒãŒCanvasé ˜åŸŸå…¨ä½“ã«åºƒãŒã£ã¦ã„ã‚‹å¯èƒ½æ€§


ã€æ¤œè¨¼æ–¹æ³•ã€‘
1. ãƒ–ãƒ©ã‚¦ã‚¶DevToolsã§Canvasè¦ç´ ã‚’ç›´æ¥æ¤œæŸ»
   - pointer-eventsã‚¹ã‚¿ã‚¤ãƒ«ã®ç¢ºèª
   - z-indexã®ç¢ºèª
   - è¦ªè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«ç¢ºèª

2. Consoleå‘½ä»¤ã§Canvasè¦ç´ ã®çŠ¶æ…‹ç¢ºèª
   ```javascript
   const canvas = document.querySelector('canvas');
   console.log('Canvas element:', canvas);
   console.log('pointer-events:', window.getComputedStyle(canvas).pointerEvents);
   console.log('z-index:', window.getComputedStyle(canvas).zIndex);
   console.log('position:', window.getComputedStyle(canvas).position);
   console.log('touch-action:', window.getComputedStyle(canvas).touchAction);
   ```

3. Canvasè¦ç´ ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ç¢ºèª
   ```javascript
   const rect = canvas.getBoundingClientRect();
   console.log('Canvas rect:', rect);
   ```

4. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç¢ºèª
   ```javascript
   const listeners = getEventListeners(canvas);
   console.log('Canvas listeners:', listeners);
   ```

5. é‡ãªã£ã¦ã„ã‚‹è¦ç´ ã®ç¢ºèª
   ```javascript
   const x = 400; // Canvasä¸­å¤®ã®Xåº§æ¨™
   const y = 300; // Canvasä¸­å¤®ã®Yåº§æ¨™
   const topElement = document.elementFromPoint(x, y);
   console.log('Top element at Canvas center:', topElement);
   ```


================================================================================
6. æ”¹ä¿®å®Ÿæ–½æ›¸ï¼ˆå„ªå…ˆé †ä½ä»˜ããƒ»æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ä»˜ï¼‰
================================================================================

--------------------------------------------------------------------------------
ã€ç·Šæ€¥å¯¾å¿œã€‘ä¿®æ­£0: å•é¡Œã®ç‰¹å®šï¼ˆè¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œï¼‰
--------------------------------------------------------------------------------

**ç›®çš„ï¼š**
Canvasè¦ç´ ãŒã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚Œãªã„åŸå› ã‚’ç‰¹å®šã™ã‚‹

**å®Ÿæ–½æ‰‹é †ï¼š**
1. ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChromeï¼‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ã
2. F12ã§DevToolsã‚’é–‹ã
3. Consoleã‚¿ãƒ–ã§ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ

**è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ1: Canvasè¦ç´ ã®çŠ¶æ…‹ç¢ºèª**
```javascript
console.log('========================================');
console.log('Canvas Element Diagnostics');
console.log('========================================');

const canvas = document.querySelector('canvas');
if (!canvas) {
    console.error('Canvas element not found!');
} else {
    console.log('Canvas element:', canvas);
    
    const styles = window.getComputedStyle(canvas);
    console.log('Computed styles:', {
        pointerEvents: styles.pointerEvents,
        touchAction: styles.touchAction,
        position: styles.position,
        zIndex: styles.zIndex,
        display: styles.display,
        visibility: styles.visibility,
        opacity: styles.opacity
    });
    
    const rect = canvas.getBoundingClientRect();
    console.log('Canvas rect:', {
        left: rect.left,
        top: rect.top,
        width: rect.width,
        height: rect.height
    });
}
```

**è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ2: Canvasä¸­å¤®ã®æœ€ä¸Šä½è¦ç´ ã‚’ç¢ºèª**
```javascript
console.log('========================================');
console.log('Top Element Check at Canvas Center');
console.log('========================================');

const canvas = document.querySelector('canvas');
if (canvas) {
    const rect = canvas.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    console.log('Canvas center coordinates:', { centerX, centerY });
    
    const topElement = document.elementFromPoint(centerX, centerY);
    console.log('Top element at canvas center:', topElement);
    console.log('Is Canvas?', topElement === canvas);
    
    if (topElement !== canvas) {
        console.error('âŒ Canvas is covered by another element!');
        console.log('Covering element tag:', topElement.tagName);
        console.log('Covering element class:', topElement.className);
        console.log('Covering element id:', topElement.id);
        
        const coveringStyles = window.getComputedStyle(topElement);
        console.log('Covering element styles:', {
            pointerEvents: coveringStyles.pointerEvents,
            position: coveringStyles.position,
            zIndex: coveringStyles.zIndex,
            backgroundColor: coveringStyles.backgroundColor,
            opacity: coveringStyles.opacity
        });
    } else {
        console.log('âœ… Canvas is not covered');
    }
}
```

**è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ3: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç¢ºèª**
```javascript
console.log('========================================');
console.log('Event Listeners Check');
console.log('========================================');

const canvas = document.querySelector('canvas');
if (canvas) {
    // getEventListeners() ã¯Chrome DevToolsã§ã®ã¿ä½¿ç”¨å¯èƒ½
    if (typeof getEventListeners !== 'undefined') {
        const listeners = getEventListeners(canvas);
        console.log('Canvas event listeners:', listeners);
        
        if (listeners.pointerdown) {
            console.log('âœ… pointerdown listeners:', listeners.pointerdown.length);
        } else {
            console.error('âŒ No pointerdown listeners!');
        }
    } else {
        console.warn('getEventListeners() not available outside DevTools');
    }
}
```

**è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ4: è¦ªè¦ç´ ã®ãƒã‚§ãƒ¼ãƒ³ç¢ºèª**
```javascript
console.log('========================================');
console.log('Parent Chain Check');
console.log('========================================');

const canvas = document.querySelector('canvas');
if (canvas) {
    let current = canvas;
    let depth = 0;
    
    while (current && depth < 10) {
        const styles = window.getComputedStyle(current);
        console.log(`Depth ${depth}: ${current.tagName}${current.id ? '#' + current.id : ''}${current.className ? '.' + current.className.split(' ')[0] : ''}`, {
            pointerEvents: styles.pointerEvents,
            position: styles.position,
            zIndex: styles.zIndex,
            overflow: styles.overflow
        });
        
        current = current.parentElement;
        depth++;
    }
}
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœï¼š**
- Canvasä¸­å¤®ã®æœ€ä¸Šä½è¦ç´ ãŒCanvasè‡ªèº«ã§ã‚ã‚‹
- Canvasè¦ç´ ã«pointerdownãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
- pointer-events: autoï¼ˆã¾ãŸã¯è¨­å®šãªã—ï¼‰
- touch-action: none

**ã‚‚ã—å•é¡ŒãŒè¦‹ã¤ã‹ã£ãŸå ´åˆï¼š**
- Canvasè¦ç´ ãŒåˆ¥ã®è¦ç´ ã«è¦†ã‚ã‚Œã¦ã„ã‚‹
  â†’ ä¿®æ­£1ã‚’å®Ÿæ–½
- pointer-eventsãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹
  â†’ ä¿®æ­£2ã‚’å®Ÿæ–½
- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„
  â†’ ä¿®æ­£3ã‚’å®Ÿæ–½


--------------------------------------------------------------------------------
ã€æœ€å„ªå…ˆã€‘ä¿®æ­£1: Canvasè¦ç´ ã®pointer-eventsæ˜ç¤ºåŒ–
--------------------------------------------------------------------------------

**ãƒ•ã‚¡ã‚¤ãƒ«:** styles/main.css

**ç›®çš„:**
Canvasè¦ç´ ãŒPointerEventã‚’ç¢ºå®Ÿã«å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

**ç¾åœ¨:**
```css
#drawing-canvas,
canvas { 
    cursor: crosshair; 
    touch-action: none;
    -ms-touch-action: none;
}
```

**ä¿®æ­£å¾Œ:**
```css
/* â˜…â˜…â˜… Canvasè¦ç´ ã®PointerEventå—ä»˜ã‚’æ˜ç¤ºåŒ– â˜…â˜…â˜… */
#drawing-canvas {
    cursor: crosshair;
    touch-action: none;
    -ms-touch-action: none;
    pointer-events: auto !important;  /* è¿½åŠ  */
    position: relative;  /* è¿½åŠ  */
    z-index: 1;  /* è¿½åŠ  */
}

canvas { 
    cursor: crosshair; 
    touch-action: none;
    -ms-touch-action: none;
    pointer-events: auto !important;  /* è¿½åŠ  */
    position: relative;  /* è¿½åŠ  */
    z-index: 1;  /* è¿½åŠ  */
}
```

**ç†ç”±:**
- pointer-events: auto ã‚’æ˜ç¤ºçš„ã«è¨­å®š
- position: relative ã§ã‚¹ã‚¿ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç¢ºç«‹
- z-index: 1 ã§ä»–ã®è¦ç´ ã‚ˆã‚Šå‰é¢ã«é…ç½®


--------------------------------------------------------------------------------
ã€æœ€å„ªå…ˆã€‘ä¿®æ­£2: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®z-indexèª¿æ•´
--------------------------------------------------------------------------------

**ãƒ•ã‚¡ã‚¤ãƒ«:** styles/main.css

**ç›®çš„:**
ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ãŒCanvasè¦ç´ ã‚’è¦†ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹

**ç¾åœ¨:**
```css
.layer-panel-container { 
    position: fixed; 
    right: 12px; 
    top: 50%; 
    transform: translateY(-50%); 
    z-index: 1000;  /* â† ã“ã‚ŒãŒåŸå› ã®å¯èƒ½æ€§ */
    display: flex; 
    flex-direction: column; 
    gap: 2px; 
    pointer-events: none;  /* è¦ªã¯ç„¡è¦– */
}
```

**ä¿®æ­£å¾Œ:**
```css
.layer-panel-container { 
    position: fixed; 
    right: 12px; 
    top: 50%; 
    transform: translateY(-50%); 
    z-index: 10;  /* â˜…â˜…â˜… 1000 â†’ 10 ã«å¤‰æ›´ â˜…â˜…â˜… */
    display: flex; 
    flex-direction: column; 
    gap: 2px; 
    pointer-events: none;
}
```

**ç†ç”±:**
- Canvasè¦ç´ ï¼ˆz-index: 1ï¼‰ã‚ˆã‚Šé«˜ã„ãŒã€éåº¦ã«é«˜ã™ããªã„å€¤
- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ‘ãƒãƒ«ï¼ˆz-index: 2000ï¼‰ã‚ˆã‚Šã¯ä½ã„


--------------------------------------------------------------------------------
ã€æœ€å„ªå…ˆã€‘ä¿®æ­£3: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ«ã®z-indexèª¿æ•´
--------------------------------------------------------------------------------

**ãƒ•ã‚¡ã‚¤ãƒ«:** styles/main.css

**ç¾åœ¨:**
```css
.status-panel { 
    position: fixed; 
    top: 12px; 
    left: 70px; 
    /* ... */
    z-index: 1000;  /* â† ã“ã‚Œã‚‚èª¿æ•´ */
}
```

**ä¿®æ­£å¾Œ:**
```css
.status-panel { 
    position: fixed; 
    top: 12px; 
    left: 70px; 
    /* ... */
    z-index: 10;  /* â˜…â˜…â˜… 1000 â†’ 10 ã«å¤‰æ›´ â˜…â˜…â˜… */
}
```


--------------------------------------------------------------------------------
ã€å„ªå…ˆåº¦ï¼šé«˜ã€‘ä¿®æ­£4: Canvasè¦ç´ ã®æ˜ç¤ºçš„ãªã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
--------------------------------------------------------------------------------

**ãƒ•ã‚¡ã‚¤ãƒ«:** system/drawing/drawing-engine.js

**ç›®çš„:**
Canvasè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¨ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã‚’å¼·åŒ–

**ç¾åœ¨:**
```javascript
_initializeCanvas() {
    const canvas = this.app.canvas || this.app.view;
    if (!canvas) {
        console.error('âŒ [DrawingEngine] Canvas not found');
        return;
    }

    canvas.style.touchAction = 'none';
    console.log('âœ… [DrawingEngine] Canvas found');

    // PointerHandler ã‚¢ã‚¿ãƒƒãƒ
    this.pointerDetach = window.PointerHandler.attach(canvas, {
        down: this._handlePointerDown.bind(this),
        move: this._handlePointerMove.bind(this),
        up: this._handlePointerUp.bind(this),
        cancel: this._handlePointerCancel.bind(this)
    }, {
        preventDefault: true
    });

    console.log('âœ… [DrawingEngine] PointerHandler attached');
}
```

**ä¿®æ­£å¾Œ:**
```javascript
_initializeCanvas() {
    const canvas = this.app.canvas || this.app.view;
    if (!canvas) {
        console.error('âŒ [DrawingEngine] Canvas not found');
        return;
    }

    // â˜…â˜…â˜… Canvasè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«æ˜ç¤ºåŒ– â˜…â˜…â˜…
    canvas.style.touchAction = 'none';
    canvas.style.pointerEvents = 'auto';
    canvas.style.position = 'relative';
    canvas.style.zIndex = '1';
    
    // â˜…â˜…â˜… è¨ºæ–­ãƒ­ã‚°è¿½åŠ  â˜…â˜…â˜…
    console.log('âœ… [DrawingEngine] Canvas found:', canvas);
    console.log('   Canvas computed styles:', {
        pointerEvents: window.getComputedStyle(canvas).pointerEvents,
        touchAction: window.getComputedStyle(canvas).touchAction,
        zIndex: window.getComputedStyle(canvas).zIndex,
        position: window.getComputedStyle(canvas).position
    });
    
    const rect = canvas.getBoundingClientRect();
    console.log('   Canvas rect:', {
        left: rect.left.toFixed(1),
        top: rect.top.toFixed(1),
        width: rect.width.toFixed(1),
        height: rect.height.toFixed(1)
    });

    // â˜…â˜…â˜… æœ€ä¸Šä½è¦ç´ ç¢ºèª â˜…â˜…â˜…
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const topElement = document.elementFromPoint(centerX, centerY);
    
    if (topElement !== canvas) {
        console.error('âŒ [DrawingEngine] Canvas is covered by another element!');
        console.error('   Covering element:', topElement.tagName, topElement.className, topElement.id);
    } else {
        console.log('âœ… [DrawingEngine] Canvas is not covered');
    }

    // PointerHandler ã‚¢ã‚¿ãƒƒãƒ
    this.pointerDetach = window.PointerHandler.attach(canvas, {
        down: this._handlePointerDown.bind(this),
        move: this._handlePointerMove.bind(this),
        up: this._handlePointerUp.bind(this),
        cancel: this._handlePointerCancel.bind(this)
    }, {
        preventDefault: true
    });

    console.log('âœ… [DrawingEngine] PointerHandler attached');
}
```


--------------------------------------------------------------------------------
ã€å„ªå…ˆåº¦ï¼šé«˜ã€‘ä¿®æ­£5: pointer-handler.jsã®ãƒ­ã‚°å¼·åŒ–
--------------------------------------------------------------------------------

**ãƒ•ã‚¡ã‚¤ãƒ«:** system/drawing/pointer-handler.js

**ç›®çš„:**
ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡çŠ¶æ³ã‚’è©³ç´°ã«ãƒ­ã‚°å‡ºåŠ›

**ä¿®æ­£ç®‡æ‰€:**
normalizeEvent()é–¢æ•°å†…ã«ãƒ­ã‚°è¿½åŠ 

**è¿½åŠ ã‚³ãƒ¼ãƒ‰:**
```javascript
function normalizeEvent(e) {
    let pType = e.pointerType;
    
    // â˜…â˜…â˜… è¨ºæ–­ãƒ­ã‚°è¿½åŠ  â˜…â˜…â˜…
    if (window.TEGAKI_DEBUG) {
        console.log('[PointerHandler] RAW event:', {
            pointerType: e.pointerType,
            pointerId: e.pointerId,
            pressure: e.pressure,
            tiltX: e.tiltX,
            tiltY: e.tiltY,
            clientX: e.clientX,
            clientY: e.clientY,
            target: e.target.tagName + (e.target.id ? '#' + e.target.id : '')
        });
    }
    
    // ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯: mouseã§ã‚‚ç­†åœ§ãƒ»å‚¾ããŒã‚ã‚Œã°ãƒšãƒ³æ‰±ã„
    if (pType === 'mouse') {
        const hasPressure = typeof e.pressure === 'number' && e.pressure > 0.01;
        const hasTilt = typeof e.tiltX === 'number' && 
                       (e.tiltX !== 0 || e.tiltY !== 0);
        
        if (hasPressure || hasTilt) {
            pType = 'pen';
            
            if (window.TEGAKI_DEBUG) {
                console.log('[PointerHandler] Type corrected: mouse â†’ pen', {
                    reason: hasPressure ? 'pressure' : 'tilt',
                    pressure: e.pressure,
                    tiltX: e.tiltX,
                    tiltY: e.tiltY
                });
            }
        }
    }
    
    return {
        pointerId: e.pointerId,
        pointerType: pType,
        clientX: e.clientX,
        clientY: e.clientY,
        pressure: e.pressure ?? 0.5,
        tiltX: e.tiltX ?? 0,
        tiltY: e.tiltY ?? 0,
        twist: e.twist ?? 0,
        button: e.button,
        buttons: e.buttons,
        originalEvent: e
    };
}
```

**ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒãƒƒã‚°ãƒ•ãƒ©ã‚°è¿½åŠ :**
config.jsã«è¿½åŠ 
```javascript
window.TEGAKI_DEBUG = true;  // è¨ºæ–­æ™‚ã®ã¿ true
```


--------------------------------------------------------------------------------
ã€å„ªå…ˆåº¦ï¼šä¸­ã€‘ä¿®æ­£6: ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†ç¢ºèª
--------------------------------------------------------------------------------

**ãƒ•ã‚¡ã‚¤ãƒ«:** ui/layer-panel-renderer.js

**ç›®çš„:**
Sortable.jsãŒCanvasè¦ç´ ã‚’è¦†ã†è¦ç´ ã‚’ç”Ÿæˆã—ã¦ã„ãªã„ã‹ç¢ºèª

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**
1. SortableåˆæœŸåŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³
   - ghostClass ã®è¨­å®š
   - dragClass ã®è¨­å®š
   - ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ç”Ÿæˆ

2. ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®DOMå¤‰æ›´
   - é€æ˜ãªè¦ç´ ãŒç”Ÿæˆã•ã‚Œã¦ã„ãªã„ã‹
   - z-indexãŒç•°å¸¸ã«é«˜ããªã„ã‹

**ä¿®æ­£æ–¹é‡:**
ã‚‚ã—Sortable.jsãŒå•é¡Œã®å ´åˆã€ä»¥ä¸‹ã‚’è¨­å®šï¼š
```javascript
Sortable.create(element, {
    // ...
    ghostClass: 'layer-item-ghost',
    dragClass: 'layer-item-dragging',
    forceFallback: false,  // ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ‰ãƒ©ãƒƒã‚°ã‚’ä½¿ç”¨
    // ...
});
```

CSSã§åˆ¶å¾¡ï¼š
```css
.layer-item-ghost {
    opacity: 0.4;
    z-index: 9999;  /* ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«å†…ã§ã®ã¿æœ‰åŠ¹ */
}

.layer-item-dragging {
    opacity: 0.8;
    cursor: grabbing;
    z-index: 10000;  /* ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«å†…ã§ã®ã¿æœ‰åŠ¹ */
}
```


--------------------------------------------------------------------------------
ã€å„ªå…ˆåº¦ï¼šä½ã€‘ä¿®æ­£7: éå‰°ãªã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®å‰Šé™¤
--------------------------------------------------------------------------------

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:**
- drawing-engine.js
- brush-core.js
- coordinate-system.js

**å‰Šé™¤å¯¾è±¡:**
1. åº§æ¨™å¤‰æ›ã®è©³ç´°ãƒ­ã‚°ï¼ˆStep 1/2/3ãªã©ï¼‰
2. PointerDown/Move/Upã®è©³ç´°ãƒ­ã‚°ï¼ˆè¨ºæ–­å®Œäº†å¾Œï¼‰
3. åº§æ¨™å€¤ã®é€æ¬¡å‡ºåŠ›

**ä¿æŒå¯¾è±¡:**
1. åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°ï¼ˆå„ãƒ•ã‚¡ã‚¤ãƒ«1å›ã®ã¿ï¼‰
2. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ï¼ˆconsole.errorï¼‰
3. è­¦å‘Šãƒ­ã‚°ï¼ˆconsole.warnï¼‰

**å®Ÿæ–½ã‚¿ã‚¤ãƒŸãƒ³ã‚°:**
- ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³å•é¡ŒãŒè§£æ±ºã—ãŸå¾Œ
- è¨ºæ–­ãƒ­ã‚°ã¯ window.TEGAKI_DEBUG ã§ON/OFF


================================================================================
7. äºŒé‡å®Ÿè£…ãƒ»SOLIDé•åã®ç¢ºèªã¨æ’²æ»…
================================================================================

--------------------------------------------------------------------------------
7-1. åº§æ¨™å¤‰æ›ã®äºŒé‡å®Ÿè£…ãƒã‚§ãƒƒã‚¯
--------------------------------------------------------------------------------

ã€ç¾çŠ¶ã€‘
âœ… OK: drawing-engine.js ã¯ CoordinateSystem ã®ã¿ä½¿ç”¨
âœ… OK: brush-core.js ã¯ CoordinateSystem ã®ã¿ä½¿ç”¨
âœ… OK: stroke-recorder.js ã¯åº§æ¨™å¤‰æ›ã‚’è¡Œã‚ãªã„ï¼ˆLocalåº§æ¨™ã‚’ãã®ã¾ã¾è¨˜éŒ²ï¼‰

ã€å•é¡Œãªã—ã€‘


--------------------------------------------------------------------------------
7-2. ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ³ãƒœãƒ«ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
--------------------------------------------------------------------------------

ã€ç¢ºèªé …ç›®ã€‘
1. window.BrushCoreï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
   â†’ âœ… OKï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã€drawing-engine.jsã§å‚ç…§ï¼‰

2. window.CoordinateSystemï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰
   â†’ âœ… OKï¼ˆPhase 1æ”¹ä¿®ã§çµ±ä¸€æ¸ˆã¿ï¼‰

3. window.strokeRecorderï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰ vs window.StrokeRecorderï¼ˆã‚¯ãƒ©ã‚¹ï¼‰
   â†’ âœ… OKï¼ˆæ„å›³çš„ãªè¨­è¨ˆï¼‰

ã€å•é¡Œãªã—ã€‘


--------------------------------------------------------------------------------
7-3. å¾ªç’°ä¾å­˜ã®ãƒã‚§ãƒƒã‚¯
--------------------------------------------------------------------------------

ã€ä¾å­˜ã‚°ãƒ©ãƒ•ã€‘
```
pointer-handler.js
  â†’ ï¼ˆä¾å­˜ãªã—ï¼‰

coordinate-system.js
  â†’ eventBus
  â†’ cameraSystemï¼ˆsetCameraSystemçµŒç”±ã€å¾ªç’°ãªã—ï¼‰

brush-core.js
  â†’ CoordinateSystem
  â†’ strokeRecorder
  â†’ layerManager
  â†’ strokeRenderer

drawing-engine.js
  â†’ BrushCore
  â†’ CoordinateSystem
  â†’ PointerHandler
```

ã€çµè«–ã€‘
âœ… å¾ªç’°ä¾å­˜ãªã—
âœ… ä¾å­˜æ–¹å‘ã¯ä¸€æ–¹å‘ï¼ˆä¸‹ä½â†’ä¸Šä½ã®ã¿ï¼‰


--------------------------------------------------------------------------------
7-4. DRYé•åã®ãƒã‚§ãƒƒã‚¯
--------------------------------------------------------------------------------

ã€åº§æ¨™å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã€‘
âœ… OK: coordinate-system.js ã«ä¸€å…ƒåŒ–

ã€PointerEventæ­£è¦åŒ–ã€‘
âœ… OK: pointer-handler.js ã® normalizeEvent() ã«ä¸€å…ƒåŒ–

ã€ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ²ã€‘
âœ… OK: stroke-recorder.js ã«ä¸€å…ƒåŒ–

ã€å•é¡Œãªã—ã€‘


================================================================================
8. æ”¹ä¿®å¾Œã®å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
================================================================================

ã€å¿…é ˆç¢ºèªé …ç›®ã€‘
â–¡ 1. ãƒã‚¦ã‚¹ã§æç”»ã§ãã‚‹
â–¡ 2. ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§æç”»ã§ãã‚‹ â˜…â˜…â˜… é‡è¦ â˜…â˜…â˜…
â–¡ 3. ã‚¿ãƒƒãƒã§æç”»ã§ãã‚‹ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
â–¡ 4. ç­†åœ§ãŒæ­£ã—ãåæ˜ ã•ã‚Œã‚‹
â–¡ 5. ãƒšãƒ³/æ¶ˆã—ã‚´ãƒ åˆ‡æ›¿ãŒå‹•ä½œã™ã‚‹
â–¡ 6. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ï¼ˆãƒã‚¦ã‚¹ï¼‰
â–¡ 7. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ï¼ˆãƒšãƒ³ï¼‰ â˜…â˜…â˜… é‡è¦ â˜…â˜…â˜…
â–¡ 8. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ›´ï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼‰
â–¡ 9. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ›´ï¼ˆçŸ¢å°ã‚­ãƒ¼ï¼‰
â–¡ 10. Undo/Redo ãŒæ­£å¸¸å‹•ä½œ

ã€è¨ºæ–­ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã€‘
â–¡ 11. è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ1å®Ÿè¡Œï¼ˆCanvasè¦ç´ ã®çŠ¶æ…‹ç¢ºèªï¼‰
â–¡ 12. è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ2å®Ÿè¡Œï¼ˆCanvasä¸­å¤®ã®æœ€ä¸Šä½è¦ç´ ç¢ºèªï¼‰
â–¡ 13. è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ3å®Ÿè¡Œï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç¢ºèªï¼‰
â–¡ 14. è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ4å®Ÿè¡Œï¼ˆè¦ªè¦ç´ ãƒã‚§ãƒ¼ãƒ³ç¢ºèªï¼‰

ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèªã€‘
â–¡ 15. æç”»æ™‚ã®FPSä½ä¸‹ãŒãªã„
â–¡ 16. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„
â–¡ 17. ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒãªã„ï¼ˆé•·æ™‚é–“ä½¿ç”¨ï¼‰

ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ç¢ºèªã€‘
â–¡ 18. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ­ãƒƒã‚¯ä¸­ã¯æç”»ã§ããªã„
â–¡ 19. èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å‰Šé™¤ã§ããªã„
â–¡ 20. è¤‡æ•°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã®æç”»
â–¡ 21. ã‚ºãƒ¼ãƒ /ãƒ‘ãƒ³ä¸­ã®æç”»
â–¡ 22. ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒªã‚µã‚¤ã‚ºå¾Œã®æç”»


================================================================================
9. æ”¹ä¿®è¨ˆç”»æ›¸
================================================================================

--------------------------------------------------------------------------------
9-1. æ”¹ä¿®ã®å„ªå…ˆé †ä½
--------------------------------------------------------------------------------

ã€Phase 1: ç·Šæ€¥è¨ºæ–­ï¼ˆå³æ™‚å®Ÿæ–½ï¼‰ã€‘
ç›®çš„: å•é¡Œã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®šã™ã‚‹

å®Ÿæ–½é …ç›®:
1. è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ1ã€œ4ã‚’å®Ÿè¡Œ
2. Canvasè¦ç´ ã®çŠ¶æ…‹ç¢ºèª
3. æœ€ä¸Šä½è¦ç´ ã®ç¢ºèª
4. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç¢ºèª
5. è¦ªè¦ç´ ãƒã‚§ãƒ¼ãƒ³ã®ç¢ºèª

æ‰€è¦æ™‚é–“: 10åˆ†
å¿…è¦ãªã‚¹ã‚­ãƒ«: ãƒ–ãƒ©ã‚¦ã‚¶DevToolsã®åŸºæœ¬æ“ä½œ

æˆåŠŸåŸºæº–:
- Canvasè¦ç´ ãŒã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‰ãªã„åŸå› ãŒç‰¹å®šã•ã‚Œã‚‹
- è¨ºæ–­ãƒ­ã‚°ã§å•é¡Œç®‡æ‰€ãŒæ˜ç¢ºã«ãªã‚‹


ã€Phase 2: æœ€å„ªå…ˆä¿®æ­£ï¼ˆåŸå› ã«å¿œã˜ã¦å®Ÿæ–½ï¼‰ã€‘
ç›®çš„: Canvasè¦ç´ ãŒPointerEventã‚’ç¢ºå®Ÿã«å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

å®Ÿæ–½é …ç›®:
- ä¿®æ­£1: Canvasè¦ç´ ã®pointer-eventsæ˜ç¤ºåŒ–ï¼ˆstyles/main.cssï¼‰
- ä¿®æ­£2: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®z-indexèª¿æ•´ï¼ˆstyles/main.cssï¼‰
- ä¿®æ­£3: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ«ã®z-indexèª¿æ•´ï¼ˆstyles/main.cssï¼‰

æ‰€è¦æ™‚é–“: 5åˆ†
å¿…è¦ãªã‚¹ã‚­ãƒ«: CSSç·¨é›†

æˆåŠŸåŸºæº–:
- ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§Canvasè¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒåˆ°é”ã™ã‚‹
- ãƒ–ãƒ©ã‚¦ã‚¶ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã€æç”»ãŒå¯èƒ½ã«ãªã‚‹


ã€Phase 3: è¨ºæ–­æ©Ÿèƒ½å¼·åŒ–ï¼ˆå•é¡Œè§£æ±ºå¾Œï¼‰ã€‘
ç›®çš„: å°†æ¥ã®å•é¡Œç™ºç”Ÿæ™‚ã«è¿…é€Ÿã«è¨ºæ–­ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

å®Ÿæ–½é …ç›®:
- ä¿®æ­£4: Canvasè¦ç´ ã®æ˜ç¤ºçš„ãªã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆdrawing-engine.jsï¼‰
- ä¿®æ­£5: pointer-handler.jsã®ãƒ­ã‚°å¼·åŒ–
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒãƒƒã‚°ãƒ•ãƒ©ã‚°ã®å®Ÿè£…ï¼ˆconfig.jsï¼‰

æ‰€è¦æ™‚é–“: 15åˆ†
å¿…è¦ãªã‚¹ã‚­ãƒ«: JavaScriptç·¨é›†

æˆåŠŸåŸºæº–:
- åˆæœŸåŒ–æ™‚ã«è¨ºæ–­ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹
- Canvasè¦ç´ ã®çŠ¶æ…‹ãŒè‡ªå‹•ç¢ºèªã•ã‚Œã‚‹
- window.TEGAKI_DEBUG ã§è©³ç´°ãƒ­ã‚°ã®ON/OFFå¯èƒ½


ã€Phase 4: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆå…¨æ©Ÿèƒ½å‹•ä½œç¢ºèªå¾Œï¼‰ã€‘
ç›®çš„: ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ã—ã€ä¿å®ˆæ€§ã‚’å‘ä¸Šã™ã‚‹

å®Ÿæ–½é …ç›®:
- ä¿®æ­£7: éå‰°ãªã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®å‰Šé™¤
- è¨ºæ–­ãƒ­ã‚°ã®æ•´ç†ï¼ˆwindow.TEGAKI_DEBUG ã§ON/OFFï¼‰

æ‰€è¦æ™‚é–“: 10åˆ†
å¿…è¦ãªã‚¹ã‚­ãƒ«: JavaScriptç·¨é›†

æˆåŠŸåŸºæº–:
- æœ¬ç•ªç’°å¢ƒã§ä¸è¦ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œãªã„
- ãƒ‡ãƒãƒƒã‚°æ™‚ã®ã¿è©³ç´°ãƒ­ã‚°ãŒæœ‰åŠ¹ã«ãªã‚‹


--------------------------------------------------------------------------------
9-2. ãƒªã‚¹ã‚¯è©•ä¾¡
--------------------------------------------------------------------------------

ã€ãƒªã‚¹ã‚¯1: Canvasè¦ç´ ãŒåˆ¥ã®è¦ç´ ã«è¦†ã‚ã‚Œã¦ã„ã‚‹ã€‘
å¯èƒ½æ€§: â˜…â˜…â˜…â˜…â˜… éå¸¸ã«é«˜ã„
å½±éŸ¿åº¦: â˜…â˜…â˜…â˜…â˜… è‡´å‘½çš„
å¯¾å¿œç­–: ä¿®æ­£1ã€œ3ã§è§£æ±º

ã€ãƒªã‚¹ã‚¯2: pointer-eventsãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã€‘
å¯èƒ½æ€§: â˜…â˜…â˜…â˜†â˜† ä¸­ç¨‹åº¦
å½±éŸ¿åº¦: â˜…â˜…â˜…â˜…â˜… è‡´å‘½çš„
å¯¾å¿œç­–: ä¿®æ­£1ã§è§£æ±º

ã€ãƒªã‚¹ã‚¯3: ãƒ–ãƒ©ã‚¦ã‚¶/OS/ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å•é¡Œã€‘
å¯èƒ½æ€§: â˜…â˜…â˜†â˜†â˜† ä½ã„
å½±éŸ¿åº¦: â˜…â˜…â˜…â˜…â˜† é«˜ã„
å¯¾å¿œç­–: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒã®ç¢ºèªãŒå¿…è¦

ã€ãƒªã‚¹ã‚¯4: Sortable.jsãŒCanvasè¦ç´ ã‚’è¦†ã†ã€‘
å¯èƒ½æ€§: â˜…â˜†â˜†â˜†â˜† éå¸¸ã«ä½ã„
å½±éŸ¿åº¦: â˜…â˜…â˜…â˜…â˜† é«˜ã„
å¯¾å¿œç­–: ä¿®æ­£6ã§ç¢ºèªãƒ»è§£æ±º


--------------------------------------------------------------------------------
9-3. ä¿®æ­£ã®å½±éŸ¿ç¯„å›²
--------------------------------------------------------------------------------

ã€ä¿®æ­£1ã€œ3: CSSã®å¤‰æ›´ã€‘
å½±éŸ¿ç¯„å›²: æœ€å°
å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«: styles/main.css ã®ã¿
ãƒªã‚¹ã‚¯: éå¸¸ã«ä½ã„
ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: å®¹æ˜“ï¼ˆCSSãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å…ƒã®ã¿ï¼‰

ã€ä¿®æ­£4: drawing-engine.jsã®å¤‰æ›´ã€‘
å½±éŸ¿ç¯„å›²: å°
å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«: system/drawing/drawing-engine.js ã®ã¿
ãƒªã‚¹ã‚¯: ä½ã„ï¼ˆè¨ºæ–­ãƒ­ã‚°ã®è¿½åŠ ã®ã¿ï¼‰
ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: å®¹æ˜“

ã€ä¿®æ­£5: pointer-handler.jsã®å¤‰æ›´ã€‘
å½±éŸ¿ç¯„å›²: å°
å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«: system/drawing/pointer-handler.js ã®ã¿
ãƒªã‚¹ã‚¯: ä½ã„ï¼ˆè¨ºæ–­ãƒ­ã‚°ã®è¿½åŠ ã®ã¿ï¼‰
ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: å®¹æ˜“


--------------------------------------------------------------------------------
9-4. å®Ÿæ–½ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ¨å¥¨ï¼‰
--------------------------------------------------------------------------------

ã€Day 1: è¨ºæ–­ã¨ç·Šæ€¥ä¿®æ­£ã€‘
æ™‚é–“: 30åˆ†
1. [10åˆ†] Phase 1: è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
2. [5åˆ†]  Phase 2: ä¿®æ­£1ã€œ3å®Ÿæ–½
3. [10åˆ†] å‹•ä½œç¢ºèªï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§æç”»ãƒ†ã‚¹ãƒˆï¼‰
4. [5åˆ†]  ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°ãƒ†ã‚¹ãƒˆ

ã€Day 2: è¨ºæ–­æ©Ÿèƒ½å¼·åŒ–ã€‘
æ™‚é–“: 30åˆ†
1. [15åˆ†] Phase 3: ä¿®æ­£4ã€œ5å®Ÿæ–½
2. [10åˆ†] å‹•ä½œç¢ºèªï¼ˆå…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼‰
3. [5åˆ†]  ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèª

ã€Day 3: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã€‘
æ™‚é–“: 15åˆ†
1. [10åˆ†] Phase 4: ä¿®æ­£7å®Ÿæ–½
2. [5åˆ†]  æœ€çµ‚å‹•ä½œç¢ºèª


--------------------------------------------------------------------------------
9-5. æˆåŠŸåŸºæº–
--------------------------------------------------------------------------------

ã€æœ€ä½é™ã®æˆåŠŸåŸºæº–ã€‘
- ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§æç”»ã§ãã‚‹
- ãƒã‚¦ã‚¹ã§æç”»ã§ãã‚‹ï¼ˆæ—¢å­˜æ©Ÿèƒ½ã®ç¶­æŒï¼‰
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ï¼ˆãƒšãƒ³ãƒ»ãƒã‚¦ã‚¹ï¼‰

ã€ç†æƒ³çš„ãªæˆåŠŸåŸºæº–ã€‘
- ä¸Šè¨˜ + è¨ºæ–­æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- ä¸Šè¨˜ + ã‚³ãƒ¼ãƒ‰ãŒã‚¯ãƒªãƒ¼ãƒ³ï¼ˆä¸è¦ãªãƒ­ã‚°ãªã—ï¼‰
- ä¸Šè¨˜ + ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹


================================================================================
10. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
================================================================================

--------------------------------------------------------------------------------
10-1. å•é¡Œ: ä¿®æ­£å¾Œã‚‚ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§æç”»ã§ããªã„
--------------------------------------------------------------------------------

ã€ç¢ºèªé …ç›®ã€‘
1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
   - Ctrl+Shift+Delete
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
   - ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èµ·å‹•

2. è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†å®Ÿè¡Œ
   - Canvasè¦ç´ ãŒæœ€ä¸Šä½è¦ç´ ã‹ç¢ºèª
   - pointer-eventsãŒ auto ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª

3. ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒç¢ºèª
   - Chromeæœ€æ–°ç‰ˆã‹ç¢ºèª
   - chrome://flags/ ã§ Touch Events API ãŒæœ‰åŠ¹ã‹ç¢ºèª

4. OS/ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ç¢ºèªï¼ˆWindowsï¼‰
   - Windows Inkè¨­å®š
   - ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®æ›´æ–°
   - ãƒšãƒ³ã¨Windows Inkã®è¨­å®šã‚’ç¢ºèª


--------------------------------------------------------------------------------
10-2. å•é¡Œ: ãƒã‚¦ã‚¹ã§ã‚‚æç”»ã§ããªããªã£ãŸ
--------------------------------------------------------------------------------

ã€ç¢ºèªé …ç›®ã€‘
1. ä¿®æ­£ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
   - styles/main.css ã‚’å…ƒã«æˆ»ã™
   - ãƒ–ãƒ©ã‚¦ã‚¶ãƒªãƒ­ãƒ¼ãƒ‰

2. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª
   - ãƒ–ãƒ©ã‚¦ã‚¶Consoleã§ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª

3. PointerHandlerã®å‹•ä½œç¢ºèª
   ```javascript
   const canvas = document.querySelector('canvas');
   canvas.addEventListener('pointerdown', (e) => {
       console.log('Direct listener:', e);
   });
   ```


--------------------------------------------------------------------------------
10-3. å•é¡Œ: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ãŒCanvasè¦ç´ ã®å¾Œã‚ã«éš ã‚ŒãŸ
--------------------------------------------------------------------------------

ã€åŸå› ã€‘
z-indexã®èª¿æ•´ãŒä¸é©åˆ‡

ã€è§£æ±ºç­–ã€‘
styles/main.css ã§ z-index ã‚’èª¿æ•´
```css
.layer-panel-container { 
    z-index: 10;  /* Canvas(z-index:1)ã‚ˆã‚Šå‰é¢ */
}
```


--------------------------------------------------------------------------------
10-4. å•é¡Œ: è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„
--------------------------------------------------------------------------------

ã€åŸå› ã€‘
PixiJS Application ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¦ã„ãªã„

ã€è§£æ±ºç­–ã€‘
1. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å†åº¦å®Ÿè¡Œ
2. window.drawingAppInstance ã®å­˜åœ¨ç¢ºèª
   ```javascript
   console.log('App instance:', window.drawingAppInstance);
   console.log('PixiJS app:', window.drawingAppInstance?.pixiApp);
   ```


================================================================================
11. å°†æ¥çš„ãªæ”¹å–„ææ¡ˆï¼ˆPhase 5ä»¥é™ï¼‰
================================================================================

--------------------------------------------------------------------------------
11-1. å®Œå…¨ãªDIï¼ˆä¾å­˜æ³¨å…¥ï¼‰åŒ–
--------------------------------------------------------------------------------

ã€ç¾çŠ¶ã€‘
- BrushCore ãŒ window.* ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã«ä¾å­˜
- åˆæœŸåŒ–é †åºã«ä¾å­˜ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãŒå…ˆã«è¨­å®šã•ã‚Œã‚‹å¿…è¦ï¼‰

ã€æ”¹å–„æ¡ˆã€‘
```javascript
// core-engine.js
this.brushCore = new BrushCore({
    coordinateSystem: this.coordinateSystem,
    strokeRecorder: this.strokeRecorder,
    layerManager: this.layerSystem,
    strokeRenderer: this.strokeRenderer,
    pressureHandler: window.pressureHandler,
    eventBus: this.eventBus
});
```

ã€ãƒ¡ãƒªãƒƒãƒˆã€‘
- ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“ï¼ˆãƒ¢ãƒƒã‚¯ã®æ³¨å…¥ï¼‰
- åˆæœŸåŒ–é †åºã®ä¾å­˜ã‚’æ’é™¤
- ã‚°ãƒ­ãƒ¼ãƒãƒ«æ±šæŸ“ã®å‰Šæ¸›


--------------------------------------------------------------------------------
11-2. ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹çµŒç”±ã®ç–çµåˆåŒ–
--------------------------------------------------------------------------------

ã€ç¾çŠ¶ã€‘
- BrushCore ãŒ StrokeRecorder ã‚’ç›´æ¥å‘¼ã³å‡ºã—

ã€æ”¹å–„æ¡ˆã€‘
```javascript
// BrushCore
startStroke(localX, localY, pressure) {
    this.eventBus.emit('stroke:start-requested', {
        localX, localY, pressure, layerId: this.getActiveLayerId()
    });
}

// StrokeRecorder
this.eventBus.on('stroke:start-requested', (data) => {
    this.startStroke(data.localX, data.localY, data.pressure);
});
```

ã€ãƒ¡ãƒªãƒƒãƒˆã€‘
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®ç–çµåˆ
- æ©Ÿèƒ½è¿½åŠ ãŒå®¹æ˜“ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ ã®ã¿ï¼‰


--------------------------------------------------------------------------------
11-3. ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®å®Ÿè£…
--------------------------------------------------------------------------------

ã€ç¾çŠ¶ã€‘
- console.log/warn/error ã®ç›´æ¥å‘¼ã³å‡ºã—
- window.TEGAKI_DEBUG ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹ON/OFF

ã€æ”¹å–„æ¡ˆã€‘
```javascript
// logger.js
class Logger {
    static TRACE = 0;
    static DEBUG = 1;
    static INFO = 2;
    static WARN = 3;
    static ERROR = 4;
    
    constructor(name, level = Logger.INFO) {
        this.name = name;
        this.level = level;
    }
    
    debug(...args) {
        if (this.level <= Logger.DEBUG) {
            console.log(`[${this.name}] DEBUG:`, ...args);
        }
    }
    
    error(...args) {
        if (this.level <= Logger.ERROR) {
            console.error(`[${this.name}] ERROR:`, ...args);
        }
    }
}

// ä½¿ç”¨ä¾‹
const logger = new Logger('BrushCore', Logger.INFO);
logger.debug('åº§æ¨™å¤‰æ›é–‹å§‹'); // æœ¬ç•ªã§ã¯å‡ºåŠ›ã•ã‚Œãªã„
logger.error('strokeRecorder is null'); // å¸¸ã«å‡ºåŠ›
```


--------------------------------------------------------------------------------
11-4. å‹å®šç¾©ã®è¿½åŠ ï¼ˆJSDocï¼‰
--------------------------------------------------------------------------------

ã€æ”¹å–„æ¡ˆã€‘
```javascript
/**
 * @typedef {Object} LocalCoords
 * @property {number} localX - ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™X
 * @property {number} localY - ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™Y
 */

/**
 * @typedef {Object} StrokePoint
 * @property {number} x - Xåº§æ¨™
 * @property {number} y - Yåº§æ¨™
 * @property {number} pressure - ç­†åœ§ (0.0-1.0)
 * @property {number} time - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
 */

/**
 * ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–‹å§‹
 * @param {number} clientX - Screen Xåº§æ¨™
 * @param {number} clientY - Screen Yåº§æ¨™
 * @param {number} pressure - ç­†åœ§
 * @returns {void}
 */
startStroke(clientX, clientY, pressure) {
    // ...
}
```


================================================================================
12. ã¾ã¨ã‚ï¼šå³åº§ã«å®Ÿæ–½ã™ã¹ãä¿®æ­£
================================================================================

ã€æœ€å„ªå…ˆï¼ˆä»Šã™ãå®Ÿæ–½ï¼‰ã€‘
1. è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ1ã€œ4ã‚’å®Ÿè¡Œ
   â†’ å•é¡Œã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®š

2. styles/main.css ã‚’ä¿®æ­£
   - ä¿®æ­£1: Canvasè¦ç´ ã® pointer-events æ˜ç¤ºåŒ–
   - ä¿®æ­£2: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã® z-index èª¿æ•´ï¼ˆ1000 â†’ 10ï¼‰
   - ä¿®æ­£3: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ«ã® z-index èª¿æ•´ï¼ˆ1000 â†’ 10ï¼‰

3. ãƒ–ãƒ©ã‚¦ã‚¶ãƒªãƒ­ãƒ¼ãƒ‰
   â†’ ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§æç”»ãƒ†ã‚¹ãƒˆ

ã€æ¬¡ã«å®Ÿæ–½ã€‘
4. system/drawing/drawing-engine.js ã‚’ä¿®æ­£
   - ä¿®æ­£4: Canvasè¦ç´ ã®è¨ºæ–­ãƒ­ã‚°è¿½åŠ 

5. system/drawing/pointer-handler.js ã‚’ä¿®æ­£
   - ä¿®æ­£5: ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ã®è©³ç´°ãƒ­ã‚°è¿½åŠ 

6. config.js ã‚’ä¿®æ­£
   - window.TEGAKI_DEBUG = true è¿½åŠ ï¼ˆè¨ºæ–­æ™‚ã®ã¿ï¼‰

ã€æ¤œè¨¼ã€‘
7. ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§æç”»ãƒ†ã‚¹ãƒˆ
8. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°ãƒ†ã‚¹ãƒˆï¼ˆãƒšãƒ³ãƒ»ãƒã‚¦ã‚¹ï¼‰
9. ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèª

ã€å ±å‘Šã€‘
- ä¿®æ­£å‰: ãƒã‚¦ã‚¹â—‹ ãƒšãƒ³Ã— ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆãƒã‚¦ã‚¹â—‹ ãƒšãƒ³Ã—ï¼‰
- ä¿®æ­£å¾Œ: ãƒã‚¦ã‚¹â—‹ ãƒšãƒ³â—‹ ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆãƒã‚¦ã‚¹â—‹ ãƒšãƒ³â—‹ï¼‰


================================================================================
è£œè¶³1: pointerTypeèª¤èªå•é¡Œã«ã¤ã„ã¦
================================================================================

ã€pointer-handler.js ã® normalizeEvent()ã€‘
ç¾åœ¨ã€ä»¥ä¸‹ã®ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ã§è£œæ­£æ¸ˆã¿ï¼š
- pointerType='mouse' ã‹ã¤ pressure > 0.01 â†’ 'pen' ã«è£œæ­£
- pointerType='mouse' ã‹ã¤ tiltX/tiltY != 0 â†’ 'pen' ã«è£œæ­£

ã€ç¢ºèªæ–¹æ³•ã€‘
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«
canvas.addEventListener('pointerdown', (e) => {
    console.log('Native pointerType:', e.pointerType);
    console.log('Pressure:', e.pressure);
    console.log('Tilt:', e.tiltX, e.tiltY);
});
```

ã€ã‚‚ã—è£œæ­£ãŒä¸ååˆ†ãªå ´åˆã€‘
- Windowsç’°å¢ƒã§ãƒšãƒ³ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®è¨­å®šç¢ºèª
- Chrome flags: chrome://flags/ ã§ "Touch Events API" ç¢ºèª
- ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒšãƒ³ã‚µãƒãƒ¼ãƒˆçŠ¶æ³ç¢ºèª


================================================================================
è£œè¶³2: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°å•é¡Œã«ã¤ã„ã¦
================================================================================

ã€ç¾çŠ¶ã€‘
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ãŒã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã§å‹•ä½œã—ãªã„
- ãƒã‚¦ã‚¹ã§ã¯æ­£å¸¸å‹•ä½œ

ã€åŸå› ã®å¯èƒ½æ€§ã€‘
1. Sortable.js ãŒã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒšãƒ³ã«å¯¾å¿œã—ã¦ã„ãªã„
2. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã® touch-action è¨­å®šãŒä¸é©åˆ‡
3. pointer-events ã®ç«¶åˆ

ã€ç¢ºèªæ–¹æ³•ã€‘
```javascript
// ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã®çŠ¶æ…‹ç¢ºèª
const layerItem = document.querySelector('.layer-item');
const styles = window.getComputedStyle(layerItem);
console.log('Layer item styles:', {
    touchAction: styles.touchAction,
    pointerEvents: styles.pointerEvents,
    zIndex: styles.zIndex
});
```

ã€ä¿®æ­£æ¡ˆã€‘
styles/main.css
```css
.layer-item { 
    /* ... */
    touch-action: none;  /* æ—¢ã«è¨­å®šæ¸ˆã¿ */
    -ms-touch-action: none;  /* æ—¢ã«è¨­å®šæ¸ˆã¿ */
}

.layer-thumbnail { 
    /* ... */
    touch-action: none;  /* æ—¢ã«è¨­å®šæ¸ˆã¿ */
    -ms-touch-action: none;  /* æ—¢ã«è¨­å®šæ¸ˆã¿ */
    pointer-events: auto;  /* è¿½åŠ  */
}
```

ã€Sortable.jsã®è¨­å®šç¢ºèªã€‘
ui/layer-panel-renderer.js
```javascript
Sortable.create(element, {
    // ...
    forceFallback: false,  // ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ‰ãƒ©ãƒƒã‚°ã‚’ä½¿ç”¨
    fallbackTolerance: 3,  // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã®é–¾å€¤
    touchStartThreshold: 0,  // ã‚¿ãƒƒãƒé–‹å§‹ã®é–¾å€¤
    // ...
});
```


================================================================================
çµ‚ã‚ã‚Š
================================================================================