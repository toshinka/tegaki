# ğŸ¨ Tegaki WebGL2 - ãƒ•ã‚¡ã‚¤ãƒ«è¾å…¸ & ãƒ•ãƒ­ãƒ¼è§£æ

## ğŸ“‹ ç¾çŠ¶ã‚µãƒãƒªãƒ¼

### âœ… æç”»ãƒ•ãƒ­ãƒ¼ï¼ˆç¾åœ¨ã®çµŒè·¯ï¼‰
```
PointerEvent
  â†“
drawing-engine.js (_handlePointerDown/Move/Up)
  â†“ Screen â†’ Canvas â†’ World â†’ Local åº§æ¨™å¤‰æ›
brush-core.js (startStroke/updateStroke/finalizeStroke)
  â†“
stroke-recorder.js (ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²)
  â†“
stroke-renderer.js (renderFinalStroke)
  â†“ ãƒšãƒ³: SDF/MSDFè©¦è¡Œ â†’ Legacy fallback
  â†“ æ¶ˆã—ã‚´ãƒ : é€šå¸¸Graphics (Shaderä¸ä½¿ç”¨)
PIXI.Graphics (æœ€çµ‚å‡ºåŠ›)
```

### âš ï¸ Perfect-Freehand ã®çŠ¶æ³
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: âœ… èª­ã¿è¾¼ã¿æ¸ˆã¿ (`libs/perfect-freehand-1.2.0.min.js`)
- **ä½¿ç”¨ç®‡æ‰€**: âœ… `gl-stroke-processor.js` ã§ä½¿ç”¨ä¸­
- **æ¥ç¶šçŠ¶æ³**: âŒ **stroke-renderer.js ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„**
- **å•é¡Œ**: stroke-renderer.js ã¯ç›´æ¥ PIXI.Graphics ã«æç”»ã—ã¦ãŠã‚Šã€ãƒãƒªã‚´ãƒ³åŒ–ã•ã‚Œã¦ã„ãªã„

### ğŸ” WebGL2/MSDF ãƒãƒªã‚´ãƒ³ãƒšãƒ³å®Ÿè£…çŠ¶æ³
- **WebGL2 Context**: âœ… åˆæœŸåŒ–æ¸ˆã¿ (`webgl2-drawing-layer.js`)
- **Perfect-Freehand â†’ Polygon**: âœ… å®Ÿè£…æ¸ˆã¿ (`gl-stroke-processor.js`)
- **Earcut ä¸‰è§’å½¢åˆ†å‰²**: âœ… å®Ÿè£…æ¸ˆã¿ (`earcut-triangulator.js`)
- **MSDF Pipeline**: âœ… å®Ÿè£…æ¸ˆã¿ (`gl-msdf-pipeline.js`)
- **æ¥ç¶š**: âŒ **stroke-renderer.js ãŒ WebGL2 ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„**

---

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€  & è¦ªå­é–¢ä¿‚

### ğŸ—ï¸ ã‚³ã‚¢åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[index.html] --> B[core-initializer.js]
    B --> C[core-engine.js]
    C --> D[core-runtime.js]
    
    C --> E[camera-system.js]
    C --> F[layer-system.js]
    C --> G[drawing-engine.js]
    C --> H[brush-core.js]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1e1
```

#### ğŸ“„ `index.html`
- **è²¬å‹™**: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿é †åºã®ç®¡ç†
- **å­ãƒ•ã‚¡ã‚¤ãƒ«**: ã™ã¹ã¦ã®JS
- **æ³¨æ„**: Perfect-Freehand ã¯ CDN ã§ã¯ãªããƒ­ãƒ¼ã‚«ãƒ« (`libs/`) ã‹ã‚‰èª­ã¿è¾¼ã¿

#### ğŸ“„ `core-initializer.js`
- **è²¬å‹™**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã‚·ãƒ¼ã‚±ãƒ³ã‚¹
- **è¦ªä¾å­˜**:
  - `PIXI` (CDN)
  - `core-engine.js` (CoreEngine)
  - `core-runtime.js` (CoreRuntime)
  - `ui-panels.js` (UIController)
- **å­ãƒ•ã‚¡ã‚¤ãƒ«**: ã™ã¹ã¦ã®ã‚·ã‚¹ãƒ†ãƒ 
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.CoreInitializer`
- **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
  - `initialize()` - ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–
  - `initializeWebGPU()` - WebGPUåˆæœŸåŒ– (æœªä½¿ç”¨)
  - `initializeLayerPanel()` - ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«åˆæœŸåŒ–

#### ğŸ“„ `core-engine.js` v8.32.0
- **è²¬å‹™**: ã‚·ã‚¹ãƒ†ãƒ çµ±åˆç®¡ç†ãƒ»ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£…
- **è¦ªä¾å­˜**:
  - `camera-system.js`
  - `layer-system.js`
  - `drawing-clipboard.js`
  - `brush-core.js`
  - `event-bus.js`
- **å­ãƒ•ã‚¡ã‚¤ãƒ«**: ã™ã¹ã¦ã®ã‚·ã‚¹ãƒ†ãƒ 
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.TegakiCore.CoreEngine`
- **ä¸»è¦ã‚¯ãƒ©ã‚¹**:
  - `CoreEngine` - ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³
  - `UnifiedKeyHandler` - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©
- **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
  - `initialize()` - ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
  - `initializeExportManager()` - ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆåˆæœŸåŒ–
  - `initializeAnimationSystem()` - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–

---

### ğŸ¨ æç”»ã‚·ã‚¹ãƒ†ãƒ ãƒ•ãƒ­ãƒ¼

```mermaid
graph LR
    A[drawing-engine.js] --> B[brush-core.js]
    B --> C[stroke-recorder.js]
    B --> D[stroke-renderer.js]
    D --> E[PIXI.Graphics]
    
    F[gl-stroke-processor.js] -.æœªæ¥ç¶š.-> D
    G[perfect-freehand] --> F
    
    style D fill:#ffcccc
    style F fill:#ccccff
```

#### ğŸ“„ `drawing-engine.js` (Phase 4)
- **è²¬å‹™**: åº§æ¨™å¤‰æ›ãƒ»PointerEventå‡¦ç†ãƒ»ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯åˆ¶å¾¡
- **è¦ªä¾å­˜**:
  - `brush-core.js` (BrushCore)
  - `pointer-handler.js` (PointerHandler)
  - `coordinate-system.js` (CoordinateSystem)
  - `camera-system.js` (CameraSystem)
  - `layer-system.js` (LayerSystem)
  - `event-bus.js` (EventBus)
- **å­ãƒ•ã‚¡ã‚¤ãƒ«**:
  - `core-engine.js` (åˆæœŸåŒ–å…ƒ)
  - `core-runtime.js` (APIçµŒç”±)
  - `fill-tool.js` (canvas:pointerdown ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­)
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.DrawingEngine`
- **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
  - `_handlePointerDown()` - ãƒã‚¤ãƒ³ã‚¿ãƒ¼é–‹å§‹
  - `_handlePointerMove()` - ãƒã‚¤ãƒ³ã‚¿ãƒ¼ç§»å‹•
  - `_handlePointerUp()` - ãƒã‚¤ãƒ³ã‚¿ãƒ¼çµ‚äº†
  - `_screenToLocal()` - åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
- **åº§æ¨™å¤‰æ›**: Screen â†’ Canvas â†’ World â†’ Local

#### ğŸ“„ `brush-core.js` (Phase 1-FIX)
- **è²¬å‹™**: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–‹å§‹/æ›´æ–°/å®Œäº†å‡¦ç†
- **è¦ªä¾å­˜**:
  - `event-bus.js`
  - `coordinate-system.js`
  - `pressure-handler.js` (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
  - `stroke-recorder.js`
  - `stroke-renderer.js`
  - `layer-system.js`
  - `brush-settings.js`
  - `fill-tool.js`
- **å­ãƒ•ã‚¡ã‚¤ãƒ«**: ãªã— (ãƒªãƒ¼ãƒ•ãƒãƒ¼ãƒ‰)
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.BrushCore` (Singleton)
- **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
  - `init()` - åˆæœŸåŒ–
  - `startStroke()` - ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–‹å§‹
  - `updateStroke()` - ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æ›´æ–°
  - `finalizeStroke()` - ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç¢ºå®š
  - `setMode(mode)` - ãƒ„ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆ (pen/eraser/fill)
  - `getMode()` - ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰å–å¾—
- **ä¿®æ­£å†…å®¹**: æ¶ˆã—ã‚´ãƒ ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ã‚’ä¿®æ­£

#### ğŸ“„ `stroke-recorder.js` (è­¦å‘Šãƒ­ã‚°å‰Šæ¸›ç‰ˆ)
- **è²¬å‹™**: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²å°‚ç”¨
- **è¦ªä¾å­˜**:
  - `pressure-handler.js` (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
  - `camera-system.js` (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
- **å­ãƒ•ã‚¡ã‚¤ãƒ«**: `brush-core.js`
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.StrokeRecorder`
- **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
  - `startStroke(localX, localY, rawPressure)` - è¨˜éŒ²é–‹å§‹
  - `addPoint(localX, localY, rawPressure)` - ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
  - `endStroke()` - è¨˜éŒ²çµ‚äº† â†’ strokeData è¿”å´
  - `getCurrentPoints()` - ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆå–å¾—
  - `isActive()` - è¨˜éŒ²ä¸­åˆ¤å®š
- **æ³¨æ„**: **åº§æ¨™å¤‰æ›ã¯ä¸€åˆ‡è¡Œã‚ãªã„** (å—ã‘å–ã£ãŸåº§æ¨™ã‚’ãã®ã¾ã¾ä¿å­˜)

#### ğŸ“„ `stroke-renderer.js` (Phase 1-FIX)
- **è²¬å‹™**: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®è¦–è¦šåŒ–ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æœ€çµ‚æç”»ï¼‰
- **è¦ªä¾å­˜**:
  - `PixiJS v8.13` (Graphics, Sprite, Mesh)
  - `webgpu-drawing-layer.js` âŒ (WebGPUçµ±åˆ - æœªä½¿ç”¨)
  - `webgpu-compute-sdf.js` âŒ (SDFç”Ÿæˆ - æœªä½¿ç”¨)
  - `webgpu-compute-msdf.js` âŒ (MSDFç”Ÿæˆ - æœªä½¿ç”¨)
  - `webgpu-texture-bridge.js` âŒ (ãƒ†ã‚¯ã‚¹ãƒãƒ£å¤‰æ› - æœªä½¿ç”¨)
  - `sdf-brush-shader.js` âŒ (çµ±åˆshader - æœªä½¿ç”¨)
  - `msdf-brush-shader.js` âŒ (MSDF shader - æœªä½¿ç”¨)
  - `brush-settings.js` (settingså–å¾—)
  - `curve-interpolator.js` âŒ (è£œé–“å‡¦ç† - æœªä½¿ç”¨)
- **å­ãƒ•ã‚¡ã‚¤ãƒ«**:
  - `brush-core.js` (ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”»)
  - `layer-system.js` (ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ )
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.StrokeRenderer`
- **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
  - `renderPreview()` - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  - `renderFinalStroke()` - æœ€çµ‚æç”»
  - `_renderEraserStroke()` - æ¶ˆã—ã‚´ãƒ å°‚ç”¨æç”» (Shaderä¸ä½¿ç”¨)
  - `_renderFinalStrokeMSDF()` âŒ - MSDFæç”» (æœªæ¥ç¶š)
  - `_renderFinalStrokeWebGPU()` âŒ - SDFæç”» (æœªæ¥ç¶š)
  - `_renderFinalStrokeLegacy()` - Legacyæç”» (å®Ÿéš›ã«ä½¿ç”¨)
- **å•é¡Œç‚¹**: 
  - âŒ **Perfect-Freehand ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„**
  - âŒ **WebGL2/MSDF ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒæœªæ¥ç¶š**
  - âŒ **ãƒãƒªã‚´ãƒ³åŒ–ã•ã‚Œã¦ã„ãªã„ (PIXI.Graphics ç›´æ¥æç”»)**

---

### ğŸ”§ WebGL2 ã‚·ã‚¹ãƒ†ãƒ  (æº–å‚™æ¸ˆã¿ãƒ»æœªæ¥ç¶š)

```mermaid
graph TD
    A[webgl2-drawing-layer.js] --> B[gl-stroke-processor.js]
    B --> C[gl-msdf-pipeline.js]
    B --> D[gl-texture-bridge.js]
    
    E[perfect-freehand] --> B
    F[earcut-triangulator.js] --> B
    
    style A fill:#ccffcc
    style B fill:#ccffcc
    style C fill:#ccffcc
    style D fill:#ccffcc
    style E fill:#ffffcc
    style F fill:#ffffcc
```

#### ğŸ“„ `webgl2-drawing-layer.js` (Phase 1 å®Œå…¨ä¿®æ­£ç‰ˆ)
- **è²¬å‹™**: WebGL2 contextåˆæœŸåŒ–ãƒ»ç®¡ç†
- **è¦ªä¾å­˜**: ãªã— (ãƒªãƒ¼ãƒ•ãƒãƒ¼ãƒ‰)
- **å­ãƒ•ã‚¡ã‚¤ãƒ«**:
  - `gl-stroke-processor.js`
  - `gl-msdf-pipeline.js`
  - `gl-texture-bridge.js`
  - `gl-mask-layer.js`
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: 
  - `window.WebGLContext` (ä¸»è¦)
  - `window.WebGL2DrawingLayer` (äº’æ›)
- **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
  - `initialize()` - WebGL2åˆæœŸåŒ–
  - `createShader()` - Shaderä½œæˆ
  - `createProgram()` - Programãƒªãƒ³ã‚¯
  - `createFBO()` - FBOç”Ÿæˆ
  - `createTexture()` - Textureç”Ÿæˆ
- **çŠ¶æ…‹**: âœ… åˆæœŸåŒ–æ¸ˆã¿ãƒ»å‹•ä½œç¢ºèªæ¸ˆã¿

#### ğŸ“„ `gl-stroke-processor.js` (Phase 4.0)
- **è²¬å‹™**: Perfect-Freehandå‡ºåŠ› â†’ GPUé ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ç”Ÿæˆ
- **è¦ªä¾å­˜**:
  - `libs/perfect-freehand-1.2.0.min.js` âœ…
  - `system/earcut-triangulator.js` âœ…
  - `config.js`
  - `webgl2-drawing-layer.js`
  - `camera-system.js`
- **å­ãƒ•ã‚¡ã‚¤ãƒ«**:
  - `brush-core.js` âŒ (å‘¼ã³å‡ºã—å…ƒ - æœªæ¥ç¶š)
  - `gl-msdf-pipeline.js` âŒ (ãƒãƒƒãƒ•ã‚¡å—ã‘å–ã‚Š - æœªæ¥ç¶š)
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.GLStrokeProcessor` (Singleton)
- **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
  - `initialize(gl)` - åˆæœŸåŒ–
  - `createPolygonVertexBuffer()` - ãƒãƒªã‚´ãƒ³é ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ç”Ÿæˆ
  - `createEdgeBuffer()` - ã‚¨ãƒƒã‚¸ãƒãƒƒãƒ•ã‚¡ç”Ÿæˆ (MSDFç”¨)
  - `calculateBounds()` - Boundsè¨ˆç®—
  - `uploadToGPU()` - GPUãƒãƒƒãƒ•ã‚¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- **çŠ¶æ…‹**: âœ… å®Ÿè£…æ¸ˆã¿ãƒ»ãƒ†ã‚¹ãƒˆæ¸ˆã¿ãƒ»**æœªæ¥ç¶š**
- **Phase 4.0æ”¹ä¿®å†…å®¹**:
  - ã‚«ãƒ¡ãƒ©ãƒ•ãƒ¬ãƒ¼ãƒ å¤–ã¸ã®æç”»ã‚’å®Œå…¨é˜²æ­¢
  - ãƒã‚¤ãƒ³ãƒˆåº§æ¨™ã®æ¤œè¨¼è¿½åŠ 
  - Boundsè¨ˆç®—ã®ç²¾åº¦å‘ä¸Š

#### ğŸ“„ `gl-msdf-pipeline.js`
- **è²¬å‹™**: MSDF (Multi-channel Signed Distance Field) ç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
- **è¦ªä¾å­˜**:
  - `webgl2-drawing-layer.js`
  - `gl-stroke-processor.js`
  - GLSLã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤
- **çŠ¶æ…‹**: âœ… å®Ÿè£…æ¸ˆã¿ãƒ»**æœªæ¥ç¶š**

#### ğŸ“„ `gl-texture-bridge.js`
- **è²¬å‹™**: WebGL2 Texture â†” PixiJS Texture ç›¸äº’å¤‰æ›
- **è¦ªä¾å­˜**:
  - `webgl2-drawing-layer.js`
  - `PixiJS v8`
- **çŠ¶æ…‹**: âœ… å®Ÿè£…æ¸ˆã¿ãƒ»**æœªæ¥ç¶š**

#### ğŸ“„ `earcut-triangulator.js`
- **è²¬å‹™**: Earcut ä¸‰è§’å½¢åˆ†å‰²å®Ÿè¡Œ
- **è¦ªä¾å­˜**: Earcut.js (CDN?)
- **å­ãƒ•ã‚¡ã‚¤ãƒ«**: `gl-stroke-processor.js`
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.EarcutTriangulator`
- **çŠ¶æ…‹**: âœ… å®Ÿè£…æ¸ˆã¿ãƒ»å‹•ä½œç¢ºèªæ¸ˆã¿

#### ğŸ“„ `libs/perfect-freehand-1.2.0.min.js`
- **è²¬å‹™**: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆ â†’ ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ãƒãƒªã‚´ãƒ³å¤‰æ›
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.PerfectFreehand`
- **ä½¿ç”¨ç®‡æ‰€**: `gl-stroke-processor.js` ã® `_executePerfectFreehand()`
- **çŠ¶æ…‹**: âœ… èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒ»å‹•ä½œç¢ºèªæ¸ˆã¿

---

### ğŸ“Š åº§æ¨™ç³»ã‚·ã‚¹ãƒ†ãƒ 

#### ğŸ“„ `coordinate-system.js`
- **è²¬å‹™**: åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (Screen/Canvas/World/Local)
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.CoordinateSystem`
- **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
  - `screenClientToCanvas()` - Screen â†’ Canvas
  - `canvasToWorld()` - Canvas â†’ World
  - `worldToLocal()` - World â†’ Local
- **æ³¨æ„**: **PixiJS ã® toLocal()/toGlobal() ã¯ä½¿ç”¨ç¦æ­¢**

#### ğŸ“„ `camera-system.js`
- **è²¬å‹™**: worldContainer transform, ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.cameraSystem`, `window.TegakiCameraSystem`

#### ğŸ“„ `layer-system.js`
- **è²¬å‹™**: ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.layerManager`, `window.TegakiLayerSystem`

---

## ğŸ”€ ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼

### ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆ
- `drawing:stroke-started` - ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–‹å§‹
- `drawing:stroke-completed` - ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å®Œäº†
- `layer:path-added` - ãƒ‘ã‚¹è¿½åŠ 
- `thumbnail:layer-updated` - ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
- `canvas:pointerdown` - ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªãƒƒã‚¯ (fillç”¨)

### EventBus
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«**: `window.TegakiEventBus`, `window.eventBus`
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `system/event-bus.js`

---

## âŒ æœªä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãŒã€**ç¾åœ¨ã®æç”»ãƒ•ãƒ­ãƒ¼ã§ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„**:

### WebGL2é–¢é€£ (æº–å‚™æ¸ˆã¿ãƒ»æœªæ¥ç¶š)
- âœ… `webgl2-drawing-layer.js` - åˆæœŸåŒ–æ¸ˆã¿ã ãŒæœªä½¿ç”¨
- âœ… `gl-stroke-processor.js` - Perfect-Freehandå®Ÿè£…æ¸ˆã¿ã ãŒæœªæ¥ç¶š
- âœ… `gl-msdf-pipeline.js` - MSDFå®Ÿè£…æ¸ˆã¿ã ãŒæœªæ¥ç¶š
- âœ… `gl-texture-bridge.js` - Texture Bridgeå®Ÿè£…æ¸ˆã¿ã ãŒæœªæ¥ç¶š
- âœ… `gl-mask-layer.js` - ãƒã‚¹ã‚¯å‡¦ç†å®Ÿè£…æ¸ˆã¿ã ãŒæœªæ¥ç¶š
- âœ… `earcut-triangulator.js` - ä¸‰è§’å½¢åˆ†å‰²å®Ÿè£…æ¸ˆã¿ã ãŒæœªæ¥ç¶š

### Shaderé–¢é€£ (æº–å‚™æ¸ˆã¿ãƒ»æœªæ¥ç¶š)
- âœ… `sdf-brush-shader.js` - SDF Shaderå®Ÿè£…æ¸ˆã¿ã ãŒæœªä½¿ç”¨
- ğŸ” `system/drawing/webgl2/shaders/*.glsl` - GLSLãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ (è¦ç¢ºèª)

### ãã®ä»–
- âŒ `curve-interpolator.js` - è£œé–“å‡¦ç† (stroke-renderer.js ã§å‚ç…§ã•ã‚Œã‚‹ãŒæœªå®Ÿè£…?)

---

## ğŸš¨ ä¸»è¦ãªå•é¡Œç‚¹

### 1. âŒ Perfect-Freehand æœªæ¥ç¶š
**ç¾çŠ¶**: `stroke-renderer.js` ãŒç›´æ¥ `PIXI.Graphics` ã«æç”»
**å•é¡Œ**: ãƒãƒªã‚´ãƒ³åŒ–ã•ã‚Œã¦ã„ãªã„ â†’ WebGL2/MSDF ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒä½¿ãˆãªã„

### 2. âŒ WebGL2 ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æœªæ¥ç¶š
**ç¾çŠ¶**: `gl-stroke-processor.js` ãŒå­¤ç«‹ã—ã¦ã„ã‚‹
**å•é¡Œ**: 
- `stroke-renderer.js` ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„
- `renderFinalStroke()` ãŒ Legacyæç”»ã®ã¿

### 3. âš ï¸ åº§æ¨™å¤‰æ›ã®è²¬å‹™æ··åœ¨
**ç¾çŠ¶**: `drawing-engine.js` ã§åº§æ¨™å¤‰æ›å®Œäº†å¾Œã€`stroke-recorder.js` ã«æ¸¡ã™
**å•é¡Œ**: ç¾çŠ¶ã¯å•é¡Œãªã„ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ˜è¨˜ãŒå¿…è¦

### 4. âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«åã®ä¸ä¸€è‡´
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `webgpu-*` ã¨è¨˜è¼‰
**å®Ÿéš›**: `webgl2-*` ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨
**å½±éŸ¿**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨å®Ÿè£…ã®ä¹–é›¢

---

## âœ… æ­£å¸¸å‹•ä½œã—ã¦ã„ã‚‹ã‚‚ã®

### æç”»åŸºç›¤
- âœ… PointerEventå‡¦ç† (`drawing-engine.js`)
- âœ… åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (`coordinate-system.js`)
- âœ… ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ² (`stroke-recorder.js`)
- âœ… ãƒšãƒ³/æ¶ˆã—ã‚´ãƒ åˆ‡ã‚Šæ›¿ãˆ (`brush-core.js`)
- âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç† (`layer-system.js`)
- âœ… ã‚«ãƒ¡ãƒ©ç®¡ç† (`camera-system.js`)

### UI
- âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ« (`layer-panel-renderer.js`)
- âœ… ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ© (`keyboard-handler.js`)
- âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç®¡ç† (`popup-manager.js`)

### ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- âœ… PNG/APNG/GIF/WebP/MP4 (`exporters/*.js`)

---

## ğŸ”§ WebGL2ãƒ»MSDFãƒ»ãƒãƒªã‚´ãƒ³ãƒšãƒ³å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: stroke-renderer.js æ”¹ä¿®
**ç›®çš„**: Perfect-Freehand â†’ WebGL2 ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¸ã®æ¥ç¶š

**å¤‰æ›´ç®‡æ‰€**: `stroke-renderer.js` ã® `renderFinalStroke()`

**å®Ÿè£…æ‰‹é †**:
```javascript
async renderFinalStroke(strokeData, providedSettings = null, targetGraphics = null) {
  const settings = this._getSettings(providedSettings);
  const mode = this._getCurrentMode(settings);
  
  // æ¶ˆã—ã‚´ãƒ ã¯å¾“æ¥é€šã‚Š
  if (mode === 'eraser') {
    return this._renderEraserStroke(strokeData, settings);
  }
  
  // ğŸ†• Perfect-Freehand â†’ WebGL2 ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
  if (window.GLStrokeProcessor && window.GLStrokeProcessor.isInitialized()) {
    try {
      // 1. Perfect-Freehand ã§ãƒãƒªã‚´ãƒ³åŒ–
      const vertexBuffer = window.GLStrokeProcessor.createPolygonVertexBuffer(
        strokeData.points,
        settings.size
      );
      
      if (vertexBuffer) {
        // 2. WebGL2 ã§æç”»
        return this._renderWithWebGL2(vertexBuffer, settings);
      }
    } catch (error) {
      console.warn('[StrokeRenderer] WebGL2 failed, fallback to legacy:', error);
    }
  }
  
  // Fallback: Legacyæç”»
  return this._renderFinalStrokeLegacy(strokeData, settings, mode, targetGraphics);
}

_renderWithWebGL2(vertexBuffer, settings) {
  // TODO: WebGL2 Meshç”Ÿæˆ
  // TODO: Pixi.Mesh ã§ãƒ©ãƒƒãƒ—
  // TODO: Shaderé©ç”¨
  return mesh;
}
```

### Phase 2: WebGL2 Mesh ç”Ÿæˆ
**ç›®çš„**: `gl-stroke-processor.js` ã®é ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ã‚’ Pixi.Mesh ã«å¤‰æ›

**å®Ÿè£…ç®‡æ‰€**: `stroke-renderer.js` ã® `_renderWithWebGL2()`

**æ‰‹é †**:
1. `vertexBuffer.buffer` (Float32Array) ã‚’ Pixi.Geometry ã«å¤‰æ›
2. Pixi.Mesh ã‚’ç”Ÿæˆ
3. Shaderé©ç”¨ (SDF/MSDF)
4. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿½åŠ 

### Phase 3: MSDF Shader çµ±åˆ
**ç›®çš„**: MSDF Pipeline ã‚’æœ‰åŠ¹åŒ–

**å®Ÿè£…ç®‡æ‰€**: `gl-msdf-pipeline.js` ã®çµ±åˆ

**æ‰‹é †**:
1. `gl-msdf-pipeline.js` åˆæœŸåŒ–
2. `stroke-renderer.js` ã‹ã‚‰å‘¼ã³å‡ºã—
3. MSDF Textureç”Ÿæˆ
4. Shaderé©ç”¨

### Phase 4: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
**ç›®çš„**: ä¸è¦ãªã‚³ãƒ¼ãƒ‰å‰Šé™¤ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

**ã‚¿ã‚¹ã‚¯**:
- âŒ Legacyæç”»ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
- âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–° (webgpu â†’ webgl2)
- âœ… æœªä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´ç†

---

## ğŸ“ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### ğŸ”¥ ç·Šæ€¥åº¦: é«˜
1. **stroke-renderer.js æ”¹ä¿®** - Perfect-Freehand æ¥ç¶š
2. **WebGL2 ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ¥ç¶š** - gl-stroke-processor.js çµ±åˆ
3. **Pixi.Mesh ç”Ÿæˆå®Ÿè£…** - WebGL2 é ‚ç‚¹ãƒãƒƒãƒ•ã‚¡ â†’ Mesh

### âš¡ ç·Šæ€¥åº¦: ä¸­
4. **MSDF Pipeline çµ±åˆ** - gl-msdf-pipeline.js æ¥ç¶š
5. **Shader çµ±åˆ** - SDF/MSDF Shader é©ç”¨
6. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°** - webgpu â†’ webgl2 ä¿®æ­£

### ğŸ§¹ ç·Šæ€¥åº¦: ä½
7. **æœªä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«æ•´ç†** - curve-interpolator.js ç­‰
8. **Legacyæç”»å‰Šé™¤** - ã‚ªãƒ—ã‚·ãƒ§ãƒ³ (fallback ã¨ã—ã¦æ®‹ã™?)
9. **ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ** - å„ãƒ•ã‚¡ã‚¤ãƒ«ã®è²¬å‹™æ˜è¨˜

---

## ğŸ¯ çµè«–

### ç¾çŠ¶
- âœ… **æç”»åŸºç›¤ã¯å®Œç’§ã«å‹•ä½œ**
- âœ… **WebGL2/Perfect-Freehand/MSDF ã¯å®Ÿè£…æ¸ˆã¿**
- âŒ **æ¥ç¶šãŒæœªå®Œäº†** (stroke-renderer.js ãŒå­¤ç«‹)

### æœ€å„ªå…ˆã‚¿ã‚¹ã‚¯
**`stroke-renderer.js` ã® `renderFinalStroke()` ã‚’æ”¹ä¿®ã—ã€`gl-stroke-processor.js` ã‚’å‘¼ã³å‡ºã™ã“ã¨ã€‚**

ã“ã‚Œã«ã‚ˆã‚Š:
- Perfect-Freehand ã«ã‚ˆã‚‹ãƒãƒªã‚´ãƒ³åŒ–
- WebGL2 ã«ã‚ˆã‚‹é«˜é€Ÿæç”»
- MSDF ã«ã‚ˆã‚‹é«˜å“è³ªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

ãŒä¸€æ°—ã«å®Ÿç¾ã—ã¾ã™ã€‚

### ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®å¿…è¦æ€§
**ç¾æ™‚ç‚¹ã§ã¯ä¸è¦**ã§ã™ã€‚ã¾ãš Phase 1-3 ã‚’å®Œäº†ã•ã›ã€å‹•ä½œç¢ºèªå¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’æ¤œè¨ã™ã¹ãã§ã™ã€‚

---

## ğŸ“š å‚è€ƒè³‡æ–™

### åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
```
PointerEvent.clientX/Y
  â†“ screenClientToCanvas() [DPIè£œæ­£]
  â†“ canvasToWorld() [worldContaineré€†è¡Œåˆ—]
  â†“ worldToLocal() [æ‰‹å‹•é€†ç®—ãƒ»è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»]
Localåº§æ¨™ç¢ºå®š
  â†“ strokeRecorderè¨˜éŒ²
```

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- `window.CoordinateSystem` - åº§æ¨™å¤‰æ›
- `window.cameraSystem` - ã‚«ãƒ¡ãƒ©ç®¡ç†
- `window.layerManager` - ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
- `window.WebGLContext` - WebGL2ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ (Singleton)
- `window.GLStrokeProcessor` - Perfect-Freehandå‡¦ç† (Singleton)
- `window.BrushCore` - ãƒ–ãƒ©ã‚·ã‚³ã‚¢ (Singleton)

### ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰
```javascript
// WebGL2çµ±è¨ˆ
TegakiDebug.glStroke.enable()  // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–
TegakiDebug.glStroke.stats()   // çµ±è¨ˆè¡¨ç¤º
TegakiDebug.glStroke.reset()   // çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
```

---

**ä½œæˆæ—¥**: 2025-01-XX  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.0.0  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ“ è¦å®Ÿè£… (Phase 1-3)