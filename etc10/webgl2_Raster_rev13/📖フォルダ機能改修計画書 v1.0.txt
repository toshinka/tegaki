
================================================================================
ãƒ•ã‚©ãƒ«ãƒ€æ©Ÿèƒ½æ”¹ä¿®è¨ˆç”»æ›¸ v1.0
================================================================================

ã€ç¾çŠ¶åˆ†ææ—¥æ™‚ã€‘2025å¹´ç‰ˆ
ã€å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã€‘WebGL2 MSDFç‰ˆ ãŠçµµã‹ããƒ„ãƒ¼ãƒ« (webgl2_rev29)

================================================================================
â–  ç¾çŠ¶ã®å•é¡Œç‚¹
================================================================================

âš ï¸ å•é¡Œ1: UIãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ä¸å…¨
ç¾è±¡: ãƒ•ã‚©ãƒ«ãƒ€è¿½åŠ ãƒœã‚¿ãƒ³(#add-folder-btn)æŠ¼ä¸‹æ™‚ã«ğŸš«ãƒãƒ¼ã‚¯è¡¨ç¤ºã€Œæº–å‚™ä¸­ã€è¡¨ç¤º
åŸå› : ui-panels.js ã§createFolder()ã¯æ­£å¸¸ã«å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ãŒã€ä½•ã‚‰ã‹ã®ç†ç”±ã§å®Ÿè¡Œå¤±æ•—

âš ï¸ å•é¡Œ2: folder-open SVGã‚¢ã‚¤ã‚³ãƒ³æœªç™»éŒ²
ç¾è±¡: layer-panel-renderer.js ã® _createFolderEar() ã§folder-openã‚¢ã‚¤ã‚³ãƒ³æœªä½¿ç”¨
åŸå› : æ—¢å­˜å®Ÿè£…ã§ã¯é–‰ã˜ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ä½¿ç”¨ã€é–‹ã„ãŸçŠ¶æ…‹ã®è¦–è¦šçš„å·®åˆ¥åŒ–ãŒä¸è¶³

âš ï¸ å•é¡Œ3: å®Ÿè£…ã®åˆ†æ•£
ç¾è±¡: ãƒ•ã‚©ãƒ«ãƒ€æ©Ÿèƒ½ãŒlayer-system.js / layer-panel-renderer.js / data-models.js ã«åˆ†æ•£
ãƒªã‚¹ã‚¯: ä»Šå¾Œã®ä¿å®ˆæ€§ãƒ»å¯èª­æ€§ã®ä½ä¸‹

================================================================================
â–  ãƒ•ã‚¡ã‚¤ãƒ«é–“ä¾å­˜é–¢ä¿‚ãƒãƒƒãƒ—
================================================================================

ğŸ“ ã€æœ€ä¸Šä½ã€‘data-models.js
  â”œâ”€ LayerModel (isFolder / folderExpanded / parentId / childIds)
  â””â”€ âœ… ãƒ•ã‚©ãƒ«ãƒ€å±æ€§ã¯å®Ÿè£…æ¸ˆã¿ãƒ»å‹•ä½œç¢ºèªæ¸ˆã¿

ğŸ“ ã€ä¸­æ ¸ã€‘layer-system.js
  â”œâ”€ ä¾å­˜: data-models.js / event-bus.js / history.js / coordinate-system.js
  â”œâ”€ ãƒ¡ã‚½ãƒƒãƒ‰:
  â”‚   â”œâ”€ createFolder(name) âœ…å®Ÿè£…æ¸ˆã¿
  â”‚   â”œâ”€ addLayerToFolder(layerId, folderId) âœ…å®Ÿè£…æ¸ˆã¿
  â”‚   â”œâ”€ removeLayerFromFolder(layerId) âœ…å®Ÿè£…æ¸ˆã¿
  â”‚   â”œâ”€ toggleFolderExpand(folderId) âœ…å®Ÿè£…æ¸ˆã¿
  â”‚   â”œâ”€ getVisibleLayers() âœ…å®Ÿè£…æ¸ˆã¿
  â”‚   â””â”€ getFolderChildren(folderId) âœ…å®Ÿè£…æ¸ˆã¿
  â””â”€ âš ï¸ createFolder() å†…ã§Historyç™»éŒ²ã¯ã‚ã‚‹ãŒå®Ÿè¡Œå¤±æ•—ã®åŸå› ä¸æ˜

ğŸ“„ ã€UIå±¤ã€‘layer-panel-renderer.js
  â”œâ”€ ä¾å­˜: layer-system.js / thumbnail-system.js / event-bus.js / config.js
  â”œâ”€ ãƒ¡ã‚½ãƒƒãƒ‰:
  â”‚   â”œâ”€ createFolderElement() âœ…å®Ÿè£…æ¸ˆã¿
  â”‚   â”œâ”€ _createFolderEar() âœ…å®Ÿè£…æ¸ˆã¿ï¼ˆfolder-openæœªä½¿ç”¨ï¼‰
  â”‚   â”œâ”€ _createFolderToggleIcon() âœ…å®Ÿè£…æ¸ˆã¿
  â”‚   â”œâ”€ createFolderThumbnail() âœ…å®Ÿè£…æ¸ˆã¿
  â”‚   â””â”€ _calculateIndentLevel() âœ…å®Ÿè£…æ¸ˆã¿
  â””â”€ âš ï¸ folder-openã‚¢ã‚¤ã‚³ãƒ³æœªé©ç”¨

ğŸ“„ ã€UIå±¤ã€‘ui-panels.js
  â”œâ”€ ä¾å­˜: core-runtime.js / popup-manager.js / event-bus.js / layer-system.js
  â”œâ”€ ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†:
  â”‚   â””â”€ #add-folder-btn ã‚¯ãƒªãƒƒã‚¯æ™‚ â†’ layerSystem.createFolder() å‘¼ã³å‡ºã—
  â””â”€ âœ… æ¥ç¶šã¯æ­£å¸¸ï¼ˆv8.13.16ã§ç¢ºèªæ¸ˆã¿ï¼‰

================================================================================
â–  ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼
================================================================================

ğŸ”€ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ•ãƒ­ãƒ¼
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ #add-folder-btn ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ui-panels.js ã® setupEventDelegation() ãŒã‚¤ãƒ™ãƒ³ãƒˆæ•æ‰
3. layerSystem.createFolder() å‘¼ã³å‡ºã—
4. layer-system.js ã§LayerModelç”Ÿæˆ + Historyç™»éŒ²
5. âš ï¸ ã“ã“ã§å®Ÿè¡Œå¤±æ•—ï¼ˆåŸå› ä¸æ˜ï¼‰
6. eventBus.emit('folder:created') ãŒç™ºç«ã•ã‚Œãªã„
7. layer-panel-renderer.js ãŒUIæ›´æ–°ã‚’å—ã‘å–ã‚Œãªã„

ğŸ”€ ãƒ•ã‚©ãƒ«ãƒ€é–‹é–‰ãƒ•ãƒ­ãƒ¼
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ«ãƒ€ãƒˆã‚°ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. layer-panel-renderer.js ã® _createFolderToggleIcon() ãŒã‚¤ãƒ™ãƒ³ãƒˆæ•æ‰
3. layerSystem.toggleFolderExpand(folderId) å‘¼ã³å‡ºã—
4. layer-system.js ã§folderExpandedã‚’åè»¢
5. eventBus.emit('folder:toggled') ç™ºç«
6. layer-panel-renderer.js ãŒrequestUpdate() çµŒç”±ã§UIå†æç”»
7. âœ… ã“ã®ãƒ•ãƒ­ãƒ¼ã¯æ­£å¸¸å‹•ä½œã™ã‚‹ã¨æ¨æ¸¬

================================================================================
â–  æ”¹ä¿®è¨ˆç”»
================================================================================

ã€Phase 1ã€‘ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°ãƒ»åŸå› ç‰¹å®š
å„ªå…ˆåº¦: â˜…â˜…â˜…â˜…â˜…
å†…å®¹:
- layer-system.js createFolder() ã«console.logã‚’è¿½åŠ ã—å®Ÿè¡ŒçŠ¶æ³ã‚’ç¢ºèª
- Historyç™»éŒ²éƒ¨åˆ†ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
- window.History._manager.isApplying ã®çŠ¶æ…‹ç¢ºèª
- currentFrameContainer.addChild(folder) ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª
å®Ÿè£…ç®‡æ‰€: layer-system.js 271-314è¡Œç›®

ã€Phase 2ã€‘folder-openã‚¢ã‚¤ã‚³ãƒ³é©ç”¨
å„ªå…ˆåº¦: â˜…â˜…â˜…â˜…â˜†
å†…å®¹:
- layer-panel-renderer.js _createFolderEar() ã‚’æ”¹ä¿®
- isExpandedçŠ¶æ…‹ã«å¿œã˜ã¦folder / folder-open SVGã‚’åˆ‡ã‚Šæ›¿ãˆ
- æ—¢ã«æä¾›ã•ã‚ŒãŸSVGã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
å®Ÿè£…ç®‡æ‰€: layer-panel-renderer.js 183-210è¡Œç›®

ã€Phase 3ã€‘ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
å„ªå…ˆåº¦: â˜…â˜…â˜…â˜†â˜†
å†…å®¹:
- createFolder() ã«try-catchã‚’è¿½åŠ 
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«eventBus.emit('error:folder-create-failed') ã‚’ç™ºç«
- UIå´ã§ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
å®Ÿè£…ç®‡æ‰€: layer-system.js createFolder() å…¨ä½“

ã€Phase 4ã€‘çµ±åˆãƒ†ã‚¹ãƒˆ
å„ªå…ˆåº¦: â˜…â˜…â˜…â˜…â˜†
å†…å®¹:
- ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ»å‰Šé™¤ãƒ»é–‹é–‰ãƒ»ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ãƒ»å–ã‚Šå‡ºã—ã®ãƒ•ãƒ«ãƒ•ãƒ­ãƒ¼ç¢ºèª
- Historyæ©Ÿèƒ½ï¼ˆUndo/Redoï¼‰ã¨ã®é€£æºç¢ºèª
- ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã®å‹•ä½œç¢ºèª
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã¨ã®äº’æ›æ€§ç¢ºèª

================================================================================
â–  æ”¹ä¿®æ‰‹é †è©³ç´°
================================================================================

ã€æ‰‹é †1ã€‘layer-system.js ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
```
createFolder(name) å…ˆé ­ã«è¿½åŠ :
console.log('[LayerSystem] createFolder() called, name:', name);
console.log('[LayerSystem] currentFrameContainer:', this.currentFrameContainer);
console.log('[LayerSystem] History manager state:', window.History?._manager?.isApplying);
```

ã€æ‰‹é †2ã€‘folder-open SVGé©ç”¨
layer-panel-renderer.js _createFolderEar() æ”¹ä¿®:
- æ—¢å­˜ã®æ¡ä»¶åˆ†å²ã‚’ç¶­æŒ
- isExpanded===true ã®å ´åˆã«folder-open SVG
- isExpanded===false ã®å ´åˆã«æ—¢å­˜folder SVG
- stroke="#800000" stroke-width="1.5" ã‚’çµ±ä¸€

ã€æ‰‹é †3ã€‘ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
layer-system.js createFolder() å…¨ä½“ã‚’try-catchã§å›²ã‚€:
```
try {
  // æ—¢å­˜å‡¦ç†
} catch (error) {
  console.error('[LayerSystem] createFolder() failed:', error);
  if (this.eventBus) {
    this.eventBus.emit('error:folder-create-failed', { error: error.message });
  }
  return null;
}
```

================================================================================
â–  äºˆæƒ³ã•ã‚Œã‚‹å•é¡Œã¨å¯¾ç­–
================================================================================

âš ï¸ å•é¡ŒA: Historyç™»éŒ²æ™‚ã®structuredCloneå¤±æ•—
åŸå› : PIXI.Containerã¯ã‚¯ãƒ­ãƒ¼ãƒ³ä¸å¯
å¯¾ç­–: folderModel.toJSON() ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¾Œã«Historyç™»éŒ²

âš ï¸ å•é¡ŒB: worldContainerã¸ã®è¦ªå­é–¢ä¿‚æœªç¢ºç«‹
åŸå› : currentFrameContainerãŒworldContainerã®å­ã«ãªã£ã¦ã„ãªã„
å¯¾ç­–: setCameraSystem() å†…ã§è¦ªå­é–¢ä¿‚ã‚’å†ç¢ºèª

âš ï¸ å•é¡ŒC: ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤æ™‚ã®å­ãƒ¬ã‚¤ãƒ¤ãƒ¼å‡¦ç†
ç¾çŠ¶: deleteLayer() ã§ãƒ•ã‚©ãƒ«ãƒ€å†…ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚å‰Šé™¤ã—ã¦ã„ã‚‹ãŒã€Undoæ™‚ã®å¾©å…ƒãŒä¸å®Œå…¨
å¯¾ç­–: å‰Šé™¤æ™‚ã«å­ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®parentIdã‚’ä¿å­˜ã—ã€Undoæ™‚ã«å¾©å…ƒ

================================================================================
â–  å®Ÿè£…å„ªå…ˆé †ä½ã¾ã¨ã‚
================================================================================

1. ã€æœ€å„ªå…ˆã€‘layer-system.js ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ  â†’ åŸå› ç‰¹å®š
2. ã€é«˜ã€‘createFolder() ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ 
3. ã€é«˜ã€‘folder-openã‚¢ã‚¤ã‚³ãƒ³é©ç”¨
4. ã€ä¸­ã€‘Historyé€£æºã®å®Œå…¨æ€§ç¢ºèª
5. ã€ä½ã€‘ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤æ™‚ã®Undoã®å®Œå…¨æ€§å‘ä¸Š

================================================================================
â–  ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
================================================================================

â–¡ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ•ã‚©ãƒ«ãƒ€ãŒç”Ÿæˆã•ã‚Œã‚‹
â–¡ ãƒ•ã‚©ãƒ«ãƒ€åãŒã€Œãƒ•ã‚©ãƒ«ãƒ€1ã€ã€Œãƒ•ã‚©ãƒ«ãƒ€2ã€ã¨è‡ªå‹•æ¡ç•ªã•ã‚Œã‚‹
â–¡ ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã§ãã‚‹
â–¡ ãƒ•ã‚©ãƒ«ãƒ€ãƒˆã‚°ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã§é–‹é–‰ã§ãã‚‹
â–¡ é–‹é–‰æ™‚ã«folder/folder-openã‚¢ã‚¤ã‚³ãƒ³ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹
â–¡ ãƒ•ã‚©ãƒ«ãƒ€ã«è€³éƒ¨åˆ†ãŒè¡¨ç¤ºã•ã‚Œã‚‹
â–¡ ãƒ•ã‚©ãƒ«ãƒ€å†…ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ãã‚‹
â–¡ ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰å–ã‚Šå‡ºã—ã§ãã‚‹
â–¡ é–‰ã˜ãŸãƒ•ã‚©ãƒ«ãƒ€å†…ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯éè¡¨ç¤ºã«ãªã‚‹
â–¡ ãƒ•ã‚©ãƒ«ãƒ€ã‚µãƒ ãƒã‚¤ãƒ«ãŒå­ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæˆã§ç”Ÿæˆã•ã‚Œã‚‹
â–¡ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ»å‰Šé™¤ã‚’Undo/Redoã§ãã‚‹
â–¡ ãƒ•ã‚©ãƒ«ãƒ€é–‹é–‰ã‚’Undo/Redoã§ãã‚‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
â–¡ ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤æ™‚ã«å­ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚å‰Šé™¤ã•ã‚Œã‚‹
â–¡ ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤Undoæ™‚ã«å­ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚å¾©å…ƒã•ã‚Œã‚‹

================================================================================
â–  ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
================================================================================

âœ… DRYåŸå‰‡: data-models.js ã§çµ±ä¸€ãƒ¢ãƒ‡ãƒ«ç®¡ç†ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’åŒºåˆ¥ã›ãšï¼‰
âœ… SOLIDåŸå‰‡: layer-system.js ãŒè²¬å‹™ã‚’æŒã¡ã€UIã¯æç”»ã®ã¿
âœ… å‘½åè¦å‰‡: isFolder / folderExpanded / parentId / childIds ã§çµ±ä¸€
âœ… ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•: EventBusã§ç–çµåˆã‚’ç¶­æŒ
âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ç¾çŠ¶ä¸è¶³ã€Phase 3ã§æ”¹å–„äºˆå®š
âš ï¸ äºŒé‡å®Ÿè£…: ç¾æ™‚ç‚¹ã§ã¯ç¢ºèªã•ã‚Œã¦ã„ãªã„ãŒã€ä»Šå¾Œã®æ³¨æ„äº‹é …

================================================================================
â–  ä»Šå¾Œã®æ‹¡å¼µäºˆå®š
================================================================================

ã€v2.0ã€‘ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ã®ãƒ•ã‚©ãƒ«ãƒ€éšå±¤æ“ä½œ
ã€v2.1ã€‘ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒã‚¹ãƒˆï¼ˆãƒ•ã‚©ãƒ«ãƒ€å†…ãƒ•ã‚©ãƒ«ãƒ€ï¼‰
ã€v2.2ã€‘ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ã®ãƒ–ãƒ¬ãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰ãƒ»ä¸é€æ˜åº¦
ã€v2.3ã€‘ãƒ•ã‚©ãƒ«ãƒ€å˜ä½ã§ã®å¤‰å½¢ãƒ»ç§»å‹•
ã€v2.4ã€‘ãƒ•ã‚©ãƒ«ãƒ€ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾å¿œ

================================================================================
æ”¹ä¿®è¨ˆç”»æ›¸çµ‚ã‚ã‚Š
================================================================================