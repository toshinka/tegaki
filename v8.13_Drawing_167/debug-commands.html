<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tegaki ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰é›†</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        h2 {
            color: #4ec9b0;
            margin-top: 0;
            border-bottom: 1px solid #3e3e42;
            padding-bottom: 10px;
        }
        .command {
            background: #1e1e1e;
            border: 1px solid #4ec9b0;
            border-radius: 3px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .command:hover {
            background: #2d2d30;
            border-color: #6ec9b0;
        }
        .command-title {
            color: #dcdcaa;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .command-code {
            color: #ce9178;
            font-size: 12px;
        }
        .output {
            background: #1e1e1e;
            border: 1px solid #007acc;
            border-radius: 3px;
            padding: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 11px;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
        }
        button:hover {
            background: #1177bb;
        }
        .warning {
            color: #ff6b6b;
            font-weight: bold;
        }
        .success {
            color: #51cf66;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Tegaki ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰é›†</h1>
    
    <div class="section">
        <h2>ğŸ“Š å…¨ä½“çŠ¶æ³ã®è¨ºæ–­</h2>
        <button onclick="runFullDiagnostics()">ğŸš€ å®Œå…¨è¨ºæ–­ã‚’å®Ÿè¡Œ</button>
        <div id="full-output" class="output" style="display:none;"></div>
    </div>

    <div class="section">
        <h2>ğŸ“œ Historyï¼ˆã‚¢ãƒ³ãƒ‰ã‚¥/ãƒªãƒ‰ã‚¥ï¼‰</h2>
        <div class="command" onclick="runCommand('debugHistory')">
            <div class="command-title">1. HistoryçŠ¶æ…‹ç¢ºèª</div>
            <div class="command-code">debugHistory()</div>
        </div>
        <div class="command" onclick="runCommand('checkHistoryStack')">
            <div class="command-title">2. Historyã‚¹ã‚¿ãƒƒã‚¯è©³ç´°</div>
            <div class="command-code">window.History.getStack()</div>
        </div>
        <div class="command" onclick="runCommand('testUndo')">
            <div class="command-title">3. ã‚¢ãƒ³ãƒ‰ã‚¥ãƒ†ã‚¹ãƒˆï¼ˆç›´æ¥å®Ÿè¡Œï¼‰</div>
            <div class="command-code">window.History.undo()</div>
        </div>
        <div id="history-output" class="output" style="display:none;"></div>
    </div>

    <div class="section">
        <h2>ğŸ–¼ï¸ ã‚µãƒ ãƒã‚¤ãƒ«</h2>
        <div class="command" onclick="runCommand('debugThumbnails')">
            <div class="command-title">1. ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°çŠ¶æ…‹</div>
            <div class="command-code">debugThumbnails()</div>
        </div>
        <div class="command" onclick="runCommand('checkThumbnailSizes')">
            <div class="command-title">2. ã‚µãƒ ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª</div>
            <div class="command-code">å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚µãƒ ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’æ¸¬å®š</div>
        </div>
        <div class="command" onclick="runCommand('checkBackgroundThumbnail')">
            <div class="command-title">3. èƒŒæ™¯ã‚µãƒ ãƒã‚¤ãƒ«è©³ç´°</div>
            <div class="command-code">èƒŒæ™¯ã‚µãƒ ãƒã‚¤ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è§£æ</div>
        </div>
        <div id="thumbnail-output" class="output" style="display:none;"></div>
    </div>

    <div class="section">
        <h2>ğŸ“ ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>
        <div class="command" onclick="runCommand('checkLayers')">
            <div class="command-title">1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§</div>
            <div class="command-code">å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª</div>
        </div>
        <div class="command" onclick="runCommand('checkActiveLayer')">
            <div class="command-title">2. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼è©³ç´°</div>
            <div class="command-code">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ‘ã‚¹æ•°ãƒ»å¤‰å½¢çŠ¶æ…‹</div>
        </div>
        <div id="layer-output" class="output" style="display:none;"></div>
    </div>

    <div class="section">
        <h2>ğŸ¯ EventBus</h2>
        <div class="command" onclick="runCommand('checkEventBus')">
            <div class="command-title">1. ç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</div>
            <div class="command-code">window.TegakiEventBus.getRegisteredEvents()</div>
        </div>
        <div class="command" onclick="runCommand('checkEventListeners')">
            <div class="command-title">2. ãƒªã‚¹ãƒŠãƒ¼æ•°ç¢ºèª</div>
            <div class="command-code">å„ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼æ•°</div>
        </div>
        <div id="eventbus-output" class="output" style="display:none;"></div>
    </div>

    <script>
        function log(elementId, message, isError = false) {
            const output = document.getElementById(elementId);
            output.style.display = 'block';
            const className = isError ? 'warning' : 'success';
            output.innerHTML += `<span class="${className}">[${new Date().toLocaleTimeString()}]</span> ${message}\n`;
        }

        function clearLog(elementId) {
            const output = document.getElementById(elementId);
            output.innerHTML = '';
        }

        function runCommand(command) {
            const outputMap = {
                'debugHistory': 'history-output',
                'checkHistoryStack': 'history-output',
                'testUndo': 'history-output',
                'debugThumbnails': 'thumbnail-output',
                'checkThumbnailSizes': 'thumbnail-output',
                'checkBackgroundThumbnail': 'thumbnail-output',
                'checkLayers': 'layer-output',
                'checkActiveLayer': 'layer-output',
                'checkEventBus': 'eventbus-output',
                'checkEventListeners': 'eventbus-output'
            };

            const outputId = outputMap[command];
            clearLog(outputId);

            try {
                switch(command) {
                    case 'debugHistory':
                        if (window.History) {
                            window.History.debug();
                            log(outputId, 'Historyæƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸ');
                        } else {
                            log(outputId, 'window.History ãŒå­˜åœ¨ã—ã¾ã›ã‚“', true);
                        }
                        break;

                    case 'checkHistoryStack':
                        if (window.History) {
                            const stack = window.History.getStack();
                            log(outputId, `ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚º: ${stack.length}`);
                            log(outputId, `ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${window.History.index}`);
                            log(outputId, `Undoå¯èƒ½: ${window.History.canUndo()}`);
                            log(outputId, `Redoå¯èƒ½: ${window.History.canRedo()}`);
                            log(outputId, '\nã‚¹ã‚¿ãƒƒã‚¯å†…å®¹:');
                            stack.forEach(cmd => {
                                const marker = cmd.isCurrent ? 'ğŸ‘‰ ' : '   ';
                                log(outputId, `${marker}[${cmd.index}] ${cmd.name}`);
                            });
                        } else {
                            log(outputId, 'window.History ãŒå­˜åœ¨ã—ã¾ã›ã‚“', true);
                        }
                        break;

                    case 'testUndo':
                        if (window.History) {
                            log(outputId, 'ã‚¢ãƒ³ãƒ‰ã‚¥ã‚’å®Ÿè¡Œã—ã¾ã™...');
                            if (window.History.canUndo()) {
                                window.History.undo();
                                log(outputId, 'ã‚¢ãƒ³ãƒ‰ã‚¥å®Ÿè¡Œå®Œäº†');
                            } else {
                                log(outputId, 'ã‚¢ãƒ³ãƒ‰ã‚¥ã§ãã¾ã›ã‚“ï¼ˆã‚¹ã‚¿ãƒƒã‚¯ãŒç©ºï¼‰', true);
                            }
                        } else {
                            log(outputId, 'window.History ãŒå­˜åœ¨ã—ã¾ã›ã‚“', true);
                        }
                        break;

                    case 'debugThumbnails':
                        if (window.debugThumbnails) {
                            window.debugThumbnails();
                            log(outputId, 'ã‚µãƒ ãƒã‚¤ãƒ«æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸ');
                        } else {
                            log(outputId, 'debugThumbnails() ãŒå­˜åœ¨ã—ã¾ã›ã‚“', true);
                        }
                        break;

                    case 'checkThumbnailSizes':
                        const thumbnails = document.querySelectorAll('.layer-thumbnail');
                        log(outputId, `ã‚µãƒ ãƒã‚¤ãƒ«ç·æ•°: ${thumbnails.length}\n`);
                        thumbnails.forEach((thumb, i) => {
                            const rect = thumb.getBoundingClientRect();
                            const computed = window.getComputedStyle(thumb);
                            const isBackground = thumb.classList.contains('background-thumbnail');
                            log(outputId, `[${i}] ${isBackground ? 'èƒŒæ™¯' : 'é€šå¸¸'} ã‚µãƒ ãƒã‚¤ãƒ«:`);
                            log(outputId, `  - å®Ÿã‚µã‚¤ã‚º: ${rect.width.toFixed(1)}x${rect.height.toFixed(1)}px`);
                            log(outputId, `  - CSS width: ${computed.width}`);
                            log(outputId, `  - CSS height: ${computed.height}`);
                            log(outputId, `  - flex-shrink: ${computed.flexShrink}`);
                            log(outputId, '');
                        });
                        break;

                    case 'checkBackgroundThumbnail':
                        const bgThumbs = document.querySelectorAll('.background-thumbnail');
                        if (bgThumbs.length === 0) {
                            log(outputId, 'èƒŒæ™¯ã‚µãƒ ãƒã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', true);
                        } else {
                            bgThumbs.forEach((thumb, i) => {
                                const rect = thumb.getBoundingClientRect();
                                const computed = window.getComputedStyle(thumb);
                                log(outputId, `èƒŒæ™¯ã‚µãƒ ãƒã‚¤ãƒ« [${i}]:`);
                                log(outputId, `  - å®Ÿã‚µã‚¤ã‚º: ${rect.width}x${rect.height}px`);
                                log(outputId, `  - CSS width: ${computed.width}`);
                                log(outputId, `  - CSS height: ${computed.height}`);
                                log(outputId, `  - display: ${computed.display}`);
                                log(outputId, `  - background-color: ${computed.backgroundColor}`);
                                log(outputId, `  - background-image: ${computed.backgroundImage}`);
                                log(outputId, `  - grid-column: ${computed.gridColumn}`);
                                log(outputId, `  - grid-row: ${computed.gridRow}`);
                                log(outputId, '');
                            });
                        }
                        break;

                    case 'checkLayers':
                        const layerManager = window.drawingApp?.layerManager || window.layerManager;
                        if (layerManager) {
                            const layers = layerManager.getLayers();
                            log(outputId, `ãƒ¬ã‚¤ãƒ¤ãƒ¼ç·æ•°: ${layers.length}`);
                            log(outputId, `ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${layerManager.getActiveLayerIndex()}\n`);
                            layers.forEach((layer, i) => {
                                const data = layer.layerData;
                                const isActive = i === layerManager.getActiveLayerIndex();
                                const marker = isActive ? 'ğŸ‘‰ ' : '   ';
                                log(outputId, `${marker}[${i}] ${data?.name || 'åç„¡ã—'}`);
                                log(outputId, `    - ID: ${data?.id}`);
                                log(outputId, `    - èƒŒæ™¯: ${data?.isBackground ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
                                log(outputId, `    - ãƒ‘ã‚¹æ•°: ${data?.paths?.length || 0}`);
                                log(outputId, `    - å¯è¦–: ${data?.visible !== false ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
                                log(outputId, '');
                            });
                        } else {
                            log(outputId, 'layerManager ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', true);
                        }
                        break;

                    case 'checkActiveLayer':
                        const lm = window.drawingApp?.layerManager || window.layerManager;
                        if (lm) {
                            const active = lm.getActiveLayer();
                            if (active) {
                                log(outputId, `ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${active.layerData?.name}`);
                                log(outputId, `ãƒ‘ã‚¹æ•°: ${active.layerData?.paths?.length || 0}`);
                                log(outputId, `å­è¦ç´ æ•°: ${active.children.length}`);
                                log(outputId, `ä½ç½®: (${active.position.x}, ${active.position.y})`);
                                log(outputId, `ã‚¹ã‚±ãƒ¼ãƒ«: (${active.scale.x}, ${active.scale.y})`);
                                log(outputId, `å›è»¢: ${active.rotation}`);
                            } else {
                                log(outputId, 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“', true);
                            }
                        } else {
                            log(outputId, 'layerManager ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', true);
                        }
                        break;

                    case 'checkEventBus':
                        if (window.TegakiEventBus) {
                            const events = window.TegakiEventBus.getRegisteredEvents();
                            log(outputId, `ç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${events.length}\n`);
                            events.sort().forEach(event => {
                                log(outputId, event);
                            });
                        } else {
                            log(outputId, 'window.TegakiEventBus ãŒå­˜åœ¨ã—ã¾ã›ã‚“', true);
                        }
                        break;

                    case 'checkEventListeners':
                        if (window.TegakiEventBus) {
                            const events = window.TegakiEventBus.getRegisteredEvents();
                            log(outputId, 'ã‚¤ãƒ™ãƒ³ãƒˆåˆ¥ãƒªã‚¹ãƒŠãƒ¼æ•°:\n');
                            events.sort().forEach(event => {
                                const count = window.TegakiEventBus.getListenerCount(event);
                                log(outputId, `${event}: ${count}å€‹`);
                            });
                        } else {
                            log(outputId, 'window.TegakiEventBus ãŒå­˜åœ¨ã—ã¾ã›ã‚“', true);
                        }
                        break;
                }
            } catch (error) {
                log(outputId, `ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                console.error(error);
            }
        }

        function runFullDiagnostics() {
            const output = document.getElementById('full-output');
            output.style.display = 'block';
            output.innerHTML = '<span class="success">ğŸš€ å®Œå…¨è¨ºæ–­ã‚’é–‹å§‹...</span>\n\n';

            const diagnostics = [
                {
                    name: '1. HistoryçŠ¶æ…‹',
                    check: () => {
                        if (!window.History) return 'âŒ window.History ãŒå­˜åœ¨ã—ã¾ã›ã‚“';
                        return `âœ… ã‚¹ã‚¿ãƒƒã‚¯: ${window.History.stack.length}å€‹, ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${window.History.index}, Undo: ${window.History.canUndo()}, Redo: ${window.History.canRedo()}`;
                    }
                },
                {
                    name: '2. ThumbnailUpdateManager',
                    check: () => {
                        if (!window.thumbnailUpdateManager) return 'âŒ thumbnailUpdateManager ãŒå­˜åœ¨ã—ã¾ã›ã‚“';
                        const info = window.thumbnailUpdateManager.getDebugInfo();
                        return `âœ… æœ‰åŠ¹: ${info.isEnabled}, ãƒ‡ãƒã‚¦ãƒ³ã‚¹: ${info.debounceTime}ms, å¾…æ©Ÿä¸­: ${info.activeTimers}å€‹`;
                    }
                },
                {
                    name: '3. EventBus',
                    check: () => {
                        if (!window.TegakiEventBus) return 'âŒ TegakiEventBus ãŒå­˜åœ¨ã—ã¾ã›ã‚“';
                        const events = window.TegakiEventBus.getRegisteredEvents();
                        return `âœ… ç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆ: ${events.length}å€‹`;
                    }
                },
                {
                    name: '4. LayerManager',
                    check: () => {
                        const lm = window.drawingApp?.layerManager || window.layerManager;
                        if (!lm) return 'âŒ layerManager ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                        const layers = lm.getLayers();
                        const active = lm.getActiveLayerIndex();
                        return `âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${layers.length}å€‹, ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: ${active}`;
                    }
                },
                {
                    name: '5. ã‚µãƒ ãƒã‚¤ãƒ«è¦ç´ ',
                    check: () => {
                        const thumbs = document.querySelectorAll('.layer-thumbnail');
                        const bg = document.querySelectorAll('.background-thumbnail');
                        return `âœ… é€šå¸¸: ${thumbs.length}å€‹, èƒŒæ™¯: ${bg.length}å€‹`;
                    }
                },
                {
                    name: '6. KeyboardHandler',
                    check: () => {
                        if (!window.KeyboardHandler) return 'âŒ KeyboardHandler ãŒå­˜åœ¨ã—ã¾ã›ã‚“';
                        return `âœ… Vã‚­ãƒ¼çŠ¶æ…‹: ${window.KeyboardHandler.isVKeyPressed()}`;
                    }
                },
                {
                    name: '7. CoreRuntime API',
                    check: () => {
                        if (!window.CoreRuntime?.api) return 'âŒ CoreRuntime.api ãŒå­˜åœ¨ã—ã¾ã›ã‚“';
                        return `âœ… APIåˆ©ç”¨å¯èƒ½`;
                    }
                }
            ];

            diagnostics.forEach(diag => {
                try {
                    const result = diag.check();
                    output.innerHTML += `${diag.name}\n  ${result}\n\n`;
                } catch (error) {
                    output.innerHTML += `${diag.name}\n  âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}\n\n`;
                }
            });

            output.innerHTML += '<span class="success">âœ… è¨ºæ–­å®Œäº†</span>\n';
        }
    </script>
</body>
</html>
