# åº§æ¨™ç³»ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨è§£æãƒ¬ãƒãƒ¼ãƒˆ v8.13_Drawing_76

## ğŸš¨ è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼åˆ†æ

### ã‚¨ãƒ©ãƒ¼1: `Cannot read properties of undefined (reading 'addChild')` (brush-core.js:180)

**åŸå› :**
```javascript
// brush-core.js:180è¡Œç›®ï¼ˆèª¤ã‚Šï¼‰
activeLayer.container.addChild(this.previewGraphics);
```

**å•é¡Œ:**
- `activeLayer` ã¯æ—¢ã« `PIXI.Container` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
- `activeLayer.container` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯å­˜åœ¨ã—ãªã„ï¼ˆ`undefined`ï¼‰
- LayerSystemã® `getActiveLayer()` ãŒè¿”ã™ã®ã¯ Container ãã®ã‚‚ã®

**ä¿®æ­£:**
```javascript
// æ­£ã—ã„è¨˜è¿°
activeLayer.addChild(this.previewGraphics);
```

**å½±éŸ¿ç®‡æ‰€:**
- brush-core.js:180è¡Œç›® - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼Graphicsè¿½åŠ 
- brush-core.js:270è¡Œç›® - ç¢ºå®šGraphicsè¿½åŠ 

---

### ã‚¨ãƒ©ãƒ¼2: `this.curveInterpolator.interpolate is not a function` (brush-core.js:229)

**åŸå› :**
```javascript
// brush-core.js:61è¡Œç›® - æ­£ã—ã„ã‚¯ãƒ©ã‚¹å‚ç…§
this.curveInterpolator = window.CurveInterpolator;

// brush-core.js:229è¡Œç›® - å­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—
const interpolatedPoints = this.curveInterpolator.interpolate(
    this.lastLocalX,
    this.lastLocalY,
    localX,
    localY,
    this.lastPressure,
    processedPressure
);
```

**å•é¡Œ:**
- CurveInterpolatorã«ã¯ `interpolate()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„
- å®Ÿéš›ã®ãƒ¡ã‚½ãƒƒãƒ‰: `catmullRom(points, tension, segmentPoints)`
- é…åˆ—å½¢å¼ã®å¼•æ•°ã‚’è¦æ±‚ï¼ˆ2ç‚¹é–“è£œé–“ç”¨APIã§ã¯ãªã„ï¼‰

**ä¿®æ­£:**
```javascript
// 2ç‚¹é–“ã®è£œé–“ã¯ç·šå½¢è£œé–“ã§å®Ÿè£…
const interpolatedPoints = [];
const steps = 5; // è£œé–“ã‚¹ãƒ†ãƒƒãƒ—æ•°
for (let i = 1; i <= steps; i++) {
    const t = i / (steps + 1);
    interpolatedPoints.push({
        x: this.lastLocalX + (localX - this.lastLocalX) * t,
        y: this.lastLocalY + (localY - this.lastLocalY) * t,
        pressure: this.lastPressure + (processedPressure - this.lastPressure) * t
    });
}
```

---

### ã‚¨ãƒ©ãƒ¼3: `[Panel] Thumbnail image element not found for layer 0` (layer-panel-renderer.js:424)

**å•é¡Œ:**
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«è¦ç´ ãŒ DOM ã«å­˜åœ¨ã—ãªã„
- LayerPanelRenderer ã¨ LayerSystem ã®åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å•é¡Œ

**å½±éŸ¿:**
- è»½å¾®ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã®ã¿ã«å½±éŸ¿ã€æç”»æ©Ÿèƒ½ã«ã¯ç„¡é–¢ä¿‚ï¼‰

---

## ğŸ“Š åº§æ¨™ç³»ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
PointerEvent (clientX, clientY)
    â†“
CoordinateSystem.screenClientToCanvas()
    â”œâ”€ DPI/DPRè£œæ­£
    â”œâ”€ getBoundingClientRect()
    â””â”€ CSS â†’ Canvasåº§æ¨™å¤‰æ›
    â†“
CoordinateSystem.canvasToWorld()
    â”œâ”€ worldContainer.worldTransformå–å¾—
    â”œâ”€ é€†è¡Œåˆ—é©ç”¨
    â””â”€ worldåº§æ¨™ç¢ºå®š
    â†“
CoordinateSystem.worldToLocal()
    â”œâ”€ è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»
    â”œâ”€ position/rotation/scaleé€†é©ç”¨
    â””â”€ Localåº§æ¨™ç¢ºå®š
    â†“
BrushCore.startStroke(clientX, clientY, pressure)
    â”œâ”€ åº§æ¨™å¤‰æ›å®Ÿè¡Œ
    â””â”€ StrokeRecorder.startStroke(localX, localY, pressure)
        â†“
    StrokeRecorder.addPoint(localX, localY, pressure)
        â””â”€ pointsé…åˆ—ã«ç›´æ¥è¨˜éŒ²
        â†“
BrushCore.updateStroke(clientX, clientY, pressure)
    â”œâ”€ åº§æ¨™å¤‰æ›å®Ÿè¡Œ
    â”œâ”€ è£œé–“å‡¦ç†ï¼ˆCurveInterpolatorä½¿ç”¨ä¸å¯ â†’ ç·šå½¢è£œé–“ï¼‰
    â””â”€ StrokeRecorder.addPoint() ç¹°ã‚Šè¿”ã—
        â†“
BrushCore.finalizeStroke()
    â”œâ”€ StrokeRecorder.endStroke() â†’ strokeDataå–å¾—
    â””â”€ StrokeRenderer.renderStroke(activeLayer, strokeData, settings)
        â”œâ”€ ãƒšãƒ³ãƒ¢ãƒ¼ãƒ‰: normal blendMode
        â””â”€ æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰: erase blendMode â†’ maskTexture
```

---

## ğŸ”§ ãƒ¡ã‚½ãƒƒãƒ‰è¾å…¸

### CoordinateSystem (coordinate-system.js)

| ãƒ¡ã‚½ãƒƒãƒ‰ | è²¬å‹™ | å…¥åŠ› | å‡ºåŠ› |
|---------|------|------|------|
| `screenClientToCanvas(clientX, clientY)` | Screenâ†’Canvasåº§æ¨™å¤‰æ› | PointerEventåº§æ¨™ | `{canvasX, canvasY}` |
| `canvasToWorld(canvasX, canvasY)` | Canvasâ†’Worldåº§æ¨™å¤‰æ› | Canvasåº§æ¨™ | `{worldX, worldY}` |
| `worldToLocal(worldX, worldY, container)` | Worldâ†’Localåº§æ¨™å¤‰æ› | Worldåº§æ¨™+Container | `{localX, localY}` |
| `localToWorld(localX, localY, container)` | Localâ†’Worldåº§æ¨™å¤‰æ› | Localåº§æ¨™+Container | `{worldX, worldY}` |
| `screenClientToWorld(clientX, clientY)` | Screenâ†’Worldçµ±åˆå¤‰æ› | PointerEventåº§æ¨™ | `{worldX, worldY}` |
| `screenClientToLocal(clientX, clientY, container)` | Screenâ†’Localçµ±åˆå¤‰æ› | PointerEventåº§æ¨™+Container | `{localX, localY}` |

**ä¾å­˜é–¢ä¿‚:**
- window.TEGAKI_CONFIG
- window.TegakiEventBus
- window.cameraSystem.worldContainer

**ç¦æ­¢äº‹é …:**
- âŒ PIXI.toLocal() ã®ä½¿ç”¨ï¼ˆworldContainer offsetãŒå«ã¾ã‚Œã‚‹ï¼‰
- âœ… æ‰‹å‹•é€†ç®—ã®ã¿ä½¿ç”¨

---

### BrushCore (system/drawing/brush-core.js)

| ãƒ¡ã‚½ãƒƒãƒ‰ | è²¬å‹™ | å…¥åŠ› | å‡ºåŠ› |
|---------|------|------|------|
| `init()` | ä¾å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ– | ãªã— | ãªã— |
| `setMode(mode)` | ãƒšãƒ³/æ¶ˆã—ã‚´ãƒ åˆ‡æ›¿ | `'pen'|'eraser'` | ãªã— |
| `updateSettings(settings)` | ãƒ–ãƒ©ã‚·è¨­å®šæ›´æ–° | `{size, opacity, color}` | ãªã— |
| `startStroke(clientX, clientY, pressure)` | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–‹å§‹ | Screenåº§æ¨™+ç­†åœ§ | ãªã— |
| `updateStroke(clientX, clientY, pressure)` | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æ›´æ–° | Screenåº§æ¨™+ç­†åœ§ | ãªã— |
| `finalizeStroke()` | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç¢ºå®š | ãªã— | ãªã— |
| `cancelStroke()` | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ« | ãªã— | ãªã— |

**ä¾å­˜é–¢ä¿‚:**
- window.CoordinateSystem âœ…
- window.layerManager âœ…
- window.strokeRecorder âœ…
- window.strokeRenderer âœ…
- window.pressureHandler âš ï¸ï¼ˆä»»æ„ï¼‰
- window.CurveInterpolator âš ï¸ï¼ˆä»»æ„ãƒ»ä½¿ç”¨ä¸å¯ï¼‰

**è‡´å‘½çš„å•é¡Œ:**
1. **229è¡Œç›®**: `this.curveInterpolator.interpolate()` ãŒå­˜åœ¨ã—ãªã„
2. **180è¡Œç›®**: `activeLayer.container.addChild()` â†’ `activeLayer.addChild()`
3. **270è¡Œç›®**: `activeLayer.container.addChild()` â†’ `activeLayer.addChild()`

---

### StrokeRecorder (system/drawing/stroke-recorder.js)

| ãƒ¡ã‚½ãƒƒãƒ‰ | è²¬å‹™ | å…¥åŠ› | å‡ºåŠ› |
|---------|------|------|------|
| `startStroke(localX, localY, rawPressure)` | è¨˜éŒ²é–‹å§‹ | Localåº§æ¨™+ç­†åœ§ | ãªã— |
| `addPoint(localX, localY, rawPressure)` | ãƒã‚¤ãƒ³ãƒˆè¿½åŠ  | Localåº§æ¨™+ç­†åœ§ | ãªã— |
| `endStroke()` | è¨˜éŒ²çµ‚äº† | ãªã— | `{points, isSingleDot}` |
| `getCurrentPoints()` | ç¾åœ¨ã®ç‚¹ç¾¤å–å¾— | ãªã— | `Array<{x,y,pressure}>` |
| `getTotalDistance()` | ç·è·é›¢è¨ˆç®— | ãªã— | `number` |

**åº§æ¨™ç³»è²¬å‹™:**
- âœ… Localåº§æ¨™ã®ã¿ã‚’è¨˜éŒ²
- âŒ åº§æ¨™å¤‰æ›ã¯ä¸€åˆ‡è¡Œã‚ãªã„ï¼ˆäºŒé‡å¤‰æ›é˜²æ­¢ï¼‰

---

### StrokeRenderer (system/drawing/stroke-renderer.js)

| ãƒ¡ã‚½ãƒƒãƒ‰ | è²¬å‹™ | å…¥åŠ› | å‡ºåŠ› |
|---------|------|------|------|
| `setTool(tool)` | ãƒ„ãƒ¼ãƒ«è¨­å®š | `'pen'|'eraser'` | ãªã— |
| `calculateWidth(pressure, brushSize)` | å¹…è¨ˆç®— | ç­†åœ§+ã‚µã‚¤ã‚º | `number` |
| `renderPreview(points, settings, targetGraphics)` | ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”» | ç‚¹ç¾¤+è¨­å®š | `PIXI.Graphics` |
| `renderStroke(layerContainer, strokeData, settings)` | ç¢ºå®šæç”» | Container+strokeData | `pathData` |
| `_renderEraserStroke(layerContainer, strokeData, settings)` | æ¶ˆã—ã‚´ãƒ æç”» | Container+strokeData | `pathData` |
| `_ensureMaskTexture(layerData)` | maskTextureç”Ÿæˆ | layerData | ãªã— |

**ãƒšãƒ³/æ¶ˆã—ã‚´ãƒ çµ±åˆ:**
- ãƒšãƒ³: `blendMode='normal'`, é€šå¸¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç”»
- æ¶ˆã—ã‚´ãƒ : `blendMode='erase'`, maskTextureã«æç”»

---

### LayerSystem (system/layer-system.js)

| ãƒ¡ã‚½ãƒƒãƒ‰ | è²¬å‹™ | å…¥åŠ› | å‡ºåŠ› |
|---------|------|------|------|
| `getLayers()` | ãƒ¬ã‚¤ãƒ¤ãƒ¼é…åˆ—å–å¾— | ãªã— | `Array<PIXI.Container>` |
| `getActiveLayer()` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾— | ãªã— | `PIXI.Container` ã¾ãŸã¯ `null` |
| `createLayer(name, isBackground)` | ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ | åå‰+èƒŒæ™¯ãƒ•ãƒ©ã‚° | `PIXI.Container` |
| `setActiveLayer(index)` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | ãªã— |

**é‡è¦:**
- `getActiveLayer()` ã®æˆ»ã‚Šå€¤ã¯ `PIXI.Container` ç›´æ¥
- `.container` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯å­˜åœ¨ã—ãªã„

---

### CurveInterpolator (system/drawing/curve-interpolator.js)

| ãƒ¡ã‚½ãƒƒãƒ‰ | è²¬å‹™ | å…¥åŠ› | å‡ºåŠ› |
|---------|------|------|------|
| `catmullRom(points, tension, segmentPoints)` | Catmull-Romè£œé–“ | ç‚¹ç¾¤é…åˆ— | è£œé–“æ¸ˆã¿é…åˆ— |
| `adaptiveSample(points, maxDistance)` | é©å¿œã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° | ç‚¹ç¾¤é…åˆ— | ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ¸ˆã¿é…åˆ— |

**ä½¿ç”¨ä¸å¯:**
- âŒ `interpolate()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯å­˜åœ¨ã—ãªã„
- âŒ 2ç‚¹é–“è£œé–“ç”¨APIã¯æœªå®Ÿè£…

**ä»£æ›¿ç­–:**
- ç·šå½¢è£œé–“ã‚’æ‰‹å‹•å®Ÿè£…
- ã¾ãŸã¯å˜ç´”ã«ãƒã‚¤ãƒ³ãƒˆã‚’ç›´æ¥è¨˜éŒ²

---

## ğŸ”„ åˆæœŸåŒ–é †åºãƒ•ãƒ­ãƒ¼ (core-engine.js)

```
CoreEngine.constructor()
    â”œâ”€ CameraSystem ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    â”œâ”€ LayerSystem ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    â”œâ”€ BrushSettings ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    â””â”€ BrushCore = window.BrushCoreï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ï¼‰

CoreEngine.initialize()
    â”œâ”€ Phase 1: CameraSystem.init()
    â”œâ”€ Phase 2: LayerSystem.init()
    â”‚   â”œâ”€ åˆæœŸãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ
    â”‚   â””â”€ activeLayerIndex = 1
    â”œâ”€ Phase 3: ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§è¨­å®š
    â”‚   â”œâ”€ window.layerManager = this.layerSystem
    â”‚   â””â”€ window.cameraSystem = this.cameraSystem
    â”œâ”€ Phase 4: StrokeRecorder ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    â”‚   â””â”€ window.strokeRecorder = new StrokeRecorder()
    â”œâ”€ Phase 5: StrokeRenderer ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    â”‚   â””â”€ window.strokeRenderer = new StrokeRenderer()
    â”œâ”€ Phase 6: BrushCore.init()  â† â˜… ã“ã“ã§ä¾å­˜è§£æ±º
    â”‚   â”œâ”€ window.CoordinateSystem å–å¾—
    â”‚   â”œâ”€ window.layerManager å–å¾—
    â”‚   â”œâ”€ window.strokeRecorder å–å¾—
    â”‚   â””â”€ window.strokeRenderer å–å¾—
    â””â”€ Phase 7: PointerEventè¨­å®šï¼ˆCoreRuntimeï¼‰
```

**åˆæœŸåŒ–å®Œäº†æ¡ä»¶:**
- âœ… LayerSystem.isInitialized = true
- âœ… window.strokeRecorder ãŒå­˜åœ¨
- âœ… window.strokeRenderer ãŒå­˜åœ¨
- âœ… BrushCore.coordinateSystem !== null

---

## ğŸ› äºŒé‡å®Ÿè£…æ¤œå‡ºãƒªã‚¹ãƒˆ

### âŒ æ¤œå‡ºã•ã‚ŒãŸäºŒé‡å®Ÿè£…

1. **åº§æ¨™å¤‰æ›ã®äºŒé‡åŒ–ï¼ˆè§£æ¶ˆæ¸ˆã¿ï¼‰**
   - âœ… CoordinateSystemã«å®Œå…¨çµ±åˆæ¸ˆã¿
   - âœ… StrokeRecorderã¯åº§æ¨™å¤‰æ›ã—ãªã„

2. **CurveInterpolatorã®ä¸æ•´åˆ**
   - âŒ BrushCoreãŒå­˜åœ¨ã—ãªã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
   - âœ… ä¿®æ­£å¿…è¦: ç·šå½¢è£œé–“ã«ç½®ãæ›ãˆ

3. **Containerå‚ç…§ã®èª¤ã‚Š**
   - âŒ `activeLayer.container` ã¯å­˜åœ¨ã—ãªã„
   - âœ… ä¿®æ­£å¿…è¦: `activeLayer` ç›´æ¥ä½¿ç”¨

---

## ğŸ“‹ æ”¹ä¿®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### æœ€å„ªå…ˆä¿®æ­£ï¼ˆå³æ™‚å¯¾å¿œå¿…è¦ï¼‰

- [ ] brush-core.js:180 - `activeLayer.addChild(this.previewGraphics)`
- [ ] brush-core.js:270 - `activeLayer.addChild(pathData.graphics)`
- [ ] brush-core.js:229 - CurveInterpolator.interpolate()ã‚’ç·šå½¢è£œé–“ã«ç½®ãæ›ãˆ

### ä¸­å„ªå…ˆä¿®æ­£ï¼ˆæ©Ÿèƒ½æ”¹å–„ï¼‰

- [ ] CurveInterpolatorã«2ç‚¹é–“è£œé–“ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ï¼ˆå°†æ¥å¯¾å¿œï¼‰
- [ ] LayerPanelRendererã®åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´

### ä½å„ªå…ˆä¿®æ­£ï¼ˆæœ€é©åŒ–ï¼‰

- [ ] ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã®éåŒæœŸåŒ–
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

---

## ğŸ’‰ ä¿®æ­£ãƒ‘ãƒƒãƒé©ç”¨ã‚¬ã‚¤ãƒ‰

### ãƒ‘ãƒƒãƒ1: brush-core.js - Containerå‚ç…§ä¿®æ­£

**è¡Œ180ä»˜è¿‘:**
```javascript
// å¤‰æ›´å‰
activeLayer.container.addChild(this.previewGraphics);

// å¤‰æ›´å¾Œ
activeLayer.addChild(this.previewGraphics);
```

**è¡Œ220-240ä»˜è¿‘ï¼ˆCurveInterpolatorä½¿ç”¨ç®‡æ‰€ï¼‰:**
```javascript
// å¤‰æ›´å‰
if (this.curveInterpolator) {
    const interpolatedPoints = this.curveInterpolator.interpolate(
        this.lastLocalX,
        this.lastLocalY,
        localX,
        localY,
        this.lastPressure,
        processedPressure
    );
    
    interpolatedPoints.forEach(pt => {
        this.strokeRecorder.addPoint(pt.x, pt.y, pt.pressure);
    });
} else {
    this.strokeRecorder.addPoint(localX, localY, processedPressure);
}

// å¤‰æ›´å¾Œ
// ç·šå½¢è£œé–“å®Ÿè£…
const steps = Math.max(1, Math.floor(
    Math.sqrt((localX - this.lastLocalX) ** 2 + (localY - this.lastLocalY) ** 2) / 5
));

for (let i = 1; i <= steps; i++) {
    const t = i / (steps + 1);
    const interpX = this.lastLocalX + (localX - this.lastLocalX) * t;
    const interpY = this.lastLocalY + (localY - this.lastLocalY) * t;
    const interpPressure = this.lastPressure + (processedPressure - this.lastPressure) * t;
    
    this.strokeRecorder.addPoint(interpX, interpY, interpPressure);
}

// æœ€çµ‚ç‚¹ã‚’è¿½åŠ 
this.strokeRecorder.addPoint(localX, localY, processedPressure);
```

**è¡Œ268-272ä»˜è¿‘:**
```javascript
// å¤‰æ›´å‰
activeLayer.container.addChild(pathData.graphics);

// å¤‰æ›´å¾Œ
activeLayer.addChild(pathData.graphics);
```

---

## ğŸ§ª æ¤œè¨¼ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### ãƒ†ã‚¹ãƒˆ1: åº§æ¨™å¤‰æ›ã®ç²¾åº¦æ¤œè¨¼

```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
const testX = 400, testY = 300;
const canvas = window.CoordinateSystem.screenClientToCanvas(testX, testY);
console.log('Canvas:', canvas);

const world = window.CoordinateSystem.canvasToWorld(canvas.canvasX, canvas.canvasY);
console.log('World:', world);

const activeLayer = window.layerManager.getActiveLayer();
const local = window.CoordinateSystem.worldToLocal(world.worldX, world.worldY, activeLayer);
console.log('Local:', local);

// é€†å¤‰æ›æ¤œè¨¼
const worldBack = window.CoordinateSystem.localToWorld(local.localX, local.localY, activeLayer);
console.log('World (back):', worldBack);
console.log('Î”:', Math.abs(world.worldX - worldBack.worldX), Math.abs(world.worldY - worldBack.worldY));
```

**åˆæ ¼åŸºæº–:** Î” < 0.5px

---

### ãƒ†ã‚¹ãƒˆ2: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æç”»

```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
window.BrushCore.setMode('pen');
window.BrushCore.updateSettings({ size: 10, opacity: 1.0, color: 0xFF0000 });

// ä»®æƒ³ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯
const mockEvent = { clientX: 400, clientY: 300, pressure: 0.5 };
window.BrushCore.startStroke(mockEvent.clientX, mockEvent.clientY, mockEvent.pressure);

setTimeout(() => {
    window.BrushCore.updateStroke(450, 350, 0.7);
}, 50);

setTimeout(() => {
    window.BrushCore.finalizeStroke();
}, 100);
```

**åˆæ ¼åŸºæº–:** ã‚¨ãƒ©ãƒ¼ãªãèµ¤ç·šãŒæç”»ã•ã‚Œã‚‹

---

## ğŸ“š ã‚·ãƒ³ãƒœãƒ«ä¾å­˜ã‚°ãƒ©ãƒ•

```
window.CoordinateSystem (æœ€ä¸‹å±¤ãƒ»ä¾å­˜ãªã—)
    â†‘
window.cameraSystem.worldContainer
    â†‘
window.layerManager
    â†‘
    â”œâ”€ window.strokeRecorder
    â”œâ”€ window.strokeRenderer
    â””â”€ window.BrushCore â† â˜… å…¨ã¦ã«ä¾å­˜
        â†‘
    CoreRuntime.handlePointerDown/Move/Up
```

**å¾ªç’°ä¾å­˜ãƒã‚§ãƒƒã‚¯:** âœ… ãªã—

---

## ğŸ¯ ä¿®æ­£å„ªå…ˆåº¦ãƒãƒˆãƒªã‚¯ã‚¹

| å•é¡Œ | å½±éŸ¿åº¦ | ä¿®æ­£é›£æ˜“åº¦ | å„ªå…ˆåº¦ |
|------|--------|-----------|--------|
| Containerå‚ç…§èª¤ã‚Š | ğŸ”´ è‡´å‘½çš„ | ğŸŸ¢ ç°¡å˜ | âš¡ æœ€é«˜ |
| CurveInterpolatorä¸æ•´åˆ | ğŸŸ¡ é«˜ | ğŸŸ¢ ç°¡å˜ | âš¡ æœ€é«˜ |
| ã‚µãƒ ãƒã‚¤ãƒ«è¦ç´ ä¸åœ¨ | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ | ğŸ”µ ä½ |

---

## ğŸš€ ä¿®æ­£å¾Œã®å‹•ä½œãƒ•ãƒ­ãƒ¼ï¼ˆæœŸå¾…å€¤ï¼‰

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯
    â†“
2. CoreRuntime.handlePointerDown() å®Ÿè¡Œ
    â†“
3. BrushCore.startStroke(clientX, clientY, pressure)
    â”œâ”€ CoordinateSystem.screenClientToCanvas()
    â”œâ”€ CoordinateSystem.canvasToWorld()
    â”œâ”€ CoordinateSystem.worldToLocal(activeLayer)
    â””â”€ StrokeRecorder.startStroke(localX, localY, pressure)
    â†“
4. activeLayer.addChild(previewGraphics) â† â˜… ä¿®æ­£æ¸ˆã¿
    â†“
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¦ã‚¹ç§»å‹•
    â†“
6. BrushCore.updateStroke(clientX, clientY, pressure)
    â”œâ”€ åº§æ¨™å¤‰æ›
    â”œâ”€ ç·šå½¢è£œé–“ â† â˜… ä¿®æ­£æ¸ˆã¿
    â””â”€ StrokeRecorder.addPoint() ç¹°ã‚Šè¿”ã—
    â†“
7. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—
    â†“
8. BrushCore.finalizeStroke()
    â”œâ”€ StrokeRecorder.endStroke() â†’ strokeData
    â”œâ”€ StrokeRenderer.renderStroke(activeLayer, strokeData, settings)
    â””â”€ activeLayer.addChild(pathData.graphics) â† â˜… ä¿®æ­£æ¸ˆã¿
    â†“
9. æç”»å®Œäº† âœ…
```

---

## ğŸ“– ç”¨èªé›†

- **Screenåº§æ¨™**: ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åŸºæº–ï¼ˆclientX/Yï¼‰
- **Canvasåº§æ¨™**: PixiJS Canvaså†…éƒ¨åº§æ¨™ï¼ˆDPIè£œæ­£æ¸ˆã¿ï¼‰
- **Worldåº§æ¨™**: worldContaineråŸºæº–ï¼ˆã‚«ãƒ¡ãƒ©å¤‰æ›å‰ï¼‰
- **Localåº§æ¨™**: ãƒ¬ã‚¤ãƒ¤ãƒ¼Containerç›´ä¸‹ï¼ˆã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¨˜éŒ²åº§æ¨™ï¼‰
- **DPR**: Device Pixel Ratioï¼ˆRetinaå¯¾å¿œï¼‰
- **blendMode**: PixiJSæç”»åˆæˆãƒ¢ãƒ¼ãƒ‰ï¼ˆnormal/eraseï¼‰
- **maskTexture**: æ¶ˆã—ã‚´ãƒ ç”¨ãƒã‚¹ã‚¯ãƒ†ã‚¯ã‚¹ãƒãƒ£

---

## ğŸ” ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰é›†

```javascript
// ç¾åœ¨ã®BrushCoreçŠ¶æ…‹ç¢ºèª
console.log('BrushCore:', window.BrushCore);
console.log('Is Drawing:', window.BrushCore.isDrawing);
console.log('Mode:', window.BrushCore.currentMode);

// åº§æ¨™ç³»ç¢ºèª
console.log('CoordinateSystem:', window.CoordinateSystem);
console.log('LayerManager:', window.layerManager);
console.log('Active Layer:', window.layerManager.getActiveLayer());

// StrokeRecorderç¢ºèª
console.log('StrokeRecorder:', window.strokeRecorder);
console.log('Current Points:', window.strokeRecorder.getCurrentPoints());

// ä¾å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç¢ºèª
console.log('Dependencies:', {
    coordinateSystem: !!window.BrushCore.coordinateSystem,
    layerManager: !!window.BrushCore.layerManager,
    strokeRecorder: !!window.BrushCore.strokeRecorder,
    strokeRenderer: !!window.BrushCore.strokeRenderer
});
```

---

**ç”Ÿæˆæ—¥æ™‚:** 2025-10-31  
**ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³æº–æ‹ ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** v2.2  
**Phase:** Phase 2 çµ±åˆå¾Œã®ãƒã‚°ä¿®æ­£