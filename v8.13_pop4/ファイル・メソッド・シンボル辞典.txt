# Tegaki v8.13_pop1 - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ã‚·ãƒ³ãƒœãƒ«è¾å…¸

## ğŸ” ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é–¢é€£ã®äºŒé‡å®Ÿè£…ãƒã‚§ãƒƒã‚¯

### âŒ å•é¡Œç™ºè¦‹: AlbumPopup ã®äºŒé‡å®Ÿè£…

#### 1. **album-popup.js** (æ—§å®Ÿè£…ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§)
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²**: `window.AlbumPopup` (ç‹¬è‡ªã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ–¹å¼)
- **å®Ÿè£…æ–¹å¼**: ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ + ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°
- **ãƒ¡ã‚½ãƒƒãƒ‰**: `show()`, `hide()`, `toggle()`

#### 2. **album-popup.js** (æ–°å®Ÿè£…)
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²**: `window.TegakiUI.AlbumPopup`
- **å®Ÿè£…æ–¹å¼**: `.popup-panel` ã‚¯ãƒ©ã‚¹ + å›ºå®šä½ç½®
- **ãƒ¡ã‚½ãƒƒãƒ‰**: `show()`, `hide()`, `toggle()`

#### 3. **ui-panels.js** (`UIController.initializeAlbumPopup`)
```javascript
initializeAlbumPopup(animationSystem) {
    // window.TegakiUI.AlbumPopup ã‚’ä½¿ç”¨
    this.albumPopup = new window.TegakiUI.AlbumPopup(...)
}
```

#### 4. **core-engine.js** (`CoreEngine`)
- ã‚¢ãƒ«ãƒãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯**ç›´æ¥ç®¡ç†ã—ã¦ã„ãªã„**
- `exportManager`ã®ã¿ç®¡ç†

---

## ğŸ“ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç®¡ç†ãƒ•ãƒ­ãƒ¼

### UIController (ui-panels.js)

#### ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å‚ç…§
```javascript
this.albumPopup = null          // AlbumPopup
this.settingsPopup = null       // SettingsPopup
this.exportPopup = null         // ExportPopup
this.quickAccessPopup = null    // QuickAccessPopup
```

#### åˆæœŸåŒ–ãƒ¡ã‚½ãƒƒãƒ‰
```javascript
initializeAlbumPopup(animationSystem)       // âœ… window.TegakiUI.AlbumPopup
initializeSettingsPopup()                   // âœ… window.TegakiUI.SettingsPopup
initializeQuickAccessPopup()                // âœ… window.TegakiUI.QuickAccessPopup
getExportPopup()                            // âœ… window.TEGAKI_EXPORT_POPUP
```

#### ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆ¶å¾¡
```javascript
showPopup(popup)                 // ä»–ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã¦è¡¨ç¤º
closeAllPopups(exceptPopup)      // å…¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
```

#### ãƒ„ãƒ¼ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
```javascript
handleToolClick(button)
  - 'pen-tool'        â†’ quickAccessPopup.toggle()
  - 'library-tool'    â†’ albumPopup.toggle()
  - 'export-tool'     â†’ exportPopup.toggle()
  - 'settings-tool'   â†’ settingsPopup.toggle()
  - 'resize-tool'     â†’ ãƒªã‚µã‚¤ã‚ºãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
```

---

## ğŸ¯ å„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å®Ÿè£…

### 1. QuickAccessPopup (quick-access-popup.js)
```javascript
class QuickAccessPopup {
    constructor(drawingEngine)
    
    // DOM
    _ensurePopupElement()
    _createPopupElement()          // <div id="quick-access-popup" class="popup-panel">
    
    // åˆ¶å¾¡
    show()                         // popup.classList.add('show')
    hide()                         // popup.classList.remove('show')
    toggle()
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
window.TegakiUI.QuickAccessPopup
window.QuickAccessPopup
```

### 2. SettingsPopup (settings-popup.js)
```javascript
class SettingsPopup {
    constructor(drawingEngine)
    
    // DOM
    _ensurePopupElement()
    _createPopupElement()          // <div id="settings-popup" class="popup-panel">
    _populateContent()
    
    // åˆæœŸåŒ–
    initialize()
    _setupSliders()
    _setupButtons()
    
    // åˆ¶å¾¡
    show()                         // popup.classList.add('show')
    hide()                         // popup.classList.remove('show')
    toggle()
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
window.TegakiUI.SettingsPopup
window.SettingsPopup
```

### 3. AlbumPopup (album-popup.js) âš ï¸ äºŒé‡å®Ÿè£…ç–‘æƒ‘
```javascript
class AlbumPopup {
    constructor(app, layerSystem, animationSystem)
    
    // DOM (æ–°å®Ÿè£…)
    _ensurePopupElement()
    _createPopupElement()          // <div id="album-popup" class="popup-panel">
    
    // åˆ¶å¾¡ (æ–°å®Ÿè£…)
    show()                         // popup.classList.add('show')
    hide()                         // popup.classList.remove('show')
    toggle()
    
    // æ©Ÿèƒ½
    _saveSnapshot()
    _loadSnapshot()
    _renderGallery()
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ² (æ–°å®Ÿè£…)
window.TegakiUI.AlbumPopup
window.AlbumPopup = window.TegakiUI.AlbumPopup

// âš ï¸ æ—§å®Ÿè£…ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§
// - ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ–¹å¼
// - document.createElement('div') ã§ overlay ä½œæˆ
// - document.body.appendChild(overlay)
```

### 4. ExportPopup (export-popup.js)
```javascript
class ExportPopup {
    constructor(exportManager)
    
    // DOM
    setupUI()                      // <div id="export-popup" class="popup-panel">
    updateOptionsUI(format)
    
    // åˆ¶å¾¡
    show()                         // popup.classList.add('show')
    hide()                         // popup.classList.remove('show')
    toggle()
    
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    executeExport()
    executePreview()
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
window.ExportPopup
window.TegakiExportPopup
window.TEGAKI_EXPORT_POPUP        // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
```

---

## ğŸ”§ åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼

### core-initializer.js
```javascript
class DrawingApp {
    async initialize() {
        // 1. UIController åˆæœŸåŒ–
        this.uiController = new UIController(...)
        
        // 2. SettingsPopup é…å»¶åˆæœŸåŒ–
        this.initializeSettingsPopupDelayed()
        
        // 3. AlbumPopup åˆæœŸåŒ–
        if (this.coreEngine.animationSystem) {
            this.uiController.initializeAlbumPopup(
                this.coreEngine.animationSystem
            );
        }
    }
}

// Export System åˆæœŸåŒ–
function initializeExportSystem(app) {
    CoreRuntime.initializeExportSystem(...)
    
    // ExportPopup æ‰‹å‹•ä½œæˆ
    if (!window.TEGAKI_EXPORT_POPUP) {
        window.TEGAKI_EXPORT_POPUP = new window.ExportPopup(...)
    }
}
```

---

## ğŸš¨ å•é¡Œã®æ ¹æœ¬åŸå› 

### 1. **album-popup.js ãŒäºŒé‡ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§**
   - `index.html` ã§ `<script src="ui/album-popup.js"></script>`
   - æ—§å®Ÿè£…ã‚³ãƒ¼ãƒ‰ãŒæ®‹ã£ã¦ã„ã‚‹
   - æ–°å®Ÿè£…ãŒè¿½åŠ ã•ã‚ŒãŸãŒã€æ—§å®Ÿè£…ãŒå‰Šé™¤ã•ã‚Œã¦ã„ãªã„

### 2. **ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²ã®ç«¶åˆ**
   ```javascript
   // æ—§å®Ÿè£… (ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ–¹å¼)
   window.AlbumPopup = class { ... }
   
   // æ–°å®Ÿè£… (.popup-panelæ–¹å¼)
   window.TegakiUI.AlbumPopup = class { ... }
   window.AlbumPopup = window.TegakiUI.AlbumPopup  // ä¸Šæ›¸ã
   ```

### 3. **UIController ã®å‚ç…§ãŒä¸æ˜ç¢º**
   ```javascript
   // ui-panels.js
   initializeAlbumPopup(animationSystem) {
       // window.TegakiUI.AlbumPopup ã‚’å‚ç…§
       this.albumPopup = new window.TegakiUI.AlbumPopup(...)
   }
   
   handleToolClick(button) {
       case 'library-tool':
           // this.albumPopup ã‚’ä½¿ç”¨
           if (this.albumPopup.isVisible) {
               this.albumPopup.hide();
           } else {
               this.showPopup(this.albumPopup);
           }
   }
   ```

---

## âœ… è§£æ±ºç­–

### 1. album-popup.js ã®å®Œå…¨æ›¸ãæ›ãˆ
   - ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã§æ—§å®Ÿè£…ã‚’å‰Šé™¤
   - æ–°å®Ÿè£…ã®ã¿ã‚’æ®‹ã™

### 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²ã®çµ±ä¸€
   ```javascript
   // album-popup.js ã®æœ€å¾Œ
   
   // æ—§å®Ÿè£…ã‚’å‰Šé™¤
   if (window.AlbumPopup) {
       delete window.AlbumPopup;
   }
   
   // æ–°å®Ÿè£…ã‚’ç™»éŒ²
   window.TegakiUI.AlbumPopup = class { ... }
   window.AlbumPopup = window.TegakiUI.AlbumPopup;
   ```

### 3. DOMè¦ç´ ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
   ```javascript
   _ensurePopupElement() {
       // æ—¢å­˜ã®è¦ç´ ã‚’å‰Šé™¤
       const existingPopup = document.getElementById('album-popup');
       if (existingPopup) {
           existingPopup.remove();
       }
       
       this._createPopupElement();
   }
   ```

### 4. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®é‡è¤‡é˜²æ­¢
   ```javascript
   // library-tool ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
   // ui-panels.js ã§ä¸€å…ƒç®¡ç†
   ```

---

## ğŸ“Š ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç®¡ç†

### keyboard-handler.js
```javascript
handleKeyDown(e) {
    // Q ã‚­ãƒ¼
    if (e.key === 'q' || e.key === 'Q') {
        eventBus.emit('ui:toggle-quick-access');
    }
}
```

### ui-panels.js (EventBus ãƒªã‚¹ãƒŠãƒ¼)
```javascript
setupEventBusListeners() {
    eventBus.on('ui:toggle-quick-access', () => {
        if (this.quickAccessPopup) {
            this.quickAccessPopup.toggle();
        }
    });
}
```

---

## ğŸ¨ CSS ã‚¯ãƒ©ã‚¹çµ±ä¸€

### .popup-panel (å…¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å…±é€š)
```css
.popup-panel {
    position: fixed;
    display: none;                    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º */
    background: var(--futaba-cream);
    border: 2px solid var(--futaba-maroon);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 24px rgba(128, 0, 0, 0.2);
    z-index: 9999;
}

.popup-panel.show {
    display: flex;                    /* è¡¨ç¤ºæ™‚ */
    flex-direction: column;
}
```

### ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½ç½®
- **QuickAccessPopup**: `top: 60px; left: 60px;`
- **SettingsPopup**: `top: 60px; left: 60px;`
- **AlbumPopup**: `top: 60px; left: 60px;` (æ–°å®Ÿè£…)
- **ExportPopup**: `top: 200px; left: 60px;`

---

## ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

1. **ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèª**
   ```javascript
   console.log('window.AlbumPopup:', window.AlbumPopup);
   console.log('window.TegakiUI.AlbumPopup:', window.TegakiUI.AlbumPopup);
   console.log('Same?', window.AlbumPopup === window.TegakiUI.AlbumPopup);
   
   // UIController ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
   console.log('uiController.albumPopup:', window.TegakiUI.uiController?.albumPopup);
   ```

2. **DOMè¦ç´ ã®é‡è¤‡ç¢ºèª**
   ```javascript
   console.log('album-popup elements:', 
       document.querySelectorAll('#album-popup').length
   );
   console.log('album-overlay elements:', 
       document.querySelectorAll('.album-overlay').length
   );
   ```

3. **ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç¢ºèª**
   ```javascript
   const libraryBtn = document.getElementById('library-tool');
   console.log('library-tool listeners:', 
       getEventListeners(libraryBtn)  // Chrome DevTools
   );
   ```

---

## ğŸ¯ æœ€çµ‚ç¢ºèªé …ç›®

- [ ] `album-popup.js` ã«æ—§å®Ÿè£…ã‚³ãƒ¼ãƒ‰ãŒæ®‹ã£ã¦ã„ãªã„ã‹
- [ ] `window.AlbumPopup === window.TegakiUI.AlbumPopup` ãŒ true ã‹
- [ ] DOM ã« `#album-popup` ãŒ1ã¤ã ã‘å­˜åœ¨ã™ã‚‹ã‹
- [ ] DOM ã« `.album-overlay` ãŒå­˜åœ¨ã—ãªã„ã‹
- [ ] `library-tool` ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒé‡è¤‡ã—ã¦ã„ãªã„ã‹
- [ ] `closeAllPopups()` ã§ã‚¢ãƒ«ãƒãƒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒç¢ºå®Ÿã«é–‰ã˜ã‚‹ã‹