!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).PerfectFreehand=t()}(this,function(){"use strict";function e(e,t,n,r=e=>e){return e*r(.5-t*(.5-n))}function t(e,t){return[e[0]+t[0],e[1]+t[1]]}function n(e,t){return[e[0]-t[0],e[1]-t[1]]}function r(e,t){return[e[0]*t,e[1]*t]}function i(e){return[e[1],-e[0]]}function u(e,t){return e[0]*t[0]+e[1]*t[1]}function l(e,t){return e[0]===t[0]&&e[1]===t[1]}function o(e,t){return function(e){return e[0]*e[0]+e[1]*e[1]}(n(e,t))}function s(e){return function(e,t){return[e[0]/t,e[1]/t]}(e,function(e){return Math.hypot(e[0],e[1])}(e))}function f(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function c(e,t,n){let r=Math.sin(n),i=Math.cos(n),u=e[0]-t[0],l=e[1]-t[1],o=u*r+l*i;return[u*i-l*r+t[0],o+t[1]]}function h(e,i,u){return t(e,r(n(i,e),u))}function p(e,n,i){return t(e,r(n,i))}var{min:a,PI:g}=Math,d=g+1e-4;return function(g,v={}){return function(l,f={}){let{size:g=16,smoothing:v=.5,thinning:m=.5,simulatePressure:M=!0,easing:y=e=>e,start:x={},end:L={},last:b=!1}=f,{cap:P=!0,easing:z=e=>e*(2-e)}=x,{cap:A=!0,easing:T=e=>--e*e*e+1}=L;if(0===l.length||g<=0)return[];let j,w=l[l.length-1].runningLength,F=!1===x.taper?0:!0===x.taper?Math.max(g,w):x.taper,I=!1===L.taper?0:!0===L.taper?Math.max(g,w):L.taper,k=Math.pow(g*v,2),q=[],B=[],C=l.slice(0,10).reduce((e,t)=>{let n=t.pressure;if(M){let r=a(1,t.distance/g),i=a(1,1-r);n=a(1,e+.275*r*(i-e))}return(e+n)/2},l[0].pressure),D=e(g,m,l[l.length-1].pressure,y),E=l[0].vector,G=l[0].point,H=G,J=G,K=H,N=!1;for(let s=0;s<l.length;s++){let{pressure:f}=l[s],{point:p,vector:v,distance:x,runningLength:L}=l[s];if(s<l.length-1&&w-L<3)continue;if(m){if(M){let e=a(1,x/g),t=a(1,1-e);f=a(1,C+.275*e*(t-C))}D=e(g,m,f,y)}else D=g/2;void 0===j&&(j=D);let b=L<F?z(L/F):1,P=w-L<I?T((w-L)/I):1;D=Math.max(.01,D*Math.min(b,P));let A=(s<l.length-1?l[s+1]:l[s]).vector,O=s<l.length-1?u(v,A):1,Q=null!==O&&O<0;if(u(v,E)<0&&!N||Q){let e=r(i(E),D);for(let r=1/13,i=0;i<=1;i+=r)J=c(n(p,e),p,d*i),q.push(J),K=c(t(p,e),p,d*-i),B.push(K);G=J,H=K,Q&&(N=!0);continue}if(N=!1,s===l.length-1){let e=r(i(v),D);q.push(n(p,e)),B.push(t(p,e));continue}let R=r(i(h(A,v,O)),D);J=n(p,R),(s<=1||o(G,J)>k)&&(q.push(J),G=J),K=t(p,R),(s<=1||o(H,K)>k)&&(B.push(K),H=K),C=f,E=v}let O=l[0].point.slice(0,2),Q=l.length>1?l[l.length-1].point.slice(0,2):t(l[0].point,[1,1]),R=[],S=[];if(1===l.length){if(!F&&!I||b){let e=p(O,s(i(n(O,Q))),-(j||D)),t=[];for(let n=1/13,r=n;r<=1;r+=n)t.push(c(e,O,2*d*r));return t}}else{if(!(F||I&&1===l.length))if(P)for(let e=1/13,t=e;t<=1;t+=e){let e=c(B[0],O,d*t);R.push(e)}else{let e=n(q[0],B[0]),i=r(e,.5),u=r(e,.51);R.push(n(O,i),n(O,u),t(O,u),t(O,i))}let e=i(function(e){return[-e[0],-e[1]]}(l[l.length-1].vector));if(I||F&&1===l.length)S.push(Q);else if(A){let t=p(Q,e,D);for(let e=1/29,n=e;n<1;n+=e)S.push(c(t,Q,3*d*n))}else S.push(t(Q,r(e,D)),t(Q,r(e,.99*D)),n(Q,r(e,.99*D)),n(Q,r(e,D)))}return q.concat(S,B.reverse(),R)}(function(e,r={}){var i;let{streamline:u=.5,size:o=16,last:c=!1}=r;if(0===e.length)return[];let p=.15+.85*(1-u),a=Array.isArray(e[0])?e:e.map(({x:e,y:t,pressure:n=.5})=>[e,t,n]);if(2===a.length){let e=a[1];a=a.slice(0,-1);for(let t=1;t<5;t++)a.push(h(a[0],e,t/4))}1===a.length&&(a=[...a,[...t(a[0],[1,1]),...a[0].slice(2)]]);let g=[{point:[a[0][0],a[0][1]],pressure:a[0][2]>=0?a[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],d=!1,v=0,m=g[0],M=a.length-1;for(let e=1;e<a.length;e++){let t=c&&e===M?a[e].slice(0,2):h(m.point,a[e],p);if(l(m.point,t))continue;let r=f(t,m.point);if(v+=r,e<M&&!d){if(v<o)continue;d=!0}m={point:t,pressure:a[e][2]>=0?a[e][2]:.5,vector:s(n(m.point,t)),distance:r,runningLength:v},g.push(m)}return g[0].vector=(null==(i=g[1])?void 0:i.vector)||[0,0],g}(g,v),v)}});
