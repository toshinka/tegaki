# Tegaki WebGL2 ãŠçµµã‹ããƒ„ãƒ¼ãƒ« - ãƒ•ã‚¡ã‚¤ãƒ«è¾å…¸ãƒ»ãƒ•ãƒ­ãƒ¼è¨ºæ–­

## å‡¡ä¾‹
- âš ï¸ = å•é¡Œç®‡æ‰€ãƒ»å®Ÿè£…ä¸å®Œå…¨
- ğŸ”§ = æ”¹ä¿®å¿…è¦
- âœ… = æ­£å¸¸å‹•ä½œç¢ºèªæ¸ˆã¿
- âŒ = æœªå®Ÿè£…ãƒ»æ©Ÿèƒ½ä¸å…¨
- ğŸ” = è¦èª¿æŸ»
- ğŸ“ = è¦ªãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¾å­˜ï¼‰
- ğŸ“„ = å­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ï¼‰
- ğŸ”€ = ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼é–¢é€£

---

## â–  ã‚³ã‚¢åˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ 

### ğŸ“ core-initializer.js (Phase 1.2.2)
**è²¬å‹™**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®åˆæœŸåŒ–çµ±æ‹¬

**è¦ªä¾å­˜**:
- PIXI.js v8.14 (CDN)
- config.js (TEGAKI_CONFIG)
- coordinate-system.js (CoordinateSystem) â­
- system/event-bus.js (TegakiEventBus)
- system/popup-manager.js (TegakiPopupManager)
- system/settings-manager.js (TegakiSettingsManager)
- ui/dom-builder.js (DOMBuilder)
- core-runtime.js (CoreRuntime)
- core-engine.js (CoreEngine)

**å­åˆæœŸåŒ–å¯¾è±¡**:
- coordinate-system.js (åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³)
- system/drawing/webgl2/webgl2-drawing-layer.js
- system/drawing/webgl2/gl-stroke-processor.js
- system/drawing/webgl2/gl-msdf-pipeline.js
- system/drawing/webgl2/gl-texture-bridge.js
- system/drawing/webgl2/gl-mask-layer.js
- system/drawing/stroke-renderer.js
- system/drawing/brush-core.js

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
```
checkDependencies() -> boolean
buildDOM() -> void
initializeSettingsManager() -> TegakiSettingsManager
initializePopupManager(app, coreEngine) -> PopupManager
setupEventBusListeners() -> void
initializeLayerPanel(layerSystem, eventBus) -> LayerPanelRenderer
ğŸ”§ initializeCoordinateSystem(worldContainer) -> boolean
async initializeWebGL2(strokeRenderer, pixiApp) -> boolean
DrawingApp.initialize() -> boolean
```

**åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼**:
```
1. checkDependencies()
2. buildDOM()
3. KeyboardHandler.init()
4. DrawingApp.initialize()
   â”œâ”€ PIXI.Application.init()
   â”œâ”€ CoreEngine.initialize() â­worldContainerç”Ÿæˆ
   â”œâ”€ CoordinateSystem.initialize(canvas, worldContainer) â­Phase 1.2.2ä¿®æ­£
   â”œâ”€ CoreRuntime.init()
   â”œâ”€ initializeSettingsManager()
   â”œâ”€ UIControlleråˆæœŸåŒ–
   â”œâ”€ initializePopupManager()
   â”œâ”€ setupEventBusListeners()
   â”œâ”€ initializeLayerPanel()
   â”œâ”€ initializeWebGL2()
   â””â”€ startRenderLoop()
```

**å•é¡Œç‚¹**:
âš ï¸ CoordinateSystemåˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒCoreEngine.initialize()å®Œäº†å¾Œã«ç§»å‹•ã•ã‚ŒãŸãŒã€DrawingEngineã¨ã®æ¥ç¶šãŒæœªç¢ºèª
âš ï¸ WebGL2åˆæœŸåŒ–ã¨BrushCoreå†åˆæœŸåŒ–ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒè¤‡é›‘

---

### ğŸ“ core-engine.js (Phase 4-C)
**è²¬å‹™**: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®åˆæœŸåŒ–ãƒ»ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ«ãƒ¼ãƒ—ç®¡ç†

**è¦ªä¾å­˜**:
- system/camera-system.js (TegakiCameraSystem)
- system/layer-system.js (TegakiLayerSystem)
- system/drawing-clipboard.js (TegakiDrawingClipboard)
- system/drawing/brush-core.js (BrushCore)
- system/drawing/stroke-recorder.js (StrokeRecorder)
- system/drawing/stroke-renderer.js (StrokeRenderer)
- system/event-bus.js (TegakiEventBus)
- system/export-manager.js (ExportManager)

**å­ä½¿ç”¨å…ˆ**:
- core-initializer.js (åˆæœŸåŒ–å‘¼ã³å‡ºã—å…ƒ)
- drawing-engine.js (renderPreviewå‘¼ã³å‡ºã—)

**ä¸»è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**:
```javascript
app: PIXI.Application
cameraSystem: TegakiCameraSystem
layerSystem: TegakiLayerSystem
clipboardSystem: TegakiDrawingClipboard
brushSettings: BrushSettings
drawingEngine: DrawingEngine âš ï¸å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒåˆæœŸåŒ–ä¸æ˜
animationSystem: TegakiAnimationSystem
eventBus: TegakiEventBus
renderLoopId: number
isRenderLoopRunning: boolean
```

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
constructor(app, config)
initialize() -> CoreEngine
startRenderLoop() -> void
_renderLoop() -> void  // â­Phase 4-C: BrushCore.renderPreview()çµ±åˆ
stopRenderLoop() -> void
flushPointerBatch() -> void
```

**å•é¡Œç‚¹**:
âŒ DrawingEngineã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯ã‚ã‚‹ãŒã€åˆæœŸåŒ–å‡¦ç†ãŒä¸æ˜ç­
âŒ DrawingEngineã¨PointerHandlerã®æ¥ç¶šãŒè¦‹å½“ãŸã‚‰ãªã„
ğŸ” this.drawingEngine = new DrawingEngine() ã ã‘ã§ã€initialize()ãŒå‘¼ã°ã‚Œã¦ã„ãªã„

---

## â–  åº§æ¨™å¤‰æ›ã‚·ã‚¹ãƒ†ãƒ 

### ğŸ“ coordinate-system.js (Phase 1.3)
**è²¬å‹™**: Screen â†’ Canvas â†’ World â†’ Local åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

**è¦ªä½¿ç”¨å…ƒ**:
- drawing-engine.js
- brush-core.js

**å­ä¾å­˜**:
- camera-system.js (worldContainerç®¡ç†)

**ä¸»è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**:
```javascript
canvas: HTMLCanvasElement
worldContainer: PIXI.Container
initialized: boolean
```

**åº§æ¨™å¤‰æ›ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
initialize(canvas, worldContainer) -> boolean
screenClientToCanvas(clientX, clientY) -> {canvasX, canvasY} | null
canvasToWorld(canvasX, canvasY) -> {worldX, worldY} | null
worldToLocal(worldX, worldY, container) -> {localX, localY} | null
transformScreenToLocal(clientX, clientY, container) -> Object | null
dumpState() -> Object
```

**åº§æ¨™å¤‰æ›ãƒ•ãƒ­ãƒ¼**:
```
PointerEvent.clientX/Y
â†’ screenClientToCanvas() [DPIè£œæ­£]
â†’ canvasToWorld() [worldContaineré€†è¡Œåˆ—]
â†’ worldToLocal() [æ‰‹å‹•é€†ç®—ãƒ»è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»]
â†’ {localX, localY}
```

**å•é¡Œç‚¹**:
âœ… Phase 1.3ã§é…å»¶åˆæœŸåŒ–å¯¾å¿œæ¸ˆã¿ (_getWorldContainer())
âš ï¸ initialize()ã¯ä¸€åº¦ã ã‘å‘¼ã°ã‚Œã‚‹å‰æã ãŒã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ¤œè¨¼å¿…è¦

---

## â–  æç”»ã‚¨ãƒ³ã‚¸ãƒ³

### ğŸ“ drawing-engine.js (Phase 1.1 v8.14.2)
**è²¬å‹™**: PointerEventå—ä¿¡ãƒ»åº§æ¨™å¤‰æ›å®Ÿè¡Œãƒ»BrushCoreã¸ã®æç”»å‘½ä»¤å§”è­²

**è¦ªä¾å­˜**:
- coordinate-system.js (CoordinateSystem)
- system/camera-system.js (cameraSystem)
- system/layer-system.js (layerManager)
- system/drawing/brush-core.js (BrushCore)
- system/drawing/pointer-handler.js (PointerHandler)

**å­ä½¿ç”¨å…ˆ**:
- core-engine.js (åˆæœŸåŒ–å‘¼ã³å‡ºã—å…ƒã€renderPreviewå‘¼ã³å‡ºã—å…ƒ)

**ä¸»è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**:
```javascript
initialized: boolean
isDrawing: boolean
currentMode: 'pen' | 'eraser' | 'fill'
coordSystem: CoordinateSystem
cameraSystem: TegakiCameraSystem
layerManager: TegakiLayerSystem
brushCore: BrushCore
pointerHandler: PointerHandler
eventBus: TegakiEventBus
glCanvas: HTMLCanvasElement
pendingPoints: Array
DEBUG_TRANSFORM: boolean
```

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
initialize(dependencies) -> boolean
_ensureCoordinateSystemReady() -> boolean
_setupPointerHandlers() -> void
_setupEventListeners() -> void
_handlePointerDown(e) -> void
_handlePointerMove(e) -> void
_handlePointerUp(e) -> void
flushPendingPoints() -> void
ğŸ”§ _transformPointerToLocal(e) -> {localX, localY, ...} | null
setBrushSettings(settings) -> void
setColor(color) -> void
setSize(size) -> void
setOpacity(opacity) -> void
setTool(tool) -> void
renderPreview() -> void
getIsDrawing() -> boolean
```

**åº§æ¨™å¤‰æ›ãƒ•ãƒ­ãƒ¼** (_transformPointerToLocal):
```
PointerEvent e
â†’ coordSystem.screenClientToCanvas(e.clientX, e.clientY)
â†’ coordSystem.canvasToWorld(canvasX, canvasY)
â†’ layerManager.getActiveLayer()
â†’ coordSystem.worldToLocal(worldX, worldY, activeLayer)
â†’ {localX, localY}
```

**å•é¡Œç‚¹**:
âŒâŒ initialize()ãƒ¡ã‚½ãƒƒãƒ‰ã¯å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒã€core-engine.jsã‹ã‚‰å‘¼ã°ã‚Œã¦ã„ãªã„
âŒâŒ PointerHandlerã®åˆæœŸåŒ–ã¨æ¥ç¶šãŒä¸å®Œå…¨
ğŸ” dependenciesã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚‹ãŒã€èª°ãŒæ¸¡ã™ã®ã‹ä¸æ˜
ğŸ” this.glCanvasãŒæ¸¡ã•ã‚Œã‚‹ã¯ãšã ãŒã€å®Ÿéš›ã«ã¯æœªè¨­å®šã®å¯èƒ½æ€§

---

### ğŸ“ pointer-handler.js (Phase 1)
**è²¬å‹™**: PointerEventçµ±ä¸€ãƒãƒ³ãƒ‰ãƒ©ï¼ˆãƒã‚¦ã‚¹ãƒ»ã‚¿ãƒƒãƒãƒ»ãƒšãƒ³å¯¾å¿œï¼‰

**è¦ªä¾å­˜**: ãªã—ï¼ˆç‹¬ç«‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰

**å­ä½¿ç”¨å…ˆ**:
- system/drawing/drawing-engine.js

**ä¸»è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**:
```javascript
element: HTMLElement
options: {preventDefault, capture}
activePointers: Map<pointerId, info>
eventHandlers: Map<eventName, Set<callback>>
attached: boolean
```

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
constructor(element, options)
on(eventName, callback) -> void  // EventEmitteré¢¨API
off(eventName, callback) -> void
_emit(eventName, ...args) -> void
_normalizeEvent(e) -> Object
_attach() -> void
detach() -> void
getActivePointers() -> Array
getPointer(pointerId) -> Object | null
```

**å•é¡Œç‚¹**:
âŒ DrawingEngineã‹ã‚‰new PointerHandler()ãŒå‘¼ã°ã‚Œã¦ã„ãªã„
âŒ PointerHandlerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆã¨æ¥ç¶šãŒæ¬ è½

---

## â–  ãƒ–ãƒ©ã‚·ã‚·ã‚¹ãƒ†ãƒ 

### ğŸ“ brush-core.js (Phase 2.2)
**è²¬å‹™**: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å‡¦ç†çµ±åˆãƒ»WebGL2æç”»çµ±åˆ

**è¦ªä¾å­˜**:
- stroke-recorder.js (åº§æ¨™è¨˜éŒ²)
- gl-stroke-processor.js (VertexBuffer/EdgeBuffer)
- gl-msdf-pipeline.js (MSDFç”Ÿæˆ)
- gl-texture-bridge.js (Spriteå¤‰æ›)
- gl-mask-layer.js (æ¶ˆã—ã‚´ãƒ ãƒã‚¹ã‚¯å‡¦ç†)
- layer-system.js (ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†)
- history.js (å±¥æ­´ç®¡ç†)
- event-bus.js (EventBus)

**å­ä½¿ç”¨å…ˆ**:
- drawing-engine.js (startStroke/updateStrokeå‘¼ã³å‡ºã—å…ƒ)
- core-engine.js (_renderLoopå†…ã§renderPreviewå‘¼ã³å‡ºã—)

**ä¸»è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**:
```javascript
strokeRecorder: StrokeRecorder
glStrokeProcessor: GLStrokeProcessor
glMSDFPipeline: GLMSDFPipeline
textureBridge: GLTextureBridge
glMaskLayer: GLMaskLayer
layerManager: TegakiLayerSystem
eventBus: TegakiEventBus
isDrawing: boolean
currentStroke: Object
previewSprite: PIXI.Sprite
previewContainer: PIXI.Container
currentSettings: {mode, color, size, opacity}
initialized: boolean
msdfAvailable: boolean
maskAvailable: boolean
```

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
async initialize() -> void
startStroke(localX, localY, pressure) -> void
async updateStroke(localX, localY, pressure) -> void
async renderPreview() -> void  // â­Phase 4-Cçµ±åˆ
async finalizeStroke() -> void
async _finalizeMSDFStroke(points, activeLayer) -> void
updateSettings(settings) -> void
setMode(mode) -> void
```

**å•é¡Œç‚¹**:
âœ… Phase 2.2ã§Spriteã‚¹ã‚±ãƒ¼ãƒ«ä¿®æ­£æ¸ˆã¿
âš ï¸ åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒcore-initializer.jsã¨core-engine.jsã§äºŒé‡ã«å‘¼ã°ã‚Œã¦ã„ã‚‹
ğŸ” window.BrushCoreã¸ã®ä¾å­˜é–¢ä¿‚è¨­å®šãŒPhase 6.1ã§è¤‡é›‘åŒ–

---

### ğŸ“ stroke-recorder.js (Phase 0å®Œæˆç‰ˆ)
**è²¬å‹™**: Localåº§æ¨™ãƒã‚¤ãƒ³ãƒˆã®è¨˜éŒ²ï¼ˆåº§æ¨™å¤‰æ›ã¯ä¸€åˆ‡è¡Œã‚ãªã„ï¼‰

**è¦ªä¾å­˜**:
- drawing-engine.js (Localåº§æ¨™å–å¾—å…ƒ)
- pressure-handler.js (ç­†åœ§ãƒ‡ãƒ¼ã‚¿) [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]
- config.js (BRUSH_SETTINGS)

**å­ä½¿ç”¨å…ˆ**:
- brush-core.js (startStroke/updateStroke/endStrokeå‘¼ã³å‡ºã—)

**ä¸»è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**:
```javascript
points: Array<{x, y, pressure, tiltX, tiltY, timestamp, ...}>
isRecording: boolean
strokeStartTime: number
currentMode: 'pen' | 'eraser'
currentColor: string
currentSize: number
initialized: boolean
totalPoints: number
totalStrokes: number
```

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
constructor(pressureHandler, cameraSystem)
initialize() -> void  // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§è‡ªå‹•åˆæœŸåŒ–æ¸ˆã¿
startStroke(localX, localY, pressure, options) -> void
addPoint(localX, localY, pressure, tiltX, tiltY) -> void
endStroke() -> Object
getRawPoints() -> Array
reset() -> void
```

**å•é¡Œç‚¹**:
âœ… Phase 0ã§è‡ªå‹•åˆæœŸåŒ–å®Œäº†
âœ… åº§æ¨™å¤‰æ›ã‚’è¡Œã‚ãªã„è¨­è¨ˆã§æ­£ã—ã„

---

## â–  WebGL2æç”»ã‚·ã‚¹ãƒ†ãƒ 

### ğŸ“ webgl2-drawing-layer.js
**è²¬å‹™**: WebGL2ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ãƒ»FBOç®¡ç†

**æƒ…å ±**: æœªèª­ã¿è¾¼ã¿ï¼ˆè¦ç¢ºèªï¼‰

**äºˆæƒ³ã•ã‚Œã‚‹ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
initialize() -> boolean
getGL() -> WebGL2RenderingContext
createFBO(width, height, options) -> FBO
deleteFBO(fbo) -> void
```

**å•é¡Œç‚¹**:
ğŸ” åˆæœŸåŒ–çŠ¶æ…‹è¦ç¢ºèª
ğŸ” glCanvaså–å¾—æ–¹æ³•è¦ç¢ºèª

---

### ğŸ“ gl-stroke-processor.js
**è²¬å‹™**: PerfectFreehand â†’ ãƒãƒªã‚´ãƒ³é ‚ç‚¹ç”Ÿæˆãƒ»GPUè»¢é€

**æƒ…å ±**: æœªèª­ã¿è¾¼ã¿ï¼ˆè¦ç¢ºèªï¼‰

**äºˆæƒ³ã•ã‚Œã‚‹ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
```javascript
initialize(gl) -> void
createPolygonVertexBuffer(points, size) -> {buffer, vertexCount}
createEdgeBuffer(points, size) -> {buffer, edgeCount}
uploadToGPU(buffer, type, stride) -> {glBuffer}
calculateBounds(points) -> {minX, minY, maxX, maxY, width, height}
```

**å•é¡Œç‚¹**:
ğŸ” åˆæœŸåŒ–çŠ¶æ…‹è¦ç¢ºèª

---

## â–  é‡å¤§ãªå•é¡Œç‚¹ã¾ã¨ã‚

### âŒâŒâŒ DrawingEngineã®åˆæœŸåŒ–æ¬ è½
**å•é¡Œ**: 
- DrawingEngine.initialize()ãƒ¡ã‚½ãƒƒãƒ‰ã¯å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒã€å‘¼ã³å‡ºã—å…ƒãŒå­˜åœ¨ã—ãªã„
- core-engine.jsã§ `this.drawingEngine = new DrawingEngine()` ã ã‘ã§çµ‚ã‚ã£ã¦ã„ã‚‹
- initialize()ã«å¿…è¦ãª dependencies ãŒæ¸¡ã•ã‚Œã¦ã„ãªã„

**å½±éŸ¿**:
- coordSystem, cameraSystem, layerManager, brushCore, pointerHandler, eventBus, glCanvas ãŒæœªè¨­å®š
- _setupPointerHandlers() ãŒå‘¼ã°ã‚Œãšã€PointerEventãŒå–å¾—ã§ããªã„
- æç”»ãŒã§ããªã„æ ¹æœ¬åŸå› 

**ä¿®æ­£å¿…è¦ç®‡æ‰€**: core-engine.js ã® initialize() ãƒ¡ã‚½ãƒƒãƒ‰

---

### âŒâŒ PointerHandlerã®åˆæœŸåŒ–æ¬ è½
**å•é¡Œ**:
- PointerHandlerã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ãªã„
- DrawingEngineã«æ¸¡ã•ã‚Œã¦ã„ãªã„
- WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**å½±éŸ¿**:
- PointerEventãŒå–å¾—ã§ããªã„
- æç”»é–‹å§‹ãŒã§ããªã„

**ä¿®æ­£å¿…è¦ç®‡æ‰€**: core-engine.js ã¾ãŸã¯ drawing-engine.js

---

### âš ï¸ CoordinateSystemã®åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°
**å•é¡Œ**:
- Phase 1.2.2ã§æ”¹å–„ã•ã‚ŒãŸãŒã€DrawingEngineã¨ã®æ¥ç¶šæ¤œè¨¼å¿…è¦
- _ensureCoordinateSystemReady()ã§è‡ªå‹•ä¿®å¾©ã‚’è©¦ã¿ã¦ã„ã‚‹ãŒæ ¹æœ¬è§£æ±ºã§ã¯ãªã„

**ç¢ºèªå¿…è¦äº‹é …**:
- worldContainerãŒç¢ºå®Ÿã«ç”Ÿæˆã•ã‚ŒãŸå¾Œã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹
- DrawingEngineãŒæ­£ã—ãCoordinateSystemã‚’å‚ç…§ã§ãã‚‹ã‹

---

### ğŸ”§ åˆæœŸåŒ–ã®å¾ªç’°ä¾å­˜å•é¡Œ
**å•é¡Œ**:
- core-initializer.js â†’ core-engine.js â†’ drawing-engine.js ã®åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼
- BrushCoreã®åˆæœŸåŒ–ãŒè¤‡æ•°ç®‡æ‰€ã§å‘¼ã°ã‚Œã‚‹ï¼ˆcore-engine.js ã¨ core-initializer.jsï¼‰
- åˆæœŸåŒ–é †åºã®ä¿è¨¼ãŒä¸å®Œå…¨

**æ”¹å–„æ–¹å‘**:
- åˆæœŸåŒ–ã‚’1ç®‡æ‰€ã«é›†ç´„
- ä¾å­˜é–¢ä¿‚ã‚’æ˜ç¢ºåŒ–
- åˆæœŸåŒ–å®Œäº†ãƒ•ãƒ©ã‚°ã§é‡è¤‡åˆæœŸåŒ–ã‚’é˜²æ­¢

---

## â–  æç”»ãƒ•ãƒ­ãƒ¼å…¨ä½“ï¼ˆç†æƒ³çŠ¶æ…‹ï¼‰

```
ã€åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚ºã€‘
1. core-initializer.js: checkDependencies()
2. core-initializer.js: buildDOM()
3. core-initializer.js: DrawingApp.initialize()
   â”œâ”€ PIXI.Application.init()
   â”œâ”€ CoreEngine.initialize()
   â”‚  â”œâ”€ CameraSystem.init() â†’ worldContainerç”Ÿæˆ
   â”‚  â”œâ”€ LayerSystem.init()
   â”‚  â”œâ”€ StrokeRecorderä½œæˆï¼ˆæ—¢ã«å­˜åœ¨ç¢ºèªï¼‰
   â”‚  â””â”€ BrushCore.init()
   â”œâ”€ CoordinateSystem.initialize(canvas, worldContainer)
   â”œâ”€ âŒ DrawingEngine.initialize(dependencies) â† å‘¼ã°ã‚Œã¦ã„ãªã„ï¼
   â”œâ”€ initializeWebGL2()
   â””â”€ startRenderLoop()

ã€æç”»ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆç†æƒ³ï¼‰ã€‘
1. WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹ã§ PointerEventç™ºç”Ÿ
2. PointerHandler._normalizeEvent() â†’ info
3. PointerHandler._emit('pointerdown', info)
4. DrawingEngine._handlePointerDown(info)
5. DrawingEngine._transformPointerToLocal(info)
   â”œâ”€ CoordinateSystem.screenClientToCanvas()
   â”œâ”€ CoordinateSystem.canvasToWorld()
   â””â”€ CoordinateSystem.worldToLocal()
6. BrushCore.startStroke(localX, localY, pressure)
7. StrokeRecorder.addPoint(localX, localY, pressure)
8. CoreEngine._renderLoop()
   â””â”€ BrushCore.renderPreview() â† Phase 4-Cçµ±åˆ
9. PointerUpæ™‚: BrushCore.finalizeStroke()
   â””â”€ GLMSDFPipeline.generateMSDF()

ã€å®Ÿéš›ã®çŠ¶æ…‹ã€‘
âŒ ã‚¹ãƒ†ãƒƒãƒ—2-4ãŒæ©Ÿèƒ½ã—ã¦ã„ãªã„ï¼ˆPointerHandleræœªåˆæœŸåŒ–ï¼‰
âŒ ã‚¹ãƒ†ãƒƒãƒ—5ãŒæ©Ÿèƒ½ã—ã¦ã„ãªã„ï¼ˆDrawingEngineæœªåˆæœŸåŒ–ï¼‰
â†’ æç”»é–‹å§‹ä¸å¯
```

---

## â–  æ”¹ä¿®å„ªå…ˆåº¦

### ğŸ”¥ æœ€å„ªå…ˆï¼ˆæç”»ä¸èƒ½ã®åŸå› ï¼‰
1. **DrawingEngine.initialize()ã®å‘¼ã³å‡ºã—è¿½åŠ **
2. **PointerHandlerã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã¨æ¥ç¶š**
3. **WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹å‚ç…§ã®ç¢ºå®Ÿãªå—ã‘æ¸¡ã—**

### ğŸ”§ é«˜å„ªå…ˆï¼ˆå®‰å®šæ€§å‘ä¸Šï¼‰
4. BrushCoreåˆæœŸåŒ–ã®ä¸€æœ¬åŒ–
5. CoordinateSystemåˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®æ¤œè¨¼
6. ä¾å­˜é–¢ä¿‚æ³¨å…¥ã®æ˜ç¢ºåŒ–

### ğŸ“ ä¸­å„ªå…ˆï¼ˆä¿å®ˆæ€§å‘ä¸Šï¼‰
7. åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼ã®æ–‡æ›¸åŒ–
8. ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰ã®æ•´å‚™
9. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–

---

## â–  ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰

```javascript
// CoordinateSystemçŠ¶æ…‹ç¢ºèª
window.CoordinateSystem.dumpState()

// DrawingEngineçŠ¶æ…‹ç¢ºèª
window.drawingEngine?.inspect()

// åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ
window.drawingEngine?.testCoordinateTransform(100, 100)

// BrushCoreçŠ¶æ…‹ç¢ºèª
console.log({
  initialized: window.BrushCore?.initialized,
  isDrawing: window.BrushCore?.isDrawing,
  msdfAvailable: window.BrushCore?.msdfAvailable,
  maskAvailable: window.BrushCore?.maskAvailable
})

// PointerHandlerç¢ºèª
console.log('PointerHandler:', window.pointerHandler || 'NOT FOUND')

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç¢ºèª
console.log({
  CoordinateSystem: !!window.CoordinateSystem,
  cameraSystem: !!window.cameraSystem,
  layerManager: !!window.layerManager,
  drawingEngine: !!window.drawingEngine,
  BrushCore: !!window.BrushCore,
  strokeRecorder: !!window.strokeRecorder
})
```