Tegaki è¨­å®šã‚·ã‚¹ãƒ†ãƒ çµ±åˆæ”¹ä¿®è¨ˆç”»æ›¸
Version: v8.13_History57 â†’ v8.13_History58
å¯¾è±¡: å¾Œç¶šClaudeå‘ã‘æ®µéšçš„æ”¹ä¿®æ‰‹é †
æ”¹ä¿®ç›®çš„
EventBusçµ±åˆã®å®Œå…¨åŒ–ã€APIçµ±ä¸€ã€è¨­å®šé©ç”¨ãƒ•ãƒ­ãƒ¼ã®ç¢ºç«‹ã«ã‚ˆã‚‹DRY/SOLIDåŸå‰‡ã®å¾¹åº•
å‰æç¢ºèªï¼ˆPhase 0ï¼‰
å®Ÿè¡Œå‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
javascript// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
console.log('EventBus:', !!window.TegakiEventBus);
console.log('BrushSettings:', !!window.TegakiDrawing?.BrushSettings);
console.log('SettingsManager:', !!window.TegakiSettingsManager);
console.log('CoreRuntime:', !!window.CoreRuntime);
console.log('DrawingEngine:', !!window.CoreRuntime?.internal?.drawingEngine);
å…¨ã¦trueã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚falseãŒã‚ã‚‹å ´åˆã¯è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿é †ã‚’ç¢ºèªã€‚

Phase 1: DrawingEngineã®EventBusçµ±åˆå®Œå…¨åŒ–
å½±éŸ¿ç¯„å›²: system/drawing/drawing-engine.jsã®ã¿
ãƒªã‚¹ã‚¯: ä½ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ã®ã¿ï¼‰
ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«: system/event-bus.js, system/drawing/brush-settings.js, system/drawing/pressure-handler.js
1-1. ç¾çŠ¶åˆ†æ
å•é¡Œç®‡æ‰€
javascript// drawing-engine.js L12-20ï¼ˆç¾çŠ¶ï¼‰
constructor(cameraSystem, layerManager, eventBus, config) {
  this.eventBus = eventBus; // ä¿æŒã¯ã—ã¦ã„ã‚‹ãŒè³¼èª­ã—ã¦ã„ãªã„
  // BrushSettings ã¯ EventBus ã‚’è³¼èª­ã—ã¦ã„ã‚‹
  this.settings = new window.TegakiDrawing.BrushSettings(config, eventBus);
}
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆç¾çŠ¶ï¼‰
```
settings-popup.js
  â†“ EventBus.emit('settings:pressure-correction')
BrushSettings.constructor
  â†“ eventBus.on('settings:pressure-correction')
BrushSettings.setPressureCorrection()
  â†“ this.pressureCorrection = value
ï¼ˆâŒã“ã“ã§æ­¢ã¾ã‚‹ã€‚PressureHandlerã«ä¼ã‚ã‚‰ãªã„ï¼‰
1-2. å®Ÿè£…æ‰‹é †
Step 1: subscribeToSettings() ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
drawing-engine.js ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æœ«å°¾ã«è¿½åŠ :
javascriptconstructor(cameraSystem, layerManager, eventBus, config) {
  // ... æ—¢å­˜ã‚³ãƒ¼ãƒ‰ ...
  
  // ğŸ†• EventBusè³¼èª­ã®åˆæœŸåŒ–
  this.subscribeToSettings();
}

subscribeToSettings() {
  if (!this.eventBus) return;
  
  // ç­†åœ§è£œæ­£ã®å¤‰æ›´ã‚’è³¼èª­
  this.eventBus.on('settings:pressure-correction', ({ value }) => {
    if (this.settings) {
      this.settings.setPressureCorrection(value);
    }
    if (this.pressureHandler) {
      this.pressureHandler.correctionFactor = value;
    }
  });
  
  // ç·šè£œæ­£ã®å¤‰æ›´ã‚’è³¼èª­
  this.eventBus.on('settings:smoothing', ({ value }) => {
    if (this.settings) {
      this.settings.setSmoothing(value);
    }
  });
  
  // ç­†åœ§ã‚«ãƒ¼ãƒ–ã®å¤‰æ›´ã‚’è³¼èª­
  this.eventBus.on('settings:pressure-curve', ({ curve }) => {
    if (this.settings) {
      this.settings.setPressureCurve(curve);
    }
    if (this.pressureHandler) {
      this.pressureHandler.curve = curve;
    }
  });
}
Step 2: PressureHandlerã«é©ç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¿½åŠ 
ç¢ºèªå¿…é ˆ: pressure-handler.js ã«ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª:
javascript// pressure-handler.js
class PressureHandler {
  constructor() {
    this.correctionFactor = 1.0; // â† ã“ã‚ŒãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    this.curve = 'linear'; // â† ã“ã‚ŒãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
  }
  
  getCorrectedPressure(rawPressure) {
    let corrected = rawPressure * this.correctionFactor; // â† ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    // ...
  }
}
å­˜åœ¨ã—ãªã„å ´åˆ: PressureHandlerã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«è¿½åŠ ã—ã€getCorrectedPressure()å†…ã§ä½¿ç”¨ã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚
1-3. æ¤œè¨¼é …ç›®
javascript// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
const engine = window.CoreRuntime.internal.drawingEngine;

// 1. subscribeToSettings ãŒå­˜åœ¨ã™ã‚‹ã‹
console.log('subscribeToSettings:', typeof engine.subscribeToSettings);

// 2. EventBusè³¼èª­ãŒå‹•ä½œã™ã‚‹ã‹
window.TegakiEventBus.emit('settings:pressure-correction', { value: 1.5 });
console.log('BrushSettings:', engine.settings.pressureCorrection); // 1.5
console.log('PressureHandler:', engine.pressureHandler?.correctionFactor); // 1.5

// 3. å®Ÿéš›ã®æç”»ã§åæ˜ ã•ã‚Œã‚‹ã‹ï¼ˆæ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼‰
// - ç­†åœ§è£œæ­£ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å¤‰æ›´
// - ãƒšãƒ³ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§æç”»
// - ç·šã®å¤ªã•ãŒå¤‰åŒ–ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
```

### 1-4. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆæ”¹ä¿®å¾Œï¼‰
```
settings-popup.js
  â†“ EventBus.emit('settings:pressure-correction', {value})
  â”œâ†’ BrushSettings.setPressureCorrection(value)
  â””â†’ DrawingEngine.subscribeToSettings()
       â””â†’ PressureHandler.correctionFactor = value
            â†“
       StrokeRecorder.recordPoint()
            â†“
       PressureHandler.getCorrectedPressure()
            â†“ rawPressure * correctionFactor
       StrokeRenderer.renderStroke()

Phase 2: CoreRuntime APIæ‹¡å¼µ
å½±éŸ¿ç¯„å›²: core-runtime.jsã®ã¿
ãƒªã‚¹ã‚¯: æ¥µä½ï¼ˆAPIãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ã®ã¿ï¼‰
ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«: system/drawing/brush-settings.js
2-1. APIè¨­è¨ˆ
åŸå‰‡

EventBusã‚’çµŒç”±ã›ãšç›´æ¥BrushSettingsã‚’æ“ä½œ
æˆ»ã‚Šå€¤ã§æˆåŠŸ/å¤±æ•—ã‚’æ˜ç¤ºï¼ˆbooleanï¼‰
å€¤ã®æ¤œè¨¼ã¯BrushSettingså´ã§è¡Œã†

2-2. å®Ÿè£…æ‰‹é †
core-runtime.js ã® api ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ :
javascriptapi: {
  // ... æ—¢å­˜ã®ãƒ¡ã‚½ãƒƒãƒ‰ ...
  
  // === è¨­å®šé–¢é€£APIï¼ˆPhase 2è¿½åŠ ï¼‰ ===
  
  setPressureCorrection(value) {
    const engine = CoreRuntime.internal.drawingEngine;
    if (!engine?.settings) return false;
    
    engine.settings.setPressureCorrection(value);
    return true;
  },
  
  setSmoothing(value) {
    const engine = CoreRuntime.internal.drawingEngine;
    if (!engine?.settings) return false;
    
    engine.settings.setSmoothing(value);
    return true;
  },
  
  setPressureCurve(curve) {
    const engine = CoreRuntime.internal.drawingEngine;
    if (!engine?.settings) return false;
    
    engine.settings.setPressureCurve(curve);
    return true;
  },
  
  // ğŸ†• è¨­å®šå–å¾—APIï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  getSettings() {
    const engine = CoreRuntime.internal.drawingEngine;
    if (!engine?.settings) return null;
    
    return engine.settings.getCurrentSettings();
  }
}
2-3. æ¤œè¨¼é …ç›®
javascript// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
const api = window.CoreRuntime.api;

// 1. APIãŒå­˜åœ¨ã™ã‚‹ã‹
console.log('setPressureCorrection:', typeof api.setPressureCorrection);
console.log('setSmoothing:', typeof api.setSmoothing);
console.log('setPressureCurve:', typeof api.setPressureCurve);
console.log('getSettings:', typeof api.getSettings);

// 2. å‹•ä½œç¢ºèª
console.log(api.setPressureCorrection(1.8)); // true
console.log(api.setSmoothing(0.7)); // true
console.log(api.setPressureCurve('ease-in')); // true

// 3. å€¤ãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹
const settings = api.getSettings();
console.log(settings);
// {
//   pressureCorrection: 1.8,
//   smoothing: 0.7,
//   pressureCurve: 'ease-in',
//   ...
// }
```

### 2-4. APIå‘¼ã³å‡ºã—çµŒè·¯
```
å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ/DevTools
  â†“
CoreRuntime.api.setPressureCorrection(1.5)
  â†“ ç›´æ¥å‘¼ã³å‡ºã—ï¼ˆEventBusçµŒç”±ã—ãªã„ï¼‰
BrushSettings.setPressureCorrection(1.5)
  â†“ EventBus.emit('brush:pressure-correction-changed')
DrawingEngine.subscribeToSettings()
  â†“
PressureHandler.correctionFactor = 1.5

Phase 3: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å®Ÿè£…ã®å®Œå…¨çµ±ä¸€
å½±éŸ¿ç¯„å›²: ui/settings-popup.js, ui/slider-utils.js
ãƒªã‚¹ã‚¯: ä¸­ï¼ˆUIå‹•ä½œã®å¤‰æ›´ï¼‰
ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«: system/event-bus.js
3-1. ç¾çŠ¶åˆ†æ
å•é¡Œç®‡æ‰€
settings-popup.js L175-254:
javascriptsetupPressureCorrectionListener() {
  const slider = document.getElementById('pressure-correction-slider');
  const valueDisplay = document.getElementById('pressure-correction-value');
  
  // ç‹¬è‡ªã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å®Ÿè£…ï¼ˆé‡è¤‡ï¼‰
  slider.addEventListener('input', (e) => { ... });
}
ui-panels.js L272-312:
javascriptcreateSlider: function(sliderId, min, max, initial, callback) {
  // åˆ¥ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å®Ÿè£…ï¼ˆé‡è¤‡ï¼‰
}
slider-utils.js:
javascript// æ—¢ã«çµ±ä¸€å®Ÿè£…ãŒå­˜åœ¨
window.SliderUtils = {
  createSlider(options) { ... }
};
3-2. å®Ÿè£…æ‰‹é †
Step 1: settings-popup.js ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
å‰Šé™¤ã™ã‚‹ç®‡æ‰€:

setupPressureCorrectionListener() ã®ç‹¬è‡ªå®Ÿè£…ï¼ˆL175-203ï¼‰
setupSmoothingListener() ã®ç‹¬è‡ªå®Ÿè£…ï¼ˆL205-233ï¼‰
setupPressureCurveListener() ã®ç‹¬è‡ªå®Ÿè£…ï¼ˆL235-254ï¼‰

ç½®ãæ›ãˆå¾Œ:
javascript// settings-popup.js
setupPressureCorrectionListener() {
  const container = document.getElementById('pressure-correction-container');
  const slider = document.getElementById('pressure-correction-slider');
  const valueDisplay = document.getElementById('pressure-correction-value');
  
  if (!slider || !valueDisplay) return;
  
  // ğŸ†• SliderUtils ã‚’ä½¿ç”¨
  window.SliderUtils.bindSlider({
    slider: slider,
    valueDisplay: valueDisplay,
    min: 0.1,
    max: 3.0,
    step: 0.1,
    initialValue: this.currentSettings.pressureCorrection || 1.0,
    formatValue: (v) => v.toFixed(1),
    onInput: (value) => {
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      this.eventBus.emit('settings:pressure-correction', { value });
    },
    onCommit: (value) => {
      // ç¢ºå®šæ™‚ã®ã¿ä¿å­˜
      this.updateSetting('pressureCorrection', value);
    }
  });
}

setupSmoothingListener() {
  const slider = document.getElementById('smoothing-slider');
  const valueDisplay = document.getElementById('smoothing-value');
  
  if (!slider || !valueDisplay) return;
  
  window.SliderUtils.bindSlider({
    slider: slider,
    valueDisplay: valueDisplay,
    min: 0.0,
    max: 1.0,
    step: 0.05,
    initialValue: this.currentSettings.smoothing || 0.5,
    formatValue: (v) => v.toFixed(2),
    onInput: (value) => {
      this.eventBus.emit('settings:smoothing', { value });
    },
    onCommit: (value) => {
      this.updateSetting('smoothing', value);
    }
  });
}
Step 2: slider-utils.js ã®æ‹¡å¼µç¢ºèª
å¿…è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª:
javascript// slider-utils.js
window.SliderUtils = {
  // æ—¢å­˜
  createSlider(options) { ... },
  
  // ğŸ†• å¿…è¦ãªã‚‰è¿½åŠ 
  bindSlider(options) {
    const { slider, valueDisplay, min, max, step, initialValue, formatValue, onInput, onCommit } = options;
    
    slider.min = min;
    slider.max = max;
    slider.step = step;
    slider.value = initialValue;
    valueDisplay.textContent = formatValue(initialValue);
    
    slider.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value);
      valueDisplay.textContent = formatValue(value);
      if (onInput) onInput(value);
    });
    
    slider.addEventListener('change', (e) => {
      const value = parseFloat(e.target.value);
      if (onCommit) onCommit(value);
    });
  }
};
3-3. æ¤œè¨¼é …ç›®
javascript// 1. SliderUtils.bindSlider ãŒå­˜åœ¨ã™ã‚‹ã‹
console.log('bindSlider:', typeof window.SliderUtils.bindSlider);

// 2. è¨­å®šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
// - ç­†åœ§è£œæ­£ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒå‹•ä½œã™ã‚‹ã‹
// - å€¤ã®è¡¨ç¤ºãŒæ›´æ–°ã•ã‚Œã‚‹ã‹
// - EventBusã«ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹ã‹

// 3. EventBusç›£è¦–
window.TegakiEventBus.on('settings:pressure-correction', (data) => {
  console.log('ç­†åœ§è£œæ­£å¤‰æ›´:', data);
});

Phase 4: localStorageæ“ä½œã®SettingsManagerå®Œå…¨ç§»ç®¡
å½±éŸ¿ç¯„å›²: ui/settings-popup.js, system/settings-manager.js
ãƒªã‚¹ã‚¯: ä¸­ï¼ˆè¨­å®šä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ã®å¤‰æ›´ï¼‰
ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«: system/event-bus.js
4-1. ç¾çŠ¶åˆ†æ
å•é¡Œç®‡æ‰€
settings-popup.js L235-244:
javascriptsaveSettings(partial) {
  const stored = localStorage.getItem('tegaki_settings');
  const current = stored ? JSON.parse(stored) : {};
  const updated = { ...current, ...partial };
  localStorage.setItem('tegaki_settings', JSON.stringify(updated));
}
âŒ å•é¡Œ: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ°¸ç¶šåŒ–å±¤ã‚’ç›´æ¥æ“ä½œã—ã¦ã„ã‚‹ï¼ˆè²¬å‹™é•åï¼‰
4-2. å®Ÿè£…æ‰‹é †
Step 1: SettingsManager ã®ç¢ºèª
settings-manager.js ãŒä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤ã‹ç¢ºèª:
javascript// system/settings-manager.js
class SettingsManager {
  updateSetting(key, value) { ... } // å¿…é ˆ
  getSetting(key) { ... } // å¿…é ˆ
  getAll() { ... } // å¿…é ˆ
  reset() { ... } // æ¨å¥¨
}
å­˜åœ¨ã—ãªã„å ´åˆ: ä»¥ä¸‹ã‚’è¿½åŠ 
javascriptclass SettingsManager {
  constructor(eventBus) {
    this.eventBus = eventBus;
    this.settings = this.loadFromStorage();
  }
  
  updateSetting(key, value) {
    this.settings[key] = value;
    this.saveToStorage();
    this.eventBus.emit(`settings:${this.toKebabCase(key)}`, { value });
  }
  
  getSetting(key) {
    return this.settings[key];
  }
  
  getAll() {
    return { ...this.settings };
  }
  
  loadFromStorage() {
    const stored = localStorage.getItem('tegaki_settings');
    return stored ? JSON.parse(stored) : this.getDefaults();
  }
  
  saveToStorage() {
    localStorage.setItem('tegaki_settings', JSON.stringify(this.settings));
  }
  
  getDefaults() {
    return {
      pressureCorrection: 1.0,
      smoothing: 0.5,
      pressureCurve: 'linear',
      statusPanelVisible: true
    };
  }
  
  toKebabCase(str) {
    return str.replace(/([A-Z])/g, '-$1').toLowerCase();
  }
}
Step 2: settings-popup.js ã®ä¿®æ­£
å‰Šé™¤ã™ã‚‹ç®‡æ‰€:
javascript// âŒ å‰Šé™¤
saveSettings(partial) {
  const stored = localStorage.getItem('tegaki_settings');
  // ...
}
ç½®ãæ›ãˆå¾Œ:
javascript// settings-popup.js
constructor(eventBus) {
  this.eventBus = eventBus;
  this.settingsManager = window.TegakiSettingsManager; // ğŸ†• å‚ç…§ã‚’ä¿æŒ
  this.currentSettings = this.settingsManager.getAll();
}

updateSetting(key, value) {
  this.settingsManager.updateSetting(key, value); // ğŸ†• SettingsManagerçµŒç”±
  this.currentSettings[key] = value; // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
}

// onCommit æ™‚ã«å‘¼ã³å‡ºã—
setupPressureCorrectionListener() {
  window.SliderUtils.bindSlider({
    // ...
    onCommit: (value) => {
      this.updateSetting('pressureCorrection', value); // ğŸ†• çµ±ä¸€APIä½¿ç”¨
    }
  });
}
Step 3: CoreRuntime ã§ã® SettingsManager åˆæœŸåŒ–ç¢ºèª
core-initializer.js ã¾ãŸã¯ core-runtime.js:
javascript// åˆæœŸåŒ–ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã§ SettingsManager ã‚’ç”Ÿæˆ
const settingsManager = new window.SettingsManager(eventBus);
window.TegakiSettingsManager = settingsManager;

CoreRuntime.internal.settingsManager = settingsManager;
4-3. æ¤œè¨¼é …ç›®
javascript// 1. SettingsManager ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹
console.log('SettingsManager:', window.TegakiSettingsManager);

// 2. è¨­å®šã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
const manager = window.TegakiSettingsManager;
manager.updateSetting('pressureCorrection', 2.0);
console.log(manager.getSetting('pressureCorrection')); // 2.0

// 3. localStorage ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹
const stored = localStorage.getItem('tegaki_settings');
console.log(JSON.parse(stored));
// { pressureCorrection: 2.0, ... }

// 4. ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã«å¾©å…ƒã•ã‚Œã‚‹ã‹
// - ãƒªãƒ­ãƒ¼ãƒ‰
// - console.log(window.TegakiSettingsManager.getSetting('pressureCorrection')); // 2.0

Phase 5: æœ€çµ‚æ¤œè¨¼ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
5-1. APIçµ±ä¸€æ€§ãƒã‚§ãƒƒã‚¯
javascript// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
const api = window.CoreRuntime.api;

// === æç”»é–¢é€£API ===
console.log('âœ“ undo:', typeof api.undo);
console.log('âœ“ redo:', typeof api.redo);
console.log('âœ“ clearCanvas:', typeof api.clearCanvas);

// === ãƒ¬ã‚¤ãƒ¤ãƒ¼é–¢é€£API ===
console.log('âœ“ addLayer:', typeof api.addLayer);
console.log('âœ“ deleteLayer:', typeof api.deleteLayer);
console.log('âœ“ selectLayer:', typeof api.selectLayer);

// === è¨­å®šé–¢é€£APIï¼ˆPhase 2è¿½åŠ ï¼‰ ===
console.log('âœ“ setPressureCorrection:', typeof api.setPressureCorrection);
console.log('âœ“ setSmoothing:', typeof api.setSmoothing);
console.log('âœ“ setPressureCurve:', typeof api.setPressureCurve);
console.log('âœ“ getSettings:', typeof api.getSettings);

// === ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–¢é€£API ===
console.log('âœ“ exportPNG:', typeof api.exportPNG);
console.log('âœ“ exportGIF:', typeof api.exportGIF);
5-2. EventBusçµ±åˆå®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯
javascript// å…¨ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒè³¼èª­ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
const eventBus = window.TegakiEventBus;

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–ï¼ˆå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
if (eventBus.setDebug) eventBus.setDebug(true);

// è¨­å®šå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç«ãƒ†ã‚¹ãƒˆ
eventBus.emit('settings:pressure-correction', { value: 1.5 });
eventBus.emit('settings:smoothing', { value: 0.7 });
eventBus.emit('settings:pressure-curve', { curve: 'ease-out' });

// è³¼èª­è€…ãŒåå¿œã—ã¦ã„ã‚‹ã‹ç¢ºèª
const engine = window.CoreRuntime.internal.drawingEngine;
console.log('BrushSettings:', engine.settings.getCurrentSettings());
console.log('PressureHandler:', engine.pressureHandler);
5-3. äºŒé‡å®Ÿè£…ãƒã‚§ãƒƒã‚¯
âŒ å‰Šé™¤æ¸ˆã¿ã‚’ç¢ºèªã™ã¹ãã‚³ãƒ¼ãƒ‰
settings-popup.js:

âœ… setupPressureCorrectionListener() ã®ç‹¬è‡ªã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å®Ÿè£…
âœ… saveSettings() ã® localStorage ç›´æ¥æ“ä½œ

ui-panels.js:

âš ï¸ createSlider() ãŒ slider-utils.js ã¨é‡è¤‡ã—ã¦ã„ãªã„ã‹ç¢ºèª

javascript// ui-panels.js ã‚’ç¢ºèª
console.log('ui-panels.createSlider:', typeof window.TegakiUI?.UIPanels?.createSlider);
console.log('SliderUtils.createSlider:', typeof window.SliderUtils?.createSlider);

// é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯ ui-panels.js ã® createSlider ã‚’å‰Šé™¤ã—ã€
// SliderUtils.createSlider ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ä¿®æ­£
5-4. åº§æ¨™ç³»æ··åœ¨ãƒã‚§ãƒƒã‚¯
javascript// coordinate-system.js ãŒæ­£ã—ãä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
const CoordSys = window.CoordinateSystem;

// æç”»ã‚¨ãƒ³ã‚¸ãƒ³ãŒ CoordinateSystem ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
const engine = window.CoreRuntime.internal.drawingEngine;
console.log('DrawingEngine uses CoordSys:', !!engine.coordSys);

// ç›´æ¥ PIXI åº§æ¨™ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒãªã„ã‹æ¤œç´¢
// âŒ ç¦æ­¢: point.x, point.y ã®ç›´æ¥ä½¿ç”¨
// âœ… æ¨å¥¨: CoordSys.toCanvas(point), CoordSys.toWorld(point)
5-5. å…¨æ©Ÿèƒ½å›å¸°ãƒ†ã‚¹ãƒˆ
æç”»æ©Ÿèƒ½

 ãƒšãƒ³ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ç­†åœ§ãŒåŠ¹ã
 ç­†åœ§è£œæ­£ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å¤ªã•ãŒå¤‰ã‚ã‚‹
 ç·šè£œæ­£ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ãŒå¤‰ã‚ã‚‹
 æ¶ˆã—ã‚´ãƒ ãƒ„ãƒ¼ãƒ«ãŒå‹•ä½œã™ã‚‹

è¨­å®šæ©Ÿèƒ½

 è¨­å®šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã
 ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åæ˜ ã•ã‚Œã‚‹
 è¨­å®šãŒlocalStorageã«ä¿å­˜ã•ã‚Œã‚‹
 ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã«è¨­å®šãŒå¾©å…ƒã•ã‚Œã‚‹

APIå‹•ä½œ

 CoreRuntime.api.setPressureCorrection(2.0) ãŒå‹•ä½œ
 CoreRuntime.api.getSettings() ã§ç¾åœ¨å€¤å–å¾—
 EventBusçµŒç”±ã®è¨­å®šå¤‰æ›´ãŒå‹•ä½œ

ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»å±¥æ­´

 Undo/Redo ãŒå‹•ä½œ
 ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ãƒ»å‰Šé™¤ãŒå‹•ä½œ
 ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”ŸãŒå‹•ä½œ


æ”¹ä¿®å®Œäº†ã®å®šç¾©
æ©Ÿèƒ½è¦ä»¶

 Phase 1: DrawingEngine ãŒ EventBus ã‚’å®Œå…¨è³¼èª­
 Phase 2: CoreRuntime.api ã«è¨­å®šé–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
 Phase 3: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å®Ÿè£…ã‚’ slider-utils.js ã«çµ±ä¸€
 Phase 4: localStorage æ“ä½œã‚’ SettingsManager ã«é›†ç´„

éæ©Ÿèƒ½è¦ä»¶

 DRYåŸå‰‡: é‡è¤‡ã‚³ãƒ¼ãƒ‰ãªã—ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã€localStorageï¼‰
 SOLIDåŸå‰‡: å˜ä¸€è²¬ä»»ï¼ˆUI/æ°¸ç¶šåŒ–å±¤ã®åˆ†é›¢ï¼‰
 APIçµ±ä¸€: å…¨ã¦ã®è¨­å®šå¤‰æ›´ãŒ CoreRuntime.api çµŒç”±ã§å¯èƒ½
 EventBusçµ±åˆ: å…¨ã¦ã®è¨­å®šå¤‰æ›´ãŒã‚¤ãƒ™ãƒ³ãƒˆçµŒç”±ã§ä¼æ’­

ã‚³ãƒ¼ãƒ‰å“è³ª

 console.log å‰Šé™¤ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æœ€å°é™ï¼‰
 äºŒé‡å®Ÿè£…ãªã—
 åº§æ¨™ç³»ã®çµ±ä¸€ï¼ˆCoordinateSystemä½¿ç”¨ï¼‰
 ã‚°ãƒ­ãƒ¼ãƒãƒ«æ±šæŸ“ã®æœ€å°åŒ–


ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
ç­†åœ§è£œæ­£ãŒåŠ¹ã‹ãªã„å ´åˆ
javascript// 1. PressureHandler ã« correctionFactor ãŒå­˜åœ¨ã™ã‚‹ã‹
const handler = window.CoreRuntime.internal.drawingEngine.pressureHandler;
console.log('correctionFactor:', handler.correctionFactor);

// 2. EventBus ãŒè³¼èª­ã•ã‚Œã¦ã„ã‚‹ã‹
const engine = window.CoreRuntime.internal.drawingEngine;
console.log('subscribeToSettings:', typeof engine.subscribeToSettings);

// 3. æ‰‹å‹•ã§ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã—ã¦ã¿ã‚‹
window.TegakiEventBus.emit('settings:pressure-correction', { value: 2.0 });
console.log('After emit:', handler.correctionFactor); // 2.0 ã«ãªã‚‹ã¯ãš
è¨­å®šãŒä¿å­˜ã•ã‚Œãªã„å ´åˆ
javascript// 1. SettingsManager ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹
console.log('SettingsManager:', window.TegakiSettingsManager);

// 2. localStorage ã‚’ç›´æ¥ç¢ºèª
console.log(localStorage.getItem('tegaki_settings'));

// 3. settings-popup.js ãŒ SettingsManager ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
// â†’ saveSettings() ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¢ºèª
ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒå‹•ä½œã—ãªã„å ´åˆ
javascript// 1. SliderUtils ãŒå­˜åœ¨ã™ã‚‹ã‹
console.log('SliderUtils:', window.SliderUtils);

// 2. DOMè¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹
const slider = document.getElementById('pressure-correction-slider');
console.log('Slider element:', slider);

// 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹
// â†’ Chrome DevTools ã® Event Listeners ã‚¿ãƒ–ã§ç¢ºèª

å¾Œç¶šClaudeå‘ã‘æŒ‡ç¤º

Phase 1ã‹ã‚‰é †ç•ªã«å®Ÿè¡Œï¼ˆã‚¹ã‚­ãƒƒãƒ—ç¦æ­¢ï¼‰
å„Phaseå®Œäº†å¾Œã€å¿…ãšæ¤œè¨¼é …ç›®ã‚’å…¨ã¦ãƒã‚§ãƒƒã‚¯
ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯è©²å½“Phaseã®ã¿ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
æ—¢å­˜æ©Ÿèƒ½ã®ç ´å£Šçš„å¤‰æ›´ã¯çµ¶å¯¾ç¦æ­¢
ã‚³ãƒ¼ãƒ‰ç”Ÿæˆæ™‚ã¯å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’æç¤ºï¼ˆçœç•¥ç¦æ­¢ï¼‰
ä¸æ˜ç‚¹ã¯å…ˆã«è³ªå•ã€æ¨æ¸¬å®Ÿè£…ç¦æ­¢
file://ã§å‹•ä½œç¢ºèªã‚’å¿˜ã‚Œãšã«

æ”¹ä¿®ä¸­ã«ç™ºè¦‹ã—ãŸå•é¡Œã¯å³å ±å‘Š:

APIä¸ä¸€è‡´ â†’ BatchAPIã§çµ±ä¸€
EventBusçµ±åˆä¸å®Œå…¨ â†’ è©²å½“ç®‡æ‰€ã‚’æŒ‡æ‘˜
äºŒé‡å®Ÿè£… â†’ DRYåŸå‰‡é•åã¨ã—ã¦å ±å‘Š
åº§æ¨™ç³»æ··åœ¨ â†’ CoordinateSystemã§çµ±ä¸€ç¢ºèª

Good luck, Claude. Keep the data flow clear and the responsibilities separated.