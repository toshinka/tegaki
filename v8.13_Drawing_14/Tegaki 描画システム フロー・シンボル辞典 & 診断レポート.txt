# Tegaki æç”»ã‚·ã‚¹ãƒ†ãƒ  ãƒ•ãƒ­ãƒ¼ãƒ»ã‚·ãƒ³ãƒœãƒ«è¾å…¸ & è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ

---

## ğŸ”´ **ã‚¨ãƒ©ãƒ¼åŸå› åˆ¤å®š**

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | è‡´å‘½åº¦ |
|--------|------|--------|
| `this.settings.getStrokeOptions is not a function` | `BrushSettings` ã«ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„ | **CRITICAL** |
| QuickAccessPopup ãŒè¡¨ç¤ºã•ã‚Œãªã„ | ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸ä¸€è‡´ | **HIGH** |
| åº§æ¨™ç³»ã®æ··åœ¨ | canvas/layer/worldåº§æ¨™ã®ç®¡ç†ãŒæ›–æ˜§ | **HIGH** |

---

## ğŸ“Š **APIä¸ä¸€è‡´ã®è©³ç´°åˆ†æ**

### âŒ **å•é¡Œ1: BrushSettings.getStrokeOptions() å­˜åœ¨ã—ãªã„**

**ç¾åœ¨ã® drawing-engine.js (è¡Œ203)**
```javascript
const strokeOptions = this.settings.getStrokeOptions();  // âŒ å®Ÿè£…ãªã—
```

**BrushSettings å®Ÿè£…**
```javascript
class BrushSettings {
  getSize()          // âœ… å®Ÿè£…æ¸ˆã¿
  getColor()         // âœ… å®Ÿè£…æ¸ˆã¿
  getAlpha()         // âœ… å®Ÿè£…æ¸ˆã¿
  getOpacity()       // âœ… å®Ÿè£…æ¸ˆã¿
  getCurrentSettings()  // âœ… å®Ÿè£…æ¸ˆã¿ï¼ˆæ¨å¥¨ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
  
  // âŒ getStrokeOptions() ãªã—ï¼
}
```

**æ—§ç‰ˆã¨ã®æ¯”è¼ƒ**

| ãƒ¡ã‚½ãƒƒãƒ‰ | æ—§ç‰ˆ(etc9) | æ–°ç‰ˆ(v8.13) | ç”¨é€” |
|---------|----------|----------|------|
| `getStrokeOptions()` | âœ… å­˜åœ¨ | âŒ ãªã— | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¸€æ‹¬å–å¾— |
| `getCurrentSettings()` | ãªã— | âœ… æ¨å¥¨ | è¨­å®šä¸€æ‹¬å–å¾— |
| `getSize()` | ã‚ã‚Š | âœ… ã‚ã‚Š | å€‹åˆ¥å–å¾— |

**ä¿®æ­£æ¡ˆ**
```javascript
// æ–°ç‰ˆã®æ¨å¥¨APIï¼ˆPhase 1è¨­è¨ˆï¼‰
const currentSettings = this.settings.getCurrentSettings();
// â†’ {size, color, alpha, opacity, minPhysicalWidth}
```

---

## ğŸ“ **åº§æ¨™ç³»ãƒ•ãƒ­ãƒ¼å›³**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº§æ¨™ç³»ã®æµã‚Œ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PointerEvent.clientX/Y
        â†“ (ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™)
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  drawing-engine.js â†’ startDrawing(screenX, screenY)  â”‚
â”‚  â€» ScreenToCanvaså¤‰æ›ãŒå¿…è¦ãªå ´æ‰€                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
  cameraSystem.screenToCanvas(screenX, screenY)
        â†“ (ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ = ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ«)
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  currentPath = recorder.startNewPath({x, y, pressure}) â”‚
â”‚  â€» ã“ã“ã‹ã‚‰å…ˆã¯å…¨ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
  this.currentPath.graphics (PIXI.Graphics)
        â†“ (ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™)
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  layerManager.addPathToActiveLayer(path)              â”‚
â”‚  â†’ layerSystem ã«çµ±åˆ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ ç¾åœ¨ã®å•é¡Œ: drawing-engine.js ã§å¤šé‡åº§æ¨™å¤‰æ›ã®å…†å€™**

---

## ğŸ“‹ **ãƒ„ãƒ¼ãƒ«ãƒ»ã‚·ãƒ³ãƒœãƒ«è¾å…¸ï¼ˆAPIå¯¾å¿œè¡¨ï¼‰**

### **1. DrawingEngine ã‚¯ãƒ©ã‚¹**

| é …ç›® | æ—§ç‰ˆ(etc9) | æ–°ç‰ˆ(v8.13) | å•é¡Œ |
|------|----------|----------|------|
| åˆæœŸåŒ– | `constructor(cameraSystem, layerManager, eventBus, config)` | `constructor(app, layerSystem, cameraSystem, historyManager)` | âš ï¸ ã‚·ã‚°ãƒãƒãƒ£å¤‰æ›´ |
| ãƒ„ãƒ¼ãƒ«åˆæœŸåŒ– | â—‡ ç›´æ¥è¨˜è¿° | â—‡ `toolManager`ä½¿ç”¨ï¼ˆPhase 1) | âœ… æ”¹å–„ |
| æç”»é–‹å§‹ | `startDrawing(x, y, pressure)` | `startDrawing(x, y, pressure)` | âœ… äº’æ› |
| ãƒ–ãƒ©ã‚·è¨­å®š | ç›´æ¥å‚ç…§ | `this.settings`ï¼ˆBrushSettings) | âœ… æ”¹å–„ |
| StrokeOptions | `getStrokeOptions()` | âŒ **ãƒ¡ã‚½ãƒƒãƒ‰ãªã—** | **ğŸ”´ CRITICAL** |
| EventBusè³¼èª­ | éƒ¨åˆ†çš„ | `subscribeToSettings()` | âœ… æ‹¡å¼µ |

---

### **2. BrushSettings ã‚¯ãƒ©ã‚¹**

| ãƒ¡ã‚½ãƒƒãƒ‰ | ç”¨é€” | æˆ»ã‚Šå€¤ | å‚™è€ƒ |
|---------|------|-------|------|
| `getSize()` | ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚ºå–å¾— | `number` | âœ… |
| `setSize(size)` | ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚ºè¨­å®š | `void` | âœ… |
| `getColor()` | è‰²å–å¾—(16é€²æ•°) | `0xRRGGBB` | âœ… |
| `setColor(color)` | è‰²è¨­å®š | `void` | âœ… |
| `getAlpha()` | é€æ˜åº¦(0.0-1.0) | `number` | âœ… |
| `setAlpha(alpha)` | é€æ˜åº¦è¨­å®š | `void` | âœ… |
| `getOpacity()` | é€æ˜åº¦(0-100%) | `number` | âœ… |
| `setOpacity(opacity)` | é€æ˜åº¦è¨­å®š(%) | `void` | âœ… |
| `getCurrentSettings()` | **å…¨è¨­å®šä¸€æ‹¬å–å¾—** | `{size, color, alpha, ...}` | âœ… **æ¨å¥¨** |
| `getStrokeOptions()` | âŒ **å­˜åœ¨ã—ãªã„** | â€” | **ğŸ”´ CRITICAL** |

---

### **3. ToolManager ã‚¯ãƒ©ã‚¹**

| ãƒ¡ã‚½ãƒƒãƒ‰ | ç”¨é€” | ä¾å­˜ | å‚™è€ƒ |
|---------|------|------|------|
| `registerTool(name, ToolClass)` | ãƒ„ãƒ¼ãƒ«ç™»éŒ² | â€” | âœ… |
| `switchTool(name, deps)` | ãƒ„ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆ | ToolBase | âœ… EventBusç™ºè¡Œ |
| `getCurrentTool()` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ„ãƒ¼ãƒ«å–å¾— | â€” | âœ… |
| `getCurrentToolName()` | ãƒ„ãƒ¼ãƒ«åå–å¾— | â€” | âœ… |
| `getRegisteredToolNames()` | ç™»éŒ²æ¸ˆã¿ãƒ„ãƒ¼ãƒ«ä¸€è¦§ | â€” | âœ… |
| `clearInstances()` | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¯ãƒªã‚¢ | â€” | âœ… |

**ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ:**
- `'tool:changed'` â†’ `{from, to, tool}`

---

### **4. StrokeRecorder ã‚¯ãƒ©ã‚¹**

| ãƒ¡ã‚½ãƒƒãƒ‰ | ç”¨é€” | åº§æ¨™ç³» | å‚™è€ƒ |
|---------|------|--------|------|
| `startStroke(x, y, pressure)` | è¨˜éŒ²é–‹å§‹ | ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ« | âœ… |
| `addPoint(x, y, pressure)` | ãƒã‚¤ãƒ³ãƒˆè¿½åŠ  | ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ« | âœ… |
| `endStroke()` | è¨˜éŒ²çµ‚äº† | â€” | âœ… `{points, isSingleDot}` |
| `getCurrentPoints()` | ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆå–å¾— | â€” | âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ |
| `getTotalDistance()` | ç·è·é›¢è¨ˆç®— | â€” | âœ… |
| `getPointCount()` | ãƒã‚¤ãƒ³ãƒˆæ•°å–å¾— | â€” | âœ… |

**åº§æ¨™ç³»æ³¨æ„:** screentolayerå¤‰æ›ã¯ `cameraSystem` ã§è¡Œã†å¿…è¦ãŒã‚ã‚‹

---

### **5. StrokeRenderer ã‚¯ãƒ©ã‚¹**

| ãƒ¡ã‚½ãƒƒãƒ‰ | ç”¨é€” | æˆ»ã‚Šå€¤ | å‚™è€ƒ |
|---------|------|-------|------|
| `setTool(tool)` | ãƒ„ãƒ¼ãƒ«è¨­å®š | `void` | âœ… 'pen'/'eraser' |
| `renderPreview(points, settings)` | ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”» | `PIXI.Graphics` | âœ… ç­†åœ§å¯¾å¿œ |
| `renderFinalStroke(strokeData, settings)` | æœ€çµ‚æç”» | `PIXI.Graphics` | âœ… |
| `renderDot(point, settings)` | å˜ç‹¬ç‚¹æç”» | `PIXI.Graphics` | âœ… å††å½¢ |
| `calculateWidth(pressure, size)` | å¹…è¨ˆç®— | `number` | âœ… ç­†åœ§åæ˜  |
| `updateResolution()` | è§£åƒåº¦æ›´æ–° | `void` | âœ… DPIå¯¾å¿œ |

**è¨­å®šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹:**
```javascript
const settings = {
  color: 0xRRGGBB,     // è‰²
  size: number,        // ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚º
  alpha: 0.0-1.0       // é€æ˜åº¦
};
```

---

### **6. StrokeDataManager ã‚¯ãƒ©ã‚¹**

| ãƒ¡ã‚½ãƒƒãƒ‰ | ç”¨é€” | EventBus | å‚™è€ƒ |
|---------|------|----------|------|
| `addStroke(strokeData)` | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯è¿½åŠ  | `'stroke:added'` | âœ… IDè‡ªå‹•ç”Ÿæˆ |
| `removeStroke(id)` | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å‰Šé™¤ | `'stroke:removed'` | âœ… |
| `updateStroke(id, data)` | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æ›´æ–° | `'stroke:updated'` | âœ… |
| `getStroke(id)` | ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å–å¾— | â€” | âœ… |
| `getAllStrokes()` | å…¨ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å–å¾— | â€” | âœ… é…åˆ— |
| `findStrokesInBounds(bounds)` | å¢ƒç•Œæ¤œç´¢ | â€” | âœ… Phase 6ã§QuadTreeåŒ– |
| `findStrokesInRadius(center, r)` | å††å½¢æ¤œç´¢ | â€” | âœ… æ¶ˆã—ã‚´ãƒ ã§ä½¿ç”¨ |
| `batchRemove(ids)` | ãƒãƒƒãƒå‰Šé™¤ | â—‡ è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆ | âš ï¸ æœ€é©åŒ–å¾…ã¡ |
| `batchAdd(data[])` | ãƒãƒƒãƒè¿½åŠ  | â—‡ è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆ | âš ï¸ æœ€é©åŒ–å¾…ã¡ |

---

## ğŸ”Œ **EventBus ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Eventç™ºè¡Œå…ƒã¨è³¼èª­è€…                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ãƒ„ãƒ¼ãƒ«é–¢é€£ã€‘
ToolManager
  â””â†’ 'tool:changed' {from, to, tool}
        â”œâ†’ ğŸ¨ drawing-engine (è³¼èª­ï¼Ÿ âš ï¸ ç¢ºèªå¿…è¦)
        â”œâ†’ ğŸ–±ï¸ keyboard-handler
        â””â†’ ğŸ–¼ï¸ UIå±¤

ã€ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–¢é€£ã€‘
StrokeDataManager
  â”œâ†’ 'stroke:added' {id, strokeData}
  â”œâ†’ 'stroke:removed' {id}
  â””â†’ 'stroke:updated' {id, strokeData}
        â”œâ†’ ğŸ“¦ drawing-engine (requestRender() å‘¼ã³å‡ºã— âœ…)
        â”œâ†’ ğŸ’¾ history
        â””â†’ ğŸ¨ layer-system

ã€è¨­å®šé–¢é€£ã€‘
UIå±¤ (è¨­å®šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãªã©)
  â”œâ†’ 'settings:pressure-correction' {value}
  â”œâ†’ 'settings:simplify-tolerance' {value}
  â”œâ†’ 'settings:smoothing-mode' {mode}
  â””â†’ ... (ãã®ä»–è¨­å®š)
        â”œâ†’ ğŸ–Œï¸ BrushSettings
        â”œâ†’ ğŸ“ StrokeRecorder
        â”œâ†’ ğŸ”„ StrokeTransformer
        â””â†’ ğŸ’ª PressureHandler

ã€ãƒ„ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆã€‘
keyboard-handler ('E' ã‚­ãƒ¼ etc)
  â””â†’ 'tool:switch' {tool}
        â””â†’ ğŸ–±ï¸ core-runtime.js â†’ toolManager.switchTool()
```

---

## ğŸ¯ **ç¾åœ¨ã®å®Ÿè£…çŠ¶æ…‹ã®å•é¡Œç‚¹**

### **ãƒ†ãƒ¼ãƒ–ãƒ«: APIçµ±åˆåº¦ãƒã‚§ãƒƒã‚¯**

| å¯¾è±¡ | APIå®šç¾© | å®Ÿè£… | ä¸€è‡´åº¦ | å•é¡Œ |
|------|--------|------|--------|------|
| **BrushSettings** | getCurrentSettings() | âœ… | âœ… | getStrokeOptions()ã‚®ãƒ£ãƒƒãƒ— |
| **DrawingEngine** | startDrawing() | âœ… | âš ï¸ | å‘¼ã³å‡ºã—ãƒ¡ã‚½ãƒƒãƒ‰ä¸ä¸€è‡´ |
| **ToolManager** | switchTool() | âœ… | âœ… | â€” |
| **StrokeRecorder** | addPoint() | âœ… | âœ… | åº§æ¨™ç³»è¦ç¢ºèª |
| **StrokeRenderer** | renderPreview() | âœ… | âœ… | â€” |
| **StrokeDataManager** | addStroke() | âœ… | âœ… | â€” |
| **EventBusè³¼èª­** | subscribeToSettings | âœ… | âš ï¸ | éƒ¨åˆ†çš„ |
| **PopupManager** | show(name) | âœ… | âŒ | å‹•çš„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å®Ÿè£…ä¸­ |

---

## ğŸ› ï¸ **ä¿®æ­£å¯¾å¿œè¡¨**

### **ä¿®æ­£1: BrushSettings API çµ±ä¸€**

**ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ (line 203 drawing-engine.js)**
```javascript
const strokeOptions = this.settings.getStrokeOptions();  // âŒ 
```

**ä¿®æ­£æ¡ˆA: getCurrentSettings()ã‚’ä½¿ç”¨ (æ¨å¥¨)**
```javascript
const currentSettings = this.settings.getCurrentSettings();
const strokeOptions = {
  size: currentSettings.size,
  color: currentSettings.color,
  alpha: currentSettings.alpha
};
```

**ä¿®æ­£æ¡ˆB: getStrokeOptions()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ **
```javascript
// BrushSettings ã«è¿½åŠ 
getStrokeOptions() {
  return {
    size: this.size,
    color: this.color,
    alpha: this.alpha,
    minPhysicalWidth: this.minPhysicalWidth
  };
}
```

**æ¨å¥¨: ä¿®æ­£æ¡ˆA** (æ—¢å­˜APIæ´»ç”¨ã€DRYåŸå‰‡)

---

### **ä¿®æ­£2: PopupManager ã®å‹•çš„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¯¾å¿œ**

**ç¾åœ¨ã®ç—‡çŠ¶**
```
popup-manager.js:192 ğŸ‘ï¸ Popup "quickAccess" shown    â† ã‚¤ãƒ™ãƒ³ãƒˆå‡ºåŠ›
popup-manager.js:212 ğŸ™ˆ Popup "quickAccess" hidden   â† ã™ãéè¡¨ç¤º
```

**åŸå› æ¨æ¸¬:**
- `show(name)` å¾Œã« `hide(name)` ãŒè‡ªå‹•å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹
- ã¾ãŸã¯ DOMæŒ¿å…¥ãŒè¡Œã‚ã‚Œã¦ã„ãªã„

**ç¢ºèªé …ç›®:**
1. `popup-manager.js` ã® `show()` å®Ÿè£…ã‚’ç¢ºèª
2. `quick-access-popup.js` ã® DOMæ§‹é€ ç¢ºèª
3. `core-runtime.js` ã§ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”Ÿæˆãƒ»è¡¨ç¤ºé †åºç¢ºèª

---

## ğŸ“¦ **ãƒ•ã‚¡ã‚¤ãƒ«ä¾å­˜é–¢ä¿‚ï¼ˆç¾çŠ¶ï¼‰**

```
drawing-engine.js
â”œâ”€ app âœ…
â”œâ”€ layerSystem (layerManager) âœ…
â”œâ”€ cameraSystem âœ…
â”œâ”€ historyManager âœ…
â”œâ”€ BrushSettings âœ…
â”‚  â””â”€ config.js
â”‚  â””â”€ eventBus
â”œâ”€ StrokeRecorder âŒ (åˆæœŸåŒ–ãªã—ï¼Ÿ)
â”œâ”€ StrokeRenderer âŒ (åˆæœŸåŒ–ãªã—ï¼Ÿ)
â”œâ”€ PressureHandler âŒ (åˆæœŸåŒ–ãªã—ï¼Ÿ)
â”œâ”€ StrokeTransformer âŒ (åˆæœŸåŒ–ãªã—ï¼Ÿ)
â”œâ”€ ToolManager âœ… (æ–°è¦: Phase 1)
â”œâ”€ StrokeDataManager âœ… (æ–°è¦: Phase 1)
â””â”€ EventBus âœ…

popup-manager.js
â”œâ”€ DOMæ“ä½œ
â”œâ”€ dynamicPopups âŒ (å®Ÿè£…çŠ¶æ…‹ä¸æ˜)
â””â”€ show/hide ãƒ­ã‚¸ãƒƒã‚¯
```

---

## âœ… **æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£é †åº**

### **Priority 1 (å³ä¿®æ­£)**

1. **drawing-engine.js line 203**
   - `getStrokeOptions()` â†’ `getCurrentSettings()` ã«ç½®ãæ›ãˆ
   - å½±éŸ¿åº¦: CRITICAL (ã‚¨ãƒ©ãƒ¼æ­¢ã‚)

2. **StrokeRecorder åˆæœŸåŒ–ç¢ºèª**
   - `screenToLayer()` vs `screenToCanvas()` åº§æ¨™ç³»çµ±ä¸€
   - å½±éŸ¿åº¦: HIGH (åº§æ¨™ç³»å´©å£Šé˜²æ­¢)

### **Priority 2 (æ¬¡ãƒ•ã‚§ãƒ¼ã‚º)**

3. **PopupManager ãƒ‡ãƒãƒƒã‚°**
   - å‹•çš„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã® show/hide ã‚¿ã‚¤ãƒŸãƒ³ã‚°ç¢ºèª
   - DOMæŒ¿å…¥ç¢ºèª
   - å½±éŸ¿åº¦: MEDIUM (UIå‹•ä½œ)

4. **EventBus è³¼èª­å®Œå…¨æ€§**
   - `'tool:changed'` ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ã®ç¢ºèª
   - drawing-engine å´ã®è³¼èª­å®Ÿè£…ç¢ºèª
   - å½±éŸ¿åº¦: HIGH (ãƒ„ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆå‹•ä½œ)

### **Priority 3 (çµ±åˆãƒ†ã‚¹ãƒˆ)**

5. **åº§æ¨™ç³»çµ±ä¸€ãƒ†ã‚¹ãƒˆ**
   - screenToCanvas vs screenToLayer ã®æ˜ç¢ºåŒ–
   - å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã§åŒã˜å®šç¾©ã‚’ä½¿ç”¨
   - å½±éŸ¿åº¦: HIGH (æ ¹æœ¬å•é¡Œ)

6. **APIå‘½åè¦å‰‡çµ±ä¸€**
   - getStrokeOptions() ã®çµ±ä¸€å®Ÿè£…
   - å‚ç…§è¡¨ã‚’ä½œæˆï¼ˆå¯è¦–åŒ–ï¼‰
   - å½±éŸ¿åº¦: MEDIUM (ä¿å®ˆæ€§å‘ä¸Š)

---

## ğŸ“„ **å‚è€ƒ: å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

- âœ… `get*()` ãƒ¡ã‚½ãƒƒãƒ‰: getterï¼ˆå‰¯ä½œç”¨ãªã—ï¼‰
- âœ… `set*()` ãƒ¡ã‚½ãƒƒãƒ‰: setterï¼ˆå˜ä¸€è²¬å‹™ï¼‰
- âœ… EventBus ã‚¤ãƒ™ãƒ³ãƒˆå: `'domain:action'` å½¢å¼
- âœ… ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ID: `'stroke_123'` å½¢å¼
- âœ… ãƒ„ãƒ¼ãƒ«å: `'pen'` / `'eraser'`ï¼ˆå°æ–‡å­—ï¼‰
- âŒ `get*Options()` vs `getCurrentSettings()` æ··åœ¨ï¼ˆè¦çµ±ä¸€ï¼‰

---

## ğŸ“ **çµè«–**

| å•é¡Œ | æ ¹æœ¬åŸå›  | å¯¾ç­– | å„ªå…ˆåº¦ |
|------|---------|------|--------|
| ãƒšãƒ³æç”»ã‚¨ãƒ©ãƒ¼ | BrushSettings APIä¸ä¸€è‡´ | `getCurrentSettings()` ä½¿ç”¨ | **P1** |
| ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—éè¡¨ç¤º | popup-managerå®Ÿè£…å•é¡Œ | ãƒ‡ãƒãƒƒã‚°ãƒ»DOMç¢ºèª | **P2** |
| åº§æ¨™ç³»æ··åœ¨ | è¤‡æ•°åº§æ¨™ç³»å®šç¾©ã®ä½¿ã„åˆ†ã‘æ›–æ˜§ | screenToLayerçµ±ä¸€ | **P1** |
| APIæ–­ç‰‡åŒ– | ãƒ¡ã‚½ãƒƒãƒ‰å‘½åä¸ä¸€è‡´ | ã‚·ãƒ³ãƒœãƒ«è¾å…¸ä½œæˆãƒ»çµ±ä¸€ | **P3** |