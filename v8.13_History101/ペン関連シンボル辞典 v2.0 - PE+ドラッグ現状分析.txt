# ãƒšãƒ³é–¢é€£ã‚·ãƒ³ãƒœãƒ«è¾å…¸ v2.0 - P/E+ãƒ‰ãƒ©ãƒƒã‚°ç¾çŠ¶åˆ†æ

## ğŸ“Š ç¾çŠ¶ã‚µãƒãƒªãƒ¼

### âœ… å®Ÿè£…æ¸ˆã¿
- BrushSettings: ã‚µã‚¤ã‚º/ä¸é€æ˜åº¦ç®¡ç†
- DrawingEngine: tool:size-opacity-changedè³¼èª­
- ToolSizeManager: drag-size-updateâ†’size-opacity-changedå¤‰æ›
- KeyboardHandler: P/E+ãƒ‰ãƒ©ãƒƒã‚°æ¤œå‡ºã€ç´¯ç©deltaè¨ˆç®—
- DragVisualFeedback: ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º

### âŒ å•é¡Œç‚¹
1. **ToolSizeManagerãŒBrushSettingsã‚’å–å¾—ã§ããªã„**
   - `_getBrushSettings()`ãŒ`window.drawingEngine.settings`ã®ã¿ã‚’å‚ç…§
   - åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§`window.drawingEngine`ãŒæœªå®šç¾©
   
2. **DrawingEngineã®å‚ç…§ãƒ‘ã‚¹ä¸çµ±ä¸€**
   - `window.drawingEngine` (ToolSizeManager)
   - `window.drawingApp.drawingEngine` (ãƒ¬ã‚¬ã‚·ãƒ¼)
   - `window.CoreRuntime.internal.drawingEngine` (æ–°)

3. **ãƒ„ãƒ¼ãƒ«çŠ¶æ…‹ã®äºŒé‡ç®¡ç†**
   - ToolSizeManagerãŒç‹¬è‡ªã«`penSize/penOpacity`ã‚’ä¿æŒ
   - BrushSettingsã‚‚åŒã˜å€¤ã‚’ä¿æŒ
   - åŒæœŸãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡é›‘

---

## ğŸ” 1. BrushSettings (system/drawing/brush-settings.js)

### ã‚¯ãƒ©ã‚¹å®šç¾©
```javascript
class BrushSettings {
  // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
  size: number                  // â˜… ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚º
  color: number                 // â˜… ãƒ–ãƒ©ã‚·è‰² (0xRRGGBB)
  opacity: number               // â˜… ä¸é€æ˜åº¦ (0.0-1.0)
  thinning: number
  smoothing: number
  streamline: number
  pressureCorrection: number
  // ...ä»–è¨­å®š
}
```

### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰
- `getBrushSize()` â†’ number
- `setBrushSize(size)` â†’ emit('brushSizeChanged')
- `getBrushOpacity()` â†’ number
- `setBrushOpacity(opacity)` â†’ emit('brushOpacityChanged')
- `getCurrentSettings()` â†’ Object

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
```javascript
window.TegakiDrawing.BrushSettings = BrushSettings
window.BrushSettings = BrushSettings
globalThis.BrushSettings = BrushSettings
```

---

## ğŸ” 2. DrawingEngine (system/drawing/drawing-engine.js)

### åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼
```javascript
constructor(cameraSystem, layerManager, eventBus, config) {
  this._initializeBrushSettings()  // åŒæœŸçš„ã«BrushSettingsç”Ÿæˆ
  this.settings = new BrushSettings(config, eventBus)
  // ...
  this.subscribeToSettings()       // ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
}
```

### ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
```javascript
subscribeToSettings() {
  // â˜… P/E+ãƒ‰ãƒ©ãƒƒã‚°å¯¾å¿œ
  this.eventBus.on('tool:size-opacity-changed', ({ tool, size, opacity }) => {
    if (!tool || tool === this.currentTool) {
      if (size !== undefined) {
        this.settings.setBrushSize(size)
      }
      if (opacity !== undefined) {
        this.settings.setBrushOpacity(opacity)
      }
    }
  })
  
  // ä»–ã®è¨­å®šã‚¤ãƒ™ãƒ³ãƒˆ...
}
```

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
```javascript
window.TegakiDrawing.DrawingEngine = DrawingEngine
```

### å‚ç…§ãƒ‘ã‚¹ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›ï¼‰
- `window.drawingApp.drawingEngine`
- `window.coreEngine.drawingEngine`
- `window.CoreRuntime.internal.drawingEngine`

---

## ğŸ” 3. ToolSizeManager (system/tool-size-manager.js)

### å½¹å‰²
P/E+ãƒ‰ãƒ©ãƒƒã‚°ã®deltaå€¤ã‚’å®Ÿéš›ã®size/opacityã«å¤‰æ›ã—ã€`tool:size-opacity-changed`ã‚’ç™ºè¡Œ

### å•é¡Œã®ã‚ã‚‹å®Ÿè£…
```javascript
_getBrushSettings() {
  // âŒ window.drawingEngine ã®ã¿ã‚’å‚ç…§
  if (!window.drawingEngine?.settings) {
    return null
  }
  return window.drawingEngine.settings
}
```

### æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ
```javascript
// ãƒ„ãƒ¼ãƒ«çŠ¶æ…‹ã¯ç‹¬è‡ªã«ä¿æŒã›ãšã€BrushSettingsã‹ã‚‰å–å¾—ã™ã¹ã
this.eventBus.on('tool:drag-size-start', (data) => {
  // é–‹å§‹å€¤ã‚’BrushSettingsã‹ã‚‰å–å¾—
  const brushSettings = this._getBrushSettings()
  this.dragState = {
    tool: data.tool,
    startSize: data.startSize,      // KeyboardHandlerã‹ã‚‰æ¸¡ã•ã‚Œã‚‹
    startOpacity: data.startOpacity // KeyboardHandlerã‹ã‚‰æ¸¡ã•ã‚Œã‚‹
  }
})

this.eventBus.on('tool:drag-size-update', (data) => {
  // deltaã‹ã‚‰æ–°ã—ã„å€¤ã‚’è¨ˆç®—
  const newSize = clamp(
    this.dragState.startSize + data.deltaX * sensitivity,
    min, max
  )
  const newOpacity = clamp(
    this.dragState.startOpacity - data.deltaY * sensitivity,
    min, max
  )
  
  // BrushSettingsã«åæ˜ 
  this._updateBrushSettings(newSize, newOpacity)
  
  // tool:size-opacity-changedã‚’ç™ºè¡Œï¼ˆDrawingEngine/DragVisualFeedbackå‘ã‘ï¼‰
  this.eventBus.emit('tool:size-opacity-changed', {
    tool: data.tool,
    size: newSize,
    opacity: newOpacity
  })
})
```

---

## ğŸ” 4. KeyboardHandler (ui/keyboard-handler.js)

### ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ç®¡ç†
```javascript
const dragState = {
  pKeyPressed: boolean,      // Pã‚­ãƒ¼æŠ¼ä¸‹ä¸­
  eKeyPressed: boolean,      // Eã‚­ãƒ¼æŠ¼ä¸‹ä¸­
  isDragging: boolean,       // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
  dragStartX: number,        // é–‹å§‹Xåº§æ¨™ï¼ˆç”»é¢åº§æ¨™ï¼‰
  dragStartY: number,        // é–‹å§‹Yåº§æ¨™ï¼ˆç”»é¢åº§æ¨™ï¼‰
  activeTool: 'pen'|'eraser'|null
}
```

### ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ãƒ•ãƒ­ãƒ¼
```javascript
// 1. ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³
handleMouseDown(e) {
  dragState.dragStartX = e.clientX
  dragState.dragStartY = e.clientY
  
  const brushSettings = getBrushSettings()
  const startSize = brushSettings.getBrushSize()
  const startOpacity = brushSettings.getBrushOpacity()
  
  // â˜… ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã‚’é€šçŸ¥
  TegakiEventBus.emit('tool:drag-size-start', {
    tool: dragState.activeTool,
    startSize,
    startOpacity
  })
  
  dragState.isDragging = true
}

// 2. ãƒã‚¦ã‚¹ç§»å‹•
handleMouseMove(e) {
  // â˜… é–‹å§‹ä½ç½®ã‹ã‚‰ã®ç´¯ç©å·®åˆ†
  const deltaX = e.clientX - dragState.dragStartX
  const deltaY = e.clientY - dragState.dragStartY
  
  TegakiEventBus.emit('tool:drag-size-update', {
    tool: dragState.activeTool,
    deltaX,  // ç´¯ç©å·®åˆ†ï¼ˆå‰å›å·®åˆ†ã§ã¯ãªã„ï¼‰
    deltaY
  })
}

// 3. ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—
handleMouseUp(e) {
  TegakiEventBus.emit('tool:drag-size-end')
  dragState.isDragging = false
}
```

### BrushSettingså–å¾—ãƒ­ã‚¸ãƒƒã‚¯
```javascript
function getBrushSettings() {
  const candidates = [
    window.coreEngine?.drawingEngine,
    window.drawingApp?.drawingEngine,
    window.CoreEngine?.drawingEngine,
    window.drawingEngine
  ]
  
  for (const c of candidates) {
    if (c?.settings) return c.settings        // â˜… settingsã‚’å„ªå…ˆ
    if (c?.brushSettings) return c.brushSettings
  }
  return null
}
```

---

## ğŸ” 5. DragVisualFeedback (ui/drag-visual-feedback.js)

### ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
```javascript
_setupEventListeners() {
  this.eventBus.on('tool:drag-size-start', (data) => {
    this._handleDragStart(data)  // è¡¨ç¤ºé–‹å§‹
  })
  
  this.eventBus.on('tool:size-opacity-changed', (data) => {
    this._handleDragUpdate(data) // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ›´æ–°
  })
  
  this.eventBus.on('tool:drag-size-end', () => {
    this._handleDragEnd()        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
  })
  
  // ã‚«ãƒ¼ã‚½ãƒ«è¿½å¾“
  document.addEventListener('mousemove', (e) => {
    this.currentX = e.clientX
    this.currentY = e.clientY
    if (this.isActive) this._updatePosition()
  })
}
```

---

## ğŸ” 6. CoreRuntime (core-runtime.js)

### DrawingEngineå‚ç…§ã®è¨­å®š
```javascript
setupLegacyCompatibility() {
  window.drawingApp = {
    pixiApp: this.internal.app,
    cameraSystem: this.internal.cameraSystem,
    layerManager: this.internal.layerManager,
    drawingEngine: this.internal.drawingEngine,  // â˜…ã“ã“ã«æ ¼ç´
    app: this.internal.app
  }
}
```

### PointerEventå‡¦ç†ï¼ˆPhase 12ï¼‰
```javascript
handlePointerDown(event) {
  // â˜… P/Eã‚­ãƒ¼æŠ¼ä¸‹ä¸­ã¯ã‚µã‚¤ã‚ºå¤‰æ›´ãƒ¢ãƒ¼ãƒ‰
  if (window.KeyboardHandler) {
    const debugState = window.KeyboardHandler.getDebugState?.()
    if (debugState && (debugState.pKeyPressed || debugState.eKeyPressed)) {
      return  // æç”»ã—ãªã„
    }
  }
  
  // é€šå¸¸ã®æç”»å‡¦ç†
  const screenX = event.global.x
  const screenY = event.global.y
  this.internal.drawingEngine.startDrawing(screenX, screenY, event)
}
```

---

## ğŸ¯ å•é¡Œã®æ ¹æœ¬åŸå› 

### 1. åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å•é¡Œ
```
// ç¾åœ¨ã®åˆæœŸåŒ–é †åº
1. BrushSettingsç”Ÿæˆ (drawing-engine.js)
2. ToolSizeManagerç”Ÿæˆ (core-initializer.js)
3. CoreRuntime.setupLegacyCompatibility()
   â†’ window.drawingApp.drawingEngineè¨­å®š
```

**ToolSizeManagerç”Ÿæˆæ™‚ã€`window.drawingEngine`ã¯æœªå®šç¾©**

### 2. å‚ç…§ãƒ‘ã‚¹ã®ä¸çµ±ä¸€
```javascript
// ToolSizeManager
window.drawingEngine.settings  // âŒ å­˜åœ¨ã—ãªã„

// KeyboardHandler
window.coreEngine?.drawingEngine.settings     // âœ…
window.drawingApp?.drawingEngine.settings     // âœ…
```

### 3. ãƒ„ãƒ¼ãƒ«çŠ¶æ…‹ã®äºŒé‡ç®¡ç†
```javascript
// ToolSizeManager
this.penSize = 10
this.penOpacity = 0.85

// BrushSettings
this.size = 10
this.opacity = 0.85

// åŒæœŸå‡¦ç†
_updateBrushSettings(size, opacity) {
  brushSettings.setBrushSize(size)
  brushSettings.setBrushOpacity(opacity)
}

// ã•ã‚‰ã«ToolSizeManagerã§ã‚‚ä¿æŒ
if (data.tool === 'pen') {
  this.penSize = newSize
  this.penOpacity = newOpacity
}
```

â†’ ãƒ‡ãƒ¼ã‚¿ã®æ‰€æœ‰æ¨©ãŒæ›–æ˜§

---

## ğŸ”§ æ”¹ä¿®æ–¹é‡

### SOLIDåŸå‰‡ã«åŸºã¥ãè²¬å‹™åˆ†é›¢

#### 1. BrushSettings (ãƒ‡ãƒ¼ã‚¿ä¿æŒ)
- ã‚µã‚¤ã‚º/ä¸é€æ˜åº¦/è‰²ã®**å”¯ä¸€ã®æƒ…å ±æº**
- ãƒ„ãƒ¼ãƒ«ã”ã¨ã®çŠ¶æ…‹ã¯æŒãŸãªã„ï¼ˆå¸¸ã«ç¾åœ¨å€¤ã®ã¿ï¼‰
- EventBusçµŒç”±ã§å¤‰æ›´ã‚’é€šçŸ¥

#### 2. ToolSizeManager (è¨ˆç®—ãƒ»å¤‰æ›)
- ãƒ‰ãƒ©ãƒƒã‚°delta â†’ size/opacityå¤‰æ›
- **çŠ¶æ…‹ã¯ä¸€æ™‚çš„ãªdragStateã®ã¿ä¿æŒ**
- BrushSettingsã‹ã‚‰ç¾åœ¨å€¤ã‚’å–å¾—
- è¨ˆç®—çµæœã‚’BrushSettingsã«åæ˜ 

#### 3. DrawingEngine (æç”»çµ±åˆ)
- BrushSettingsã‚’ä¿æŒï¼ˆ`this.settings`ï¼‰
- tool:size-opacity-changedã‚’è³¼èª­
- æç”»æ™‚ã«settings.getStrokeOptions()ã‚’ä½¿ç”¨

#### 4. KeyboardHandler (å…¥åŠ›æ¤œå‡º)
- ã‚­ãƒ¼/ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆæ¤œå‡º
- BrushSettingsã‹ã‚‰é–‹å§‹å€¤ã‚’å–å¾—
- tool:drag-size-startã‚’ç™ºè¡Œ

### å‚ç…§ãƒ‘ã‚¹çµ±ä¸€

```javascript
// ToolSizeManager
_getBrushSettings() {
  // è¤‡æ•°ãƒ‘ã‚¹ã‚’è©¦è¡Œï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  const sources = [
    () => window.drawingApp?.drawingEngine?.settings,
    () => window.coreEngine?.drawingEngine?.settings,
    () => window.CoreRuntime?.internal?.drawingEngine?.settings
  ]
  
  for (const fn of sources) {
    try {
      const settings = fn()
      if (settings) return settings
    } catch {}
  }
  
  return null
}
```

---

## ğŸ“‹ æ”¹ä¿®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### system/tool-size-manager.js
- [ ] `_getBrushSettings()`ã‚’è¤‡æ•°ãƒ‘ã‚¹å¯¾å¿œã«ä¿®æ­£
- [ ] `penSize/penOpacity/eraserSize/eraserOpacity`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‰Šé™¤
- [ ] ãƒ„ãƒ¼ãƒ«çŠ¶æ…‹ç®¡ç†ã‚’dragStateã®ã¿ã«é™å®š
- [ ] `_updateBrushSettings()`ã‚’ç°¡ç´ åŒ–

### ui/keyboard-handler.js
- [ ] `getBrushSettings()`ã®å‚ç…§ãƒ‘ã‚¹é †åºç¢ºèª
- [ ] P/E+ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®æç”»é˜²æ­¢ç¢ºèª

### system/drawing/drawing-engine.js
- [ ] `subscribeToSettings()`ã§tool:size-opacity-changedè³¼èª­ç¢ºèª
- [ ] toolãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ç¢ºèª

### core-runtime.js
- [ ] `window.drawingEngine`ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²è¿½åŠ ï¼ˆäº’æ›æ€§ï¼‰
- [ ] PointerEventå‡¦ç†ã§P/Eåˆ¤å®šç¢ºèª

### ui/drag-visual-feedback.js
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ç¢ºèª
- [ ] ã‚«ãƒ¼ã‚½ãƒ«è¿½å¾“ç¢ºèª

---

## ğŸ“ è¨­è¨ˆåŸå‰‡ã®éµå®ˆ

### DRY (Don't Repeat Yourself)
- âŒ ãƒ„ãƒ¼ãƒ«çŠ¶æ…‹ã‚’ToolSizeManagerã¨BrushSettingsã§äºŒé‡ç®¡ç†
- âœ… BrushSettingsã‚’å”¯ä¸€ã®æƒ…å ±æºã¨ã™ã‚‹

### SRP (Single Responsibility Principle)
- BrushSettings: è¨­å®šå€¤ã®ä¿æŒã®ã¿
- ToolSizeManager: ãƒ‰ãƒ©ãƒƒã‚°è¨ˆç®—ãƒ»å¤‰æ›ã®ã¿
- DrawingEngine: æç”»çµ±åˆã®ã¿
- KeyboardHandler: å…¥åŠ›æ¤œå‡ºã®ã¿

### OCP (Open/Closed Principle)
- BrushSettingsã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æŠ½è±¡åŒ–ï¼ˆ_getBrushSettingsï¼‰
- æ–°ã—ã„å‚ç…§ãƒ‘ã‚¹è¿½åŠ ãŒå®¹æ˜“

### LSP (Liskov Substitution Principle)
- EventBusçµŒç”±ã®ç–çµåˆ
- å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ç‹¬ç«‹ã—ã¦å‹•ä½œå¯èƒ½

### ISP (Interface Segregation Principle)
- æœ€å°é™ã®APIã®ã¿å…¬é–‹
- getBrushSize/setBrushSizeãªã©æ˜ç¢ºãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### DIP (Dependency Inversion Principle)
- å…·ä½“çš„ãªå®Ÿè£…ã§ã¯ãªãEventBusã«ä¾å­˜
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®ç›´æ¥å‚ç…§ã‚’æœ€å°åŒ–

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. ToolSizeManageræ”¹ä¿®ï¼ˆ_getBrushSettingsæ”¹å–„ã€çŠ¶æ…‹å‰Šé™¤ï¼‰
2. CoreRuntimeæ”¹ä¿®ï¼ˆwindow.drawingEngineè¿½åŠ ï¼‰
3. å‹•ä½œç¢ºèªï¼ˆP+ãƒ‰ãƒ©ãƒƒã‚°ã€E+ãƒ‰ãƒ©ãƒƒã‚°ï¼‰
4. ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ç¢ºèªï¼ˆåˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€ãƒ„ãƒ¼ãƒ«åˆ‡æ›¿ï¼‰