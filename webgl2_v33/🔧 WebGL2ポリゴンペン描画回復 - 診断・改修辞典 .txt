================================================================================
WebGL2ãƒãƒªã‚´ãƒ³ãƒšãƒ³æç”»å›å¾© - è¨ºæ–­ãƒ»æ”¹ä¿®è¾å…¸
Version: 2025-01-21
Target: webgl2_v32
================================================================================

## ç›®æ¬¡
1. ç¾çŠ¶ã‚¨ãƒ©ãƒ¼è¨ºæ–­
2. ãƒ•ã‚¡ã‚¤ãƒ«è²¬å‹™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹
3. åº§æ¨™å¤‰æ›ãƒ•ãƒ­ãƒ¼ãƒã‚§ãƒ¼ãƒ³
4. å•é¡Œç®‡æ‰€ç‰¹å®š
5. æ®µéšçš„æ”¹ä¿®ãƒ—ãƒ©ãƒ³
6. å®Œå…¨å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

================================================================================

## 1. ç¾çŠ¶ã‚¨ãƒ©ãƒ¼è¨ºæ–­

### ã‚¨ãƒ©ãƒ¼å†…å®¹
```
[CoordinateSystem] âŒ worldToLocal: container not child of worldContainer
{containerLabel: 'layer_1763671591612_c974yx273', chainLength: 5}
[DrawingEngine] worldToLocal failed
[DrawingEngine] Failed to transform pointer coords on pointerdown
```

### ğŸ”´ æ ¹æœ¬åŸå› 
LayerSystemãŒè¿”ã™`activeLayer`ãŒ`worldContainer`ã®å­ã§ã¯ãªãã€åˆ¥ã®è¦ªã‚³ãƒ³ãƒ†ãƒŠæ§‹é€ ã«å±ã—ã¦ã„ã‚‹ã€‚
åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯`worldContainer`ç›´ä¸‹ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰æã«è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ãŒã€å®Ÿéš›ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ãŒç•°ãªã‚‹ã€‚

### âš ï¸ æ§‹é€ çš„å•é¡Œ
1. `currentFrameContainer` â‰  `worldContainer`
2. LayerSystemã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯`currentFrameContainer`ã«å±ã™ã‚‹
3. CoordinateSystemã¯`worldContainer`ç›´ä¸‹ã‚’æƒ³å®š
4. è¦ªå­é–¢ä¿‚ã®ãƒŸã‚¹ãƒãƒƒãƒãŒåº§æ¨™å¤‰æ›å¤±æ•—ã‚’å¼•ãèµ·ã“ã™

================================================================================

## 2. ãƒ•ã‚¡ã‚¤ãƒ«è²¬å‹™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

### åº§æ¨™å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (æœ€é‡è¦)

ğŸ“ **coordinate-system.js** (ç´”ç²‹æ•°å­¦è¨ˆç®—å±¤)
- è²¬å‹™: Screenâ†’Canvasâ†’Worldâ†’Local ã®å¤‰æ›è¨ˆç®—ã®ã¿
- ä¾å­˜: canvas (HTMLElement), worldContainer (PIXI.Container)
- ç¦æ­¢: PIXIå†…éƒ¨é–¢æ•°ã€updateTransform()ã€toLocal/toGlobal()
- ã‚°ãƒ­ãƒ¼ãƒãƒ«: `window.CoordinateSystem`
- Phase: 1.6 (ç´”ç²‹æ•°å­¦è¨ˆç®—ç‰ˆ)
- çŠ¶æ…‹: âœ… è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã¯æ­£å¸¸ / âš ï¸ worldContainerå‰æãŒå•é¡Œ

ğŸ“ **drawing-engine.js** (ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†å±¤)
- è²¬å‹™: PointerEventå—ä¿¡â†’åº§æ¨™å¤‰æ›å‘¼ã³å‡ºã—â†’BrushCoreå§”è­²
- ä¾å­˜: CoordinateSystem, LayerSystem, BrushCore, PointerHandler
- åº§æ¨™å¤‰æ›: `_transformPointerToLocal()` ã§CoordinateSystemå‘¼ã³å‡ºã—
- ã‚°ãƒ­ãƒ¼ãƒãƒ«: `window.DrawingEngine` (ã‚¯ãƒ©ã‚¹å®šç¾©), `window.drawingEngine` (ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹)
- Phase: 1.2 (åº§æ¨™å¤‰æ›ä¿®æ­£ç‰ˆ)
- çŠ¶æ…‹: âš ï¸ activeLayerå–å¾—ã¯æ­£å¸¸ / âŒ worldContainerå‰æã®å¤‰æ›å¤±æ•—

### ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

ğŸ“ **layer-system.js** (ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ç®¡ç†)
- è²¬å‹™: ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒ»å‰Šé™¤ãƒ»é¸æŠãƒ»å¤‰å½¢ãƒ»éšå±¤ç®¡ç†
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¿æŒ: `currentFrameContainer.children`
- activeLayerå–å¾—: `getActiveLayer()` â†’ `currentFrameContainer.children[activeLayerIndex]`
- ä¾å­˜: AnimationSystem, LayerTransform, EventBus
- ã‚°ãƒ­ãƒ¼ãƒãƒ«: `window.layerSystem`, `window.layerManager` (äº’æ›æ€§)
- Phase: 8 (getLayerByIdå®Ÿè£…ç‰ˆ)
- çŠ¶æ…‹: âœ… ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†æ­£å¸¸ / âš ï¸ currentFrameContainer â‰  worldContainer

ğŸ“ **camera-system.js** (ã‚«ãƒ¡ãƒ©ãƒ»ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³)
- è²¬å‹™: worldContainerã®transformæ“ä½œ
- worldContainerä½œæˆ: åˆæœŸåŒ–æ™‚ã«PIXI.Containerã‚’ç”Ÿæˆ
- åº§æ¨™å½±éŸ¿: worldContainer.x/y/scale/rotation
- ã‚°ãƒ­ãƒ¼ãƒãƒ«: `window.cameraSystem`
- çŠ¶æ…‹: ğŸ” worldContainerã¨currentFrameContainerã®é–¢ä¿‚è¦ç¢ºèª

### æç”»å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ 

ğŸ“ **brush-core.js** (æç”»çµ±åˆ)
- è²¬å‹™: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é–‹å§‹/æ›´æ–°/çµ‚äº†ã®çµ±åˆå‡¦ç†
- ä¾å­˜: StrokeRecorder, WebGL2ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€LayerSystem
- ãƒ¡ã‚½ãƒƒãƒ‰: startStroke, updateStroke, finalizeStroke
- ã‚°ãƒ­ãƒ¼ãƒãƒ«: `window.BrushCore` (ã‚¯ãƒ©ã‚¹), `window.brushCore` (ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹)
- çŠ¶æ…‹: ğŸ” åˆæœŸåŒ–çŠ¶æ…‹è¦ç¢ºèª

ğŸ“ **stroke-recorder.js** (ãƒãƒªã‚´ãƒ³ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼)
- è²¬å‹™: Localåº§æ¨™ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²â†’PerfectFreehandå¤‰æ›
- å…¥åŠ›: {x, y, pressure} (Localåº§æ¨™å‰æ)
- ç¦æ­¢: åº§æ¨™å¤‰æ›ã®å®Ÿè¡Œ (å—ã‘å–ã£ãŸå€¤ã‚’ãã®ã¾ã¾è¨˜éŒ²)
- ã‚°ãƒ­ãƒ¼ãƒãƒ«: `window.StrokeRecorder`
- Phase: 0 (åŸºç¤å®Ÿè£…)
- çŠ¶æ…‹: âœ… è¨˜éŒ²ãƒ­ã‚¸ãƒƒã‚¯ã¯æ­£å¸¸ / âš ï¸ å…¥åŠ›åº§æ¨™å¾…ã¡

### WebGL2ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

ğŸ“ **webgl2-drawing-layer.js** (WebGL2çµ±åˆ)
- è²¬å‹™: WebGLã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ãƒ»ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ãƒ»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
- ã‚°ãƒ­ãƒ¼ãƒãƒ«: `window.WebGLContext`, `window.WebGL2DrawingLayer`
- çŠ¶æ…‹: âœ… åˆæœŸåŒ–å®Œäº†

ğŸ“ **gl-stroke-processor.js** (ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å‡¦ç†)
- è²¬å‹™: PerfectFreehandå‡ºåŠ›â†’é ‚ç‚¹ãƒãƒƒãƒ•ã‚¡â†’GPUè»¢é€
- ä¾å­˜: WebGL2DrawingLayer
- çŠ¶æ…‹: âœ… Singletonä½œæˆæ¸ˆã¿

ğŸ“ **gl-msdf-pipeline.js** (MSDFãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°)
- è²¬å‹™: SDF/MSDFç”Ÿæˆãƒ»åˆæˆ
- Phase: 1.8 (Rollbackä¿®æ­£ç‰ˆ)
- çŠ¶æ…‹: âœ… åˆæœŸåŒ–å®Œäº†

### ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•

ğŸ“ **pointer-handler.js** (ãƒã‚¤ãƒ³ã‚¿ãƒ¼å…¥åŠ›)
- è²¬å‹™: PointerEventæ­£è¦åŒ–ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡
- EventEmitter: .on('pointerdown/move/up', callback)
- ã‚°ãƒ­ãƒ¼ãƒãƒ«: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã¿ (DrawingEngineãŒä¿æŒ)
- çŠ¶æ…‹: âœ… ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡æ­£å¸¸

ğŸ“ **event-bus.js** (ã‚·ã‚¹ãƒ†ãƒ é–“é€šä¿¡)
- è²¬å‹™: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã‚¤ãƒ™ãƒ³ãƒˆé€šä¿¡
- ã‚°ãƒ­ãƒ¼ãƒãƒ«: `window.EventBus`
- çŠ¶æ…‹: âœ… é€šä¿¡çµŒè·¯æ­£å¸¸

================================================================================

## 3. åº§æ¨™å¤‰æ›ãƒ•ãƒ­ãƒ¼ãƒã‚§ãƒ¼ãƒ³

### ç†æƒ³çš„ãªãƒ•ãƒ­ãƒ¼ (ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³æº–æ‹ )

```
[1] PointerEvent (Browser)
    â†“ clientX, clientY, pressure
[2] DrawingEngine._handlePointerDown(e)
    â†“ 
[3] DrawingEngine._transformPointerToLocal(e)
    â†“
[4] CoordinateSystem.screenClientToCanvas(clientX, clientY)
    â†“ DPIè£œæ­£
[5] canvasCoords {canvasX, canvasY}
    â†“
[6] CoordinateSystem.canvasToWorld(canvasX, canvasY)
    â†“ worldContaineré€†å¤‰æ› (ç´”ç²‹æ•°å­¦)
[7] worldCoords {worldX, worldY}
    â†“
[8] LayerSystem.getActiveLayer()
    â†“ activeLayerå–å¾—
[9] CoordinateSystem.worldToLocal(worldX, worldY, activeLayer)
    â†“ è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»ãƒ»é€†å¤‰æ› (ç´”ç²‹æ•°å­¦)
[10] localCoords {localX, localY}
    â†“
[11] BrushCore.startStroke(localX, localY, pressure)
    â†“
[12] StrokeRecorder.startStroke({x: localX, y: localY, pressure})
    â†“ åº§æ¨™å¤‰æ›ãªã—ãƒ»ç›´æ¥è¨˜éŒ²
[13] PerfectFreehandå¤‰æ›
    â†“
[14] WebGL2ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
```

### ğŸ”´ ç¾åœ¨ã®ãƒ•ãƒ­ãƒ¼ (ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ)

```
[1]~[8] æ­£å¸¸å‹•ä½œ âœ…
[9] CoordinateSystem.worldToLocal(worldX, worldY, activeLayer)
    âŒ è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»ã§worldContaineråˆ°é”å¤±æ•—
    ç†ç”±: activeLayerã®è¦ªãŒcurrentFrameContainer
          currentFrameContainerã®è¦ª â‰  worldContainer
[10]~[14] å®Ÿè¡Œã•ã‚Œãš âŒ
```

================================================================================

## 4. å•é¡Œç®‡æ‰€ç‰¹å®š

### å•é¡Œ1: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã®è¦ªå­é–¢ä¿‚ãƒŸã‚¹ãƒãƒƒãƒ

#### æœŸå¾…ã•ã‚Œã‚‹æ§‹é€  (ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³)
```
worldContainer (camera-systemç®¡ç†)
  â””â”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¾¤
      â”œâ”€ èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼
      â”œâ”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼1
      â””â”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼2
```

#### å®Ÿéš›ã®æ§‹é€  (æ¨å®š)
```
canvasContainer (?)
  â””â”€ worldContainer (camera-systemç®¡ç†)
      â””â”€ ??? (ä¸æ˜)
          
åˆ¥éšå±¤:
currentFrameContainer (layer-systemç®¡ç†)
  â””â”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¾¤
      â”œâ”€ èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼
      â”œâ”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼1
      â””â”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼2
```

âš ï¸ `currentFrameContainer` ã¯ `worldContainer` ã®å­ã§ã¯ãªã„
âš ï¸ CoordinateSystem.worldToLocal() ã¯è¦ªãƒã‚§ãƒ¼ãƒ³ã§`worldContainer`ã‚’æ¢ã™ãŒè¦‹ã¤ã‹ã‚‰ãªã„

### å•é¡Œ2: CameraSystemã¨LayerSystemã®çµ±åˆä¸è¶³

ğŸ“„ **camera-system.js** (è¦ç¢ºèª)
- `worldContainer` ã‚’ä½œæˆãƒ»ç®¡ç†
- ğŸ” `currentFrameContainer` ã‚’å­ã¨ã—ã¦è¿½åŠ ã—ã¦ã„ã‚‹ã‹ï¼Ÿ
- ğŸ” åˆæœŸåŒ–é †åºã¯é©åˆ‡ã‹ï¼Ÿ

ğŸ“„ **layer-system.js**
- `currentFrameContainer` ã‚’ç‹¬ç«‹ç®¡ç†
- âŒ `worldContainer` ã¨ã®è¦ªå­é–¢ä¿‚ã‚’ç¢ºç«‹ã—ã¦ã„ãªã„
- ãƒ¡ã‚½ãƒƒãƒ‰: `setCameraSystem(cameraSystem)` å­˜åœ¨
- ğŸ”§ ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§è¦ªå­é–¢ä¿‚ã‚’ç¢ºç«‹ã™ã¹ã

### å•é¡Œ3: åˆæœŸåŒ–é †åºã®ä¸ç¢ºå®šæ€§

ğŸ“„ **core-initializer.js** (è¦ç¢ºèª)
- CameraSystemåˆæœŸåŒ–: worldContainerç”Ÿæˆ
- LayerSystemåˆæœŸåŒ–: currentFrameContainerç”Ÿæˆ
- CoordinateSystemåˆæœŸåŒ–: worldContainerå‚ç…§è¨­å®š
- ğŸ”§ CameraSystemãŒcurrentFrameContainerã‚’worldContainerã«è¿½åŠ ã™ã‚‹å‡¦ç†ãŒå¿…è¦

================================================================================

## 5. æ®µéšçš„æ”¹ä¿®ãƒ—ãƒ©ãƒ³

### Phase 1: æ§‹é€ ç¢ºèª (ã‚¨ãƒ©ãƒ¼å›å¾©ã®å‰æº–å‚™)

#### Step 1.1: ç¾åœ¨ã®è¦ªå­é–¢ä¿‚èª¿æŸ»
**å®Ÿè¡Œå ´æ‰€**: ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«
```javascript
// worldContainerç¢ºèª
console.log('worldContainer:', window.cameraSystem?.worldContainer);
console.log('worldContainer parent:', window.cameraSystem?.worldContainer?.parent);
console.log('worldContainer children:', window.cameraSystem?.worldContainer?.children);

// currentFrameContainerç¢ºèª
console.log('currentFrameContainer:', window.layerManager?.currentFrameContainer);
console.log('currentFrameContainer parent:', window.layerManager?.currentFrameContainer?.parent);
console.log('currentFrameContainer children:', window.layerManager?.currentFrameContainer?.children);

// activeLayerç¢ºèª
const activeLayer = window.layerManager?.getActiveLayer();
console.log('activeLayer:', activeLayer);
console.log('activeLayer parent:', activeLayer?.parent);
console.log('activeLayer label:', activeLayer?.label);

// è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»
let current = activeLayer;
let depth = 0;
while (current && depth < 10) {
  console.log(`Parent[${depth}]:`, current.label || current.constructor.name, current);
  current = current.parent;
  depth++;
}
```

#### Step 1.2: camera-system.jsã®æ§‹é€ ç¢ºèª
ğŸ” ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
- `worldContainer`ä½œæˆç®‡æ‰€
- `canvasContainer`ã¨ã®é–¢ä¿‚
- `currentFrameContainer`ã‚’å­ã¨ã—ã¦è¿½åŠ ã—ã¦ã„ã‚‹ã‹ï¼Ÿ

#### Step 1.3: core-initializer.jsã®åˆæœŸåŒ–é †ç¢ºèª
ğŸ” ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
- CameraSystemåˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- LayerSystemåˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- `layerManager.setCameraSystem(cameraSystem)` å‘¼ã³å‡ºã—æœ‰ç„¡
- `worldContainer.addChild(currentFrameContainer)` å®Ÿè¡Œæœ‰ç„¡

### Phase 2: è¦ªå­é–¢ä¿‚ç¢ºç«‹ (æœ€é‡è¦)

#### ä¿®æ­£å¯¾è±¡: layer-system.js

**ä¿®æ­£ç®‡æ‰€1**: `setCameraSystem(cameraSystem)` ãƒ¡ã‚½ãƒƒãƒ‰

**ç¾çŠ¶**:
```javascript
setCameraSystem(cameraSystem) {
    this.cameraSystem = cameraSystem;
    
    // checkerPatternè¿½åŠ ã®ã¿
    if (cameraSystem?.canvasContainer && window.checkerUtils) {
        this.checkerPattern = window.checkerUtils.createCanvasChecker(...);
        cameraSystem.canvasContainer.addChildAt(this.checkerPattern, 0);
    }
    
    // transformåˆæœŸåŒ–
    if (this.transform && this.app && !this.transform.app) {
        this.initTransform();
    }
}
```

**å¿…è¦ãªè¿½åŠ **:
```javascript
setCameraSystem(cameraSystem) {
    this.cameraSystem = cameraSystem;
    
    // ğŸ”§ é‡è¦: currentFrameContainerã‚’worldContainerã®å­ã¨ã—ã¦è¿½åŠ 
    if (cameraSystem?.worldContainer && this.currentFrameContainer) {
        if (!this.currentFrameContainer.parent) {
            cameraSystem.worldContainer.addChild(this.currentFrameContainer);
            console.log('[LayerSystem] currentFrameContainer added to worldContainer');
        } else if (this.currentFrameContainer.parent !== cameraSystem.worldContainer) {
            console.warn('[LayerSystem] currentFrameContainer already has different parent');
            // è¦ªã‚’å¤‰æ›´
            this.currentFrameContainer.parent.removeChild(this.currentFrameContainer);
            cameraSystem.worldContainer.addChild(this.currentFrameContainer);
            console.log('[LayerSystem] currentFrameContainer reparented to worldContainer');
        }
    }
    
    // checkerPatternè¿½åŠ 
    if (cameraSystem?.canvasContainer && window.checkerUtils) {
        this.checkerPattern = window.checkerUtils.createCanvasChecker(...);
        cameraSystem.canvasContainer.addChildAt(this.checkerPattern, 0);
    }
    
    // transformåˆæœŸåŒ–
    if (this.transform && this.app && !this.transform.app) {
        this.initTransform();
    }
}
```

#### ä¿®æ­£å¯¾è±¡: core-initializer.js (è¦ç¢ºèªå¾Œ)

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**:
- `layerManager.setCameraSystem(cameraSystem)` ãŒç¢ºå®Ÿã«å‘¼ã°ã‚Œã¦ã„ã‚‹ã‹
- å‘¼ã³å‡ºã—ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯é©åˆ‡ã‹ (CameraSystemåˆæœŸåŒ–å¾Œ)

**å¿…è¦ãªè¿½åŠ ** (ã‚‚ã—å‘¼ã°ã‚Œã¦ã„ãªã„å ´åˆ):
```javascript
// CameraSystemåˆæœŸåŒ–å¾Œ
if (window.cameraSystem) {
    window.cameraSystem.initialize(worldContainer);
}

// LayerSystemåˆæœŸåŒ–
if (window.layerManager) {
    await window.layerManager.initialize();
}

// ğŸ”§ é‡è¦: CameraSystemã¨LayerSystemã‚’æ¥ç¶š
if (window.layerManager && window.cameraSystem) {
    window.layerManager.setCameraSystem(window.cameraSystem);
}
```

### Phase 3: CoordinateSystemä¿®æ­£ (äºˆé˜²çš„)

#### ä¿®æ­£å¯¾è±¡: coordinate-system.js

**ä¿®æ­£ç®‡æ‰€**: `worldToLocal()` ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**ç¾çŠ¶**:
```javascript
if (current !== worldContainer) {
    console.error('[CoordinateSystem] âŒ worldToLocal: container not child of worldContainer', {
        containerLabel: container.label || 'unknown',
        chainLength: parentChain.length
    });
    return null;
}
```

**æ”¹å–„æ¡ˆ** (Phase 2å®Œäº†å¾Œã¯ä¸è¦ã ãŒã€ãƒ‡ãƒãƒƒã‚°æƒ…å ±å¼·åŒ–):
```javascript
if (current !== worldContainer) {
    console.error('[CoordinateSystem] âŒ worldToLocal: container not child of worldContainer');
    console.error('  Container:', container.label || 'unknown');
    console.error('  Parent chain length:', parentChain.length);
    console.error('  Final parent:', current ? (current.label || current.constructor.name) : 'null');
    console.error('  Expected parent:', worldContainer ? (worldContainer.label || 'worldContainer') : 'null');
    console.error('  Parent chain:');
    for (let i = 0; i < parentChain.length; i++) {
        console.error(`    [${i}]:`, parentChain[i].label || parentChain[i].constructor.name);
    }
    return null;
}
```

### Phase 4: WebGPUæ®‹å­˜ã‚³ãƒ¼ãƒ‰å‰Šé™¤

#### ç¢ºèªå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
ğŸ” ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§WebGPUå‚ç…§ã‚’æ¤œç´¢:
- drawing-engine.js
- brush-core.js
- webgl2-drawing-layer.js
- gl-stroke-processor.js
- fill-tool.js (æ—¢ã«ä¿®æ­£æ¸ˆã¿)

#### å‰Šé™¤å¯¾è±¡
- `window.WebGPUContext` å‚ç…§
- `gpuDevice`, `gpuCanvas` ç­‰ã®å¤‰æ•°
- WebGPUåˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰
- WebGPUç”¨ã®ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã‚³ãƒ¼ãƒ‰ (WGSL)

#### ç¢ºèªæ–¹æ³•
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
console.log('WebGPU references:', {
    WebGPUContext: typeof window.WebGPUContext,
    gpuDevice: typeof window.gpuDevice,
    gpuCanvas: document.querySelector('canvas[id*="gpu"]')
});
```

### Phase 5: æç”»ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼

#### Test 1: åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«
window.TegakiDebug.drawing.testTransform(960, 540);
```
**æœŸå¾…çµæœ**: ã‚¨ãƒ©ãƒ¼ãªã—ã€localX/localY ãŒæ•°å€¤ã§è¿”ã‚‹

#### Test 2: è¦ªå­é–¢ä¿‚ç¢ºèª
```javascript
const activeLayer = window.layerManager.getActiveLayer();
console.log('Parent chain valid:', activeLayer?.parent === window.layerManager.currentFrameContainer);
console.log('currentFrame in world:', window.layerManager.currentFrameContainer?.parent === window.cameraSystem.worldContainer);
```
**æœŸå¾…çµæœ**: ä¸¡æ–¹ `true`

#### Test 3: å®Ÿéš›ã®æç”»ãƒ†ã‚¹ãƒˆ
1. WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã§ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯
2. ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç·šã‚’å¼•ã
3. ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—

**æœŸå¾…çµæœ**: 
- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—
- StrokeRecorderã«ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²
- WebGL2ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ç·šãŒè¡¨ç¤º

### Phase 6: Perfect-Freehandç¢ºèª

#### ç¢ºèªãƒã‚¤ãƒ³ãƒˆ
ğŸ“„ **stroke-recorder.js**
- PerfectFreehandå‘¼ã³å‡ºã—ç®‡æ‰€
- config.jsã®perfectFreehandè¨­å®šé©ç”¨

ğŸ“„ **config.js**
- thinning, smoothing, streamline è¨­å®šå€¤
- ç­†åœ§å¯¾å¿œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

#### æ¤œè¨¼æ–¹æ³•
```javascript
// stroke-recorder.jsã®è¨˜éŒ²ç¢ºèª
window.StrokeRecorder.getPoints(); // æç”»å¾Œã«å®Ÿè¡Œ
```
**æœŸå¾…çµæœ**: ãƒã‚¤ãƒ³ãƒˆé…åˆ—ãŒå–å¾—ã§ãã‚‹

================================================================================

## 6. å®Œå…¨å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### âœ… åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚º
- [ ] CameraSystemåˆæœŸåŒ–å®Œäº† (`worldContainer` ç”Ÿæˆ)
- [ ] LayerSystemåˆæœŸåŒ–å®Œäº† (`currentFrameContainer` ç”Ÿæˆ)
- [ ] `layerManager.setCameraSystem()` å®Ÿè¡Œ
- [ ] `currentFrameContainer` ãŒ `worldContainer` ã®å­
- [ ] CoordinateSystemåˆæœŸåŒ– (canvas, worldContainerè¨­å®š)
- [ ] DrawingEngineåˆæœŸåŒ– (ä¾å­˜é–¢ä¿‚ã™ã¹ã¦æƒã£ã¦ã„ã‚‹)
- [ ] BrushCoreåˆæœŸåŒ–
- [ ] WebGL2ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–

### âœ… åº§æ¨™å¤‰æ›ãƒ•ã‚§ãƒ¼ã‚º
- [ ] PointerEventå—ä¿¡
- [ ] screenClientToCanvas() æˆåŠŸ
- [ ] canvasToWorld() æˆåŠŸ
- [ ] activeLayerå–å¾—æˆåŠŸ
- [ ] activeLayerã®è¦ªãƒã‚§ãƒ¼ãƒ³ã«worldContainerãŒå­˜åœ¨
- [ ] worldToLocal() æˆåŠŸ (ã‚¨ãƒ©ãƒ¼ãªã—)
- [ ] localX, localY ãŒæœ‰é™æ•°å€¤

### âœ… æç”»å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º
- [ ] BrushCore.startStroke() å®Ÿè¡Œ
- [ ] StrokeRecorder.startStroke() å®Ÿè¡Œ
- [ ] ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ² (åº§æ¨™å¤‰æ›ãªã—)
- [ ] PerfectFreehandå¤‰æ›å®Ÿè¡Œ
- [ ] WebGL2é ‚ç‚¹ãƒãƒƒãƒ•ã‚¡è»¢é€
- [ ] WebGL2ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œ
- [ ] ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ç·šãŒè¡¨ç¤ºã•ã‚Œã‚‹

### âœ… WebGPUå‰Šé™¤ç¢ºèª
- [ ] `window.WebGPUContext` ãŒ undefined
- [ ] gpuCanvasè¦ç´ ãŒå­˜åœ¨ã—ãªã„
- [ ] WebGPUé–¢é€£ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—

================================================================================

## ä»˜éŒ²A: ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰é›†

### ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
```javascript
// CoordinateSystemçŠ¶æ…‹
window.CoordinateSystem.dumpState();

// DrawingEngineçŠ¶æ…‹
window.TegakiDebug.drawing.inspect();

// ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ç¢ºèª
window.layerManager.getLayers();
window.layerManager.getActiveLayer();

// è¦ªå­é–¢ä¿‚ç¢ºèª
const activeLayer = window.layerManager.getActiveLayer();
let parent = activeLayer;
while (parent) {
  console.log(parent.label || parent.constructor.name);
  parent = parent.parent;
}
```

### åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ
```javascript
// ãƒã‚¦ã‚¹åº§æ¨™ã‹ã‚‰Localåº§æ¨™ã¸ã®å¤‰æ›ãƒ†ã‚¹ãƒˆ
window.TegakiDebug.drawing.testTransform(960, 540);

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–
window.TegakiDebug.drawing.enableDebug();
// â†’ ãã®å¾Œã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒ­ã‚°å‡ºåŠ›

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ç„¡åŠ¹åŒ–
window.TegakiDebug.drawing.disableDebug();
```

### WebGL2çŠ¶æ…‹ç¢ºèª
```javascript
// WebGL2ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
console.log('WebGL2:', window.WebGLContext);
console.log('GL Canvas:', document.getElementById('webgl2-canvas'));

// ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
console.log('GLStrokeProcessor:', window.GLStrokeProcessor);
console.log('GLMSDFPipeline:', window.GLMSDFPipeline);
```

================================================================================

## ä»˜éŒ²B: ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥å¯¾å‡¦

### ã‚¨ãƒ©ãƒ¼1: "container not child of worldContainer"
**åŸå› **: currentFrameContainerãŒworldContainerã®å­ã§ã¯ãªã„
**å¯¾å‡¦**: Phase 2 å®Ÿæ–½

### ã‚¨ãƒ©ãƒ¼2: "CoordinateSystem not initialized"
**åŸå› **: åˆæœŸåŒ–é †åºã®å•é¡Œ
**å¯¾å‡¦**: core-initializer.jsã§åˆæœŸåŒ–é †åºç¢ºèª

### ã‚¨ãƒ©ãƒ¼3: "No active layer"
**åŸå› **: LayerSystemã®åˆæœŸåŒ–ä¸å®Œå…¨
**å¯¾å‡¦**: LayerSystem.init()ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ã‚¨ãƒ©ãƒ¼4: "BrushCore not available"
**åŸå› **: BrushCoreã®åˆæœŸåŒ–å¤±æ•—
**å¯¾å‡¦**: brush-core.jsåˆæœŸåŒ–ãƒ­ã‚°ç¢ºèªã€ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯

### ã‚¨ãƒ©ãƒ¼5: NaN/Infinity in coordinates
**åŸå› **: åº§æ¨™è¨ˆç®—ã®ã©ã“ã‹ã§ä¸æ­£ãªå€¤ãŒæ··å…¥
**å¯¾å‡¦**: å„å¤‰æ›ã‚¹ãƒ†ãƒƒãƒ—ã§isFinite()ãƒã‚§ãƒƒã‚¯å®Ÿæ–½ã€ãƒ­ã‚°è¿½è·¡

================================================================================

## ä»˜éŒ²C: ãƒ•ã‚¡ã‚¤ãƒ«æ”¹ä¿®å„ªå…ˆé †ä½

### å„ªå…ˆåº¦: æœ€é«˜ ğŸ”´
1. **layer-system.js** - setCameraSystem()ä¿®æ­£
2. **core-initializer.js** - åˆæœŸåŒ–é †åºãƒ»è¦ªå­é–¢ä¿‚ç¢ºç«‹
3. **coordinate-system.js** - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å¼·åŒ– (äºˆé˜²çš„)

### å„ªå…ˆåº¦: é«˜ ğŸŸ 
4. **camera-system.js** - æ§‹é€ ç¢ºèªãƒ»å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£
5. **drawing-engine.js** - WebGPUæ®‹å­˜ã‚³ãƒ¼ãƒ‰å‰Šé™¤
6. **brush-core.js** - WebGPUæ®‹å­˜ã‚³ãƒ¼ãƒ‰å‰Šé™¤

### å„ªå…ˆåº¦: ä¸­ ğŸŸ¡
7. **stroke-recorder.js** - PerfectFreehandçµ±åˆç¢ºèª
8. **webgl2-drawing-layer.js** - WebGPUå‚ç…§å‰Šé™¤
9. **config.js** - PerfectFreehandè¨­å®šç¢ºèª

### å„ªå…ˆåº¦: ä½ ğŸŸ¢
10. ãã®ä»–WebGL2ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ç³»ãƒ•ã‚¡ã‚¤ãƒ« (å‹•ä½œç¢ºèªæ¸ˆã¿)

================================================================================

## æ”¹ä¿®å¾Œã®æœŸå¾…å‹•ä½œ

### åº§æ¨™å¤‰æ›ãƒ•ãƒ­ãƒ¼ (å®Œå…¨ç‰ˆ)
1. âœ… PointerEventå–å¾—
2. âœ… Screen â†’ Canvas (DPIè£œæ­£)
3. âœ… Canvas â†’ World (worldContaineré€†å¤‰æ›)
4. âœ… World â†’ Local (è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»ãƒ»é€†å¤‰æ›)
5. âœ… Localåº§æ¨™è¨˜éŒ² (StrokeRecorder)
6. âœ… PerfectFreehandå¤‰æ› (ãƒãƒªã‚´ãƒ³ç”Ÿæˆ)
7. âœ… WebGL2ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (ãƒ¡ãƒƒã‚·ãƒ¥æç”»)

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€  (å®Œå…¨ç‰ˆ)
```
canvasContainer (PixiJS Stage)
  â””â”€ checkerPattern (èƒŒæ™¯ãƒã‚§ãƒƒã‚«ãƒ¼)
  â””â”€ worldContainer (CameraSystemç®¡ç†)
      â””â”€ currentFrameContainer (LayerSystemç®¡ç†)
          â”œâ”€ èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ (PIXI.Container)
          â”œâ”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼1 (PIXI.Container)
          â”‚   â”œâ”€ maskSprite
          â”‚   â””â”€ path.graphics (WebGL2 Mesh) â† ã“ã“ã«æç”»
          â””â”€ ãƒ¬ã‚¤ãƒ¤ãƒ¼2 (PIXI.Container)
```

### åº§æ¨™ç³»ã®æ•´åˆæ€§
- worldContainer: ã‚«ãƒ¡ãƒ©å¤‰æ›ã®åŸºæº–ç‚¹
- currentFrameContainer: ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¾¤ã®ãƒ«ãƒ¼ãƒˆ (worldContainerã®å­)
- activeLayer: æç”»å¯¾è±¡ (currentFrameContainerã®å­)
- è¦ªãƒã‚§ãƒ¼ãƒ³: activeLayer â†’ currentFrameContainer â†’ worldContainer âœ…

================================================================================

## æœ€å¾Œã«

æœ¬æ”¹ä¿®è¾å…¸ã¯**AIãŒèª­ã¿ã‚„ã™ã„å½¢å¼**ã§è¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚
å„Phaseã¯ç‹¬ç«‹ã—ã¦å®Ÿè¡Œå¯èƒ½ã§ã€æ®µéšçš„ãªæ”¹ä¿®ã‚’æ”¯æ´ã—ã¾ã™ã€‚

æ”¹ä¿®å®Ÿæ–½æ™‚ã¯ä»¥ä¸‹ã®é †åºã‚’æ¨å¥¨:
1. Phase 1 (æ§‹é€ ç¢ºèª) â†’ ç¾çŠ¶æŠŠæ¡
2. Phase 2 (è¦ªå­é–¢ä¿‚ç¢ºç«‹) â†’ ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ
3. Phase 3~4 (äºˆé˜²çš„ä¿®æ­£) â†’ å®‰å®šåŒ–
4. Phase 5~6 (æç”»ãƒ†ã‚¹ãƒˆ) â†’ æ©Ÿèƒ½ç¢ºèª

å„Phaseã®å®Œäº†å¾Œã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã§æ¤œè¨¼ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

================================================================================