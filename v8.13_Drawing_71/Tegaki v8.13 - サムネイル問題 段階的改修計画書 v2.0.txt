================================================================================
Tegaki v8.13 - ã‚µãƒ ãƒã‚¤ãƒ«å•é¡Œ æ®µéšçš„æ”¹ä¿®è¨ˆç”»æ›¸ v2.0
================================================================================
ä½œæˆæ—¥: 2025å¹´
å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v8.13_Drawing_70ä»¥é™
æ”¹ä¿®æ–¹é‡: éç ´å£Šãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ»ThumbnailSystemçµ±ä¸€ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•åŒ–


================================================================================
ã€å•é¡Œã®å…¨ä½“åƒã€‘
================================================================================

â–  ç—‡çŠ¶
1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«: å›è»¢ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´ãŒåæ˜ ã•ã‚Œãªã„
2. éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼: ã‚µã‚¤ã‚ºå¤‰æ›´ã™ã‚‰åæ˜ ã•ã‚Œãªã„
3. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«: åˆå›ç”Ÿæˆé…å»¶ï¼ˆVãƒ¢ãƒ¼ãƒ‰æ“ä½œã¾ã§æ²ˆé»™ï¼‰
4. Vãƒ¢ãƒ¼ãƒ‰ä¸­: åè»¢ãƒœã‚¿ãƒ³ãƒ»ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ(H/Shift+H)ãŒåŠ¹ã‹ãªã„

â–  æ ¹æœ¬åŸå› 
1. layer-system.js ãŒ ThumbnailSystem ã‚’ç„¡è¦–ã—ã¦ç‹¬è‡ªå®Ÿè£…
   â†’ updateThumbnail() ãŒç ´å£Šçš„æ“ä½œï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¦ªã‹ã‚‰åˆ‡ã‚Šé›¢ã—ï¼‰
   
2. ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼æ–­çµ¶
   â†’ layer-system.js ãŒ layer:transform-updated ã‚’è³¼èª­ã—ã¦ã„ãªã„
   â†’ Transformå¤‰æ›´ãŒã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°ã«ä¼æ’­ã—ãªã„
   
3. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã®äºŒé‡å®Ÿè£…
   â†’ thumbnail-system.js: _renderLayerThumbnail() (ã‚¯ãƒ­ãƒ¼ãƒ³æ–¹å¼ãƒ»å¤±æ•—)
   â†’ layer-system.js: updateThumbnail() (ä¸€æ™‚ç§»å‹•æ–¹å¼ãƒ»ç ´å£Šçš„)
   
4. åº§æ¨™ç³»ç ´å£Š
   â†’ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¦ªã‹ã‚‰åˆ‡ã‚Šé›¢ã™â†’åº§æ¨™ç³»ã®è¦ªãƒã‚§ãƒ¼ãƒ³ãŒæ–­çµ¶
   â†’ Transformä¸€æ™‚ãƒªã‚»ãƒƒãƒˆâ†’å…ƒã«æˆ»ã™éš›ã«ã‚ºãƒ¬ç™ºç”Ÿ


================================================================================
ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç†è§£ã€‘
================================================================================

â–  åº§æ¨™ç³»ã®5å±¤æ§‹é€ 
Screenåº§æ¨™ (clientX/Y) 
  â†’ [DPIè£œæ­£] â†’ Canvasåº§æ¨™ (canvasX/Y)
  â†’ [worldContaineré€†è¡Œåˆ—] â†’ Worldåº§æ¨™ (worldX/Y)
  â†’ [è¦ªãƒã‚§ãƒ¼ãƒ³é¡æŸ»] â†’ Localåº§æ¨™ (localX/Y)
  â†’ [RenderTexture] â†’ Textureåº§æ¨™

â–  ãƒ•ã‚¡ã‚¤ãƒ«è²¬å‹™ãƒãƒƒãƒ—
ã€åº§æ¨™ç³»ã€‘
- coordinate-system.js: å…¨åº§æ¨™å¤‰æ›ã®çµ±ä¸€API

ã€ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã€‘
- thumbnail-system.js: ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã®ä¸­æ ¸
  - generateLayerThumbnail(): ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«
  - generateFrameThumbnail(): ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ ãƒã‚¤ãƒ«
  - _renderLayerThumbnail(): âŒå•é¡Œç®‡æ‰€ï¼ˆPhase 2ã§ä¿®æ­£ï¼‰

ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã€‘
- layer-system.js: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œãƒ»ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«
  - updateThumbnail(): âŒç‹¬è‡ªå®Ÿè£…ï¼ˆPhase 3ã§å‰Šé™¤ï¼‰
  - flipActiveLayer(): åè»¢æ©Ÿèƒ½

ã€Transformåˆ¶å¾¡ã€‘
- layer-transform.js: Transformé©ç”¨ãƒ»GSAPçµ±åˆ
  - applyTransform(): GSAP delayedCallçµŒç”±ã§é©ç”¨
  - flipLayer(): åè»¢å‡¦ç†
  - _emitTransformUpdated(): ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ï¼ˆthrottleä»˜ãï¼‰

ã€UIå±¤ã€‘
- layer-panel-renderer.js: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«UI
  - _generateAndDisplayThumbnail(): ThumbnailSystemå‘¼ã³å‡ºã—ï¼ˆæ­£å¸¸ï¼‰
  
- timeline-thumbnail-utils.js: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«
  - generateThumbnail(): ThumbnailSystemå‘¼ã³å‡ºã—
  - layer:transform-updated è³¼èª­æ¸ˆã¿ï¼ˆæ­£å¸¸ï¼‰

â–  ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ï¼ˆç¾çŠ¶ï¼‰
layer-transform.js
  â†’ gsap.delayedCall(0.016ç§’) 
  â†’ layer:transform-updated ç™ºç«
  
timeline-thumbnail-utils.js â†’ âœ… è³¼èª­ä¸­
layer-panel-renderer.js â†’ âœ… è³¼èª­ä¸­
layer-system.js â†’ âŒ è³¼èª­ãªã—ï¼ˆã“ã‚ŒãŒå•é¡Œï¼‰


================================================================================
ã€ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ã‚·ãƒ³ãƒœãƒ«è¾å…¸ã€‘
================================================================================

â–  ThumbnailSystem (thumbnail-system.js)
ãƒ¡ã‚½ãƒƒãƒ‰                                æˆ»ã‚Šå€¤           ç”¨é€”
generateLayerThumbnail(layer, w, h)     Promise<Canvas>  ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«
generateFrameThumbnail(frame, w, h)     Promise<Canvas>  ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ ãƒã‚¤ãƒ«
_renderLayerThumbnail(layer, w, h)      Promise<Canvas>  âŒä¿®æ­£å¯¾è±¡
_invalidateLayerCacheByLayerId(id)      void             ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
canvasToDataURL(canvas)                 string           DataURLå¤‰æ›

â–  LayerSystem (layer-system.js)
ãƒ¡ã‚½ãƒƒãƒ‰                                æˆ»ã‚Šå€¤           ç”¨é€”
updateThumbnail(layerIndex)             void             âŒå‰Šé™¤å¯¾è±¡
requestThumbnailUpdate(layerIndex)      void             ä¿®æ­£å¯¾è±¡
flipActiveLayer(direction)              void             åè»¢ï¼ˆVãƒ¢ãƒ¼ãƒ‰æ™‚ã«å•é¡Œï¼‰

â–  LayerTransform (layer-transform.js)
ãƒ¡ã‚½ãƒƒãƒ‰                                æˆ»ã‚Šå€¤           ç”¨é€”
applyTransform(layer, transform, c)     void             Transformé©ç”¨
flipLayer(layer, direction)             void             åè»¢å‡¦ç†
_emitTransformUpdated(layerId, layer)   void             ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«

â–  ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆ
ã‚¤ãƒ™ãƒ³ãƒˆå                  ç™ºç«å…ƒ              ãƒ‡ãƒ¼ã‚¿                      ç”¨é€”
layer:transform-updated     layer-transform.js  {layerIndex,layerId,trans}  Transformæ›´æ–°é€šçŸ¥
thumbnail:layer-updated     è¤‡æ•°                {layerIndex,layerId,imm}    ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°è¦æ±‚
keyboard:vkey-pressed       keyboard-handler    -                           Vãƒ¢ãƒ¼ãƒ‰é–‹å§‹
keyboard:vkey-released      keyboard-handler    -                           Vãƒ¢ãƒ¼ãƒ‰çµ‚äº†

â–  ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
window.ThumbnailSystem      ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 
window.layerManager         ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
window.TegakiEventBus       ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹
window.CoordinateSystem     åº§æ¨™å¤‰æ›ã‚·ã‚¹ãƒ†ãƒ 
window.cameraSystem         ã‚«ãƒ¡ãƒ©ãƒ»ã‚ºãƒ¼ãƒ åˆ¶å¾¡


================================================================================
ã€æ”¹ä¿®ãƒ•ãƒ­ãƒ¼å…¨ä½“ã€‘
================================================================================

Phase 1: æº–å‚™ãƒ»è¨ºæ–­
  â†“
Phase 2: thumbnail-system.js ä¿®æ­£ï¼ˆéç ´å£Šãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè£…ï¼‰
  â†“
Phase 3: layer-system.js ä¿®æ­£ï¼ˆç‹¬è‡ªå®Ÿè£…å‰Šé™¤ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ï¼‰
  â†“
Phase 4: ã‚¤ãƒ™ãƒ³ãƒˆçµ±åˆãƒ»UIé€£æºç¢ºèª
  â†“
Phase 5: æœ€çµ‚æ¤œè¨¼ãƒ»ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰æ•´å‚™


================================================================================
Phase 1: æº–å‚™ãƒ»è¨ºæ–­
================================================================================

ã€ç›®çš„ã€‘
- ç¾çŠ¶ã®å‹•ä½œç¢ºèª
- ä¾å­˜é–¢ä¿‚ã®æ¤œè¨¼
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ

ã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
- ãªã—ï¼ˆè¨ºæ–­ã®ã¿ï¼‰

ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¯¾è±¡ã€‘
- system/drawing/thumbnail-system.js
- system/layer-system.js
- system/layer-transform.js
- ui/layer-panel-renderer.js
- ui/timeline-thumbnail-utils.js

ã€è¨ºæ–­ã‚³ãƒãƒ³ãƒ‰ã€‘
ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:

```javascript
// ä¾å­˜é–¢ä¿‚ç¢ºèª
console.log('ThumbnailSystem:', typeof window.ThumbnailSystem);
console.log('EventBus:', typeof window.TegakiEventBus);
console.log('LayerManager:', typeof window.layerManager);
console.log('CoordinateSystem:', typeof window.CoordinateSystem);
console.log('GSAP:', typeof gsap);

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç¢ºèª
const events = window.TegakiEventBus?.events || {};
console.log('layer:transform-updated listeners:', 
  events['layer:transform-updated']?.length || 0);
console.log('thumbnail:layer-updated listeners:', 
  events['thumbnail:layer-updated']?.length || 0);
```

ã€æ¤œè¨¼é …ç›®ã€‘
[  ] å…¨ã¦ã®ä¾å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ "object" ã¾ãŸã¯ "function" ã‚’è¿”ã™
[  ] layer:transform-updated ã«1å€‹ä»¥ä¸Šã®ãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚‹
[  ] thumbnail:layer-updated ã«1å€‹ä»¥ä¸Šã®ãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚‹


================================================================================
Phase 2: thumbnail-system.js ä¿®æ­£ï¼ˆéç ´å£Šãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè£…ï¼‰
================================================================================

ã€ç›®çš„ã€‘
ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¦ªã‹ã‚‰åˆ‡ã‚Šé›¢ã•ãªã„éç ´å£Šãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ–¹å¼ã«å¤‰æ›´

ã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
- system/drawing/thumbnail-system.jsï¼ˆä¿®æ­£ï¼‰

ã€å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
- coordinate-system.js: åº§æ¨™ç³»ç†è§£
- system/layer-system.js: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ç¢ºèª
- config.js: canvas.width/height å–å¾—

ã€ä¿®æ­£æ–¹é‡ã€‘
âŒ å‰Šé™¤: ã‚¯ãƒ­ãƒ¼ãƒ³æ–¹å¼ï¼ˆGraphics.clone()ãŒä¸å®Œå…¨ï¼‰
âœ… æ¡ç”¨: éç ´å£Šãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆå…„å¼Ÿã‚’ä¸€æ™‚éè¡¨ç¤ºï¼‰

ã€ä¿®æ­£å†…å®¹ã€‘

â–  2-1. _renderLayerThumbnail() ãƒ¡ã‚½ãƒƒãƒ‰å®Œå…¨æ›¸ãæ›ãˆ

ä¿®æ­£å‰ã®å•é¡Œ:
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³â†’Graphics.clone()ãŒä¸å®Œå…¨
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä¸€æ™‚ç§»å‹•â†’åº§æ¨™ç³»ç ´å£Š

ä¿®æ­£å¾Œã®æ–¹å¼:
1. èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å°‚ç”¨å‡¦ç†ï¼ˆ_generateBackgroundThumbnail()ï¼‰
2. ãƒ•ãƒ¬ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠï¼ˆè¦ªï¼‰ã‚’å–å¾—
3. ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‚µã‚¤ã‚ºã§RenderTextureä½œæˆ
4. å…„å¼Ÿãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¯è¦–æ€§ã‚’ä¸€æ™‚ä¿å­˜
5. å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ä»¥å¤–ã‚’éè¡¨ç¤ºåŒ–ï¼ˆvisible = falseï¼‰
6. ãƒ•ãƒ¬ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å…ƒã®ä½ç½®ã®ã¾ã¾ï¼‰
7. å¯è¦–æ€§ã‚’å¾©å…ƒ
8. ã‚µãƒ ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã«ãƒªã‚µã‚¤ã‚º

å®Ÿè£…ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆ:
```javascript
// Step 1: è¦ªã‚³ãƒ³ãƒ†ãƒŠå–å¾—
const frameContainer = layer.parent;

// Step 2: ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã§RenderTextureä½œæˆ
const canvasWidth = this.config?.canvas?.width || 800;
const canvasHeight = this.config?.canvas?.height || 600;
const frameRT = PIXI.RenderTexture.create({
    width: canvasWidth,
    height: canvasHeight,
    resolution: 1
});

// Step 3: å…„å¼Ÿãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¯è¦–æ€§ã‚’ä¸€æ™‚ä¿å­˜
const siblingVisibility = new Map();
frameContainer.children.forEach(sibling => {
    if (sibling !== layer) {
        siblingVisibility.set(sibling, sibling.visible);
        sibling.visible = false;
    }
});

const originalVisibility = layer.visible;
layer.visible = true;

// Step 4: ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å…ƒã®ä½ç½®ã®ã¾ã¾ï¼‰
this.app.renderer.render({
    container: frameContainer,
    target: frameRT,
    clear: true
});

// Step 5: å¯è¦–æ€§ã‚’å¾©å…ƒ
layer.visible = originalVisibility;
siblingVisibility.forEach((vis, sibling) => {
    sibling.visible = vis;
});

// Step 6: ã‚µãƒ ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã«ãƒªã‚µã‚¤ã‚º
const canvas = await this._resizeRenderTextureToCanvas(frameRT, width, height);

// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
frameRT.destroy(true);
```

ã‚¨ãƒ©ãƒ¼æ™‚ã®å¯è¦–æ€§å¾©å…ƒã‚‚å¿…é ˆï¼ˆtry-catch-finallyï¼‰

â–  2-2. _generateBackgroundThumbnail() å®Ÿè£…

èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼å°‚ç”¨:
- config.background.color ã‹ã‚‰è‰²å–å¾—
- Canvas2D ã§å˜è‰²å¡—ã‚Šã¤ã¶ã—ï¼ˆè»½é‡åŒ–ï¼‰

â–  2-3. ä¸è¦ãƒ¡ã‚½ãƒƒãƒ‰å‰Šé™¤

å‰Šé™¤å¯¾è±¡:
- _cloneLayerForThumbnail()
- _cloneDisplayObject()

ç†ç”±: éç ´å£Šãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ã¯ä¸è¦

ã€æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã€‘

```javascript
window.TegakiDebug = window.TegakiDebug || {};
window.TegakiDebug.thumbnail = {
  testLayer: async function(layerIndex) {
    const layers = window.layerManager.getLayers();
    const layer = layers[layerIndex];
    console.log('Layer:', layer.layerData?.name);
    console.log('Transform:', {
      pos: layer.position,
      scale: layer.scale,
      rot: (layer.rotation * 180 / Math.PI).toFixed(1) + 'Â°'
    });
    
    const canvas = await window.ThumbnailSystem.generateLayerThumbnail(
      layer, 128, 128
    );
    
    if (canvas) {
      const img = new Image();
      img.src = canvas.toDataURL();
      img.style.border = '2px solid red';
      document.body.appendChild(img);
      console.log('âœ… Thumbnail appended (red border)');
    } else {
      console.error('âŒ Failed');
    }
  }
};
```

ã€æ¤œè¨¼æ‰‹é †ã€‘
1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç”»
2. Vãƒ¢ãƒ¼ãƒ‰ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å›è»¢ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«
3. `window.TegakiDebug.thumbnail.testLayer(1)` å®Ÿè¡Œ
4. ç”»é¢ã«ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
5. ã‚µãƒ ãƒã‚¤ãƒ«ãŒå›è»¢ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«ã‚’åæ˜ ã—ã¦ã„ã‚‹ã‹ç¢ºèª


================================================================================
Phase 3: layer-system.js ä¿®æ­£ï¼ˆç‹¬è‡ªå®Ÿè£…å‰Šé™¤ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ï¼‰
================================================================================

ã€ç›®çš„ã€‘
- ç‹¬è‡ªã‚µãƒ ãƒã‚¤ãƒ«å®Ÿè£…ã®å‰Šé™¤
- ThumbnailSystemçµ±ä¸€å‘¼ã³å‡ºã—ã«å¤‰æ›´
- layer:transform-updated ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­è¿½åŠ 

ã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
- system/layer-system.jsï¼ˆä¿®æ­£ï¼‰

ã€å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
- system/drawing/thumbnail-system.js: å‘¼ã³å‡ºã—å…ˆ
- system/event-bus.js: ã‚¤ãƒ™ãƒ³ãƒˆä»•æ§˜
- ui/layer-panel-renderer.js: UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ–¹æ³•

ã€ä¿®æ­£å†…å®¹ã€‘

â–  3-1. updateThumbnail() ãƒ¡ã‚½ãƒƒãƒ‰å‰Šé™¤

å‰Šé™¤å¯¾è±¡: updateThumbnail(layerIndex) ãƒ¡ã‚½ãƒƒãƒ‰å…¨ä½“ï¼ˆç´„60è¡Œï¼‰
ç†ç”±: ThumbnailSystemã¨é‡è¤‡ãƒ»ç ´å£Šçš„æ“ä½œã‚’å«ã‚€

â–  3-2. requestThumbnailUpdate() ãƒ¡ã‚½ãƒƒãƒ‰ä¿®æ­£

ä¿®æ­£å‰: ç‹¬è‡ªã®ã‚­ãƒ¥ãƒ¼ç®¡ç†ãƒ»setTimeoutå®Ÿè£…

ä¿®æ­£å¾Œ:
```javascript
requestThumbnailUpdate(layerIndex) {
    const layers = this.getLayers();
    if (layerIndex < 0 || layerIndex >= layers.length) return;
    
    const layer = layers[layerIndex];
    const layerId = layer.layerData?.id;
    
    if (!layerId) return;
    
    // ThumbnailSystemã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
    if (window.ThumbnailSystem) {
        window.ThumbnailSystem._invalidateLayerCacheByLayerId(layerId);
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ï¼ˆlayer-panel-renderer.js ãŒè³¼èª­ï¼‰
    if (this.eventBus) {
        this.eventBus.emit('thumbnail:layer-updated', {
            component: 'layer-system',
            action: 'thumbnail-requested',
            data: { layerIndex, layerId, immediate: false }
        });
    }
}
```

â–  3-3. processThumbnailUpdates() ãƒ¡ã‚½ãƒƒãƒ‰å‰Šé™¤

å‰Šé™¤ç†ç”±: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã«å¤‰æ›´ã—ãŸãŸã‚ä¸è¦

â–  3-4. _startThumbnailUpdateProcess() ãƒ¡ã‚½ãƒƒãƒ‰å‰Šé™¤

å‰Šé™¤ç†ç”±: ãƒãƒ¼ãƒªãƒ³ã‚°ä¸è¦ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ï¼‰

â–  3-5. init() ãƒ¡ã‚½ãƒƒãƒ‰ä¿®æ­£

å‰Šé™¤ã™ã‚‹è¡Œ:
```javascript
this._startThumbnailUpdateProcess(); // âŒ
```

è¿½åŠ ã™ã‚‹è¡Œ:
```javascript
this._setupThumbnailEventListeners(); // âœ…
```

â–  3-6. _setupThumbnailEventListeners() ãƒ¡ã‚½ãƒƒãƒ‰æ–°è¦è¿½åŠ 

è¿½åŠ ä½ç½®: _setupAnimationSystemIntegration() ã®ç›´å¾Œ

```javascript
_setupThumbnailEventListeners() {
    if (!this.eventBus) return;
    
    // layer:transform-updated ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
    this.eventBus.on('layer:transform-updated', ({ data }) => {
        const { layerIndex, layerId } = data || {};
        
        if (layerIndex === undefined && !layerId) return;
        
        // layerId ã‹ã‚‰ layerIndex ã‚’è§£æ±º
        let targetLayerIndex = layerIndex;
        
        if (targetLayerIndex === undefined && layerId) {
            const layers = this.getLayers();
            targetLayerIndex = layers.findIndex(
              l => l.layerData?.id === layerId
            );
        }
        
        if (targetLayerIndex < 0) return;
        
        // ThumbnailSystem ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
        if (window.ThumbnailSystem && layerId) {
            window.ThumbnailSystem._invalidateLayerCacheByLayerId(layerId);
        }
        
        // UIæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
        this.eventBus.emit('thumbnail:layer-updated', {
            component: 'layer-system',
            action: 'transform-updated-relay',
            data: { 
                layerIndex: targetLayerIndex, 
                layerId, 
                immediate: false 
            }
        });
        
        console.log(`[LayerSystem] Transform updated: layer ${targetLayerIndex}`);
    });
    
    console.log('[LayerSystem] Thumbnail event listeners configured');
}
```

â–  3-7. ä¸è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‰Šé™¤

constructor() ã‹ã‚‰å‰Šé™¤:
```javascript
this.thumbnailUpdateQueue = new Set(); // âŒ
this.thumbnailUpdateTimer = null;      // âŒ
```

ã€æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã€‘

```javascript
window.TegakiDebug.thumbnail.testEventFlow = function() {
    console.log('\n=== ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ ===');
    
    const eventBus = window.TegakiEventBus;
    const events = eventBus?.events || {};
    
    console.log('layer:transform-updated listeners:', 
        events['layer:transform-updated']?.length || 0);
    console.log('thumbnail:layer-updated listeners:', 
        events['thumbnail:layer-updated']?.length || 0);
    
    // ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
    eventBus.emit('layer:transform-updated', {
        data: { layerIndex: 1, layerId: 'test_id' }
    });
    
    console.log('âœ… Test event emitted');
};
```

ã€æ¤œè¨¼æ‰‹é †ã€‘
1. `window.TegakiDebug.thumbnail.testEventFlow()` å®Ÿè¡Œ
2. ãƒªã‚¹ãƒŠãƒ¼æ•°ãŒä¸¡æ–¹ã¨ã‚‚ 1ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
3. ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã“ã¨ã‚’ç¢ºèª


================================================================================
Phase 4: ã‚¤ãƒ™ãƒ³ãƒˆçµ±åˆãƒ»UIé€£æºç¢ºèª
================================================================================

ã€ç›®çš„ã€‘
- Phase 2ãƒ»3ã®çµ±åˆå‹•ä½œç¢ºèª
- UIå±¤ã¨ã®é€£æºç¢ºèª
- Vãƒ¢ãƒ¼ãƒ‰åè»¢æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª

ã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
- ãªã—ï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆã®ã¿ï¼‰

ã€å‚ç…§ãƒ•ã‚¡ã‚¤ãƒ«ã€‘
- ui/layer-panel-renderer.js: ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
- ui/timeline-thumbnail-utils.js: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«
- ui/keyboard-handler.js: Vãƒ¢ãƒ¼ãƒ‰ã‚­ãƒ¼å‡¦ç†
- system/layer-transform.js: åè»¢å‡¦ç†

ã€ç¢ºèªé …ç›®ã€‘

â–  4-1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«é€£æºç¢ºèª

ç¢ºèªå†…å®¹:
- layer-panel-renderer.js ãŒ thumbnail:layer-updated ã‚’è³¼èª­ã—ã¦ã„ã‚‹ã‹
- _generateAndDisplayThumbnail() ãŒ ThumbnailSystem ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã‹

ç¢ºèªã‚³ãƒãƒ³ãƒ‰:
```javascript
const events = window.TegakiEventBus?.events || {};
console.log('thumbnail:layer-updated listeners:', 
  events['thumbnail:layer-updated']?.length);
```

æœŸå¾…å€¤: 1ä»¥ä¸Š

â–  4-2. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³é€£æºç¢ºèª

ç¢ºèªå†…å®¹:
- timeline-thumbnail-utils.js ãŒ layer:transform-updated ã‚’è³¼èª­ã—ã¦ã„ã‚‹ã‹

ç¢ºèªã‚³ãƒãƒ³ãƒ‰:
```javascript
const events = window.TegakiEventBus?.events || {};
console.log('layer:transform-updated listeners (timeline):', 
  events['layer:transform-updated']?.length);
```

æœŸå¾…å€¤: 2ä»¥ä¸Šï¼ˆlayer-system + timeline-thumbnail-utilsï¼‰

â–  4-3. Vãƒ¢ãƒ¼ãƒ‰åè»¢æ©Ÿèƒ½ç¢ºèª

å•é¡Œ: Vãƒ¢ãƒ¼ãƒ‰ä¸­ã«åè»¢ãƒœã‚¿ãƒ³ãƒ»ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãŒåŠ¹ã‹ãªã„

ç¢ºèªç®‡æ‰€:
- keyboard-handler.js: Vãƒ¢ãƒ¼ãƒ‰ä¸­ã®H/Shift+Hå‡¦ç†
- layer-system.js: flipActiveLayer() å®Ÿè£…
- layer-transform.js: flipLayer() å®Ÿè£…

ç¢ºèªæ–¹æ³•:
1. Vãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼ˆVã‚­ãƒ¼æŠ¼ä¸‹ï¼‰
2. H ã‚­ãƒ¼æŠ¼ä¸‹â†’æ°´å¹³åè»¢ã•ã‚Œã‚‹ã‹
3. Shift+H æŠ¼ä¸‹â†’å‚ç›´åè»¢ã•ã‚Œã‚‹ã‹
4. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®ã‚µãƒ ãƒã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã‚‹ã‹

ã‚‚ã—å‹•ä½œã—ãªã„å ´åˆ:
- keyboard-handler.js ã§ Vãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚­ãƒ¼å‡¦ç†ã‚’ç¢ºèª
- flipLayer() å¾Œã« _emitTransformUpdated() ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

ã€çµ±åˆãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã€‘

ãƒ†ã‚¹ãƒˆ1: åŸºæœ¬Transformåæ˜ 
1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç”»
2. Vãƒ¢ãƒ¼ãƒ‰ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼å›è»¢ï¼ˆ45åº¦ï¼‰
3. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ã®ã‚µãƒ ãƒã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚µãƒ ãƒã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

ãƒ†ã‚¹ãƒˆ2: éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼
1. ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã¤ä½œæˆ
2. ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
3. ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã‚’Vãƒ¢ãƒ¼ãƒ‰ã§å¤‰å½¢
4. ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®ã‚µãƒ ãƒã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

ãƒ†ã‚¹ãƒˆ3: åè»¢æ©Ÿèƒ½
1. Vãƒ¢ãƒ¼ãƒ‰é–‹å§‹
2. H ã‚­ãƒ¼ã§æ°´å¹³åè»¢
3. Shift+H ã§å‚ç›´åè»¢
4. ã‚µãƒ ãƒã‚¤ãƒ«ãŒå³åº§ã«æ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

ãƒ†ã‚¹ãƒˆ4: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆå›ç”Ÿæˆ
1. ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ
2. æç”»ç›´å¾Œã«ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç¢ºèª
3. ã‚µãƒ ãƒã‚¤ãƒ«ãŒå³åº§ã«ç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª


================================================================================
Phase 5: æœ€çµ‚æ¤œè¨¼ãƒ»ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰æ•´å‚™
================================================================================

ã€ç›®çš„ã€‘
- å…¨ç—‡çŠ¶ã®è§£æ±ºç¢ºèª
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª
- ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰ã®å®Œå…¨å®Ÿè£…

ã€æœ€çµ‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‘

[  ] 1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ãŒå›è»¢ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«ã‚’åæ˜ ã™ã‚‹
[  ] 2. éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚ã‚µã‚¤ã‚ºå¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹
[  ] 3. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«ãŒåˆå›ã‹ã‚‰æ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹
[  ] 4. Vãƒ¢ãƒ¼ãƒ‰ä¸­ã®åè»¢ãƒœã‚¿ãƒ³ãŒå‹•ä½œã™ã‚‹
[  ] 5. Vãƒ¢ãƒ¼ãƒ‰ä¸­ã®åè»¢ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ(H/Shift+H)ãŒå‹•ä½œã™ã‚‹
[  ] 6. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ™‚ã«ãƒ•ãƒªãƒ¼ã‚ºã—ãªã„
[  ] 7. ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒç™ºç”Ÿã—ã¦ã„ãªã„

ã€ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰å®Œå…¨å®Ÿè£…ã€‘

â–  5-1. å…¨ä½“è¨ºæ–­ã‚³ãƒãƒ³ãƒ‰

```javascript
window.TegakiDebug.thumbnail.diagnose = function() {
    console.log('\n=== ã‚µãƒ ãƒã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ ===\n');
    
    // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
    console.log('ğŸ” ã‚·ã‚¹ãƒ†ãƒ :');
    console.log('  ThumbnailSystem:', !!window.ThumbnailSystem);
    console.log('  LayerManager:', !!window.layerManager);
    console.log('  EventBus:', !!window.TegakiEventBus);
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ…‹
    if (window.ThumbnailSystem) {
        const info = window.ThumbnailSystem.getDebugInfo?.() || {};
        console.log('\nğŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥:');
        console.log('  Layer cache:', info.layerCacheSize || 'N/A');
        console.log('  Frame cache:', info.frameCacheSize || 'N/A');
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const events = window.TegakiEventBus?.events || {};
    console.log('\nğŸ“¡ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼:');
    console.log('  layer:transform-updated:', 
        events['layer:transform-updated']?.length || 0);
    console.log('  thumbnail:layer-updated:', 
        events['thumbnail:layer-updated']?.length || 0);
    
    // ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹
    if (window.layerManager) {
        const layers = window.layerManager.getLayers();
        console.log('\nğŸ¨ ãƒ¬ã‚¤ãƒ¤ãƒ¼:');
        console.log('  Total:', layers.length);
        console.log('  Active:', window.layerManager.activeLayerIndex);
    }
    
    console.log('\nâœ… è¨ºæ–­å®Œäº†\n');
};
```

â–  5-2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚³ãƒãƒ³ãƒ‰

```javascript
window.TegakiDebug.thumbnail.monitor = function(duration = 10000) {
    console.log(`\n=== ç›£è¦–é–‹å§‹ï¼ˆ${duration/1000}ç§’ï¼‰ ===\n`);
    
    const eventBus = window.TegakiEventBus;
    let count = 0;
    
    const listener = ({ data }) => {
        count++;
        console.log(`[${count}] layer:transform-updated`, data);
    };
    
    eventBus.on('layer:transform-updated', listener);
    
    setTimeout(() => {
        eventBus.off('layer:transform-updated', listener);
        console.log(`\nâœ… ç›£è¦–çµ‚äº†ï¼ˆ${count}å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼‰\n`);
    }, duration);
};
```

â–  5-3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬

```javascript
window.TegakiDebug.thumbnail.measurePerf = async function() {
    console.log('\n=== ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬ ===\n');
    
    const layers = window.layerManager.getLayers();
    const layer = layers[1];
    
    if (!layer) {
        console.error('âŒ Layer not found');
        return;
    }
    
    const times = [];
    
    for (let i = 0; i < 10; i++) {
        window.ThumbnailSystem._invalidateLayerCacheByLayerId(
            layer.layerData.id
        );
        
        const start = performance.now();
        await window.ThumbnailSystem.generateLayerThumbnail(layer, 64, 64);
        const end = performance.now();
        
        times.push(end - start);
    }
    
    const avg = times.reduce((a, b) => a + b, 0) / times.length;
    const min = Math.min(...times);
    const max = Math.max(...times);
    
    console.log('ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆæ™‚é–“:');
    console.log('  å¹³å‡:', avg.toFixed(2), 'ms');
    console.log('  æœ€å°:', min.toFixed(2), 'ms');
    console.log('  æœ€å¤§:', max.toFixed(2), 'ms');
    console.log('\nâœ… è¨ˆæ¸¬å®Œäº†\n');
};
```

ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™ã€‘
- ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ: å¹³å‡ 50msä»¥ä¸‹
- Vãƒ¢ãƒ¼ãƒ‰ãƒ‰ãƒ©ãƒƒã‚°: 60FPSç¶­æŒ
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: æ”¹ä¿®å‰ã¨åŒç­‰


================================================================================
ã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€‘
================================================================================

â–  å•é¡Œ: ã‚µãƒ ãƒã‚¤ãƒ«ãŒçœŸã£é»’/çœŸã£ç™½

åŸå› :
- RenderTexture ã‚µã‚¤ã‚ºãŒ0
- ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå®Œå…¨ã«éè¡¨ç¤º
- frameContainer ãŒ null

ç¢ºèª:
```javascript
const layer = window.layerManager.getLayers()[1];
console.log('Parent:', layer.parent);
console.log('Visible:', layer.visible);
console.log('Children:', layer.children.length);
```

â–  å•é¡Œ: ã‚µãƒ ãƒã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œãªã„

åŸå› :
- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¦ã„ãªã„

ç¢ºèª:
```javascript
const events = window.TegakiEventBus?.events || {};
console.log('Listeners:', events['layer:transform-updated']?.length);
```

â–  å•é¡Œ: Vãƒ¢ãƒ¼ãƒ‰ä¸­ã«åè»¢ãŒåŠ¹ã‹ãªã„

åŸå› :
- keyboard-handler.js ã§ Vãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚­ãƒ¼å‡¦ç†ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹
- flipLayer() å¾Œã« _emitTransformUpdated() ãŒå‘¼ã°ã‚Œã¦ã„ãªã„

ç¢ºèª:
```javascript
// keyboard-handler.js ã§ Vãƒ¢ãƒ¼ãƒ‰ä¸­ã®å‡¦ç†ã‚’ç¢ºèª
// layer-transform.js ã® flipLayer() ã‚’ç¢ºèª
```

â–  å•é¡Œ: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯

åŸå› :
- RenderTexture ã® destroy() æ¼ã‚Œ
- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã® off() æ¼ã‚Œ

ç¢ºèª:
```javascript
// Chrome DevTools > Memory > Take Heap Snapshot
// RenderTexture ãŒæ®‹ã£ã¦ã„ãªã„ã‹ç¢ºèª
```


================================================================================
ã€æ”¹ä¿®å®Œäº†ã®åˆ¤å®šåŸºæº–ã€‘
================================================================================

ä»¥ä¸‹ã®å…¨ã¦ãŒæº€ãŸã•ã‚ŒãŸå ´åˆã€æ”¹ä¿®å®Œäº†ã¨ã™ã‚‹:

1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«
   - Vãƒ¢ãƒ¼ãƒ‰ã§ã®å›è»¢ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´ãŒå³åº§ã«åæ˜ ã•ã‚Œã‚‹
   - éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¤‰æ›´ã‚‚åæ˜ ã•ã‚Œã‚‹

2. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚µãƒ ãƒã‚¤ãƒ«
   - ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆç›´å¾Œã‹ã‚‰æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
   - Vãƒ¢ãƒ¼ãƒ‰æ“ä½œã‚’å¾…ãŸãšã«ç”Ÿæˆã•ã‚Œã‚‹

3. åè»¢æ©Ÿèƒ½
   - Vãƒ¢ãƒ¼ãƒ‰ä¸­ã®åè»¢ãƒœã‚¿ãƒ³ãŒå‹•ä½œã™ã‚‹
   - Vãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ(H/Shift+H)ãŒå‹•ä½œã™ã‚‹
   - åè»¢å¾Œã€ã‚µãƒ ãƒã‚¤ãƒ«ãŒå³åº§ã«æ›´æ–°ã•ã‚Œã‚‹

4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
   - ã‚µãƒ ãƒã‚¤ãƒ«ç”ŸæˆãŒ 50msä»¥ä¸‹
   - Vãƒ¢ãƒ¼ãƒ‰ãƒ‰ãƒ©ãƒƒã‚°ãŒ 60FPSç¶­æŒ
   - ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒç™ºç”Ÿã—ã¦ã„ãªã„

5. ã‚³ãƒ¼ãƒ‰å“è³ª
   - äºŒé‡å®Ÿè£…ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
   - ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã«çµ±ä¸€ã•ã‚Œã¦ã„ã‚‹
   - ç ´å£Šçš„æ“ä½œãŒæ’é™¤ã•ã‚Œã¦ã„ã‚‹


================================================================================
ã€æ”¹ä¿®å¾Œã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€‘
================================================================================

â–  ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆãƒ•ãƒ­ãƒ¼ï¼ˆæ”¹ä¿®å¾Œï¼‰

Transformå¤‰æ›´
  â†“
layer-transform.js: _emitTransformUpdated()
  â†“
layer:transform-updated ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  â†“
  â”œâ†’ layer-system.js: _setupThumbnailEventListeners()
  â”‚   â†’ ThumbnailSystem._invalidateLayerCacheByLayerId()
  â”‚   â†’ thumbnail:layer-updated ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  â”‚   â†’ layer-panel-renderer.js: ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
  â”‚
  â””â†’ timeline-thumbnail-utils.js: ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°

â–  çµ±ä¸€ãƒ«ãƒ¼ãƒ«

1. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã¯ ThumbnailSystem ã®ã¿
2. Transformå¤‰æ›´ã¯ layer:transform-updated ã‚¤ãƒ™ãƒ³ãƒˆçµŒç”±
3. UIæ›´æ–°ã¯ thumbnail:layer-updated ã‚¤ãƒ™ãƒ³ãƒˆçµŒç”±
4. åº§æ¨™ç³»ç ´å£Šã¯å³ç¦ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¦ªã‹ã‚‰åˆ‡ã‚Šé›¢ã•ãªã„ï¼‰


================================================================================
ã€ä»˜éŒ²: é‡è¦ãªã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘
================================================================================

â–  éç ´å£Šãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³

```javascript
// å…„å¼Ÿã‚’ä¸€æ™‚éè¡¨ç¤º
const siblingVisibility = new Map();
frameContainer.children.forEach(sibling => {
    if (sibling !== layer) {
        siblingVisibility.set(sibling, sibling.visible);
        sibling.visible = false;
    }
});

// ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
this.app.renderer.render({
    container: frameContainer,
    target: renderTexture,
    clear: true
});

// å¯è¦–æ€§ã‚’å¾©å…ƒ
siblingVisibility.forEach((vis, sibling) => {
    sibling.visible = vis;
});
```

â–  ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ãƒ‘ã‚¿ãƒ¼ãƒ³

```javascript
this.eventBus.on('layer:transform-updated', ({ data }) => {
    const { layerIndex, layerId } = data || {};
    
    // å‡¦ç†
    if (window.ThumbnailSystem && layerId) {
        window.ThumbnailSystem._invalidateLayerCacheByLayerId(layerId);
    }
    
    // æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
    this.eventBus.emit('thumbnail:layer-updated', {
        component: 'layer-system',
        action: 'transform-updated-relay',
        data: { layerIndex, layerId, immediate: false }
    });
});
```

â–  ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãƒ‘ã‚¿ãƒ¼ãƒ³

```javascript
requestThumbnailUpdate(layerIndex) {
    const layers = this.getLayers();
    const layer = layers[layerIndex];
    const layerId = layer.layerData?.id;
    
    if (window.ThumbnailSystem && layerId) {
        window.ThumbnailSystem._invalidateLayerCacheByLayerId(layerId);
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
    this.eventBus.emit('thumbnail:layer-updated', {
        data: { layerIndex, layerId }
    });
}
```


================================================================================
ã€æ”¹ä¿®å®Ÿæ–½æ™‚ã®æ³¨æ„äº‹é …ã€‘
================================================================================

1. Phaseé †ã«å®Ÿæ–½ã™ã‚‹ã“ã¨
   - Phase 1ã‚’é£›ã°ã•ãªã„ï¼ˆè¨ºæ–­ãŒé‡è¦ï¼‰
   - Phase 2â†’3ã®é †åºã‚’å®ˆã‚‹ï¼ˆä¾å­˜é–¢ä¿‚ï¼‰

2. å„Phaseå®Œäº†å¾Œã«æ¤œè¨¼ã™ã‚‹ã“ã¨
   - æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å¿…ãšå®Ÿè¡Œ
   - å•é¡ŒãŒã‚ã‚Œã°æ¬¡ã®Phaseã«é€²ã¾ãªã„

3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¿…ãšå–ã‚‹ã“ã¨
   - æ”¹ä¿®å‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .bak ã§ä¿å­˜
   - å•é¡ŒãŒã‚ã‚Œã°å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

4. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ã“ã¨
   - ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã‹
   - ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ã¦ã„ã‚‹ã‹
   - ãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹

5. æ—¢å­˜ã®å‹•ä½œã‚’å£Šã•ãªã„ã“ã¨
   - æç”»æ©Ÿèƒ½ã¯æ”¹ä¿®å¯¾è±¡å¤–
   - ã‚«ãƒ¡ãƒ©ãƒ»ã‚ºãƒ¼ãƒ ã¯æ”¹ä¿®å¯¾è±¡å¤–
   - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ”¹ä¿®å¯¾è±¡å¤–


================================================================================
ä»¥ä¸Š
================================================================================