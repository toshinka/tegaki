# Phase 1 å•é¡Œç¢ºå®šè¨ºæ–­æ›¸

## è¨ºæ–­çµæœãƒ­ã‚°åˆ†æ

### ğŸ”´ ãƒšãƒ³ã‚ºãƒ¬ã®åŸå› ï¼šå®Œå…¨ç¢ºå®š

```
Input (ãƒ–ãƒ©ã‚¦ã‚¶ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™):     {x: 363.5, y: 316}
Output (screenToLayer):           {x: 135.5, y: 83.5}
Canvasç›¸å¯¾åº§æ¨™:                     {x: 313.5, y: 318}
toLocal(canvasç›¸å¯¾):               {x: 85.5, y: 85.5}

ã‚ªãƒ•ã‚»ãƒƒãƒˆ:
  offsetX: -178  (å·¦ã«ã‚ºãƒ¬ã¦ã„ã‚‹)
  offsetY: -234.5 (ä¸Šã«ã‚ºãƒ¬ã¦ã„ã‚‹)
```

### ğŸ” æ ¹æœ¬åŸå› ã®ç‰¹å®š

**Canvas.getBoundingClientRect():**
```
{left: 50, top: -2, right: 777, bottom: 630}
```

**worldContainer ã®ä½ç½®:**
```
{x: 228, y: 232.5}
```

### ğŸ’¥ å•é¡Œã®ä»•çµ„ã¿

```javascript
// ç¾åœ¨ã® screenToLayer() å®Ÿè£…
screenToLayer(screenX, screenY) {
    const globalPoint = { x: screenX, y: screenY };  // â† ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ã®ã¾ã¾
    return this.canvasContainer.toLocal(globalPoint);  // â† é–“é•ã£ãŸåŸºæº–ç‚¹
}
```

**æµã‚Œ**:
1. ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ (363.5, 316) ãŒå…¥åŠ›ã•ã‚Œã‚‹
2. ãã®ã¾ã¾ canvasContainer.toLocal() ã«æ¸¡ã•ã‚Œã‚‹
3. canvasContainer ã¯ worldContainerå†…ã«ã‚ã‚Šã€worldContainer ãŒ (228, 232.5) ã«ã‚ã‚‹
4. worldContainerã®ä½ç½®åˆ†ãŒã‚ºãƒ¬ã¨ã—ã¦å‡ºç¾ â† **ã“ã‚ŒãŒ -178, -234.5 ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ**

**æ­£ã—ã„æµã‚Œ**:
```
screenX/Y (ãƒ–ãƒ©ã‚¦ã‚¶ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™)
  â†“ [canvas.getBoundingClientRect() ã§ç›¸å¯¾åŒ–]
  â†“ relX = screenX - canvas.left (50)
  â†“ relY = screenY - canvas.top (-2)
  â†“ ã‚­ãƒ£ãƒ³ãƒã‚¹ç›¸å¯¾åº§æ¨™
  â†“ [canvasContainer.toLocal()]
  â†“ ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ âœ…
```

---

## âœ… ä¿®æ­£æ–¹æ³•ï¼ˆç¢ºå®šï¼‰

### ä¿®æ­£å¯¾è±¡: camera-system.js ã® screenToLayer()

```javascript
// âŒ ä¿®æ­£å‰ï¼ˆé–“é•ã„ï¼‰
screenToLayer(screenX, screenY) {
    const globalPoint = { x: screenX, y: screenY };
    return this.canvasContainer.toLocal(globalPoint);
}

// âœ… ä¿®æ­£å¾Œï¼ˆæ­£ã—ã„ï¼‰
screenToLayer(screenX, screenY) {
    // canvasè¦ç´ ã®ä½ç½®ã‚’å–å¾—
    const canvas = this._getSafeCanvas();
    if (!canvas) {
        return { x: screenX, y: screenY };
    }
    
    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ â†’ ã‚­ãƒ£ãƒ³ãƒã‚¹ç›¸å¯¾åº§æ¨™
    const rect = canvas.getBoundingClientRect();
    const relativeX = screenX - rect.left;
    const relativeY = screenY - rect.top;
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ç›¸å¯¾åº§æ¨™ â†’ ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™
    return this.canvasContainer.toLocal({ x: relativeX, y: relativeY });
}
```

**æ¤œè¨¼**:
```
Input:  (363.5, 316)
Step1:  relativeX = 363.5 - 50 = 313.5
        relativeY = 316 - (-2) = 318
Step2:  canvasContainer.toLocal({313.5, 318}) â‰ˆ ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ âœ…
```

---

## ğŸ“Š 3ã¤ã®å•é¡Œã®ç¾çŠ¶

| # | å•é¡Œ | åŸå›  | ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ« | å„ªå…ˆåº¦ |
|---|------|------|------------|--------|
| 1 | ãƒšãƒ³ãŒå³ãƒ»ä¸Šã«ã‚ºãƒ¬ | screenToLayer()ãŒcanvasç›¸å¯¾åŒ–ã‚’ã—ã¦ã„ãªã„ | camera-system.js | ğŸ”´ é«˜ |
| 2 | ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒå‹•ã‹ãªã„ | SettingsManager vs BrushSettings ã®ç«¶åˆ | core-initializer.js | ğŸ”´ é«˜ |
| 3 | è‰²ã¯å¤‰ã‚ã‚‹ãŒã‚µã‚¤ã‚ºãƒ»é€æ˜åº¦ã¯åæ˜ ãªã— | åŒä¸Šã®å‰¯ä½œç”¨ | åŒä¸Š | ğŸ”´ é«˜ |

---

## ğŸ”§ ä¿®æ­£å®Ÿè£…ï¼ˆã‚³ãƒ¼ãƒ‰ï¼‰

### ä¿®æ­£1: camera-system.js

```javascript
screenToLayer(screenX, screenY) {
    // canvasè¦ç´ ã®ä½ç½®ã‚’åŸºæº–ã«ç›¸å¯¾åŒ–
    const canvas = this._getSafeCanvas();
    if (!canvas) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        return this.canvasContainer.toLocal({ x: screenX, y: screenY });
    }
    
    const rect = canvas.getBoundingClientRect();
    const relativeX = screenX - rect.left;
    const relativeY = screenY - rect.top;
    
    return this.canvasContainer.toLocal({ x: relativeX, y: relativeY });
}
```

### ä¿®æ­£2: core-initializer.js

**å‰Šé™¤å¯¾è±¡**:
```javascript
// core-initializer.js ã® initialize() ãƒ¡ã‚½ãƒƒãƒ‰å†…

// âŒ ã“ã‚Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
// this.settingsManager = initializeSettingsManager(window.TegakiEventBus, CONFIG);

// ã¾ãŸã¯ initializeSettingsManager() é–¢æ•°å…¨ä½“ã‚’å‰Šé™¤
```

**ç†ç”±**: 
- `BrushSettings` ãŒ core-engine.js ã§æ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- `SettingsManager` ã¯å¤ã„è¨­è¨ˆã§ã€BrushSettings ã¨ç«¶åˆã—ã¦ã„ã‚‹
- BrushSettings ã«çµ±ä¸€ã™ã‚‹ã“ã¨ã§ EventBus çµŒè·¯ãŒæ˜ç¢ºåŒ–ã•ã‚Œã‚‹

---

## ğŸ¯ ä¿®æ­£å¾Œã®å‹•ä½œãƒ•ãƒ­ãƒ¼ï¼ˆç¢ºå®šç‰ˆï¼‰

```javascript
// ãƒšãƒ³ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã™
ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ input ã‚¤ãƒ™ãƒ³ãƒˆ
  â†“
quick-access-popup.js: _onSizeChange()
  â†“
EventBus.emit('brush:size-changed', {size: 30})
  â†“
BrushSettings.subscribeToEvents() ãƒªã‚¹ãƒŠãƒ¼å®Ÿè¡Œ
  â†“
this.size = 30
  â†“
DrawingEngine.continueDrawing() ã§éƒ½åº¦å‚ç…§
  â†“
this.currentSettings = this.brushSettings.getCurrentSettings()
  â†“
size: 30 ãŒæç”»ã«åæ˜ ã•ã‚Œã‚‹ âœ…
```

---

## âœ¨ æœŸå¾…ã•ã‚Œã‚‹ä¿®æ­£å¾Œã®çŠ¶æ…‹

1. **ãƒšãƒ³ä½ç½®**
   - âŒ å³ã«ã‚ºãƒ¬ â†’ âœ… æ­£ç¢ºãªä½ç½®ã«æç”»

2. **ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å‹•ä½œ**
   - âŒ å€¤ãŒ3ã§å›ºå®š â†’ âœ… 1ï½50pxã§è‡ªç”±ã«å¤‰æ›´å¯èƒ½

3. **é€æ˜åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼**
   - âŒ å€¤ãŒ100%ã§å›ºå®š â†’ âœ… 0ï½100%ã§è‡ªç”±ã«å¤‰æ›´å¯èƒ½

4. **è‰²ãƒ‘ãƒ¬ãƒƒãƒˆ**
   - âœ… æ—¢ã«å‹•ä½œä¸­ â†’ âœ… ç¶™ç¶šå‹•ä½œ

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] camera-system.js ã® screenToLayer() ã‚’ä¿®æ­£
- [ ] core-initializer.js ã‹ã‚‰ SettingsManager åˆæœŸåŒ–ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ/å‰Šé™¤
- [ ] ãƒšãƒ³ã‚ºãƒ¬ãŒæ¶ˆãˆãŸã‹ç¢ºèªï¼ˆã‚¯ãƒªãƒƒã‚¯ä½ç½® = æç”»ä½ç½®ï¼‰
- [ ] ã‚µã‚¤ã‚ºã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒ1ï½50pxã§å¤‰æ›´å¯èƒ½ã‹ç¢ºèª
- [ ] é€æ˜åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒ0ï½100%ã§å¤‰æ›´å¯èƒ½ã‹ç¢ºèª
- [ ] è‰²ãƒ‘ãƒ¬ãƒƒãƒˆãŒç¶™ç¶šå‹•ä½œã™ã‚‹ã‹ç¢ºèª
- [ ] quick-access-popup.js ã®æ•°å€¤è¡¨ç¤ºãŒæ›´æ–°ã•ã‚Œã‚‹ã‹ç¢ºèª