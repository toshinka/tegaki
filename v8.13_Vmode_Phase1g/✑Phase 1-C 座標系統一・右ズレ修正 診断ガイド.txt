# Phase 1-C: åº§æ¨™ç³»çµ±ä¸€ãƒ»å³ã‚ºãƒ¬ä¿®æ­£ è¨ºæ–­ã‚¬ã‚¤ãƒ‰

## å•é¡Œ: ãƒšãƒ³ãŒå³ã«ã‚ºãƒ¬ã‚‹

ç¾è±¡: ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚ˆã‚Šå³ã«æç”»ã•ã‚Œã‚‹

---

## åº§æ¨™å¤‰æ›ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PointerEvent (ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒ†ã‚£ãƒ–åº§æ¨™ç³»)                  â”‚
â”‚ event.clientX, event.clientY                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“ [core-runtime.js handlePointerDown]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DrawingEngine.startDrawing(                              â”‚
â”‚   event.global.x,  â† â† â† â“ ã“ã‚Œã¯ä½•åº§æ¨™ï¼Ÿ            â”‚
â”‚   event.global.y,                                       â”‚
â”‚   event                                                 â”‚
â”‚ )                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“ [StrokeRecorder.addPointFromEvent]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ cameraSystem.screenToLayer(                             â”‚
â”‚   event.clientX,  â† å…ƒã® PointerEventåº§æ¨™              â”‚
â”‚   event.clientY                                         â”‚
â”‚ )                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“ [CameraSystemå†…éƒ¨]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ canvasContainer.toLocal({x, y})                         â”‚
â”‚ = canvasLocalåº§æ¨™ï¼ˆcanvasContainerç›¸å¯¾ï¼‰                â”‚
â”‚                                                         â”‚
â”‚ â€» ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã¸ã®å¤‰æ›ãŒã“ã“ã§å®Œçµã—ã¦ã„ã‚‹ï¼Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StrokeRecorder.points ã«æ ¼ç´                            â”‚
â”‚ {x, y, pressure, ...}                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ã‚ºãƒ¬ã®åŸå› å€™è£œ

### å€™è£œ1: event.global.x ãŒæ—¢ã« PixiJS ã‚°ãƒ­ãƒ¼ãƒãƒ«åº§æ¨™
**å•é¡Œ**: 
```javascript
// core-runtime.js
handlePointerDown(event) {
    this.internal.drawingEngine.startDrawing(
        event.global.x,  // â† ã“ã‚Œã¯ PixiJS ã‚°ãƒ­ãƒ¼ãƒãƒ«åº§æ¨™
        event.global.y,
        event
    );
}
```

**DrawingEngineå†…ã§**:
```javascript
// ğŸ”´ é–“é•ã„
const canvasLocalPoint = this.cameraSystem.screenToLayer(
    event.global.x,  // â† PixiJS ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ã¨ã—ã¦è§£é‡ˆ
    event.global.y
);
```

**ä¿®æ­£**:
```javascript
// âœ… æ­£ã—ã„
const canvasLocalPoint = this.cameraSystem.screenToLayer(
    event.clientX,  // â† å…ƒã® PointerEvent åº§æ¨™ã‚’ä½¿ç”¨
    event.clientY
);
```

---

### å€™è£œ2: canvasContainer ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ä½ç½®ã«ã‚ºãƒ¬
**ç¢ºèªæ–¹æ³•**:
```javascript
// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
const cc = drawingApp.cameraSystem.canvasContainer;
console.log('canvasContainer.position:', cc.position);
console.log('canvasContainer.scale:', cc.scale);
console.log('worldContainer.position:', drawingApp.cameraSystem.worldContainer.position);
console.log('worldContainer.scale:', drawingApp.cameraSystem.worldContainer.scale);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«åº§æ¨™ã«å¤‰æ›ã—ã¦ã¿ã‚‹
const testPoint = cc.toGlobal({x: 0, y: 0});
console.log('toGlobal({0,0}):', testPoint);
```

**æœŸå¾…å€¤**:
- `canvasContainer.position` = {x: 0, y: 0}
- `canvasContainer.toGlobal({0,0})` â‰ˆ worldContainerå†…ã®ã©ã“ã‹

---

### å€™è£œ3: screenToLayer() ã®å®Ÿè£…ãŒä¸æ­£ç¢º
**ç¢ºèªå¯¾è±¡**: `camera-system.js` ã® `screenToLayer()` ãƒ¡ã‚½ãƒƒãƒ‰

```javascript
// ç¾åœ¨ã®å®Ÿè£…
screenToLayer(screenX, screenY) {
    const globalPoint = { x: screenX, y: screenY };
    return this.canvasContainer.toLocal(globalPoint);
}
```

**å•é¡Œç‚¹**:
1. `screenX/Y` ãŒã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ã¨ä»®å®šã—ã¦ã„ã‚‹
2. `toLocal()` ã®åŸºæº–ç‚¹ãŒcanvasContainerã«ãªã£ã¦ã„ã‚‹
3. worldContainerã®å¤‰æ›ãŒåæ˜ ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§

**æ­£ã—ã„å®Ÿè£…ã®æµã‚Œ**:
```
screenX/Y (ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™)
  â†“ [PixiJSç”»é¢åº§æ¨™ç³» â†’ stage.toLocal()]
  â†“ stageåº§æ¨™ (= worldContainerç›¸å¯¾)
  â†“ [worldContainer â†’ canvasContainer]
  â†“ canvasLocalåº§æ¨™
```

---

## è¨ºæ–­æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: core-runtime.js ã‚’ç¢ºèª

```javascript
// core-runtime.js ã® handlePointerDown
handlePointerDown(event) {
    if (this.internal.drawingEngine && !this.internal.layerManager?.isLayerMoveMode) {
        // ğŸ” ç¢ºèª: event.global.x/y vs event.clientX/Y
        console.log('event.clientX/Y:', event.clientX, event.clientY);
        console.log('event.global.x/y:', event.global?.x, event.global?.y);
        
        // â† event ã¯ PixiJS FederatedPointerEvent ã‹ã€ãƒã‚¤ãƒ†ã‚£ãƒ– PointerEvent ã‹ï¼Ÿ
        
        this.internal.drawingEngine.startDrawing(
            event.global.x,
            event.global.y,
            event
        );
    }
}
```

**è³ªå•**: event.global ã¯å­˜åœ¨ã™ã‚‹ï¼Ÿå­˜åœ¨ã—ãªã„å ´åˆã€ä½•ãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ

---

### ã‚¹ãƒ†ãƒƒãƒ—2: DrawingEngine.startDrawing() ã‚’ç¢ºèª

```javascript
startDrawing(x, y, event) {
    // ğŸ” ç¢ºèª: event ã®å‹
    console.log('event.pointerType:', event.pointerType);
    console.log('event.clientX/Y:', event.clientX, event.clientY);
    
    // â† DrawingEngine ãŒå—ã‘å–ã‚‹åº§æ¨™ç³»ã¯çµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
}
```

---

### ã‚¹ãƒ†ãƒƒãƒ—3: cameraSystem.screenToLayer() ã®æ¤œè¨¼

```javascript
// canvas è¦ç´ ã®ä½ç½®ã‚’ç¢ºèª
const canvas = document.querySelector('canvas');
const rect = canvas.getBoundingClientRect();
console.log('canvas.getBoundingClientRect():', rect);
// æœŸå¾…: {left: 0, top: 0, ...}

// PixiJS stage ã®åº§æ¨™ç³»ç¢ºèª
const testScreen = { x: 10, y: 10 };
const testLocal = cameraSystem.screenToLayer(testScreen.x, testScreen.y);
console.log('screenToLayer(10, 10):', testLocal);
// æœŸå¾…: canvasContainerãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã§ {x: 10, y: 10} ã«è¿‘ã„å€¤

// worldContainerã®å½±éŸ¿ç¢ºèª
const wc = cameraSystem.worldContainer;
console.log('worldContainer.position:', wc.position);
console.log('worldContainer.scale:', wc.scale);
// å½±éŸ¿ã‚ã‚‹ãªã‚‰ã€canvasLocalåº§æ¨™ã«åŠ ç®—ãŒå¿…è¦
```

---

## ä¿®æ­£æ¡ˆ

### æ¡ˆA: core-runtime.js ã§åº§æ¨™ã‚’ PointerEvent ã«çµ±ä¸€

```javascript
// âŒ ä¿®æ­£å‰
handlePointerDown(event) {
    this.internal.drawingEngine.startDrawing(
        event.global.x,
        event.global.y,
        event
    );
}

// âœ… ä¿®æ­£å¾Œ
handlePointerDown(event) {
    this.internal.drawingEngine.startDrawing(
        event.clientX,  // â† ãƒã‚¤ãƒ†ã‚£ãƒ–PointerEventåº§æ¨™ã‚’ä½¿ç”¨
        event.clientY,
        event
    );
}
```

---

### æ¡ˆB: camera-system.screenToLayer() ã‚’æ­£ç¢ºã«å®Ÿè£…

```javascript
// ğŸ”„ ä¿®æ­£æ¡ˆ
screenToLayer(screenX, screenY) {
    // stage ã‚’é€šã˜ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ã‚’stageåº§æ¨™ã«å¤‰æ›
    const stage = this.app.stage;
    if (!stage) return { x: screenX, y: screenY };
    
    // canvas.getBoundingClientRect() ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ã‚’ç›¸å¯¾åŒ–
    const canvas = stage.parent?.canvas || stage.parent?.view;
    if (!canvas) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: canvasContainerã«ç›´æ¥å¤‰æ›
        return this.canvasContainer.toLocal({ x: screenX, y: screenY });
    }
    
    const rect = canvas.getBoundingClientRect();
    const relativeX = screenX - rect.left;  // ã‚­ãƒ£ãƒ³ãƒã‚¹ç›¸å¯¾X
    const relativeY = screenY - rect.top;   // ã‚­ãƒ£ãƒ³ãƒã‚¹ç›¸å¯¾Y
    
    // canvasContainer ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã«å¤‰æ›
    return this.canvasContainer.toLocal({ x: relativeX, y: relativeY });
}
```

---

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] core-runtime.js ã® eventåº§æ¨™ç¢ºèªï¼ˆevent.global vs event.clientX/Yï¼‰
- [ ] DrawingEngine ã«æ¸¡ã•ã‚Œã‚‹åº§æ¨™ã®ä¸€è²«æ€§ç¢ºèª
- [ ] cameraSystem.screenToLayer() ã®å®Ÿè£…æ¤œè¨¼
- [ ] worldContainer ã®ä½ç½®ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«ãƒ»å›è»¢ãŒæç”»ã«å½±éŸ¿ã—ã¦ã„ã‚‹ã‹ç¢ºèª
- [ ] PixiJS stage.toLocal() vs canvasContainer.toLocal() ã®é•ã„ç¢ºèª
- [ ] canvas.getBoundingClientRect() ã¨ã®ã‚ºãƒ¬ç¢ºèª

---

## ãƒ­ã‚°å‡ºåŠ›ã§ç¢ºèªã™ã‚‹ã‚³ãƒ¼ãƒ‰

```javascript
// QuickAccessPopup.show() æ™‚ã«å®Ÿè¡Œ
console.group('ğŸ” åº§æ¨™ç³»ãƒ‡ãƒãƒƒã‚°');

const cc = drawingApp.cameraSystem.canvasContainer;
const wc = drawingApp.cameraSystem.worldContainer;

console.log('worldContainer:', {
    x: wc.x, y: wc.y,
    scaleX: wc.scale.x, scaleY: wc.scale.y,
    rotation: wc.rotation
});

console.log('canvasContainer:', {
    x: cc.x, y: cc.y,
    scaleX: cc.scale.x, scaleY: cc.scale.y
});

const testPt = {x: 100, y: 100};
console.log('Test point (100, 100):', {
    toLocal: cc.toLocal(testPt),
    toGlobal: cc.toGlobal(testPt)
});

console.groupEnd();
```

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ã‚¹ãƒ†ãƒƒãƒ—1ï½3ã‚’å®Ÿè¡Œ** ã—ã¦ãƒ­ã‚°ã‚’å–å¾—
2. ã‚ºãƒ¬ã®æ–¹å‘ã¨å¤§ãã•ã‹ã‚‰åŸå› ã‚’ç‰¹å®š
3. è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£
4. ãƒ†ã‚¹ãƒˆã§ç¢ºèª