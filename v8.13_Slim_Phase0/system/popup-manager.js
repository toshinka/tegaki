// ===== system/popup-manager.js =====
// Ë≤¨Âãô: „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆ‰∏ÄÂÖÉÁÆ°ÁêÜ
// - ÂàùÊúüÂåñ„ÉªÁôªÈå≤„ÅÆÁµ±‰∏Ä
// - ÂèÇÁÖßÁÆ°ÁêÜ„ÅÆÁµ±‰∏Ä
// - Êéí‰ªñÂà∂Âæ°„ÅÆÂÆüË£Ö
// - EventBusÁµ±Âêà

window.TegakiPopupManager = class PopupManager {
    constructor(eventBus) {
        if (!eventBus) {
            throw new Error('EventBus is required for PopupManager');
        }
        
        this.eventBus = eventBus;
        this.popups = new Map(); // name -> { instance, PopupClass, dependencies, config, status }
        this.activePopup = null;
        this.initializationQueue = [];
        
        console.log('‚úÖ PopupManager initialized');
    }
    
    /**
     * „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÁôªÈå≤
     * @param {string} name - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠òÂà•Âêç
     * @param {class} PopupClass - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇØ„É©„Çπ
     * @param {object} dependencies - ‰æùÂ≠ò„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
     * @param {object} config - Ë®≠ÂÆö { priority, waitFor }
     */
    register(name, PopupClass, dependencies = {}, config = {}) {
        if (this.popups.has(name)) {
            console.warn(`‚ö†Ô∏è Popup "${name}" is already registered`);
            return false;
        }
        
        const popupData = {
            name,
            PopupClass,
            dependencies,
            config: {
                priority: config.priority || 99,
                waitFor: config.waitFor || []
            },
            instance: null,
            status: 'registered' // registered -> initializing -> ready -> failed
        };
        
        this.popups.set(name, popupData);
        this.initializationQueue.push(popupData);
        
        this.eventBus.emit('popup:registered', { name });
        
        console.log(`üìã Popup "${name}" registered (priority: ${popupData.config.priority})`);
        
        return true;
    }
    
    /**
     * ÂÄãÂà•„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÂàùÊúüÂåñ
     * @param {string} name - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠òÂà•Âêç
     * @returns {boolean} ÂàùÊúüÂåñÊàêÂäü/Â§±Êïó
     */
    initialize(name) {
        const popupData = this.popups.get(name);
        
        if (!popupData) {
            console.error(`‚ùå Popup "${name}" not registered`);
            return false;
        }
        
        if (popupData.status === 'ready') {
            console.log(`‚úÖ Popup "${name}" already initialized`);
            return true;
        }
        
        // ‰æùÂ≠òÈñ¢‰øÇ„ÉÅ„Çß„ÉÉ„ÇØ
        if (popupData.config.waitFor.length > 0) {
            const missingDeps = popupData.config.waitFor.filter(dep => {
                // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÅÆÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ
                return !window[dep];
            });
            
            if (missingDeps.length > 0) {
                console.log(`‚è≥ Popup "${name}" waiting for: ${missingDeps.join(', ')}`);
                return false;
            }
        }
        
        popupData.status = 'initializing';
        
        try {
            // „Ç§„É≥„Çπ„Çø„É≥„ÇπÁîüÊàê
            const instance = new popupData.PopupClass(popupData.dependencies);
            
            // ÂøÖÈ†à„É°„ÇΩ„ÉÉ„Éâ„ÅÆÁ¢∫Ë™ç
            if (typeof instance.show !== 'function' || 
                typeof instance.hide !== 'function' || 
                typeof instance.toggle !== 'function') {
                throw new Error(`Popup "${name}" missing required methods (show/hide/toggle)`);
            }
            
            popupData.instance = instance;
            popupData.status = 'ready';
            
            this.eventBus.emit('popup:initialized', { name });
            
            console.log(`‚úÖ Popup "${name}" initialized successfully`);
            
            return true;
            
        } catch (error) {
            popupData.status = 'failed';
            this.eventBus.emit('popup:initialization-failed', { name, error: error.message });
            
            console.error(`‚ùå Popup "${name}" initialization failed:`, error);
            
            return false;
        }
    }
    
    /**
     * „Åô„Åπ„Å¶„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÂÑ™ÂÖàÈ†Ü‰ΩçÈ†Ü„Å´ÂàùÊúüÂåñ
     */
    initializeAll() {
        console.log('üîß Initializing all popups...');
        
        // ÂÑ™ÂÖàÈ†Ü‰Ωç„Åß„ÇΩ„Éº„Éà
        this.initializationQueue.sort((a, b) => a.config.priority - b.config.priority);
        
        let initialized = 0;
        let deferred = 0;
        
        this.initializationQueue.forEach(popupData => {
            const success = this.initialize(popupData.name);
            if (success) {
                initialized++;
            } else {
                deferred++;
            }
        });
        
        console.log(`üìä Popup initialization: ${initialized} ready, ${deferred} deferred`);
        
        // ÈÅÖÂª∂ÂàùÊúüÂåñ„ÅåÂøÖË¶Å„Å™„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆ„É™„Éà„É©„Ç§Ë®≠ÂÆö
        if (deferred > 0) {
            this._setupDeferredInitialization();
        }
    }
    
    /**
     * ÈÅÖÂª∂ÂàùÊúüÂåñ„ÅÆ„É™„Éà„É©„Ç§Âá¶ÁêÜ
     * @private
     */
    _setupDeferredInitialization() {
        const maxRetries = 20;
        let retryCount = 0;
        
        const retryInitialization = () => {
            let stillWaiting = false;
            
            this.popups.forEach((popupData, name) => {
                if (popupData.status === 'registered') {
                    const success = this.initialize(name);
                    if (!success) {
                        stillWaiting = true;
                    }
                }
            });
            
            retryCount++;
            
            if (stillWaiting && retryCount < maxRetries) {
                setTimeout(retryInitialization, 200);
            } else if (stillWaiting) {
                console.warn(`‚ö†Ô∏è Some popups failed to initialize after ${maxRetries} retries`);
                this.popups.forEach((popupData, name) => {
                    if (popupData.status === 'registered') {
                        console.warn(`  - "${name}" still waiting for: ${popupData.config.waitFor.join(', ')}`);
                    }
                });
            } else {
                console.log('‚úÖ All deferred popups initialized');
            }
        };
        
        setTimeout(retryInitialization, 200);
    }
    
    /**
     * „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇíÂèñÂæó
     * @param {string} name - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠òÂà•Âêç
     * @returns {object|null} „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç§„É≥„Çπ„Çø„É≥„Çπ
     */
    get(name) {
        const popupData = this.popups.get(name);
        
        if (!popupData) {
            console.warn(`‚ö†Ô∏è Popup "${name}" not registered`);
            return null;
        }
        
        if (popupData.status !== 'ready') {
            console.warn(`‚ö†Ô∏è Popup "${name}" not ready (status: ${popupData.status})`);
            // „É™„Éà„É©„Ç§Ë©¶Ë°å
            this.initialize(name);
            return popupData.instance; // null „ÅÆÂèØËÉΩÊÄß„ÅÇ„Çä
        }
        
        return popupData.instance;
    }
    
    /**
     * „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫ÔºàÊéí‰ªñÂà∂Âæ°‰ªò„ÅçÔºâ
     * @param {string} name - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠òÂà•Âêç
     */
    show(name) {
        const instance = this.get(name);
        
        if (!instance) {
            console.error(`‚ùå Cannot show popup "${name}": not ready`);
            return false;
        }
        
        // ‰ªñ„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÈñâ„Åò„Çã
        this.hideAll(name);
        
        // Ë°®Á§∫
        instance.show();
        this.activePopup = name;
        
        this.eventBus.emit('popup:show', { name });
        
        console.log(`üëÅÔ∏è Popup "${name}" shown`);
        
        return true;
    }
    
    /**
     * „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÈùûË°®Á§∫
     * @param {string} name - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠òÂà•Âêç
     */
    hide(name) {
        const instance = this.get(name);
        
        if (!instance) {
            return false;
        }
        
        instance.hide();
        
        if (this.activePopup === name) {
            this.activePopup = null;
        }
        
        this.eventBus.emit('popup:hide', { name });
        
        console.log(`üôà Popup "${name}" hidden`);
        
        return true;
    }
    
    /**
     * „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
     * @param {string} name - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠òÂà•Âêç
     */
    toggle(name) {
        const instance = this.get(name);
        
        if (!instance) {
            console.error(`‚ùå Cannot toggle popup "${name}": not ready`);
            return false;
        }
        
        const wasVisible = this.isVisible(name);
        
        if (wasVisible) {
            this.hide(name);
        } else {
            this.show(name);
        }
        
        this.eventBus.emit('popup:toggled', { name, isVisible: !wasVisible });
        
        return true;
    }
    
    /**
     * „Åô„Åπ„Å¶„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÈñâ„Åò„Çã
     * @param {string} exceptName - Èô§Â§ñ„Åô„Çã„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÂêç
     */
    hideAll(exceptName = null) {
        let hiddenCount = 0;
        
        this.popups.forEach((popupData, name) => {
            if (name !== exceptName && popupData.instance) {
                if (this.isVisible(name)) {
                    popupData.instance.hide();
                    hiddenCount++;
                }
            }
        });
        
        // DOMÁõ¥Êé•Êìç‰Ωú„Åß„ÇÇÁ¢∫ÂÆü„Å´Èñâ„Åò„Çã
        document.querySelectorAll('.popup-panel').forEach(popup => {
            if (popup.id !== `${exceptName}-popup`) {
                popup.classList.remove('show');
            }
        });
        
        // „É™„Çµ„Ç§„Ç∫„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇÇÂØæË±°
        const resizePopup = document.getElementById('resize-settings');
        if (resizePopup && exceptName !== 'resize') {
            resizePopup.classList.remove('show');
        }
        
        if (exceptName !== null) {
            this.activePopup = exceptName;
        } else {
            this.activePopup = null;
        }
        
        if (hiddenCount > 0) {
            this.eventBus.emit('popup:all-hidden', { exceptName, hiddenCount });
            console.log(`üôà Closed ${hiddenCount} popups (except: ${exceptName || 'none'})`);
        }
    }
    
    /**
     * „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
     * @param {string} name - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠òÂà•Âêç
     * @returns {boolean}
     */
    isVisible(name) {
        const instance = this.get(name);
        
        if (!instance) {
            return false;
        }
        
        return instance.isVisible === true;
    }
    
    /**
     * „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåÂàùÊúüÂåñÊ∏à„Åø„ÅãÁ¢∫Ë™ç
     * @param {string} name - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠òÂà•Âêç
     * @returns {boolean}
     */
    isReady(name) {
        const popupData = this.popups.get(name);
        return popupData ? popupData.status === 'ready' : false;
    }
    
    /**
     * ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó‰∏ÄË¶ß„ÇíÂèñÂæó
     * @returns {Array} „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÂêç„ÅÆÈÖçÂàó
     */
    getRegisteredPopups() {
        return Array.from(this.popups.keys());
    }
    
    /**
     * „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆÁä∂ÊÖãÊÉÖÂ†±„ÇíÂèñÂæó
     * @param {string} name - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË≠òÂà•Âêç
     * @returns {object|null}
     */
    getStatus(name) {
        const popupData = this.popups.get(name);
        
        if (!popupData) {
            return null;
        }
        
        return {
            name,
            status: popupData.status,
            isVisible: this.isVisible(name),
            priority: popupData.config.priority,
            waitFor: popupData.config.waitFor
        };
    }
    
    /**
     * „Åô„Åπ„Å¶„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆÁä∂ÊÖã„ÇíÂèñÂæóÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
     * @returns {Array}
     */
    getAllStatuses() {
        const statuses = [];
        
        this.popups.forEach((popupData, name) => {
            statuses.push(this.getStatus(name));
        });
        
        return statuses.sort((a, b) => a.priority - b.priority);
    }
    
    /**
     * Ë®∫Êñ≠ÊÉÖÂ†±„ÇíÂá∫Âäõ
     */
    diagnose() {
        console.log('=== PopupManager Diagnostics ===');
        console.log('Registered popups:', this.getRegisteredPopups().length);
        console.log('Active popup:', this.activePopup || 'none');
        console.log('\nPopup statuses:');
        
        const statuses = this.getAllStatuses();
        statuses.forEach(status => {
            const icon = status.status === 'ready' ? '‚úÖ' : 
                        status.status === 'failed' ? '‚ùå' : 
                        status.status === 'initializing' ? '‚è≥' : 'üìã';
            const visibleIcon = status.isVisible ? 'üëÅÔ∏è' : 'üôà';
            
            console.log(`  ${icon} ${visibleIcon} ${status.name} (priority: ${status.priority}, status: ${status.status})`);
            
            if (status.waitFor && status.waitFor.length > 0) {
                console.log(`      Waiting for: ${status.waitFor.join(', ')}`);
            }
        });
        
        console.log('================================');
    }
};

// „Ç∞„É≠„Éº„Éê„É´ÂÖ¨Èñã
window.PopupManager = null; // „Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅØÂæå„ÅßË®≠ÂÆö

console.log('‚úÖ popup-manager.js loaded');