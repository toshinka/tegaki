# ğŸ”§ æ”¹ä¿®è¨ˆç”»æ›¸ï¼š4ã¤ã®å•é¡Œã«å¯¾ã™ã‚‹åŒ…æ‹¬çš„è§£æ±ºç­–

## ğŸ“‹ ç›®æ¬¡
1. [ã‚·ãƒ³ãƒœãƒ«è¾å…¸](#ã‚·ãƒ³ãƒœãƒ«è¾å…¸)
2. [å•é¡Œåˆ†æ](#å•é¡Œåˆ†æ)
3. [æ”¹ä¿®è¨ˆç”»](#æ”¹ä¿®è¨ˆç”»)
4. [å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## ğŸ” ã‚·ãƒ³ãƒœãƒ«è¾å…¸

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

| ã‚·ãƒ³ãƒœãƒ« | å‹ | å®šç¾©å ´æ‰€ | è²¬å‹™ | åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚° |
|---------|-----|----------|------|------------------|
| `window.TegakiEventBus` | EventBus | system/event-bus.js | ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•é€šä¿¡ | æœ€åˆ |
| `window.TEGAKI_CONFIG` | Object | config.js | è¨­å®šå€¤ä¸€å…ƒç®¡ç† | æœ€åˆ |
| `window.TEGAKI_KEYMAP` | Object | config.js | ã‚­ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾© | æœ€åˆ |
| `window.PopupManager` | PopupManager | system/popup-manager.js | ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä¸€å…ƒç®¡ç† | core-initializer.js |
| `window.History` | History | system/history.js | Undo/Redoç®¡ç† | ä¸­æœŸ |
| `window.StateManager` | StateManager | system/state-manager.js | çŠ¶æ…‹ç®¡ç† | ä¸­æœŸ |
| `window.BrushSettings` | BrushSettings | system/drawing/brush-settings.js | ãƒ–ãƒ©ã‚·è¨­å®šç®¡ç† | core-engine.js |
| `window.drawingApp` | Object | core-runtime.js | ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ› | core-runtime.js |
| `window.CoreRuntime` | Object | core-runtime.js | Runtime API | core-runtime.js |
| `window.animationSystem` | AnimationSystem | system/animation-system.js | ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç† | core-engine.js |
| `window.timelineUI` | TimelineUI | ui/timeline-ui.js | ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³UI | core-engine.js |

### ã‚¯ãƒ©ã‚¹å®šç¾©

#### æç”»ç³»

| ã‚¯ãƒ©ã‚¹ | ãƒ•ã‚¡ã‚¤ãƒ« | ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ | ä¾å­˜ |
|--------|---------|-------------|------|
| `DrawingEngine` | system/drawing/drawing-engine.js | `startDrawing()`, `continueDrawing()`, `stopDrawing()`, `setTool()` | StrokeRenderer, StrokeRecorder, BrushSettings |
| `StrokeRenderer` | system/drawing/stroke-renderer.js | `renderPreview()`, `renderFinalStroke()`, `setTool()` | PIXI.Graphics |
| `StrokeRecorder` | system/drawing/stroke-recorder.js | `startStroke()`, `addPoint()`, `endStroke()` | PressureHandler |
| `BrushSettings` | system/drawing/brush-settings.js | `getSize()`, `setSize()`, `getColor()`, `setColor()`, `getOpacity()`, `setOpacity()` | EventBus, CONFIG |

#### ã‚·ã‚¹ãƒ†ãƒ ç³»

| ã‚¯ãƒ©ã‚¹ | ãƒ•ã‚¡ã‚¤ãƒ« | ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ | ä¾å­˜ |
|--------|---------|-------------|------|
| `LayerSystem` | system/layer-system.js | `getLayers()`, `getActiveLayer()`, `createLayer()`, `deleteLayer()`, `reorderLayers()` | EventBus, LayerTransform |
| `CameraSystem` | system/camera-system.js | `init()`, `resizeCanvas()`, `updateCursor()` | EventBus |
| `StateManager` | system/state-manager.js | `getCurrentTool()`, `setCurrentTool()`, `getPenSize()`, `setPenSize()` | EventBus |
| `PopupManager` | system/popup-manager.js | `register()`, `show()`, `hide()`, `toggle()`, `hideAll()` | EventBus |

#### UIç³»

| ã‚¯ãƒ©ã‚¹ | ãƒ•ã‚¡ã‚¤ãƒ« | ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ | ä¾å­˜ |
|--------|---------|-------------|------|
| `QuickAccessPopup` | ui/quick-access-popup.js | `show()`, `hide()`, `toggle()` | BrushSettings, EventBus |
| `UIController` | ui/ui-panels.js | `handleToolClick()`, `closeAllPopups()` | PopupManager, CoreRuntime |
| `KeyboardHandler` | ui/keyboard-handler.js | `handleKeyDown()`, `handleKeyUp()` | EventBus, KEYMAP |

---

## ğŸ› å•é¡Œåˆ†æ

### å•é¡Œ1: quick-access-popupãŒç”»é¢å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹

**ç¾çŠ¶**
- `ui-panels.js` ã® `setupEventDelegation()` ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
- `.popup-panel` ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ `closeAllPopups()` ãŒç™ºç«
- `quick-access-popup` ã‚‚å¯¾è±¡ã«å«ã¾ã‚Œã‚‹

**åŸå› **
- `closeAllPopups()` ãŒä¾‹å¤–å‡¦ç†ãªã—ã§å…¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
- PopupManagerã® `hideAll()` ã« `exceptName` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹ãŒæ´»ç”¨ã•ã‚Œã¦ã„ãªã„

**å½±éŸ¿ç¯„å›²**
- `ui/ui-panels.js` - `setupEventDelegation()`
- `system/popup-manager.js` - `hideAll()`

---

### å•é¡Œ2: Delã‚­ãƒ¼ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼å†…å®¹æ¶ˆå»ãŒå‹•ä½œã—ãªã„

**ç¾çŠ¶**
- `config.js` ã§ `LAYER_DELETE_DRAWINGS` ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå®šç¾©æ¸ˆã¿
- `keyboard-handler.js` ã§ `deleteActiveLayerDrawings()` é–¢æ•°ãŒå®Ÿè£…æ¸ˆã¿
- ã—ã‹ã—å®Ÿéš›ã«ã¯å‹•ä½œã—ã¦ã„ãªã„

**åŸå› ã®å¯èƒ½æ€§**
1. **EventBusã¨ã®æ¥ç¶šä¸å‚™**: `keyboard-handler.js` ã¯ç‹¬ç«‹ã—ã¦å‹•ä½œã—ã¦ã„ã‚‹ãŒã€`core-engine.js` ã® `UnifiedKeyHandler` ãŒå„ªå…ˆã•ã‚Œã‚‹
2. **ã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®äºŒé‡å®Ÿè£…**: `keyboard-handler.js` ã¨ `core-engine.js (UnifiedKeyHandler)` ãŒå…±å­˜
3. **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æœªå‡¦ç†**: `UnifiedKeyHandler.handleKeyDown()` ã§ `LAYER_DELETE_DRAWINGS` ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå‡¦ç†ã•ã‚Œã¦ã„ãªã„

**å½±éŸ¿ç¯„å›²**
- `ui/keyboard-handler.js` - åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§
- `core-engine.js` - UnifiedKeyHandlerãŒDELã‚­ãƒ¼ã‚’å‡¦ç†ã—ã¦ã„ãªã„
- `index.html` - keyboard-handler.jsã®èª­ã¿è¾¼ã¿é †åº

**ç¢ºèªäº‹é …**
```javascript
// keyboard-handler.js ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
window.KeyboardHandler?.init() // å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ï¼Ÿ

// UnifiedKeyHandlerãŒDELã‚’å‡¦ç†ã—ã¦ã„ã‚‹ã‹ï¼Ÿ
// core-engine.js Line 111: switch(action) ã« 'delete' ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ãŒ
// 'LAYER_DELETE_DRAWINGS' ã«ãƒãƒƒãƒã—ã¦ã„ãªã„
```

---

### å•é¡Œ3: æ¶ˆã—ã‚´ãƒ ãŒé€æ˜ãƒšãƒ³ã§ã¯ãªãèƒŒæ™¯è‰²ã§å¡—ã‚Šã¤ã¶ã—

**ç¾çŠ¶**
- `stroke-renderer.js` ã§ `blendMode: 'erase'` ã‚’è¨­å®šæ¸ˆã¿ï¼ˆæ”¹ä¿®ç‰ˆï¼‰
- ã—ã‹ã—å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼Ÿ

**åŸå› **
- `stroke-renderer.js` ã®å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ãŒæ”¹ä¿®ç‰ˆã«ç½®ãæ›ã‚ã£ã¦ã„ãªã„
- ã¾ãŸã¯ `setTool()` ãŒæ­£ã—ãå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„

**ç¢ºèªäº‹é …**
```javascript
// StrokeRenderer.setTool() ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
drawingEngine.setTool('eraser'); // ã“ã‚ŒãŒstrokeRenderer.setTool()ã‚’å‘¼ã¶ï¼Ÿ

// ç¾åœ¨ã®ãƒ„ãƒ¼ãƒ«çŠ¶æ…‹
drawingEngine.currentTool // 'eraser' ã«ãªã£ã¦ã„ã‚‹ï¼Ÿ
strokeRenderer.currentTool // 'eraser' ã«ãªã£ã¦ã„ã‚‹ï¼Ÿ
```

**å½±éŸ¿ç¯„å›²**
- `system/drawing/stroke-renderer.js` - `setTool()`, `renderPreview()`
- `system/drawing/drawing-engine.js` - `setTool()` â†’ `strokeRenderer.setTool()`
- `core-runtime.js` - `CoreRuntime.api.tool.set()`
- `ui/ui-panels.js` - `handleToolClick()`

**ãƒ„ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆãƒ•ãƒ­ãƒ¼**
```
UIãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  â†“
ui-panels.js: handleToolClick('eraser-tool')
  â†“
CoreRuntime.api.tool.set('eraser')
  â†“
drawingEngine.setTool('eraser')
  â†“
strokeRenderer.setTool('eraser')  â† ã“ã“ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§
  â†“
EventBus.emit('tool:select', {tool: 'eraser'})
```

---

### å•é¡Œ4: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°ã«ã‚ˆã‚‹éšå±¤ç§»å‹•ãŒæ¶ˆãˆã¦ã„ã‚‹

**ç¾çŠ¶**
- `ui-panels.js` ã« `initializeSortable()` é–¢æ•°ãŒå­˜åœ¨
- ã—ã‹ã— `Sortable.js` ãŒæ­£ã—ãçµ±åˆã•ã‚Œã¦ã„ãªã„

**åŸå› **
1. **Sortable.jsã®åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: `layer-system.js` ã® `updateLayerPanelUI()` å®Ÿè¡Œå¾Œã«å‘¼ã°ã‚Œã¦ã„ãªã„
2. **HTMLã«æœªåæ˜ **: `index.html` ã§Sortable.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãŒã€åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§
3. **LayerSystemã¨ã®çµ±åˆä¸å‚™**: `reorderLayers()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯å­˜åœ¨ã™ã‚‹ãŒã€Sortableã‚¤ãƒ™ãƒ³ãƒˆã¨æ¥ç¶šã•ã‚Œã¦ã„ãªã„

**å½±éŸ¿ç¯„å›²**
- `ui/ui-panels.js` - `initializeSortable()`
- `system/layer-system.js` - `updateLayerPanelUI()`, `reorderLayers()`
- `core-engine.js` - åˆæœŸåŒ–æ™‚ã«`initializeSortable()`ã‚’å‘¼ã³å‡ºã—ã¦ã„ãªã„
- `index.html` - Sortable.jsèª­ã¿è¾¼ã¿ç¢ºèª

**åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼ï¼ˆç†æƒ³ï¼‰**
```
core-engine.js: initialize()
  â†“
layerSystem.updateLayerPanelUI()
  â†“
TegakiUI.initializeSortable(layerSystem) â† å‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„
  â†“
Sortable.create('#layer-list', {...})
```

---

## ğŸ“ æ”¹ä¿®è¨ˆç”»

### Phase 1: å•é¡Œ1 - quick-access-popupç”»é¢å¤–ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `ui/ui-panels.js`

**å¤‰æ›´å†…å®¹**:
```javascript
// setupEventDelegation() å†…
if (!e.target.closest('.popup-panel') && ...) {
    // quick-access-popupä»¥å¤–ã‚’é–‰ã˜ã‚‹
    const manager = this.getPopupManager();
    if (manager) {
        manager.hideAll('quickAccess'); // â† exceptNameã‚’ä½¿ç”¨
    }
}
```

**å½±éŸ¿**: ãªã—ï¼ˆæ—¢å­˜æ©Ÿèƒ½ã®é™å®šåŒ–ï¼‰

---

### Phase 2: å•é¡Œ2 - Delã‚­ãƒ¼ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼å†…å®¹æ¶ˆå»

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: 
1. `core-engine.js` - UnifiedKeyHandler
2. `ui/keyboard-handler.js` - åˆæœŸåŒ–çµ±åˆ

**å¤‰æ›´å†…å®¹**:

#### 2-1. core-engine.js - UnifiedKeyHandlerã«DELã‚­ãƒ¼å‡¦ç†ã‚’è¿½åŠ 

```javascript
// UnifiedKeyHandler.handleKeyDown() å†…ã«è¿½åŠ 
case 'delete':
case 'LAYER_DELETE_DRAWINGS':
    if ((e.code === 'Delete' || e.code === 'Backspace') && 
        !e.ctrlKey && !e.altKey && !e.metaKey) {
        this.deleteActiveLayerDrawings();
        e.preventDefault();
    }
    break;

// æ–°è¦ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
deleteActiveLayerDrawings() {
    const layerSystem = this.layerSystem;
    if (!layerSystem) return;
    
    const activeLayer = layerSystem.getActiveLayer();
    if (!activeLayer || !activeLayer.layerData) return;
    
    // èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å‰Šé™¤ä¸å¯
    if (activeLayer.layerData.isBackground) return;
    
    const paths = activeLayer.layerData.paths;
    if (!paths || paths.length === 0) return;
    
    // Historyçµ±åˆ
    if (window.History && !window.History._manager.isApplying) {
        const pathsBackup = structuredClone(paths);
        const layerIndex = layerSystem.activeLayerIndex;
        
        const entry = {
            name: 'layer-delete-drawings',
            do: () => {
                this.clearLayerDrawings(layerSystem, activeLayer);
            },
            undo: () => {
                this.restoreLayerDrawings(layerSystem, activeLayer, pathsBackup, layerIndex);
            },
            meta: { 
                layerId: activeLayer.layerData.id,
                pathCount: pathsBackup.length
            }
        };
        
        window.History.push(entry);
    } else {
        this.clearLayerDrawings(layerSystem, activeLayer);
    }
}

clearLayerDrawings(layerSystem, layer) {
    // keyboard-handler.jsã‹ã‚‰ç§»æ¤
}

restoreLayerDrawings(layerSystem, layer, pathsBackup, layerIndex) {
    // keyboard-handler.jsã‹ã‚‰ç§»æ¤
}
```

#### 2-2. keyboard-handler.js - çµ±åˆã¾ãŸã¯å‰Šé™¤

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: å®Œå…¨å‰Šé™¤**ï¼ˆæ¨å¥¨ï¼‰
- `index.html` ã‹ã‚‰ `<script src="ui/keyboard-handler.js"></script>` ã‚’å‰Šé™¤
- UnifiedKeyHandlerã«æ©Ÿèƒ½ã‚’çµ±åˆ

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: åˆæœŸåŒ–çµ±åˆ**
- `core-engine.js` ã§ `window.KeyboardHandler.init()` ã‚’å‘¼ã³å‡ºã™

---

### Phase 3: å•é¡Œ3 - æ¶ˆã—ã‚´ãƒ ã‚’é€æ˜ãƒšãƒ³ã«å¤‰æ›´

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
1. `system/drawing/stroke-renderer.js` - blendModeå®Ÿè£…
2. `system/drawing/drawing-engine.js` - setToolé€£æº
3. `core-runtime.js` - EventBusç™ºè¡Œ

**å¤‰æ›´å†…å®¹**:

#### 3-1. stroke-renderer.js

```javascript
class StrokeRenderer {
    constructor(app) {
        this.app = app;
        this.resolution = window.devicePixelRatio || 1;
        this.minPhysicalWidth = 1 / this.resolution;
        this.currentTool = 'pen'; // â† è¿½åŠ 
    }

    setTool(tool) {
        this.currentTool = tool;
    }

    renderPreview(points, settings) {
        const graphics = new PIXI.Graphics();
        
        // æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰
        if (this.currentTool === 'eraser') {
            graphics.blendMode = 'erase';
        }
        
        // æç”»å‡¦ç†
        if (points.length === 1) {
            const p = points[0];
            const width = this.calculateWidth(p.pressure, settings.size);
            graphics.circle(p.x, p.y, width / 2);
            
            if (this.currentTool === 'eraser') {
                graphics.fill({ color: 0xFFFFFF, alpha: 1.0 });
            } else {
                graphics.fill({ color: settings.color, alpha: settings.alpha || 1.0 });
            }
            return graphics;
        }
        
        // è¤‡æ•°ç‚¹ã®å ´åˆã‚‚åŒæ§˜
        // ...
    }
}
```

#### 3-2. drawing-engine.js

```javascript
setTool(toolName) {
    this.currentTool = toolName;
    // StrokeRendererã«ä¼æ’­
    if (this.strokeRenderer) {
        this.strokeRenderer.setTool(toolName);
    }
}
```

#### 3-3. core-runtime.js

```javascript
api: {
    tool: {
        set: (toolName) => {
            if (CoreRuntime.internal.drawingEngine?.setTool) {
                CoreRuntime.internal.drawingEngine.setTool(toolName);
                if (CoreRuntime.internal.cameraSystem?.updateCursor) {
                    CoreRuntime.internal.cameraSystem.updateCursor();
                }
                // EventBusç™ºè¡Œ
                if (window.TegakiEventBus) {
                    window.TegakiEventBus.emit('tool:select', { tool: toolName });
                }
                return true;
            }
            return false;
        },
        // ...
    }
}
```

#### 3-4. drawing-engine.js - EventBusè³¼èª­è¿½åŠ 

```javascript
_syncToolSelection() {
    if (!this.eventBus) return;

    this.eventBus.on('tool:select', ({ tool }) => {
        this.setTool(tool);
    });
}

constructor(...) {
    // ...
    this._syncToolSelection(); // â† è¿½åŠ 
}
```

---

### Phase 4: å•é¡Œ4 - ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°ã«ã‚ˆã‚‹éšå±¤ç§»å‹•

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
1. `ui/ui-panels.js` - initializeSortableå®Ÿè£…
2. `system/layer-system.js` - updateLayerPanelUIä¿®æ­£
3. `core-engine.js` - åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°

**å¤‰æ›´å†…å®¹**:

#### 4-1. ui-panels.js

```javascript
window.TegakiUI.initializeSortable = function(layerSystem) {
    const layerList = document.getElementById('layer-list');
    if (!layerList || !window.Sortable) {
        console.warn('Sortable.js not loaded or #layer-list not found');
        return;
    }
    
    // æ—¢å­˜ã®Sortableã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å‰Šé™¤
    if (layerList._sortable) {
        layerList._sortable.destroy();
    }
    
    layerList._sortable = new Sortable(layerList, {
        animation: 150,
        handle: '.layer-item',
        ghostClass: 'layer-ghost',
        chosenClass: 'layer-chosen',
        dragClass: 'layer-drag',
        onEnd: function(evt) {
            const fromIndex = evt.oldIndex;
            const toIndex = evt.newIndex;
            
            if (fromIndex !== toIndex) {
                // UIã¨ãƒ‡ãƒ¼ã‚¿ã®é€†é †ã«æ³¨æ„
                const layers = layerSystem.getLayers();
                const actualFromIndex = layers.length - 1 - fromIndex;
                const actualToIndex = layers.length - 1 - toIndex;
                
                layerSystem.reorderLayers(actualFromIndex, actualToIndex);
            }
        }
    });
    
    console.log('âœ… Sortable initialized for #layer-list');
};
```

#### 4-2. layer-system.js

```javascript
updateLayerPanelUI() {
    // ...æ—¢å­˜ã®DOMæ§‹ç¯‰å‡¦ç†...
    
    // SortableåˆæœŸåŒ–ï¼ˆæœ€å¾Œã«å‘¼ã³å‡ºã—ï¼‰
    if (window.TegakiUI?.initializeSortable) {
        setTimeout(() => {
            window.TegakiUI.initializeSortable(this);
        }, 50);
    }
}
```

#### 4-3. core-engine.js

```javascript
initialize() {
    // ...æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†...
    
    // LayerSystemã®UIåˆæœŸåŒ–å¾Œã«Sortableã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    if (window.TegakiUI && window.TegakiUI.initializeSortable) {
        setTimeout(() => {
            window.TegakiUI.initializeSortable(this.layerSystem);
        }, 100);
    }
    
    // ...
}
```

---

## âœ… å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: quick-access-popup
- [ ] `ui/ui-panels.js` - `setupEventDelegation()` ä¿®æ­£
- [ ] `system/popup-manager.js` - `hideAll(exceptName)` ç¢ºèª
- [ ] å‹•ä½œãƒ†ã‚¹ãƒˆ: ç”»é¢å¤–ã‚¯ãƒªãƒƒã‚¯ã§quick-access-popupãŒæ®‹ã‚‹ã‹

### Phase 2: Delã‚­ãƒ¼æ©Ÿèƒ½
- [ ] `core-engine.js` - UnifiedKeyHandlerã«`deleteActiveLayerDrawings()`è¿½åŠ 
- [ ] `core-engine.js` - `clearLayerDrawings()`, `restoreLayerDrawings()`è¿½åŠ 
- [ ] `config.js` - `LAYER_DELETE_DRAWINGS`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¢ºèª
- [ ] å‹•ä½œãƒ†ã‚¹ãƒˆ: Del/Backspaceã§ãƒ¬ã‚¤ãƒ¤ãƒ¼å†…å®¹ãŒæ¶ˆãˆã‚‹ã‹
- [ ] å‹•ä½œãƒ†ã‚¹ãƒˆ: Undoã§å¾©å…ƒã•ã‚Œã‚‹ã‹

### Phase 3: æ¶ˆã—ã‚´ãƒ é€æ˜åŒ–
- [ ] `system/drawing/stroke-renderer.js` - `currentTool`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¿½åŠ 
- [ ] `system/drawing/stroke-renderer.js` - `setTool()`ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
- [ ] `system/drawing/stroke-renderer.js` - `renderPreview()`ã«blendModeåˆ†å²è¿½åŠ 
- [ ] `system/drawing/stroke-renderer.js` - `renderFinalStroke()`ã«blendModeåˆ†å²è¿½åŠ 
- [ ] `system/drawing/drawing-engine.js` - `setTool()`ã«`strokeRenderer.setTool()`è¿½åŠ 
- [ ] `system/drawing/drawing-engine.js` - `_syncToolSelection()`ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
- [ ] `core-runtime.js` - `api.tool.set()`ã«EventBusç™ºè¡Œè¿½åŠ 
- [ ] å‹•ä½œãƒ†ã‚¹ãƒˆ: æ¶ˆã—ã‚´ãƒ ã§æç”»ãŒé€æ˜åŒ–ã•ã‚Œã‚‹ã‹
- [ ] å‹•ä½œãƒ†ã‚¹ãƒˆ: èƒŒæ™¯ã®ãƒã‚§ãƒƒã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ãˆã‚‹ã‹

### Phase 4: ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ãƒ©ãƒƒã‚°
- [ ] `ui/ui-panels.js` - `initializeSortable()`é–¢æ•°ç¢ºèª
- [ ] `ui/ui-panels.js` - CSSï¼ˆ.layer-ghostç­‰ï¼‰è¿½åŠ 
- [ ] `system/layer-system.js` - `updateLayerPanelUI()`ã«`initializeSortable()`å‘¼ã³å‡ºã—è¿½åŠ 
- [ ] `core-engine.js` - `initialize()`ã«`initializeSortable()`å‘¼ã³å‡ºã—è¿½åŠ 
- [ ] `index.html` - Sortable.jsèª­ã¿è¾¼ã¿ç¢ºèª
- [ ] å‹•ä½œãƒ†ã‚¹ãƒˆ: ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆã§ãã‚‹ã‹
- [ ] å‹•ä½œãƒ†ã‚¹ãƒˆ: ä¸¦ã³æ›¿ãˆå¾Œã«Undo/RedoãŒå‹•ä½œã™ã‚‹ã‹

---

## ğŸ” äºŒé‡å®Ÿè£…ãƒ»çµ±ä¸€ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯

### ãƒ„ãƒ¼ãƒ«ç®¡ç†ã®çµ±ä¸€
- **StateManager**: `getCurrentTool()`, `setCurrentTool()`
- **DrawingEngine**: `currentTool`, `setTool()`
- **CoreRuntime**: `api.tool.set()`, `api.tool.get()`
- **çµè«–**: DrawingEngineãŒå®Ÿä½“ã€CoreRuntimeãŒAPIã€StateManagerã¯ä¸è¦ï¼ˆå‰Šé™¤å€™è£œï¼‰

### ã‚¤ãƒ™ãƒ³ãƒˆå‘½åè¦å‰‡ã®çµ±ä¸€
- âœ… çµ±ä¸€: `tool:select`, `tool:changed`
- âŒ ä¸çµ±ä¸€: `tool:updated` (æœªä½¿ç”¨)
- **çµè«–**: `tool:select`ã«çµ±ä¸€ï¼ˆDrawingEngine, CoreRuntimeï¼‰

### ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç®¡ç†ã®çµ±ä¸€
- âœ… PopupManagerã§ä¸€å…ƒç®¡ç†
- âœ… EventBusã§é€šçŸ¥
- âœ… UIControllerãŒå§”è­²
- **çµè«–**: çµ±ä¸€ã•ã‚Œã¦ã„ã‚‹

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œã®çµ±ä¸€
- âœ… LayerSystemãŒä¸€å…ƒç®¡ç†
- âœ… EventBusã§é€šçŸ¥
- âš ï¸ Historyçµ±åˆã¯éƒ¨åˆ†çš„ï¼ˆreorderLayersã¯Historyå¯¾å¿œæ¸ˆã¿ã€deleteLayerDrawingsã¯æœªå¯¾å¿œï¼‰
- **çµè«–**: Historyçµ±åˆã‚’å…¨ãƒ¡ã‚½ãƒƒãƒ‰ã«é©ç”¨

---

## ğŸ“ å®Ÿè£…å„ªå…ˆé †ä½

1. **Phase 3ï¼ˆæ¶ˆã—ã‚´ãƒ ï¼‰** - æœ€å„ªå…ˆï¼ˆæç”»ã®åŸºæœ¬æ©Ÿèƒ½ï¼‰
2. **Phase 2ï¼ˆDelã‚­ãƒ¼ï¼‰** - é«˜å„ªå…ˆï¼ˆé »ç¹ã«ä½¿ç”¨ï¼‰
3. **Phase 4ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼‰** - ä¸­å„ªå…ˆï¼ˆUXå‘ä¸Šï¼‰
4. **Phase 1ï¼ˆç”»é¢å¤–ã‚¯ãƒªãƒƒã‚¯ï¼‰** - ä½å„ªå…ˆï¼ˆè»½å¾®ãªå•é¡Œï¼‰

---

## ğŸš¨ æ³¨æ„äº‹é …

1. **ãƒ•ã‚¡ã‚¤ãƒ«ç½®ãæ›ãˆæ™‚ã®ç¢ºèª**
   - å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã®å…¨æ©Ÿèƒ½ãŒç¶™æ‰¿ã•ã‚Œã¦ã„ã‚‹ã‹
   - ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å…¬é–‹ãŒç¶­æŒã•ã‚Œã¦ã„ã‚‹ã‹
   - EventBusè³¼èª­ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

2. **Historyçµ±åˆã®ç¢ºèª**
   - `window.History.push(command)`ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ã‹
   - `do`/`undo`ãƒ¡ã‚½ãƒƒãƒ‰ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
   - `_manager.isApplying`ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹ã‹

3. **EventBusã®å®‰å…¨æ€§**
   - `emit`å‰ã«`EventBus`ã®å­˜åœ¨ç¢ºèª
   - `on`å‰ã«`EventBus`ã®å­˜åœ¨ç¢ºèª
   - å¾ªç’°å‚ç…§ã®é˜²æ­¢

4. **åˆæœŸåŒ–é †åºã®å³å®ˆ**
   ```
   1. config.js, coordinate-system.js
   2. system/event-bus.js
   3. system/data-models.js
   4. system/*ï¼ˆãã®ä»–ã‚·ã‚¹ãƒ†ãƒ ï¼‰
   5. system/drawing/*
   6. ui/*
   7. core-*
   ```